"use strict";(self.webpackChunkmadaster_typescript=self.webpackChunkmadaster_typescript||[]).push([[4995],{38406:(e,t,i)=>{i.d(t,{j:()=>m});var r=i(62991),s=i(6273),n=i(80861),a=i(37623),o=i(6538),l=i(31927),u=i(82657),h=i(68716),d=i(49214),p=i(89958),c=i(88416);class y{constructor(e,t,i){this._texture=null,this._lastTexture=null,this._fbos={},this.texelSize=4;const{buffer:r,pixelType:s,textureOnly:n}=e,a=(0,u.Qz)(s);this.blockIndex=i,this.pixelType=s,this.size=t,this.textureOnly=n,n||(this.data=new a(r)),this._resetRange()}destroy(){this._texture?.dispose();for(const e in this._fbos){const t=this._fbos[e];t&&("0"===e&&t.detachColorTexture(),t.dispose()),this._fbos[e]=null}this._texture=null}get _textureDesc(){const e=new c.R;return e.wrapMode=h.pF.CLAMP_TO_EDGE,e.samplingMode=h.Cj.NEAREST,e.dataType=this.pixelType,e.width=this.size,e.height=this.size,e}setData(e,t,i){const r=(0,l.Q4)(e),s=this.data,n=r*this.texelSize+t;!s||n>=s.length||(s[n]=i,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r))}getData(e,t){if(null==this.data)return null;const i=(0,l.Q4)(e)*this.texelSize+t;return!this.data||i>=this.data.length?null:this.data[i]}getTexture(e){return this._texture??this._initTexture(e)}getFBO(e,t=0){if(!this._fbos[t]){const i=0===t?this.getTexture(e):this._textureDesc;this._fbos[t]=new d.H(e,i)}return this._fbos[t]}get hasDirty(){const e=this.dirtyStart;return this.dirtyEnd>=e}updateTexture(e,t){try{const i=this.dirtyStart,a=this.dirtyEnd;if(!this.hasDirty)return;(0,s.A)("esri-2d-update-debug")&&console.debug(`Version[${t}] AttributeStoreView.updateTexture`,{start:i,end:a,firstBytes:new Uint8Array(this.data.buffer.slice(0,16)),block:this}),this._resetRange();const o=this.data.buffer,l=this.getTexture(e),h=4,d=(i-i%this.size)/this.size,p=(a-a%this.size)/this.size,c=d,y=this.size,f=p,g=d*this.size*h,m=(y+f*this.size)*h-g,_=(0,u.Qz)(this.pixelType),b=new _(o,g*_.BYTES_PER_ELEMENT,m),x=this.size,w=f-c+1;if(w>this.size)return void n.A.getLogger("esri.views.2d.engine.webgl.AttributeStoreView").error(new r.A("mapview-webgl","Out-of-bounds index when updating AttributeData"));l.updateData(0,0,c,x,w,b)}catch(e){}}update(e){const{data:t,start:i,end:r}=e;if(null!=t&&null!=this.data){const r=this.data,s=i*this.texelSize;for(let i=0;i<t.length;i++){const n=1<<i%this.texelSize;e.layout&n&&(r[s+i]=t[i])}}this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,r)}resize(e,t){const i=this.size;if(this.size=t,this.textureOnly)return void(i!==this.size&&(this._lastTexture=this._texture,this._texture=null));const r=(0,u.Qz)(this.pixelType);this.destroy(),this.data=new r(e.buffer)}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}_initTexture(e){const t=new p.g(e,this._textureDesc,this.data??void 0);if(null!=this._lastTexture&&this._fbos[0]){const i=this._lastTexture.descriptor.width,r=this._lastTexture.descriptor.height,s=this._lastTexture.descriptor.dataType,n=this._lastTexture.descriptor.pixelFormat,a=this.getFBO(e),o=(0,u.AV)(s),l=new((0,u.Qz)(s))(new ArrayBuffer(i*r*o*this.texelSize)),h=e.getBoundFramebufferObject(),{x:d,y:p,width:c,height:y}=e.getViewport();e.bindFramebuffer(a),a.readPixels(0,0,i,r,n,s,l),t.updateData(0,0,0,2*i,r/2,l),e.setViewport(d,p,c,y),e.bindFramebuffer(h)}return this.destroy(),this._texture=t,this._texture}}class f{constructor(){this.size=0,this._pendingAttributeUpdates=[],this._version=0,this._epoch=0,this._locked=!1}_initialize(e){if(!e)throw new Error("InternalError: initArgs must be defined");const t=e.blockDescriptors;if(this.size=e.blockSize,(0,s.A)("esri-2d-update-debug")&&console.debug("AttributeStoreView.initialize",{message:e}),null==this._data)this._data=t.map(((e,t)=>null!=e?new y(e,this.size,t):null));else for(let e=0;e<this._data.length;e++){const i=this._data[e],r=t[e];null!=r&&(null==i?this._data[e]=new y(r,this.size,e):i.resize(r,this.size))}}destroy(){for(const e of this._data??[])e?.destroy();this._defaultTexture?.dispose();for(const{resolver:e}of this._pendingAttributeUpdates)e.reject("AttributeStore destroyed");this._pendingAttributeUpdates=[]}isEmpty(){return null==this._data}getBlock(e){return null==this._data?null:this._data[e]}setLabelMinZoom(e,t){this.setData(e,0,1,t)}getLabelMinZoom(e){return this.getData(e,0,1,255)}getFilterFlags(e){return this.getData(e,0,0,0)}getVVSize(e){return this.getData(e,o.dV.VV,0,0)}getData(e,t,i,r){if(!this._data)return 0;const s=this._data[t];if(null==s)return 0;const n=s.getData(e,i);return null!=n?n:r}setData(e,t,i,r){this._data[t].setData(e,i,r)}lockTextureUploads(){this._locked=!0}unlockTextureUploads(){this._locked=!1,this.update()}async requestUpdate(e){const t=(0,a.Tw)();this._version=e.version,this._pendingAttributeUpdates.push({inner:e,resolver:t}),(0,s.A)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] AttributeStoreView.requestUpdate`,{message:e})}get currentEpoch(){return this._epoch}update(){if(this._locked)return;const e=this._pendingAttributeUpdates;this._pendingAttributeUpdates=[];for(const{inner:t,resolver:i}of e){const{blockData:e,initArgs:r,sendUpdateEpoch:n,version:a}=t;(0,s.A)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] Epoch[${n}] AttributeStoreView.applyUpdate`),this._version=a,this._epoch=n,null!=r&&this._initialize(r);const o=this._data;for(let t=0;t<e.length;t++){const i=e[t],r=o[t];null!=r&&null!=i&&((0,s.A)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] CpuBlock[${t}] AttributeStoreView.update`,{block:i}),r.update(i))}i.resolve()}}getUniforms(e){return{filterFlags:{texture:this._getTexture(e,o.dV.FilterFlags),unit:o.uM},animation:{texture:this._getTexture(e,o.dV.Animation),unit:o.z2},gpgpu:{texture:this._getTexture(e,o.dV.GPGPU),unit:o.Sr},visualVariableData:{texture:this._getTexture(e,o.dV.VV),unit:o.nM},dataDriven0:{texture:this._getTexture(e,o.dV.DD0),unit:o.lL},dataDriven1:{texture:this._getTexture(e,o.dV.DD1),unit:o.sn},dataDriven2:{texture:this._getTexture(e,o.dV.DD2),unit:o.n9},size:this.size}}_getTexture(e,t){const i=this._data?.[t];return i?(i.updateTexture(e,this._version),i.getTexture(e)):this._getDefaultTexture(e)}_getDefaultTexture(e){if(null==this._defaultTexture){const t=new c.R;t.wrapMode=h.pF.CLAMP_TO_EDGE,t.samplingMode=h.Cj.NEAREST,t.width=1,t.height=1,this._defaultTexture=new p.g(e,t,new Uint8Array(4))}return this._defaultTexture}}var g=i(87891);class m extends g.A{constructor(e){super(e),this._statisticsByLevel=new Map,this.attributeView=new f}destroy(){this.children.forEach((e=>e.destroy())),this.removeAllChildren(),this.attributeView.destroy()}doRender(e){e.context.capabilities.enable("textureFloat"),super.doRender(e)}createRenderParams(e){const t=super.createRenderParams(e);return t.attributeView=this.attributeView,t.instanceStore=this._instanceStore,t.statisticsByLevel=this._statisticsByLevel,t}}},87891:(e,t,i)=>{i.d(t,{A:()=>u});var r=i(6273),s=i(57122),n=i(47764),a=i(63153),o=i(586);const l=(e,t)=>e.key.level-t.key.level!=0?e.key.level-t.key.level:e.key.row-t.key.row!=0?e.key.row-t.key.row:e.key.col-t.key.col;class u extends n.A{constructor(e){super(),this._tileInfoView=e}renderChildren(e){this.sortChildren(l),this.setStencilReference(e),super.renderChildren(e)}createRenderParams(e){const{state:t}=e,i=super.createRenderParams(e);return i.requiredLevel=this._tileInfoView.getClosestInfoForScale(t.scale).level,i.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(t.scale),i}prepareRenderPasses(e){const t=super.prepareRenderPasses(e);return t.push(e.registerRenderPass({name:"stencil",brushes:[a.A],drawPhase:s.S5.DEBUG|s.S5.MAP|s.S5.HIGHLIGHT|s.S5.LABEL,target:()=>this.getStencilTarget()})),(0,r.A)("esri-tiles-debug")&&t.push(e.registerRenderPass({name:"tileInfo",brushes:[o.A],drawPhase:s.S5.DEBUG,target:()=>this.children})),t}getStencilTarget(){return this.children}setStencilReference(e){let t=1;for(const e of this.children)e.stencilRef=t++}}},24923:(e,t,i)=>{i.d(t,{O:()=>s});var r=i(11069);class s{constructor(e,t,i,r,s){this._instanceId=e,this.techniqueRef=t,this._meshWriterName=i,this._input=r,this.optionalAttributes=s}get instanceId(){return(0,r.P)(this._instanceId)}createMeshInfo(e){return{id:this._instanceId,meshWriterName:this._meshWriterName,options:e,optionalAttributes:this.optionalAttributes}}getInput(){return this._input}setInput(e){this._input=e}}},52616:(e,t,i)=>{i.d(t,{f:()=>T});var r=i(57725),s=i(38406),n=i(57122),a=i(24923),o=i(39921),l=i(11069);let u=0;function h(e,t,i){return new a.O((0,l.U)(u++),e,e.meshWriter.name,t,i)}const d={geometry:{visualVariableColor:null,visualVariableOpacity:null,visualVariableSizeMinMaxValue:null,visualVariableSizeScaleStops:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableRotation:null}};class p{constructor(){this.instances={fill:h(o.YS.fill,d,{zoomRange:!0}),marker:h(o.YS.marker,d,{zoomRange:!0}),line:h(o.YS.line,d,{zoomRange:!0}),text:h(o.YS.text,d,{zoomRange:!0,referenceSymbol:!1,clipAngle:!1}),complexFill:h(o.YS.complexFill,d,{zoomRange:!0}),texturedLine:h(o.YS.texturedLine,d,{zoomRange:!0})},this._instancesById=Object.values(this.instances).reduce(((e,t)=>(e.set(t.instanceId,t),e)),new Map)}getInstance(e){return this._instancesById.get(e)}}var c=i(82541),y=i(93446),f=i(14571),g=i(6590),m=i(87249),_=i(40087),b=i(82657),x=i(89325),w=i(68716),v=i(40866);const S=Math.PI/180;class A extends _.q{constructor(e){super(),this._program=null,this._vao=null,this._vertexBuffer=null,this._indexBuffer=null,this._dvsMat3=(0,y.vt)(),this._localOrigin={x:0,y:0},this._getBounds=e}destroy(){this._vao&&(this._vao.dispose(),this._vao=null,this._vertexBuffer=null,this._indexBuffer=null),this._program=(0,r.WD)(this._program)}doRender(e){const{context:t}=e,i=this._getBounds();if(i.length<1)return;this._createShaderProgram(t),this._updateMatricesAndLocalOrigin(e),this._updateBufferData(t,i),t.setBlendingEnabled(!0),t.setDepthTestEnabled(!1),t.setStencilWriteMask(0),t.setStencilTestEnabled(!1),t.setBlendFunction(w.dn.ONE,w.dn.ONE_MINUS_SRC_ALPHA),t.setColorMask(!0,!0,!0,!0);const r=this._program;t.bindVAO(this._vao),t.useProgram(r),r.setUniformMatrix3fv("u_dvsMat3",this._dvsMat3),t.gl.lineWidth(1),t.drawElements(w.WR.LINES,8*i.length,w.pe.UNSIGNED_INT,0),t.bindVAO()}_createTransforms(){return{displayViewScreenMat3:(0,y.vt)()}}_createShaderProgram(e){this._program||(this._program=e.programCache.acquire("precision highp float;\n        uniform mat3 u_dvsMat3;\n\n        attribute vec2 a_position;\n\n        void main() {\n          mediump vec3 pos = u_dvsMat3 * vec3(a_position, 1.0);\n          gl_Position = vec4(pos.xy, 0.0, 1.0);\n        }","precision mediump float;\n      void main() {\n        gl_FragColor = vec4(0.75, 0.0, 0.0, 0.75);\n      }",M().attributes))}_updateMatricesAndLocalOrigin(e){const{state:t}=e,{displayMat3:i,size:r,resolution:s,pixelRatio:n,rotation:a,viewpoint:o}=t,l=S*a,{x:u,y:h}=o.targetGeometry,d=(0,m.mT)(u,t.spatialReference);this._localOrigin.x=d,this._localOrigin.y=h;const p=n*r[0],y=n*r[1],_=s*p,b=s*y,x=(0,c.D_)(this._dvsMat3);(0,c.lw)(x,x,i),(0,c.Tl)(x,x,(0,f.fA)(p/2,y/2)),(0,c.hs)(x,x,(0,g.fA)(r[0]/_,-y/b,1)),(0,c.e$)(x,x,-l)}_updateBufferData(e,t){const{x:i,y:r}=this._localOrigin,s=8*t.length,n=new Float32Array(s),a=new Uint32Array(8*t.length);let o=0,l=0;for(const e of t)e&&(n[2*o]=e[0]-i,n[2*o+1]=e[1]-r,n[2*o+2]=e[0]-i,n[2*o+3]=e[3]-r,n[2*o+4]=e[2]-i,n[2*o+5]=e[3]-r,n[2*o+6]=e[2]-i,n[2*o+7]=e[1]-r,a[l]=o+0,a[l+1]=o+3,a[l+2]=o+3,a[l+3]=o+2,a[l+4]=o+2,a[l+5]=o+1,a[l+6]=o+1,a[l+7]=o+0,o+=4,l+=8);if(this._vertexBuffer?this._vertexBuffer.setData(n.buffer):this._vertexBuffer=x.g.createVertex(e,w._U.DYNAMIC_DRAW,n.buffer),this._indexBuffer?this._indexBuffer.setData(a):this._indexBuffer=x.g.createIndex(e,w._U.DYNAMIC_DRAW,a),!this._vao){const t=M();this._vao=new v.Z(e,t.attributes,t.bufferLayouts,{geometry:this._vertexBuffer},this._indexBuffer)}}}const M=()=>(0,b.ES)("bounds",{geometry:[{location:0,name:"a_position",count:2,type:w.pe.FLOAT}]});class T extends s.j{constructor(e){super(e),this._instanceStore=new p,this.checkHighlight=()=>!0}destroy(){super.destroy(),this._boundsRenderer=(0,r.pR)(this._boundsRenderer)}get instanceStore(){return this._instanceStore}enableRenderingBounds(e){this._boundsRenderer=new A(e),this.requestRender()}get hasHighlight(){return this.checkHighlight()}onTileData(e,t){e.onMessage(t),this.contains(e)||this.addChild(e),this.requestRender()}_renderChildren(e,t){e.selection=t;for(const t of this.children){if(!t.visible)continue;const i=t.getDisplayList(e.drawPhase,this._instanceStore,n.ch.STRICT_ORDER);i?.render(e)}}}},21109:(e,t,i)=>{i.d(t,{A:()=>u});var r=i(82392),s=(i(80861),i(6273),i(67498),i(62991),i(26325)),n=i(57122),a=i(52616),o=i(85202);let l=class extends a.f{get hasHighlight(){return this.children.some((e=>e.hasData))}renderChildren(e){this.attributeView.update(),e.drawPhase===n.S5.HIGHLIGHT&&this.children.some((e=>e.hasData))&&(super.renderChildren(e),e.context.setColorMask(!0,!0,!0,!0),(0,o.lB)(e,!0,(e=>{this._renderChildren(e,n.RI.All)})))}};l=(0,r._)([(0,s.$)("esri.views.2d.layers.support.HighlightGraphicContainer")],l);const u=l},24957:(e,t,i)=>{i.d(t,{Uh:()=>X,ox:()=>J});var r=i(82392),s=i(20857),n=i(73783),a=i(3223),o=i(40377),l=i(62991),u=i(70214),h=i(6273),d=i(80294),p=i(37623),c=i(61985),y=i(5262),f=i(81482),g=(i(80861),i(26325)),m=i(8e3),_=i(84459),b=i(46227),x=i(57179);function w(e,t){return t?"xoffset"in t&&t.xoffset?Math.max(e,Math.abs(t.xoffset)):"yoffset"in t&&t.yoffset?Math.max(e,Math.abs(t.yoffset||0)):e:e}function v(e,t){return"number"==typeof e?e:e?.stops?.length?function(e){let t=0,i=0;for(let r=0;r<e.length;r++){const s=e[r].size;"number"==typeof s&&(t+=s,i++)}return t/i}(e.stops):t}function S(e,t){if(!t)return e;const i=t.filter((e=>"size"===e.type)).map((t=>{const{maxSize:i,minSize:r}=t;return(v(i,e)+v(r,e))/2}));let r=0;const s=i.length;if(0===s)return e;for(let e=0;e<s;e++)r+=i[e];const n=Math.floor(r/s);return Math.max(n,e)}function A(e){const t=e?.renderer,i=e?.pointerType,r="touch"===i?9:6;if(!t)return r;const s="visualVariables"in t?S(r,t.visualVariables):r;if("simple"===t.type)return w(s,t.symbol);if("unique-value"===t.type){let e=s;return t.uniqueValueInfos?.forEach((t=>{e=w(e,t.symbol)})),e}if("class-breaks"===t.type){let e=s;return t.classBreakInfos.forEach((t=>{e=w(e,t.symbol)})),e}return"dot-density"===t.type||t.type,s}var M=i(38116),T=i(87249),R=i(36321),E=i(80189),V=i(56053),I=i(67488),D=i(22508);function z(e,t){const{dpi:i,gdbVersion:r,geometry:s,geometryPrecision:n,height:a,historicMoment:o,layerOption:l,mapExtent:u,maxAllowableOffset:h,returnFieldName:d,returnGeometry:p,returnUnformattedValues:c,returnZ:y,spatialReference:f,timeExtent:g,tolerance:m,width:b}=e.toJSON(),{dynamicLayers:w,layerDefs:v,layerIds:S}=function(e){const{mapExtent:t,floors:i,width:r,sublayers:s,layerIds:n,layerOption:a,gdbVersion:o}=e,l=s?.find((e=>null!=e.layer))?.layer?.serviceSublayers,u="popup"===a,h={},d=(0,_.X_)({extent:t,width:r,spatialReference:t?.spatialReference}),p=[],c=e=>{const t=0===d,i=0===e.minScale||d<=e.minScale,r=0===e.maxScale||d>=e.maxScale;if(e.visible&&(t||i&&r))if(e.sublayers)e.sublayers.forEach(c);else{if(!1===n?.includes(e.id)||u&&(!e.popupTemplate||!e.popupEnabled))return;p.unshift(e)}};if(s?.forEach(c),s&&!p.length)h.layerIds=[];else{const e=(0,D.Sk)(p,l,o),t=p.map((e=>{const t=(0,x.f)(i,e);return e.toExportImageJSON(t)}));if(e)h.dynamicLayers=JSON.stringify(t);else{if(s){let e=p.map((({id:e})=>e));n&&(e=e.filter((e=>n.includes(e)))),h.layerIds=e}else n?.length&&(h.layerIds=n);const e=function(e,t){const i=!!e?.length,r=t.filter((e=>null!=e.definitionExpression||i&&null!=e.floorInfo));return r.length?r.map((t=>{const i=(0,x.f)(e,t),r=(0,E.m)(i,t.definitionExpression);return{id:t.id,definitionExpression:r??void 0}})):null}(i,p);if(null!=e&&e.length){const t={};for(const i of e)i.definitionExpression&&(t[i.id]=i.definitionExpression);Object.keys(t).length&&(h.layerDefs=JSON.stringify(t))}}}return h}(e),A=null!=t?.geometry?t.geometry:null,M={historicMoment:o,geometryPrecision:n,maxAllowableOffset:h,returnFieldName:d,returnGeometry:p,returnUnformattedValues:c,returnZ:y,tolerance:m},T=A&&A.toJSON()||s;M.imageDisplay=`${b},${a},${i}`,r&&(M.gdbVersion=r),T&&(delete T.spatialReference,M.geometry=JSON.stringify(T),M.geometryType=(0,V.$B)(T));const R=f??T?.spatialReference??u?.spatialReference;if(R&&(M.sr=(0,I.YX)(R)),M.time=g?[g.start,g.end].join(","):null,u){const{xmin:e,ymin:t,xmax:i,ymax:r}=u;M.mapExtent=`${e},${t},${i},${r}`}return v&&(M.layerDefs=v),w&&!v&&(M.dynamicLayers=w),M.layers="popup"===l?"visible":l,S&&!w&&(M.layers+=`:${S.join(",")}`),M}var F,P=i(3313),O=i(54736),B=i(84977),k=i(8636),N=(i(67498),i(48524)),L=i(44153);let U=F=class extends B.oY{static from(e){return(0,k.PZ)(F,e)}constructor(e){super(e),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}};(0,r._)([(0,f.MZ)({type:Number,json:{write:!0}})],U.prototype,"dpi",void 0),(0,r._)([(0,f.MZ)()],U.prototype,"floors",void 0),(0,r._)([(0,f.MZ)({type:String,json:{write:!0}})],U.prototype,"gdbVersion",void 0),(0,r._)([(0,f.MZ)({types:P.yR,json:{read:V.rS,write:!0}})],U.prototype,"geometry",void 0),(0,r._)([(0,f.MZ)({type:Number,json:{write:!0}})],U.prototype,"geometryPrecision",void 0),(0,r._)([(0,f.MZ)({type:Number,json:{write:!0}})],U.prototype,"height",void 0),(0,r._)([(0,f.MZ)({type:Date})],U.prototype,"historicMoment",void 0),(0,r._)([(0,N.K)("historicMoment")],U.prototype,"writeHistoricMoment",null),(0,r._)([(0,f.MZ)({type:[Number],json:{write:!0}})],U.prototype,"layerIds",void 0),(0,r._)([(0,f.MZ)({type:["top","visible","all","popup"],json:{write:!0}})],U.prototype,"layerOption",void 0),(0,r._)([(0,f.MZ)({type:m.A,json:{write:!0}})],U.prototype,"mapExtent",void 0),(0,r._)([(0,f.MZ)({type:Number,json:{write:!0}})],U.prototype,"maxAllowableOffset",void 0),(0,r._)([(0,f.MZ)({type:Boolean,json:{write:!0}})],U.prototype,"returnFieldName",void 0),(0,r._)([(0,f.MZ)({type:Boolean,json:{write:!0}})],U.prototype,"returnGeometry",void 0),(0,r._)([(0,f.MZ)({type:Boolean,json:{write:!0}})],U.prototype,"returnM",void 0),(0,r._)([(0,f.MZ)({type:Boolean,json:{write:!0}})],U.prototype,"returnUnformattedValues",void 0),(0,r._)([(0,f.MZ)({type:Boolean,json:{write:!0}})],U.prototype,"returnZ",void 0),(0,r._)([(0,f.MZ)({type:L.A,json:{write:!0}})],U.prototype,"spatialReference",void 0),(0,r._)([(0,f.MZ)()],U.prototype,"sublayers",void 0),(0,r._)([(0,f.MZ)({type:O.A,json:{write:!0}})],U.prototype,"timeExtent",void 0),(0,r._)([(0,f.MZ)({type:Number,json:{write:!0}})],U.prototype,"tolerance",void 0),(0,r._)([(0,f.MZ)({type:Number,json:{write:!0}})],U.prototype,"width",void 0),U=F=(0,r._)([(0,g.$)("esri.rest.support.IdentifyParameters")],U);const G=U;var Z=i(25376),j=i(54483);let C=class extends B.oY{constructor(e){super(e),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(e,t){return s.A.fromJSON({attributes:{...t.attributes},geometry:{...t.geometry}})}writeFeature(e,t){if(!e)return;const{attributes:i,geometry:r}=e;i&&(t.attributes={...i}),null!=r&&(t.geometry=r.toJSON(),t.geometryType=j.Y.toJSON(r.type))}};(0,r._)([(0,f.MZ)({type:String,json:{write:!0}})],C.prototype,"displayFieldName",void 0),(0,r._)([(0,f.MZ)({type:s.A})],C.prototype,"feature",void 0),(0,r._)([(0,Z.w)("feature",["attributes","geometry"])],C.prototype,"readFeature",null),(0,r._)([(0,N.K)("feature")],C.prototype,"writeFeature",null),(0,r._)([(0,f.MZ)({type:Number,json:{write:!0}})],C.prototype,"layerId",void 0),(0,r._)([(0,f.MZ)({type:String,json:{write:!0}})],C.prototype,"layerName",void 0),C=(0,r._)([(0,g.$)("esri.rest.support.IdentifyResult")],C);const H=C;function $(e){const t=e.data;return t.results=t.results||[],t.exceededTransferLimit=Boolean(t.exceededTransferLimit),t.results=t.results.map((e=>H.fromJSON(e))),t}var q=i(83911),Q=i(68231),Y=i(96444);let W=null;function J(e,t){return"tile"===t.type||"map-image"===t.type}let X=class extends n.A{constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=(0,p.sg)((async e=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch((()=>{})))}))}initialize(){const e=e=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch((()=>{}))),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([(0,c.on)((()=>this.highlightGraphics),"change",(t=>e(t.added)),{onListenerAdd:t=>e(t)})])}async fetchPopupFeaturesAtLocation(e,t){const{layerView:{layer:i,view:{scale:r}}}=this;if(!e)throw new l.A("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:i});const s=function(e,t,i){const r=[];if(!e)return r;const s=e=>{const n=0===e.minScale||t<=e.minScale,a=0===e.maxScale||t>=e.maxScale;if(e.visible&&n&&a)if(e.sublayers)e.sublayers.forEach(s);else if(e.popupEnabled){const t=(0,Y.D8)(e,{...i,defaultPopupTemplateEnabled:!1});null!=t&&r.unshift({sublayer:e,popupTemplate:t})}};return e.map(s),r}(i.sublayers,r,t);if(!s.length)return[];const n=await async function(e,t){if(e.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(t.map((({sublayer:e})=>e.load().then((()=>e.capabilities.operations.supportsQuery)))))}catch{return!1}}(i,s);if(!((i.capabilities?.operations?.supportsIdentify??1)&&i.version>=10.5||n))throw new l.A("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:i});return n?this._fetchPopupFeaturesUsingQueries(e,s,t):this._fetchPopupFeaturesUsingIdentify(e,s,t)}clearHighlights(){this.highlightGraphics?.removeAll()}highlight(e){const t=this.highlightGraphics;if(!t)return(0,u.hA)();let i=null;if(e instanceof s.A?i=[e]:o.A.isCollection(e)&&e.length>0?i=e.toArray():Array.isArray(e)&&e.length>0&&(i=e),i=i?.filter(a.Ru),!i?.length)return(0,u.hA)();for(const e of i){const t=e.sourceLayer;null!=t&&"geometryType"in t&&"point"===t.geometryType&&(e.visible=!1)}return t.addMany(i),(0,u.hA)((()=>t.removeMany(i??[])))}async _updateHighlightedFeaturesSymbols(e){const{layerView:{view:t},highlightGraphics:r,highlightGraphicUpdated:s}=this;if(r&&s)for(const n of e){const e=n.sourceLayer&&"renderer"in n.sourceLayer&&n.sourceLayer.renderer;n.sourceLayer&&"geometryType"in n.sourceLayer&&"point"===n.sourceLayer.geometryType&&e&&"getSymbolAsync"in e&&e.getSymbolAsync(n).then((async a=>{a||=new Q.A;let o=null;const l="visualVariables"in e?e.visualVariables?.find((e=>"size"===e.type)):void 0;l&&(W||(W=(await Promise.resolve().then(i.bind(i,37525))).getSize),o=W(l,n,{view:t.type,scale:t.scale,shape:"simple-marker"===a.type?a.style:null})),o||="width"in a&&"height"in a&&null!=a.width&&null!=a.height?Math.max(a.width,a.height):"size"in a?a.size:16,r.includes(n)&&(n.symbol=new Q.A({style:"square",size:o,xoffset:"xoffset"in a?a.xoffset:0,yoffset:"yoffset"in a?a.yoffset:0}),s(n,"symbol"),n.visible=!0)}))}}async _updateHighlightedFeaturesGeometries(e){const{layerView:{layer:t,view:i},highlightGraphics:r,highlightGraphicUpdated:s}=this;if(this._highlightGeometriesResolution=e,!s||!r?.length||!t.capabilities.operations.supportsQuery)return;const n=this._getTargetResolution(e),a=new Map;for(const e of r)if(!this._featuresResolutions.has(e)||this._featuresResolutions.get(e)>n){const t=e.sourceLayer;(0,d.tE)(a,t,(()=>new Map)).set(e.getObjectId(),e)}const o=Array.from(a,(([e,t])=>{const r=e.createQuery();return r.objectIds=[...t.keys()],r.outFields=[e.objectIdField],r.returnGeometry=!0,r.maxAllowableOffset=n,r.outSpatialReference=i.spatialReference,e.queryFeatures(r)})),l=await Promise.all(o);if(!this.destroyed)for(const{features:e}of l)for(const t of e){const e=t.sourceLayer,i=a.get(e).get(t.getObjectId());i&&r.includes(i)&&(i.geometry=t.geometry,s(i,"geometry"),this._featuresResolutions.set(i,n))}}_getTargetResolution(e){const t=e*(0,y.GA)(this.layerView.view.spatialReference),i=t/16;return i<=10?0:e/t*i}async _fetchPopupFeaturesUsingIdentify(e,t,i){const r=await this._createIdentifyParameters(e,t,i);if(null==r)return[];const{results:s}=await async function(e,t,i){const r=(t=function(e){return G.from(e)}(t)).geometry?[t.geometry]:[],s=(0,R.Dl)(e);return s.path+="/identify",(0,T.el)(r).then((e=>{const r=z(t,{geometry:e?.[0]}),n=(0,R.lF)({...s.query,f:"json",...r}),a=(0,R.jV)(n,i);return(0,M.A)(s.path,a).then($).then((e=>function(e,t){if(!t?.length)return e;const i=new Map;t.forEach((function e(t){i.set(t.id,t),t.sublayers&&t.sublayers.forEach(e)}));for(const t of e.results)t.feature.sourceLayer=i.get(t.layerId);return e}(e,t.sublayers)))}))}(this.layerView.layer.parsedUrl,r,i);return s.map((e=>e.feature))}async _createIdentifyParameters(e,t,i){const{floors:r,layer:s,timeExtent:n,view:{spatialReference:a,scale:o}}=this.layerView;if(!t.length)return null;await Promise.all(t.map((({sublayer:e})=>e.load(i).catch((()=>{})))));const l=Math.min((0,h.A)("mapservice-popup-identify-max-tolerance"),s.allSublayers.reduce(((e,t)=>t.renderer?A({renderer:t.renderer,pointerType:i?.pointerType}):e),2)),u=this.createFetchPopupFeaturesQueryGeometry(e,l),d=(0,_.i1)(o,a),p=Math.round(u.width/d),c=new m.A({xmin:u.center.x-d*p,ymin:u.center.y-d*p,xmax:u.center.x+d*p,ymax:u.center.y+d*p,spatialReference:u.spatialReference});return new G({floors:r,gdbVersion:"gdbVersion"in s?s.gdbVersion:void 0,geometry:e,height:p,layerOption:"popup",mapExtent:c,returnGeometry:!0,spatialReference:a,sublayers:s.sublayers,timeExtent:n,tolerance:l,width:p})}async _fetchPopupFeaturesUsingQueries(e,t,i){const{layerView:{floors:r,timeExtent:s}}=this,n=t.map((async({sublayer:t,popupTemplate:n})=>{if(await t.load(i).catch((()=>{})),t.capabilities&&!t.capabilities.operations.supportsQuery)return[];const a=t.createQuery(),o=A({renderer:t.renderer,pointerType:i?.pointerType}),l=this.createFetchPopupFeaturesQueryGeometry(e,o),u=new Set,[h]=await Promise.all([(0,Y.TO)(t,n),t.renderer?.collectRequiredFields(u,t.fieldsIndex)]);(0,p.Te)(i),(0,b._w)(u,t.fieldsIndex,h);const d=Array.from(u).sort();if(a.geometry=l,a.outFields=d,a.timeExtent=s,r){const e=r.clone(),i=(0,x.f)(e,t);null!=i&&(a.where=a.where?`(${a.where}) AND (${i})`:i)}const c=this._getTargetResolution(l.width/o),y=await function(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type))?(0,q.lw)():Promise.resolve()}(n);(0,p.Te)(i);const f="point"===t.geometryType||y&&y.arcadeUtils.hasGeometryOperations(n);f||(a.maxAllowableOffset=c);let{features:g}=await t.queryFeatures(a,i);const m=f?0:c;g=await async function(e,t,i){const r=e.renderer;return r&&"defaultSymbol"in r&&!r.defaultSymbol&&(t=r.valueExpression?await Promise.all(t.map((e=>r.getSymbolAsync(e,i).then((t=>t?e:null))))).then((e=>e.filter((e=>null!=e)))):t.filter((e=>null!=r.getSymbol(e)))),t}(t,g,i);for(const e of g)this._featuresResolutions.set(e,m);return g}));return(await Promise.allSettled(n)).reduce(((e,t)=>"fulfilled"===t.status?[...e,...t.value]:e),[]).filter(a.Ru)}};(0,r._)([(0,f.MZ)({constructOnly:!0})],X.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),(0,r._)([(0,f.MZ)({constructOnly:!0})],X.prototype,"layerView",void 0),(0,r._)([(0,f.MZ)({constructOnly:!0})],X.prototype,"highlightGraphics",void 0),(0,r._)([(0,f.MZ)({constructOnly:!0})],X.prototype,"highlightGraphicUpdated",void 0),(0,r._)([(0,f.MZ)({constructOnly:!0})],X.prototype,"updatingHandles",void 0),X=(0,r._)([(0,g.$)("esri.views.layers.support.MapService")],X)},96444:(e,t,i)=>{i.d(t,{D8:()=>n,TO:()=>s,d0:()=>a});var r=i(46227);async function s(e,t=e.popupTemplate){if(null==t)return[];const i=await t.getRequiredFields(e.fieldsIndex),{lastEditInfoEnabled:s}=t,{objectIdField:n,typeIdField:a,globalIdField:o,relationships:l}=e;if(i.includes("*"))return["*"];const u=s?(0,r.eX)(e):[],h=(0,r.DB)(e.fieldsIndex,[...i,...u]);return a&&h.push(a),h&&n&&e.fieldsIndex?.has(n)&&!h.includes(n)&&h.push(n),h&&o&&e.fieldsIndex?.has(o)&&!h.includes(o)&&h.push(o),l&&l.forEach((t=>{const{keyField:i}=t;h&&i&&e.fieldsIndex?.has(i)&&!h.includes(i)&&h.push(i)})),h}function n(e,t){return e.popupTemplate?e.popupTemplate:null!=t&&t.defaultPopupTemplateEnabled&&null!=e.defaultPopupTemplate?e.defaultPopupTemplate:null}function a(e,t){return null!=n(e,{defaultPopupTemplateEnabled:t})}},17467:(e,t,i)=>{i.d(t,{V:()=>n}),i(3313);var r=i(5262),s=i(8e3);function n(e,t,i,n=new s.A){let a=0;if("2d"===i.type)a=t*(i.resolution??0);else if("3d"===i.type){const s=i.overlayPixelSizeInMapUnits(e),n=i.basemapSpatialReference;a=null==n||n.equals(i.spatialReference)?t*s:(0,r.GA)(n)/(0,r.GA)(i.spatialReference)}const o=e.x-a,l=e.y-a,u=e.x+a,h=e.y+a,{spatialReference:d}=i;return n.xmin=Math.min(o,u),n.ymin=Math.min(l,h),n.xmax=Math.max(o,u),n.ymax=Math.max(l,h),n.spatialReference=d,n}new s.A}}]);