"use strict";(self.webpackChunkmadaster_typescript=self.webpackChunkmadaster_typescript||[]).push([[4293],{26769:(e,t,a)=>{a.d(t,{Hq:()=>L,Qj:()=>C,V2:()=>m,m_:()=>f}),a(6273);var i=a(4506),n=a(8e3),o=a(65648),s=a(44153),r=a(99263),l=a(5525),p=a(65977),h=a(48277);const d=new Float64Array(2),u=new Float64Array(2),y="0123456789bcdefghjkmnpqrstuvwxyz",c=64;function m(e,t,a,i){const r=[e.xmin,e.ymin,e.xmax,e.ymax],d=o.A.fromExtent(n.A.fromBounds(r,i)),u=(0,h.Cv)(d,i,s.A.WGS84,{densificationStep:t*c}),y=(0,l.Ye)(new p.A,u,!1,!1),m=y.coords.filter(((e,t)=>!(t%2))),g=y.coords.filter(((e,t)=>t%2)),T=Math.min(...m),M=Math.min(...g),b=Math.max(...m),L=Math.max(...g),k=f(T,M,a,s.A.WGS84),C=f(b,L,a,s.A.WGS84);if(!k||!C)throw new Error("InternalError: Unable to project tile bounds");return{bounds:r,geohashBounds:{xLL:k[0],yLL:k[1],xTR:C[0],yTR:C[1]},level:a}}function f(e,t,a,n){if(n.isWebMercator){const n=(0,i.KJ)(e/r.$O.radius),o=n-360*Math.floor((n+180)/360),s=[0,0];return k(s,0,(0,i.KJ)(Math.PI/2-2*Math.atan(Math.exp(-t/r.$O.radius))),o,a),s}const o=(0,h.Cv)({x:e,y:t},n,s.A.WGS84);if(!o)return null;const l=[0,0];return k(l,0,o.y,o.x,a),l}function g(e){return y[e]}function T(e){return(e[0]+e[1])/2}function M(e,t,a){return e[0]=t,e[1]=a,e}function b(e,t){const a=t>T(e);return function(e,t){const a=T(e),i=t,n=!t;e[0]=n*e[0]+i*a,e[1]=n*a+i*e[1]}(e,a),a}function L(e,t){let a=-90,i=90,n=-180,o=180;for(let s=0;s<t;s++){const t=Math.ceil((s+1)/2),r=Math.floor((s+1)/2),l=1-s%2,p=30-(3*t+2*r),h=30-(2*t+3*r),d=3*l+2*(1-l),u=2*l+3*(1-l),y=3*l+7*(1-l)<<h,c=(7*l+3*(1-l)<<p&e.geohashX)>>p,m=(y&e.geohashY)>>h;for(let e=d-1;e>=0;e--){const t=(n+o)/2,a=c&1<<e?1:0;n=(1-a)*n+a*t,o=(1-a)*t+a*o}for(let e=u-1;e>=0;e--){const t=(a+i)/2,n=m&1<<e?1:0;a=(1-n)*a+n*t,i=(1-n)*t+n*i}}return[n,a,o,i]}function k(e,t,a,i,n){n%2&&(n+=1);let o=0,s=0,r=-90,l=90,p=-180,h=180;for(let e=0;e<n/2;e++){for(let t=0;t<5;t++){const a=(p+h)/2,n=i>a?1:0;o|=n<<29-(t+5*e),p=(1-n)*p+n*a,h=(1-n)*a+n*h}for(let t=0;t<5;t++){const i=(r+l)/2,n=a>i?1:0;s|=n<<29-(t+5*e),r=(1-n)*r+n*i,l=(1-n)*i+n*l}}e[2*t]=o,e[2*t+1]=s}function C(e,t,a){let i="";const n=M(d,-90,90),o=M(u,-180,180);for(let s=0;s<a;s++){let a=0;s%2?(a|=b(n,e)<<4,a|=b(o,t)<<3,a|=b(n,e)<<2,a|=b(o,t)<<1,a|=b(n,e)<<0):(a|=b(o,t)<<4,a|=b(n,e)<<3,a|=b(o,t)<<2,a|=b(n,e)<<1,a|=b(o,t)<<0),i+=g(a)}return i}},41473:(e,t,a)=>{a.r(t),a.d(t,{default:()=>_e});var i=a(82392),n=(a(3313),a(40377)),o=a(62991),s=a(80861),r=a(37623),l=a(81482),p=(a(6273),a(67498),a(26325)),h=a(26769),d=a(45449),u=a(5525),y=a(65977),c=a(73783),m=a(80294),f=a(80189),g=a(65648),T=a(34561),M=a(67488),b=a(85747),L=a(56053);class k{constructor(){this._featureLookup=new Map}static getInstance(){return k.instance||(k.instance=new k),k.instance}static resetInstance(){k.instance&&(k.instance=null)}deleteFromStore(e){e.forEach((e=>{this._featureLookup.delete(e)}))}readFromStoreByList(e){const t=[];return e.forEach((e=>{const a=this.readFromStoreById(e);a&&t.push(a)})),t}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,t,a){const i=[];return e.forEach((e=>{if(!e?.id)return;e.properties||(e.properties=[]);let n,o=null;if(a&&e.properties[a]&&(o=(0,u.Ux)(e.properties[a])),"originId"in e&&"destinationId"in e&&(e.properties.ESRI__ORIGIN_ID=e.originId,e.properties.ESRI__DESTINATION_ID=e.destinationId),e.properties[t]=e.id,e.id&&this._featureLookup.has(e.id)&&this._featureLookup.get(e.id).attributes){const i=this._featureLookup.get(e.id),s=JSON.parse(JSON.stringify(Object.assign(i.attributes,e.properties)));a&&e.properties[a]&&(s[a]=(0,L.rS)(e.properties[a])),n=new b.Om(o?JSON.parse(JSON.stringify(o)):i?.geometry?JSON.parse(JSON.stringify(i.geometry)):null,s,null,e.properties[t])}else n=new b.Om(o?JSON.parse(JSON.stringify(o)):null,e.properties,null,e.properties[t]);this._featureLookup.set(e.id,n),i.push(n)})),i}}a(38116);var C,w,E,x,D,I,A,_,N,R=a(89030),S=a(23783);function v(e){if(!e.spatialReference.isWGS84)throw new o.A("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");let t;return t=e.xmax>180&&e.xmin<180?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[-180,e.ymin]]]:e.xmax>180&&e.xmin>180?[[[e.xmin-360,e.ymin],[e.xmin-360,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[e.xmin-360,e.ymin]]]:e.xmax>-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin+360,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[-180,e.ymin]]]:e.xmax<-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[e.xmax+360,e.ymax],[e.xmax+360,e.ymin],[e.xmin+360,e.ymin]]]:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]],t}a(44153),(w=C||(C={})).ELEMENTUID="ELEMENTUID",w.TYPENAME="TYPENAME",C.ELEMENTUID,C.TYPENAME,function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"}(E||(E={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(x||(x={})),a(2399),a(13949),(N=D||(D={}))[N.featureResult=0]="featureResult",N[N.countResult=1]="countResult",N[N.idsResult=2]="idsResult",function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(I||(I={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(A||(A={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(_||(_={}));var G=a(10591),F=a(8e3);const j="ESRI__ID",O="ESRI__ORIGIN_ID",P="ESRI__DESTINATION_ID",q="ESRI__LAYOUT_GEOMETRY",Z=12;let $=class extends c.A{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach((a=>{a.name&&(t.set(a.name,"entity"),this._processingCacheUpdatesLookup.set(a.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(a.name),a.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(a.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((a=>{a.name&&(t.set(a.name,"relationship"),this._processingCacheUpdatesLookup.set(a.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(a.name),a.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(a.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((a,i)=>{if("entity"===t.get(i))this.entityTypeNames.add(i);else{if("relationship"!==t.get(i))return s.A.getLogger(this).warn(`A named type, ${i}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(i);this.relationshipTypeNames.add(i)}const n=new Map;a.members?.forEach((e=>{(0,m.tE)(this.memberIdTypeLookup,e.id,(()=>new Set)).add(i);const t=this.getById(e.id);t&&n.set(e.id,t)})),this.sublayerCaches.set(i,n)}))}addToLayer(e){e.forEach((({typeName:e,id:t})=>{if(!this.inclusionModeDefinition)throw new o.A("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const a=this.inclusionModeDefinition.namedTypeDefinitions.get(e);a.members||(a.members=new Map),a.members.set(t,{id:t}),(0,m.tE)(this.memberIdTypeLookup,t,(()=>new Set)).add(e)}}else{const a=new Map;a.set(t,{id:t}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:a}),(0,m.tE)(this.memberIdTypeLookup,t,(()=>new Set)).add(e)}}))}getById(e){return k.getInstance().readFromStoreById(e)}async getData(e,t,a){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let i;if(i=e||new G.A({where:"1=1",outFields:["*"]}),"link-chart"===t.parentCompositeLayer.type){const e=t.parentCompositeLayer,a=this._processingCacheUpdatesLookup.get(t.objectType.name??""),n=i.outFields,o=i.geometry;let s="",r="";o&&o.extent&&(s=(0,h.Qj)(o.extent.ymin,o.extent.xmin,Z),r=(0,h.Qj)(o.extent.ymax,o.extent.xmax,Z)),n&&1===n.length&&n[0]===j&&"1=1"===i.where||await Promise.all(a??[]);const l=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],p=[];return l.forEach((a=>{if(this.relationshipTypeNames.has(t.objectType.name)?a.geometry=e.relationshipLinkChartDiagramLookup.get(a.attributes[t.objectIdField]):a.geometry=e.entityLinkChartDiagramLookup.get(a.attributes[t.objectIdField]),a.attributes[q]=a.geometry,s&&r){const i=e.linkChartGeohashLookup.get(a.attributes[t.objectIdField]);i?i>=s&&i<=r&&p.push(a):p.push(a)}else p.push(a)})),p}return this.retrieveDataFromService(i,t,a)}async getConnectedRecordIds(e,t){const a=[];let i="";const n=[],o=new Map;if(e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e)){if(!this.entityTypeNames.has(t))return;o.has(t)?o.get(t)?.push(e):o.set(t,[e])}})),t&&0!==t?.length){for(const e of t)i=i+e+"|";i=i.slice(0,-1)}return o.forEach(((e,o)=>{let r;r=t&&0!==t?.length?`MATCH (n:${o})-[r:${i}]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`:`MATCH (n:${o})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`;const l=new Promise((t=>{(async()=>{const t=(await(0,R.executeQueryStreaming)(this.knowledgeGraph,new S.A({openCypherQuery:r,bindParameters:{ids:e}}))).resultRowsStream.getReader();try{for(;;){const{done:e,value:i}=await t.read();if(e)break;for(let e=0;e<i.length;e++){const t=i[e];a.push({id:t[0],typeName:t[1]}),a.push({id:t[2],typeName:t[3]})}}}catch(e){if("AbortError"!==e.name)throw e;s.A.getLogger(this).info("Request aborted as expected")}})().then((()=>{t()}))}));n.push(l)})),this.refreshCacheContent(),await Promise.all(n),a}async refreshCacheContent(e,t,a,i=!0){const n=k.getInstance(),s=[],r=new Map,l=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&l.set(e.name,e)})),this.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&l.set(e.name,e)})),e||this.inclusionModeDefinition?e?e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e))r.has(t)?r.get(t)?.push(e):r.set(t,[e])})):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e.useAllData?r.set(t,null):e.members&&e.members.forEach((e=>{r.has(t)&&null!==r.get(t)?r.get(t)?.push(e.id):r.set(t,[e.id])}))})):(this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&r.set(e.name,null)})),this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&r.set(e.name,null)})));for(const[e,p]of r){const r=new Promise((s=>{(async()=>{const s=new Set,r=[];let h,d="",u=!1;if(t||l.get(e)?.properties?.forEach((e=>{e.name&&s.add(e.name)})),a&&this.geographicLookup.has(e)){const t=this.geographicLookup.get(e)?.name;t&&s.add(t)}if(this.entityTypeNames.has(e))d=`MATCH (n:${e}) ${p?"WHERE id(n) IN $ids ":""}return ID(n)`,s.forEach((e=>{d+=`, n.${e}`,r.push(e)}));else{if(!this.relationshipTypeNames.has(e))throw new o.A("knowledge-graph:layer-data-manager",`The graph type of ${e} could not be determined. Was this type set in the KG data model and inclusion definition?`);u=!0,d=`MATCH ()-[n:${e}]->() ${p?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,s.forEach((e=>{d+=`, n.${e}`,r.push(e)}))}h=new S.A(p?{openCypherQuery:d,bindParameters:{ids:p}}:{openCypherQuery:d});const y=(await(0,R.executeQueryStreaming)(this.knowledgeGraph,h)).resultRowsStream.getReader();for(;;){const{done:t,value:a}=await y.read();if(t)break;const o=[];for(let e=0;e<a.length;e++){const t=a[e];let i=0,n=0;const s={properties:{}};for(s.id=t[i],i++,n++,u&&(s.originId=t[i],i++,n++,s.destinationId=t[i],i++,n++,(0,m.tE)(this.nodeConnectionsLookup,s.originId,(()=>new Set)).add(s.id),(0,m.tE)(this.nodeConnectionsLookup,s.destinationId,(()=>new Set)).add(s.id),(0,m.tE)(this.relationshipConnectionsLookup,s.id,(()=>[s.originId,s.destinationId])));i<t.length;i++)s.properties[r[i-n]]=t[i];o.push(s)}const s=n.writeToStore(o,j,this.geographicLookup.get(e)?.name);this.sublayerCaches.has(e)||this.sublayerCaches.set(e,new Map),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(e)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(e,{useAllData:!1,members:new Map}),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(e).members=new Map);const l=this.sublayerCaches.get(e);s.forEach((t=>{l?.set(t.attributes[j],t),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.has(t.attributes[j])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.set(t.attributes[j],{id:t.attributes[j]}),(0,m.tE)(this.memberIdTypeLookup,t.attributes[j],(()=>new Set)).add(e))}))}})().then((()=>{s(null)}))}));s.push(r),this._processingCacheUpdatesLookup.get(e)?.push(r)}await Promise.all(s)}removeFromLayer(e){const t=new Set,a=new Set(e.map((e=>e.id)));for(const a of e)t.add(a.typeName),1===this.memberIdTypeLookup.get(a.id)?.size?this.memberIdTypeLookup.delete(a.id):this.memberIdTypeLookup.get(a.id)?.delete(a.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{t===a.typeName&&e.members?.has(a.id)&&e.members.delete(a.id)}));t.forEach((e=>{this.sublayerCaches.get(e)?.forEach(((t,i)=>{a.has(i)&&this.sublayerCaches.get(e)?.delete(i)}))}))}async retrieveDataFromService(e,t,a){const i=k.getInstance(),n=new Set,s=[];let r,l="",p=[];const h="relationship"===t.graphType,d=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,u=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let y=!d&&u?Array.from(u).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&null!=e.objectIds&&(y=e.objectIds);else if(null!=e.objectIds&&y&&y.length>0){const t=e.objectIds;e.objectIds=y.filter((e=>t.includes(e)))}else if(null!=e.objectIds)y=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=y}if(null!=e.outFields){const a=e.outFields;a.includes("*")?t.fields.forEach((e=>{n.add(e.name)})):a.forEach((e=>{e!==j&&e!==t.geometryFieldName&&n.add(e)}))}if(null!=e.geometry){const a=e.geometry;let i;const p=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,d=p?.spatialReference,u=p?.serviceCapabilities?.geometryCapabilities;let y=u?.geometryMaxBoundingRectangleSizeX,c=u?.geometryMaxBoundingRectangleSizeY;if(a?.extent?.spatialReference&&!a.spatialReference?.isWGS84?(await(0,T.initializeProjection)(a.extent.spatialReference,M.KK),i=(0,T.project)(a.extent,M.KK)):i=a.extent,y&&c&&d){if(4326!==d.wkid){const e=new F.A({spatialReference:d,xmax:y,ymax:c}),t=(0,T.project)(e,M.KK);y=t.xmax,c=t.ymax}if(i.xmax-i.xmin>y)throw new o.A("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${y}° latitude, limit exceeded`);if(i.ymax-i.ymin>c)throw new o.A("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${c}° longitude, limit exceeded`)}if(null!=e.where&&"1=1"!==e.where){const a=await(0,f.G)(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach((e=>{a.fieldNames.includes(e.name)&&n.add(e.name)}))}l=h?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&n.add(t.geometryFieldName),n.forEach((e=>{l+=`, n.${e}`,s.push(e)})),r=new S.A({openCypherQuery:l,bindParameters:{param_filter_geom:new g.A({rings:v(i)})}})}else{let a="";if(null!=e.where&&"1=1"!==e.where){const i=await(0,f.G)(e.where,t.fieldsIndex);t.fields.forEach((e=>{i.fieldNames.includes(e.name)&&n.add(e.name)}));const o=new Set(["column-reference","string","number","binary-expression"]),s=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let r=!1;const l=e=>{if("column-reference"===e.type)return`n.${e.column}`;if("string"===e.type)return`'${e.value}'`;if("number"===e.type)return`${e.value}`;if("binary-expression"===e.type&&o.has(e.left.type)&&o.has(e.right.type)&&s.has(e.operator))return`${l(e.left)} ${e.operator} ${l(e.right)}`;if("binary-expression"===e.type&&"LIKE"===e.operator){let t="";if("function"===e.left.type&&"column-reference"===e.left.args.value[0].type)t+=`lower(n.${e.left.args.value[0].column})`;else{if("column-reference"!==e.left.type)return r=!0,"";t+=`lower(n.${e.left.column})`}if(t+=" CONTAINS (","string"!==e.right.type)return r=!0,"";{let a=e.right.value;"%"===a.charAt(0)&&(a=a.slice(1)),"%"===a.charAt(a.length-1)&&(a=a.slice(0,-1)),t+=`'${a.toLowerCase()}')`}return t}return r=!0,""};a=l(i.parseTree),r&&(a="")}let i="";i=h?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let o=!1;y&&(o=!0,i+=" WHERE ID(n) IN $ids"),a&&(i+=o?" AND":" WHERE",i+=` ${a}`),i+=" return ID(n)",h&&(i+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&n.add(t.geometryFieldName),n.forEach((e=>{i+=`, n.${e}`,s.push(e)})),r=new S.A(y?{openCypherQuery:i,bindParameters:{ids:y}}:{openCypherQuery:i})}const c=(await(0,R.executeQueryStreaming)(t.parentCompositeLayer.dataManager.knowledgeGraph,r,a)).resultRowsStream.getReader();for(;;){const{done:e,value:a}=await c.read();if(e)break;const n=[];for(let e=0;e<a.length;e++){const t=a[e];let i=0,o=0;const r={properties:{}};for(r.id=t[i],i++,o++,h&&(r.originId=t[i],i++,o++,r.destinationId=t[i],i++,o++);i<t.length;i++)r.properties[s[i-o]]=t[i];n.push(r)}p=p.concat(i.writeToStore(n,j,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return p}};(0,i._)([(0,l.MZ)()],$.prototype,"knowledgeGraph",void 0),(0,i._)([(0,l.MZ)()],$.prototype,"inclusionModeDefinition",void 0),(0,i._)([(0,l.MZ)()],$.prototype,"entityTypeNames",void 0),(0,i._)([(0,l.MZ)()],$.prototype,"relationshipTypeNames",void 0),(0,i._)([(0,l.MZ)()],$.prototype,"geographicLookup",void 0),(0,i._)([(0,l.MZ)()],$.prototype,"sublayerCaches",void 0),(0,i._)([(0,l.MZ)()],$.prototype,"nodeConnectionsLookup",void 0),(0,i._)([(0,l.MZ)()],$.prototype,"relationshipConnectionsLookup",void 0),(0,i._)([(0,l.MZ)()],$.prototype,"memberIdTypeLookup",void 0),$=(0,i._)([(0,p.$)("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],$);var Q=a(20879),U=(a(42957),a(8499),a(72502),a(2394),a(52721),a(46243),a(79645),a(1851),a(29221)),B=a(83015),H=(a(73462),a(91582)),J=a(52790),z=a(77159);const Y=(0,a(83693).p)(),V=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return(0,i._)([(0,l.MZ)(Y.fields)],t.prototype,"fields",void 0),(0,i._)([(0,l.MZ)(Y.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=(0,i._)([(0,p.$)("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],t),t};var W=a(20923),K=a(36576),X=a(51177),ee=a(22111),te=a(41332),ae=a(45352),ie=a(46227),ne=a(74704),oe=a(95610),se=a(15331),re=a(38648),le=a(54483);let pe=class extends((0,K.J)(V((0,W.d)((0,ee.j)((0,X.J)(d.A)))))){constructor(e){if(super(e),this.capabilities=(0,z.f)(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=j,this.objectType=null,this.parentCompositeLayer=null,this.popupEnabled=!0,this.popupTemplate=null,this.source={openPorts:()=>this.load().then((()=>{const e=new MessageChannel;return new se.A(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{const a=G.A.fromJSON(e);return this.queryFeaturesJSON(a,t)}}}),[e.port2]}))},this.type="knowledge-graph-sublayer","link-chart"===e.parentCompositeLayer.type)"relationship"===e.graphType?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=q;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&"esriGeometryNull"!==e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?le.g.fromJSON(t.geometryType):null;const a=t?.name,i=a?e.objectType.properties?.[a]:null;i?(this.hasM=i.hasM??!1,this.hasZ=i.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach((e=>{let t=e.fieldType;"esriFieldTypeOID"===t&&(t="esriFieldTypeInteger"),this.fields.push(ae.A.fromJSON({name:e.name,type:t,alias:e.alias,defaultValue:null,editable:e.editable,nullable:e.nullable}))})),this.fields.push(ae.A.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this._set("fields",[...this.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),"link-chart"===e.parentCompositeLayer.type?"relationship"===e.graphType?this.renderer=(0,U.r)((0,z.F0)(le.g.toJSON("polyline")).renderer):this.renderer=(0,U.r)((0,z.F0)(le.g.toJSON("point")).renderer):this.renderer=(0,U.r)((0,z.F0)(le.g.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){(0,ie.yp)(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return(0,oe.tn)(this,e)}createQuery(){return new G.A({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];return null}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:a,queryEngine:i}=await this._setupQueryObjects(e),n=ne.A.fromJSON(await i.executeQuery(a.toJSON(),t?.signal));return n.features.forEach((e=>{e.sourceLayer=this})),n}async queryFeaturesJSON(e,t){const{resolvedQuery:a,queryEngine:i}=await this._setupQueryObjects(e);return await i.executeQuery(a.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:a,queryEngine:i}=await this._setupQueryObjects(e);return i.executeQueryForCount(a.toJSON(),t?.signal)}async queryExtent(e={},t){const a={...e,returnGeometry:!0},{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(a),o=await n.executeQueryForExtent(i.toJSON(),t?.signal);let s;return s=null!=o.extent?.xmin&&null!=o.extent?.xmax&&null!=o.extent?.ymin&&null!=o.extent?.ymax?new F.A(o.extent):new F.A,{count:o.count,extent:s}}async queryObjectIds(e,t){const a=G.A.from(e);let i;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(a,this,t);i=this.loadQueryEngine(e)}return i.executeQueryForIds(a.toJSON(),t?.signal)}loadQueryEngine(e){const t=new H.A({geometryType:le.g.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),a=new J.d({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:le.g.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return a.featureStore.addMany(e),a}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new G.A({where:"1=1",outFields:[j]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){const a=G.A.from(e),i=a.geometry;let n;if(i&&!i.spatialReference?.isWGS84&&(await(0,T.initializeProjection)(i.spatialReference,M.KK),a.geometry=(0,T.project)(i instanceof g.A||i instanceof re.A?i:i.extent,M.KK)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)n=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(a,this,t);n=this.loadQueryEngine(e)}return{resolvedQuery:a,queryEngine:n}}};(0,i._)([(0,l.MZ)()],pe.prototype,"capabilities",void 0),(0,i._)([(0,l.MZ)({readOnly:!0})],pe.prototype,"defaultPopupTemplate",null),(0,i._)([(0,l.MZ)()],pe.prototype,"definitionExpression",void 0),(0,i._)([(0,l.MZ)()],pe.prototype,"displayField",void 0),(0,i._)([(0,l.MZ)()],pe.prototype,"elevationInfo",void 0),(0,i._)([(0,l.MZ)()],pe.prototype,"geometryType",void 0),(0,i._)([(0,l.MZ)()],pe.prototype,"geometryFieldName",void 0),(0,i._)([(0,l.MZ)()],pe.prototype,"graphType",void 0),(0,i._)([(0,l.MZ)()],pe.prototype,"hasM",void 0),(0,i._)([(0,l.MZ)()],pe.prototype,"hasZ",void 0),(0,i._)([(0,l.MZ)()],pe.prototype,"labelsVisible",void 0),(0,i._)([(0,l.MZ)()],pe.prototype,"labelingInfo",void 0),(0,i._)([(0,l.MZ)()],pe.prototype,"objectIdField",void 0),(0,i._)([(0,l.MZ)()],pe.prototype,"objectType",void 0),(0,i._)([(0,l.MZ)()],pe.prototype,"parentCompositeLayer",void 0),(0,i._)([(0,l.MZ)(te.M6)],pe.prototype,"popupEnabled",void 0),(0,i._)([(0,l.MZ)({type:Q.A,json:{name:"popupInfo",write:!0}})],pe.prototype,"popupTemplate",void 0),(0,i._)([(0,l.MZ)({types:B.H,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],pe.prototype,"renderer",null),(0,i._)([(0,l.MZ)()],pe.prototype,"source",void 0),(0,i._)([(0,l.MZ)({json:{read:!1}})],pe.prototype,"type",void 0),pe=(0,i._)([(0,p.$)("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],pe);const he=pe;var de=a(44764);let ue,ye=null;var ce,me,fe,ge,Te,Me,be,Le,ke,Ce,we;function Ee(e,t,a,i,n,o){const s=a.length,r=n.length,l=Float64Array.BYTES_PER_ELEMENT,p=Uint32Array.BYTES_PER_ELEMENT,h=Uint8Array.BYTES_PER_ELEMENT,d=15+s*(h+2*l)+r*(2*p),u=ye._malloc(d);try{const h=u+16-u%16,d=h+s*l,y=d+s*l,c=y+r*p,m=c+r*p,f=()=>[ye.HEAPF64.subarray(h>>3,(h>>3)+s),ye.HEAPF64.subarray(d>>3,(d>>3)+s),ye.HEAPU32.subarray(y>>2,(y>>2)+r),ye.HEAPU32.subarray(c>>2,(c>>2)+r),ye.HEAPU8.subarray(m,m+s)],[g,T,M,b,L]=f();g.set(a),T.set(i),M.set(n),b.set(o),L.set(t);const k=e(s,m,h,d,r,y,c);let C=null;if(k){const e=ye.getLayoutLinksTypes(),t=ye.getLayoutLinksVerticesEndIndices(),a=ye.getLayoutLinksVertices(),i=ye.countLayoutLinksVertices();C={types:ye.HEAPU8.subarray(e,e+r),vertexEndIndex:ye.HEAPU32.subarray(t>>2,(t>>2)+r),vertices:ye.HEAPF64.subarray(a>>3,(a>>3)+2*i)}}const[w,E,x,D,I]=f();return a.set(w),i.set(E),n.set(x),o.set(D),t.set(I),{success:k,links:C}}finally{ye._free(u),ye.cleanupLayout()}}(fe=ce||(ce={}))[fe.None=0]="None",fe[fe.IsMovable=1]="IsMovable",fe[fe.IsGeographic=2]="IsGeographic",fe[fe.IsRoot=4]="IsRoot",function(e){e[e.Regular=0]="Regular",e[e.Orthogonal=1]="Orthogonal",e[e.Curved=2]="Curved",e[e.Recursive=3]="Recursive"}(me||(me={})),function(e){e.getMinIdealEdgeLength=function(){return ye.getMinIdealEdgeLength()},e.apply=function(e,t,a,i,n,o=2,s=1,r=-1){return Ee(((e,t,a,i,n,l,p)=>ye.applyForceDirectedLayout(e,t,a,i,n,l,p,o,s,r)),e,t,a,i,n)}}(ge||(ge={})),function(e){e.apply=function(e,t,a,i,n,o=2,s=1,r=-1){return Ee(((e,t,a,i,n,l,p)=>ye.applyCommunityLayout(e,t,a,i,n,l,p,o,s,r)),e,t,a,i,n)}}(Te||(Te={})),function(e){e.apply=function(e,t,a,i,n){return Ee(ye.applySimpleLayout,e,t,a,i,n)}}(Me||(Me={})),function(e){e.apply=function(e,t,a,i,n){return Ee(ye.applyHierarchicalLayout,e,t,a,i,n)}}(be||(be={})),function(e){e.apply=function(e,t,a,i,n){return Ee(ye.applyRadialTreeLayout,e,t,a,i,n)}}(Le||(Le={})),function(e){e.apply=function(e,t,a,i,n){return Ee(ye.applySmartTreeLayout,e,t,a,i,n)}}(ke||(ke={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(Ce||(Ce={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(we||(we={}));var xe=a(16466),De=a(1895),Ie=a(8977);let Ae=class extends((0,W.d)((0,ee.j)(d.A))){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE",xScaleFactor:1,yScaleFactor:1},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new n.A,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new F.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new n.A,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new o.A("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){const e=this.url.split("/");this.title=e[e.length-2]}const t=new Set;let a=[],i=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new o.A("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.inclusionModeDefinition?.generateAllSublayers?(a=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((n,o)=>{if(!this._graphTypeLookup.get(o))return s.A.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(o);this._graphTypeLookup.get(o)instanceof De.A||"strictOrigin"in this._graphTypeLookup.get(o)?t.has(o)||(t.add(o),i.push(this._graphTypeLookup.get(o))):this._graphTypeLookup.get(o)instanceof xe.A||"properties"in this._graphTypeLookup.get(o)?t.has(o)||(t.add(o),a.push(this._graphTypeLookup.get(o))):(s.A.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(o))})):(a=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]);const n=new $({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=a,this.memberRelationshipTypes=i,this.dataManager=n}load(e){return this.addResolvingPromise(new Promise((t=>{(0,R.fetchKnowledgeGraph)(this.url).then((a=>{if(this._initializeLayerProperties({knowledgeGraph:a,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})})),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})}))),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e=>{e.useAllData=!1,e.members?.forEach((e=>{let t;t=e.linkChartLocation instanceof y.A?e.linkChartLocation:e.linkChartLocation?(0,u.Ux)(e.linkChartLocation):null,t&&2===t.coords.length&&0===t.lengths.length?(this.linkChartGeohashLookup.set(e.id,(0,h.Qj)(t.coords[1],t.coords[0],Z)),this.entityLinkChartDiagramLookup.set(e.id,t)):(this.linkChartGeohashLookup.set(e.id,""),this.relationshipLinkChartDiagramLookup.set(e.id,t))})),this.addResolvingPromise(this._initializeDiagram().then((async()=>{this.layers.forEach((async e=>{await e.refreshCachedQueryEngine()})),this.tables.forEach((async e=>{await e.refreshCachedQueryEngine()}))})))}));else{const t="GEOGRAPHIC"===this.defaultLinkChartConfig?.layoutMode;this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,t,!0).then((async()=>{(0,r.Te)(e);const t=[],a=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach((e=>{e.useAllData=!1}))),await this._initializeDiagram(),this.layers.forEach((e=>{a.push(e.refreshCachedQueryEngine()),t.push(new Promise((t=>{e.on("layerview-create",(()=>{t(null)}))})))})),this.tables.forEach((e=>{a.push(e.refreshCachedQueryEngine())})),await Promise.all(a)})))}t(null)}))}))),Promise.resolve(this)}async addRecords(e,t){let a=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(a=await async function(e,t){const a=[],i=new Map,n=[];if(t.dataModel?.relationshipTypes)for(const e of t.dataModel.relationshipTypes)e.name&&i.set(e.name,[]);for(const t of e)i.has(t.typeName)&&i.get(t.typeName)?.push(t.id);for(const[e,o]of i){if(o.length<1)continue;const i=new S.A({openCypherQuery:`MATCH (n)-[r:${e}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:o}});n.push((0,R.executeQueryStreaming)(t,i).then((async e=>{const t=e.resultRowsStream.getReader();for(;;){const{done:e,value:i}=await t.read();if(e)break;for(const e of i)a.push({id:e[0],typeName:e[1]}),a.push({id:e[2],typeName:e[3]})}})))}return await Promise.all(n),a}(e,this.dataManager.knowledgeGraph));const i=e.concat(a).filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));await this._handleNewRecords(i)}async removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:a=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){let i=[];for(const t of e)!1===this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.useAllData&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.members?.has(t.id)&&i.push(t);if(t){const e=new Set,t=[];for(const t of i)if(this.dataManager.nodeConnectionsLookup.has(t.id))for(const a of this.dataManager.nodeConnectionsLookup.get(t.id))e.add(a);for(const a of e)if(this.dataManager.memberIdTypeLookup.has(a))for(const e of this.dataManager.memberIdTypeLookup.get(a))this.dataManager.relationshipTypeNames.has(e)&&t.push({id:a,typeName:e});i=i.concat(t)}this.dataManager.removeFromLayer(i);for(const e of i)this.sublayerIdsCache.get(e.typeName)?.delete(e.id),this.dataManager.relationshipTypeNames.has(e.typeName)?this.relationshipLinkChartDiagramLookup.delete(e.id):this.entityLinkChartDiagramLookup.delete(e.id);a&&await this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,{xScaleFactor:this._currentLinkChartConfig.xScaleFactor,yScaleFactor:this._currentLinkChartConfig.xScaleFactor});const n=[];return this.layers.forEach((e=>{n.push(e.refreshCachedQueryEngine())})),await Promise.all(n),this._refreshNamedTypes(),i}async expand(e,t){const a=await this.dataManager.getConnectedRecordIds(e,t),i=a.filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));return await this._handleNewRecords(a),{records:i}}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach((e=>{const t=new he({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.memberEntityTypes.forEach((e=>{const t=new he({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{const a=((e,t,a)=>(e.has(t)||e.set(t,new Set),e.get(t)))(this.sublayerIdsCache,t);e.members?.forEach((e=>{if(a.add(e.id),e.linkChartLocation)if(e.linkChartLocation instanceof y.A)this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation),2===e.linkChartLocation.coords.length&&0===e.linkChartLocation.lengths.length?this.linkChartGeohashLookup.set(e.id,(0,h.Qj)(e.linkChartLocation.coords[1],e.linkChartLocation.coords[0],Z)):this.linkChartGeohashLookup.set(e.id,"");else{const a=(0,u.Ux)(e.linkChartLocation);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation?a:null):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation?a:null),"x"in e.linkChartLocation&&"y"in e.linkChartLocation?this.linkChartGeohashLookup.set(e.id,(0,h.Qj)(e.linkChartLocation.x,e.linkChartLocation.y,Z)):this.linkChartGeohashLookup.set(e.id,"")}}))}))}async calculateLinkChartLayout(e="RADIAL_TREE",t){const i=[],n=[];this.dataManager.sublayerCaches.forEach(((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach((e=>{i.push({typeName:t,feature:e})})):this.dataManager.relationshipTypeNames.has(t)&&e.forEach((e=>{n.push({typeName:t,feature:e})}))})),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const r=new Map,l=new Map,p=new Map,d=new Map,y=new Uint8Array(i.length),c=new Float64Array(i.length),m=new Float64Array(i.length),f=new Uint32Array(n.length),g=new Uint32Array(n.length),T=[],M=t?.xScaleFactor??1,b=t?.yScaleFactor??1,L=new F.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let k,C="FORCE_DIRECTED",w=0,E=0;switch(C="GEOGRAPHIC"===e?"FORCE_DIRECTED":e,C){case"FORCE_DIRECTED":k=ge.apply;break;case"COMMUNITY":k=Te.apply;break;case"HIERARCHICAL":k=be.apply;break;case"RADIAL_TREE":k=Le.apply;break;case"SMART_TREE":k=ke.apply;break;default:k=Me.apply}i.forEach((({typeName:a,feature:i})=>{if(t?.lockedNodeLocations?.has(i.attributes[j])){"GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(a)?y[w]=ce.IsGeographic:y[w]=ce.None;const n=t.lockedNodeLocations.get(i.attributes[j]);c[w]=n.x,m[w]=n.y}else if("GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(a)){y[w]=ce.IsGeographic;let e=null;const t=i.attributes[this.dataManager.geographicLookup.get(a).name],n=this.dataManager.geographicLookup.get(a)?.geometryType;switch(n){case"esriGeometryPoint":c[w]=t?.x,m[w]=t?.y;break;case"esriGeometryPolygon":e=t?.centroid,null!=e?.x&&null!=e?.y?(c[w]=e.x,m[w]=e.y):y[w]=ce.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":e=t?.extent?.center,null!=e?.x&&null!=e?.y?(c[w]=e.x,m[w]=e.y):y[w]=ce.IsMovable;break;default:y[w]=ce.IsMovable}(null==c[w]||null==m[w]||Number.isNaN(c[w])||Number.isNaN(m[w]))&&(y[w]=ce.IsMovable,c[w]=0,m[w]=0)}else y[w]=ce.IsMovable,c[w]=0,m[w]=0;d.set(i.attributes[j],w),T[w]={feature:i,typeName:a},w++}));let x=!1;n.forEach((e=>{const t=d.get(e.feature.attributes[O]),a=d.get(e.feature.attributes[P]);void 0!==t&&void 0!==a?(f[E]=t,g[E]=a,E++):(x=!0,this.relationshipLinkChartDiagramLookup.set(e.feature.attributes[O],null),this.linkChartGeohashLookup.set(e.feature.attributes[O],null))})),x&&s.A.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await(ue||(ue=a.e(2933).then(a.bind(a,22933)).then((e=>e.l)).then((({default:e})=>e({locateFile:e=>(0,de.s)(`esri/libs/linkchartlayout/${e}`)}))).then((e=>{!function(e){ye=e}(e)})),ue));const{success:D}=k(y,c,m,f,g);if(!D)throw new o.A("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let e=0;e<T.length;e++){if(y[e]===ce.IsMovable&&(c[e]=c[e]*M,m[e]=m[e]*b),m[e]>84.9999&&(m[e]=84.9999),m[e]<-84.9999&&(m[e]=-84.9999),c[e]>179.9999&&(c[e]=179.9999),c[e]<-179.9999&&(c[e]=-179.9999),T[e].feature.attributes[q]=new Ie.A(c[e],m[e]),r.has(T[e].typeName)){const t=r.get(T[e].typeName);t?.set(T[e].feature.attributes[j],T[e].feature)}else{const t=new Map;t.set(T[e].feature.attributes[j],T[e].feature),r.set(T[e].typeName,t)}p.set(T[e].feature.attributes[j],T[e].feature);const t=(0,u.Ux)(T[e].feature.attributes[q]);this.entityLinkChartDiagramLookup.set(T[e].feature.attributes[j],T[e].feature.attributes[q]?t:null),this.linkChartGeohashLookup.set(T[e].feature.attributes[j],(0,h.Qj)(T[e].feature.attributes[q].y,T[e].feature.attributes[q].x,Z)),T[e].feature.attributes[q].x<L.xmin&&(L.xmin=T[e].feature.attributes[q].x),T[e].feature.attributes[q].x>L.xmax&&(L.xmax=T[e].feature.attributes[q].x),T[e].feature.attributes[q].y<L.ymin&&(L.ymin=T[e].feature.attributes[q].y),T[e].feature.attributes[q].y>L.ymax&&(L.ymax=T[e].feature.attributes[q].y)}return this.linkChartExtent.xmin=L.xmin,this.linkChartExtent.xmax=L.xmax,this.linkChartExtent.ymin=L.ymin,this.linkChartExtent.ymax=L.ymax,n.forEach((e=>{const t=T[d.get(e.feature.attributes[O])]?.feature.attributes[q],a=T[d.get(e.feature.attributes[P])]?.feature.attributes[q];if(!t||!a)return;const i=new re.A({paths:[[t.x,t.y],[a.x,a.y]]});if(e.feature.attributes[q]=i,l.has(e.typeName)){const t=l.get(e.typeName);t?.set(e.feature.attributes[j],e.feature)}else{const t=new Map;t.set(e.feature.attributes[j],e.feature),l.set(e.typeName,t)}p.set(e.feature.attributes[j],e.feature);const n=(0,u.Ux)(e.feature.attributes[q]);this.relationshipLinkChartDiagramLookup.set(e.feature.attributes[j],e.feature.attributes[q]?n:null),this.linkChartGeohashLookup.set(e.feature.attributes[j],"")})),this._currentLinkChartConfig={layoutMode:e,xScaleFactor:M,yScaleFactor:b},{nodes:r,links:l,idMap:p}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){const a=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach((e=>{a.push(e.refreshCachedQueryEngine())})),await Promise.all(a),this._refreshNamedTypes()}getCurrentNodeLocations(){const e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t=>{t?.members?.forEach((t=>{const a=t.linkChartLocation;let i;const n=t.id;a&&(i="x"in a?{x:a.x,y:a.y}:{x:a.coords[0],y:a.coords[1]},e.set(n,new Ie.A({x:i.x,y:i.y})))}))})),e}async synchronizeInclusionListWithCache(){return new Promise((e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{if(e.useAllData=!1,e.members&&e.members.size>0){if(!this.dataManager.sublayerCaches.get(t))return;const a=new Set(Array.from(this.dataManager.sublayerCaches.get(t).keys()));Array.from(e.members.keys()).filter((e=>!a.has(e))).forEach((t=>{e.members?.delete(t)}))}})),e()}))}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach((e=>{t.push(e.refreshCachedQueryEngine())})),await Promise.all(t),this._refreshNamedTypes()}async _handleNewRecords(e){const t=[];this.dataManager.addToLayer(e);for(const a of e)this.sublayerIdsCache.has(a.typeName)||(this.sublayerIdsCache.set(a.typeName,new Set),t.push(a.typeName)),this.sublayerIdsCache.get(a.typeName).add(a.id);for(const e of t)if(this._graphTypeLookup.has(e)){const t=this._graphTypeLookup.get(e),a="endPoints"in t?"relationship":"entity",i=new he({objectType:t,parentCompositeLayer:this,graphType:a,title:e});"entity"===a?this.dataManager.entityTypeNames.add(e):this.dataManager.relationshipTypeNames.add(e),i.geometryType?this.layers.push(i):this.tables.push(i),this.dataManager.sublayerCaches.set(e,new Map)}await this.dataManager.refreshCacheContent(e.map((e=>e.id))),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,{xScaleFactor:this._currentLinkChartConfig.xScaleFactor,yScaleFactor:this._currentLinkChartConfig.xScaleFactor})}async _initializeDiagram(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e?.members?.forEach((e=>{const a=e.linkChartLocation;let i;const n=e.id;if(!a)return;i="x"in a?{x:a.x,y:a.y}:{x:a.coords[0],y:a.coords[1]};const o=(0,u.Ux)(i);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(n,o):this.entityLinkChartDiagramLookup.set(n,o),this.linkChartGeohashLookup.set(n,(0,h.Qj)(i.x,i.y,Z)),this.linkChartExtent.xmin>i.x&&(this.linkChartExtent.xmin=i.x),this.linkChartExtent.xmax<i.x&&(this.linkChartExtent.xmax=i.x),this.linkChartExtent.ymin>i.y&&(this.linkChartExtent.ymin=i.y),this.linkChartExtent.ymax<i.y&&(this.linkChartExtent.ymax=i.y)}))})),this.memberRelationshipTypes.forEach((e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach((e=>{const t=this.relationshipLinkChartDiagramLookup.get(e.attributes[O]),a=this.relationshipLinkChartDiagramLookup.get(e.attributes[P]);if(t&&a){const i=(0,u.Ux)(new re.A({paths:[[t.coords[0],t.coords[1]],[a.coords[0],a.coords[1]]]}));this.relationshipLinkChartDiagramLookup.set(e.attributes[j],i)}else this.relationshipLinkChartDiagramLookup.set(e.attributes[j],null);this.linkChartGeohashLookup.set(e.attributes[j],"")}))}))):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{xScaleFactor:this.defaultLinkChartConfig.xScaleFactor,yScaleFactor:this.defaultLinkChartConfig.yScaleFactor,lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}};(0,i._)([(0,l.MZ)()],Ae.prototype,"dataPreloadedInLocalCache",void 0),(0,i._)([(0,l.MZ)()],Ae.prototype,"defaultLinkChartConfig",void 0),(0,i._)([(0,l.MZ)()],Ae.prototype,"dataManager",void 0),(0,i._)([(0,l.MZ)()],Ae.prototype,"knowledgeGraph",void 0),(0,i._)([(0,l.MZ)()],Ae.prototype,"layers",void 0),(0,i._)([(0,l.MZ)()],Ae.prototype,"entityLinkChartDiagramLookup",void 0),(0,i._)([(0,l.MZ)()],Ae.prototype,"relationshipLinkChartDiagramLookup",void 0),(0,i._)([(0,l.MZ)()],Ae.prototype,"linkChartExtent",void 0),(0,i._)([(0,l.MZ)()],Ae.prototype,"linkChartGeohashLookup",void 0),(0,i._)([(0,l.MZ)()],Ae.prototype,"memberEntityTypes",void 0),(0,i._)([(0,l.MZ)()],Ae.prototype,"memberRelationshipTypes",void 0),(0,i._)([(0,l.MZ)()],Ae.prototype,"sublayerIdsCache",void 0),(0,i._)([(0,l.MZ)()],Ae.prototype,"tables",void 0),(0,i._)([(0,l.MZ)({json:{read:!1}})],Ae.prototype,"type",void 0),Ae=(0,i._)([(0,p.$)("esri.layers.LinkChartLayer")],Ae);const _e=Ae},77159:(e,t,a)=>{a.d(t,{F0:()=>r,Vx:()=>h,e2:()=>d,f:()=>u});var i=a(6273),n=a(15565),o=a(52557),s=a(51103);function r(e){return{renderer:{type:"simple",symbol:"esriGeometryPoint"===e||"esriGeometryMultipoint"===e?s.Cb:"esriGeometryPolyline"===e?s.yM:s.WR}}}const l=/^[_$a-zA-Z][_$a-zA-Z0-9]*$/;let p=1;function h(e,t){if((0,i.A)("esri-csp-restrictions"))return()=>({[t]:null,...e});try{let a=`this.${t} = null;`;for(const t in e)a+=`this${l.test(t)?`.${t}`:`["${t}"]`} = ${JSON.stringify(e[t])};`;const i=new Function(`\n      return class AttributesClass$${p++} {\n        constructor() {\n          ${a};\n        }\n      }\n    `)();return()=>new i}catch(a){return()=>({[t]:null,...e})}}function d(e={}){return[{name:"New Feature",description:"",prototype:{attributes:(0,n.o8)(e)}}]}function u(e,t){return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:e},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:t,supportsDelete:t,supportsEditing:t,supportsChangeTracking:!1,supportsQuery:!0,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:t,supportsExceedsLimitStatistics:!0,supportsAsyncConvert3D:!1},query:o.F,queryRelated:{supportsCount:!0,supportsOrderBy:!0,supportsPagination:!0,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},editing:{supportsGeometryUpdate:t,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsAsyncApplyEdits:!1,zDefault:void 0}}}},81114:(e,t,a)=>{a.d(t,{A:()=>p});var i=a(82392),n=(a(3313),a(81482)),o=(a(6273),a(80861),a(67498),a(26325)),s=a(80211),r=a(8977);let l=class extends s.A{constructor(e){super(e),this.layoutGeometry=null}};(0,i._)([(0,n.MZ)({type:r.A,json:{write:!0}})],l.prototype,"layoutGeometry",void 0),l=(0,i._)([(0,o.$)("esri.rest.knowledgeGraph.Entity")],l);const p=l},80211:(e,t,a)=>{a.d(t,{A:()=>l});var i=a(82392),n=a(81482),o=(a(6273),a(80861),a(67498),a(26325)),s=a(92450);let r=class extends s.A{constructor(e){super(e),this.typeName=null,this.id=null}};(0,i._)([(0,n.MZ)({type:String,json:{write:!0}})],r.prototype,"typeName",void 0),(0,i._)([(0,n.MZ)({type:String,json:{write:!0}})],r.prototype,"id",void 0),r=(0,i._)([(0,o.$)("esri.rest.knowledgeGraph.GraphNamedObject")],r);const l=r},92450:(e,t,a)=>{a.d(t,{A:()=>l});var i=a(82392),n=a(84977),o=a(81482),s=(a(6273),a(80861),a(67498),a(26325));let r=class extends n.oY{constructor(e){super(e),this.properties=null}};(0,i._)([(0,o.MZ)({json:{write:!0}})],r.prototype,"properties",void 0),r=(0,i._)([(0,s.$)("esri.rest.knowledgeGraph.GraphObject")],r);const l=r},23783:(e,t,a)=>{a.d(t,{A:()=>h});var i=a(82392),n=a(81482),o=(a(6273),a(80861),a(67498),a(26325)),s=a(73783);let r=class extends s.A{constructor(e){super(e),this.openCypherQuery=""}};(0,i._)([(0,n.MZ)()],r.prototype,"openCypherQuery",void 0),r=(0,i._)([(0,o.$)("esri.rest.knowledgeGraph.GraphQuery")],r);const l=r;let p=class extends l{constructor(e){super(e),this.bindParameters=null,this.bindGeometryQuantizationParameters=null,this.outputQuantizationParameters=null,this.outputSpatialReference=null}};(0,i._)([(0,n.MZ)()],p.prototype,"bindParameters",void 0),(0,i._)([(0,n.MZ)()],p.prototype,"bindGeometryQuantizationParameters",void 0),(0,i._)([(0,n.MZ)()],p.prototype,"outputQuantizationParameters",void 0),(0,i._)([(0,n.MZ)()],p.prototype,"outputSpatialReference",void 0),p=(0,i._)([(0,o.$)("esri.rest.knowledgeGraph.GraphQueryStreaming")],p);const h=p},60097:(e,t,a)=>{a.d(t,{A:()=>r});var i=a(82392),n=(a(80861),a(6273),a(67498),a(62991),a(26325)),o=a(92450);let s=class extends o.A{constructor(e){super(e)}};s=(0,i._)([(0,n.$)("esri.rest.knowledgeGraph.ObjectValue")],s);const r=s},28530:(e,t,a)=>{a.d(t,{A:()=>p});var i=a(82392),n=a(84977),o=a(81482),s=(a(6273),a(80861),a(67498),a(26325)),r=a(92450);let l=class extends n.oY{constructor(e){super(e),this.path=null}};(0,i._)([(0,o.MZ)({type:[r.A],json:{write:!0}})],l.prototype,"path",void 0),l=(0,i._)([(0,s.$)("esri.rest.knowledgeGraph.Path")],l);const p=l},95324:(e,t,a)=>{a.d(t,{A:()=>p});var i=a(82392),n=(a(3313),a(81482)),o=(a(6273),a(80861),a(67498),a(26325)),s=a(80211),r=a(38648);let l=class extends s.A{constructor(e){super(e),this.originId=null,this.destinationId=null,this.layoutGeometry=null}};(0,i._)([(0,n.MZ)({type:String,json:{write:!0}})],l.prototype,"originId",void 0),(0,i._)([(0,n.MZ)({type:String,json:{write:!0}})],l.prototype,"destinationId",void 0),(0,i._)([(0,n.MZ)({type:r.A,json:{write:!0}})],l.prototype,"layoutGeometry",void 0),l=(0,i._)([(0,o.$)("esri.rest.Relationship.Relationship")],l);const p=l}}]);