"use strict";(self.webpackChunkmadaster_typescript=self.webpackChunkmadaster_typescript||[]).push([[3091,7942],{26318:(e,t,i)=>{i.d(t,{b:()=>c});const r=2654435761,s=2246822519,n=3266489917,a=668265263,o=374761393;function l(e){const t=[];for(let i=0,r=e.length;i<r;i++){let r=e.charCodeAt(i);r<128?t.push(r):r<2048?t.push(192|r>>6,128|63&r):r<55296||r>=57344?t.push(224|r>>12,128|r>>6&63,128|63&r):(i++,r=65536+((1023&r)<<10|1023&e.charCodeAt(i)),t.push(240|r>>18,128|r>>12&63,128|r>>6&63,128|63&r))}return new Uint8Array(t)}class c{constructor(e){this._seed=e,this._totallen=0,this._bufs=[],this.init()}init(){return this._bufs=[],this._totallen=0,this}updateFloatArray(e){const t=[];for(const i of e)isNaN(i)?t.push("NaN"):i===1/0?t.push("Infinity"):i===-1/0?t.push("-Infinity"):0===i?t.push("0"):t.push(i.toString(16));this.update(l(t.join("")))}updateIntArray(e){const t=Int32Array.from(e);this.update(new Uint8Array(t.buffer))}updateUint8Array(e){this.update(Uint8Array.from(e))}updateWithString(e){return this.update(l(e))}update(e){return this._bufs.push(e),this._totallen+=e.length,this}digest(){const e=new Uint8Array(this._totallen);let t=0;for(const i of this._bufs)e.set(i,t),t+=i.length;return this.init(),this._xxHash32(e,this._seed)}_xxHash32(e,t=0){const i=e;let l=t+o&4294967295,c=0;if(i.length>=16){const i=[t+r+s&4294967295,t+s&4294967295,t+0&4294967295,t-r&4294967295],n=e,a=n.length-16;let o=0;for(c=0;(4294967280&c)<=a;c+=4){const e=c,t=n[e]+(n[e+1]<<8),a=n[e+2]+(n[e+3]<<8),l=t*s+(a*s<<16);let h=i[o]+l&4294967295;h=h<<13|h>>>19;const d=65535&h,u=h>>>16;i[o]=d*r+(u*r<<16)&4294967295,o=o+1&3}l=(i[0]<<1|i[0]>>>31)+(i[1]<<7|i[1]>>>25)+(i[2]<<12|i[2]>>>20)+(i[3]<<18|i[3]>>>14)&4294967295}l=l+e.length&4294967295;const h=e.length-4;for(;c<=h;c+=4){const e=c,t=i[e]+(i[e+1]<<8),r=i[e+2]+(i[e+3]<<8);l=l+(t*n+(r*n<<16))&4294967295,l=l<<17|l>>>15,l=(65535&l)*a+((l>>>16)*a<<16)&4294967295}for(;c<i.length;++c)l+=i[c]*o,l=l<<11|l>>>21,l=(65535&l)*r+((l>>>16)*r<<16)&4294967295;return l^=l>>>15,l=((65535&l)*s&4294967295)+((l>>>16)*s<<16),l^=l>>>13,l=((65535&l)*n&4294967295)+((l>>>16)*n<<16),l^=l>>>16,l<0?l+4294967296:l}}},38382:(e,t,i)=>{i.d(t,{C:()=>S,b:()=>x});var r=i(47635),s=i(77788),n=i(29592),a=i(31790),o=i(38587),l=i(73713),c=i(23932),h=i(15479),d=i(65630),u=i(24578),p=i(78546),f=i(83660),g=i(69952),m=i(92121),_=i(41014),y=i(92624),v=i(7782),b=i(33763);function x(e){const t=new y.N5,{vertex:i,fragment:x,attributes:S,varyings:w}=t;(0,g.NB)(i,e),t.include(a.d,e),t.include(l.c,e),t.include(u.A,e),t.include(o.g,e),S.add(b.r.POSITION,"vec3"),e.vvColor&&S.add(b.r.COLORFEATUREATTRIBUTE,"float"),w.add("vColor","vec4"),w.add("vpos","vec3");const C=e.multipassEnabled&&(e.output===s.V.Color||e.output===s.V.Alpha);C&&w.add("depth","float"),i.uniforms.add(new m.E("eColor",(e=>e.color)));const R=e.output===s.V.LinearDepth;R&&(t.include(c.L,e),(0,r.xJ)(t),(0,r.Mu)(t)),i.code.add(_.H`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${e.hasVertexColors?"vColor *= eColor;":e.vvColor?"vColor = eColor * interpolateVVColor(colorFeatureAttribute);":"vColor = eColor;"}
      ${C?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${R?_.H`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:_.H`transformPosition(proj, view, vpos);`}
    }
  `),t.include(n.HQ,e),C&&t.include(d.Q,e),x.include(f.a);const E=e.output===s.V.Highlight;return E&&t.include(h.Qh,e),x.code.add(_.H`
  void main() {
    discardBySlice(vpos);
    ${C?"terrainDepthTest(depth);":""}
    vec4 fColor = vColor;

    ${e.output===s.V.ObjectAndLayerIdColor?_.H`fColor.a = 1.0;`:""}

    if (fColor.a < ${_.H.float(p.y)}) {
      discard;
    }

    ${e.output===s.V.Alpha?_.H`fragColor = vec4(fColor.a);`:""}

    ${e.output===s.V.Color?_.H`fragColor = highlightSlice(fColor, vpos); ${e.transparencyPassType===v.y.Color?"fragColor = premultiplyAlpha(fragColor);":""}`:""}
    ${E?_.H`outputHighlight();`:""};
    ${e.output===s.V.LinearDepth?_.H`outputDepth(linearDepth);`:""};
    ${e.output===s.V.ObjectAndLayerIdColor?_.H`outputObjectAndLayerIdColor();`:""}
  }
  `),t}const S=Object.freeze(Object.defineProperty({__proto__:null,build:x},Symbol.toStringTag,{value:"Module"}))},32052:(e,t,i)=>{i.d(t,{H:()=>I,b:()=>T,c:()=>P});var r=i(53334),s=i(56560),n=i(76982),a=i(77788),o=i(29592),l=i(38587),c=i(65895),h=i(87331),d=i(73227),u=i(16075),p=i(15479),f=i(24578),g=i(78546),m=i(83660),_=i(80002),y=i(15510),v=i(69952),b=i(66579),x=i(92121),S=i(19635),w=i(41014),C=i(92624),R=i(19778),E=i(7782),A=i(33763);function T(e){const t=new C.N5,i=e.signedDistanceFieldEnabled;if(t.include(h.Q,e),t.include(o.HQ,e),e.occlusionPass)return t.include(d.I,e),t;const{vertex:s,fragment:T}=t;t.include(y.Y6),T.include(_.W),T.include(m.a),t.include(f.A,e),t.include(l.g,e),t.include(u.y),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),t.varyings.add("voccluded","float"),s.uniforms.add(new x.E("viewport",((e,t)=>t.camera.fullViewport)),new b.G("screenOffset",((e,t)=>(0,r.hZ)(M,2*e.screenOffset[0]*t.camera.pixelRatio,2*e.screenOffset[1]*t.camera.pixelRatio))),new b.G("anchorPosition",(e=>P(e))),new x.E("materialColor",(e=>e.color))),(0,v.Nz)(s),i&&(s.uniforms.add(new x.E("outlineColor",(e=>e.outlineColor))),T.uniforms.add(new x.E("outlineColor",(e=>O(e)?e.outlineColor:n.uY)),new S.m("outlineSize",(e=>O(e)?e.outlineSize:0)))),e.pixelSnappingEnabled&&s.include(c.K),e.hasScreenSizePerspective&&((0,y.pM)(s),(0,y.OH)(s)),e.debugDrawLabelBorder&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add(A.r.UV0,"vec2"),t.attributes.add(A.r.COLOR,"vec4"),t.attributes.add(A.r.SIZE,"vec2"),t.attributes.add(A.r.FEATUREATTRIBUTE,"vec4"),s.code.add(w.H`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      forwardObjectAndLayerIdColor();

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${e.hasScreenSizePerspective?w.H`
            inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
            vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:w.H`
            inputSize = size;
            vec2 screenOffsetScaled = screenOffset;`}

      ${e.vvSize?"inputSize *= vvScale(featureAttribute).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);
      bool visible = testHUDVisibility(posProj);
      voccluded = visible ? 0.0 : 1.0;
    `);const I=w.H`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPosition) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,D=e.pixelSnappingEnabled?i?w.H`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:w.H`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:w.H`posProj += quadOffset;`;s.code.add(w.H`
    ${e.occlusionTestEnabled?"if (visible) {":""}
    ${I}
    ${e.vvColor?"vcolor = interpolateVVColor(featureAttribute.y) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    ${e.output===a.V.ObjectAndLayerIdColor?w.H`vcolor.a = 1.0;`:""}

    bool alphaDiscard = vcolor.a < ${w.H.float(g.y)};
    ${i?`alphaDiscard = alphaDiscard && outlineColor.a < ${w.H.float(g.y)};`:""}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${D}
      gl_Position = posProj;
    }

    vtc = uv;

    ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
    vsize = inputSize;
    ${e.occlusionTestEnabled?w.H`} else { vtc = vec2(0.0);
      ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
  }
  `),T.uniforms.add(new R.N("tex",(e=>e.texture)));const F=e.debugDrawLabelBorder?w.H`(isBorder > 0.0 ? 0.0 : ${w.H.float(g.H)})`:w.H.float(g.H),L=w.H`
    ${e.debugDrawLabelBorder?w.H`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${e.sampleSignedDistanceFieldTexelCenter?w.H`
      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      float txSize = float(textureSize(tex, 0).x);
      float texelSize = 1.0 / txSize;

      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;
      `:w.H`
      vec2 samplePos = vtc;
      `}

    ${i?w.H`
      vec4 fillPixelColor = vcolor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${F} ||
          fillPixelColor.a + outlinePixelColor.a < ${w.H.float(g.y)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        fragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${F}) {
          discard;
        }

        fragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // fragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:w.H`
          vec4 texColor = texture(tex, vtc, -0.5);
          if (texColor.a < ${F}) {
            discard;
          }
          fragColor = texColor * premultiplyAlpha(vcolor);
          `}

    // Draw debug border with transparency, so that original texels along border are still partially visible
    ${e.debugDrawLabelBorder?w.H`fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`:""}
  `;switch(e.output){case a.V.Color:T.code.add(w.H`
        void main() {
          ${L}
          ${e.transparencyPassType===E.y.FrontFace?"fragColor.rgb /= fragColor.a;":""}
        }`);break;case a.V.Alpha:T.code.add(w.H`
        void main() {
          ${L}
          fragColor = vec4(fragColor.a);
        }`);break;case a.V.ObjectAndLayerIdColor:T.code.add(w.H`
        void main() {
          ${L}
          outputObjectAndLayerIdColor();
        }`);break;case a.V.Highlight:T.constants.add("occludedHighlightFlag","vec4",p.U),T.constants.add("unoccludedHighlightFlag","vec4",p.bO),T.code.add(w.H`
        void main() {
          ${L}
          if (voccluded == 1.0) {
            fragColor = occludedHighlightFlag;
          } else {
            fragColor = unoccludedHighlightFlag;
          }
        }`)}return t}function O(e){return e.outlineColor[3]>0&&e.outlineSize>0}function P(e,t=M){return e.textureIsSignedDistanceField?function(e,t,i){null!=t?(0,r.hZ)(i,e[0]*(t[2]-t[0])+t[0],e[1]*(t[3]-t[1])+t[1]):(0,r.hZ)(i,0,0)}(e.anchorPosition,e.distanceFieldBoundingBox,t):(0,r.C)(t,e.anchorPosition),t}const M=(0,s.vt)(),I=Object.freeze(Object.defineProperty({__proto__:null,build:T,calculateAnchorPosForRendering:P},Symbol.toStringTag,{value:"Module"}))},77148:(e,t,i)=>{i.d(t,{H:()=>h,b:()=>c});var r=i(28019),s=i(22180),n=i(19635),a=i(41014),o=i(92624),l=i(19778);function c(e){const t=new o.N5;t.include(r.c),t.include(s.g);const{usesHalfFloat:i}=e;return t.fragment.uniforms.add(new l.N("densityMap",(e=>e.densityMap)),new l.N("tex",(e=>e.colorRamp)),new n.m("densityNormalizer",(e=>1/(e.maxDensity-e.minDensity))),new n.m("minDensity",(e=>e.minDensity)),new n.m("densityMultiplier",(e=>3/(e.searchRadius*e.searchRadius*Math.PI)))),i&&t.constants.add("compressionFactor","float",4),t.fragment.code.add(a.H`
    void main() {
      float density = texture(densityMap, uv).r * densityMultiplier${i?a.H` * compressionFactor`:""};
      float densityRatio = (density - minDensity) * densityNormalizer;

      vec4 color = texture(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));

      discardOrAdjustAlpha(color);
      fragColor = color;
    }
  `),t}const h=Object.freeze(Object.defineProperty({__proto__:null,build:c},Symbol.toStringTag,{value:"Module"}))},80506:(e,t,i)=>{i.d(t,{H:()=>c,b:()=>l});var r=i(69952),s=i(19635),n=i(41014),a=i(92624),o=i(33763);function l(e){const t=new a.N5,{vertex:i,fragment:l,attributes:c,varyings:h}=t;(0,r.NB)(i,e);const{isAttributeDriven:d,usesHalfFloat:u}=e;return c.add(o.r.POSITION,"vec3"),c.add(o.r.UV0,"vec2"),d&&(c.add(o.r.FEATUREATTRIBUTE,"float"),h.add("attributeValue","float")),u&&t.constants.add("compressionFactor","float",.25),h.add("unitCirclePos","vec2"),i.uniforms.add(new s.m("radius",(({resolutionForScale:e,searchRadius:t},{camera:i,screenToWorldRatio:r,overlayStretch:s})=>2*t*(0===e?1:e/r)*i.pixelRatio/i.fullViewport[2]/s))),i.code.add(n.H`
    void main() {
      unitCirclePos = uv0;

      vec4 posProj = proj * (view * vec4(${o.r.POSITION}, 1.0));
      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);

      ${d?n.H`attributeValue = ${o.r.FEATUREATTRIBUTE};`:""}
      gl_Position = posProj + quadOffset;
    }
  `),l.code.add(n.H`
    void main() {
      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
      if (radiusRatioSquared > 1.0) {
        discard;
      }

      float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;
      float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared ${d?n.H` * attributeValue`:""} ${u?n.H` * compressionFactor`:""};
      fragColor = vec4(density);
    }
  `),t}const c=Object.freeze(Object.defineProperty({__proto__:null,build:l},Symbol.toStringTag,{value:"Module"}))},63254:(e,t,i)=>{i.d(t,{L:()=>x,b:()=>y});var r=i(53334),s=i(56560),n=i(76982),a=i(29592),o=i(65895),l=i(87331),c=i(16075),h=i(43793),d=i(15510),u=i(66579),p=i(92121),f=i(19635),g=i(41014),m=i(92624),_=i(33763);function y(e){const t=new m.N5,{vertex:i,fragment:s}=t;return i.include(o.K),t.include(l.Q,e),t.include(a.HQ,e),t.attributes.add(_.r.UV0,"vec2"),i.uniforms.add(new p.E("viewport",((e,t)=>t.camera.fullViewport)),new f.m("lineSize",((e,t)=>e.size>0?Math.max(1,e.size)*t.camera.pixelRatio:0)),new u.G("pixelToNDC",((e,t)=>(0,r.hZ)(b,2/t.camera.fullViewport[2],2/t.camera.fullViewport[3]))),new f.m("borderSize",((e,t)=>null!=e.borderColor?t.camera.pixelRatio:0)),new u.G("screenOffset",((e,t)=>(0,r.hZ)(b,e.horizontalScreenOffset*t.camera.pixelRatio,0)))),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),e.multipassEnabled&&t.varyings.add("depth","float"),e.occlusionTestEnabled&&t.include(c.y),e.hasScreenSizePerspective&&(0,d.OH)(i),i.code.add(g.H`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${e.occlusionTestEnabled?g.H`
      if (!testHUDVisibility(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${e.hasScreenSizePerspective?g.H`
      vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:g.H`vec2 screenOffsetScaled = screenOffset;`}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly used to get the
      // correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${e.multipassEnabled?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(centerOffsetAndDistance.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${e.depthHudEnabled?e.depthHudAlignStartEnabled?g.H`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:g.H`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.hasScreenSizePerspective?g.H`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:g.H`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (-halfPixelSize - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),s.uniforms.add(new p.E("uColor",(e=>v(e.color))),new p.E("borderColor",(e=>v(e.borderColor)))),e.multipassEnabled&&(s.include(h.H,e),s.uniforms.add(new u.G("inverseViewport",((e,t)=>t.inverseViewport)))),s.code.add(g.H`
    void main() {
      ${e.multipassEnabled?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line blends on top of the
      // border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage and the color alpha
      float borderAlpha = uColor.a * borderColor.a * coverage.y;
      float colorAlpha = uColor.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${e.depthHudEnabled?g.H`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:g.H`
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
      fragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),t}function v(e){return null!=e?e:n.uY}const b=(0,s.vt)(),x=Object.freeze(Object.defineProperty({__proto__:null,build:y},Symbol.toStringTag,{value:"Module"}))},94066:(e,t,i)=>{i.d(t,{L:()=>E,b:()=>R});var r=i(4498),s=i(47635),n=i(77788),a=i(29592),o=i(37303),l=i(23932),c=i(47913),h=i(65630),d=i(78546),u=i(83660),p=i(80002),f=i(69952),g=i(66579),m=i(92121),_=i(19635),y=i(41014),v=i(99040),b=i(92624),x=i(19778),S=i(7782),w=i(33763),C=i(18994);function R(e){const t=new b.N5,i=e.multipassEnabled&&(e.output===n.V.Color||e.output===n.V.Alpha),R=e.space===C.lM.World;t.include(o.s,e),t.include(c.r,e),e.output===n.V.LinearDepth&&t.include(l.L,e);const{vertex:E,fragment:A}=t;return A.include(p.W),(0,f.NB)(E,e),t.attributes.add(w.r.POSITION,"vec3"),t.attributes.add(w.r.PREVPOSITION,"vec3"),t.attributes.add(w.r.UV0,"vec2"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vUV","vec2"),t.varyings.add("vSize","float"),(0,s.Mu)(t),i&&t.varyings.add("depth","float"),e.hasTip&&t.varyings.add("vLineWidth","float"),E.uniforms.add(new g.G("nearFar",((e,t)=>t.camera.nearFar)),new m.E("viewport",((e,t)=>t.camera.fullViewport))),E.code.add(y.H`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),E.code.add(y.H`void clip(vec4 pos, inout vec4 prev) {
float vnp = nearFar[0] * 0.99;
if (prev.z > -nearFar[0]) {
float interpolation = (-vnp - pos.z) / (prev.z - pos.z);
prev = mix(pos, prev, interpolation);
}
}`),R?(t.attributes.add(w.r.NORMAL,"vec3"),(0,f.S7)(E),E.constants.add("tiltThreshold","float",.7),E.code.add(y.H`vec3 perpendicular(vec3 v) {
vec3 n = (viewNormal * vec4(normal.xyz, 1.0)).xyz;
vec3 n2 = cross(v, n);
vec3 forward = vec3(0.0, 0.0, 1.0);
float tiltDot = dot(forward, n);
return abs(tiltDot) < tiltThreshold ? n : n2;
}`)):E.code.add(y.H`vec2 perpendicular(vec2 v) {
return vec2(v.y, -v.x);
}`),E.code.add(y.H`
      #define vecN ${R?"vec3":"vec2"}

      vecN normalizedSegment(vecN pos, vecN prev) {
        vecN segment = pos - prev;
        float segmentLen = length(segment);

        // normalize or zero if too short
        return (segmentLen > 0.001) ? segment / segmentLen : ${R?"vec3(0.0, 0.0, 0.0)":"vec2(0.0, 0.0)"};
      }

      vecN displace(vecN pos, vecN prev, float displacementLen) {
        vecN segment = normalizedSegment(pos, prev);

        vecN displacementDirU = perpendicular(segment);
        vecN displacementDirV = segment;

        ${e.anchor===C.kJ.Tip?"pos -= 0.5 * displacementLen * displacementDirV;":""}

        return pos + displacementLen * (uv0.x * displacementDirU + uv0.y * displacementDirV);
      }
    `),e.space===C.lM.Screen&&(E.uniforms.add(new v.X("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix))),E.code.add(y.H`vec3 inverseProject(vec4 posScreen) {
posScreen.xy = (posScreen.xy / viewport.zw) * posScreen.w;
return (inverseProjectionMatrix * posScreen).xyz;
}`),E.code.add(y.H`bool rayIntersectPlane(vec3 rayDir, vec3 planeOrigin, vec3 planeNormal, out vec3 intersection) {
float cos = dot(rayDir, planeNormal);
float t = dot(planeOrigin, planeNormal) / cos;
intersection = t * rayDir;
return abs(cos) > 0.001 && t > 0.0;
}`),E.uniforms.add(new _.m("perScreenPixelRatio",((e,t)=>t.camera.perScreenPixelRatio))),E.code.add(y.H`
      vec4 toFront(vec4 displacedPosScreen, vec3 posLeft, vec3 posRight, vec3 prev, float lineWidth) {
        // Project displaced position back to camera space
        vec3 displacedPos = inverseProject(displacedPosScreen);

        // Calculate the plane that we want the marker to lie in. Note that this will always be an approximation since ribbon lines are generally
        // not planar and we do not know the actual position of the displaced prev vertices (they are offset in screen space, too).
        vec3 planeNormal = normalize(cross(posLeft - posRight, posLeft - prev));
        vec3 planeOrigin = posLeft;

        ${e.hasCap?"\n                if(prev.z > posLeft.z) {\n                  vec2 diff = posLeft.xy - posRight.xy;\n                  planeOrigin.xy += perpendicular(diff) / 2.0;\n                }\n              ":""};

        // Move the plane towards the camera by a margin dependent on the line width (approximated in world space). This tolerance corrects for the
        // non-planarity in most cases, but sharp joins can place the prev vertices at arbitrary positions so markers can still clip.
        float offset = lineWidth * perScreenPixelRatio;
        planeOrigin *= (1.0 - offset);

        // Intersect camera ray with the plane and make sure it is within clip space
        vec3 rayDir = normalize(displacedPos);
        vec3 intersection;
        if (rayIntersectPlane(rayDir, planeOrigin, planeNormal, intersection) && intersection.z < -nearFar[0] && intersection.z > -nearFar[1]) {
          return vec4(intersection.xyz, 1.0);
        }

        // Fallback: use depth of pos or prev, whichever is closer to the camera
        float minDepth = planeOrigin.z > prev.z ? length(planeOrigin) : length(prev);
        displacedPos *= minDepth / length(displacedPos);
        return vec4(displacedPos.xyz, 1.0);
      }
  `)),(0,f.Nz)(E),(0,s.i$)(t),E.code.add(y.H`void main(void) {
if (uv0.y == 0.0) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
}
else {
float lineWidth = getLineWidth();
float screenMarkerSize = getScreenMarkerSize();
vec4 pos  = view * vec4(position, 1.0);
vec4 prev = view * vec4(prevPosition, 1.0);
clip(pos, prev);`),R?(e.hideOnShortSegments&&E.code.add(y.H`if (areWorldMarkersHidden(pos, prev)) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
return;
}`),E.code.add(y.H`pos.xyz = displace(pos.xyz, prev.xyz, getWorldMarkerSize(pos));
vec4 displacedPosScreen = projectAndScale(pos);`)):(E.code.add(y.H`vec4 posScreen = projectAndScale(pos);
vec4 prevScreen = projectAndScale(prev);
vec4 displacedPosScreen = posScreen;
displacedPosScreen.xy = displace(posScreen.xy, prevScreen.xy, screenMarkerSize);`),e.space===C.lM.Screen&&E.code.add(y.H`vec2 displacementDirU = perpendicular(normalizedSegment(posScreen.xy, prevScreen.xy));
vec3 lineRight = inverseProject(posScreen + lineWidth * vec4(displacementDirU.xy, 0.0, 0.0));
vec3 lineLeft = pos.xyz + (pos.xyz - lineRight);
pos = toFront(displacedPosScreen, lineLeft, lineRight, prev.xyz, lineWidth);
displacedPosScreen = projectAndScale(pos);`)),E.code.add(y.H`
        ${i?"depth = pos.z;":""}
        linearDepth = calculateLinearDepth(nearFar,pos.z);

        // Convert back into NDC
        displacedPosScreen.xy = (displacedPosScreen.xy / viewport.zw) * displacedPosScreen.w;

        // Convert texture coordinate into [0,1]
        vUV = (uv0 + 1.0) / 2.0;

        ${R?"":"vUV *= displacedPosScreen.w;"}

        ${e.hasTip?"vLineWidth = lineWidth;":""}

        vSize = screenMarkerSize;
        vColor = getColor();

        // Use camera space for slicing
        vpos = pos.xyz;

        gl_Position = displacedPosScreen;
      }
    }
  `),i&&t.include(h.Q,e),t.include(a.HQ,e),A.uniforms.add(new m.E("intrinsicColor",(e=>e.color)),new x.N("tex",(e=>e.markerTexture))),A.include(u.a),t.constants.add("texelSize","float",1/r.vO),A.code.add(y.H`float markerAlpha(vec2 samplePos) {
samplePos += vec2(0.5, -0.5) * texelSize;
float sdf = rgba2float(texture(tex, samplePos)) - 0.5;
float distance = sdf * vSize;
distance -= 0.5;
return clamp(0.5 - distance, 0.0, 1.0);
}`),e.hasTip&&(t.constants.add("relativeMarkerSize","float",r.Cz/r.vO),t.constants.add("relativeTipLineWidth","float",r.DZ),A.code.add(y.H`
    float tipAlpha(vec2 samplePos) {
      // Convert coordinates s.t. they are in pixels and relative to the tip of an arrow marker
      samplePos -= vec2(0.5, 0.5 + 0.5 * relativeMarkerSize);
      samplePos *= vSize;

      float halfMarkerSize = 0.5 * relativeMarkerSize * vSize;
      float halfTipLineWidth = 0.5 * max(1.0, relativeTipLineWidth * vLineWidth);

      ${R?"halfTipLineWidth *= fwidth(samplePos.y);":""}

      float distance = max(abs(samplePos.x) - halfMarkerSize, abs(samplePos.y) - halfTipLineWidth);
      return clamp(0.5 - distance, 0.0, 1.0);
    }
  `)),t.constants.add("symbolAlphaCutoff","float",d.y),A.code.add(y.H`
  void main() {
    discardBySlice(vpos);
    ${i?"terrainDepthTest(depth);":""}

    vec4 finalColor = intrinsicColor * vColor;

    ${R?"vec2 samplePos = vUV;":"vec2 samplePos = vUV * gl_FragCoord.w;"}

    ${e.hasTip?"finalColor.a *= max(markerAlpha(samplePos), tipAlpha(samplePos));":"finalColor.a *= markerAlpha(samplePos);"}

    ${e.output===n.V.ObjectAndLayerIdColor?y.H`finalColor.a = 1.0;`:""}

    if (finalColor.a < symbolAlphaCutoff) {
      discard;
    }

    ${e.output===n.V.Alpha?y.H`fragColor = vec4(finalColor.a);`:""}
    ${e.output===n.V.Color?y.H`fragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===n.V.Color&&e.transparencyPassType===S.y.Color?"fragColor = premultiplyAlpha(fragColor);":""}
    ${e.output===n.V.Highlight?y.H`fragColor = vec4(1.0);`:""}
    ${e.output===n.V.LinearDepth?y.H`outputDepth(linearDepth);`:""}
  }
  `),t}const E=Object.freeze(Object.defineProperty({__proto__:null,build:R},Symbol.toStringTag,{value:"Module"}))},71005:(e,t,i)=>{i.d(t,{N:()=>m,b:()=>g});var r=i(77788),s=i(29592),n=i(31790),a=i(73713),o=i(15479),l=i(78546),c=i(69952),h=i(92121),d=i(19635),u=i(41014),p=i(92624),f=i(33763);function g(e){const t=new p.N5,{vertex:i,fragment:g}=t;return t.include(n.d,e),t.include(a.c,e),(0,c.NB)(i,e),t.attributes.add(f.r.POSITION,"vec3"),t.varyings.add("vpos","vec3"),i.code.add(u.H`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);
}`),e.output===r.V.Highlight&&t.include(o.Qh,e),t.include(s.HQ,e),g.uniforms.add(new d.m("alphaCoverage",((e,t)=>Math.min(1,e.width*t.camera.pixelRatio)))),e.hasVertexColors||g.uniforms.add(new h.E("constantColor",(e=>e.color))),g.code.add(u.H`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${e.hasVertexColors?"vColor":"constantColor"};

    ${e.output===r.V.ObjectAndLayerIdColor?u.H`color.a = 1.0;`:""}

    if (color.a < ${u.H.float(l.y)}) {
      discard;
    }

    ${e.output===r.V.Color?u.H`fragColor = highlightSlice(color, vpos);`:""}
    ${e.output===r.V.Highlight?u.H`outputHighlight();`:""}
  }
  `),t}const m=Object.freeze(Object.defineProperty({__proto__:null,build:g},Symbol.toStringTag,{value:"Module"}))},58062:(e,t,i)=>{i.d(t,{O:()=>h,a:()=>u,b:()=>d});var r=i(68986),s=i(28019),n=i(19635),a=i(88531),o=i(41014),l=i(92624),c=i(19778);class h extends o.Y{constructor(){super(...arguments),this.overlayIndex=r.vr.INNER,this.opacity=1}}function d(){const e=new l.N5;return e.include(s.c),e.fragment.uniforms.add(new c.N("tex",(e=>e.texture))),e.fragment.uniforms.add(new a.c("overlayIdx",(e=>e.overlayIndex))),e.fragment.uniforms.add(new n.m("opacity",(e=>e.opacity))),e.fragment.code.add(o.H`void main() {
vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;
}`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:h,build:d},Symbol.toStringTag,{value:"Module"}))},43575:(e,t,i)=>{i.d(t,{P:()=>R,b:()=>C});var r=i(47635),s=i(77788),n=i(29592),a=i(31790),o=i(40198),l=i(23932),c=i(15479),h=i(23883),d=i(31434),u=i(40574),p=i(65630),f=i(23605),g=i(60769),m=i(88251),_=i(83660),y=i(69952),v=i(64802),b=i(19635),x=i(41014),S=i(92624),w=i(7782);function C(e){const t=new S.N5,{vertex:i,fragment:C}=t;switch((0,y.NB)(i,e),t.varyings.add("vpos","vec3"),t.include(o.H,e),e.output!==s.V.Color&&e.output!==s.V.Alpha||(t.include(a.d,e),t.include(m.Bz,e),t.include(r.oD,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vcolor","vec4"),e.multipassEnabled&&t.varyings.add("depth","float"),i.code.add(x.H`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${e.multipassEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${e.output===s.V.Color?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),t.include(p.Q,e),e.output){case s.V.Alpha:t.include(n.HQ,e),C.uniforms.add(new b.m("opacity",(e=>e.opacity))),C.code.add(x.H`
      void main() {
        discardBySlice(vpos);
        ${e.multipassEnabled?"terrainDepthTest(depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        fragColor = vec4(combinedOpacity);
      }
    `);break;case s.V.Color:t.include(n.HQ,e),t.include(d.kA,e),t.include(h.n,e),t.include(m.Bz,e),t.include(f.r,e),(0,y.yu)(C,e),(0,d.a8)(C),(0,d.eU)(C),C.uniforms.add(i.uniforms.get("localOrigin"),new v.t("ambient",(e=>e.ambient)),new v.t("diffuse",(e=>e.diffuse)),new v.t("specular",(e=>e.specular)),new b.m("opacity",(e=>e.opacity))),C.include(_.a),(0,u.O4)(C),C.code.add(x.H`
        void main() {
          discardBySlice(vpos);
          ${e.multipassEnabled?"terrainDepthTest(depth);":""}

          shadingParams.viewDirection = normalize(vpos - cameraPosition);
          shadingParams.normalView = vnormal;
          vec3 normal = shadingNormal(shadingParams);
          float ssao = evaluateAmbientOcclusionInverse();

          float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
          ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
          vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
          float combinedOpacity = vcolor.a * opacity;
          albedo += 0.25 * specular; // don't completely ignore specular for now

          vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
          fragColor = vec4(shadedColor, combinedOpacity);
          fragColor = highlightSlice(fragColor, vpos);
          ${e.transparencyPassType===w.y.Color?"fragColor = premultiplyAlpha(fragColor);":""}
        }
      `);break;case s.V.LinearDepth:case s.V.Shadow:case s.V.ShadowHighlight:case s.V.ShadowExcludeHighlight:t.include(a.d,e),(0,r.xJ)(t),t.varyings.add("depth","float"),i.code.add(x.H`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),t.include(n.HQ,e),t.include(l.L,e),C.code.add(x.H`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`);break;case s.V.Normal:t.include(a.d,e),t.include(g.n,e),(0,y.S7)(i),t.varyings.add("vnormal","vec3"),i.code.add(x.H`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(n.HQ,e),C.code.add(x.H`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`);break;case s.V.Highlight:t.include(a.d,e),t.include(g.n,e),t.varyings.add("vnormal","vec3"),i.code.add(x.H`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(n.HQ,e),t.include(c.Qh,e),C.code.add(x.H`void main() {
discardBySlice(vpos);
outputHighlight();
}`)}return t}const R=Object.freeze(Object.defineProperty({__proto__:null,build:C},Symbol.toStringTag,{value:"Module"}))},49526:(e,t,i)=>{i.d(t,{P:()=>A,b:()=>E});var r=i(47635),s=i(77788),n=i(29592),a=i(31790),o=i(38587),l=i(73713),c=i(23932),h=i(15479),d=i(65630),u=i(24578),p=i(78546),f=i(83660),g=i(69952),m=i(92121),_=i(19635),y=i(41014),v=i(92624),b=i(7782),x=i(33763),S=i(72253);const w=.70710678118,C=w,R=.08715574274;function E(e){const t=new v.N5,i=e.multipassEnabled&&(e.output===s.V.Color||e.output===s.V.Alpha),{vertex:E,fragment:A,attributes:T,varyings:O}=t;(0,g.NB)(E,e),t.include(a.d,e),t.include(l.c,e),t.include(u.A,e),t.include(o.g,e),e.draped?E.uniforms.add(new _.m("worldToScreenRatio",((e,t)=>1/t.screenToPCSRatio))):T.add(x.r.BOUNDINGRECT,"mat3"),T.add(x.r.POSITION,"vec3"),T.add(x.r.UVMAPSPACE,"vec4"),e.vvColor&&T.add(x.r.COLORFEATUREATTRIBUTE,"float"),O.add("vColor","vec4"),O.add("vpos","vec3"),O.add("vuv","vec2"),i&&O.add("depth","float"),E.uniforms.add(new m.E("uColor",(e=>e.color)));const P=e.style===S.O.ForwardDiagonal||e.style===S.O.BackwardDiagonal||e.style===S.O.DiagonalCross;P&&E.code.add(y.H`
      const mat2 rotate45 = mat2(${y.H.float(w)}, ${y.H.float(-C)},
                                 ${y.H.float(C)}, ${y.H.float(w)});
    `),e.draped||((0,g.yu)(E,e),E.uniforms.add(new _.m("worldToScreenPerDistanceRatio",((e,t)=>1/t.camera.perScreenPixelRatio))),E.code.add(y.H`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),E.code.add(y.H`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),E.code.add(y.H`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${y.H.float(R)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - cameraPosition);
      }
    `)),E.code.add(y.H`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${P?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${P?" * rotate45":""};

      ${e.draped?"":y.H`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${y.H.float(e.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `);const M=e.output===s.V.LinearDepth;return M&&(t.include(c.L,e),(0,r.xJ)(t),(0,r.Mu)(t)),E.code.add(y.H`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${i?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();
      ${e.hasVertexColors?"vColor *= uColor;":e.vvColor?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;"}
      gl_Position = ${M?y.H`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:y.H`transformPosition(proj, view, vpos);`}
    }
  `),t.include(n.HQ,e),A.include(f.a),e.draped&&A.uniforms.add(new _.m("texelSize",((e,t)=>1/t.camera.pixelRatio))),e.output===s.V.Highlight&&t.include(h.Qh,e),i&&t.include(d.Q,e),e.output!==s.V.Highlight&&(A.code.add(y.H`
      const float lineWidth = ${y.H.float(e.lineWidth)};
      const float spacing = ${y.H.float(e.patternSpacing)};
      const float spacingINV = ${y.H.float(1/e.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),e.draped||A.code.add(y.H`const int maxSamples = 5;
float sampleAA(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),A.code.add(y.H`
    void main() {
      discardBySlice(vpos);
      ${i?"terrainDepthTest(depth);":""}
      vec4 color = vColor;
      color = highlightSlice(color, vpos);

      ${e.output!==s.V.Highlight?y.H`color.a *= ${function(e){function t(t){return e.draped?y.H`coverage(vuv.${t}, texelSize)`:y.H`sampleAA(vuv.${t})`}switch(e.style){case S.O.ForwardDiagonal:case S.O.Horizontal:return t("y");case S.O.BackwardDiagonal:case S.O.Vertical:return t("x");case S.O.DiagonalCross:case S.O.Cross:return y.H`
        1.0 - (1.0 - ${t("x")}) * (1.0 - ${t("y")})
      `;default:return"0.0"}}(e)};`:""}

      ${e.output===s.V.ObjectAndLayerIdColor?y.H`color.a = 1.0;`:""}

      if (color.a < ${y.H.float(p.y)}) {
        discard;
      }

      ${e.output===s.V.Alpha?y.H`fragColor = vec4(color.a);`:""}

      ${e.output===s.V.Color?y.H`fragColor = color; ${e.transparencyPassType===b.y.Color?"fragColor = premultiplyAlpha(fragColor);":""}`:""}
      ${e.output===s.V.Highlight?y.H`outputHighlight();`:""}
      ${e.output===s.V.LinearDepth?y.H`outputDepth(linearDepth);`:""};
      ${e.output===s.V.ObjectAndLayerIdColor?y.H`outputObjectAndLayerIdColor();`:""}
    }
  `),t}const A=Object.freeze(Object.defineProperty({__proto__:null,build:E},Symbol.toStringTag,{value:"Module"}))},46348:(e,t,i)=>{i.d(t,{R:()=>T,b:()=>A,r:()=>E});var r=i(47635),s=i(77788),n=i(29592),a=i(38587),o=i(37303),l=i(23932),c=i(77802),h=i(47913),d=i(65630),u=i(48425),p=i(78546),f=i(83660),g=i(69952),m=i(66579),_=i(92121),y=i(19635),v=i(41014),b=i(99040),x=i(92624),S=i(7782),w=i(33763),C=i(18994),R=i(47268);const E=1;function A(e){const t=new x.N5,{attributes:i,varyings:A,constants:T,vertex:O,fragment:P}=t;t.include(u.p),t.include(o.s,e),t.include(c.q,e);const M=e.applyMarkerOffset&&!e.draped;M&&(O.uniforms.add(new y.m("markerScale",(e=>e.markerScale))),t.include(h.r,{space:C.lM.World,draped:!1})),e.output===s.V.LinearDepth&&t.include(l.L,e),t.include(a.g,e),(0,g.NB)(O,e),O.uniforms.add(new b.X("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new m.G("nearFar",((e,t)=>t.camera.nearFar)),new y.m("miterLimit",(e=>"miter"!==e.join?0:e.miterLimit)),new _.E("viewport",((e,t)=>t.camera.fullViewport))),O.constants.add("LARGE_HALF_FLOAT","float",65500),i.add(w.r.POSITION,"vec3"),i.add(w.r.PREVPOSITION,"vec3"),i.add(w.r.NEXTPOSITION,"vec3"),i.add(w.r.SUBDIVISIONFACTOR,"float"),i.add(w.r.UV0,"vec2"),A.add("vColor","vec4"),A.add("vpos","vec3"),A.add("vLineDistance","float"),A.add("vLineWidth","float"),(0,r.Mu)(t);const I=e.multipassEnabled&&(e.output===s.V.Color||e.output===s.V.Alpha);I&&A.add("depth","float");const D=e.stippleEnabled;D&&A.add("vLineSizeInv","float"),T.add("aaWidth","float",e.stippleEnabled?0:1);const F=e.capType===R.x.ROUND,L=e.stippleEnabled&&F,N=e.falloffEnabled||L;N&&A.add("vLineDistanceNorm","float"),F&&(A.add("vSegmentSDF","float"),A.add("vReverseSegmentSDF","float")),O.code.add(v.H`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),O.code.add(v.H`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),(0,r.i$)(t),O.code.add(v.H`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${I?"depth = pos.z;":""}
      linearDepth = calculateLinearDepth(nearFar,pos.z);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),(0,g.Nz)(O),O.code.add(v.H`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;
      float lineSize = getSize();

      if (lineSize < 1.0) {
        coverage = lineSize; // convert sub-pixel coverage to alpha
        lineSize = 1.0;
      }
      lineSize += aaWidth;

      float lineWidth = lineSize * pixelRatio;
      vLineWidth = lineWidth;
      ${D?v.H`vLineSizeInv = 1.0 / lineSize;`:""}

      vec4 pos  = view * vec4(position, 1.0);
      vec4 prev = view * vec4(prevPosition, 1.0);
      vec4 next = view * vec4(nextPosition, 1.0);
  `),M&&O.code.add(v.H`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos, other);
if(!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;
}`),O.code.add(v.H`clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),(e.stippleEnabled||F)&&O.code.add(v.H`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${F?v.H`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),O.code.add(v.H`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),e.roundJoins?O.code.add(v.H`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${e.stippleEnabled?v.H`min(1.0, subdivisionFactor * ${v.H.float((E+2)/(E+1))})`:v.H`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):O.code.add(v.H`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`);const V=e.capType!==R.x.BUTT;return O.code.add(v.H`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${V?v.H`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),O.code.add(v.H`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;
    float lineDistNorm = sign(uv0.y) * pos.w;

    vLineDistance =  lineWidth * lineDistNorm;
    ${N?v.H`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),F&&O.code.add(v.H`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),e.stippleEnabled&&(e.draped?O.uniforms.add(new y.m("worldToScreenRatio",((e,t)=>1/t.screenToPCSRatio))):O.code.add(v.H`vec3 segmentCenter = mix((nextPosition + position) * 0.5, (position + prevPosition) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),O.code.add(v.H`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(nextPosition - position, position - prevPosition, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),e.draped?O.code.add(v.H`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):O.code.add(v.H`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),O.uniforms.add(new y.m("stipplePatternPixelSize",(e=>(0,c.h)(e)))),O.code.add(v.H`float patternLength = lineSize * stipplePatternPixelSize;
vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);
vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);
if (segmentLengthScreenDouble >= 0.001) {
vec2 stippleDisplacement = pos.xy - segmentOrigin;
float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);
vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
}
vStippleDistanceLimits *= pos.w;
vStippleDistance *= pos.w;
vStippleDistanceLimits = isJoin ?
vStippleDistanceLimits :
isStartVertex ?
vec2(-1e34, vStippleDistanceLimits.y) :
vec2(vStippleDistanceLimits.x, 1e34);`)),O.code.add(v.H`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${e.wireframe&&!e.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }
  }
  `),I&&t.include(d.Q,e),t.include(n.HQ,e),P.include(f.a),P.code.add(v.H`
  void main() {
    discardBySlice(vpos);
    ${I?"terrainDepthTest(depth);":""}
  `),e.wireframe?P.code.add(v.H`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(F&&P.code.add(v.H`
        float sdf = min(vSegmentSDF, vReverseSegmentSDF);
        vec2 fragmentPosition = vec2(
          min(sdf, 0.0),
          vLineDistance
        ) * gl_FragCoord.w;

        float fragmentRadius = length(fragmentPosition);
        float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
        float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

        if (capCoverage < ${v.H.float(p.y)}) {
          discard;
        }
      `),L?P.code.add(v.H`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${v.H.float(p.y)}, stippleCoverage);
      `):P.code.add(v.H`float stippleAlpha = getStippleAlpha();`),e.output!==s.V.ObjectAndLayerIdColor&&P.code.add(v.H`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);`),P.uniforms.add(new _.E("intrinsicColor",(e=>e.color))),P.code.add(v.H`vec4 color = intrinsicColor * vColor;`),e.innerColorEnabled&&(P.uniforms.add(new _.E("innerColor",(e=>e.innerColor??e.color)),new y.m("innerWidth",((e,t)=>e.innerWidth*t.camera.pixelRatio))),P.code.add(v.H`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),P.code.add(v.H`vec4 finalColor = blendStipple(color, stippleAlpha);`),e.falloffEnabled&&(P.uniforms.add(new y.m("falloff",(e=>e.falloff))),P.code.add(v.H`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`)),e.stippleEnabled||P.code.add(v.H`float featherStartDistance = max(vLineWidth - 2.0, 0.0);
float value = abs(vLineDistance) * gl_FragCoord.w;
float feather = (value - featherStartDistance) / (vLineWidth - featherStartDistance);
finalColor.a *= 1.0 - clamp(feather, 0.0, 1.0);`)),P.code.add(v.H`
    ${e.output===s.V.ObjectAndLayerIdColor?v.H`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${v.H.float(p.y)}) {
      discard;
    }

    ${e.output===s.V.Alpha?v.H`fragColor = vec4(finalColor.a);`:""}
    ${e.output===s.V.Color?v.H`fragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===s.V.Color&&e.transparencyPassType===S.y.Color?"fragColor = premultiplyAlpha(fragColor);":""}
    ${e.output===s.V.Highlight?v.H`fragColor = vec4(1.0);`:""}
    ${e.output===s.V.LinearDepth?v.H`outputDepth(linearDepth);`:""}
    ${e.output===s.V.ObjectAndLayerIdColor?v.H`outputObjectAndLayerIdColor();`:""}
  }
  `),t}const T=Object.freeze(Object.defineProperty({__proto__:null,build:A,ribbonlineNumRoundJoinSubdivisions:E},Symbol.toStringTag,{value:"Module"}))},30607:(e,t,i)=>{i.d(t,{T:()=>c,a:()=>d,b:()=>h});var r=i(19913),s=i(28019),n=i(64802),a=i(41014),o=i(92624),l=i(19778);class c extends a.Y{constructor(){super(...arguments),this.color=(0,r.fA)(1,1,1)}}function h(){const e=new o.N5;return e.include(s.c),e.fragment.uniforms.add(new l.N("tex",(e=>e.texture)),new n.t("uColor",(e=>e.color))),e.fragment.code.add(a.H`void main() {
vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);
}`),e}const d=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:c,build:h},Symbol.toStringTag,{value:"Module"}))},9684:(e,t,i)=>{i.d(t,{W:()=>A,b:()=>E});var r=i(47635),s=i(77788),n=i(29592),a=i(31790),o=i(38587),l=i(15479),c=i(44118),h=i(40574),d=i(65630),u=i(60769),p=i(35212),f=i(88251),g=i(25853),m=i(63149),_=i(78546),y=i(83660),v=i(69952),b=i(92121),x=i(19635),S=i(41014),w=i(92624),C=i(7782),R=i(33763);function E(e){const t=new w.N5,{vertex:i,fragment:E}=t;(0,v.NB)(i,e),t.include(a.d,e),t.attributes.add(R.r.POSITION,"vec3"),t.attributes.add(R.r.UV0,"vec2");const A=new b.E("waterColor",(e=>e.color));if(e.output===s.V.Color&&e.draped)return t.varyings.add("vpos","vec3"),i.uniforms.add(A),i.code.add(S.H`
        void main(void) {
          if (waterColor.a < ${S.H.float(_.y)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),E.uniforms.add(A),E.code.add(S.H`void main() {
fragColor = waterColor;
}`),t;switch(e.output!==s.V.Color&&e.output!==s.V.Alpha||(t.include(u.n,e),t.include(r.oD,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),e.multipassEnabled&&t.varyings.add("depth","float"),i.uniforms.add(A),i.code.add(S.H`
      void main(void) {
        if (waterColor.a < ${S.H.float(_.y)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${e.multipassEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${e.output===s.V.Color?"forwardLinearDepth();":""}
      }
    `)),t.include(d.Q,e),e.output){case s.V.Alpha:t.include(n.HQ,e),E.uniforms.add(A),E.code.add(S.H`
        void main() {
          discardBySlice(vpos);
          ${e.multipassEnabled?"terrainDepthTest(depth);":""}

          fragColor = vec4(waterColor.a);
        }
      `);break;case s.V.Color:t.include(h.qU),t.include(c.W,{pbrMode:p.A9.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(m.V),t.include(n.HQ,e),t.include(f.Bz,e),t.include(g.E,e),E.uniforms.add(A,new x.m("timeElapsed",(e=>e.timeElapsed)),i.uniforms.get("view"),i.uniforms.get("localOrigin")),(0,v.yu)(E,e),E.include(y.a),(0,h.Gc)(E),(0,h.O4)(E),E.code.add(S.H`
      void main() {
        discardBySlice(vpos);
        ${e.multipassEnabled?"terrainDepthTest(depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - cameraPosition);
        float shadow = ${e.receiveShadows?S.H`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view * vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, mainLightDirection, waterColor.rgb, mainLightIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);

        // gamma correction
        fragColor = delinearizeGamma(final);
        fragColor = highlightSlice(fragColor, vpos);
        ${e.transparencyPassType===C.y.Color?"fragColor = premultiplyAlpha(fragColor);":""}
      }
    `);break;case s.V.Normal:t.include(u.n,e),t.include(m.V,e),t.include(n.HQ,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),i.uniforms.add(A),i.code.add(S.H`
        void main(void) {
          if (waterColor.a < ${S.H.float(_.y)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),E.uniforms.add(new x.m("timeElapsed",(e=>e.timeElapsed))),E.code.add(S.H`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
fragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`);break;case s.V.Highlight:t.include(l.Qh,e),t.varyings.add("vpos","vec3"),i.uniforms.add(A),i.code.add(S.H`
      void main(void) {
        if (waterColor.a < ${S.H.float(_.y)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),t.include(n.HQ,e),E.code.add(S.H`void main() {
discardBySlice(vpos);
outputHighlight();
}`);break;case s.V.ObjectAndLayerIdColor:t.include(o.g,e),t.varyings.add("vpos","vec3"),i.uniforms.add(A),i.code.add(S.H`
      void main(void) {
        if (waterColor.a < ${S.H.float(_.y)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
        forwardObjectAndLayerIdColor();
      }
    `),t.include(n.HQ,e),E.code.add(S.H`void main() {
discardBySlice(vpos);
outputObjectAndLayerIdColor();
}`)}return t}const A=Object.freeze(Object.defineProperty({__proto__:null,build:E},Symbol.toStringTag,{value:"Module"}))},20700:(e,t,i)=>{var r;i.d(t,{u:()=>r}),function(e){e[e.KILOBYTES=1024]="KILOBYTES",e[e.MEGABYTES=1048576]="MEGABYTES",e[e.GIGABYTES=1073741824]="GIGABYTES"}(r||(r={}))},12056:(e,t,i)=>{i.d(t,{A:()=>n});var r=i(99595),s=i(29745);class n{constructor(e){this._observable=new s.I,this._set=new Set(e)}get size(){return(0,r.gc)(this._observable),this._set.size}add(e){const t=this._set.size;return this._set.add(e),this._set.size!==t&&this._observable.notify(),this}clear(){this._set.size>0&&(this._set.clear(),this._observable.notify())}delete(e){const t=this._set.delete(e);return t&&this._observable.notify(),t}entries(){return(0,r.gc)(this._observable),this._set.entries()}forEach(e,t){(0,r.gc)(this._observable),this._set.forEach(((i,r)=>e.call(t,i,r,this)),t)}has(e){return(0,r.gc)(this._observable),this._set.has(e)}keys(){return(0,r.gc)(this._observable),this._set.keys()}values(){return(0,r.gc)(this._observable),this._set.values()}[Symbol.iterator](){return(0,r.gc)(this._observable),this._set[Symbol.iterator]()}get[Symbol.toStringTag](){return this._set[Symbol.toStringTag]}}},18031:(e,t,i)=>{i.d(t,{P:()=>p});var r=i(62991),s=i(89809),n=i(47980),a=i(19759),o=i(1874),l=i(88135),c=i(91101),h=i(81482),d=i(80925),u=i(55714);function p(e){const t=e?.origins??[void 0];return(i,r)=>{const s=function(e,t,i){if("resource"===e?.type)return function(e,t,i){const r=(0,l.z4)(t,i);return{type:String,read:(e,t,i)=>{const s=(0,u.r)(e,t,i);return r.type===String?s:"function"==typeof r.type?new r.type({url:s}):void 0},write:{writer(t,s,o,l){if(!l?.resources)return"string"==typeof t?void(s[o]=(0,u.t)(t,l)):void(s[o]=t.write({},l));const h=function(e){return null==e?null:"string"==typeof e?e:e.url}(t),p=(0,u.t)(h,{...l,verifyItemRelativeUrls:l?.verifyItemRelativeUrls?{writtenUrls:l.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},u.M.NO),_=r.type!==String&&(!(0,n.H)(this)||l?.origin&&this.originIdOf(i)>(0,c.aB)(l.origin)),y={object:this,propertyName:i,value:t,targetUrl:p,dest:s,targetPropertyName:o,context:l,params:e};l?.portalItem&&p&&!(0,a.oP)(p)?_&&e?.contentAddressed?f(y):_?function(e){const{context:t,targetUrl:i,params:r,value:s,dest:n,targetPropertyName:o}=e;if(!t.portalItem)return;const l=t.portalItem.resourceFromPath(i),c=m(s,i,t),h=(0,d.n)(c),u=(0,a.Zo)(l.path),p=r?.compress??!1;h===u?(t.resources&&g({...e,resource:l,content:c,compress:p,updates:t.resources.toUpdate}),n[o]=i):f(e)}(y):function({context:e,targetUrl:t,dest:i,targetPropertyName:r}){e.portalItem&&e.resources&&(e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(t),compress:!1}),i[r]=t)}(y):l?.portalItem&&(null==p||null!=(0,u.i)(p)||(0,a.w8)(p)||_)?f(y):s[o]=p}}}}(e,t,i);switch(e?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:e,write:t}=u.b;return{read:e,write:t}}}}(e,i,r);for(const e of t){const t=(0,h.rM)(i,e,r);for(const e in s)t[e]=s[e]}}}function f(e){const{targetUrl:t,params:i,value:n,context:l,dest:c,targetPropertyName:h}=e;if(!l.portalItem)return;const p=(0,u.p)(t),f=m(n,t,l);if(i?.contentAddressed&&"json"!==f.type)return void l.messages?.push(new r.A("persistable:contentAddressingUnsupported",`Property "${h}" is trying to serializing a resource with content of type ${f.type} with content addressing. Content addressing is only supported for json resources.`,{content:f}));const _=i?.contentAddressed&&"json"===f.type?(0,s.d)(f.jsonString):p?.filename??(0,o.lk)(),y=(0,a.fj)(i?.prefix??p?.prefix,_),v=`${y}.${(0,d.n)(f)}`;if(i?.contentAddressed&&l.resources&&"json"===f.type){const e=l.resources.toKeep.find((({resource:e})=>e.path===v))??l.resources.toAdd.find((({resource:e})=>e.path===v));if(e)return void(c[h]=e.resource.itemRelativeUrl)}const b=l.portalItem.resourceFromPath(v);(0,a.w8)(t)&&l.resources&&l.resources.pendingOperations.push((0,a.tk)(t).then((e=>{b.path=`${y}.${(0,d.n)({type:"blob",blob:e})}`,c[h]=b.itemRelativeUrl})).catch((()=>{})));const x=i?.compress??!1;l.resources&&g({...e,resource:b,content:f,compress:x,updates:l.resources.toAdd}),c[h]=b.itemRelativeUrl}function g({object:e,propertyName:t,updates:i,resource:r,content:s,compress:n}){i.push({resource:r,content:s,compress:n,finish:i=>{!function(e,t,i){"string"==typeof e[t]?e[t]=i.url:e[t].url=i.url}(e,t,i)}})}function m(e,t,i){return"string"==typeof e?{type:"url",url:t}:{type:"json",jsonString:JSON.stringify(e.toJSON(i))}}},39637:(e,t,i)=>{i.d(t,{T:()=>n,U:()=>s});var r=i(4506);function s(e,t,i=0){const s=(0,r.qE)(e,0,l);for(let e=0;e<4;e++)t[i+e]=Math.floor(256*c(s*a[e]))}function n(e,t=0){let i=0;for(let r=0;r<4;r++)i+=e[t+r]*o[r];return i}const a=[1,256,65536,16777216],o=[1/256,1/65536,1/16777216,1/4294967296],l=n(new Uint8ClampedArray([255,255,255,255]));function c(e){return e-Math.floor(e)}},6590:(e,t,i)=>{function r(){return new Float32Array(3)}function s(e){const t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function n(e,t,i){const r=new Float32Array(3);return r[0]=e,r[1]=t,r[2]=i,r}function a(){return r()}function o(){return n(1,1,1)}function l(){return n(1,0,0)}function c(){return n(0,1,0)}function h(){return n(0,0,1)}i.d(t,{fA:()=>n,o8:()=>s,vt:()=>r});const d=a(),u=o(),p=l(),f=c(),g=h();Object.freeze(Object.defineProperty({__proto__:null,ONES:u,UNIT_X:p,UNIT_Y:f,UNIT_Z:g,ZEROS:d,clone:s,create:r,createView:function(e,t){return new Float32Array(e,t,3)},fromValues:n,ones:o,unitX:l,unitY:c,unitZ:h,zeros:a},Symbol.toStringTag,{value:"Module"}))},47980:(e,t,i)=>{function r(e){return e&&"getAtOrigin"in e&&"originOf"in e}i.d(t,{H:()=>r})},8189:(e,t,i)=>{i.d(t,{B:()=>l});var r=i(3223),s=i(70214),n=i(80861),a=i(37623),o=i(73462);class l{constructor(e,t,i,r,s={}){this._mainMethod=t,this._transferLists=i,this._listeners=[],this._promise=(0,o.ho)(e,{...s,schedule:r}).then((e=>{if(void 0===this._thread){this._thread=e,this._promise=null,s.hasInitialize&&this.broadcast({},"initialize");for(const e of this._listeners)this._connectListener(e)}else e.close()})),this._promise.catch((t=>n.A.getLogger("esri.core.workers.WorkerHandle").error(`Failed to initialize ${e} worker: ${t}`)))}on(e,t){const i={removed:!1,eventName:e,callback:t,threadHandle:null};return this._listeners.push(i),this._connectListener(i),(0,s.hA)((()=>{i.removed=!0,(0,r.TF)(this._listeners,i),this._thread&&null!=i.threadHandle&&i.threadHandle.remove()}))}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null,this._listeners.length=0,this._transferLists={}}invoke(e,t){return this.invokeMethod(this._mainMethod,e,t)}invokeMethod(e,t,i){if(this._thread){const r=this._transferLists[e],s=r?r(t):[];return this._thread.invoke(e,t,{transferList:s,signal:i})}return this._promise?this._promise.then((()=>((0,a.Te)(i),this.invokeMethod(e,t,i)))):Promise.reject(null)}broadcast(e,t){return this._thread?Promise.all(this._thread.broadcast(t,e)).then((()=>{})):this._promise?this._promise.then((()=>this.broadcast(e,t))):Promise.reject()}get promise(){return this._promise}_connectListener(e){this._thread&&this._thread.on(e.eventName,e.callback).then((t=>{e.removed||(e.threadHandle=t)}))}}},74860:(e,t,i)=>{i.d(t,{FB:()=>d,C:()=>y,vt:()=>m,Qy:()=>_,ui:()=>v,m7:()=>b});var r=i(82444),s=i(25336),n=i(80347),a=i(19913),o=i(74772),l=i(76982),c=i(63918);function h(e){return e?{ray:(0,c.vt)(e.ray),c0:e.c0,c1:e.c1}:{ray:(0,c.vt)(),c0:0,c1:Number.MAX_VALUE}}new r.I((()=>h()));var d,u,p,f=i(87368),g=i(11631);function m(e){return e?[(0,f.vt)(e[0]),(0,f.vt)(e[1]),(0,f.vt)(e[2]),(0,f.vt)(e[3]),(0,f.vt)(e[4]),(0,f.vt)(e[5])]:[(0,f.vt)(),(0,f.vt)(),(0,f.vt)(),(0,f.vt)(),(0,f.vt)(),(0,f.vt)()]}function _(){return[(0,a.vt)(),(0,a.vt)(),(0,a.vt)(),(0,a.vt)(),(0,a.vt)(),(0,a.vt)(),(0,a.vt)(),(0,a.vt)()]}function y(e,t){for(let i=0;i<x;i++)(0,f.C)(e[i],t[i]);return e}function v(e,t,i,r=C){const a=(0,s.lw)(g.Rc.get(),t,e);(0,s.B8)(a,a);for(let e=0;e<S;++e){const t=(0,o.t)(g.Km.get(),w[e],a);(0,n.s)(r[e],t[0]/t[3],t[1]/t[3],t[2]/t[3])}!function(e,t){(0,f.Cr)(t[u.FAR_BOTTOM_LEFT],t[u.NEAR_BOTTOM_LEFT],t[u.NEAR_TOP_LEFT],e[d.LEFT]),(0,f.Cr)(t[u.NEAR_BOTTOM_RIGHT],t[u.FAR_BOTTOM_RIGHT],t[u.FAR_TOP_RIGHT],e[d.RIGHT]),(0,f.Cr)(t[u.FAR_BOTTOM_LEFT],t[u.FAR_BOTTOM_RIGHT],t[u.NEAR_BOTTOM_RIGHT],e[d.BOTTOM]),(0,f.Cr)(t[u.NEAR_TOP_LEFT],t[u.NEAR_TOP_RIGHT],t[u.FAR_TOP_RIGHT],e[d.TOP]),(0,f.Cr)(t[u.NEAR_BOTTOM_LEFT],t[u.NEAR_BOTTOM_RIGHT],t[u.NEAR_TOP_RIGHT],e[d.NEAR]),(0,f.Cr)(t[u.FAR_BOTTOM_RIGHT],t[u.FAR_BOTTOM_LEFT],t[u.FAR_TOP_LEFT],e[d.FAR])}(i,r)}function b(e,t){for(let i=0;i<x;i++){const r=e[i];if(r[0]*t[0]+r[1]*t[1]+r[2]*t[2]+r[3]>=t[3])return!1}return!0}(p=d||(d={}))[p.LEFT=0]="LEFT",p[p.RIGHT=1]="RIGHT",p[p.BOTTOM=2]="BOTTOM",p[p.TOP=3]="TOP",p[p.NEAR=4]="NEAR",p[p.FAR=5]="FAR",function(e){e[e.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",e[e.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",e[e.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",e[e.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",e[e.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",e[e.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",e[e.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",e[e.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(u||(u={})),u.FAR_BOTTOM_RIGHT,u.NEAR_BOTTOM_RIGHT,u.NEAR_BOTTOM_LEFT,u.FAR_BOTTOM_LEFT,u.NEAR_BOTTOM_LEFT,u.NEAR_BOTTOM_RIGHT,u.NEAR_TOP_RIGHT,u.NEAR_TOP_LEFT,u.FAR_BOTTOM_RIGHT,u.FAR_BOTTOM_LEFT,u.FAR_TOP_LEFT,u.FAR_TOP_RIGHT,u.NEAR_BOTTOM_RIGHT,u.FAR_BOTTOM_RIGHT,u.FAR_TOP_RIGHT,u.NEAR_TOP_RIGHT,u.FAR_BOTTOM_LEFT,u.NEAR_BOTTOM_LEFT,u.NEAR_TOP_LEFT,u.FAR_TOP_LEFT,u.FAR_TOP_LEFT,u.NEAR_TOP_LEFT,u.NEAR_TOP_RIGHT,u.FAR_TOP_RIGHT;const x=6,S=8,w=[(0,l.fA)(-1,-1,-1,1),(0,l.fA)(1,-1,-1,1),(0,l.fA)(1,1,-1,1),(0,l.fA)(-1,1,-1,1),(0,l.fA)(-1,-1,1,1),(0,l.fA)(1,-1,1,1),(0,l.fA)(1,1,1,1),(0,l.fA)(-1,1,1,1)],C=(new r.I(h),_())},11703:(e,t,i)=>{var r,s,n,a,o,l,c,h,d,u,p,f,g,m,_;i.d(t,{Pl:()=>y,Qg:()=>_,vE:()=>v}),function(e){e.U8="U8",e.I8="I8",e.U16="U16",e.I16="I16",e.U32="U32",e.I32="I32",e.F32="F32",e.F64="F64",e.Utf8String="Utf8String",e.NotSet="NotSet"}(r||(r={})),function(e){e.Png="Png",e.Jpeg="Jpeg",e.Dds="Dds",e.Raw="Raw",e.Dxt1="Dxt1",e.Dxt5="Dxt5",e.Etc2="Etc2",e.Astc="Astc",e.Pvrtc="Pvrtc",e.NotSet="NotSet"}(s||(s={})),function(e){e.Rgb8="Rgb8",e.Rgba8="Rgba8",e.R8="R8",e.Bgr8="Bgr8",e.Bgra8="Bgra8",e.Rg8="Rg8",e.NotSet="NotSet"}(n||(n={})),function(e){e.Position="Position",e.Normal="Normal",e.TexCoord="TexCoord",e.Color="Color",e.Tangent="Tangent",e.FeatureIndex="FeatureIndex",e.UvRegion="UvRegion",e.NotSet="NotSet"}(a||(a={})),function(e){e.Opaque="Opaque",e.Mask="Mask",e.Blend="Blend"}(o||(o={})),function(e){e.None="None",e.Mask="Mask",e.Alpha="Alpha",e.PreMultAlpha="PreMultAlpha",e.NotSet="NotSet"}(l||(l={})),function(e){e.Points="Points",e.Lines="Lines",e.LineStrip="LineStrip",e.Triangles="Triangles",e.TriangleStrip="TriangleStrip",e.NotSet="NotSet"}(c||(c={})),function(e){e.None="None",e.WrapXBit="WrapXBit",e.WrapYBit="WrapYBit",e.WrapXy="WrapXy",e.NotSet="NotSet"}(h||(h={})),function(e){e.Linear="Linear",e.Nearest="Nearest",e.NotSet="NotSet"}(d||(d={})),function(e){e.Linear="Linear",e.Nearest="Nearest",e.NearestMipmapNearest="NearestMipmapNearest",e.LinearMipmapNearest="LinearMipmapNearest",e.NearestMipmapLinear="NearestMipmapLinear",e.LinearMipmapLinear="LinearMipmapLinear",e.NotSet="NotSet"}(u||(u={})),function(e){e.FeatureId="FeatureId",e.GlobalUid="GlobalUid",e.UnspecifiedDateTime="UnspecifiedDateTime",e.EcmaIso8601DateTime="EcmaIso8601DateTime",e.EcmaIso8601DateOnly="EcmaIso8601DateOnly",e.TimeOnly="TimeOnly",e.TimeStamp="TimeStamp",e.ColorRgb="ColorRgb",e.ColorRgba="ColorRgba",e.Unrecognized="Unrecognized",e.NotSet="NotSet"}(p||(p={})),function(e){e.Texture="Texture",e.VertexAtrb="VertexAtrb",e.Implicit="Implicit",e.NotSet="NotSet"}(f||(f={})),function(e){e.Front="Front",e.Back="Back",e.None="None",e.NotSet="NotSet"}(g||(g={})),function(e){e.Pbr="Pbr",e.Unlit="Unlit"}(m||(m={})),function(e){e[e.Succeeded=0]="Succeeded",e[e.Failed=1]="Failed",e[e.MissingInputs=2]="MissingInputs"}(_||(_={}));const y=-1,v=-2},98562:(e,t,i)=>{i.r(t),i.d(t,{default:()=>PS});var r=i(82392),s=i(38116),n=i(73783),a=i(80861),o=i(37623),l=i(61985),c=i(9987),h=i(81482),d=i(6273),u=(i(67498),i(26325)),p=i(11703),f=i(8189);class g extends f.B{constructor(e){super("Lyr3DWorker","process",{process:e=>e.inputs},e,{hasInitialize:!0})}destroyWasm(){return this.broadcast({},"destroyWasm")}}var m=i(38425),_=i(69172),y=i(93814),v=i(20857),b=i(3223),x=i(20700),S=i(40377),w=i(70214),C=i(41785),R=i(62088),E=i(5262),A=i(82541),T=i(79441),O=i(25336),P=i(26110),M=(i(19165),i(80347)),I=i(19913),D=i(74772),F=i(76982),L=i(68660),N=i(91240),V=i(99263),G=i(67488),U=i(4506);function z(e,t,i,r){if(null==t||null==r)return!1;const s=(0,N.t_)(t,r,j);if(s.projector===N.pO)return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],!0;if(null==s.projector)return!1;const{source:n,dest:a}=s;if(a.spatialReferenceId===N.rz.WEB_MERCATOR){const t=N.w5[n.spatialReferenceId][N.rz.WGS84];return null!=t&&(t(e,0,H,0),(0,N.s7)(H,0,i,0),i[3]=B(H[1],e[2],e[3],V.$O.radius),!0)}if(n.spatialReferenceId!==N.rz.WGS84&&n.spatialReferenceId!==N.rz.CGCS2000||a.spatialReferenceId!==N.rz.PLATE_CARREE){s.projector(e,0,i,0);const t=n.metersPerUnit??1,r=a.metersPerUnit??1;i[3]=e[3]*t/r}else{const t=N.w5[n.spatialReferenceId][N.rz.SPHERICAL_ECEF],r=N.w5[N.rz.SPHERICAL_ECEF][N.rz.PLATE_CARREE];let a=e[3];null!=t&&null!=r&&(a=B(e[1],e[2],e[3],V.$O.radius)),s.projector(e,0,i,0),i[3]=a}return!0}function B(e,t,i,r){const s=r+t;if(s<r/2||i>s)return Number.MAX_VALUE;const n=Math.abs(W*e)+Math.asin(i/s);return n>=Math.PI/2?Number.MAX_VALUE:i/Math.cos(n)}const H=(0,I.vt)(),j=(0,N.Ur)(),W=(0,U.kU)(1);var k=i(88133),Z=i(42722),q=i(46373),$=i(2532),Q=i(75644),J=i(68435),Y=i(51831),X=i(69891),K=i(71004);function ee(e,t,i,r){return!(null==e||((0,G.aI)(t,r)?((0,$.C)(i,e),0):(te[0]=e[0],te[1]=e[1],te[2]=0,!(0,k.projectBuffer)(te,t,0,te,r,0,1)||(i[0]=te[0],i[1]=te[1],te[0]=e[2],te[1]=e[3],te[2]=0,!(0,k.projectBuffer)(te,t,0,te,r,0,1)||(i[2]=te[0],i[3]=te[1],0)))))}const te=(0,I.vt)();var ie,re,se,ne=i(82320),ae=i(63466),oe=i(84456),le=i(62991),ce=i(57725),he=i(48156),de=i(1874),ue=i(28364),pe=i(25207),fe=i(17079);(se=ie||(ie={}))[se.KTX2=1]="KTX2",se[se.Basis=2]="Basis",se[se.DDS_S3TC=4]="DDS_S3TC",se[se.PNG=8]="PNG",se[se.JPG=16]="JPG",se[se.KTX_ETC2=32]="KTX_ETC2",function(e){e[e.None=0]="None",e[e.Color=1]="Color",e[e.MetallicRoughness=2]="MetallicRoughness",e[e.Normal=4]="Normal",e[e.Occlusion=8]="Occlusion",e[e.Emissive=16]="Emissive",e[e.AlphaMask=32]="AlphaMask",e[e.ColorTextures=19]="ColorTextures",e[e.GeometryTextures=36]="GeometryTextures",e[e.GeometryTexturesPBR=44]="GeometryTexturesPBR",e[e.AllTextures=37]="AllTextures",e[e.AllTexturesPBR=63]="AllTexturesPBR"}(re||(re={}));var ge=i(10875),me=i(80605),_e=i(40327);async function ye(e,t,i,r){if(null==e)return-1;const s=i.length,n=e.data,a=e.url;if(null!=n){if(n instanceof HTMLImageElement||n instanceof HTMLCanvasElement){const e=(0,me.IR)(n);return i.push({id:s,usage:r,data:e,encoding:ie.PNG,downsampled:!1}),t.push({id:s,usage:r,encodings:[{name:void 0,encoding:ie.PNG}]}),s}if(n instanceof HTMLVideoElement)return-1;if(n instanceof ImageData)throw new le.A("ImageData textures not supported yet for client side I3S nodes");if(n instanceof fe.Xi)throw new le.A("EncodedMeshTexture textures not supported yet for client side I3S nodes")}else if(null!=a){const e=new Image;e.src=a;const n=await(0,pe.Sx)(e,e.src,!1,void 0),o=(0,me.IR)(n);return i.push({id:s,usage:r,data:o,encoding:ie.PNG,downsampled:!1}),t.push({id:s,usage:r,encodings:[{name:void 0,encoding:ie.PNG}]}),s}return-1}class ve{constructor(e,t,i,r){this._uid=e,this._worker=r,this._id2Meta=new Map,this._oid2Meta=new Map,this._indexSR=t.indexSR,this._vertexSR=t.vertexSR,this._renderSR=t.renderSR,this._localMode=t.localMode,this._memCache=i.newCache(`sl-client-mesh-data-${this._uid}`)}get uid(){return this._uid}get worker(){return this._worker}get indexSR(){return this._indexSR}get renderSR(){return this._renderSR}createMeshNodeInfo(e,t){const i=`mesh${t}`,r=e.extent,s=r.spatialReference,n=this._indexSR,a=function(e,t){const{spatialReference:i}=e,r=[1,-1],s=[.5*e.width,.5*e.height,e.hasZ?.5*(e.zmax-e.zmin):0],n=i.isGeographic?i.metersPerUnit:1,a=e.center;let o=0;if(e.hasZ)for(let e=0;e<2;++e)for(let i=0;i<2;++i)for(let l=0;l<2;++l){const c=(a.x+r[e]*s[0]-t.x)*n,h=(a.y+r[i]*s[1]-t.y)*n,d=a.z+r[l]*s[2]-t.z;o=Math.max(c*c+h*h+d*d,o)}else for(let e=0;e<2;++e)for(let i=0;i<2;++i){const l=(a.x+r[e]*s[0]-t.x)*n,c=(a.y+r[i]*s[1]-t.y)*n;o=Math.max(l*l+c*c,o)}return(0,X.b)([t.x,t.y,t.z],Math.sqrt(o))}(r,e.origin);return z(a,s,a,n),{type:"mesh",id:i,version:xe(e),oid:t,mbs:a,componentNodeIds:[],unloadedMesh:e,nodeIndex:null,loadMeshPromise:null}}addMeshNode(e,t){if(null!=this.getMeshNodeIndex(t.oid))throw new le.A(`I3SClientNodeLoader: client side mesh for feature oid=${t.oid} already exists`);t.nodeIndex=e,this._id2Meta.set(t.id,t),this._oid2Meta.set(t.oid,t)}getMeshNodeIndex(e){const t=this._oid2Meta.get(e);return null==t||"mesh"!==t.type?null:t.nodeIndex}removeNode(e){const t=this._id2Meta.get(e);null!=t&&(this._id2Meta.delete(e),"mesh"===t.type&&this._oid2Meta.delete(t.oid))}async loadNodeJSON(e){const t=this._id2Meta.get(e);if(null==t)throw new le.A(`I3SClientNodeLoader::loadNodeJSON unable to find node ${e}`);switch(t.type){case"mesh":return this._loadMeshNodeJSON(t);case"mesh-component":return this._loadMeshComponentNodeJSON(t);default:throw new le.A(`I3SClientNodeLoader::loadNodeJSON unable to handle node ${e}`)}}async _loadMeshNodeJSON(e){const t=e.id,i=(await this._getMeshData(e)).loadedMesh;if(null==i.components||0===i.components.length)return{id:t,version:null,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null};const r=[],s=i.components;for(let i=0;i<s.length;++i){const s=`${t}-component${i}`,n={type:"mesh-component",id:s,mbs:e.mbs,componentIndex:i,meshNodeInfo:e,textureData:new Map};this._id2Meta.set(n.id,n),e.componentNodeIds.push(s),r.push({id:n.id,href:null,mbs:n.mbs,obb:null})}return{id:t,version:null,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:r}}updateNodeIndex(e,t,i){const r=this._id2Meta.get(e);r&&"mesh"===r.type&&(r.nodeIndex=i)}async _loadMeshComponentNodeJSON(e){return{id:e.id,version:e.meshNodeInfo.version,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null,isEmpty:!1}}async loadNodeData(e,t){const i=this._id2Meta.get(e);if(null==i||"mesh-component"!==i.type)throw new le.A(`Failed to load client node data for node ${e} (unexpected node info)`);const r=i.meshNodeInfo,s=await this._getMeshData(r),n=s.loadedMesh,a=r.oid;if(null==n.components)throw new le.A(`Failed to load client node data for node ${e} (unexpected null reference)`);const l=n.components[i.componentIndex],{material:c,requiredTextures:h,textureData:d}=await async function(e){const t=[],i=[];if(null==e)return{material:{alphaMode:"opaque",alphaCutoff:.1,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[1,1,1,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6000000238418579},wrapTextures:!1,hasParametersFromSource:!0},requiredTextures:t,textureData:i};const r=function(e){return e.hasOwnProperty("metallicRoughnessTexture")}(e);"auto"===e.alphaMode&&console.warn('alphaMode "auto" not supported by I3S PBRMaterial - defaulting to "blend".');const s=(0,_e.Jr)({normalTexture:e.normalTexture,emissiveTexture:r?e.emissiveTexture:null,emissiveFactor:r?y.A.toUnitRGB(e.emissiveColor):null,occlusionTexture:r?e.occlusionTexture:null,metallicRoughnessTexture:r?e.metallicRoughnessTexture:null,metallicFactor:r?e.metallic:null,roughnessFactor:r?e.roughness:null}),n=s?_e.mX[0]:r?e.metallic:0,a=s?_e.mX[1]:r?e.roughness:0;return{material:{alphaMode:"auto"===e.alphaMode?"blend":e.alphaMode,alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,cullFace:e.doubleSided?ge.s2.None:ge.s2.Back,normalTextureId:await ye(e.normalTexture,t,i,re.Normal),emissiveTextureId:r?await ye(e.emissiveTexture,t,i,re.Emissive):-1,occlusionTextureId:r?await ye(e.occlusionTexture,t,i,re.Occlusion):-1,emissiveFactor:r&&null!=e.emissiveColor?y.A.toUnitRGB(e.emissiveColor):[0,0,0],metallicRoughness:{baseColorFactor:null!=e.color?y.A.toUnitRGBA(e.color):[1,1,1,1],baseColorTextureId:await ye(e.colorTexture,t,i,re.Color),metallicRoughnessTextureId:r?await ye(e.metallicRoughnessTexture,t,i,re.MetallicRoughness):-1,metallicFactor:n,roughnessFactor:a},wrapTextures:!0,hasParametersFromSource:s},requiredTextures:t,textureData:i}}(l.material);if(null!=d)for(const e of d)null!=e&&i.textureData.set(e.id,e);const u={params:{material:c},type:"ArrayBufferView"},{vertexSpace:p,origin:f,transform:g}=n,m=[f.x,f.y,f.z??0],_={featureDataPosition:m,featureIds:[],geometries:[u]};s.projectionPromise||((0,ce.Lw)(this._worker,"SceneLayerWorker is needed to project mesh"),s.projectionPromise=this._worker.project({positions:n.vertexAttributes.position,localMatrix:g?.localMatrix,vertexSpace:p.toJSON(),origin:m,inSpatialReference:n.spatialReference.toJSON(),outSpatialReference:this._vertexSR.toJSON(),localMode:this._localMode},t));const{projected:v,original:b}=await s.projectionPromise;n.vertexAttributes.position=b;const{transformed:x,original:S}=await async function(e,t,i,r){const{transform:s,vertexAttributes:n}=t.loadedMesh,a="source"===e.shading?n.normal:null;if(null==a||null==s||0===s.rotationAngle&&(0,M.i)(s.scale,I.Un))return{transformed:a,original:n.normal};if(!t.normalsTransformPromise){(0,ce.Lw)(i,"SceneLayerWorker is needed to transform mesh normals");const e=(0,T.vt)();(0,A.Ge)(e,s.localMatrix),t.normalsTransformPromise=i.transformNormals({normalMatrix:e,normals:a},r)}return t.normalsTransformPromise}(l,s,this._worker,t);n.vertexAttributes.normal=S,(0,o.Te)(t);const{geometryBuffer:w,geometryDescriptor:C}=function(e,t,i,r,s,n){const a=t.length/3,o=3*a;let l=0,c=0,h=!1,d=0,u=!1,p=0,f=!1,g=0,m=0,_=0;l+=Se,l+=Se,c=l,l+=3*o*we,null!=i&&(h=!0,d=l,l+=3*o*we),null!=r&&(u=!0,p=l,l+=2*o*we),null!=s&&(f=!0,g=l,l+=4*o*Ce),m=l,l+=1*Re,_=l,l+=2*Se;const y=new ArrayBuffer(l),v=new Uint8Array(y);be(v,0,o),be(v,Se,1);const b=new Float32Array(y,c),x=null!=i?new Float32Array(y,d):null,S=null!=r?new Float32Array(y,p):null,w=null!=s?new Uint8Array(y,g):null;for(let n=0;n<a;++n){const a=3*n;for(let o=0;o<3;++o){const l=t[a+o],c=3*l,h=9*n+3*o;if(b[h]=e[c],b[h+1]=e[c+1],b[h+2]=e[c+2],null!=x&&(x[h]=i[c],x[h+1]=i[c+1],x[h+2]=i[c+2]),null!=S){const e=2*l,t=6*n+2*o;S[t]=r[e],S[t+1]=r[e+1]}if(null!=w){const e=4*l,t=12*n+4*o;w[t]=s[e],w[t+1]=s[e+1],w[t+2]=s[e+2],w[t+3]=s[e+3]}}}return be(v,m,n),be(v,m+Se,n/2**32),be(v,_,0),be(v,_+Se,a-1),{geometryBuffer:y,geometryDescriptor:{isDraco:!1,isLegacy:!0,color:f,normal:h,uv0:u,uvRegion:!1,featureIndex:!0}}}(v,l.faces,x,n.vertexAttributes.uv,n.vertexAttributes.color,a);return{geometryData:_,attributeDataInfo:{attributeData:{},loadedAttributes:[]},geometryBuffer:w,geometryDescriptor:C,requiredTextures:h,textureData:d,normalReferenceFrame:this._vertexSR.isGeographic?"east-north-up":"vertex-reference-frame"}}async loadAttributes(e,t,i){const r=e.numFeatures,s={};for(const{field:{name:e}}of t)s[e]=new Array(r);return s}async loadTextures(e,t,i){const r=e.id,s=this._id2Meta.get(r);if(null==s||"mesh-component"!==s.type)throw new Error(`Failed to load textures for node ${e.id} (unexpected node info)`);const n=[];for(const e of t)n.push(s.textureData.get(e.id)||null);return n}async _getMeshData(e){const t=e.version,i=this._memCache.get(t);if(null==i){if(null!=e.loadMeshPromise)return e.loadMeshPromise;const i=async(i,r)=>{const s=e.unloadedMesh.clone();try{await s.load()}catch(e){r(e)}const n=s.memoryUsage,a={loadedMesh:s,projectionPromise:null,normalsTransformPromise:null,usedMemoryInBytes:n};this._memCache.put(t,a,n,he.Ti),e.loadMeshPromise=null,i(a)};return e.loadMeshPromise=new Promise(((e,t)=>i(e,t))),e.loadMeshPromise}return i}}function be(e,t,i){e[t]=255&i,e[t+1]=255&i>>8,e[t+2]=255&i>>16,e[t+3]=255&i>>24}function xe(e){const t=e.metadata.displaySource?.source;if(null==t||!Array.isArray(t)||!t.length||t[0]instanceof File)return(0,de.lk)();const i=t;let r="";for(const e of i)r+=e.makeHash();return r+JSON.stringify(null!=e.transform?e.transform.toJSON():"")+((0,ue.Hq)(e.vertexSpace)?JSON.stringify(e.vertexSpace.origin):"")}const Se=4,we=4,Ce=1,Re=8;var Ee=i(42524);let Ae=class extends n.A{constructor(){super(),this.referenceCount=0,this.callbacks=new Array,this.runIndex=0}get running(){return this.callbacks.some((e=>e.running))}runTask(e){this._sort();const t=this.callbacks,i={numIndexLoading:0,numNodesLoading:0};for(let r=0;r<t.length&&!e.done;++r)t[r].priority=t[r].runTask(e,i),this.runIndex=r}_sort(){const e=this.callbacks;let t=e.length;for(let i=this.runIndex;i>0;i--){const r=e[i-1];let s=i;for(;s<e.length&&r.priority<=e[s].priority&&(s!==t||r.priority<e[s].priority);)e[s-1]=e[s],s++;e[s-1]=r,t=s-1}this.runIndex=0}add(e){this._sort(),e.priority=1/0,this.callbacks.unshift(e),this.notifyChange("running")}remove(e){(0,b.Xy)(this.callbacks,e),this.runIndex=this.callbacks.length,this._sort(),this.notifyChange("running")}};(0,r._)([(0,h.MZ)({readOnly:!0})],Ae.prototype,"running",null),Ae=(0,r._)([(0,u.$)("esri.views.3d.layers.i3s.I3SFrameTask")],Ae);class Te{constructor(e,t){this.task=e,this.handle=t}}const Oe=new Map;function Pe(e,t){let i=Oe.get(e);if(null==i){const t=new Ae,r=e.registerTask(Ee.W6.I3S_CONTROLLER,t);i=new Te(t,r),Oe.set(e,i)}return i.task.add(t),(0,w.hA)((()=>{null!=i&&(i.task.remove(t),i.task.callbacks.length>0||(Oe.delete(e),i.handle.remove(),i.task.destroy()),i=null)}))}var Me=i(96316),Ie=i(36466),De=i(37734);class Fe{constructor(e,t,i,r,s,n,a,o){this.id=e,this.mbs=t,this.obb=i,this.version=r,this.resources=s,this.children=n,this.lodSelection=a,this.numFeatures=o}}var Le=i(21016),Ne=i(45506);class Ve{constructor(e,t,i,r,s){this.childOffset=e,this.childCount=t,this.visibilityCache=i,this.ref=r,this.node=s,this.useAsHole=0,this.filterImpact=Ie.TJ.NotChecked,this.traversalState=null,this.parent=-1}}class Ge{constructor(e=new Array,t=new Array){this.nodes=e,this.children=t,this.lastTraversed=0,this.numNodesWithLoadedChildren=0}}class Ue{get _useNodePages(){return this._pageSize>0}constructor(e,t,i,r,s,n,a,o,l,c,h,d,u,p,f,g){this.viewingMode=e,this._layer=t,this._streamDataController=r,this._clientNodeLoader=s,this._viewportQueries=n,this._logger=a,this.holeFilling=o,this._isLoaded=l,this._isReloading=c,this._isSelected=h,this._enable=d,this._needsUpdate=u,this._canRequest=p,this._computeVisibilityObb=f,this._computeNodeFiltering=g,this._dirty=!0,this._nodePages=new Map,this._clientNodePage=null,this._pageSize=0,this._rootIndex=0,this._lodMetric=Ie.cJ.None,this._lodConversion=e=>e,this._isEditable=!1,this._urlPrefix="",this._loadingNodes=new Set,this._loadingPages=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._version=We(0),this._visibilityCacheVersion=We(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missingPagesAndNodes=new C.A({deallocator:null}),this._prefetchNodes=new C.A({deallocator:null}),this._updates=new Be(this._missingPagesAndNodes),this._imModificationUncategorized=new C.A({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=new Array,this._newPages=new Array,this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this._frameNumber=0,this._traverseDescendantsQueue=[0],this._traverseDescendantsNestingLevel=0,this._isEditable=(0,Me.lC)()&&null!=t.associatedLayer?.infoFor3D,t.serviceUpdateTimeStamp?.lastUpdate&&(this._lastUpdate=`${t.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1,this._init(i)}_init(e){if("page"===e.type){const t=e.rootPage;switch(this._urlPrefix=e.urlPrefix,this._pageSize=e.pageSize,e.lodMetric){case"maxScreenThreshold":this._lodMetric=Ie.cJ.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this._lodMetric=Ie.cJ.MaxScreenThreshold,this._lodConversion=Ke}if(this._isEditable){this._rootIndex=-1;const i=Qe(e.rootIndex,e.pageSize),r=t.nodes[i],s={nodes:[{index:this._rootIndex,children:[e.rootIndex],mesh:void 0,obb:r.obb,lodThreshold:r.lodThreshold}]};this._addPage($e(this._rootIndex,this._pageSize),s),this.getNode(-1).serviceObbInIndexSR=void 0}else this._rootIndex=e.rootIndex;this._addPage($e(e.rootIndex,this._pageSize),t),this._updateParentsAndLevel()}else if("node"===e.type){this._urlPrefix=e.urlPrefix;const t=new Ge;if(this._nodePages.set(0,t),this._isEditable){this._clientNodePage=new Ge;const t={id:"-1",version:null,mbs:e.rootNode.mbs,obb:e.rootNode.obb,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:e.rootNode.mbs,obb:e.rootNode.obb}]};this._rootIndex=this._makeClientRefNode(new Ie.ay(t.id,null),-1);const i=this._validateNode(t.id,t);i&&this._addNode(i,this._rootIndex)}else this._rootIndex=this._makeRefNode(new Ie.ay(e.rootNode.id,null),-1);const i=this._validateNode(e.rootNode.id,e.rootNode);i&&this._addNode(i,0)}}addClientNodeToIndex(e,t){const i=new Ie.ay(e,t),r=this._makeClientRefNode(i,-1);return this._linkChildToParentNode(-1,r),this.requestUpdate(),r}removeClientNodeFromIndex(e,t,i){this._destroyClientRefNode(e,t,i),this.requestUpdate()}_loadPage(e){this._loadingPages.add(e);const t=this._urlPrefix+e;this._streamDataController.request(t,"json").then((t=>{this._pageQueue.push({pageIndex:e,page:t})})).catch((t=>{this._loadingPages.delete(e),(0,o.zf)(t)||(this._failedPages.add(e),this._logger.error("#loadPage()",this._layer,`Error when loading page ${e}`,t))}))}_addQueuedPages(e){for(;this._pageQueue.length>0&&!e.done;){const{pageIndex:t,page:i}=this._pageQueue.shift();this._addPage(t,i),this._loadingPages.delete(t),e.madeProgress(),this.needNodeElevationRange&&this._newPages.push(t)}this._updateParentsAndLevel()}_invalidateElevationRangeForNewPages(e){if(this.needNodeElevationRange)for(;this._newPages.length>0&&!e.done;){const e=this._nodePages.get(this._newPages.shift());e?.nodes.forEach((e=>{let t=e.parent;for(;null!=t&&t!==this._rootIndex;){const e=this.getNode(t);e&&!Number.isNaN(e?.elevationRangeMin)&&(e.invalidateElevationRange(),this.invalidateBoundingVolumeCache(t)),t=this.getParentIndex(t)}}))}}_addPage(e,t){const i=[],r=[],s=t.nodes.map(((t,s)=>{const n=i.length,a=t.children?t.children.length:0;r.push(this._rootIndex);for(let e=0;e<a;e++)i.push(t.children[e]);const o=`${t.index}`,l=Ne.ab.fromJSON(t.obb),c=(0,X.b)(l.center,l.radius),h=t.mesh?.attribute,d=t.mesh?.geometry,u=t.mesh?.material,p={hasSharedResource:!1,isEmpty:null==d,attributes:null!=h?.resource?`${h.resource}`:void 0,geometry:null!=d?.resource?`${d.resource}`:void 0,texture:null!=u?.resource?`${u.resource}`:void 0,geometryDefinition:d?d.definition:-1,materialDefinition:u?u.definition:-1},f=new Ie.bP(o,Je(s,e,this._pageSize),c,a,0,p,this._lastUpdate,this._lodMetric,this._lodConversion(t.lodThreshold),d?d.featureCount:null);return f.serviceObbInIndexSR=l,f.visibilityObbInRenderSR=this._computeVisibilityObb(f),f.vertexCount=d?d.vertexCount:0,new Ve(n,a,je(this._visibilityCacheVersion),null,f)})),n=new Ge(s,i);-1===e?this._clientNodePage=n:this._nodePages.set(e,n)}_updateParentsAndLevel(){const e=new Array,t=(t,i,r)=>{const s=this._getPage(t);if(null!=s){const n=Qe(t,this._pageSize),a=s.nodes[n];a.parent=null!=i?i:-1;const o=a.node;null!=o&&(o.level=r,e.push(t))}};for(t(this._rootIndex,null,0);e.length;){const i=e.pop(),r=this.getNode(i);if(null!=r)for(let e=0;e<r.childCount;e++)t(this.getChildIndex(r.index,e),i,r.level+1),this._maxLevel=Math.max(this._maxLevel,r.level+1)}}_getPage(e){const t=$e(e,this._pageSize);return this._getPageFromPageIndex(t)}_getPageFromPageIndex(e){return e<0?this._clientNodePage:this._nodePages.get(e)}_getNodeInternal(e){const t=this._getPage(e);return null==t?null:(t.lastTraversed=this._frameNumber,t.nodes[Qe(e,this._pageSize)])}_addNode(e,t){e.children&&this.populateChildren(t,e.children);const i=this.getParent(t),r=null!=i?i.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?r+1:r);const{lodMetric:s,maxError:n}=function(e){if(e)for(let t=0;t<e.length;t++)for(const i of Ye)if(i[0]===e[t].metricType)return{lodMetric:i[1],maxError:e[t].maxError};return{lodMetric:Ie.cJ.None,maxError:0}}(e.lodSelection),a=this._getNodeInternal(t),o=new Ie.bP(e.id,t,e.mbs,a.childCount,r,e.resources,e.version,s,n,e.numFeatures);a.node=o,e.obb&&(o.serviceObbInIndexSR=Ne.ab.fromJSON(e.obb)),o.visibilityObbInRenderSR=this._computeVisibilityObb(o);const l=a.ref;return null!=l&&(null==l.serviceMbsInIndexSR&&(l.serviceMbsInIndexSR=e.mbs),o.shareServiceBVsInRenderSRWith(l),l.visibilityObbInRenderSR=o.visibilityObbInRenderSR),o}_makeRefNode(e,t){const i=this._nodePages.get(0);if(t<-1)return this._makeClientRefNode(e,t);if(null==i)return-1;const r=i.nodes.length,s=new Ve(0,0,je(this._visibilityCacheVersion),e,null);return i.nodes.push(s),s.parent=t,e.invalidateServiceBVsInRenderSR(),r}_makeClientRefNode(e,t){const i=this._clientNodePage;if(null==i)return-1;if(t>=0)throw new Error("I3SIndex::client side nodes can not be made children of service side nodes.");const r=-(i.nodes.length+1),s=new Ve(0,0,je(this._visibilityCacheVersion),e,null);return i.nodes.push(s),s.parent=t,e.invalidateServiceBVsInRenderSR(),r}_linkChildToParentNode(e,t){const i=this._clientNodePage;if(null==i||e>=0)return;const r=Qe(e,this._pageSize),s=Qe(t,this._pageSize),n=i.nodes[r],a=n.childOffset;i.children.splice(n.childOffset+n.childCount,0,t),n.childCount+=1,null!=n.node&&(n.node.childCount+=1);for(const e of i.nodes)e.childOffset>a&&(e.childOffset+=1);i.nodes[s].parent=e,this._updateParentBoundingInformation(e)}_destroyClientRefNode(e,t,i){const r=this._clientNodePage;if(null==r)return;const s=this.getParentIndex(e);if(null==s)return;const n=new Set,a=new Map,o=e=>{const i=Qe(e,this._pageSize),s=r.nodes[i];if(s.childCount>0)for(let e=s.childOffset;e<s.childOffset+s.childCount;++e)o(r.children[e]);const a=s.node?.id??s.ref?.id;if(null==a)throw new Error("Node has no id");t(a,e),n.add(s)};o(e);const l=r.nodes,c=r.children,h=r.nodes.map((()=>-1)),d=[],u=[];for(let e=0;e<l.length;++e){const t=l[e];if(n.has(t))continue;const r=d.length,s=Je(e,-1,this._pageSize),o=Je(r,-1,this._pageSize);if(t.node&&(t.node.index=o),h[e]=o,d.push(t),s!==o){const e=t.node?.id??t.ref?.id;if(null==e)throw new Error("Node has no id");i(e,s,o),a.set(s,o)}}for(let e=0;e<d.length;++e){const t=Je(e,-1,this._pageSize),i=d[e],r=u.length;for(let e=i.childOffset;e<i.childOffset+i.childCount;++e){const i=c[e];if(i>=0)u.push(i);else{const e=Qe(i,this._pageSize),r=l[e];if(n.has(r))continue;const s=h[e];u.push(s),r.parent=t}}i.childOffset=r,i.childCount=u.length-r,i.node&&(i.node.childCount=i.childCount)}r.nodes=d,r.children=u,this._updateParentBoundingInformation(h[Qe(s,this._pageSize)])}_updateParentBoundingInformation(e){let t=e;do{let e=null;const i=this._clientNodeLoader.indexSR,r=this._clientNodeLoader.renderSR,s=this._getNodeInternal(t);if(null==s)return;for(let n=0;n<s.childCount;n++){const s=this.getChildIndex(t,n),a=this._getNodeInternal(s),o=null!=a?a.ref||a.node:null;if(null!=o&&o.serviceMbsInIndexSR[3]>0)if(null==e)e=(0,X.c)(o.serviceMbsInIndexSR,et);else{const t=tt,s=it,n=rt;z(o.serviceMbsInIndexSR,i,t,r),z(e,i,s,r),(0,X.u)(t,s,n),z(n,r,e,i)}}const n=s.ref||s.node;null!=n&&(null!=e?(n.serviceMbsInIndexSR??=(0,X.d)(),(0,X.c)(e,n.serviceMbsInIndexSR)):(0,De.Q7)(n.serviceMbsInIndexSR),n.invalidateServiceBVsInRenderSR(),n.geometryObbInRenderSR=null),this.invalidateNodeVisibilityCacheInternal(s),t=this.getParentIndex(t)}while(null!=t)}populateChildren(e,t){const i=this._getNodeInternal(e),r=this._getPage(e);i.childOffset=r.children.length,i.childCount=t.length;for(let i=0;i<t.length;i++){const s=this._makeRefNode(t[i],e);r.children.push(s)}}getNode(e){const t=this._getNodeInternal(e);return null!=t?t.node:null}getIndexById(e){let t;return this._forAllNodes(((i,r)=>{(null!=i.node&&i.node.id===e||null!=i.ref&&i.ref.id===e)&&(t=r)})),t}getNodeById(e){const t=this.getIndexById(e);return null!=t&&t>=0?this.getNode(t):null}getChildIndex(e,t){const i=this._getPage(e);if(null==i)return-1;const r=i.nodes[Qe(e,this._pageSize)];return i.children[r.childOffset+t]}getParentIndex(e){const t=this._getPage(e);return null!=t&&e!==this._rootIndex?t.nodes[Qe(e,this._pageSize)].parent:null}getParent(e){const t=this.getParentIndex(e);return null!=t?this.getNode(t):null}isLeaf(e){const t=this._getNodeInternal(e);return null!=t&&0===t.childCount}get rootNode(){return this.getNode(this._rootIndex)}get isEditable(){return this._isEditable}removeAllGeometryObbs(){this._forAllNodes((e=>{null!=e.node&&(e.node.geometryObbInRenderSR=null)}))}invalidateVisibilityCache(){this._visibilityCacheVersion=We(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(e){const t=this._getNodeInternal(e);null!=t&&this.invalidateNodeVisibilityCacheInternal(t)}invalidateNodeVisibilityCacheInternal(e){e.visibilityCache=je(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(e){const t=this._getNodeInternal(e);null!=t&&(He(t),this.invalidateNodeVisibilityCacheInternal(t))}updateElevationChanged(e){const t=this._getNodeInternal(e);if(null==t)return;if(!this.needNodeElevationRange)return void this.invalidateBoundingVolumeCache(e);const i=null!=t.node?t.node:t.ref;null!=i&&i.invalidateElevationRange()}invalidateGeometryVisibility(e){const t=this._getNodeInternal(e),i=t?.node;i&&(i.geometryObbInRenderSR=null,i.invalidateServiceBVsInRenderSR())}invalidateVisibilityObbs(){null!=this.rootNode&&this.traverse(this.rootNode,(e=>(e.visibilityObbInRenderSR=this._computeVisibilityObb(e),e.geometryObbInRenderSR=null,!0)))}_updateElevationRange(e){this._updateElevationRangeInternal(e,null)}_updateElevationRangeInternal(e,t){const i=this._getNodeInternal(e);if(!i)return!1;const r=i?.node??i?.ref;if(!r)return!1;if(r.elevationRangeValid)return t?.expandElevationRange(r),!0;const s=new Le.H;let n=!1;for(let t=0;t<i.childCount;t++){const i=this.getChildIndex(e,t),r=this._updateElevationRangeInternal(i,s);n=n||!r}if(0===i.childCount||n){const e=!i.node?.resources.isEmpty;this._viewportQueries.expandElevationRange(r,e,s)}const a=r.elevationRangeMin,o=r.elevationRangeMax;return a===s.elevationRangeMin&&o===s.elevationRangeMax?(t?.expandElevationRange(r),!0):(i.node?.setElevationRange(s),i.ref?.setElevationRange(s),this.invalidateBoundingVolumeCache(e),t?.expandElevationRange(r),!0)}isNodeVisible(e){const t=this._getNodeInternal(e);if(null==t)return!0;const i=t.ref;if(null!=i&&!i.serviceMbsInIndexSR)return!0;if(!this.needNodeElevationRange&&Ze(t.visibilityCache,this._visibilityCacheVersion))return qe(t.visibilityCache);const r=t.node,s=this._viewportQueries;if(r&&r.level>0){s.ensureElevationAgnosticBoundingVolume(r,this.viewingMode);const e=r.elevationAgnosticBoundingVolume;if(!s.isElevationAgnosticBoundingVolumeVisible(this.viewingMode,e))return t.visibilityCache=ke(!1,this._visibilityCacheVersion),!1}if(this.needNodeElevationRange&&this._updateElevationRange(e),!Ze(t.visibilityCache,this._visibilityCacheVersion)){if(this._layerHasFilter&&this._computeNodeFiltering&&(null!=r||null!=i)&&t.filterImpact===Ie.TJ.NotChecked){const e=null!=r?r.serviceMbsInIndexSR:null!=i?i.serviceMbsInIndexSR:null;t.filterImpact=null!=e?this._computeNodeFiltering(e):Ie.TJ.Unmodified}const e=null!=r&&t.filterImpact===Ie.TJ.Culled,n=null!=r&&r.imModificationImpact===Ie.Js.Culled,a=!r||i&&!r.visibilityObbInRenderSR?i??null:r,o=!n&&(!a||s.isNodeVisible(a))&&!e;return t.visibilityCache=ke(o,this._visibilityCacheVersion),o}return qe(t.visibilityCache)}isGeometryVisible(e){if(!this.isNodeVisible(e))return!1;const t=this._getNodeInternal(e);return!!(null==t?.node?.geometryObbInRenderSR||this.layerHasModifications&&t.node.imModificationImpact===Ie.Js.NotChecked)||this._viewportQueries.isGeometryVisible(t.node)}_traverseCoverage(e,t,i,r,s){const n=this._getPage(e);if(null==n||0===t.childCount)return;const a=t.childOffset+t.childCount,o=new Array;for(let e=t.childOffset;e<a;++e){const t=n.children[e],i=this._getNodeInternal(t);null!=i?.node&&this.isGeometryVisible(t)&&o.push(i)}r/=o.length;for(const e of o){const t=e.node.index;this._isLoaded(t)||this._isReloading(t)?(s.delta=Math.max(s.delta,i),s.coverage+=r):this._traverseCoverage(t,e,i+1,r,s)}}useNodeAsHole(e){if("off"===this.holeFilling)return!1;const t=this._getNodeInternal(e);if(null==t)return!1;if("always"===this.holeFilling)return!0;if(Ze(t.useAsHole,this._version))return qe(t.useAsHole);const i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);const r=i.delta*i.coverage<=.5;return t.useAsHole=ke(r,this._version),r}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=We(this._version)}imModificationsChanged(e){this.layerHasModifications=e,this._forAllNodes((({node:e})=>{null!=e&&(e.imModificationImpact=Ie.Js.NotChecked,e.visibilityObbInRenderSR=this._computeVisibilityObb(e),e.hasModifications&&this.invalidateGeometryVisibility(e.index))})),this.invalidateVisibilityCache()}layerFilterChanged(e){this._layerHasFilter=e,this._forAllNodes((e=>{if(null!=e){e.filterImpact=Ie.TJ.NotChecked;const t=e.node;null!=t&&this.invalidateNodeVisibilityCache(t.index)}})),this.invalidateVisibilityCache()}update(e,t,i){if(!this._dirty)return;this._pageQueue.length>0&&this._addQueuedPages(t),this._invalidateElevationRangeForNewPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missingPagesAndNodes.clear(),this._prefetchNodes.clear(),this._updates.reset(e),ze.clear();let r=!0;const s=new Xe,n=new Xe,a=this._imModificationUncategorized;a.clear();const o=new Set;let l=0;this.traverseVisible(((o,c,h)=>{const d=$e(o,this._pageSize);if(null==c){let e=this._entryPriority(o);return e===1/0&&(e=this._entryPriority(h)),ze.set(d,Math.max(e,ze.get(d)||0)),this._loadingPages.has(d)||this._failedPages.has(d)||(this._missingPagesAndNodes.push(d),++l),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const u=c.node;if(this._updateNodeFeatureEstimate(u,n),null==u){const e=this._entryPriority(o);return this._loadingNodes.has(o)||this._failedNodes.has(o)||(this._missingPagesAndNodes.push(o),ze.set(o,e)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const p=this._getPage(o);if(0===this._missingPagesAndNodes.length&&!this._useNodePages)for(let e=0;e<c.childCount;e++){const t=p.children[c.childOffset+e],i=this._getNodeInternal(t);null==i||i.node||this._loadingNodes.has(t)||this._failedNodes.has(t)||(ze.set(t,this._entryPriority(t)),this._prefetchNodes.push(t))}if(u.failed||u.resources.isEmpty)return void(r&&c.childCount>0&&this._isSelected(u)&&(r=!1));if(this._isLoaded(o)){if(s.known+=u.memory,++s.knownNodes,this._isSelected(u)?c.childCount>0&&(r=!1):(s.unremoved+=u.memory,r=!1),this._needsUpdate(u)){const e=this._entryPriority(o);ze.set(o,e),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e),this._updates.update.push(o)}return}if(u.memory&&(s.known+=u.memory,++s.knownNodes),!this._isSelected(u))return void(this._isReloading(o)&&this._updates.remove.push(o));if(c.childCount>0&&(r=!1),u.memory?(s.missing+=u.memory,s.known+=u.memory,++s.knownNodes):++s.missingNodes,e.includes(u.index))return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(o)),void(this._updates.cancel=this._updates.cancel.filter((e=>e!==u.index)));if(!t.done&&this._enable(u))return void t.madeProgress();const f=this._entryPriority(o);ze.set(o,f),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,f),this._updates.add.push(o),this.layerHasModifications&&i&&null!=u&&u.imModificationImpact===Ie.Js.NotChecked&&a.push(o)}),o),this._frameNumber++,this._missingPagesAndNodes.sort(((e,t)=>e-t)),this._missingPagesAndNodes.filterInPlace(((e,t)=>t<1||this._missingPagesAndNodes.data[t-1]!==e)),this._missingPagesAndNodes.sort(((e,t)=>ze.get(e)-ze.get(t))),this._missingPagesAndNodes.length>0&&(this._maxUnloadedPrio=ze.get(this._missingPagesAndNodes.back()),this._prefetchNodes.clear()),this._removeUnusedNodePages(o,l);const c=this._updates.add;c.length>0&&this.layerHasModifications&&(a.length>0&&i?.(a),c.filterInPlace((e=>{const t=this._getNodeInternal(e),i=null==t?.node||t.node.imModificationImpact!==Ie.Js.Culled;return i||this.invalidateNodeVisibilityCache(e),i}))),this._unloadedMemoryEstimate=s.missing-s.unremoved,s.knownNodes>3&&s.missingNodes>0&&(this._unloadedMemoryEstimate+=s.known/s.knownNodes*s.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(n),this._featureEstimate.leavesReached=r,this._updates.add.filterInPlace((e=>ze.get(e)>=this._maxUnloadedPrio)).sort(((e,t)=>ze.get(e)-ze.get(t))),this._updates.update.sort(((e,t)=>ze.get(e)-ze.get(t))),this._indexMissing=this._loadingPages.size+this._loadingNodes.size+this._missingPagesAndNodes.length,this._dirty=this._indexMissing>0,ze.clear()}checkFeatureTarget(e,t){const i=this._viewportQueries.updateScreenSpaceErrorBias(t);let r=t,s=t,n=i,a=10;for(;a--;){const i=new Xe;if(this._updateFeatureEstimate(r,i),this._computeFeatureEstimate(i)<=e){if(r>=t||i.missingNodes>0||0===a)break;n=r,r=.5*(r+s)}else s=r,r=.5*(r+n)}return this._version=We(this._version),this._viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,r)}_removeUnusedNodePages(e,t){if(!this._useNodePages)return;const i=e.size,r=this._nodePages,s=r.size+this._loadingPages.size+t;if(s>st&&s>i){const t=new Array;for(const[i,s]of r)0!==s.numNodesWithLoadedChildren||e.has(i)||t.push([s.lastTraversed,i]);t.sort(((e,t)=>e[0]-t[0])).some((e=>{const t=e[1];return this._deleteNodePage(t),r.size<=st}))}}_updateFeatureEstimate(e,t){this._version=We(this._version),this._viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(((e,i)=>this._updateNodeFeatureEstimate(null!=i?i.node:void 0,t)))}_updateNodeFeatureEstimate(e,t){null==e||e.failed||null==e.numFeatures||this._isSelected(e)&&(null!=e.numFeatures?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes)}_computeFeatureEstimate(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}load(){return this._load(this._missingPagesAndNodes)}prefetch(){return this._prefetchNodes.sort(((e,t)=>ze.get(e)-ze.get(t))),this._load(this._prefetchNodes)}_load(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();){const t=e.pop();this._useNodePages&&t>=0?this._loadPage(t):this._loadNode(t)}return!0}get isLoading(){return this._indexMissing>0}get isPrefetching(){return this._prefetchNodes.length>0}get indexLoading(){return this._loadingPages.size+this._loadingNodes.size}get indexMissing(){return this._indexMissing}get unloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}get maxPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}nodeTraversalState(e){if(null==e)return null;const t=e.index,i=this._getNodeInternal(t);if(!i)return null;let r=i?.traversalState;if(r&&Ze(r.version,this._version))return r;const s=this._viewportQueries.getLodLevel(e),n=this._viewportQueries.hasLOD(e);let a=!0;if(n){const e=this.getParentIndex(t);if(null!=e){const t=this._getNodeInternal(e),i=t?.traversalState;a=!!i&&s>i.lodLevel}else a=s>0}else a=0===e.childCount;return r?(r.lodLevel=s,r.isChosen=a,r.version=ke(!0,this._version),r):(r=new Ie.EG(n,a,s,ke(!0,this._version)),i.traversalState=r,r)}async _loadNode(e){this._loadingNodes.add(e);const t=this._getNodeInternal(e).ref;if(null==t)return void this._failedNodes.add(e);const i=t.id,r=this._urlPrefix+i,s=()=>{this._loadingNodes.delete(e),0===this._missingPagesAndNodes.length&&0===this._loadingNodes.size&&this.requestUpdate()};let n=null;try{n=e>=0?await this._streamDataController.request(r,"json"):await this._clientNodeLoader.loadNodeJSON(i)}catch(t){return s(),void((0,o.zf)(t)||(this._logger.error("#loadNode()",this._layer,"Error loading node: "+r),this._failedNodes.add(e)))}s();const a=this._validateNode(i,n);if(null==a)return;a.obb&&this.invalidateNodeVisibilityCache(e);const l=this._addNode(a,e);this.nodeTraversalState(l)}_validateNode(e,t){if(null==t||"object"!=typeof t||t.id!==e)return this._logger.error("#validateNode()",this._layer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this._logger.error("#validateNode()",this._layer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,`Invalid shared resource href on node "${e}"`);const i=t.geometryData;null==i||Array.isArray(i)&&0===i.length||Array.isArray(i)&&1===i.length&&"./geometries/0"===i[0].href||this._logger.warn("#validateNode()",this._layer,`Invalid geometry data on node "${e}"`);const r=t.attributeData,s=this._layer.attributeStorageInfo;null==r||Array.isArray(r)&&!r.some(((e,t)=>e.href!==`./attributes/${s?.[t]?.key??`f_${t}`}/0`))||this._logger.warn("#validateNode()",this._layer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this._logger.warn("#validateNode()",this._layer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const n=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:void 0,a=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:void 0,o=Array.isArray(t.children)?t.children.map((t=>{if(null==t)return null;const i=t=>this._logger.error("#validateNode()",this._layer,`Invalid node reference on node ${e}: ${t}`);if("number"==typeof t.id)i(`id ${t.id} is a number instead of a string.`);else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i(`Invalid bounding volume on reference ${t.id}.`),null;t.href&&t.href!=="../"+t.id&&this._logger.error("#validateNode()",this._layer,`Invalid node href on node "${e}"`);const r=new Ie.ay(`${t.id}`,t.mbs);return r.serviceObbInIndexSR=!this.ignoreServiceObb&&t.hasOwnProperty("obb")&&t.obb?Ne.ab.fromJSON(t.obb):null,r.visibilityObbInRenderSR=this._computeVisibilityObb(r),r})).filter((e=>null!=e)):null,l=t.featureData?.length??!1,c=!0===t.isEmpty;return new Fe(e,t.mbs,n,"string"==typeof t.version?t.version:null,{isEmpty:!l&&c,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:void 0,texture:t.textureData&&t.textureData.length>0?e:void 0,geometry:null!=t.geometryData?e:void 0},o,Array.isArray(t.lodSelection)?t.lodSelection:null,a)}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes((e=>{null!=e.node&&(e.node.failed=!1)}))}_entryPriority(e){const t=this._getNodeInternal(e),i=this.getParentIndex(e);if(null==t||null==i&&null==t.node)return null==i?1/0:this._entryPriority(i);let r=0;if(t.node&&null!=i){const e=this._getNodeInternal(i).traversalState;null!=e&&(r=e.lodLevel)}let s=this.progressiveLoadPenalty;for(let t=e;null!=t;t=this.getParentIndex(t))if(this._isLoaded(t)){s=0;break}const n=null!=t.ref?this._viewportQueries.distToPOI(t.ref):null!=t.node?this._viewportQueries.distToPOI(t.node):0;return-n-r*(n+this.progressiveLoadPenalty)+s}traverseVisible(e,t){const i=this._getNodeInternal(this._rootIndex);null!=i?this._traverseVisible(this._rootIndex,null,i,e,t):e(this._rootIndex,null,null)}_traverseVisible(e,t,i,r,s){const n=$e(e,this._pageSize);if(s&&s.add(n),i.node&&0===i.childCount)return void(this.isGeometryVisible(e)&&r(e,i,t));if(!this.isNodeVisible(e))return;if(r(e,i,t),null==i.node)return;const a=this.nodeTraversalState(i.node);if(a?.nodeHasLOD&&a.lodLevel===this._maxLodLevel)return;const o=this._getPageFromPageIndex(n);for(let t=0;t<i.childCount;t++){const n=o.children[i.childOffset+t],a=this._getNodeInternal(n);if(a)this._traverseVisible(n,e,a,r,s);else{if(s){const e=$e(n,this._pageSize);s.add(e)}r(n,null,e)}}}traverse(e,t){t(e)&&this.traverseDescendants(e,t)}traverseDescendants(e,t){++this._traverseDescendantsNestingLevel;const i=e.index,r=this._pageSize,s=$e(i,r),n=this._getPageFromPageIndex(s);if(null==n)return;const a=this._frameNumber,o=this._nodePages;n.lastTraversed=a;const l=Qe(i,r),c=n.nodes[l],{childCount:h}=c;if(0===h)return;const d=1===this._traverseDescendantsNestingLevel?this._traverseDescendantsQueue:[0];let u=0;const p=[];{const{childOffset:e,childCount:t}=c,{children:i}=n;d.length=2**Math.ceil(Math.log2(u+t));for(let r=e;r<e+t;++r){const e=i[r];e>=0?(d[u]=e,++u):p.push(e)}}if(p.length>0){const e=this._clientNodePage;if(e){const i=e.children;let r=0;for(;r<p.length;){const s=p[r];++r;const n=-s-1,a=e.nodes[n],o=a.node;if(!o)continue;if(!t(o))continue;const{childCount:l}=a;if(0===l)continue;const{childOffset:c}=a,h=c+l;for(let e=c;e<h;++e)p.push(i[e])}}}if(u>0){let e=0;if(r>0){let i=s*r,l=n,c=l.nodes;for(;e<u;){const s=d[e];let n;if(++e,i<=s&&s<i+r)n=l;else{const e=s/r|0,t=o.get(e);if(void 0===t)continue;n=t,n.lastTraversed=a,l=n,c=l.nodes,i=r*e}const h=c[s-i],p=h.node;if(null==p)continue;if(!1===t(p))continue;const{childCount:f}=h;if(0===f)continue;const g=u+f;for(d.length<g&&(d.length=2**Math.ceil(Math.log2(u+f)));d.length<u+f;)d.length+=d.length;const m=n.children,{childOffset:_}=h,y=_+f;for(let e=_;e<y;++e)d[u]=m[e],++u}}else{const i=o.get(0);if(i)for(;e<u;){const r=d[e];++e;const s=i.nodes[r],n=s.node;if(!n)continue;if(!t(n))continue;const{childCount:a}=s;if(0===a)continue;d.length=Math.max(d.length,2**Math.ceil(Math.log2(u+a)));const o=i.children,{childOffset:l}=s,c=l+a;for(let e=l;e<c;++e)d[u]=o[e],++u}}}--this._traverseDescendantsNestingLevel}updateChildrenLoaded(e,t){let i=this.getNode(e);for(;null!=i;){const e=i.childrenLoaded,r=e+t;i.childrenLoaded=r;const s=0===e?1:0===r?-1:0,n=i.index;0!==s&&(this._getPage(n).numNodesWithLoadedChildren+=s),i=this.getParent(n)}}checkChildrenLoadedInvariant(){if(null==this.rootNode)return!0;const e=[],t=i=>{let r=this._isLoaded(i.index)||this._isReloading(i.index)?1:0;return this.traverseDescendants(i,(e=>(r+=t(e),!1))),i.childrenLoaded!==r&&e.push(i.index),r};return t(this.rootNode),e.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+e.join(",")),e.length>0}updateElevationInfo(e,t){this.needNodeElevationRange=t&&!!e&&("relative-to-ground"===e.mode||"on-the-ground"===e.mode),this._viewportQueries.updateElevationInfo(e),this.invalidateAllElevationRanges()}invalidateAllElevationRanges(){this._forAllNodes((e=>{He(e),null!=e.node&&e.node.invalidateElevationRange(),null!=e.ref&&e.ref.invalidateElevationRange()}))}_forAllNodes(e){if(null!=this._clientNodePage){const t=this._clientNodePage;for(let i=0;i<t.nodes.length;i++)e(t.nodes[i],-(i+1))}for(const[t,i]of this._nodePages){const r=t*this._pageSize;for(let t=0;t<i.nodes.length;t++)e(i.nodes[t],r+t)}}clearCaches(){if(this._useNodePages){const e=this._nodePages,t=new Set;this.traverseVisible((e=>t.add($e(e,this._pageSize))));for(const[i,r]of e)if(0!==r.numNodesWithLoadedChildren||t.has(i))for(const e of r.nodes)e.traversalState=null;else this._deleteNodePage(i)}}_deleteNodePage(e){this._nodePages.delete(e)}get test(){return{addNode:(e,t)=>this._addNode(this._validateNode(e.id,e),t),getNodeInternal:e=>this._getNodeInternal(e),getPageIndex:e=>$e(e,this._pageSize),getIndexWithinPage:e=>Qe(e,this._pageSize),getNodePage:e=>e<0?this._clientNodePage:this._nodePages.get(e),getChildIndices:e=>{const t=this._getNodeInternal(e),i=this._getPage(e);if(null==t||null==i)return[];const r=[];for(let e=t.childOffset;e<t.childOffset+t.childCount;++e)r.push(i.children[e]);return r},rootIndex:this._rootIndex,clientNodePage:this._clientNodePage,nodePages:this._nodePages}}}const ze=new Map;class Be{constructor(e){this.missing=e,this.update=new C.A({deallocator:null}),this.add=new C.A({deallocator:null}),this.remove=new C.A({deallocator:null}),this.cancel=[]}reset(e){this.add.clear(),this.update.clear(),this.cancel=e}}function He(e){e.node?.invalidateServiceBVsInRenderSR(),e.ref?.invalidateServiceBVsInRenderSR()}function je(e){return(0,De.b$)(e,-2)}function We(e){return(0,De.b$)(e,2)}function ke(e,t){return t+(e?1:0)}function Ze(e,t){return(-2&e)===t}function qe(e){return 1==(1&e)}function $e(e,t){return e<0?-1:t>0?e/t|0:0}function Qe(e,t){return e<0?-e-1:0===t?e:e%t}function Je(e,t,i){return-1===t?-(e+1):0===i?e:t*i+e}const Ye=[["maxScreenThreshold",Ie.cJ.MaxScreenThreshold],["screenSpaceRelative",Ie.cJ.ScreenSpaceRelative],["removedFeatureDiameter",Ie.cJ.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",Ie.cJ.DistanceRangeFromDefaultCamera]];class Xe{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}function Ke(e){return Math.sqrt(e*(4/Math.PI))}const et=(0,X.d)(),tt=(0,X.d)(),it=(0,X.d)(),rt=(0,X.d)(),st=(0,d.A)("esri-mobile")?100:300;var nt,at;(at=nt||(nt={}))[at.FadeIn=0]="FadeIn",at[at.FadeOut=1]="FadeOut";class ot{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}startNodeLoading(e,t,i,r){this._maxLodLevel=r.maxLodLevel,this._index=i,this._isNodeInScaleBounds=e,this._removeNodes=t}shouldLoadNode(e){if(null==e)return!1;const t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const t=this._layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(t-1)));lt.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1,!!this._layerView.nodeCrossfadingEnabled);const r=lt.length;this._removeNodes(lt,e);const s=lt.length<r;return 0!==lt.length&&(this._lodGlobalDirty=!0),lt.clear(),s}_lodGlobalHandling(e,t,i,r){if(null==e)return!1;const s=e.index,n=this._index,a=this._layerView,o=n.nodeTraversalState(e),l=this._isChosenMaxLOD(o),c=e.resources.isEmpty;if(l&&c)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const h=a.isNodeLoaded(s);if(r&&h&&l){const t=!i&&this.hasNoVisibleChildren(e);a.fadeNode(s,nt.FadeIn,!t)}const d=h&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(s));if(h&&(a.updateNodeState(s,l?Ie.UY.Leaf:Ie.UY.Hole),l))return d&&this._removeChildrenRecursive(e),d;const u=e.childCount>0;let p=u;if(u)for(let a=0;a<e.childCount;a++){const e=n.getChildIndex(s,a),o=n.getNode(e);null!=o?n.isGeometryVisible(e)&&!this._lodGlobalHandling(o,t,i||d,r)&&this._isNodeInScaleBounds(o)&&(p=!1):n.isNodeVisible(e)&&(p=!1)}const f=h&&!l&&(p||lt.length<t);f&&lt.push(s),!r||f||!h||i||p||a.fadeNode(s,nt.FadeIn,!1);const g=e.resources.isEmpty;return p||d&&!f||g}_removeChildrenRecursive(e){this._index.traverseDescendants(e,(e=>((this._layerView.isNodeLoaded(e.index)||this._layerView.isNodeReloading(e.index))&&lt.push(e.index),e.childrenLoaded>0)))}hasNoVisibleChildren(e){let t=!0;return this._index.traverseDescendants(e,(e=>!(!t||!this._index.isNodeVisible(e.index))&&(this._layerView.isNodeLoaded(e.index)?(t=!1,!1):e.childrenLoaded>0))),t}_childrenRequireLoading(e){let t=!1,i=!0;return this._index.traverseDescendants(e,(e=>{if(!i||!this._index.isNodeVisible(e.index))return!1;const r=this._index.nodeTraversalState(e);return this._isChosenMaxLOD(r)&&this._index.isGeometryVisible(e.index)&&(t=!0),this._layerView.isNodeLoaded(e.index)?(i=!1,!1):e.childrenLoaded>0})),i&&t}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}const lt=new C.A({deallocator:null});var ct,ht,dt=i(3132),ut=i(15565),pt=i(19759),ft=i(16504),gt=i(78546);(ht=ct||(ct={}))[ht.Earth=1]="Earth",ht[ht.Mars=2]="Mars",ht[ht.Moon=3]="Moon",ht[ht.COUNT=4]="COUNT";var mt=i(32573),_t=i(68716);function yt(e){return e.sort(((e,t)=>e.encoding-t.encoding))}const vt={ktx2:ie.KTX2,basis:ie.Basis,dds:ie.DDS_S3TC,png:ie.PNG,jpg:ie.JPG,"ktx-etc2":ie.KTX_ETC2},bt={[ge.JS.KTX2_ENCODING]:ie.Basis,[ge.JS.BASIS_ENCODING]:ie.Basis,[ge.JS.DDS_ENCODING]:ie.DDS_S3TC,"image/png":ie.PNG,"image/jpg":ie.JPG,"image/jpeg":ie.JPG,"image/ktx":ie.KTX_ETC2};_t.pF.CLAMP_TO_EDGE,_t.pF.CLAMP_TO_EDGE,_t.pF.REPEAT,_t.pF.REPEAT;class xt{constructor(e,t,i,r,s,n){if(this._streamDataController=t,this._logger=i,this._defaultGeometrySchema=r,this._requiredAttributes=s,this._options=n,this._logLayer=e,this._layerUrl=e.parsedUrl.path,this._geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){const t=e.textureSetDefinitions;this._materialAndTextures=e.materialDefinitions.map((i=>function(e,t,i){const r=new Map,s=(e,t)=>{if(null==e)return-1;const i=r.get(e.id);if(i)return i.usage|=t,i.id;const s=r.size;return r.set(e.id,{id:s,usage:t}),s},n=t.pbrMetallicRoughness,a=n?.baseColorFactor,o=t.emissiveFactor,l=(0,d.A)("disable-feature:diffuse-rendering-i3s")||i?(0,_e.me)({normalTexture:t.normalTexture,emissiveTexture:t.emissiveTexture,emissiveFactor:t.emissiveFactor,occlusionTexture:t.occlusionTexture,metallicRoughnessTexture:n?.metallicRoughnessTexture,metallicFactor:n?.metallicFactor,roughnessFactor:n?.roughnessFactor}):(0,_e.Jr)({normalTexture:t.normalTexture,emissiveTexture:t.emissiveTexture,emissiveFactor:t.emissiveFactor,occlusionTexture:t.occlusionTexture,metallicRoughnessTexture:n?.metallicRoughnessTexture,metallicFactor:n?.metallicFactor,roughnessFactor:n?.roughnessFactor}),c=l?_e.mX[0]:n?.metallicFactor??_e.Rk[0],h=l?_e.mX[1]:n?.roughnessFactor??_e.Rk[1],u="mask"===t.alphaMode?re.Color|re.AlphaMask:re.Color,p={baseColorFactor:a?[a[0],a[1],a[2],a[3]]:[1,1,1,1],baseColorTextureId:s(n?.baseColorTexture,u),metallicRoughnessTextureId:s(n?.metallicRoughnessTexture,re.MetallicRoughness),metallicFactor:c,roughnessFactor:h},f={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?ge.s2.None:"back"===t.cullFace?ge.s2.Back:"front"===t.cullFace?ge.s2.Front:ge.s2.None,normalTextureId:s(t.normalTexture,re.Normal),emissiveTextureId:s(t.emissiveTexture,re.Emissive),occlusionTextureId:s(t.occlusionTexture,re.Occlusion),emissiveFactor:o?[o[0],o[1],o[2]]:[0,0,0],metallicRoughness:p,wrapTextures:!1,hasParametersFromSource:l},g=[];return r.forEach((({usage:t},i)=>{const r=null!=e&&e[i]&&e[i].formats,s=r?yt(r.map((({name:e,format:t})=>({name:e,encoding:vt[t]})))):[];g.push({id:i,usage:t,encodings:s})})),{material:f,textures:g}}(t,i,"integrated-mesh"===e.type)))}}_load(e,t,i){return this._streamDataController.request(e,t,i)}_loadAttribute(e,t,i){const r=`${this._layerUrl}/nodes/${e.resources.attributes}/attributes/${t.key}/0`;return this._load(r,"binary",i).then((e=>(0,ft.m0)(t,e)))}async loadAttributes(e,t,i){const r=await Promise.allSettled(t.map((t=>this._loadAttribute(e,t.attributeStorageInfo,i)))),s={};for(let i=0;i<t.length;++i){const n=r[i],a=t[i];if("fulfilled"===n.status){const e=n.value;s[a.name]=e}else{const t=n.reason;(0,o.QP)(t),this._logger.error("#loadAttributes",this._logLayer,`Failed to load attributeData for '${a.name}' on node '${e.id}'`,t)}}return s}async loadNodeData(e,t){const i=null!=this._requiredAttributes&&e.resources.attributes?(0,dt.Ke)(this.loadAttributes(e,this._requiredAttributes,t)):null,{bufferDefinition:r,bufferIndex:s}=function(e,t){const i={bufferDefinition:null,bufferIndex:0},r=t.resources.geometryDefinition;if(null==e||null==r||r<0)return i;const s=r>=0?e[r].geometryBuffers:null;if(null==s)return i;for(let e=0;e<s.length;e++){const t=s[e];if(null==t.compressedAttributes)i.bufferIndex=e,i.bufferDefinition=s[e];else if("draco"===t.compressedAttributes.encoding&&!(0,d.A)("disable-feature:i3s-draco"))return i.bufferIndex=e,i.bufferDefinition=t,i}return i}(this._geometryDefinitions,e),n=!!e.resources.geometry,a=n?(0,dt.Ke)(this._loadGeometry(e.resources.geometry,s,t)):null,o=e.resources.hasSharedResource?await this._loadShared(e,t):null,l=e.resources.materialDefinition,c=this._materialAndTextures&&null!=l&&l>=0?this._materialAndTextures[l]:null!=o?function(e){const t=e?.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,i=e?.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,r=t?e.materialDefinitions?.[t]:null,s=i?e.textureDefinitions?.[i]:null,n={alphaMode:"opaque",alphaCutoff:gt.H,doubleSided:!0,cullFace:ge.s2.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0};if(null!=r){const e=r.params;e.diffuse&&(n.metallicRoughness.baseColorFactor=[e.diffuse[0],e.diffuse[1],e.diffuse[2],1]),null!=e.doubleSided&&(n.doubleSided=e.doubleSided,n.cullFace=e.doubleSided?ge.s2.None:ge.s2.Back),"none"!==e.cullFace&&"front"!==e.cullFace&&"back"!==e.cullFace||(n.cullFace="none"===e.cullFace?ge.s2.None:"back"===e.cullFace?ge.s2.Back:ge.s2.Front),e.transparency&&(n.metallicRoughness.baseColorFactor[3]=(0,U.qE)(1-e.transparency,0,1)),(e.useVertexColorAlpha||n.metallicRoughness.baseColorFactor[3]<1)&&(n.alphaMode="blend")}const a=[];if(null!=s){const e=0;!s.wrap||"repeat"!==s.wrap[0]&&"repeat"!==s.wrap[1]||(n.wrapTextures=!0);let t=re.Color;"rgba"===s.channels&&(n.alphaMode="blend",t|=re.AlphaMask);const i=s.images.length-1,r=s.images[i],o=e=>e?.split("/").pop(),l=Array.isArray(s.encoding)?yt(s.encoding.map(((e,t)=>({name:o(r.href[t]),encoding:bt[e]||0})))):[{name:o(r.href),encoding:bt[s.encoding]||0}];a.push({id:e,usage:t,encodings:l}),n.metallicRoughness.baseColorTextureId=e}return{material:n,textures:a}}(o):null,h=c?.material,u=c?.textures??[],p=`${e.id}`,f=!n&&this._options.loadFeatureData,g=f?await this._loadFeatureData(p,t):null,m=f?function(e){if(!e)return null;for(const t of e.featureData){const e=t.geometries;if(null!=e)for(const i of e)return{featureIds:[t.id],featureDataPosition:t.position,geometries:[i]}}return null}(g):function(e){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}(h),_=null==m?function(e){if(!e)return null;const t=new Array;for(const i of e.featureData)null!=i.position&&t.push({featureIds:[i.id],featureDataPosition:i.position,geometries:[]});return t}(g):null,y=u.length>0?(0,dt.Ke)(this.loadTextures(e,u,t)):null;let v=null,b=null;if(a){v=(0,dt.QA)(await a);const e=function(e,t){if(!e||!t?.materialDefinitions)return e;const i=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[i].params.vertexRegions&&e.vertexAttributes.region&&delete(e=(0,ut.o8)(e)).vertexAttributes.region,e}(this._defaultGeometrySchema,o);b=(0,ft.qs)(r,e)}const x=y?(0,dt.QA)(await y):null,S=i?(0,dt.QA)(await i):{},w=S?{attributeData:S,loadedAttributes:this._requiredAttributes}:null;if(null!=m)return{geometryData:m,attributeDataInfo:w,geometryBuffer:v,geometryDescriptor:b,requiredTextures:u,textureData:x};if(null!=_)return{pointData:_,attributeDataInfo:w,geometryBuffer:v,geometryDescriptor:b,requiredTextures:u,textureData:x};throw new Error}static _addAbsoluteHrefTexture(e,t){const i=e.textureDefinitions;if(null!=i)for(const e of Object.keys(i))for(const r of i[e].images)Array.isArray(r.href)?r.hrefConcat=r.href.map((e=>(0,pt.s2)(e,t))):r.hrefConcat=(0,pt.s2)(r.href,t)}static _fixTextureEncodings(e){const t=e.textureDefinitions;if(null!=t)for(const e in t){const i=t[e];if(Array.isArray(i.encoding))for(let e=0;e<i.encoding.length;e++){const t=i.encoding[e];"data:"===t.substring(0,5)&&(i.encoding[e]=t.substring(5))}else{const e=i.encoding;"data:"===e.substring(0,5)&&(i.encoding=e.substring(5))}}}async _loadShared(e,t){if(null==e.resources.geometry)return{};const i=`${this._layerUrl}/nodes/${e.resources.geometry}/shared`,r=await this._load(i,"json",t);return xt._fixTextureEncodings(r),xt._addAbsoluteHrefTexture(r,i),r}_loadTexture(e,t,i,r,s,n){let a=!1;return s===ie.DDS_S3TC||s===ie.KTX2||s===ie.Basis?this._load(e,"binary",n).then((e=>({id:t,usage:i,data:e,encoding:s,downsampled:a}))):this._load(e,"image",n).then((e=>{let n=e;if(r&&e.width*e.height>=4096){const t=Math.ceil(e.width/2),i=Math.ceil(e.height/2),r=document.createElement("canvas");r.width=t,r.height=i,r.getContext("2d").drawImage(e,0,0,t,i),n=r,a=!0}return{id:t,usage:i,data:n,encoding:s,downsampled:a}}))}loadTextures(e,t,i){const r=!!this._options.uncompressedTextureDownsamplingEnabled,s=this._options.textureUsageMask;return Promise.all(t.map((t=>{if(0==(t.usage&s))return null;const n=function(e,t){if(null!=t)return e.find((e=>0!=(e.encoding&t)))}(t.encodings,this._options.textureEncodings);if(null==n)return this._logger.error("#loadTextures",this._logLayer,`No known encoding for texture found on node ${e.id}`),Promise.reject();const a=e.resources.texture||e.id,o=`${this._layerUrl}/nodes/${a}/textures/${n.name}`;return this._loadTexture(o,t.id,t.usage,r,n.encoding,i)})))}_loadFeatureData(e,t){const i=`${this._layerUrl}/nodes/${e}/features/0`;return this._load(i,"json",t)}_loadGeometry(e,t,i){const r=`${this._layerUrl}/nodes/${e}/geometries/${t}`;return this._load(r,"binary",i)}}class St{constructor(e,t,i){this._requester=e,this._customParameters=t,this._apiKey=i,this._activeRequests=new Set}get busy(){return this._requester.busy}request(e,t,i){const r=new AbortController,s=(0,o.NY)(i,(()=>r.abort())),n={signal:r.signal,query:{...this._customParameters,token:this._apiKey}},a=this._requester.request(e,t,n),l={response:a,abortController:r,abortHandle:s};return this._activeRequests.add(l),(0,o.Gk)(a,(()=>{l.abortController=null,l.abortHandle?.remove(),l.abortHandle=null,this._activeRequests.delete(l)})),a}cancelAll(){this._activeRequests.forEach((e=>{e.abortController?.abort(),e.abortController=null,e.abortHandle?.remove()})),this._activeRequests.clear()}}var wt=i(34670),Ct=i(32159),Rt=i(74860),Et=i(80788);function At(e){return"point"===e.type}class Tt{constructor(e,t=null,i=0){this.array=e,this.spatialReference=t,this.offset=i}}function Ot(e){return"array"in e}function Pt(e,t,i="ground"){if(At(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,i);if(Ot(t)){let r=t.offset;return e.getElevation(t.array[r++],t.array[r++],t.array[r]||0,t.spatialReference??e.spatialReference,i)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,i)}var Mt,It=i(33763);function Dt(e,t,i,r,s,n,a,o,l,c,h){const d=Ht[h.mode];let u,p,f=0;if((0,k.projectBuffer)(e,t,i,r,l.spatialReference,s,o))return d.requiresAlignment(h)?(f=d.applyElevationAlignmentBuffer(r,s,n,a,o,l,c,h),u=n,p=a):(u=r,p=s),(0,k.projectBuffer)(u,l.spatialReference,p,n,c.spatialReference,a,o)?f:void 0}function Ft(e,t,i,r,s){const n=(At(e)?e.z:Ot(e)?e.array[e.offset+2]:e[2])||0;switch(i.mode){case"on-the-ground":{const i=Pt(t,e,"ground")??0;return s.verticalDistanceToGround=0,s.sampledElevation=i,void(s.z=i)}case"relative-to-ground":{const a=Pt(t,e,"ground")??0,o=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=o,s.sampledElevation=a,void(s.z=o+a)}case"relative-to-scene":{const a=Pt(t,e,"scene")??0,o=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=o,s.sampledElevation=a,void(s.z=o+a)}case"absolute-height":{const a=i.geometryZWithOffset(n,r),o=Pt(t,e,"ground")??0;return s.verticalDistanceToGround=a-o,s.sampledElevation=o,void(s.z=a)}default:return void(s.z=0)}}function Lt(e,t,i,r){return Ft(e,t,i,r,Wt),Wt.z}function Nt(e,t,i){return null==t||null==i?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===i?e.staysOnTheGround:t===i||"on-the-ground"!==t&&"on-the-ground"!==i?Mt.UPDATE:e.onTheGroundChanged}function Vt(e){return"relative-to-ground"===e||"relative-to-scene"===e}function Gt(e){return"absolute-height"!==e}function Ut(e,t,i,r,s){Ft(t,i,s,r,Wt),zt(e,Wt.verticalDistanceToGround);const n=Wt.sampledElevation,a=(0,O.C)(jt,e.transformation);return kt[0]=t.x,kt[1]=t.y,kt[2]=Wt.z,(0,Et.l)(t.spatialReference,kt,a,r.spatialReference)?e.transformation=a:console.warn("Could not locate symbol object properly, it might be misplaced"),n}function zt(e,t){for(let i=0;i<e.geometries.length;++i){const r=e.geometries[i].getMutableAttribute(It.r.CENTEROFFSETANDDISTANCE);r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[i],It.r.CENTEROFFSETANDDISTANCE))}}class Bt{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(Mt||(Mt={}));const Ht={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,i,r,s,n,a,o){const l=o.calculateOffsetRenderUnits(a),c=o.featureExpressionInfoContext;t*=3,r*=3;for(let n=0;n<s;++n){const s=e[t],n=e[t+1],a=e[t+2];i[r]=s,i[r+1]=n,i[r+2]=null==c?a+l:l,t+=3,r+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,i=e.featureExpressionInfoContext;return 0!==t||null!=i}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,i,r,s,n){let a=0;const o=n.spatialReference;t*=3,r*=3;for(let l=0;l<s;++l){const s=e[t],l=e[t+1],c=e[t+2],h=n.getElevation(s,l,c,o,"ground")??0;a+=h,i[r]=s,i[r+1]=l,i[r+2]=h,t+=3,r+=3}return a/s},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,i,r,s,n,a,o){let l=0;const c=o.calculateOffsetRenderUnits(a),h=o.featureExpressionInfoContext,d=n.spatialReference;t*=3,r*=3;for(let a=0;a<s;++a){const s=e[t],a=e[t+1],o=e[t+2],u=n.getElevation(s,a,o,d,"ground")??0;l+=u,i[r]=s,i[r+1]=a,i[r+2]=null==h?o+u+c:u+c,t+=3,r+=3}return l/s},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,i,r,s,n,a,o){let l=0;const c=o.calculateOffsetRenderUnits(a),h=o.featureExpressionInfoContext,d=n.spatialReference;t*=3,r*=3;for(let a=0;a<s;++a){const s=e[t],a=e[t+1],o=e[t+2],u=n.getElevation(s,a,o,d,"scene")??0;l+=u,i[r]=s,i[r+1]=a,i[r+2]=null==h?o+u+c:u+c,t+=3,r+=3}return l/s},requiresAlignment:()=>!0}},jt=(0,P.vt)(),Wt=new Bt,kt=(0,I.vt)();i(3313);var Zt=i(56053),qt=i(44153);function $t(e){return"declaredClass"in e}function Qt(e){return"declaredClass"in e}function Jt(e,t){return e?function(e){return"declaredClass"in e}(e)?e:new v.A({layer:t,sourceLayer:t,visible:e.visible,symbol:(0,ut.o8)(e.symbol),attributes:(0,ut.o8)(e.attributes),geometry:Yt(e.geometry)}):null}function Yt(e){return null==e?null:$t(e)?e:(0,Zt.rS)(function(e){const{wkid:t,wkt:i,wkt2:r,latestWkid:s}=e.spatialReference,n={wkid:t,wkt:i,wkt2:r,latestWkid:s};switch(e.type){case"point":{const{x:t,y:i,z:r,m:s}=e;return{x:t,y:i,z:r,m:s,spatialReference:n}}case"polygon":{const{rings:t,hasZ:i,hasM:r}=e;return{rings:Xt(t),hasZ:i,hasM:r,spatialReference:n}}case"polyline":{const{paths:t,hasZ:i,hasM:r}=e;return{paths:Xt(t),hasZ:i,hasM:r,spatialReference:n}}case"extent":{const{xmin:t,xmax:i,ymin:r,ymax:s,zmin:a,zmax:o,mmin:l,mmax:c,hasZ:h,hasM:d}=e;return{xmin:t,xmax:i,ymin:r,ymax:s,zmin:a,zmax:o,mmin:l,mmax:c,hasZ:h,hasM:d,spatialReference:n}}case"multipoint":{const{points:t,hasZ:i,hasM:r}=e;return{points:ei(t)?Kt(t):t,hasZ:i,hasM:r,spatialReference:n}}default:return}}(e))}function Xt(e){return function(e){for(const t of e)if(0!==t.length)return ei(t);return!1}(e)?e.map((e=>Kt(e))):e}function Kt(e){return e.map((e=>Array.from(e)))}function ei(e){return e.length>0&&((0,R.vZ)(e[0])||(0,R.aI)(e[0]))}var ti=i(83911);async function ii(e,t,i,r){const s=e?.expression;if("string"!=typeof s)return null;const n=li(s);if(null!=n)return{cachedResult:n};const a=await(0,ti.lw)();(0,o.Te)(i);const l=a.arcadeUtils,c=l.createSyntaxTree(s);return l.dependsOnView(c)?(null!=r&&r.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:l.createFunction(c),context:l.createExecContext(null,{sr:t}),modules:a}}}function ri(e,t,i){return e.arcadeUtils.createFeature(t.attributes,t.geometry,i)}function si(e,t){if(null!=e&&!oi(e)){if(!t||!e.arcade)return void a.A.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils").errorOncePerTick("Arcade support required but not provided");const i=t;i._geometry&&(i._geometry=Yt(i._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function ni(e,t=!1){let i=e?.featureExpressionInfo;const r=i?.expression;return t||"0"===r||(i=null),i??null}const ai={cachedResult:0};function oi(e){return null!=e.cachedResult}function li(e){return"0"===e?0:null}class ci{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=(0,_.Ao)(e)}get requiresSampledElevationInfo(){return"absolute-height"!==this.mode}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const i=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?i:e+i}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return null!=i&&(t+=function(e){if(null!=e){if(oi(e))return e.cachedResult;const t=e.arcade;let i=t?.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof i&&(e.cachedResult=0,i=0),i}return 0}(i)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=(0,_.Tg)(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=e.offset??0}updateFeatureExpressionInfoContext(e,t,i){if(null==e)return void(this._featureExpressionInfoContext=null);const r=e?.arcade;r&&null!=t&&null!=i?(this._featureExpressionInfoContext=function(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}(e),si(this._featureExpressionInfoContext,ri(r.modules,t,i))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const t=new ci;return null!=e&&t.setFromElevationInfo(e),t}}const hi=1e5;class di{constructor(e,t,i,r,s,n,a,o,l={}){this._indexSR=e,this._renderCoordsHelper=t,this._clippingArea=s,this._elevationProvider=n,this._viewingMode=a,this._options=l,this._frustum=(0,Rt.vt)(),this._frustumMbs=(0,F.vt)(),this._useFrustumCulling=!1,this._poi=(0,I.vt)(),this._elevationContext=null,this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=new Ne.ab,this._tmp1=(0,I.vt)(),this._tmp2=(0,I.vt)(),this._tmp3=(0,I.vt)(),this._tmp0=(0,I.vt)(),this._screenspaceErrorBias=l.screenspaceErrorBias||1,this._progressiveLoadFactor=l.progressiveLoadFactor||1,this.updateCamera(i,r);const c=this._renderCoordsHelper.spatialReference;this._renderSR=c,this._renderSRSphericalPCPF=(0,Ct.lO)(c),this._isGlobalMode=c===this._renderSRSphericalPCPF,this.updateElevationInfo(o),this._tmpPoint=(0,ne.T)(0,0,0,e),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(c.isWebMercator||(0,G.r1)(c)),this._indexSREllipsoidRadius=(0,wt.tO)(this._indexSR).radius,this._indexSRSphericalPCPF=(0,Ct.lO)(e),this._projectorIndexSRToIndexSRSphericalPCPF=(0,N.jd)(this._indexSR,this._indexSRSphericalPCPF)}updateElevationInfo(e){null!=e?(this._elevationContext=ci.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(function(e){const t=e?.expression;if("string"==typeof t){const e=li(t);if(null!=e)return{cachedResult:e}}return null}(ni(e,!1)))):this._elevationContext=null}updateCamera(e,t){if(this._useFrustumCulling=t,t){(0,Rt.ui)(e.viewMatrix,e.projectionMatrix,this._frustum,pi);{const t=e.eye,i=ui;(0,M.n)(i,e.viewForward);const r=fi;(0,M.y)(r,pi[4],t);const s=.5*(0,M.j)(r,r)/(0,M.j)(i,r),n=this._frustumMbs;(0,M.q)(n,t,i,s);const a=1+s;n[3]=a}}this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(e){this._poi=e}updateScreenSpaceErrorBias(e){const t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}updateClippingArea(e){this._clippingArea=e}expandElevationRange(e,t,i){if(null==this._elevationContext)return;const r=e.serviceMbsInIndexSR;if(!r)return;const s="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds){const e=this._elevationProvider.getSphereElevationBounds(r,this._indexSR,s);return void(e&&i.expandElevationRange(e))}const n=r[0],a=r[1],o=r[2],l=this._elevationProvider.getElevation(n,a,o,this._indexSR,s);l&&i.expandElevationRangeValues(l,l);const c=t?null:this._elevationProvider.getRootElevationBounds?.();c&&i.expandElevationRange(c)}getServiceMbsInRenderSR(e){const t=e.serviceMbsInRenderSR;if((0,De.hB)(t))return t;e.serviceMbsInIndexSR&&(0,D.c)(t,e.serviceMbsInIndexSR);const i=e.elevationRangeMin;if(this._elevationContext&&Number.isFinite(i)){let r=0,s=0;const n=e.elevationRangeMax;switch(this._elevationContext.mode){case"relative-to-ground":r=this._elevationContext.geometryZWithOffset(t[2],this._renderCoordsHelper)+i-t[2],s=n-i;break;case"on-the-ground":r=i-t[2],s=n-i}t[2]+=r+.5*s,t[3]+=.5*s}else this._elevationContext&&t[3]<hi&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=Lt(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper));return z(t,this._indexSR,t,this._renderSR),t}getAndUpdateVisibilityObbInRenderSR(e){{const t=e.visibilityObbInRenderSR;if(t)return t}const t=.01*this._indexSREllipsoidRadius,{serviceMbsInIndexSR:i,serviceObbInIndexSR:r}=e;if(null==r||!i||!r.isValid||this._isECEFOBBInLocalMode&&(r.halfSizeX>t||r.halfSizeY>t||r.halfSizeZ>t))return null;{let t=e.serviceObbInRenderSR;if(null==t)t=new Ne.ab,e.serviceObbInRenderSR=t;else if(t.isValid)return t;const s=i[3];let n=0,a=0;const o=r.centerZ,l=this._renderCoordsHelper,c=this._elevationContext;if(c&&e.elevationRangeValid){const t=e.elevationRangeMin,i=e.elevationRangeMax;switch(c.mode){case"relative-to-ground":n=c.geometryZWithOffset(o,l)+t-o,a=i-t;break;case"on-the-ground":n=t-o,a=i-t}}else if(c&&s<hi){const e=this._tmpPoint;e.x=r.centerX,e.y=r.centerY,e.z=o,n=Lt(e,this._elevationProvider,c,l)-o}const h=a>0,d=h?this._tmpObb:t;return r.transform(d,this._indexSR,this._renderSR,n,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),h&&(0,Ne.gm)(d,0,a,this._viewingMode,t),t}}getNodeObbInRenderSRIndependentOfElevationOffset(e){{const t=e.visibilityObbInRenderSR??e.serviceObbInRenderSR??null;if(t?.isValid)return t}const t=e.serviceObbInIndexSR;return t?(t.transform(mi,this._indexSR,this._renderSR,void 0,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),mi):null}ensureElevationAgnosticBoundingVolume(e,t){-1===e.elevationAgnosticBoundingVolume[3]&&(t===oe.RT.Global?this._updateElevationAgnosticBoundingVolumeGlobal(e):this._updateElevationAgnosticBoundingVolumeLocal(e))}_updateElevationAgnosticBoundingVolumeGlobal(e){const t=this.getNodeObbInRenderSRIndependentOfElevationOffset(e),i=e.elevationAgnosticBoundingVolume,r=_i;let s=-1;if(t){t.getCenter(r),(0,M.n)(r,r),t.getCorners(yi);for(const e of yi){(0,M.n)(e,e);const t=(0,M.j)(e,r);if(t<=0)return void(i[3]=-1);const n=Math.sqrt(1-t*t);s=Math.max(s,n)}}else{const t=e.serviceMbsInRenderSR;if(!(0,De.hB)(t))return void(i[3]=-1);{const e=(0,M.c)(_i,(0,X.g)(t)),i=t[3],r=(0,M.C)(e);s=0===i?0:r<i?-1:i/r,(0,M.n)(e,e)}}(0,D.b)(i,r),i[3]=s+.001}_updateElevationAgnosticBoundingVolumeLocal(e){const t=e.elevationAgnosticBoundingVolume,i=this.getNodeObbInRenderSRIndependentOfElevationOffset(e);if(i){const e=i.getCenter(_i);e[2]=0,(0,D.b)(t,e);let r=0;const s=vi;i.getCorners(yi);for(const e of yi){e[2]=0;const t=(0,M.v)(s,e);r=Math.max(r,t)}t[3]=Math.sqrt(r)}else{const i=e.serviceMbsInRenderSR;if((0,De.hB)(i)){const e=(0,M.c)(_i,(0,X.g)(i));e[2]=0,(0,D.b)(t,e),t[3]=i[3]}}}isNodeVisible(e){const t=this.getServiceMbsInRenderSR(e);if(!this._isMBSinClippingArea(t))return!1;if(!this._useFrustumCulling)return!0;const i=this.getAndUpdateVisibilityObbInRenderSR(e);return i?i.isVisible(this._frustum):(0,Rt.m7)(this._frustum,(0,X.w)(t))}isElevationAgnosticBoundingVolumeVisible(e,t){return!this._useFrustumCulling||-1===t[3]||(e===oe.RT.Global?this._isConeVisibleInFrustum(t):this._isCylinderVisibleInFrustum(t))}_isConeVisibleInFrustum(e){const t=this._frustumMbs,i=t,r=(0,M.C)(i),s=t[3],n=e,a=(0,M.j)(n,i),o=e[3];if(o>.9)return!0;if(r<=s)return!0;{const e=(0,M.h)(gi,n,a);if((0,M.m)(e,i)<s)return!0}const l=a/r;if(a<=0)return-l<s;const c=Math.sqrt(1-l*l);if(c<o)return!0;const h=s/r;return c*Math.sqrt(1-h*h)-h*l<o}_isCylinderVisibleInFrustum(e){const t=this._frustumMbs,i=t,r=t[3],s=(0,M.c)(gi,i);s[2]=0;const n=e[3];return(0,M.m)(s,e)<=n+r}isGeometryVisible(e){if(!this._useFrustumCulling)return!0;const t=e.geometryObbInRenderSR;return t?.isVisible(this._frustum)??this.isNodeVisible(e)}_isMBSinClippingArea(e){return null==this._clippingArea||(0,De.aM)(this._clippingArea,e)!==De.JA.OUTSIDE}_screenSpaceDiameterMbs(e,t){const i=this.getServiceMbsInRenderSR(e),r=Math.sqrt((0,M.a)((0,X.g)(i),this._camPos)),s=r-i[3];return this._updateMinMaxDistance(r),s<0?.5*Number.MAX_VALUE:t/s*this._screenSizeFactor}calcCameraDistance(e){return this.calcCameraDistanceToCenter(e)-this.getServiceMbsInRenderSR(e)[3]}calcCameraDistanceToCenter(e){const t=this.getServiceMbsInRenderSR(e),i=(0,M.p)((0,X.g)(t),this._camPos);return this._updateMinMaxDistance(i),i}calcAngleDependentLoD(e){const t=this.getServiceMbsInRenderSR(e),i=t[3],r=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/(0,M.l)((0,X.g)(t))+i)/(0,M.p)((0,X.g)(t),this._camPos);return Math.min(1,r)}hasLOD(e){return e.lodMetric!==Ie.cJ.None}_getDistancePlanarMode(e,t){const i=e[0]-t[0],r=e[1]-t[1],s=e[2]-t[2],n=i*i+r*r,a=t[3];if(n<=a*a)return Math.abs(s);const o=Math.sqrt(n)-a;return Math.sqrt(s*s+o*o)}_getDistanceGlobeMode(e,t){const i=(0,M.l)((0,X.g)(t)),r=(0,M.l)(e)-i;(0,M.h)(this._tmp0,e,(0,M.j)(e,(0,X.g)(t))/(0,M.o)(e));const s=(0,M.a)((0,X.g)(t),this._tmp0),n=t[3];if(s<=n*n)return Math.abs(r);{const s=(0,M.h)(this._tmp0,(0,X.g)(t),1/i),a=i,o=n*n/2/a,l=(0,M.h)(this._tmp1,s,a-o),c=e,h=(0,M.f)(this._tmp2,c,l),d=(0,M.f)(this._tmp2,h,(0,M.h)(this._tmp3,s,(0,M.j)(s,h))),u=(0,M.g)(this._tmp2,l,(0,M.h)(this._tmp2,d,n/(0,M.l)(d)));let p=(0,M.p)(c,u);if(r>=2e5){const e=(0,M.f)(this._tmp1,c,u);let t=(0,M.j)(e,s)/(0,M.l)(e);t<.08&&(t=1e-4),p/=t}return p}}_getDistance(e,t){return this._isGlobalMode?this._getDistanceGlobeMode(e,t):this._getDistancePlanarMode(e,t)}_updateMinMaxDistance(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}getLodLevel(e){if(e.lodMetric===Ie.cJ.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const t=this._progressiveLoadFactor*this._screenspaceErrorBias,i=this._screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(e,t){switch(e.lodMetric){case Ie.cJ.ScreenSpaceRelative:{const i=this.getServiceMbsInRenderSR(e),r=this._getDistance(this._camPos,i),s=2*r/this._screenSizeFactor,n=r+i[3];return this._updateMinMaxDistance(n),e.maxError*t<=s}case Ie.cJ.MaxScreenThreshold:{let i=this._screenSpaceDiameterMbs(e,e.serviceMbsInIndexSR[3]*t);return this._options.angleDependentLoD&&(i*=this.calcAngleDependentLoD(e)),i<e.maxError}case Ie.cJ.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case Ie.cJ.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return!1}distToPOI(e){const t=this.getServiceMbsInRenderSR(e);return(0,M.p)((0,X.g)(t),this._poi)-t[3]}distCameraToPOI(){return(0,M.p)(this._camPos,this._poi)}}const ui=(0,I.vt)(),pi=(0,Rt.Qy)(),fi=(0,I.vt)(),gi=(0,I.vt)(),mi=new Ne.ab,_i=(0,I.vt)(),yi=[(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)()],vi=(0,I.vt)();function bi(e,t,i){if(null==e||null==i)return!1;let r=!0;return xi[0]=null!=e.xmin?e.xmin:0,xi[1]=null!=e.ymin?e.ymin:0,xi[2]=null!=e.zmin?e.zmin:0,r=r&&(0,k.projectBuffer)(xi,e.spatialReference,0,xi,i,0,1),t[0]=xi[0],t[1]=xi[1],xi[0]=null!=e.xmax?e.xmax:0,xi[1]=null!=e.ymax?e.ymax:0,xi[2]=null!=e.zmax?e.zmax:0,r=r&&(0,k.projectBuffer)(xi,e.spatialReference,0,xi,i,0,1),t[2]=xi[0],t[3]=xi[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),r}const xi=(0,I.vt)();var Si,wi;(wi=Si||(Si={}))[wi.ELEVATION=0]="ELEVATION",wi[wi.BASEMAP=1]="BASEMAP",wi[wi.I3S_INDEX=2]="I3S_INDEX",wi[wi.I3S_DATA=3]="I3S_DATA",wi[wi.SYMBOLOGY=4]="SYMBOLOGY",(()=>{const e=new Array;e[Si.ELEVATION]=10,e[Si.BASEMAP]=10,e[Si.I3S_INDEX]=10,e[Si.I3S_DATA]=10,e[Si.SYMBOLOGY]=5})();let Ci=class extends n.A{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new he.F,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles((0,c.mg)({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){null!=e&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t){return new he.Mn(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._usedMemory>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>.1&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,.1),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){if(!this.view)return;this.view._stage?.renderer?.tick();const e=this.view._stage?.renderer?.usedMemory;let t=(this.view.basemapTerrain?.usedMemory??0)+(e?e.fbos+e.edges+e.plugins:0),i=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((e=>{if(function(e){return"usedMemory"in e&&"unloadedMemory"in e&&"ignoresMemoryFactor"in e}(e)){const r=e.ignoresMemoryFactor?this._quality:1;t+=e.usedMemory*r,i+=e.unloadedMemory*r}}));const r=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),s=1048576*this.maxMemory;if(t>s&&r){this._warnMemoryUsage=t;const e=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",r=Math.round(100*this._quality);a.A.getLogger(this).warn(`Memory Limit exceeded! Limit: ${e(s)} Current: ${e(t)} Projected: ${e(t+i)} Quality: ${r}%`)}this._usedMemory=t/s,this._memoryPredicted=(t+i)/s;const n=s-t;this._cacheStorage.maxSize=Math.max(0,n+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t},disableMemCache:()=>e.disableMemCache()}}};(0,r._)([(0,h.MZ)({constructOnly:!0})],Ci.prototype,"view",void 0),(0,r._)([(0,h.MZ)()],Ci.prototype,"maxMemory",null),(0,r._)([(0,h.MZ)()],Ci.prototype,"additionalCacheMemory",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ci.prototype,"memoryFactor",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ci.prototype,"updating",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ci.prototype,"usedMemory",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ci.prototype,"usedCacheMemory",null),(0,r._)([(0,h.MZ)()],Ci.prototype,"_quality",void 0),(0,r._)([(0,h.MZ)()],Ci.prototype,"_usedMemory",void 0),(0,r._)([(0,h.MZ)()],Ci.prototype,"_updating",void 0),(0,r._)([(0,h.MZ)()],Ci.prototype,"_stableQuality",void 0),(0,r._)([(0,h.MZ)()],Ci.prototype,"_maxMemory",void 0),(0,r._)([(0,h.MZ)()],Ci.prototype,"_additionalCacheMemory",void 0),Ci=(0,r._)([(0,u.$)("esri.views.3d.support.MemoryController")],Ci);var Ri=i(96383);const Ei=1e-4;let Ai=class extends((0,K.g)(n.A)){get isMeshPyramid(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store?.lodType}get isGraphics3D(){return"points"===this.layer.profile}get useMaximumNumberOfFeatures(){return!this.isMeshPyramid&&(null==this.layer.priority||"High"===this.layer.priority)}get indexStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(Si.I3S_INDEX);return new St(e,this.layer.customParameters,this.layer.apiKey)}get dataStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(Si.I3S_DATA);return new St(e,this.layer.customParameters,this.layer.apiKey)}get crsVertex(){return(0,De.Dd)(this.layer)}get crsIndex(){return(0,De.Rm)(this.layer)}get layer(){return this.layerView.i3slayer}get running(){return this.updating}get rootNodeVisible(){if(this._index){const e=this._index.rootNode;if(e)return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}get index(){return this._index}get requiredAttributes(){return this._requiredAttributes}constructor(e){super(e),this.screenSizeFactor=0,this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.scaleVisibilityEnabled=!0,this.worker=null,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._idleStateCallbacks=null,this._newLoadingNodes=new C.A({deallocator:null}),this._loadedNodeScales=new Map,this._modificationsNodeFilteringArray=new C.A,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._idleQueue=new ae.T,this._elevationUpdateNodes=new C.A({deallocator:null}),this._errorCount=0}initialize(){const{layerView:e,layer:t}=this;this._disableMemCache=!e.loadCachedGPUData||!e.addCachedGPUData,this._lodHandling=new ot(e),this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=(0,d.A)("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo),this.addResolvingPromise(Promise.all([t.indexInfo,t.when(),e.when()]).then((([i])=>{if(this.destroyed||!e||e.destroyed||!i)return;const{view:r,clientGeometry:s}=e,{resourceController:n}=r;if(this._setClippingArea(r.clippingArea),this.addHandles([(0,l.wB)((()=>r?.pointsOfInterest?.focus?.renderLocation),(e=>this._pointOfInterestChanged(e)),l.Vh),(0,l.wB)((()=>r.quality),(()=>this._setCameraDirty()),l.OH),(0,l.wB)((()=>e.contentVisible),(e=>{const t=e?()=>this._updateIdleState(!0):()=>this._updateViewData(),i=e?()=>this._updateIdleState(!1):()=>{};e&&null!=this._index&&this._index.invalidateAllElevationRanges(),this._idleStateCallbacks?(e||this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=t,this._idleStateCallbacks.idleEnd=i):this._idleStateCallbacks=n.scheduler.registerIdleStateCallbacks(t,i)}),l.Vh),Pe(e.view.resourceController.scheduler,this),(0,l.wB)((()=>e.uncompressedTextureDownsamplingEnabled),(()=>this.restartNodeLoading())),(0,l.wB)((()=>[this.featureTarget,this.fixedFeatureTarget]),(()=>{this._setCameraDirty(),this._stableFeatureLOD=!1})),(0,l.wB)((()=>r.state?.contentCamera),(()=>this._setCameraDirty())),(0,l.wB)((()=>t.elevationInfo),(e=>this._elevationInfoChanged(e))),(0,l.wB)((()=>t.effectiveScaleRange),(()=>this._scaleBoundsChanged())),(0,l.wB)((()=>e.lodFactor),(()=>this._setCameraDirty())),(0,l.wB)((()=>e.availableFields),(()=>this._requiredFieldsChange())),(0,l.wB)((()=>e.holeFilling),(e=>null!=this._index&&(this._index.holeFilling=e)))]),this._updateScaleHandles(),this._viewportQueries=new di(this.crsIndex,r.renderCoordsHelper,r.state.contentCamera,!r.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,this.isMeshPyramid?r.basemapTerrain:r.elevationProvider,(0,oe.yX)(r.viewingMode),this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this._lod,angleDependentLoD:this._lod<.5}),this._clientNodeLoader=new ve(this.layer.uid,{indexSR:this.crsIndex,vertexSR:this.crsVertex,renderSR:r.renderCoordsHelper.spatialReference,localMode:"local"===r.viewingMode},r.resourceController.memoryController,this.worker),this._index=new Ue((0,oe.yX)(r.viewingMode),t,i,this.indexStreamController,this._clientNodeLoader,this._viewportQueries,a.A.getLogger(this),e.holeFilling,(t=>e.isNodeLoaded(t)),(t=>e.isNodeReloading(t)),(e=>this._shouldLoadNode(e)),(e=>this._enableFromGPUCache(e,Ie.UY.Leaf)),(e=>this._needsUpdate(e)),(()=>!this.indexStreamController.busy),(t=>e.computeVisibilityObb?.(t)??null),e?.computeNodeFiltering?t=>e.computeNodeFiltering(t):void 0),this._index.updateElevationInfo(this.layer.elevationInfo,this.isMeshPyramid||this.isGraphics3D),this._index.imModificationsChanged(!!e.hasModifications),this._index.layerFilterChanged(!!e.hasGeometryFilter),null!=s){for(const e of s)this._addMesh(e.mesh,e.oid);this.addHandles(s.on("change",(e=>{for(const t of e.removed)this._removeMesh(t.oid);for(const t of e.added)this._addMesh(t.mesh,t.oid)})))}this._startNodeLoading()}))),this._tmpPoint=(0,ne.T)(0,0,0,this.crsIndex)}updateNodeModificationStatus(e){const t=this._index,i=this.layerView;null!=t&&i?.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),e.forAll((e=>{const i=t.getNode(e);null!=i&&this._modificationsNodeFilteringArray.push(i)})),i.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._nodeLoader=null,Ti.prune(),null!=Oi&&(Oi.hide(),Oi=null)}get viewportQueries(){return this._viewportQueries}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((i=>{const r=Mi(e,i),s=Mi(t,i);return r>=0&&s>=0?{index:r,name:t[s].name,field:t[s],attributeStorageInfo:e[r]}:null})).filter((e=>null!=e&&e.name!==i))}_requiredFieldsChange(){const e=this._getRequiredAttributes();Pi(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}_setClippingArea(e){const t=(0,$.vt)();bi(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}_pointOfInterestChanged(e){null!=this._viewportQueries&&(this._viewportQueries.setPointOfInterest(e),null!=this._index&&(this._index.progressiveLoadPenalty=Ii.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(e){this._setClippingArea(e),null!=this._viewportQueries&&null!=this._index&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}_addMesh(e,t){if(null==this._index)return;const i=this._clientNodeLoader.createMeshNodeInfo(e,t),r=this._index.addClientNodeToIndex(i.id,i.mbs);this._clientNodeLoader.addMeshNode(r,i),this._evaluateUpdating(),this.notifyChange("rootNodeVisible")}_removeMesh(e){const t=this._clientNodeLoader.getMeshNodeIndex(e);if(null!=t){if(null==this._index)throw new Error("delayed removal of client side i3s node geometry not supported yet.");{const e=(e,t)=>{this.layerView.removeNode(t),this._loadedNodeScales.delete(t),this._clientNodeLoader.removeNode(e),this.layerView.deleteCachedNodeData&&null!=e&&this.layerView.deleteCachedNodeData(e),this.layerView.deleteCachedGPUData?.(this.layerView.loadCachedGPUData?.(t))},i=(e,t,i)=>{this._clientNodeLoader.updateNodeIndex(e,t,i),this.layerView.updateNodeIndex&&this.layerView.updateNodeIndex(t,i)};this._index.removeClientNodeFromIndex(t,e,i),this.notifyChange("rootNodeVisible")}}}updateElevationChanged(e,t){const i=this._index;if(null==i?.rootNode||null==t)return null;this.crsIndex.equals(t)||(ee(e,t,Di,this.crsIndex),e=Di);const r=this._elevationUpdateNodes;return r.clear(),(0,De.II)(e,i.rootNode,i,(e=>r.push(e.index))),r.length&&(r.forAll((e=>i.updateElevationChanged(e))),this._setCameraDirty()),r}removeAllGeometryObbs(){null!=this._index&&this._index.removeAllGeometryObbs()}getRenderMbs(e){return null!=this._viewportQueries?this._viewportQueries.getServiceMbsInRenderSR(e):null}_elevationInfoChanged(e){null!=this._index&&(this._index.updateElevationInfo(e,this.isMeshPyramid||this.isGraphics3D),this._setCameraDirty())}_updateScaleHandles(){const e="scale-bounds";this.removeHandles(e),this._areScaleBoundsActive&&this.addHandles(this.layerView.view.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),e)}_scaleBoundsChanged(){this._areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}_scaleUpdateHandler(e){this._updateScaleInBoundingRect(e.extent,e.spatialReference),this._setCameraDirty()}_updateScaleInBoundingRect(e,t){const i=this._index;null!=i&&null!=i.rootNode&&ee(e,t,Di,this.crsIndex)&&this._loadedNodeScales.forEach(((e,t)=>{const r=i.getNode(t);null!=r&&(0,$.m7)(Di,r.serviceMbsInIndexSR)&&this._loadedNodeScales.set(t,this._computeScale(r))}))}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}schedule(e,t){return this._idleQueue.push(e,t)}reschedule(e,t){return this._idleQueue.unshift(e,t)}get _isIntegratedMesh(){return"integrated-mesh"===this.layer.type}get _areScaleBoundsActive(){const{minScale:e,maxScale:t}=(0,Ri.Cf)(this.layer);return this.scaleVisibilityEnabled&&(e>0||t>0)}get unloadedMemoryEstimate(){return null!=this._index&&this.layerView.contentVisible?this._index.unloadedMemoryEstimate*this._lodDropFactor:0}async _loadNodeData(e,t){return e.index<0?this._clientNodeLoader.loadNodeData(e.id,t):this._nodeLoader.loadNodeData(e,t)}async _loadAttributes(e,t,i){return(e.index<0?this._clientNodeLoader:this._nodeLoader).loadAttributes(e,t,i)}get indexDepth(){return null!=this._index?this._index.maxLevel:0}set disableMemCache(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData?this._disableMemCache=e:this._disableMemCache=!0}runTask(e,t){return this.layerView.contentVisible?this.layerView.visible&&null!=this._index?(this._processWithErrorLogging(e,t),this._index.maxPriority):-1/0:(this._updateViewData(),this._evaluateUpdating(),-1/0)}_processWithErrorLogging(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?a.A.getLogger(this).error(`Error during processing: ${e} at ${e.stack}`):50===this._errorCount&&a.A.getLogger(this).error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}_process(e,t){this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&null!=this._index&&(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this._isIntegratedMesh&&(e.enabled=!1),e.run((()=>this._processIndex(e))),this._updateFeatureLOD(),e.run((()=>this._processCache(e))),this._isIntegratedMesh&&(e.enabled=!0),e.run((()=>this._processNodes(e,t))),this._idleQueue.runTask(e),e.run((()=>this._prefetchIndex())),t.numIndexLoading+=this._index.indexLoading,t.numNodesLoading+=this._downloadingCount,e.run((()=>this._lodHandling.lodGlobalHandling(e))),this._evaluateUpdating())}_processIndex(e){if(null==this._index)return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),e,(e=>this.updateNodeModificationStatus(e))),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const t=this._index.featureEstimate.leavesReached;this._index.isLoading||t===this._get("leavesReached")||this._set("leavesReached",t)}return this._index.load()}_prefetchIndex(){return!(null==this._index||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.useMaximumNumberOfFeatures||null==this._index||null==this._viewportQueries)return;const e=!this._index.isLoading,t=this.featureTarget*this._baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||t/2,this._index.indexMissing>500){if(this._featureLOD<=Ei)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;const e=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=e;const r=this._lod,s=this._index.checkFeatureTarget(t,r);s!==r&&(this._featureLOD=s/this._baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=Ei)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Ei,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.requestUpdate()}_processCache(e){const t=this._index;if(null==t)return!1;for(;this._newLoadingNodes.length>0&&!e.done;){const i=this._newLoadingNodes.pop();for(let r=t.getParent(i);null!=r&&!this.layerView.isNodeLoaded(r.index)&&this._isNodeInScaleBounds(r);r=t.getParent(r.index))if(this._enableFromGPUCache(r,Ie.UY.Hole)){e.madeProgress();break}}return e.hasProgressed}_processNodes(e,t){if(null==this._index)return!1;let i=(this._isIdle?100:2)-this._loadingNodes.size;const r=this._index.updates;for(r.cancel.forEach(this._cancelNode,this),r.cancel=[];r.remove.length>0&&!e.done;)this.layerView.removeNode(r.remove.pop()),e.madeProgress();for(;r.update.length>0&&!e.done;){const t=this._index.getNode(r.update.pop());null!=t&&(this._updateLoadedNode(t),e.madeProgress())}for(;r.add.length>0&&!e.done&&i>0;){--i;const s=this._index.getNode(r.add.back());if(null==s||s.cacheState!==Ie.iF.Cached&&!this._hasNodeLoadToken(t))break;r.add.pop(),this._loadNode(s),e.madeProgress()}return e.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach((e=>e.abort())),this._loadingNodes.clear(),this._updatingNodes.forEach((e=>e.abort())),this._updatingNodes.clear()}_cancelNode(e){const t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}_hasNodeLoadToken(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<30&&!this.dataStreamController.busy}_evaluateUpdating(){let e=!1,t=0;if(this.layerView){if(this.layerView.contentVisible){const i=(null!=this._index?this._index.indexMissing:0)+3*(null!=this._index?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling||null!=this._index&&this._index.isPrefetching),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),t=1-i/this._progressMaxNumNodes}else e=this._cameraDirty,t=e?0:1;this.updating=e,this.updatingProgress=t}}_updateViewData(){if(!this._cameraDirty||null==this._index||null==this._viewportQueries)return;const e=this.layerView.view,{contentCamera:t,fixedContentCamera:i}=e.state;this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._viewportQueries.updateCamera(t,!i||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=Ii.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}_getProgressiveLoadFactor(){return this.layerView.view.quality<1?1:this.layerView.progressiveLoadFactor}get _lod(){return this._featureLOD*this._baseLOD}get _baseLOD(){const e=this.layerView.lodFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*this.layerView.view.quality}get _lodDropFactor(){return this.fixedFeatureTarget?1:(Math.min(this.layerView.view.quality,.5)-.1)/.4}isGeometryVisible(e){return!!this._index?.isGeometryVisible(e.index)}updateVisibility(e){this._index?.invalidateNodeVisibilityCache(e)}invalidateGeometryVisibility(e){this._index?.invalidateGeometryVisibility(e)}invalidateVisibilityObbs(){this._index?.invalidateVisibilityObbs()}modificationsChanged(){this._index?.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}_shouldLoadNode(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e))&&!(null==this._index||!this._index.isGeometryVisible(e.index))&&this._isNodeInScaleBounds(e)}_shouldDropNode(e){if(null==this._viewportQueries)return!1;const t=this._lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}_startNodeLoading(){this._restartNodeLoading=!1;const e=this._index;if(this._updatesDisabled||null==e||null==this._viewportQueries)return;this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);const t={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures};this._nodeLoader=new xt(this.layer,this.dataStreamController,a.A.getLogger(this),this._defaultGeometrySchema,this._requiredAttributes,t),e.requestUpdate(),this._lodHandling.startNodeLoading((e=>this._isNodeInScaleBounds(e)),((e,t)=>this._removeNodes(e,t,Fi.fadeout)),e,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(e){const t=this._index;if(null==t||null==this._viewportQueries)return!1;Ti.clear(),this.layerView.getLoadedNodeIndices(Ti);const i=0===this._viewportQueries.maxDistance,r=i?()=>!1:e=>this._shouldDropNode(e);return Ti.filterInPlace((e=>{const i=t.getNode(e);return null==i||!t.isGeometryVisible(e)||r(i)||!this._isNodeInScaleBounds(i)})),Ti.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(Ti,e,Fi.pop),!(i&&this._lodDropFactor<1||0!==Ti.length&&(Ti.clear(),1))}markNodeToRemove(e){Ti.push(e)}removeMarkedNodes(){this._removeNodes(Ti,Ee.Bb,Fi.pop)}_removeNodes(e,t,i){const r=e.length;if(0!==r&&!t.done){for(null!=this._index&&this._index.requestUpdate();e.length>0&&!t.done;){const r=e.pop(),s=this._index;i===Fi.fadeout&&this.layerView.nodeFadeoutEnabled&&null!=s&&s.isGeometryVisible(r)?this.layerView.fadeNode(r,nt.FadeOut,!0):this.layerView.removeNode(r),t.madeProgress()}if(this._loadedNodeScales.size>0)for(let t=e.length;t<r;t++){const i=e.data[t];this._loadedNodeScales.delete(i)}}}_needsUpdate(e){if(e.resources.isEmpty||this._updatingNodes.has(e.index))return!1;const t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}async _updateLoadedNode(e){const t=new AbortController;this._updatingNodes.set(e.index,t),this._evaluateUpdating();try{const i=Pi(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes);let r=null;r=i?this.layerView.getAttributeData(e.index):await this._loadAttributes(e,this._requiredAttributes,t.signal),await this.schedule((()=>this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:r},t.signal)),t.signal)}catch(i){if(!(0,o.zf)(i))return this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},t.signal)}this._updatingNodes.delete(e.index),this._evaluateUpdating()}_loadNode(e){if(this._loadingNodes.has(e.index))return void a.A.getLogger(this).error("already loading node "+e.index);const t=new AbortController;this._loadingNodes.set(e.index,t),this._evaluateUpdating(),this._loadAndAddNode(e,t.signal).then((i=>{i&&null!=this._index&&this._loadingNodes.get(e.index)===t&&(this._loadingNodes.delete(e.index),this._index.requestUpdate())})).catch((e=>{if(!(0,o.zf)(e))throw e})).finally((()=>{this._loadingNodes.get(e.index)===t&&this._loadingNodes.delete(e.index),this._evaluateUpdating()}))}_loadAndAddNode(e,t){return e.cacheState===Ie.iF.Uncached?this._loadUncached(e,t).then((()=>!1)):this._loadCached(e,t).then((t=>!t&&(e.cacheState=Ie.iF.Uncached,!0))).catch((t=>!(0,o.zf)(t)&&(e.cacheState=Ie.iF.Uncached,!0)))}_enableFromGPUCache(e,t){if(this._disableMemCache||null==this._index)return!1;if(t===Ie.UY.Hole&&!this._index.useNodeAsHole(e.index))return!0;const i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)}_loadCachedGPUData(e){const t=this.layerView.loadCachedGPUData(e.index);return null!=t?.attributeInfo&&Pi(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}_nodeAdded(){null!=this._index&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateLoadStatus(e,t){const i=this._index;null!=i&&i.updateChildrenLoaded(e,t?1:-1)}async _loadCached(e,t){if(this._enableFromGPUCache(e,Ie.UY.Leaf))return!0;const i=this.layerView;if(this.disableIDBCache||!i.loadCachedNodeData||!i.addCachedNodeData)return!1;const r=e.index>=0?(t,i)=>this._nodeLoader.loadTextures(e,t,i):(t,i)=>this._clientNodeLoader.loadTextures(e,t,i),s=await this.schedule((()=>i.loadCachedNodeData(e,t,r)),t);if(null==s)return!1;const n=this._requiredAttributes,a=await this.reschedule((()=>this._loadAttributes(e,n,t)),t);return await this.reschedule((()=>i.addCachedNodeData(e,s,{loadedAttributes:n,attributeData:a},t)),t),this._nodeAdded(),!0}_loadUncached(e,t){return this._downloadingCount++,this._loadNodeData(e,t).catch((e=>{throw this._downloadingCount--,e})).then((i=>(this._downloadingCount--,this.schedule((()=>this.layerView.addNode(e,i,t)),t)))).then((()=>{this._nodeAdded(),e.cacheState=Ie.iF.Cached})).catch((t=>{if(!(0,o.zf)(t))throw a.A.getLogger(this).error("#loadNodeData()",this.layer,`Failed to load node '${e.id}'`,t),e.failed=!0,null!=this._index&&this._index.requestUpdate(),t}))}_updateIdleState(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&null!=this._index&&this._index.resetFailedNodes())}_getScale(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);const t=this._computeScale(e);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}_computeScale(e){this._tmpPoint.x=e.serviceMbsInIndexSR[0],this._tmpPoint.y=e.serviceMbsInIndexSR[1],this._tmpPoint.z=e.serviceMbsInIndexSR[2];const t=e.serviceMbsInIndexSR[3];return this.layerView.view.basemapTerrain.getSphereScale(this._tmpPoint,t)}_isNodeInScaleBounds(e){if(!this._areScaleBoundsActive)return!0;const t=this._getScale(e),{minScale:i,maxScale:r}=(0,Ri.Cf)(this.layer);return(0,Ri.JU)(t,i,r)}get test(){const e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){null!=e._index&&(e._index.ignoreServiceObb=t)},shouldLoadNode:t=>e._shouldLoadNode(t)}}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),null!=this._index&&this._index.requestUpdate()}geometryFilterChanged(e){const t=this._index;null!=t&&t.layerFilterChanged(e),this._setCameraDirty()}};(0,r._)([(0,h.MZ)({readOnly:!0})],Ai.prototype,"isMeshPyramid",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ai.prototype,"isGraphics3D",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ai.prototype,"useMaximumNumberOfFeatures",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ai.prototype,"indexStreamController",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ai.prototype,"dataStreamController",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ai.prototype,"crsVertex",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ai.prototype,"crsIndex",null),(0,r._)([(0,h.MZ)()],Ai.prototype,"screenSizeFactor",void 0),(0,r._)([(0,h.MZ)()],Ai.prototype,"featureTarget",void 0),(0,r._)([(0,h.MZ)()],Ai.prototype,"fixedFeatureTarget",void 0),(0,r._)([(0,h.MZ)()],Ai.prototype,"layerView",void 0),(0,r._)([(0,h.MZ)()],Ai.prototype,"layer",null),(0,r._)([(0,h.MZ)()],Ai.prototype,"updating",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],Ai.prototype,"running",null),(0,r._)([(0,h.MZ)()],Ai.prototype,"updatingProgress",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],Ai.prototype,"leavesReached",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Ai.prototype,"scaleVisibilityEnabled",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Ai.prototype,"worker",void 0),(0,r._)([(0,h.MZ)({readOnly:!0,dependsOn:[]})],Ai.prototype,"rootNodeVisible",null),Ai=(0,r._)([(0,u.$)("esri.layers.graphics.controllers.I3SOnDemandController")],Ai);const Ti=new C.A({deallocator:null});let Oi;function Pi(e,t){return null!=e&&e.length===t.length&&e.every((e=>Mi(t,e.name)>=0))}function Mi(e,t){const i=t.toLowerCase();for(let t=0;t<e.length;t++)if(e[t].name.toLowerCase()===i)return t;return-1}const Ii={factorIM:.2,factor3dObject:.05,distancePenalty:10},Di=(0,$.vt)();var Fi;!function(e){e[e.pop=0]="pop",e[e.fadeout=1]="fadeout"}(Fi||(Fi={}));var Li=i(46227),Ni=(i(65088),i(37525)),Vi=i(6183),Gi=(i(62932),i(3438),i(78851)),Ui=i(58652),zi=(i(42957),i(8499),i(72502),i(2394),i(52721),i(46243),i(79645),i(1851)),Bi=(i(29221),i(80294)),Hi=i(34561),ji=i(19262),Wi=i(45449),ki=i(891),Zi=i(84155),qi=i(58720),$i=i(85498),Qi=i(56173),Ji=i(12862),Yi=i(7998),Xi=i(49864),Ki=i(61793),er=i(51103);const tr=Ji.A.fromSimpleMarkerSymbol(Ki.UK),ir=$i.A.fromSimpleLineSymbol(Ki.A7),rr=Yi.A.fromSimpleFillSymbol(Ki.Cx),sr=new Qi.A({symbolLayers:new S.A([new qi.A({material:{color:er.fT},edges:new Xi.A({size:"1px",color:er.JR})})])});function nr(e){if(null==e)return null;switch(e.type){case"mesh":return sr;case"point":case"multipoint":return tr;case"polyline":return ir;case"polygon":case"extent":return rr}return null}var ar=i(14215),or=i(95039),lr=i(73962);var cr,hr,dr=i(56560),ur=i(6590),pr=i(87368),fr=i(63918),gr=i(10941);(hr=cr||(cr={})).length=function(e,t){const i=e[t],r=e[t+1],s=e[t+2];return Math.sqrt(i*i+r*r+s*s)},hr.normalize=function(e,t){const i=e[t],r=e[t+1],s=e[t+2],n=1/Math.sqrt(i*i+r*r+s*s);e[t]*=n,e[t+1]*=n,e[t+2]*=n},hr.scale=function(e,t,i){e[t]*=i,e[t+1]*=i,e[t+2]*=i},hr.add=function(e,t,i,r,s,n=t){(s=s||e)[n]=e[t]+i[r],s[n+1]=e[t+1]+i[r+1],s[n+2]=e[t+2]+i[r+2]},hr.subtract=function(e,t,i,r,s,n=t){(s=s||e)[n]=e[t]-i[r],s[n+1]=e[t+1]-i[r+1],s[n+2]=e[t+2]-i[r+2]};var mr=i(61723),_r=i(24960),yr=i(26421);const vr=cr,br=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],xr=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],Sr=[0,0,1,0,1,1,0,1],wr=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],Cr=new Array(36);for(let e=0;e<6;e++)for(let t=0;t<6;t++)Cr[6*e+t]=e;const Rr=new Array(36);for(let e=0;e<6;e++)Rr[6*e]=0,Rr[6*e+1]=1,Rr[6*e+2]=2,Rr[6*e+3]=2,Rr[6*e+4]=3,Rr[6*e+5]=0;const Er=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],Ar=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],Tr=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],Or=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7],Pr=(0,ur.fA)(-.5,0,-.5),Mr=(0,ur.fA)(.5,0,-.5),Ir=(0,ur.fA)(0,0,.5),Dr=(0,ur.fA)(0,.5,0),Fr=(0,ur.vt)(),Lr=(0,ur.vt)(),Nr=(0,ur.vt)(),Vr=(0,ur.vt)(),Gr=(0,ur.vt)();(0,M.f)(Fr,Pr,Dr),(0,M.f)(Lr,Pr,Mr),(0,M.b)(Nr,Fr,Lr),(0,M.n)(Nr,Nr),(0,M.f)(Fr,Mr,Dr),(0,M.f)(Lr,Mr,Ir),(0,M.b)(Vr,Fr,Lr),(0,M.n)(Vr,Vr),(0,M.f)(Fr,Ir,Dr),(0,M.f)(Lr,Ir,Pr),(0,M.b)(Gr,Fr,Lr),(0,M.n)(Gr,Gr);const Ur=[Pr,Mr,Ir,Dr],zr=[0,-1,0,Nr[0],Nr[1],Nr[2],Vr[0],Vr[1],Vr[2],Gr[0],Gr[1],Gr[2]],Br=[0,1,2,3,1,0,3,2,1,3,0,2],Hr=[0,0,0,1,1,1,2,2,2,3,3,3];function jr(e,t,i,r,s,n,a,o,l=null){const c=i?(0,I.o8)(i):(0,I.vt)(),h=t?(0,I.o8)(t):(0,I.fA)(0,0,1);a??=(0,dr.vt)();const d=r?[255*r[0],255*r[1],255*r[2],r.length>3?255*r[3]:255]:[255,255,255,255],u=null!=s&&2===s.length?s:[1,1],p=(0,Y.EH)(1),f=[[It.r.POSITION,new gr.n(c,p,3,!0)],[It.r.NORMAL,new gr.n(h,p,3,!0)],[It.r.UV0,new gr.n(a,p,a.length)],[It.r.COLOR,new gr.n(d,p,4,!0)],[It.r.SIZE,new gr.n(u,p,2)]];if(null!=n&&(n=[n[0],n[1],n[2],n[3]],f.push([It.r.CENTEROFFSETANDDISTANCE,new gr.n(n,p,4)])),o){const e=[o[0],o[1],o[2],o[3]];f.push([It.r.FEATUREATTRIBUTE,new gr.n(e,p,4)])}return new _r.V(e,f,null,mr.X.Point,l)}function Wr(e,t,i,r,s,n=!0,a=!0){let o=0;const l=i,c=t;let h=(0,ur.fA)(0,o,0),d=(0,ur.fA)(0,o+c,0),u=(0,ur.fA)(0,-1,0),p=(0,ur.fA)(0,1,0);s&&(o=c,d=(0,ur.fA)(0,0,0),h=(0,ur.fA)(0,o,0),u=(0,ur.fA)(0,1,0),p=(0,ur.fA)(0,-1,0));const f=[d,h],g=[u,p],m=r+2,_=Math.sqrt(c*c+l*l);if(s)for(let e=r-1;e>=0;e--){const t=e*(2*Math.PI/r),i=(0,ur.fA)(Math.cos(t)*l,o,Math.sin(t)*l);f.push(i);const s=(0,ur.fA)(c*Math.cos(t)/_,-l/_,c*Math.sin(t)/_);g.push(s)}else for(let e=0;e<r;e++){const t=e*(2*Math.PI/r),i=(0,ur.fA)(Math.cos(t)*l,o,Math.sin(t)*l);f.push(i);const s=(0,ur.fA)(c*Math.cos(t)/_,l/_,c*Math.sin(t)/_);g.push(s)}const y=new Array,v=new Array;if(n){for(let e=3;e<f.length;e++)y.push(1),y.push(e-1),y.push(e),v.push(0),v.push(0),v.push(0);y.push(f.length-1),y.push(2),y.push(1),v.push(0),v.push(0),v.push(0)}if(a){for(let e=3;e<f.length;e++)y.push(e),y.push(e-1),y.push(0),v.push(e),v.push(e-1),v.push(1);y.push(0),y.push(2),y.push(f.length-1),v.push(1),v.push(2),v.push(g.length-1)}const b=(0,J.oe)(3*m);for(let e=0;e<m;e++)b[3*e]=f[e][0],b[3*e+1]=f[e][1],b[3*e+2]=f[e][2];const x=(0,J.oe)(3*m);for(let e=0;e<m;e++)x[3*e]=g[e][0],x[3*e+1]=g[e][1],x[3*e+2]=g[e][2];const S=[[It.r.POSITION,new gr.n(b,y,3,!0)],[It.r.NORMAL,new gr.n(x,v,3,!0)]];return new _r.V(e,S)}function kr(e,t,i,r,s){return!(Math.abs((0,M.j)(t,e))>s||((0,M.b)(i,e,t),(0,M.n)(i,i),(0,M.b)(r,i,e),(0,M.n)(r,r),0))}function Zr(e,t,i,r,s,n,a){return kr(e,t,s,n,a)||kr(e,i,s,n,a)||kr(e,r,s,n,a)}(0,I.vt)();class qr{constructor(e,t=null){this.geometry=e,this.textures=t}}class $r{constructor(e,t,i){this.components=e,this.minScreenSpaceRadius=t,this.pivotOffset=i;const r=this.geometries;this.numVertices=r.reduce(((e,t)=>e+t.attributes.get(It.r.POSITION).indices.length),0)}get geometries(){return(0,b.Am)(this.components.map((e=>e.geometry)))}}class Qr{constructor(e){this.levels=e,this.levels.sort(((e,t)=>e.minScreenSpaceRadius===t.minScreenSpaceRadius?e.numVertices-t.numVertices:e.minScreenSpaceRadius-t.minScreenSpaceRadius))}}function Jr(e){const t=[];return e.levels.forEach((e=>e.components.forEach((e=>t.push(e.geometry.material))))),(0,b.Am)(t)}function Yr(e){const t=new Array;return e.levels.forEach((e=>e.components.forEach((e=>{null!=e.textures&&t.push(...e.textures)})))),(0,b.Am)(t)}function Xr(e){const t=new Array;return e.levels.forEach((e=>e.components.forEach((e=>t.push(e.geometry))))),(0,b.Am)(t)}function Kr(e,t){const i=(e,t,i=!1)=>new Qr(e.map((e=>{const r=t(e.tesselation);return i&&function(e,t=e){const i=e.attributes,r=i.get(It.r.POSITION).data,s=i.get(It.r.NORMAL).data;if(s){const e=t.getMutableAttribute(It.r.NORMAL).data;for(let t=0;t<s.length;t+=3){const i=s[t+1];e[t+1]=-s[t+2],e[t+2]=i}}if(r){const e=t.getMutableAttribute(It.r.POSITION).data;for(let t=0;t<r.length;t+=3){const i=r[t+1];e[t+1]=-r[t+2],e[t+2]=i}}}(r),new $r([new qr(r)],e.minScreenSpaceRadius)})));switch(e){case"sphere":return i([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],(e=>function(e,t,i,r){const s=function(e,t,i){const r=e;let s,n;if(i)s=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],n=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{const e=r*(1+Math.sqrt(5))/2;s=[-r,e,0,r,e,0,-r,-e,0,r,-e,0,0,-r,e,0,r,e,0,-r,-e,0,r,-e,e,0,-r,e,0,r,-e,0,-r,-e,0,r],n=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let t=0;t<s.length;t+=3)vr.scale(s,t,e/vr.length(s,t));let a={};function o(t,i){t>i&&([t,i]=[i,t]);const r=t.toString()+"."+i.toString();if(a[r])return a[r];let n=s.length;return s.length+=3,vr.add(s,3*t,s,3*i,s,n),vr.scale(s,n,e/vr.length(s,n)),n/=3,a[r]=n,n}for(let e=0;e<t;e++){const e=n.length,t=new Array(4*e);for(let i=0;i<e;i+=3){const e=n[i],r=n[i+1],s=n[i+2],a=o(e,r),l=o(r,s),c=o(s,e),h=4*i;t[h]=e,t[h+1]=a,t[h+2]=c,t[h+3]=r,t[h+4]=l,t[h+5]=a,t[h+6]=s,t[h+7]=c,t[h+8]=l,t[h+9]=a,t[h+10]=l,t[h+11]=c}n=t,a={}}const l=(0,J.Wz)(s);for(let e=0;e<l.length;e+=3)vr.normalize(l,e);return[[It.r.POSITION,new gr.n((0,J.Wz)(s),n,3,!0)],[It.r.NORMAL,new gr.n(l,n,3,!0)]]}(t,i,r);return new _r.V(e,s)}(t,.5,e,!0)));case"cube":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>function(e,t){Array.isArray(t)||(t=[t,t,t]);const i=new Array(24);for(let e=0;e<8;e++)i[3*e]=br[e][0]*t[0],i[3*e+1]=br[e][1]*t[1],i[3*e+2]=br[e][2]*t[2];return new _r.V(e,[[It.r.POSITION,new gr.n(i,wr,3,!0)],[It.r.NORMAL,new gr.n(xr,Cr,3)],[It.r.UV0,new gr.n(Sr,Rr,2)]])}(t,1)));case"cone":return i(es,(e=>Wr(t,1,.5,e,!1)),!0);case"inverted-cone":return i(es,(e=>Wr(t,1,.5,e,!0)),!0);case"cylinder":return i(es,(e=>function(e,t,i,r,s,n,a){const o=s?(0,ur.o8)(s):(0,ur.fA)(1,0,0),l=n?(0,ur.o8)(n):(0,ur.fA)(0,0,0);a??=!0;const c=(0,ur.vt)();(0,M.n)(c,o);const h=(0,ur.vt)();(0,M.h)(h,c,Math.abs(1));const d=(0,ur.vt)();(0,M.h)(d,h,-.5),(0,M.g)(d,d,l);const u=(0,ur.fA)(0,1,0);Math.abs(1-(0,M.j)(c,u))<.2&&(0,M.s)(u,0,0,1);const p=(0,ur.vt)();(0,M.b)(p,c,u),(0,M.n)(p,p),(0,M.b)(u,p,c);const f=2*r+(a?2:0),g=r+(a?2:0),m=(0,J.oe)(3*f),_=(0,J.oe)(3*g),y=(0,J.oe)(2*f),v=new Array(3*r*(a?4:2)),b=new Array(3*r*(a?4:2));a&&(m[3*(f-2)]=d[0],m[3*(f-2)+1]=d[1],m[3*(f-2)+2]=d[2],y[2*(f-2)]=0,y[2*(f-2)+1]=0,m[3*(f-1)]=m[3*(f-2)]+h[0],m[3*(f-1)+1]=m[3*(f-2)+1]+h[1],m[3*(f-1)+2]=m[3*(f-2)+2]+h[2],y[2*(f-1)]=1,y[2*(f-1)+1]=1,_[3*(g-2)]=-c[0],_[3*(g-2)+1]=-c[1],_[3*(g-2)+2]=-c[2],_[3*(g-1)]=c[0],_[3*(g-1)+1]=c[1],_[3*(g-1)+2]=c[2]);const x=(e,t,i)=>{v[e]=t,b[e]=i};let S=0;const w=(0,ur.vt)(),C=(0,ur.vt)();for(let e=0;e<r;e++){const t=e*(2*Math.PI/r);(0,M.h)(w,u,Math.sin(t)),(0,M.h)(C,p,Math.cos(t)),(0,M.g)(w,w,C),_[3*e]=w[0],_[3*e+1]=w[1],_[3*e+2]=w[2],(0,M.h)(w,w,.5),(0,M.g)(w,w,d),m[3*e]=w[0],m[3*e+1]=w[1],m[3*e+2]=w[2],y[2*e]=e/r,y[2*e+1]=0,m[3*(e+r)]=m[3*e]+h[0],m[3*(e+r)+1]=m[3*e+1]+h[1],m[3*(e+r)+2]=m[3*e+2]+h[2],y[2*(e+r)]=e/r,y[2*e+1]=1;const i=(e+1)%r;x(S++,e,e),x(S++,e+r,e),x(S++,i,i),x(S++,i,i),x(S++,e+r,e),x(S++,i+r,i)}if(a){for(let e=0;e<r;e++){const t=(e+1)%r;x(S++,f-2,g-2),x(S++,e,g-2),x(S++,t,g-2)}for(let e=0;e<r;e++){const t=(e+1)%r;x(S++,e+r,g-1),x(S++,f-1,g-1),x(S++,t+r,g-1)}}const R=[[It.r.POSITION,new gr.n(m,v,3,!0)],[It.r.NORMAL,new gr.n(_,b,3,!0)],[It.r.UV0,new gr.n(y,v,2,!0)]];return new _r.V(e,R)}(t,0,0,e,[0,0,1],[0,0,.5])));case"tetrahedron":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>function(e,t){Array.isArray(t)||(t=[t,t,t]);const i=new Array(12);for(let e=0;e<4;e++)i[3*e]=Ur[e][0]*t[0],i[3*e+1]=Ur[e][1]*t[1],i[3*e+2]=Ur[e][2]*t[2];return new _r.V(e,[[It.r.POSITION,new gr.n(i,Br,3,!0)],[It.r.NORMAL,new gr.n(zr,Hr,3)]])}(t,1)),!0);case"diamond":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>function(e,t){Array.isArray(t)||(t=[t,t,t]);const i=new Array(18);for(let e=0;e<6;e++)i[3*e]=Er[e][0]*t[0],i[3*e+1]=Er[e][1]*t[1],i[3*e+2]=Er[e][2]*t[2];return new _r.V(e,[[It.r.POSITION,new gr.n(i,Tr,3,!0)],[It.r.NORMAL,new gr.n(Ar,Or,3)]])}(t,1)),!0);default:return}}const es=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];class ts{constructor(e){this.estimated=!1,this.verticesPerFeature=e.verticesPerFeature??0,this.verticesPerCoordinate=e.verticesPerCoordinate??0,this.drawCallsPerFeature=e.drawCallsPerFeature??0,this.memory=e.memory??new ns}}class is extends ts{constructor(e){super(e),this.estimated=!0}}class rs extends ts{constructor(e,t){super(t),this.numComplexities=e}}class ss extends is{constructor(e,t){super(t),this.numComplexities=e}}class ns{constructor(){this.bytesPerFeature=0,this.bytesPerFeatureLabel=0,this.resourceBytes=0,this.draped={bytesPerFeature:0,bytesPerFeatureLabel:0}}}var as=i(118),os=i(14103);const ls=new is({});function cs(e){let t=0,i=0,r=0,s=!1,n=0;const a=new ns;for(const o of e)null!=o&&(t+=o.verticesPerFeature,i+=o.verticesPerCoordinate,r+=o.drawCallsPerFeature,a.bytesPerFeature+=o.memory.bytesPerFeature,a.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,a.resourceBytes+=o.memory.resourceBytes,a.draped.bytesPerFeature+=o.memory.bytesPerFeature,a.draped.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,s=s||o.estimated,++n);return s?new ss(n,{verticesPerFeature:t,verticesPerCoordinate:i,drawCallsPerFeature:r,memory:a}):new rs(n,{verticesPerFeature:t,verticesPerCoordinate:i,drawCallsPerFeature:r,memory:a})}const hs={};function ds(e,t){const i=us(e,t),r=(0,as.RF)(t)?2:0;switch(t.type){case"extrude":return new ts({verticesPerFeature:-12,verticesPerCoordinate:12,drawCallsPerFeature:r,memory:i});case"fill":if("mesh-3d"===e.type)return new ts({drawCallsPerFeature:r,memory:i});if(null!=t.outline&&t.outline.size>0)return new ts({verticesPerFeature:-12,verticesPerCoordinate:9,memory:i});case"water":return new ts({verticesPerFeature:-6,verticesPerCoordinate:3,memory:i});case"line":return new ts({verticesPerFeature:-6,verticesPerCoordinate:6,memory:i});case"object":return t.resource?.href?new is({verticesPerFeature:100,memory:i}):{...ps(t.resource?.primitive??lr.r),memory:i};case"path":{let e=0,r=0;switch(t.profile){case"circle":e=10;break;case"quad":e=4;break;default:return void(0,or.Xb)(t.profile)}switch(t.join??"simple"){case"round":r=3;break;case"miter":case"bevel":r=1;break;default:return}const s=2*e,n=e*r*2,a=n+s;let o=-2*n-s;switch(t.cap){case"none":break;case"butt":case"square":o+=2*(e-1);break;case"round":o+=2*(2*e*2+e);break;default:return}return new ts({verticesPerFeature:o,verticesPerCoordinate:a,memory:i})}case"text":case"icon":return new ts({verticesPerFeature:6,memory:i});default:return}}function us(e,t){const i="point-3d"===e.type;switch(t.type){case"extrude":return t.edges&&t.edges.size>0?gs.EXTRUDE_EDGES:gs.EXTRUDE;case"fill":return null!=t.outline&&t.outline.size>0?gs.FILL_OUTLINE:gs.FILL;case"water":return gs.FILL;case"line":return"round"===t.join?gs.LINE_ROUND:gs.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return gs.PATH_ROUND_CIRCLE;case"quad":return gs.PATH_ROUND_QUAD;default:return void(0,or.Xb)(t.profile)}case"miter":case"bevel":switch(t.profile){case"circle":return gs.PATH_MITER_CIRCLE;case"quad":return gs.PATH_MITER_QUAD;default:return void(0,or.Xb)(t.profile)}default:return}case"object":return i?gs.OBJECT_POINT:gs.OBJECT_POLYGON;case"icon":case"text":return i?gs.ICON_POINT:gs.ICON_POLYGON;default:return}}function ps(e){const t=hs[e];if(t)return t;const i=fs(Kr(e,new os.$U({})).levels);return hs[e]=new ts({verticesPerFeature:i}),hs[e]}function fs(e){return e.reduce(((e,t,i)=>e+t.numVertices*(1/10**i)),0)/e.reduce(((e,t,i)=>e+1/10**i),0)}const gs={ICON_POINT:{bytesPerFeature:2379.8272296852992,bytesPerFeatureLabel:852.246235,resourceBytes:0,draped:{bytesPerFeature:1868.2382921559424,bytesPerFeatureLabel:839.205415}},ICON_POLYGON:{bytesPerFeature:2957.8429876524656,bytesPerFeatureLabel:862.5307816666666,resourceBytes:0,draped:{bytesPerFeature:2579.7767085451133,bytesPerFeatureLabel:856.9298550000001}},OBJECT_POINT:{bytesPerFeature:603.543820573039,bytesPerFeatureLabel:717.4551849999999,resourceBytes:0,draped:{bytesPerFeature:603.543820573039,bytesPerFeatureLabel:717.4551849999999}},OBJECT_POLYGON:{bytesPerFeature:1111.1693389308373,bytesPerFeatureLabel:707.4535949999998,resourceBytes:0,draped:{bytesPerFeature:1111.1693389308373,bytesPerFeatureLabel:707.4535949999998}},LINE_MITER:{bytesPerFeature:3081.208408220661,bytesPerFeatureLabel:858.6749016666668,resourceBytes:0,draped:{bytesPerFeature:2682.57863388475,bytesPerFeatureLabel:844.6118016666666}},LINE_ROUND:{bytesPerFeature:3209.3236242927915,bytesPerFeatureLabel:858.1810416666667,resourceBytes:0,draped:{bytesPerFeature:2687.6256038096126,bytesPerFeatureLabel:849.578535}},PATH_MITER_CIRCLE:{bytesPerFeature:38708.74276663992,bytesPerFeatureLabel:858.70415,resourceBytes:0,draped:{bytesPerFeature:38708.74276663992,bytesPerFeatureLabel:858.70415}},PATH_ROUND_CIRCLE:{bytesPerFeature:42098.00590216518,bytesPerFeatureLabel:868.3632500000001,resourceBytes:0,draped:{bytesPerFeature:42098.00590216518,bytesPerFeatureLabel:868.3632500000001}},PATH_MITER_QUAD:{bytesPerFeature:25037.823002405767,bytesPerFeatureLabel:835.93355,resourceBytes:0,draped:{bytesPerFeature:25037.823002405767,bytesPerFeatureLabel:835.93355}},PATH_ROUND_QUAD:{bytesPerFeature:40320.254760224525,bytesPerFeatureLabel:851.66955,resourceBytes:0,draped:{bytesPerFeature:40320.254760224525,bytesPerFeatureLabel:851.66955}},FILL:{bytesPerFeature:3147.43349219103,bytesPerFeatureLabel:850.7598550000001,resourceBytes:0,draped:{bytesPerFeature:2673.7898488975106,bytesPerFeatureLabel:846.6459950000002}},FILL_OUTLINE:{bytesPerFeature:4565.099993465867,bytesPerFeatureLabel:855.334515,resourceBytes:0,draped:{bytesPerFeature:3904.46969705314,bytesPerFeatureLabel:844.7081016666667}},EXTRUDE:{bytesPerFeature:7551.2282834569505,bytesPerFeatureLabel:849.5513283333333,resourceBytes:0,draped:{bytesPerFeature:7551.2282834569505,bytesPerFeatureLabel:849.5513283333333}},EXTRUDE_EDGES:{bytesPerFeature:2959.8379634500698,bytesPerFeatureLabel:602.0969283333335,resourceBytes:0,draped:{bytesPerFeature:2959.8379634500698,bytesPerFeatureLabel:602.0969283333335}}};class ms{constructor(e,t,i){this.maximumTotalNumberOfVertices=e,this.maximumNumberOfFeatures=t,this.averageSymbolComplexity=i}}var _s,ys,vs;i(67709);class bs{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,i){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,i)}async queryElevation(e,t,i,r,s){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,s,i,r)}}(vs=_s||(_s={}))[vs.USER=1]="USER",vs[vs.SCALE_RANGE=2]="SCALE_RANGE",vs[vs.FILTER=4]="FILTER",vs[vs.DECONFLICTION=8]="DECONFLICTION",vs[vs.ALL_GRAPHIC=15]="ALL_GRAPHIC",vs[vs.ALL_LABEL=255]="ALL_LABEL",function(e){e[e.GRAPHIC=1]="GRAPHIC",e[e.LABEL=16]="LABEL"}(ys||(ys={}));var xs=i(57888),Ss=i(85747),ws=i(65977),Cs=i(46452);const Rs=(0,q.vt)();let Es=class extends n.A{constructor(e){super(e),this.events=new xs.A,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.featureAdapter={getAttribute:(e,t)=>"graphic"in e?e.graphic.attributes[t]:Cs.T.getAttribute(e,t),getAttributes:e=>"graphic"in e?e.graphic.attributes:Cs.T.getAttributes(e),getObjectId:e=>"graphic"in e?(0,ki.RW)(e.graphic,this.objectIdField)??void 0:Cs.T.getObjectId(e),getGeometry:e=>"graphic"in e?e.getAsOptimizedGeometry(this.hasZ,this.hasM):Cs.T.getGeometry(e),getCentroid:(e,t)=>{if("graphic"in e){let i=null;null!=e.centroid?i=e.centroid:"point"===e.graphic.geometry.type&&(0,Hi.projectPoint)(e.graphic.geometry,As,this.viewSpatialReference)&&(i=As);const r=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return null==i?(r[0]=0,r[1]=0,r[2]=0,r[3]=0):(r[0]=i.x,r[1]=i.y,t.hasZ&&(r[2]=i.hasZ?i.z:0),t.hasM&&(r[t.hasZ?3:2]=i.hasM?i.m:0)),new ws.A([],r)}return Cs.T.getCentroid(e,t)},cloneWithGeometry:(e,t)=>"graphic"in e?new Ss.Om(t,this.featureAdapter.getAttributes(e),null,this.featureAdapter.getObjectId(e)):Cs.T.cloneWithGeometry(e,t)}}forEachInBounds(e,t){this.getSpatialIndex().forEachInBounds(e,t)}forEachBounds(e,t){const i=this.getSpatialIndex();for(const r of e){const e=this.featureAdapter.getObjectId(r);null!=i.getBounds(e,Rs)&&t(Rs)}}};(0,r._)([(0,h.MZ)({constructOnly:!0})],Es.prototype,"getSpatialIndex",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Es.prototype,"forEach",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Es.prototype,"hasZ",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Es.prototype,"hasM",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Es.prototype,"objectIdField",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Es.prototype,"viewSpatialReference",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Es.prototype,"featureSpatialReference",void 0),Es=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],Es);const As={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};class Ts{constructor(e,t,i){this.graphic=e,this.renderingInfo=t,this.layer=i}}class Os{constructor(e,t){this.scheduler=e,this.schedule=t,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}}var Ps=i(884),Ms=i(23572),Is=i(31882);function Ds(e){return null!=e.mapPositions}function Fs(e,t,i,r,s){const n=e.stageObject,a=n.geometries;let o=0;for(const e of a){if(!Ds(e))continue;const{update:a,averageGeometrySampledElevation:l}=Zs(e,t,i,r,s);o+=l,a&&n.geometryVertexAttributeUpdated(e,It.r.POSITION)}return o/a.length}function Ls(e,t,i,r,s,n){const a=e.stageObject,o=t.centerPointInElevationSR;let l=0;a.usesVerticalDistanceToGround?(r(o,ks),zt(a,ks.verticalDistanceToGround),l=ks.sampledElevation):(r(o,ks),"absolute-height"!==t.mode&&(l=ks.sampledElevation));const c=(0,O.C)(Ns,n??a.transformation),h=(0,M.s)(Ws,c[12],c[13],c[14]);Is.b.TESTS_DISABLE_OPTIMIZATIONS?(zs[0]=o.x,zs[1]=o.y,zs[2]=ks.z,(0,Et.l)(o.spatialReference,zs,c,s.spatialReference)&&(n?(0,O.C)(n,c):a.transformation=c)):s.setAltitudeOfTransformation(ks.z,c);const d=Us/s.unitInMeters;return(Math.abs(c[12]-h[0])>=d||Math.abs(c[13]-h[1])>=d||Math.abs(c[14]-h[2])>=d)&&(n?(0,O.C)(n,c):a.transformation=c),l}const Ns=(0,P.vt)();function Vs(e,t,i,r,s){const n=e.graphics3DSymbolLayer.lodRenderer;if(null==n)return 0;const a=t.centerPointInElevationSR;r(a,ks);const o="absolute-height"!==t.mode?ks.sampledElevation:0,l=n.instanceData,c=e.instanceIndex,h=js;l.getGlobalTransform(c,h);const d=(0,M.s)(Ws,h[12],h[13],h[14]);Is.b.TESTS_DISABLE_OPTIMIZATIONS?(zs[0]=a.x,zs[1]=a.y,zs[2]=ks.z,(0,Et.l)(a.spatialReference,zs,h,s.spatialReference)&&l.setGlobalTransform(c,h)):s.setAltitudeOfTransformation(ks.z,h);const u=Us/s.unitInMeters;return(Is.b.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(h[12]-d[0])>=u||Math.abs(h[13]-d[1])>=u||Math.abs(h[14]-d[2])>=u)&&l.setGlobalTransform(c,h),o}function Gs(e,t,i,r,s){const n=e.stageObject,a=n.geometries;if(0===a.length)return 0;let o=0,l=null,c=0,h=!1;for(const e of a){if(!Ds(e))continue;const a=e.attributes.get(It.r.POSITION);if(a!==l){const{update:n,averageGeometrySampledElevation:o}=Zs(e,t,i,r,s);c=o,l=a,h=n}h&&n.geometryVertexAttributeUpdated(e,It.r.POSITION),o+=c}return o/a.length}const Us=.01,zs=(0,I.vt)(),Bs=(0,I.vt)(),Hs=(0,I.vt)(),js=(0,P.vt)(),Ws=(0,I.vt)(),ks=new Bt;function Zs(e,t,i,r,s){let n=!1;const a=e.transformation,o=t.requiresSampledElevationInfo;Bs[0]=a[12],Bs[1]=a[13],Bs[2]=a[14],e.invalidateBoundingInfo();const l=e.getMutableAttribute(It.r.POSITION),c=l.data,h=l.size,d=c.length/h,u=new Tt(e.mapPositions,i);let p=0,f=0;for(let e=0;e<d;e++){if(Hs[0]=c[p],Hs[1]=c[p+1],Hs[2]=c[p+2],r(u,ks),o&&(f+=ks.sampledElevation),Is.b.TESTS_DISABLE_OPTIMIZATIONS)c[p]=u.array[u.offset],c[p+1]=u.array[u.offset+1],c[p+2]=ks.z,(0,k.projectBuffer)(c,i,p,c,s.spatialReference,p,1),c[p]-=Bs[0],c[p+1]-=Bs[1],c[p+2]-=Bs[2],n=!0;else{zs[0]=c[p]+Bs[0],zs[1]=c[p+1]+Bs[1],zs[2]=c[p+2]+Bs[2],s.setAltitude(zs,ks.z),c[p]=zs[0]-Bs[0],c[p+1]=zs[1]-Bs[1],c[p+2]=zs[2]-Bs[2];const e=Us/s.unitInMeters;(Math.abs(Hs[0]-c[p])>=e||Math.abs(Hs[1]-c[p+1])>=e||Math.abs(Hs[2]-c[p+2])>=e)&&(n=!0)}p+=h,u.offset+=3}return f/=d,{update:n,averageGeometrySampledElevation:f}}var qs=i(23064),$s=i(11021);function Qs(e,t){if("point"===e.type)return Ys(e,t,!1);if($t(e))switch(e.type){case"extent":return Ys(e.center,t,!1);case"polygon":return Ys(e.centroid,t,!1);case"polyline":return Ys(Js(e),t,!0);case"mesh":return Ys(e.origin,t,!1)}else switch(e.type){case"extent":return Ys(function(e){return(0,ne.T)(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),null!=e.zmin&&null!=e.zmax&&isFinite(e.zmin)&&isFinite(e.zmax)?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}(e),t,!0);case"polygon":return Ys(function(e){const t=e.rings[0];if(!t||0===t.length)return null;const i=(0,qs.S8)(e.rings,!!e.hasZ);return(0,ne.T)(i[0],i[1],i[2],e.spatialReference)}(e),t,!0);case"polyline":return Ys(Js(e),t,!0)}}function Js(e){const t=e.paths[0];if(!t||0===t.length)return null;const i=(0,$s.$H)(t,(0,$s.Yl)(t)/2);return(0,ne.T)(i[0],i[1],i[2],e.spatialReference)}function Ys(e,t,i){const r=i?e:function(e,t){if(!e)return null;let i;return Qt(e)?e.clone():(i=(0,ne.T)(e.x,e.y,e.z,e.spatialReference),e.hasM&&(i.m=e.m,i.hasM=!0),i)}(e);return t&&e?(0,Hi.projectPoint)(e,r,t)?r:null:r}function Xs(e,t,i=null){const r=(0,F.o8)(F.Un);return null!=e&&(r[0]=e[0],r[1]=e[1],r[2]=e[2]),null!=t?r[3]=t:null!=e&&e.length>3&&(r[3]=e[3]),i&&(r[0]*=i,r[1]*=i,r[2]*=i,r[3]*=i),r}function Ks(e=I.Un,t,i,r=1){const s=new Array(3);if(null==t||null==i)s[0]=1,s[1]=1,s[2]=1;else{let r,n=0;for(let a=2;a>=0;a--){const o=e[a];let l;const c=null!=o,h=0===a&&!r&&!c,d=i[a];"symbol-value"===o||h?l=0!==d?t[a]/d:1:c&&"proportional"!==o&&isFinite(o)&&(l=0!==d?o/d:1),null!=l&&(s[a]=l,r=l,n=Math.max(n,Math.abs(l)))}for(let e=2;e>=0;e--)null==s[e]?s[e]=r:0===s[e]&&(s[e]=.001*n)}for(let e=2;e>=0;e--)s[e]/=r;return(0,I.ci)(s)}function en(e){return tn(function(e){return null!=e.isPrimitive}(e)?[e.width,e.depth,e.height]:e)?null:"Symbol sizes may not be negative values"}function tn(e){const t=e=>null==e||e>=0;return Array.isArray(e)?e.every(t):t(e)}function rn(e,t,i){if(null!=i.minDemResolution)return i.minDemResolution;const r=(0,E.GA)(t),s=(0,q.VL)(e)*r,n=(0,q.yr)(e)*r,a=(0,q.uJ)(e)*(t.isGeographic?1:r);return 0===s&&0===n&&0===a?i.minDemResolutionForPoints:.01*Math.max(s,n,a)}var sn=i(84989);class nn{constructor(e,t,i){this.baseMaterial=e,this.edgeMaterials=t,this.properties=i}}class an{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,t,i,r,s,n,a,o=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=i,this._uniqueMaterials=r,this._sharedResource=s,this.elevationAligner=n,this.elevationContext=a,this._edgeState=o,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e;const t=e.stage;t.addMany(this._uniqueMaterials),t.addMany(this._uniqueGeometries),t.add(this.stageObject)}destroy(){if(!this._stageLayer)return;const e=this._stageLayer.stage;e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),e.renderer.edgeView?.removeObject(this.stageObject),this.stageObject.dispose(),this._sharedResource?.release(),this._visible=!1,this._stageLayer=null}layerOpacityChanged(e,t){if(null==this._edgeState)return;const i=on(this._edgeState.baseMaterial);let r=!1;for(const e of this._edgeState.edgeMaterials)e.objectTransparency!==i&&(e.objectTransparency=i,r=!0);r&&this.resetEdgeObject(t),this._stageLayer.stage.renderer.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,t){null!=this._edgeState&&(this._stageLayer.stage.renderer.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:e},!t),this._edgeState.properties.hasSlicePlane=e)}setVisibility(e){if(null!=this._stageLayer&&this._visible!==e&&(this._visible=e,this.stageObject.visible=e,this._visible&&!this._addedToStage&&(this._stageLayer.add(this.stageObject),this._addedToStage=!0),this._edgeState)){const t=this._stageLayer.stage.renderer.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this._addOrUpdateEdgeObject(t,!1)}}get visible(){return this._visible}alignWithElevation(e,t,i,r){null!=this.elevationAligner&&(null!=i&&si(this.elevationContext.featureExpressionInfoContext,i),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,((i,r)=>Ft(i,e,this.elevationContext,t,r)),t),this.resetEdgeObject(r))}alignWithAbsoluteElevation(e,t,i){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,((t,i)=>{i.sampledElevation=e,i.verticalDistanceToGround=0,i.z=e}),t),this.resetEdgeObject(i)}getCenterObjectSpace(e=(0,I.vt)()){return(0,M.c)(e,(0,X.g)(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=(0,q.vt)()){const t=this.stageObject.boundingVolumeObjectSpace;return(0,q.Ne)(e,t.min),(0,q.vI)(e,t.max),e}computeAttachmentOrigin(e){const t=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++;else for(const i of this.stageObject.geometries)i.computeAttachmentOrigin(hn)&&((0,M.e)(hn,hn,t),(0,M.g)(e.render.origin,e.render.origin,hn),e.render.num++)}async getProjectedBoundingBox(e,t,i,r,s){const n=this.getBoundingBoxObjectSpace(s),a=dn,o=(0,q.fT)(n)?1:a.length;for(let e=0;e<o;e++){const t=a[e];cn[0]=n[t[0]],cn[1]=n[t[1]],cn[2]=n[t[2]],(0,M.e)(cn,cn,this.stageObject.transformation),ln[3*e]=cn[0],ln[3*e+1]=cn[1],ln[3*e+2]=cn[2]}if(!e(ln,0,o))return null;(0,q.Ie)(n);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let e=0;e<3*o;e+=3){for(let t=0;t<3;t++)n[t]=Math.min(n[t],ln[e+t]),n[t+3]=Math.max(n[t+3],ln[e+t]);l&&i.push({location:ln.slice(e,e+3),screenSpaceBoundingRect:l})}if(t?.service&&"absolute-height"!==this.elevationContext.mode){(0,q.gX)(n,hn);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let i=0;if(t.useViewElevation)i=t.service.getElevation(hn[0],hn[1],e)??0;else try{const s=rn(n,t.service.spatialReference,t);i=await t.service.queryElevation(hn[0],hn[1],r,s,e)??0}catch(e){}(0,q.cY)(n,0,0,-this.alignedSampledElevation+i)}return n}addObjectState(e,t){e===ge.Mg.Highlight&&t.addObject(this.stageObject,this.stageObject.highlight()),e===ge.Mg.MaskOccludee&&t.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}resetEdgeObject(e){if(null==this._edgeState)return;const t=this._stageLayer.stage.renderer.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(t,e):t.removeObject(this.stageObject)}_addOrUpdateEdgeObject(e,t){const i=this._edgeState;if(null==i)return;const r=on(i.baseMaterial);for(const e of i.edgeMaterials)e.objectTransparency=r;e.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!t).then((()=>this._stageLayer?.sync()))}}function on(e){return e.isVisible()?e.parameters.transparent?sn.x.TRANSPARENT:sn.x.OPAQUE:sn.x.INVISIBLE}const ln=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],cn=(0,I.vt)(),hn=(0,I.vt)(),dn=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];class un{constructor(e,t=null){this.labelText=t,this.elevationOffset=e??0}}var pn,fn,gn;!function(e){e[e.RecreateSymbol=0]="RecreateSymbol",e[e.RecreateGraphics=1]="RecreateGraphics",e[e.FastUpdate=2]="FastUpdate"}(pn||(pn={}));class mn{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=fn.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,t){return this._loadStatus===fn.LOADED?(e&&e(),this._loader??Promise.resolve()):this._loadStatus===fn.FAILED?(t&&t(this._loadError),this._loader??Promise.resolve()):(null==this._loader&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then((()=>{this._abortController=null,this._loadStatus=fn.LOADED}),(e=>{throw this._loadError=e,this._abortController=null,this._loadStatus=fn.FAILED,!(0,o.zf)(e)&&this.logger&&e.message&&this.logger.warn(e.message),e}))),this._loader.then(e,t).catch((()=>{})),this._loader)}abortLoad(){null!=this._abortController?this._abortController=(0,ce.DC)(this._abortController):this._loadStatus===fn.LOADING&&(this._loadStatus=fn.FAILED),this._loader=null}}(gn=fn||(fn={}))[gn.LOADING=0]="LOADING",gn[gn.LOADED=1]="LOADED",gn[gn.FAILED=2]="FAILED";var _n=i(15061);const yn=()=>a.A.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class vn extends mn{constructor(e,t,i,r){super(i.schedule),this.symbol=e,this.symbolLayer=t,this._context=i,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this._materials=[],this.usedMemory=0,this.logger=yn(),this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=r.renderPriority,this._renderPriorityStep=r.renderPriorityStep,this._elevationContext=new ci,this.complexity=this.computeComplexity(),this.ignoreDrivers=r.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=bn(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}_drivenPropertiesChanged(e){if(this.ignoreDrivers)return!1;const t=this._drivenProperties,i=bn(e);return i.color!==t.color||i.opacity!==t.opacity||i.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||i.size!==t.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,i,r){const s=e.projectionSuccess,n="polygons"in e?e.polygons:null,a=`${r} geometry failed to be created`;let o=null;s?!this._logGeometryValidationWarnings(t,i,r)&&n&&0===n.length&&"rings"===i&&t.length>0&&t[0].length>2&&(o=`${a} (filled rings should use clockwise winding - try reversing the order of vertices)`):o=`${a} (failed to project geometry to view spatial reference)`,o&&yn().warnOncePerTick(o)}_logGeometryValidationWarnings(e,t,i){const r=`${i} geometry failed to be created`;return!e.length||1===e.length&&!e[0].length?(yn().warnOncePerTick(`${r} (no ${t} were defined)`),!0):!(Array.isArray(e)&&Array.isArray(e[0])||(yn().warnOncePerTick(`${r} (${t} should be defined as a 2D array)`),0))}_validateGeometry(e,t=null,i=null){if(null!=t&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+i+` symbol: ${e.type}`),!1;if("point"===e.type){const t=e;if(!isFinite(t.x)||!isFinite(t.y))return yn().warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return xn}_defaultElevationInfoZ(){return Sn}_updateElevationContext(){null!=this._elevationInfoOverride?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,t=new ci){const i=e.geometry,r=this.getDefaultElevationInfo(i);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:r.unit,t.mode=this.getGeometryElevationMode(i,r),t.offsetMeters=this._elevationContext.meterUnitOffset??r.offset??0;const s=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;s&&(t.mode="relative-to-ground",t.offsetMeters=0);const n=s?ai:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(n,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}updateTransform(e,t,i,r){return!1}onRemoveGraphic(e){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(e,t=wn){let i=1;return this.draped||(i*=this._getLayerOpacity()),this._drivenProperties.opacity||(null!=e?i*=e.a:t.hasIntrinsicColor||(i=0)),i}_getCombinedOpacityAndColor(e,t=wn){const i=this._getCombinedOpacity(e,t);return this._drivenProperties.color?Xs(null,i):Xs(null!=e?y.A.toUnitRGB(e):I.Un,i)}_getVertexOpacityAndColor(e,t=null){const i=Xs(this._drivenProperties.color?e.color:null,this._drivenProperties.opacity?e.opacity:null);return t&&(i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t),i}isFastUpdatesEnabled(){return null!=this._fastUpdates}computeComplexity(){return ds(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,i){switch(e){case"opacity":return this.layerOpacityChanged(t,i),!0;case"elevationInfo":{const e=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,i,e)!==Mt.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(e,t,i){let r=Mt.UPDATE;return e.forEach((e=>{const s=t(e);if(null!=s){const t=e.graphic;this.setGraphicElevationContext(t,s.elevationContext),s.needsElevationUpdates=i(s.elevationContext.mode)}else r=Mt.RECREATE})),r}applyRendererDiff(e,t){return pn.RecreateSymbol}getFastUpdateAttrValues(e){if(!this._fastUpdates)return null;const t=this._fastUpdates.visualVariables,i=t.size?(0,_n.ul)(t.size.field,e):0,r=t.color?(0,_n.ul)(t.color.field,e):0,s=t.opacity?(0,_n.ul)(t.opacity.field,e):0;return(0,F.fA)(i,r,s,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&yn().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){return{drivenProperties:this._drivenProperties,getVisVarFields:()=>({size:this._fastUpdates?.visualVariables.size?.field??null,color:this._fastUpdates?.visualVariables.color?.field??null,opacity:this._fastUpdates?.visualVariables.opacity?.field??null,rotation:this._fastUpdates?.visualVariables.rotation?.field??null})}}}function bn(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach((e=>{switch(e.type){case"color":if(t.color=!0,e.stops)for(let i=0;i<e.stops.length;i++){const r=e.stops[i].color;r&&(t.opacity=!0,r.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0}})),t}const xn={mode:"on-the-ground",offset:0,unit:"meters"},Sn={mode:"absolute-height",offset:0,unit:"meters"},wn={hasIntrinsicColor:!1};var Cn=i(64159),Rn=i(45773),En=i(73411),An=i(32685),Tn=i(93550);class On extends En.J{get geometries(){return this._geometries}get transformation(){return this._transformation??P.zK}set transformation(e){this._transformation=(0,O.C)(this._transformation??(0,P.vt)(),e),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?(0,O.C)(this._shaderTransformation??(0,P.vt)(),e):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}constructor(e={}){super(),this.type=mr.X.Object,this._shaderTransformation=null,this._parentLayer=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerUid=e.layerUid,e.isElevationSource&&(this.lastValidElevationBB=new Pn),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){(0,yr.vA)(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._emit("geometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){const t=this._geometries.splice(e,1)[0];t&&(this._emit("geometryRemoved",{object:this,geometry:t}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,t,i=!1){this._emit("attributesChanged",{object:this,geometry:e,attribute:t,sync:i}),(0,It.b)(t)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const e of this._geometries)e.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new An.X(ge.Mg.MaskOccludee);for(const t of this._geometries)t.occludees=(0,Tn.Ci)(t.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometries)t.occludees=(0,Tn.PC)(t.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new An.X(ge.Mg.Highlight);for(const t of this._geometries)t.highlights=(0,Tn.Ci)(t.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const t of this._geometries)t.highlights=(0,Tn.PC)(t.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,t){return(0,O.lw)(t,this.transformation,e.transformation)}getCombinedShaderTransformation(e,t=(0,P.vt)()){return(0,O.lw)(t,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new Mn,this._validateBoundingVolume(this._bvWorldSpace,Vn.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new Mn,this._validateBoundingVolume(this._bvObjectSpace,Vn.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(e,t){const i=t===Vn.ObjectSpace;for(const t of this._geometries){const r=t.boundingInfo;r&&In(r,e,i?t.transformation:this.getCombinedShaderTransformation(t))}(0,M.k)((0,X.g)(e.bounds),e.min,e.max,.5);for(const t of this._geometries){const r=t.boundingInfo;if(null==r)continue;const s=i?t.transformation:this.getCombinedShaderTransformation(t),n=(0,Rn.hG)(s);(0,M.e)(Nn,r.center,s);const a=(0,M.p)(Nn,(0,X.g)(e.bounds)),o=r.radius*n;e.bounds[3]=Math.max(e.bounds[3],a+o)}}_invalidateBoundingVolume(){const e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&e&&this._parentLayer.notifyObjectBBChanged(this,e)}_emit(e,t){this._parentLayer&&this._parentLayer.events.emit(e,t)}get test(){const e=this;return{hasGeometry:t=>e._geometries.includes(t),getGeometryIndex:t=>e._geometries.indexOf(t)}}}class Pn{constructor(){this.min=(0,I.fA)(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=(0,I.fA)(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class Mn extends Pn{constructor(){super(...arguments),this.bounds=(0,X.d)()}}function In(e,t,i){const r=e.bbMin,s=e.bbMax;if((0,O.tZ)(i)){const e=(0,M.s)(Dn,i[12],i[13],i[14]);(0,M.g)(Fn,r,e),(0,M.g)(Ln,s,e);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],Fn[e]),t.max[e]=Math.max(t.max[e],Ln[e])}else if((0,M.e)(Fn,r,i),(0,M.i)(r,s))for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],Fn[e]),t.max[e]=Math.max(t.max[e],Fn[e]);else{(0,M.e)(Ln,s,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],Fn[e],Ln[e]),t.max[e]=Math.max(t.max[e],Fn[e],Ln[e]);for(let e=0;e<3;++e){(0,M.c)(Fn,r),(0,M.c)(Ln,s),Fn[e]=s[e],Ln[e]=r[e],(0,M.e)(Fn,Fn,i),(0,M.e)(Ln,Ln,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],Fn[e],Ln[e]),t.max[e]=Math.max(t.max[e],Fn[e],Ln[e])}}}const Dn=(0,I.vt)(),Fn=(0,I.vt)(),Ln=(0,I.vt)(),Nn=(0,I.vt)();var Vn;function Gn(e,t,i,r,s){const n=e.clippingExtent;if((0,Cn.g)(t,Bn,e.elevationProvider.spatialReference),null!=n&&!(0,q.Uc)(n,Bn))return null;(0,Cn.g)(t,Bn,e.renderCoordsHelper.spatialReference),i.localOrigin=e.localOriginFactory.getOrigin(Bn);const a=new On({geometries:[i],castShadow:!1,layerUid:e.layer.uid,graphicUid:s,usesVerticalDistanceToGround:!0});return{object:a,sampledElevation:Ut(a,t,e.elevationProvider,e.renderCoordsHelper,r)}}function Un(e,t,i){const r=e.elevationContext,s=i.spatialReference;(0,Cn.g)(t,Bn,s),r.centerPointInElevationSR=(0,ne.T)(Bn[0],Bn[1],t.hasZ?Bn[2]:0,null!=s?s:null)}function zn(e){switch(e.type){case"point":return e;case"polygon":case"extent":return Qs(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const i=(0,$s.$H)(t,(0,$s.Yl)(t)/2);return(0,ne.T)(i[0],i[1],i[2],e.spatialReference)}case"mesh":return e.origin}return null}!function(e){e[e.WorldSpace=0]="WorldSpace",e[e.ObjectSpace=1]="ObjectSpace"}(Vn||(Vn={}));const Bn=(0,I.vt)();var Hn=i(14571),jn=i(7724),Wn=i(77788),kn=i(76687),Zn=i(31272),qn=i(15449),$n=i(29290),Qn=i(21979),Jn=i(19362),Yn=i(74242),Xn=i(24441),Kn=i(63254),ea=i(15651);class ta extends Jn.w{initializeConfiguration(e,t){t.spherical=e.viewingMode===oe.RT.Global}initializeProgram(e){return new Xn.B(e.rctx,ta.shader.get().build(this.configuration),Yn.D)}setPipelineState(e){const t=e?_t.MT.ALWAYS:_t.MT.LESS;return this.configuration.depthHudEnabled?(0,ea.Ey)({depthTest:{func:t},depthWrite:ea.kn}):(0,ea.Ey)({blending:(0,ea.p3)(_t.dn.ONE,_t.dn.SRC_ALPHA,_t.dn.ONE_MINUS_SRC_ALPHA,_t.dn.ONE_MINUS_SRC_ALPHA),depthTest:{func:t},colorWrite:ea.wE})}initializePipeline(){return this.setPipelineState(this.configuration.multipassEnabled)}}ta.shader=new Qn.$(Kn.L,(()=>i.e(1734).then(i.bind(i,71734))));var ia=i(51662),ra=i(18693);class sa extends ra.E{constructor(){super(...arguments),this.screenCenterOffsetUnitsEnabled=!1,this.spherical=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.hasSlicePlane=!1,this.multipassEnabled=!1}}(0,r._)([(0,ia.W)()],sa.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,r._)([(0,ia.W)()],sa.prototype,"spherical",void 0),(0,r._)([(0,ia.W)()],sa.prototype,"occlusionTestEnabled",void 0),(0,r._)([(0,ia.W)()],sa.prototype,"hasVerticalOffset",void 0),(0,r._)([(0,ia.W)()],sa.prototype,"hasScreenSizePerspective",void 0),(0,r._)([(0,ia.W)()],sa.prototype,"depthHudEnabled",void 0),(0,r._)([(0,ia.W)()],sa.prototype,"depthHudAlignStartEnabled",void 0),(0,r._)([(0,ia.W)()],sa.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ia.W)()],sa.prototype,"multipassEnabled",void 0),(0,r._)([(0,ia.W)({constValue:!0})],sa.prototype,"hasSliceInVertexProgram",void 0),(0,r._)([(0,ia.W)({constValue:!1})],sa.prototype,"draped",void 0);class na extends Zn.im{get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}constructor(e){super(e,new oa),this.produces=new Map([[qn.N.LINE_CALLOUTS,e=>e===Wn.V.Color],[qn.N.LINE_CALLOUTS_HUD_DEPTH,e=>e===Wn.V.Color]]),this._configuration=new sa,this._uniqueMaterialIdentifier=na.uniqueMaterialIdentifier(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){const i=t?.slot!==qn.N.LINE_CALLOUTS;return this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=null!=this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective,this._configuration.depthHudEnabled=i,this._configuration.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration}intersect(){}createGLMaterial(e){return new aa(e)}createBufferWriter(){return new ha}validateParameters(e){const t=na.uniqueMaterialIdentifier(e);t!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=t)}static uniqueMaterialIdentifier(e){return JSON.stringify({horizontalScreenOffset:e.horizontalScreenOffset??0,centerOffsetUnits:e.centerOffsetUnits||"world"})}}class aa extends kn.A{beginSlot(e){return this.ensureTechnique(ta,e)}}class oa extends Zn.qA{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=[0,0,0,1],this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.depthHUDAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}}const la=(0,jn.BP)().vec3f(It.r.POSITION).vec3f(It.r.NORMAL).vec2f(It.r.UV0).vec4f(It.r.CENTEROFFSETANDDISTANCE),ca=[(0,Hn.fA)(0,0),(0,Hn.fA)(1,0),(0,Hn.fA)(0,1),(0,Hn.fA)(1,0),(0,Hn.fA)(1,1),(0,Hn.fA)(0,1)];class ha{constructor(){this.vertexBufferLayout=la}elementCount(e){return 6*e.attributes.get(It.r.POSITION).indices.length}write(e,t,i,r,s){(0,$n.Hk)(i.attributes.get(It.r.POSITION),e,r.position,s,6),(0,$n.p1)(i.attributes.get(It.r.NORMAL),t,r.normal,s,6),(0,$n.Ut)(i.attributes.get(It.r.CENTEROFFSETANDDISTANCE),r.centerOffsetAndDistance,s,6);for(let e=0;e<ca.length;++e)r.uv0.setVec(s+e,ca[e])}}class da extends vn{constructor(e,t){super(e,null,t,fa),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new na(this._materialParameters),this._context.stage.add(this._materials[0])}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}_perInstanceMaterialParameters(e){const t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get _materialParameters(){const e=new oa,t=this.symbol,i=t.callout;if(e.color=null!=i.color?y.A.toUnitRGBA(i.color):[0,0,0,0],e.color[3]*=this._getLayerOpacity(),e.size=(0,Ms.Lz)(i.size||0),t.verticalOffset){const{screenLength:i,minWorldLength:r,maxWorldLength:s}=t.verticalOffset;e.verticalOffset={screenLength:(0,Ms.Lz)(i),minWorldLength:r||0,maxWorldLength:null!=s?s:1/0}}e.borderColor=null!=i.border?.color?y.A.toUnitRGBA(i.border.color):null;const r="object"===t.symbolLayers.at(0).type,s="label-3d"===t.type;return e.occlusionTest=!r,e.shaderPolygonOffset=r?0:void 0,e.depthHUDAlignStart=s,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return pa}createGraphics3DGraphic(e){const t=e.renderingInfo,i=e.graphic,r=this.setGraphicElevationContext(i,new ci,t.elevationOffset||0),s=t.symbol,n="on-the-ground"===this._elevationContext.mode&&("cim"===s.type||!s.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==s.type&&n)return null;if("point-3d"===s.type&&s.symbolLayers.every((e=>"text"===e.type&&!(0,Ps.Ie)(e))))return null;const a=Qs(i.geometry);return null==a?null:this._createAs3DShape(a,r,t,i.uid)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=Nt(da.elevationModeChangeTypes,i,r);return s!==Mt.UPDATE||e.forEach((e=>{const i=t(e);null!=i&&this.updateGraphicElevationContext(e.graphic,i)})),s}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(e,t,i=0){return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(i),t}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,null!=t.metadata?t.metadata.elevationOffset:0),t.needsElevationUpdates=Vt(t.elevationContext.mode)}computeComplexity(){return new ts({verticesPerFeature:6})}_createVertexData(e){const{translation:t,centerOffset:i}=e,r=new gr.n(t?[t[0],t[1],t[2]]:[0,0,0],ua,3,!0),s=new gr.n(i?[i[0],i[1],i[2],i[3]]:[0,0,0,1],ua,4,!0);return[[It.r.POSITION,r],[It.r.NORMAL,new gr.n([0,0,1],ua,3,!0)],[It.r.CENTEROFFSETANDDISTANCE,s]]}_getOrCreateMaterial(e){const t=this._perInstanceMaterialParameters(e),i=na.uniqueMaterialIdentifier(t);if(i===this._materials[0]?.uniqueMaterialIdentifier)return{material:this._materials[0],isUnique:!1};if(null!=e.materialCollection){let r=e.materialCollection.get(i);return null==r&&(r=new na(t),e.materialCollection.add(i,r)),{material:r,isUnique:!1}}return{material:new na(t),isUnique:!0}}_createAs3DShape(e,t,i,r){const s=this._context.layer.uid,n=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerUid:s}),a=this._getOrCreateMaterial(i),o=new _r.V(a.material,this._createVertexData(i),null,mr.X.Point,n),l=Gn(this._context,e,o,t,r);if(null==l)return null;const c=new an(this,l.object,[o],a.isUnique?[a.material]:null,null,Ls,t);return c.metadata=new un(i.elevationOffset),c.alignedSampledElevation=l.sampledElevation,c.needsElevationUpdates=Vt(t.mode),Un(c,e,this._context.elevationProvider),c}}da.elevationModeChangeTypes={definedChanged:Mt.UPDATE,staysOnTheGround:Mt.UPDATE,onTheGroundChanged:Mt.RECREATE};const ua=[0],pa={mode:"relative-to-ground",offset:0},fa={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class ga{constructor(e,t,i=(0,I.vt)(),r=(0,F.vt)(),s=0,n="world",a=0,o=null){this.renderer=e,this.symbol=t,this.translation=i,this.centerOffset=r,this.horizontalScreenOffset=s,this.centerOffsetUnits=n,this.elevationOffset=a,this.materialCollection=o}}const ma=()=>a.A.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function _a(e,t){if(!(0,Ps.YX)(e))return ma().error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const i=ya[e.callout.type];return i?new i(e,t):(ma().error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)}const ya={line:da};var va=i(88188),ba=i(39744),xa=i(53334),Sa=i(65648),wa=i(5525);const Ca=new ba.A(Array,(e=>(0,q.hZ)(e,q.v_)),null,10,5),Ra=(0,$.vt)();class Ea{get labelLayers(){return this._labelLayers||b.tR}get extent(){return this._extent}get isElevationSource(){return this.layers.some((e=>e?.isElevationSource))}constructor(e,t,i,r,s){this.graphic=e,this.graphics3DSymbol=t,this.layers=i,this._visibleFlags=_s.ALL_LABEL,this.deconflictionPriority=0,++t.referenced,this._featureExpressionFeature=s?ri(s,e,r):null}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic((t=>{t.initialize(e),t.setVisibility(this.isVisible())}))}destroy(){this._forEachSymbolLayerGraphic((e=>e.destroy())),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.layers}clearLabelGraphics(){this._forEachLabelGraphic((e=>e.destroy())),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(t),e.setVisibility(this.isVisible(ys.LABEL))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic((t=>{"draped"===t.type&&(e=!0)})),e}isVisible(e=ys.GRAPHIC,t){const i=t?this._visibleFlags|t|ys.LABEL*t:this._visibleFlags;return e===ys.GRAPHIC?(i&_s.ALL_GRAPHIC)===_s.ALL_GRAPHIC:(i&_s.ALL_LABEL)===_s.ALL_LABEL}setVisibilityFlag(e,t,i){const r=this.isVisible(e);i?this._visibleFlags|=e*t:this._visibleFlags&=~(e*t);const s=this.isVisible(e);if(r===s)return!1;if(e===ys.LABEL)this._forEachLabelGraphic((e=>e.setVisibility(s)));else{this._forEachSymbolLayerGraphic((e=>e.setVisibility(s)));const e=this.isVisible(ys.LABEL);this._forEachLabelGraphic((t=>t.setVisibility(e)))}return!0}getVisibilityFlag(e,t){return 0!=(this._visibleFlags&e*t)}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(null==t)return!1;this._extent=(0,$.vt)(),(0,ki.iQ)(t,this._extent);const i=t.spatialReference;if(!(0,G.aI)(i,e)&&!ee(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,i){let r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=Sa.A.fromExtent("mesh"===r.type?r.extent:r)),(0,wa.Ux)(r,t,i)}get usedMemory(){let e=(0,va.eY)(this.graphic.attributes);return this._forEachSymbolLayerGraphic((t=>e+=t.graphics3DSymbolLayer.usedMemory)),e}computeAttachmentOrigin(){const e={render:{origin:(0,I.vt)(),num:0},draped:{origin:(0,dr.vt)(),num:0}};for(const t of this.layers)null!=t&&t.computeAttachmentOrigin(e);return e.render.num>1&&(0,M.h)(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&(0,xa.hs)(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,i,r,s){return s||(s={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),s.boundingBox?(0,q.Ie)(s.boundingBox):s.boundingBox=(0,q.Ie)(),s.requiresDrapedElevation=!1,await(0,dt.jJ)(this.layers,(async n=>{if(null==n)return;const a="draped"===n.type?t:e,o=Ca.acquire(),l=await n.getProjectedBoundingBox(a,i,s.screenSpaceObjects,r,o);isFinite(l[2])&&isFinite(l[5])||(s.requiresDrapedElevation=!0),l&&(0,q.RF)(s.boundingBox,o),Ca.release(o)})),(0,q.vQ)(s.boundingBox)||(0,$.vQ)((0,q.ES)(s.boundingBox,Ra))?s:null}needsElevationUpdates(){for(const e of this.layers)if(null!=e&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;return this._labelLayers?.some((e=>e?.needsElevationUpdates??!1))??!1}alignWithElevation(e,t,i){this._forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,t,this._featureExpressionFeature,i)}))}alignWithAbsoluteElevation(e,t,i){this._forEachRenderedGraphic((r=>{"object3d"===r.type&&r.alignWithAbsoluteElevation(e,t,i)}))}addObjectStateSet(e,t){this._forEachSymbolLayerGraphic((i=>i.addObjectState(e,t)))}removeObjectState(e){this._forEachSymbolLayerGraphic((t=>t.removeObjectState(e)))}_forEachGraphicList(e,t){e?.forEach((e=>e&&t(e)))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this._labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){const e=this;return{addLabelLayer:t=>{e._labelLayers||(e._labelLayers=new Array),e._labelLayers.push(t)}}}}var Aa=i(91814),Ta=i(72449),Oa=i(23756);function Pa(e,t){if(!e||e.symbol)return null;const i=t?.renderer;return e&&null!=i&&i.getObservationRenderer?i.getObservationRenderer(e):i}var Ma,Ia,Da,Fa=i(72104),La=i(30544),Na=i(98592);!function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"}(Ma||(Ma={})),function(e){e[e.MapLayer=0]="MapLayer",e[e.ViewLayer=1]="ViewLayer",e[e.Outline=2]="Outline",e[e.SnappingHint=3]="SnappingHint"}(Ia||(Ia={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(Da||(Da={}));var Va,Ga,Ua=i(68986);class za{constructor(e,t){this.vec3=e,this.id=t}}function Ba(e,t,i,r){return new za((0,I.fA)(e,t,i),r)}class Ha{constructor(){this._extent=(0,$.vt)(),this.resolution=0,this.renderLocalOrigin=Ba(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new ja}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this._extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,$.cY)(this._extent,e.range,0,t)}if(this._extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,$.cY)(this._extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,(0,$.C)(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}}class ja{constructor(){this.extents=[(0,$.vt)(),(0,$.vt)(),(0,$.vt)()],this.numViews=0}}(Ga=Va||(Va={}))[Ga.Color=0]="Color",Ga[Ga.ColorNoRasterImage=1]="ColorNoRasterImage",Ga[Ga.Highlight=2]="Highlight",Ga[Ga.WaterNormal=3]="WaterNormal",Ga[Ga.Occluded=4]="Occluded",Ga[Ga.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor";class Wa{constructor(e,t,i){this._fbos=e,this._format=t,this._name=i}get valid(){return null!=this._handle?.getTexture()}dispose(){this._handle=(0,ce.Gz)(this._handle)}get texture(){return this._handle?.getTexture()}bind(e,t,i){this._handle&&this._handle.fbo.width===t&&this._handle.fbo.height===i||(this._handle?.release(),this._handle=this._fbos.acquire(t,i,this._name,this._format)),e.unbindTexture(this._handle?.fbo.colorTexture),e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}}var ka=i(38236);class Za{constructor(e,t,i,r,s=ka.N.RGBA_MIPMAP){this.output=i,this.content=r,this.fbo=new Wa(e,s,t)}get valid(){return this.fbo.valid}}class qa{constructor(e){this.targets=[new Za(e,"overlay color",Wn.V.Color,Va.Color),new Za(e,"overlay IM color",Wn.V.Color,Va.ColorNoRasterImage),new Za(e,"overlay highlight",Wn.V.Highlight,Va.Highlight,ka.N.RGBA4),new Za(e,"overlay water",Wn.V.Normal,Va.WaterNormal),new Za(e,"overlay occluded",Wn.V.Color,Va.Occluded)],(0,d.A)("enable-feature:objectAndLayerId-rendering")&&this.targets.push(new Za(e,"overlay oid",Wn.V.ObjectAndLayerIdColor,Va.ObjectAndLayerIdColor))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(){for(const e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce(((e,t,i)=>t.valid?e|=1<<i:e),0)}}var $a,Qa=i(83143);Qa.Zo,function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight"}($a||($a={})),i(40574);var Ja=i(35212),Ya=(i(25853),i(7804));i(34088),Ya.n,i(19635);var Xa,Ka=i(41014);i(19778),function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"}(Xa||(Xa={})),Ya.n,(0,F.vt)();var eo=i(30607),to=i(13926);class io{constructor(e){this._context=e,this._perConstructorInstances=new to.O,this._frameCounter=0,this._keepAliveFrameCount=so}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.destroy())))),this._perConstructorInstances.clear()}acquire(e,t=no){const i=t.key;let r=this._perConstructorInstances.get(e,i);if(null==r){const s=new e(this._context,t,(()=>this.release(s)));r=new ro(s),this._perConstructorInstances.set(e,i,r)}return++r.refCount,r.technique}releaseAndAcquire(e,t,i){if(null!=i){if(t.key===i.key)return i;this.release(i)}return this.acquire(e,t)}release(e){if(null==e||this._perConstructorInstances.empty)return;const t=this._perConstructorInstances.get(e.constructor,e.key);null!=t&&(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==so&&this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((e,i)=>{0===e.refCount&&e.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(e.technique.destroy(),this._perConstructorInstances.delete(t,i))}))}))}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach(((t,i)=>{e.push((async(e,t)=>{const i=t.shader;i&&(await i.reload(),e.forEach((e=>e.technique.reload(this._context))))})(t,i))})),await Promise.all(e)}}class ro{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}const so=-1,no=new ia.K;var ao,oo=i(45845),lo=i(74695);let co=ao=class extends n.A{constructor(e){super(e),this._ray=(0,fr.vt)(),this._viewport=(0,F.fA)(0,0,1,1),this._padding=(0,F.fA)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,dr.fA)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,P.vt)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,P.vt)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,P.vt)(),this._frustumDirty=!0,this._frustum=(0,Rt.vt)(),this._fullViewport=(0,F.vt)(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=(0,I.vt)(),this._up=(0,I.vt)(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get rows(){return this._rows}set rows(e){this._rows=Math.max(1,e)}get columns(){return this._columns}set columns(e){this._columns=Math.max(1,e)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,"_center")}get ray(){return(0,M.f)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){(0,O.C)(this._viewMatrix,e),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),(0,M.s)((0,I.vt)(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),(0,M.s)((0,I.vt)(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),(0,M.s)((0,I.vt)(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(1===this.pixelRatio)return this._viewport;const e=(0,D.d)((0,F.vt)(),this._viewport,1/this.pixelRatio),t=this._get("screenViewport");return t&&(0,D.e)(e,t)?t:e}get screenPadding(){if(1===this.pixelRatio)return this._padding;const e=(0,D.d)((0,F.vt)(),this._padding,1/this.pixelRatio),t=this._get("screenPadding");return t&&(0,D.e)(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[mo.LEFT],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(e){e+=this._padding[mo.BOTTOM],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[mo.RIGHT]+this._padding[mo.LEFT]}set fullWidth(e){this.width=e-(this._padding[mo.RIGHT]+this._padding[mo.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[mo.TOP]+this._padding[mo.BOTTOM]}set fullHeight(e){this.height=e-(this._padding[mo.TOP]+this._padding[mo.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[mo.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[mo.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){(0,D.a)(this._padding,e)||(this._viewport[0]+=e[mo.LEFT]-this._padding[mo.LEFT],this._viewport[1]+=e[mo.BOTTOM]-this._padding[mo.BOTTOM],this._viewport[2]-=e[mo.RIGHT]+e[mo.LEFT]-(this._padding[mo.RIGHT]+this._padding[mo.LEFT]),this._viewport[3]-=e[mo.TOP]+e[mo.BOTTOM]-(this._padding[mo.TOP]+this._padding[mo.BOTTOM]),(0,D.c)(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&((0,O.lw)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){const e=this.width,t=this.height,i=this.near*Math.tan(this.fovY/2)*2,r=i*this._aspect,s=i/this.rows,n=r/this.columns,a=-r/2+this.column*n,o=a+n,l=-i/2+this.row*s,c=l+s,h=(0,O.$h)((0,P.vt)(),a*(1+2*this._padding[mo.LEFT]/e),o*(1+2*this._padding[mo.RIGHT]/e),l*(1+2*this._padding[mo.BOTTOM]/t),c*(1+2*this._padding[mo.TOP]/t),this.near,this.far),d=this._get("projectionMatrix");return d&&(0,O.aI)(d,h)?d:h}get inverseProjectionMatrix(){return(0,O.B8)((0,P.vt)(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||(0,P.vt)()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return function(e,t,i){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}(this._fov,this.width,this.height)}set fovX(e){this._fov=function(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/t)}(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return function(e,t,i){return 2*Math.atan(i*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}(this._fov,this.width,this.height)}set fovY(e){this._fov=function(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/i)}(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return(0,M.p)(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,O.B8)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,O.mg)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return null!=this.relativeElevation&&this.relativeElevation>=0}copyFrom(e){(0,M.c)(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,(0,D.c)(this._viewport,e.viewport),this.notifyChange("_viewport"),(0,D.c)(this._padding,e.padding),this.notifyChange("_padding"),(0,xa.C)(this._nearFar,e.nearFar),this.notifyChange("_nearFar"),this._fov=e.fov,this.row=e.row,this.column=e.column,this.rows=e.rows,this.columns=e.columns,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||((0,O.C)(this._viewMatrix,e.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||((0,Rt.C)(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,O.C)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,D.c)(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return(new ao).copyFrom(this)}equals(e){return(0,M.i)(this.eye,e.eye)&&(0,M.i)(this.center,e.center)&&(0,M.i)(this.up,e.up)&&(0,D.a)(this._viewport,e.viewport)&&(0,D.a)(this._padding,e.padding)&&(0,xa.t2)(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation&&this.row===e.row&&this.column===e.column&&this.rows===e.rows&&this.columns===e.columns}almostEquals(e){const t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||(0,D.f)(e.screenPadding,this.screenPadding)>=t||(0,D.f)(this.screenViewport,e.screenViewport)>=t||this.row!==e.row||this.column!==e.column||this.rows!==e.rows||this.columns!==e.columns)return!1;(0,M.y)(po,e.eye,e.center),(0,M.y)(fo,this.eye,this.center);const i=(0,M.j)(po,fo),r=(0,M.w)(po),s=(0,M.w)(fo),n=5e-4;return i*i>=(1-1e-10)*r*s&&(0,M.v)(e.eye,this.eye)<Math.max(r,s)*n*n}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs((0,lo.gr)(this.viewForward,(0,M.f)(po,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=(0,Ms.gs)()){return e[0]=(this.padding[mo.LEFT]+this.width/2)/this.pixelRatio,e[1]=(this.padding[mo.TOP]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,i=.5){return e[0]=this.padding[mo.LEFT]+this.width*t,e[1]=this.padding[mo.BOTTOM]+this.height*i,e[2]=.5,e}setGLViewport(e){const t=this.viewport,i=this.padding;e.setViewport(t[0]-i[3],t[1]-i[2],t[2]+i[1]+i[3],t[3]+i[0]+i[2])}applyProjection(e,t){e!==ho&&(0,M.c)(ho,e),ho[3]=1,(0,D.t)(ho,ho,this.projectionMatrix);const i=Math.abs(ho[3]);(0,M.h)(ho,ho,1/i);const r=this.fullViewport;t[0]=(0,U.Cc)(0,r[0]+r[2],.5+.5*ho[0]),t[1]=(0,U.Cc)(0,r[1]+r[3],.5+.5*ho[1]),t[2]=.5*(ho[2]+1),t[3]=i}unapplyProjection(e,t){const i=this.fullViewport;ho[0]=(e[0]/(i[0]+i[2])*2-1)*e[3],ho[1]=(e[1]/(i[1]+i[3])*2-1)*e[3],ho[2]=(2*e[2]-1)*e[3],ho[3]=e[3],null!=this.inverseProjectionMatrix&&((0,D.t)(ho,ho,this.inverseProjectionMatrix),t[0]=ho[0],t[1]=ho[1],t[2]=ho[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,go),this.renderToScreen(go,t),t}projectToRenderScreen(e,t){if(ho[0]=e[0],ho[1]=e[1],ho[2]=e[2],ho[3]=1,(0,D.t)(ho,ho,this.viewProjectionMatrix),0===ho[3])return null;const i=ho;(0,M.h)(i,i,1/Math.abs(ho[3]));const r=this.fullViewport,s=(0,U.Cc)(0,r[0]+r[2],.5+.5*i[0]),n=(0,U.Cc)(0,r[1]+r[3],.5+.5*i[1]);return"x"in t?(t.x=s,t.y=n):(t[0]=s,t[1]=n,t.length>2&&(t[2]=.5*(i[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,go),t)}unprojectFromRenderScreen(e,t){if((0,O.lw)(uo,this.projectionMatrix,this.viewMatrix),!(0,O.B8)(uo,uo))return null;const i=this.fullViewport;return ho[0]=2*(e[0]-i[0])/i[2]-1,ho[1]=2*(e[1]-i[1])/i[3]-1,ho[2]=2*e[2]-1,ho[3]=1,(0,D.t)(ho,ho,uo),0===ho[3]?null:(t[0]=ho[0]/ho[3],t[1]=ho[1]/ho[3],t[2]=ho[2]/ho[3],t)}constrainWindowSize(e,t,i,r){const s=e*this.pixelRatio,n=t*this.pixelRatio,a=Math.max(s-i/2,0),o=Math.max(this.fullHeight-n-r/2,0),l=-Math.min(s-i/2,0),c=-Math.min(this.fullHeight-n-r/2,0),h=i-l- -Math.min(this.fullWidth-s-i/2,0),d=r-c- -Math.min(n-r/2,0);return[Math.round(a),Math.round(o),Math.round(h),Math.round(d)]}computeUp(e){e===oe.RT.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){const i=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=i,t[1]=r,t}renderToScreen(e,t){const i=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;t[0]=i,t[1]=r}_computeUpGlobal(){(0,M.f)(po,this.center,this.eye);const e=(0,M.l)(this.center);e<1?((0,M.s)(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs((0,M.j)(po,this.center))>.9999*(0,M.l)(po)*e||((0,M.b)(this._up,po,this.center),(0,M.b)(this._up,this._up,po),(0,M.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){(0,M.D)(po,this.eye,this.center),Math.abs(po[2])<=.9999&&((0,M.h)(po,po,po[2]),(0,M.s)(this._up,-po[0],-po[1],1-po[2]),(0,M.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(e,t,i=""){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?(0,M.i)(e,t)||((0,M.c)(t,e),this._markViewDirty(),i.length&&this.notifyChange(i)):a.A.getLogger("esri.views.3d.webgl-engine.lib.Camera").warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&((0,Rt.ui)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&((0,O.t5)(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};(0,r._)([(0,h.MZ)()],co.prototype,"_viewport",void 0),(0,r._)([(0,h.MZ)()],co.prototype,"_padding",void 0),(0,r._)([(0,h.MZ)()],co.prototype,"_fov",void 0),(0,r._)([(0,h.MZ)()],co.prototype,"_nearFar",void 0),(0,r._)([(0,h.MZ)()],co.prototype,"_viewDirty",void 0),(0,r._)([(0,h.MZ)()],co.prototype,"_viewMatrix",void 0),(0,r._)([(0,h.MZ)()],co.prototype,"_pixelRatio",void 0),(0,r._)([(0,h.MZ)()],co.prototype,"pixelRatio",null),(0,r._)([(0,h.MZ)()],co.prototype,"row",void 0),(0,r._)([(0,h.MZ)()],co.prototype,"column",void 0),(0,r._)([(0,h.MZ)()],co.prototype,"_rows",void 0),(0,r._)([(0,h.MZ)()],co.prototype,"rows",null),(0,r._)([(0,h.MZ)()],co.prototype,"_columns",void 0),(0,r._)([(0,h.MZ)()],co.prototype,"columns",null),(0,r._)([(0,h.MZ)()],co.prototype,"eye",null),(0,r._)([(0,h.MZ)()],co.prototype,"center",null),(0,r._)([(0,h.MZ)()],co.prototype,"_center",void 0),(0,r._)([(0,h.MZ)()],co.prototype,"up",null),(0,r._)([(0,h.MZ)()],co.prototype,"_up",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],co.prototype,"viewForward",null),(0,r._)([(0,h.MZ)({readOnly:!0})],co.prototype,"viewUp",null),(0,r._)([(0,h.MZ)({readOnly:!0})],co.prototype,"viewRight",null),(0,r._)([(0,h.MZ)({readOnly:!0})],co.prototype,"nearFar",null),(0,r._)([(0,h.MZ)()],co.prototype,"near",null),(0,r._)([(0,h.MZ)()],co.prototype,"far",null),(0,r._)([(0,h.MZ)()],co.prototype,"viewport",null),(0,r._)([(0,h.MZ)({readOnly:!0})],co.prototype,"screenViewport",null),(0,r._)([(0,h.MZ)({readOnly:!0})],co.prototype,"screenPadding",null),(0,r._)([(0,h.MZ)()],co.prototype,"x",null),(0,r._)([(0,h.MZ)()],co.prototype,"y",null),(0,r._)([(0,h.MZ)()],co.prototype,"width",null),(0,r._)([(0,h.MZ)()],co.prototype,"height",null),(0,r._)([(0,h.MZ)()],co.prototype,"fullWidth",null),(0,r._)([(0,h.MZ)()],co.prototype,"fullHeight",null),(0,r._)([(0,h.MZ)({readOnly:!0})],co.prototype,"_aspect",null),(0,r._)([(0,h.MZ)()],co.prototype,"padding",null),(0,r._)([(0,h.MZ)({readOnly:!0})],co.prototype,"projectionMatrix",null),(0,r._)([(0,h.MZ)({readOnly:!0})],co.prototype,"inverseProjectionMatrix",null),(0,r._)([(0,h.MZ)()],co.prototype,"fov",null),(0,r._)([(0,h.MZ)()],co.prototype,"fovX",null),(0,r._)([(0,h.MZ)()],co.prototype,"fovY",null),co=ao=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.Camera")],co);const ho=(0,F.vt)(),uo=(0,P.vt)(),po=(0,I.vt)(),fo=(0,I.vt)(),go=(0,Ms.r_)();var mo;!function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"}(mo||(mo={}));class _o{constructor(e,t,i,r){this._textureRepository=e,this._techniqueRepository=t,this.materialChanged=i,this.requestRender=r,this._id2glMaterialRef=new to.O}dispose(){this._textureRepository.destroy()}acquire(e,t,i){this._ownMaterial(e);const r=e.produces.get(t);if(!r||!r(i))return null;let s=this._id2glMaterialRef.get(i,e.id);if(null==s){const t=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRepository:this._textureRepository,output:i});s=new yo(t),this._id2glMaterialRef.set(i,e.id,s)}return s.ref(),s.glMaterial}release(e,t){const i=this._id2glMaterialRef.get(t,e.id);null!=i&&(i.unref(),i.referenced||((0,ce.WD)(i.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&a.A.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}}class yo{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,(0,yr.vA)(this._refCnt>=0)}get referenced(){return this._refCnt>0}}var vo=i(56802);const bo=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];var xo,So,wo=i(935);(So=xo||(xo={}))[So.ASYNC=0]="ASYNC",So[So.SYNC=1]="SYNC";class Co extends En.J{get objects(){return this._objects}constructor(e,t,i=""){super(),this.stage=e,this.apiLayerUid=i,this.type=mr.X.Layer,this.events=new xs.A,this.visible=!0,this.pickable=!0,this.sliceable=!1,this._objects=new C.A,this._objectsAdded=new C.A,this._handles=new vo.A,this.apiLayerUid=i,this.visible=t?.visible??!0,this.pickable=t?.pickable??!0,this.updatePolicy=t?.updatePolicy??xo.ASYNC,this._disableOctree=t?.disableOctree??!1,e.add(this);for(const t of bo)this._handles.add(this.events.on(t,(i=>e.handleEvent(t,i))))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),null!=this._octree&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),null!=this._octree&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),null!=this._octree&&this._objectsAdded.pushArray(e)}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),null!=this._octree){for(let e=0;e<t.length;)this._objectsAdded.removeUnordered(t[e])?(t[e]=t[t.length-1],t.length-=1):++e;this._octree.remove(t)}}}sync(){this.updatePolicy!==xo.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){null==this._octree||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return null==this._octree&&this._objects.length>50&&!this._disableOctree?(this._octree=new wo.A((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)):null!=this._octree&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}invalidateSpatialQueryAccelerator(){this._octree=(0,ce.pR)(this._octree),this._objectsAdded.clear()}}var Ro=i(94669),Eo=i(34383),Ao=i(18994),To=i(46348),Oo=i(8445),Po=i(28116),Mo=i(7782);const Io=new Map([[It.r.POSITION,0],[It.r.PREVPOSITION,1],[It.r.NEXTPOSITION,2],[It.r.SUBDIVISIONFACTOR,3],[It.r.UV0,4],[It.r.COLOR,5],[It.r.COLORFEATUREATTRIBUTE,5],[It.r.SIZE,6],[It.r.SIZEFEATUREATTRIBUTE,6],[It.r.OPACITYFEATUREATTRIBUTE,7],[It.r.OBJECTANDLAYERIDCOLOR,8]]);class Do extends Jn.w{initializeProgram(e){return new Xn.B(e.rctx,Do.shader.get().build(this.configuration),Io)}_makePipelineState(e,t){const i=this.configuration,r=e===Mo.y.NONE,s=e===Mo.y.FrontFace,n=(0,Wn.cb)(i.output);return(0,ea.Ey)({blending:i.output===Wn.V.Color||i.output===Wn.V.Alpha?r?Oo.V0:(0,Oo.ez)(e):null,depthTest:{func:(0,Oo.K_)(e)},depthWrite:r?i.writeDepth||n?ea.kn:null:(0,Oo.XO)(e),colorWrite:ea.wE,stencilWrite:i.hasOccludees?Po.v0:null,stencilTest:i.hasOccludees?t?Po.a9:Po.qh:null,polygonOffset:r||s?i.hasPolygonOffset?Fo:null:Oo.SE})}initializePipeline(){const e=this.configuration;if(e.occluder){const t=e.hasPolygonOffset?Fo:null;this._occluderPipelineTransparent=(0,ea.Ey)({blending:Oo.V0,polygonOffset:t,depthTest:Po.sf,depthWrite:null,colorWrite:ea.wE,stencilWrite:null,stencilTest:Po.mK}),this._occluderPipelineOpaque=(0,ea.Ey)({blending:Oo.V0,polygonOffset:t,depthTest:Po.sf,depthWrite:null,colorWrite:ea.wE,stencilWrite:Po.r8,stencilTest:Po.I$}),this._occluderPipelineMaskWrite=(0,ea.Ey)({blending:null,polygonOffset:t,depthTest:Po.m,depthWrite:null,colorWrite:null,stencilWrite:Po.v0,stencilTest:Po.a9})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?_t.WR.LINES:_t.WR.TRIANGLE_STRIP}getPipeline(e,t,i){return e?this._occludeePipelineState:this.configuration.occluder?i?this._occluderPipelineTransparent:t?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}}Do.shader=new Qn.$(To.R,(()=>i.e(3740).then(i.bind(i,53740))));const Fo={factor:0,units:-4};var Lo,No=i(47268);!function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(Lo||(Lo={}));class Vo extends Zn.im{constructor(e){super(e,new Uo),this._configuration=new No.Q,this.produces=new Map([[qn.N.OPAQUE_MATERIAL,e=>e===Wn.V.Highlight||e===Wn.V.ObjectAndLayerIdColor||(e===Wn.V.Color||e===Wn.V.Alpha)&&this.parameters.renderOccluded===Zn.m$.OccludeAndTransparentStencil],[qn.N.OPAQUE_NO_SSAO_DEPTH,e=>e===Wn.V.LinearDepth],[qn.N.OCCLUDER_MATERIAL,e=>(0,Wn.Mo)(e)&&this.parameters.renderOccluded===Zn.m$.OccludeAndTransparentStencil],[qn.N.TRANSPARENT_OCCLUDER_MATERIAL,e=>(0,Wn.Mo)(e)&&this.parameters.renderOccluded===Zn.m$.OccludeAndTransparentStencil],[qn.N.TRANSPARENT_MATERIAL,e=>(e===Wn.V.Color||e===Wn.V.Alpha)&&this.parameters.writeDepth&&this.parameters.renderOccluded!==Zn.m$.OccludeAndTransparentStencil],[qn.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>(e===Wn.V.Color||e===Wn.V.Alpha)&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==Zn.m$.OccludeAndTransparentStencil],[qn.N.DRAPED_MATERIAL,e=>(0,Wn.i3)(e)]]),this._vertexAttributeLocations=Io}getConfiguration(e,t){this._configuration.output=e,this._configuration.draped=t.slot===qn.N.DRAPED_MATERIAL;const i=null!=this.parameters.stipplePattern&&e!==Wn.V.Highlight;return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&null!=this.parameters.stippleOffColor,this._configuration.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=null!=this.parameters.markerParameters&&function(e){return e.anchor===Ao.kJ.Tip&&e.hideOnShortSegments&&"begin-end"===e.placement&&e.worldSpace}(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&null!=this.parameters.innerColor,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===Zn.m$.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,t,i,r,s,n){if(!i.options.selectionMode)return;const a=e.attributes.get(It.r.POSITION).data,o=e.attributes.get(It.r.SIZE);let l=this.parameters.width;if(this.parameters.vvSize){const t=e.attributes.get(It.r.SIZEFEATUREATTRIBUTE).data[0];l*=(0,U.qE)(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o&&(l*=o.data[0]);const c=r[0],h=r[1],d=(l/2+4)*e.screenToWorldRatio;let u=Number.MAX_VALUE,p=0;for(let e=0;e<a.length-5;e+=3){const t=a[e],i=a[e+1],r=c-t,s=h-i,n=a[e+3]-t,o=a[e+4]-i,l=(0,U.qE)((n*r+o*s)/(n*n+o*o),0,1),d=n*l-r,f=o*l-s,g=d*d+f*f;g<u&&(u=g,p=e/3)}u<d*d&&s(n.dist,n.normal,p,!1)}intersect(e,t,i,r,s,n){if(!i.options.selectionMode||!e.visible)return;if(!(0,yr.zH)(t))return void a.A.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const o=e.attributes,l=o.get(It.r.POSITION).data;let c=this.parameters.width;if(this.parameters.vvSize){const e=o.get(It.r.SIZEFEATUREATTRIBUTE).data[0];c*=(0,U.qE)(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o.has(It.r.SIZE)&&(c*=o.get(It.r.SIZE).data[0]);const h=i.camera,d=qo;(0,xa.C)(d,i.point);const u=c*h.pixelRatio/2+4*h.pixelRatio;(0,M.s)(rl[0],d[0]-u,d[1]+u,0),(0,M.s)(rl[1],d[0]+u,d[1]+u,0),(0,M.s)(rl[2],d[0]+u,d[1]-u,0),(0,M.s)(rl[3],d[0]-u,d[1]-u,0);for(let e=0;e<4;e++)if(!h.unprojectFromRenderScreen(rl[e],sl[e]))return;(0,pr.Cr)(h.eye,sl[0],sl[1],nl),(0,pr.Cr)(h.eye,sl[1],sl[2],al),(0,pr.Cr)(h.eye,sl[2],sl[3],ol),(0,pr.Cr)(h.eye,sl[3],sl[0],ll);let p=Number.MAX_VALUE,f=0;const g=Ho(this.parameters,o)?l.length-2:l.length-5;for(let e=0;e<g;e+=3){jo[0]=l[e]+t[12],jo[1]=l[e+1]+t[13],jo[2]=l[e+2]+t[14];const i=(e+3)%l.length;if(Wo[0]=l[i]+t[12],Wo[1]=l[i+1]+t[13],Wo[2]=l[i+2]+t[14],(0,pr.mN)(nl,jo)<0&&(0,pr.mN)(nl,Wo)<0||(0,pr.mN)(al,jo)<0&&(0,pr.mN)(al,Wo)<0||(0,pr.mN)(ol,jo)<0&&(0,pr.mN)(ol,Wo)<0||(0,pr.mN)(ll,jo)<0&&(0,pr.mN)(ll,Wo)<0)continue;if(h.projectToRenderScreen(jo,$o),h.projectToRenderScreen(Wo,Qo),$o[2]<0&&Qo[2]>0){(0,M.f)(ko,jo,Wo);const e=h.frustum,t=-(0,pr.mN)(e[Rt.FB.NEAR],jo)/(0,M.j)(ko,(0,pr.Qj)(e[Rt.FB.NEAR]));(0,M.h)(ko,ko,t),(0,M.g)(jo,jo,ko),h.projectToRenderScreen(jo,$o)}else if($o[2]>0&&Qo[2]<0){(0,M.f)(ko,Wo,jo);const e=h.frustum,t=-(0,pr.mN)(e[Rt.FB.NEAR],Wo)/(0,M.j)(ko,(0,pr.Qj)(e[Rt.FB.NEAR]));(0,M.h)(ko,ko,t),(0,M.g)(Wo,Wo,ko),h.projectToRenderScreen(Wo,Qo)}else if($o[2]<0&&Qo[2]<0)continue;$o[2]=0,Qo[2]=0;const r=(0,Ro.kb)((0,Ro.Cr)($o,Qo,Xo),d);r<p&&(p=r,(0,M.c)(Jo,jo),(0,M.c)(Yo,Wo),f=e/3)}const m=i.rayBegin,_=i.rayEnd;if(p<u*u){let e=Number.MAX_VALUE;if((0,Ro.ld)((0,Ro.Cr)(Jo,Yo,Xo),(0,Ro.Cr)(m,_,Ko),Zo)){(0,M.f)(Zo,Zo,m);const t=(0,M.l)(Zo);(0,M.h)(Zo,Zo,1/t),e=t/(0,M.p)(m,_)}n(e,Zo,f,!1)}}get _layout(){const e=(0,jn.BP)().vec3f(It.r.POSITION).vec3f(It.r.PREVPOSITION).vec3f(It.r.NEXTPOSITION).f32(It.r.SUBDIVISIONFACTOR).vec2f(It.r.UV0);return this.parameters.vvSize?e.f32(It.r.SIZEFEATUREATTRIBUTE):e.f32(It.r.SIZE),this.parameters.vvColor?e.f32(It.r.COLORFEATUREATTRIBUTE):e.vec4f(It.r.COLOR),this.parameters.vvOpacity&&e.f32(It.r.OPACITYFEATUREATTRIBUTE),(0,d.A)("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(It.r.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new zo(this._layout,this.parameters)}createGLMaterial(e){return new Go(e)}validateParameters(e){"miter"!==e.join&&(e.miterLimit=0),null!=e.markerParameters&&(e.markerScale=e.markerParameters.width/e.width)}}class Go extends kn.A{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==Wn.V.Color&&this._output!==Wn.V.Alpha||this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.ensureTechnique(Do,e)}}class Uo extends Eo.S{constructor(){super(...arguments),this.width=0,this.color=F.Un,this.join="miter",this.cap=No.x.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}}class zo{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t,this.numJoinSubdivisions=0;const i=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=To.r+i}}_isClosed(e){return Ho(this._parameters,e.attributes)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=e.attributes.get(It.r.POSITION).indices.length/2+1,i=this._isClosed(e);let r=i?2:4;return r+=((i?t:t-1)-(i?0:1))*(2*this.numJoinSubdivisions+4),r+=2,this._parameters.wireframe&&(r=2+4*(r-2)),r}write(e,t,i,r,s){const n=el,a=tl,o=il,l=i.attributes.get(It.r.POSITION),c=l.indices,h=l.data.length/3,u=i.attributes.get(It.r.DISTANCETOSTART)?.data;c&&c.length!==2*(h-1)&&console.warn("RibbonLineMaterial does not support indices");const p=i.attributes.get(It.r.SIZEFEATUREATTRIBUTE)?.data[0]??i.attributes.get(It.r.SIZE)?.data[0]??1;let f=[1,1,1,1],g=0;const m=this.vertexBufferLayout.fields.has(It.r.COLORFEATUREATTRIBUTE);m?g=i.attributes.get(It.r.COLORFEATUREATTRIBUTE).data[0]:i.attributes.has(It.r.COLOR)&&(f=i.attributes.get(It.r.COLOR).data);const _=(0,d.A)("enable-feature:objectAndLayerId-rendering")?i.objectAndLayerIdColor:null,y=this.vertexBufferLayout.fields.has(It.r.OPACITYFEATUREATTRIBUTE),v=y?i.attributes.get(It.r.OPACITYFEATUREATTRIBUTE).data[0]:0,b=new Float32Array(r.buffer),x=(0,d.A)("enable-feature:objectAndLayerId-rendering")?new Uint8Array(r.buffer):null,S=this.vertexBufferLayout.stride/4;let w=s*S;const C=w;let R=0;const E=u?(e,t,i)=>R=u[i]:(e,t,i)=>R+=(0,M.p)(e,t),A=(0,d.A)("enable-feature:objectAndLayerId-rendering"),T=(e,t,i,r,s,n,a)=>{if(b[w++]=t[0],b[w++]=t[1],b[w++]=t[2],b[w++]=e[0],b[w++]=e[1],b[w++]=e[2],b[w++]=i[0],b[w++]=i[1],b[w++]=i[2],b[w++]=r,b[w++]=a,b[w++]=s,b[w++]=p,m)b[w++]=g;else{const e=Math.min(4*n,f.length-4);b[w++]=f[e],b[w++]=f[e+1],b[w++]=f[e+2],b[w++]=f[e+3]}y&&(b[w++]=v),A&&(null!=_&&(x[4*w]=_[0],x[4*w+1]=_[1],x[4*w+2]=_[2],x[4*w+3]=_[3]),w++)};w+=S,(0,M.s)(a,l.data[0],l.data[1],l.data[2]),e&&(0,M.e)(a,a,e);const O=this._isClosed(i);if(O){const t=l.data.length-3;(0,M.s)(n,l.data[t],l.data[t+1],l.data[t+2]),e&&(0,M.e)(n,n,e)}else(0,M.s)(o,l.data[3],l.data[4],l.data[5]),e&&(0,M.e)(o,o,e),T(a,a,o,1,Lo.LEFT_CAP_START,0,0),T(a,a,o,1,Lo.RIGHT_CAP_START,0,0),(0,M.c)(n,a),(0,M.c)(a,o);const P=O?0:1,I=O?h:h-1;for(let t=P;t<I;t++){const i=(t+1)%h*3;(0,M.s)(o,l.data[i],l.data[i+1],l.data[i+2]),e&&(0,M.e)(o,o,e),E(n,a,t),T(n,a,o,0,Lo.LEFT_JOIN_END,t,R),T(n,a,o,0,Lo.RIGHT_JOIN_END,t,R);const r=this.numJoinSubdivisions;for(let e=0;e<r;++e){const i=(e+1)/(r+1);T(n,a,o,i,Lo.LEFT_JOIN_END,t,R),T(n,a,o,i,Lo.RIGHT_JOIN_END,t,R)}T(n,a,o,1,Lo.LEFT_JOIN_START,t,R),T(n,a,o,1,Lo.RIGHT_JOIN_START,t,R),(0,M.c)(n,a),(0,M.c)(a,o)}O?((0,M.s)(o,l.data[3],l.data[4],l.data[5]),e&&(0,M.e)(o,o,e),R=E(n,a,I),T(n,a,o,0,Lo.LEFT_JOIN_END,P,R),T(n,a,o,0,Lo.RIGHT_JOIN_END,P,R)):(R=E(n,a,I),T(n,a,a,0,Lo.LEFT_CAP_END,I,R),T(n,a,a,0,Lo.RIGHT_CAP_END,I,R)),Bo(b,C+S,b,C,S),w=Bo(b,w-S,b,w,S),this._parameters.wireframe&&this._addWireframeVertices(r,C,w,S)}_addWireframeVertices(e,t,i,r){const s=new Float32Array(e.buffer,i*Float32Array.BYTES_PER_ELEMENT),n=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,i-t);let a=0;const o=e=>a=Bo(n,e,s,a,r);for(let e=0;e<n.length-1;e+=2*r)o(e),o(e+2*r),o(e+1*r),o(e+2*r),o(e+1*r),o(e+3*r)}}function Bo(e,t,i,r,s){for(let n=0;n<s;n++)i[r++]=e[t++];return r}function Ho(e,t){return!!e.isClosed&&t.get(It.r.POSITION).indices.length>2}const jo=(0,I.vt)(),Wo=(0,I.vt)(),ko=(0,I.vt)(),Zo=(0,I.vt)(),qo=(0,I.vt)(),$o=(0,Ms.r_)(),Qo=(0,Ms.r_)(),Jo=(0,I.vt)(),Yo=(0,I.vt)(),Xo=(0,Ro.vt)(),Ko=(0,Ro.vt)(),el=(0,I.vt)(),tl=(0,I.vt)(),il=(0,I.vt)(),rl=[(0,Ms.r_)(),(0,Ms.r_)(),(0,Ms.r_)(),(0,Ms.r_)()],sl=[(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)()],nl=(0,pr.vt)(),al=(0,pr.vt)(),ol=(0,pr.vt)(),ll=(0,pr.vt)();class cl{constructor(e){this._originSR=e,this._rootOriginId="root/"+(0,Gi.c)(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(null==t){const t=null;if(null!=t)return this._origins.set(this._rootOriginId,Ba(t[0],t[1],t[2],this._rootOriginId)),this.getOrigin(e);const i=Ba(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,i),i}const i=this._gridSize,r=Math.round(e[0]/i),s=Math.round(e[1]/i),n=Math.round(e[2]/i),a=`${r}/${s}/${n}`;let o=this._origins.get(a);const l=.5*i;if((0,M.f)(hl,e,t.vec3),hl[0]=Math.abs(hl[0]),hl[1]=Math.abs(hl[1]),hl[2]=Math.abs(hl[2]),hl[0]<l&&hl[1]<l&&hl[2]<l){if(o){const t=Math.max(...hl);if((0,M.f)(hl,e,o.vec3),hl[0]=Math.abs(hl[0]),hl[1]=Math.abs(hl[1]),hl[2]=Math.abs(hl[2]),Math.max(...hl)<t)return o}return t}return o||(o=Ba(r*i,s*i,n*i,a),this._origins.set(a,o)),o}_drawOriginBox(e,t=(0,F.fA)(1,1,0,1)){const i=window.view,r=i._stage,s=t.toString();if(!this._objects.has(s)){this._material=new Vo({width:2,color:t}),r.add(this._material);const e=new Co(r,{pickable:!1}),i=new On({castShadow:!1});r.add(i),e.add(i),this._objects.set(s,i)}const n=this._objects.get(s),a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],o=a.length,l=new Array(3*o),c=new Array,h=.5*this._gridSize;for(let t=0;t<o;t++)l[3*t]=e[0]+(1&a[t]?h:-h),l[3*t+1]=e[1]+(2&a[t]?h:-h),l[3*t+2]=e[2]+(4&a[t]?h:-h),t>0&&c.push(t-1,t);(0,k.projectBuffer)(l,this._originSR,0,l,i.renderSpatialReference,0,o);const d=new _r.V(this._material,[[It.r.POSITION,new gr.n(l,c,3,!0)]],null,mr.X.Line);r.add(d),n.addGeometry(d)}get test(){const e=this;return{set gridSize(t){e._gridSize=t}}}}const hl=(0,I.vt)();var dl=i(67900),ul=i(99164),pl=i(86316),fl=i(43793),gl=i(65630),ml=i(4477);class _l{constructor(e,t){this.shadowMap=e,this.slicePlane=t,this.slot=qn.N.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=Mo.y.NONE,this.alignPixelEnabled=!1,this.decorations=ge.ID.ON,this.overlayStretch=1,this._camera=new co,this._inverseViewport=(0,dr.vt)(),this.oldLighting=new ml.TA,this.newLighting=new ml.TA,this._fadedLighting=new ml.TA,this._lighting=this.newLighting,this.ssr=new yl,this.multipassEnabled=!1,this.multipassTerrain=new gl.h,this.multipassGeometry=new fl.U,this.hudRenderStyle=pl.D.Occluded,this.cloudsFade=new ul.ny}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:t,newLighting:i}=this;e>=1?this._lighting=i:(this._fadedLighting.lerpLighting(t,i,e),this._lighting=this._fadedLighting)}}class yl{constructor(){this.fadeFactor=1,this.reprojectionMatrix=(0,P.vt)()}}class vl{constructor(e,t,i=null){this.rctx=e,this.sliceHelper=i,this.lastFrameCamera=new co,this.output=Wn.V.Color,this.renderOccludedMask=bl,this.bindParameters=new _l(t,null!=i?i.plane:null),this.bindParameters.alignPixelEnabled=!0}}const bl=Zn.m$.Occlude|Zn.m$.OccludeAndTransparent|Zn.m$.OccludeAndTransparentStencil;let xl=class extends co{constructor(){super(...arguments),this._projectionMatrix=(0,P.vt)()}get projectionMatrix(){return this._projectionMatrix}};(0,r._)([(0,h.MZ)()],xl.prototype,"_projectionMatrix",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],xl.prototype,"projectionMatrix",null),xl=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.CascadeCamera")],xl);var Sl,wl=i(89958);!function(e){e[e.Highlight=0]="Highlight",e[e.ExcludeHighlight=1]="ExcludeHighlight"}(Sl||(Sl={}));class Cl{constructor(){this.camera=new xl,this.lightMat=(0,P.vt)()}}class Rl{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class El{constructor(e,t){this._fbos=e,this._viewingMode=t,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Rl,this._projectionView=(0,P.vt)(),this._projectionViewInverse=(0,P.vt)(),this._modelViewLight=(0,P.vt)(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=(0,F.vt)(),this._cascades=[new Cl,new Cl,new Cl,new Cl],this._lastOrigin=null,this._maxTextureWidth=Math.min((0,d.A)("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return(0,D.s)(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=(0,ce.Gz)(this._handle),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=(0,U.qE)(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let e=0;e<this._numCascades;++e)Nl[e]=this._cascades[e];return Nl.length=this._numCascades,Nl}start(e,t,i,r,s){(0,yr.vA)(this.enabled);const{near:n,far:a}=this._clampNearFar(i);this._computeCascadeDistances(n,a,r),this._textureHeight=this._computeTextureHeight(e,s,r),this._setupMatrices(e,t);const{viewMatrix:o,projectionMatrix:l}=e;for(let e=0;e<this._numCascades;++e)this._constructCascade(e,l,o,t);this._lastOrigin=null,this.clear()}finish(){(0,yr.vA)(this.enabled),this._handle?.detachDepth()}getShadowMapMatrices(e){if(!this._lastOrigin||!(0,M.i)(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||(0,I.vt)(),(0,M.c)(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){(0,O.Tl)(Vl,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)Gl[16*t+e]=Vl[e]}}return Gl}moveSnapshot(e){(0,yr.vA)(this.enabled),this._handle?.detachDepth(),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle=null,this.clear()}copySnapshot(e){const t=this._handle?.getTexture()?.descriptor;if(!this.enabled||!t)return;this._snapshots[e]?.release();const{width:i,height:r}=t,s=e===Sl.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[e]=this._fbos.acquire(i,r,s,ka.N.RGBA4);const n=this._fbos.rctx;this._bindFbo();const a=n.bindTexture(this._snapshots[e]?.getTexture(),wl.g.TEXTURE_UNIT_FOR_UPDATES);n.gl.copyTexSubImage2D(_t.Ap.TEXTURE_2D,0,0,0,0,0,i,r),n.bindTexture(a,wl.g.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture():null}clear(){const e=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(_t.hn.COLOR_BUFFER_BIT|_t.hn.DEPTH_BUFFER_BIT)}_computeTextureHeight(e,t,i){const r=Math.min(window.devicePixelRatio,t)/e.pixelRatio,s=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,n=(0,me.Mv)(Math.floor(Math.max(e.fullWidth,e.fullHeight)*r*s)),a=Math.min(this._maxTextureWidth,this._numCascades*n);return(0,me.uT)(a/this._numCascades)}_ensureFbo(){this._handle?.fbo.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",ka.N.RGBA4)),this._handle?.acquireDepth(ka.z.DEPTH16_BUFFER)}_discardSnapshot(e){this._snapshots[e]=(0,ce.Gz)(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){const e=this._fbos.rctx;e.unbindTexture(this.depthTexture),e.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,i,r){const s=this._cascades[e],n=-this._cascadeDistances[e],a=-this._cascadeDistances[e+1],o=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]),l=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]);(0,yr.vA)(o<l);for(let e=0;e<8;++e){(0,D.s)(Tl,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?o:l,1);const t=Ol[e];(0,D.t)(t,Tl,this._projectionViewInverse),t[0]/=t[3],t[1]/=t[3],t[2]/=t[3]}(0,M.E)(Ll,Ol[0]),s.camera.viewMatrix=(0,O.Tl)(Al,this._modelViewLight,Ll);for(let e=0;e<8;++e)(0,M.e)(Ol[e],Ol[e],s.camera.viewMatrix);let c=Ol[0][2],h=Ol[0][2];for(let e=1;e<8;++e)c=Math.min(c,Ol[e][2]),h=Math.max(h,Ol[e][2]);c-=200,h+=200,s.camera.near=-h,s.camera.far=-c,function(e,t,i,r,s){const n=1/Ol[0][3],a=1/Ol[4][3];(0,yr.vA)(n<a);let o=n+Math.sqrt(n*a);const l=Math.sin((0,U.XM)(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));o/=l,function(e,t,i,r,s,n,a,o){(0,xa.hZ)(Ul,0,0);for(let t=0;t<4;++t)(0,xa.WQ)(Ul,Ul,e[t]);(0,xa.hs)(Ul,Ul,.25),(0,xa.hZ)(zl,0,0);for(let t=4;t<8;++t)(0,xa.WQ)(zl,zl,e[t]);(0,xa.hs)(zl,zl,.25),(0,xa.Cc)(Bl[0],e[4],e[5],.5),(0,xa.Cc)(Bl[1],e[5],e[6],.5),(0,xa.Cc)(Bl[2],e[6],e[7],.5),(0,xa.Cc)(Bl[3],e[7],e[4],.5);let l=0,c=(0,xa.hG)(Bl[0],Ul);for(let e=1;e<4;++e){const t=(0,xa.hG)(Bl[e],Ul);t<c&&(c=t,l=e)}(0,xa.Re)(Hl,Bl[l],e[l+4]);const h=Hl[0];let d,u;Hl[0]=-Hl[1],Hl[1]=h,(0,xa.Re)(jl,zl,Ul),(0,xa.Om)(jl,Hl)<0&&(0,xa.ze)(Hl,Hl),(0,xa.Cc)(Hl,Hl,jl,i),(0,xa.S8)(Hl,Hl),d=u=(0,xa.Om)((0,xa.Re)(Wl,e[0],Ul),Hl);for(let t=1;t<8;++t){const i=(0,xa.Om)((0,xa.Re)(Wl,e[t],Ul),Hl);i<d?d=i:i>u&&(u=i)}(0,xa.C)(r,Ul),(0,xa.hs)(Wl,Hl,d-t),(0,xa.WQ)(r,r,Wl);let p=-1,f=1,g=0,m=0;for(let t=0;t<8;++t){(0,xa.Re)(kl,e[t],r),(0,xa.S8)(kl,kl);const i=Hl[0]*kl[1]-Hl[1]*kl[0];i>0?i>p&&(p=i,g=t):i<f&&(f=i,m=t)}(0,yr.MX)(p>0,"leftArea"),(0,yr.MX)(f<0,"rightArea"),(0,xa.hs)(Zl,Hl,d),(0,xa.WQ)(Zl,Zl,Ul),(0,xa.hs)(ql,Hl,u),(0,xa.WQ)(ql,ql,Ul),$l[0]=-Hl[1],$l[1]=Hl[0];const _=(0,yr.L)(r,e[m],ql,(0,xa.WQ)(Wl,ql,$l),1,s),y=(0,yr.L)(r,e[g],ql,Wl,1,n),v=(0,yr.L)(r,e[g],Zl,(0,xa.WQ)(Wl,Zl,$l),1,a),b=(0,yr.L)(r,e[m],Zl,Wl,1,o);(0,yr.MX)(_,"rayRay"),(0,yr.MX)(y,"rayRay"),(0,yr.MX)(v,"rayRay"),(0,yr.MX)(b,"rayRay")}(Ol,o,l,Pl,Ml,Il,Dl,Fl),function(e,t,i,r,s){(0,xa.Re)(Xl,i,r),(0,xa.hs)(Xl,Xl,.5),Kl[0]=Xl[0],Kl[1]=Xl[1],Kl[2]=0,Kl[3]=Xl[1],Kl[4]=-Xl[0],Kl[5]=0,Kl[6]=Xl[0]*Xl[0]+Xl[1]*Xl[1],Kl[7]=Xl[0]*Xl[1]-Xl[1]*Xl[0],Kl[8]=1,Kl[Ql(0,2)]=-(0,xa.Om)(Yl(Kl,0),e),Kl[Ql(1,2)]=-(0,xa.Om)(Yl(Kl,1),e);let n=(0,xa.Om)(Yl(Kl,0),i)+Kl[Ql(0,2)],a=(0,xa.Om)(Yl(Kl,1),i)+Kl[Ql(1,2)],o=(0,xa.Om)(Yl(Kl,0),r)+Kl[Ql(0,2)],l=(0,xa.Om)(Yl(Kl,1),r)+Kl[Ql(1,2)];n=-(n+o)/(a+l),Kl[Ql(0,0)]+=Kl[Ql(1,0)]*n,Kl[Ql(0,1)]+=Kl[Ql(1,1)]*n,Kl[Ql(0,2)]+=Kl[Ql(1,2)]*n,n=1/((0,xa.Om)(Yl(Kl,0),i)+Kl[Ql(0,2)]),a=1/((0,xa.Om)(Yl(Kl,1),i)+Kl[Ql(1,2)]),Kl[Ql(0,0)]*=n,Kl[Ql(0,1)]*=n,Kl[Ql(0,2)]*=n,Kl[Ql(1,0)]*=a,Kl[Ql(1,1)]*=a,Kl[Ql(1,2)]*=a,Kl[Ql(2,0)]=Kl[Ql(1,0)],Kl[Ql(2,1)]=Kl[Ql(1,1)],Kl[Ql(2,2)]=Kl[Ql(1,2)],Kl[Ql(1,2)]+=1,n=(0,xa.Om)(Yl(Kl,1),t)+Kl[Ql(1,2)],a=(0,xa.Om)(Yl(Kl,2),t)+Kl[Ql(2,2)],o=(0,xa.Om)(Yl(Kl,1),i)+Kl[Ql(1,2)],l=(0,xa.Om)(Yl(Kl,2),i)+Kl[Ql(2,2)],n=-.5*(n/a+o/l),Kl[Ql(1,0)]+=Kl[Ql(2,0)]*n,Kl[Ql(1,1)]+=Kl[Ql(2,1)]*n,Kl[Ql(1,2)]+=Kl[Ql(2,2)]*n,n=(0,xa.Om)(Yl(Kl,1),t)+Kl[Ql(1,2)],a=(0,xa.Om)(Yl(Kl,2),t)+Kl[Ql(2,2)],o=-a/n,Kl[Ql(1,0)]*=o,Kl[Ql(1,1)]*=o,Kl[Ql(1,2)]*=o,s[0]=Kl[0],s[1]=Kl[1],s[2]=0,s[3]=Kl[2],s[4]=Kl[3],s[5]=Kl[4],s[6]=0,s[7]=Kl[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=Kl[6],s[13]=Kl[7],s[14]=0,s[15]=Kl[8]}(Pl,Ml,Dl,Fl,s.projectionMatrix),s.projectionMatrix[10]=2/(i-r),s.projectionMatrix[14]=-(i+r)/(i-r)}(i,r,c,h,s.camera),(0,O.lw)(s.lightMat,s.camera.projectionMatrix,s.camera.viewMatrix);const d=this._textureHeight;s.camera.viewport=[e*d,0,d,d]}_setupMatrices(e,t){(0,O.lw)(this._projectionView,e.projectionMatrix,e.viewMatrix),(0,O.B8)(this._projectionViewInverse,this._projectionView);const i=this._viewingMode===oe.RT.Global?e.eye:(0,M.s)(Ll,0,0,1);(0,O.t5)(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],i)}_clampNearFar(e){let{near:t,far:i}=e;return t<2&&(t=2),i<2&&(i=2),t>=i&&(t=2,i=4),{near:t,far:i}}_computeCascadeDistances(e,t,i){const r=i?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor((0,yr.kL)(t/e,4)),r);const s=(t-e)/this._numCascades,n=(t/e)**(1/this._numCascades);let a=e,o=e;for(let e=0;e<this._numCascades+1;++e)this._cascadeDistances[e]=(0,U.Cc)(a,o,this.settings.splitSchemeLambda),a*=n,o+=s}get test(){return{cascades:this._cascades,textureHeight:this._textureHeight}}}const Al=(0,P.vt)(),Tl=(0,F.vt)(),Ol=[];for(let e=0;e<8;++e)Ol.push((0,F.vt)());const Pl=(0,dr.vt)(),Ml=(0,dr.vt)(),Il=(0,dr.vt)(),Dl=(0,dr.vt)(),Fl=(0,dr.vt)(),Ll=(0,I.vt)(),Nl=[],Vl=(0,P.vt)(),Gl=P.zK.concat(P.zK,P.zK,P.zK,P.zK),Ul=(0,dr.vt)(),zl=(0,dr.vt)(),Bl=[(0,dr.vt)(),(0,dr.vt)(),(0,dr.vt)(),(0,dr.vt)()],Hl=(0,dr.vt)(),jl=(0,dr.vt)(),Wl=(0,dr.vt)(),kl=(0,dr.vt)(),Zl=(0,dr.vt)(),ql=(0,dr.vt)(),$l=(0,dr.vt)();function Ql(e,t){return 3*t+e}const Jl=(0,dr.vt)();function Yl(e,t){return(0,xa.hZ)(Jl,e[t],e[t+3]),Jl}const Xl=(0,dr.vt)(),Kl=(0,T.vt)();var ec,tc,ic;(ic=ec||(ec={}))[ic.OBJECT=0]="OBJECT",ic[ic.HUD=1]="HUD",ic[ic.TERRAIN=2]="TERRAIN",ic[ic.OVERLAY=3]="OVERLAY",ic[ic.I3S=4]="I3S",ic[ic.PCL=5]="PCL",ic[ic.LOD=6]="LOD",ic[ic.VOXEL=7]="VOXEL",ic[ic.TILES3D=8]="TILES3D";class rc{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=tc.ALL}}!function(e){e[e.MIN=0]="MIN",e[e.MINMAX=1]="MINMAX",e[e.ALL=2]="ALL"}(tc||(tc={}));class sc{constructor(e,t,i){this.object=e,this.geometryId=t,this.triangleNr=i}}class nc extends sc{constructor(e,t,i,r){super(e,t,i),this.center=null!=r?(0,I.o8)(r):null}}class ac{constructor(e){this.layerUid=e}}class oc extends ac{constructor(e,t){super(e),this.graphicUid=t}}var lc=i(82444),cc=i(60929),hc=i(11631);const dc=()=>a.A.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");function uc(e=Pc){return{plane:(0,pr.vt)(e.plane),origin:(0,I.o8)(e.origin),basis1:(0,I.o8)(e.basis1),basis2:(0,I.o8)(e.basis2)}}function pc(e,t=uc()){return fc(e.origin,e.basis1,e.basis2,t)}function fc(e,t,i,r=uc()){return(0,M.c)(r.origin,e),(0,M.c)(r.basis1,t),(0,M.c)(r.basis2,i),gc(r),function(e,t){Math.abs((0,M.j)(e.basis1,e.basis2)/((0,M.l)(e.basis1)*(0,M.l)(e.basis2)))>1e-6&&dc().warn(t,"Provided basis vectors are not perpendicular"),Math.abs((0,M.j)(e.basis1,Rc(e)))>1e-6&&dc().warn(t,"Basis vectors and plane normal are not perpendicular"),Math.abs(-(0,M.j)(Rc(e),e.origin)-e.plane[3])>1e-6&&dc().warn(t,"Plane offset is not consistent with plane origin")}(r,"fromValues()"),r}function gc(e){(0,pr.mR)(e.basis2,e.basis1,e.origin,e.plane)}function mc(e,t,i){e!==i&&pc(e,i);const r=(0,M.h)(hc.rq.get(),Rc(e),t);return(0,M.g)(i.origin,i.origin,r),i.plane[3]-=t,i}function _c(e,t=uc()){const i=(e[2]-e[0])/2,r=(e[3]-e[1])/2;return(0,M.s)(t.origin,e[0]+i,e[1]+r,0),(0,M.s)(t.basis1,i,0,0),(0,M.s)(t.basis2,0,r,0),(0,pr.fA)(0,0,1,0,t.plane),t}function yc(e,t,i){return!!(0,pr.Ui)(e.plane,t,i)&&Ec(e,i)}function vc(e,t,i){const r=Mc.get();Oc(e,t,r,Mc.get());let s=Number.POSITIVE_INFINITY;for(const n of Lc){const a=Tc(e,n,Ic.get()),o=hc.rq.get();if((0,pr.T7)(r,a,o)){const e=(0,M.D)(hc.rq.get(),t.origin,o),r=Math.abs((0,U.XM)((0,M.j)(t.direction,e)));r<s&&(s=r,(0,M.c)(i,o))}}return s===Number.POSITIVE_INFINITY?bc(e,t,i):i}function bc(e,t,i){if(yc(e,t,i))return i;const r=Mc.get(),s=Mc.get();Oc(e,t,r,s);let n=Number.POSITIVE_INFINITY;for(const a of Lc){const o=Tc(e,a,Ic.get()),l=hc.rq.get();if((0,pr.gv)(r,o,l)){const e=(0,fr.kb)(t,l);if(!(0,pr.Tj)(s,l))continue;e<n&&(n=e,(0,M.c)(i,l))}}return wc(e,t.origin)<n&&xc(e,t.origin,i),i}function xc(e,t,i){const r=(0,pr._I)(e.plane,t,hc.rq.get()),s=(0,Ro.H6)(Ac(e,e.basis1),r,-1,1,hc.rq.get()),n=(0,Ro.H6)(Ac(e,e.basis2),r,-1,1,hc.rq.get());return(0,M.f)(i,(0,M.g)(hc.rq.get(),s,n),e.origin),i}function Sc(e,t,i){const{origin:r,basis1:s,basis2:n}=e,a=(0,M.f)(hc.rq.get(),t,r),o=(0,lo.gr)(s,a),l=(0,lo.gr)(n,a),c=(0,lo.gr)(Rc(e),a);return(0,M.s)(i,o,l,c)}function wc(e,t){const i=Sc(e,t,hc.rq.get()),{basis1:r,basis2:s}=e,n=(0,M.l)(r),a=(0,M.l)(s),o=Math.max(Math.abs(i[0])-n,0),l=Math.max(Math.abs(i[1])-a,0),c=i[2];return o*o+l*l+c*c}function Cc(e,t){const i=-e.plane[3];return(0,lo.gr)(Rc(e),t)-i}function Rc(e){return(0,pr.Qj)(e.plane)}function Ec(e,t){const i=(0,M.f)(hc.rq.get(),t,e.origin),r=(0,M.o)(e.basis1),s=(0,M.o)(e.basis2),n=(0,M.j)(e.basis1,i),a=(0,M.j)(e.basis2,i);return-n-r<0&&n-r<0&&-a-s<0&&a-s<0}function Ac(e,t){const i=Ic.get();return(0,M.c)(i.origin,e.origin),(0,M.c)(i.vector,t),i}function Tc(e,t,i){const{basis1:r,basis2:s,origin:n}=e,a=(0,M.h)(hc.rq.get(),r,t.origin[0]),o=(0,M.h)(hc.rq.get(),s,t.origin[1]);(0,M.g)(i.origin,a,o),(0,M.g)(i.origin,i.origin,n);const l=(0,M.h)(hc.rq.get(),r,t.direction[0]),c=(0,M.h)(hc.rq.get(),s,t.direction[1]);return(0,M.h)(i.vector,(0,M.g)(l,l,c),2),i}function Oc(e,t,i,r){const s=Rc(e);(0,pr.mR)(s,t.direction,t.origin,i),(0,pr.mR)((0,pr.Qj)(i),s,t.origin,r)}const Pc={plane:(0,pr.vt)(),origin:(0,I.fA)(0,0,0),basis1:(0,I.fA)(1,0,0),basis2:(0,I.fA)(0,1,0)},Mc=new lc.I(pr.vt),Ic=new lc.I(Ro.vt),Dc=(0,I.vt)(),Fc=new lc.I((()=>uc())),Lc=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],Nc=(0,P.vt)(),Vc=(0,P.vt)();Object.freeze(Object.defineProperty({__proto__:null,BoundedPlaneClass:class{constructor(){this.plane=(0,pr.vt)(),this.origin=(0,I.vt)(),this.basis1=(0,I.vt)(),this.basis2=(0,I.vt)()}},altitudeAt:Cc,axisAt:function(e,t,i,r){return function(e,t,i){switch(t){case cc._.X:(0,M.c)(i,e.basis1),(0,M.n)(i,i);break;case cc._.Y:(0,M.c)(i,e.basis2),(0,M.n)(i,i);break;case cc._.Z:(0,M.c)(i,Rc(e))}return i}(e,i,r)},closestPoint:bc,closestPointOnSilhouette:vc,copy:pc,copyWithoutVerify:function(e,t){(0,M.c)(t.origin,e.origin),(0,M.c)(t.basis1,e.basis1),(0,M.c)(t.basis2,e.basis2),(0,pr.C)(t.plane,e.plane)},create:uc,distance:function(e,t){return Math.sqrt(wc(e,t))},distance2:wc,distanceToSilhouette:function(e,t){let i=Number.NEGATIVE_INFINITY;for(const r of Lc){const s=Tc(e,r,Ic.get()),n=(0,Ro.kb)(s,t);n>i&&(i=n)}return Math.sqrt(i)},elevate:mc,equals:function(e,t){return(0,M.i)(e.basis1,t.basis1)&&(0,M.i)(e.basis2,t.basis2)&&(0,M.i)(e.origin,t.origin)},extrusionContainsPoint:function(e,t){return(0,pr.Tj)(e.plane,t)&&Ec(e,t)},fromAABoundingRect:_c,fromValues:fc,intersectRay:yc,intersectRayClosestSilhouette:function(e,t,i){if(yc(e,t,i))return i;const r=vc(e,t,hc.rq.get());return(0,M.g)(i,t.origin,(0,M.h)(hc.rq.get(),t.direction,(0,M.p)(t.origin,r)/(0,M.l)(t.direction))),i},normal:Rc,projectPoint:xc,projectPointLocal:Sc,rotate:function(e,t,i,r){return e!==r&&pc(e,r),(0,O.$0)(Vc,t,i),(0,M.e)(r.basis1,e.basis1,Vc),(0,M.e)(r.basis2,e.basis2,Vc),gc(r),r},setAltitudeAt:function(e,t,i,r){const s=Cc(e,t),n=(0,M.h)(Dc,Rc(e),i-s);return(0,M.g)(r,t,n),r},setExtent:function(e,t,i){return _c(t,i),mc(i,Cc(e,e.origin),i),i},transform:function(e,t,i){return e!==i&&pc(e,i),(0,O.B8)(Nc,t),(0,O.mg)(Nc,Nc),(0,M.e)(i.basis1,e.basis1,Nc),(0,M.e)(i.basis2,e.basis2,Nc),(0,M.e)((0,pr.Qj)(i.plane),(0,pr.Qj)(e.plane),Nc),(0,M.e)(i.origin,e.origin,t),(0,pr.mP)(i.plane,i.plane,i.origin),i},up:Pc,updateUnboundedPlane:gc,wrap:function(e,t,i){const r=Fc.get();return r.origin=e,r.basis1=t,r.basis2=i,r.plane=(0,pr.LV)(0,0,0,0),gc(r),r}},Symbol.toStringTag,{value:"Module"})),(0,I.vt)();class Gc extends oc{constructor(e,t,i){super(e,t),this.triangleNr=i}}class Uc{constructor(){this.adds=new C.A,this.removes=new C.A,this.updates=new C.A({allocator:e=>e||new zc,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return 0===this.adds.length&&0===this.removes.length&&0===this.updates.length}}class zc{}class Bc{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}var Hc=i(72559);const jc=1e-5;class Wc{constructor(e){this.options=new rc,this._results=new qc,this.transform=new Hc.dg,this.tolerance=jc,this.verticalOffset=null,this._ray=(0,fr.vt)(),this._rayEnd=(0,I.vt)(),this._rayBeginTransformed=(0,I.vt)(),this._rayEndTransformed=(0,I.vt)(),this.viewingMode=e??oe.RT.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,i){this.resetWithRay((0,fr.Cr)(e,t,this._ray),i)}resetWithRay(e,t){this.camera=t,e!==this._ray&&(0,fr.C)(e,this._ray),0!==this.options.verticalOffset?this.viewingMode===oe.RT.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,(0,M.g)(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,t,i,r,s){this.point=t,this.filterPredicate=r,this.tolerance=i??jc;const n=(0,Hc.ou)(this.verticalOffset);if(e&&e.length>0){const t=s?e=>{s(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(const i of e){const e=i.getSpatialQueryAccelerator?.();null!=e?(null!=n?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,n):e.forEachAlongRay(this._ray.origin,this._ray.direction,t),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t)):i.objects.forAll((e=>t(e)))}}this.sortResults()}intersectObject(e){const t=e.geometries;if(!t)return;const i=e.effectiveTransformation,r=(0,Hc.ou)(this.verticalOffset);for(const s of t){if(!s.visible)continue;const{material:t,id:n}=s;this.transform.setAndInvalidateLazyTransforms(i,s.transformation),(0,M.e)(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),(0,M.e)(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const a=this.transform.transform;null!=r&&(r.objectTransform=this.transform),t.intersect(s,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((t,i,r,s,o,l)=>{if(t>=0){if(null!=this.filterPredicate&&!this.filterPredicate(this._ray.origin,this._rayEnd,t))return;const c=s?this._results.hud:this._results,h=s?s=>{const a=new nc(e,n,r,l);s.set(ec.HUD,a,t,i,P.zK,o)}:s=>s.set(ec.OBJECT,{object:e,geometryId:n,triangleNr:r},t,i,a,o);if((null==c.min.drapedLayerOrder||o>=c.min.drapedLayerOrder)&&(null==c.min.dist||t<c.min.dist)&&h(c.min),this.options.store!==tc.MIN&&(null==c.max.drapedLayerOrder||o<c.max.drapedLayerOrder)&&(null==c.max.dist||t>c.max.dist)&&h(c.max),this.options.store===tc.ALL)if(s){const e=new Qc(this._ray);h(e),this._results.hud.all.push(e)}else{const e=new $c(this._ray);h(e),this._results.all.push(e)}}}))}}sortResults(e=this._results.all){e.sort(((e,t)=>e.dist!==t.dist?(e.dist??0)-(t.dist??0):e.drapedLayerOrder!==t.drapedLayerOrder?kc(e.drapedLayerOrder,t.drapedLayerOrder):kc(e.drapedLayerGraphicOrder,t.drapedLayerGraphicOrder)))}}function kc(e,t){return(t??-Number.MAX_VALUE)-(e??-Number.MAX_VALUE)}function Zc(e){return new Wc(e)}class qc{constructor(){this.min=new $c((0,fr.vt)()),this.max=new $c((0,fr.vt)()),this.hud={min:new Qc((0,fr.vt)()),max:new Qc((0,fr.vt)()),all:new Array},this.ground=new $c((0,fr.vt)()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}}class $c{get ray(){return this._ray}get distanceInRenderSpace(){return null!=this.dist?((0,M.h)(Yc,this.ray.direction,this.dist),(0,M.l)(Yc)):null}getIntersectionPoint(e){return!!function(e){return null!=e?.dist}(this)&&((0,M.h)(Yc,this.ray.direction,this.dist),(0,M.g)(e,this.ray.origin,Yc),!0)}getTransformedNormal(e){return(0,M.c)(Xc,this.normal),Xc[3]=0,(0,D.t)(Xc,Xc,this.transformation),(0,M.c)(e,Xc),(0,M.n)(e,e)}constructor(e){this.intersector=ec.OBJECT,this.normal=(0,I.vt)(),this.transformation=(0,P.vt)(),this._ray=(0,fr.vt)(),this.init(e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=ec.OBJECT,(0,fr.C)(e,this._ray)}set(e,t,i,r,s,n,a){this.intersector=e,this.dist=i,(0,M.c)(this.normal,r??I.Cb),(0,O.C)(this.transformation,s??P.zK),this.target=t,this.drapedLayerOrder=n,this.drapedLayerGraphicOrder=a}copy(e){(0,fr.C)(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,(0,M.c)(this.normal,e.normal),(0,O.C)(this.transformation,e.transformation)}}class Qc extends $c{constructor(){super(...arguments),this.intersector=ec.HUD}}function Jc(e){return new $c(e)}const Yc=(0,I.vt)(),Xc=(0,F.vt)();var Kc,eh,th,ih;function rh(e){return e.geometry.indexCount>=1}(ih=Kc||(Kc={}))[ih.ADD=0]="ADD",ih[ih.UPDATE=1]="UPDATE",ih[ih.REMOVE=2]="REMOVE",function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"}(eh||(eh={})),function(e){e[e.Default=0]="Default",e[e.Screenshot=1]="Screenshot",e[e.ObjectAndLayerID=2]="ObjectAndLayerID"}(th||(th={}));var sh=i(29386);class nh{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach(((e,t)=>{null!=e&&this._repository.release(this._material,t)}))}load(e,t,i){const r=this._material.produces.get(t);if(!r||!r(i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,t,i));const s=this._map.get(i);if(null!=s){if(s.ensureResources(e)===ge.Am.LOADED)return s;this._repository.requestRender()}return null}}class ah extends Qa.gy{constructor(e=(0,I.vt)()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}}class oh{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}}function lh(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let i=!0;for(;i;){i=!1;for(let r=0;r<e.length;++r){const s=e.data[r],n=t.get(s.to);if(!n)return;s.to=n.to,t.delete(n.from),e.removeUnordered(n),i=!0}}}class ch extends oh{constructor(e,t,i){super(t,i),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return null!=this.geometry.highlights&&this.isVisible}get hasOccludees(){return null!=this.geometry.occludees}}class hh{constructor(){this.first=0,this.count=0}}class dh{constructor(){this._numElements=0,this._instances=new Map,this.holes=new C.A({allocator:e=>e||new oh,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=uh(),this.drawCommandsHighlight=uh(),this.drawCommandsOccludees=uh(),this.drawCommandsShadowHighlightRest=uh()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,i){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,r.from=t,r.to=i,this._numElements+=r.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const t=this.drawCommandsDefault.pushNew(),i=this.holes.front();return null!=this.vao&&1===this.holes.length&&i.to===Math.floor(this.vao.byteSize/e)?(t.first=0,void(t.count=i.from)):(t.first=1/0,t.count=0,this._instances.forEach((e=>{t.first=Math.min(t.first,e.from),t.count=Math.max(t.count,e.to)})),void(t.count-=t.first))}const t=Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from));for(const e of t)e.isVisible&&(ph(e.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,e),ph(e.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,e))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function uh(){return new C.A({allocator:e=>e||new hh,deallocator:e=>e})}function ph(e,t){const i=e.back();if(null==i){const i=e.pushNew();return i.first=t.from,void(i.count=t.numElements)}if(function(e,t){return e.first+e.count>=t.from}(i,t)){const e=t.from-i.first+t.numElements;i.count=e}else{const i=e.pushNew();i.first=t.from,i.count=t.numElements}}class fh{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}}class gh{constructor(e,t){this._cache=e(t,((e,t,i)=>this._remove(e,t,i)))}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const i=t.pop();if(t.length>0){if(i){const r=this._cache.getSize(e)-Math.round(i.usedMemory);this._cache.updateSize(e,t,r)}}else this._cache.pop(e);return i}put(e,t,i=he.Cn){const r=this._cache.peek(e);if(!r)return void this._cache.put(e,[t],t.usedMemory,i);r.push(t);const s=this._cache.getSize(e)+Math.round(t.usedMemory);this._cache.updateSize(e,r,s)}_remove(e,t,i){switch(t){case he.k2.ALL:return e.forEach((e=>e.dispose())),0;case he.k2.SOME:{const t=e.shift();return t&&(i-=Math.round(t.usedMemory),t.dispose()),i}}}}var mh=i(40866);class _h extends mh.Z{}var yh=i(89325);class vh{constructor(e,t,i){this._rctx=e,this._locations=t,this._layout=i,this._cache=new gh(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let i=this._cache.pop(t);return i||(i=new _h(this._rctx,this._locations,{geometry:this._layout},{geometry:yh.g.createVertex(this._rctx,_t._U.STATIC_DRAW)}),i.vertexBuffers.geometry.setSize(e),i)}deleteVao(e){if(null==e)return;const t=e.byteSize.toString();this._cache.put(t,e)}}let bh=class extends oo.Ot{constructor(e){super(e),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._produces=new Map,this.drapedPriority=0}destroy(){this._glMaterials=(0,ce.WD)(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=(0,ce.WD)(this._vaoCache)}initialize(){this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>!(0===this._dataByOrigin.size||!(t!==Wn.V.Highlight&&t!==Wn.V.ShadowHighlight||this._hasHighlights))&&e(t)))}))}get produces(){return this._produces}initializeRenderContext(e,t){const{rctx:i}=e.renderContext;this._glMaterials=new nh(this.material,t??e.materialRepository),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new vh(i,this.material.vertexAttributeLocations,(0,sh.U)(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get hasOccludees(){return this._hasOccludees}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(e){return this.material.queryRenderOccludedState(e)}get materialReference(){return this.material}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.usedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>e(t.geometry)))))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const t=this._bufferWriter;if(null===t)return;const i=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.renderGeometry,s=this._dataByOrigin.get(e.localOrigin.id),n=s?.findBuffer(e.id);if(null==n)return;const a=n.instances.get(e.id);if(r.updateType&(eh.GEOMETRY|eh.TRANSFORMATION)){const r=Dh(t.elementCount(a.geometry.geometry)*i),s=t.vertexBufferLayout.createView(r.buffer);this._writeGeometry(e,s,0),n.vao.vertexBuffers.geometry.setSubData(r,a.from*i,0,a.numElements*i)}r.updateType&(eh.HIGHLIGHT|eh.OCCLUDEE|eh.VISIBILITY)&&(n.drawCommandsDirty=!0)}}_computeDeltas(e,t){const i=new to.O;for(const t of e){const e=t.localOrigin;if(null==e)continue;let r=i.get(e.id,null);null==r&&(r=new xh(e.vec3),i.set(e.id,null,r)),r.changes.push(t)}for(const e of t){const t=e.localOrigin;if(null==t)continue;const r=this._dataByOrigin.get(t.id),s=r?.findBuffer(e.id);if(null==s)continue;let n=i.get(t.id,s);null==n&&(n=new xh(t.vec3),i.set(t.id,s,n)),n.changes.push(e)}return i}_addAndRemoveGeometries(e,t){if(null===this._bufferWriter||null===this._vaoCache)return;const{_bufferWriter:i,_dataByOrigin:r}=this,s=i.vertexBufferLayout.stride/4,n=this._computeDeltas(e,t);n.forEach(((e,t)=>{const a=e.get(null),o=null!=a?a.changes:[];n.delete(t,null);let l=r.get(t);if(e.forEach(((e,a)=>{if(n.delete(t,a),null==a)return void(0,yr.vA)(!1,"No VAO for removed geometries");if(a.instances.size===e.changes.length)return this._vaoCache.deleteVao(a.vao),(0,b.Xy)(l.buffers,a),void(0===l.buffers.length&&0===o.length&&r.delete(t));const c=a.numElements,h=a.vao.byteSize/4,d=o.reduce(((e,t)=>e+i.elementCount(t.geometry)),0),u=e.changes.reduce(((e,t)=>e+i.elementCount(t.geometry)),0),p=Math.min((c+d-u)*s,Mh),f=p>h;p>Ah&&p<h/2?(e.changes.forEach((({id:e})=>a.deleteInstance(e))),a.instances.forEach((({geometry:e})=>o.push(e))),this._vaoCache.deleteVao(a.vao),(0,b.Xy)(l.buffers,a)):f?this._applyAndRebuild(a,o,e):this._applyRemoves(a,e)})),o.length>0)for(null==l&&(l=new fh(a.origin),r.set(t,l)),l.buffers.forEach((e=>this._applyAdds(e,o)));o.length>0;)l.buffers.push(this._applyAndRebuild(new dh,o,null))}))}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,(0,Bi.Bs)(e.instances,(t=>(e.updateDrawState(t),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees))),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,i){if(null!=i)for(const t of i.changes)e.deleteInstance(t.id);const r=this._bufferWriter,s=r.vertexBufferLayout.stride,n=s/4,a=Math.floor(Mh/n);let o=e.numElements;for(;t.length>0;){const i=t.pop(),s=r.elementCount(i.geometry);if(o+s>a&&o>0){t.push(i);break}o+=s;const n=new ch(i,0,0);(0,yr.vA)(null==e.instances.get(i.id)),e.addInstance(i.id,n)}const l=o*n,c=Dh(l),h=r.vertexBufferLayout.createView(c.buffer);let d=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach(((t,i)=>{this._writeGeometry(t.geometry,h,d);const s=d;d+=r.elementCount(t.geometry.geometry),e.updateInstance(i,s,d),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(Fh(l)),e.vao.vertexBuffers.geometry.setSubData(c,0,0,d*n),e.holes.clear();const u=e.holes.pushNew();return u.from=d,u.to=Math.floor(e.vao.byteSize/s),e.updateDrawCommands(s),e}_applyRemoves(e,t){if(0===t.changes.length||null===this._bufferWriter)return;for(const i of t.changes){const t=i.id,r=e.instances.get(t);if(!r)continue;e.deleteInstance(t);const s=Eh.back();if(s){if(s.to===r.from){s.to=r.to;continue}if(s.from===r.to){s.from=r.from;continue}}const n=Eh.pushNew();n.from=r.from,n.to=r.to}lh(Eh);const i=this._bufferWriter.vertexBufferLayout.stride/4,r=Eh.reduce(((e,t)=>Math.max(e,t.numElements)),0)*i,s=Dh(r);s.fill(0,0,r);const n=e.vao.vertexBuffers.geometry;Eh.forAll((e=>n.setSubData(s,e.from*i,0,e.numElements*i))),e.holes.pushArray(Eh.data,Eh.length),Eh.forAll(((e,t)=>Eh.data[t]=null)),Eh.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null===this._bufferWriter)return;if(!function(e){return null!=e.vao}(e))return void this._applyAndRebuild(e,t,null);const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4,s=e.numElements,n=t.reduce(((e,t)=>e+i.elementCount(t.geometry)),0),a=Math.min((s+n)*r,Mh),o=4*a;if(e.vao.byteSize<Fh(Mh-Ah)&&o>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);lh(e.holes);const l=new Array;for(const r of t){const t=i.elementCount(r.geometry),s=Sh(e.holes,t);l.push(s)}const c=e.vao.vertexBuffers.geometry;let h=0,d=0,u=0;const p=Dh(a),f=i.vertexBufferLayout.createView(p.buffer);t.forEach(((t,s)=>{const n=l[s];if(null==n)return;if(u!==n){const e=u-d;e>0&&c.setSubData(p,d*r,0,e*r),d=n,h=0}const a=i.elementCount(t.geometry);this._writeGeometry(t,f,h),h+=a,u=n+a;const o=new ch(t,n,n+a);(0,yr.vA)(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0}));const g=u-d;g>0&&c.setSubData(p,d*r,0,g*r),(0,b.$i)(t,((e,t)=>null==l[t]))}_writeGeometry(e,t,i){if(null===this._bufferWriter)return;const r=e.localOrigin.vec3;(0,yr.M_)(wh,-r[0],-r[1],-r[2]);const s=(0,O.lw)(Ch,wh,e.transformation);(0,O.B8)(Rh,s),(0,O.mg)(Rh,Rh),this._bufferWriter.write(s,Rh,e.geometry,t,i)}updateAnimation(e){return this.material.update(e)}prepareTechnique(e){if(!this.material.shouldRender(e))return null;const{output:t,bindParameters:i}=e,r=this.material.produces.get(i.slot);if(!r||!r(t))return null;const s=t===Wn.V.Highlight||t===Wn.V.ShadowHighlight;if(s&&!this._hasHighlights)return null;const n=t===Wn.V.ShadowExcludeHighlight,a=!(s||n);for(const r of this._dataByOrigin.values())for(const o of r.buffers){if(s&&!o.hasHighlights)continue;const r=(s?o.drawCommandsHighlight:n&&o.needsMultipleCommands()?o.drawCommandsShadowHighlightRest:o.drawCommandsDefault)||null,l=a&&o.drawCommandsOccludees||null;if(r?.length||l?.length){const r=this._glMaterials.load(e.rctx,i.slot,t),s=null!=r?r.beginSlot(i):null;if(null!=s)return s}}return null}renderNode(e,t){const{output:i,bindParameters:r}=e,s=i===Wn.V.Highlight||i===Wn.V.ShadowHighlight,n=i===Wn.V.ShadowExcludeHighlight,a=!(s||n),o=e.rctx,l=e.bindParameters.slot===qn.N.OCCLUDER_MATERIAL,c=e.bindParameters.slot===qn.N.TRANSPARENT_OCCLUDER_MATERIAL;o.runAppleAmdDriverHelper(),o.bindTechnique(t,r,this.material.parameters);for(const e of this._dataByOrigin.values())for(const i of e.buffers){if(s&&!i.hasHighlights)continue;const h=(s?i.drawCommandsHighlight:n&&i.needsMultipleCommands()?i.drawCommandsShadowHighlightRest:i.drawCommandsDefault)||null,d=a&&i.drawCommandsOccludees||null;(h?.length||d?.length)&&(t.program.bindDraw(new ah(e.origin),r,this.material.parameters),t.ensureAttributeLocations(i.vao),o.bindVAO(i.vao),h?.length&&(o.setPipelineState(t.getPipeline(!1,l,c)),h.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count)))),d?.length&&(o.setPipelineState(t.getPipeline(!0,l,c)),d.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count)))))}}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}};(0,r._)([(0,h.MZ)({constructOnly:!0})],bh.prototype,"material",void 0),bh=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],bh);class xh{constructor(e){this.origin=e,this.changes=new Array}}function Sh(e,t){let i;if(!e.some((e=>!(e.numElements<t||(i=e,0)))))return null;const r=i.from;return i.from+=t,i.from>=i.to&&e.removeUnordered(i),r}const wh=(0,P.vt)(),Ch=(0,P.vt)(),Rh=(0,P.vt)(),Eh=new C.A({allocator:e=>e||new oh,deallocator:null}),Ah=65536,Th=4*Ah,Oh=1024,Ph=16777216,Mh=Ph/4;let Ih=new Float32Array(Ah);function Dh(e){return Ih.length<e&&(Ih=new Float32Array(e)),Ih}function Fh(e){const t=4*e;return t<=Oh?Oh:t<Th?(0,U.cU)(t):Math.max(Math.min(Math.ceil(1.5*t/Th)*Th,Ph),t)}let Lh=class extends n.A{constructor(e){super(e),this._pending=new Nh,this._changes=new Uc,this._materialRenderers=new C.A,this._sortedMaterialRenderers=new C.A,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forAll((e=>e.destroy())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){return this._materialRenderers.some((e=>0!==e.numGeometries&&!e.queryRenderOccludedState(Zn.m$.Occlude)))}get isEmpty(){return!this.updating&&0===this._materialRenderers.length&&0===this._geometries.size}getMemoryForMaterial(e){if(null==e)return 0;const t=this._materialRenderers.find((t=>t.materialReference===e));return t?.usedMemory??0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=function(e){const t=new Map,i=e=>{let i=t.get(e);return i||(i=new Bc,t.set(e,i)),i};return e.removes.forAll((e=>{rh(e)&&i(e.material).removes.push(e)})),e.adds.forAll((e=>{rh(e)&&i(e.material).adds.push(e)})),e.updates.forAll((e=>{rh(e.renderGeometry)&&i(e.renderGeometry.material).updates.push(e)})),t}(this._changes);let t=!1;return e.forEach(((e,i)=>{let r=this._materialRenderers.find((e=>e.materialReference===i));if(!r&&e.adds.length>0){const e=new bh({material:i});e.initializeRenderContext(this.rendererContext.pluginContext,this._materialRepository),r=e,this._materialRenderers.push(r),t=!0}r&&(r.modify(e),0===r.numGeometries&&(this._materialRenderers.removeUnordered(r),r.destroy(),t=!0))})),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),this._hasHighlights=this._materialRenderers.some((e=>{const t=e.produces.get(qn.N.DRAPED_MATERIAL);return!!t&&t(Wn.V.Highlight)})),this._hasWater=this._materialRenderers.some((e=>{const t=e.produces.get(qn.N.DRAPED_WATER);return!!t&&t(Wn.V.Normal)})),this.notifyChange("updating"),!0}addGeometries(e,t){if(0===e.length)return;const i=this._validateRenderGeometries(e);for(const e of i)this._geometries.set(e.id,e);const r=this._pending.empty;for(const e of i)this._pending.adds.add(e);r&&this.notifyChange("updating"),t===Kc.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const i=this._pending.empty,r=this._pending.adds;for(const t of e)r.has(t)?(this._pending.removed.add(t),r.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t),this._geometries.delete(t.id);i&&!this._pending.empty&&this.notifyChange("updating"),t===Kc.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const i=0===this._changes.updates.length;for(const i of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._validateRenderGeometry(i),e.updateType=t}switch(i&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case eh.TRANSFORMATION:case eh.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case eh.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll((i=>t=!!i.updateAnimation&&i.updateAnimation(e)||t)),t}shouldRender(e){return this._sortedMaterialRenderers.some((t=>t.prepareTechnique(e)))}render(e){this._sortedMaterialRenderers.forAll((t=>{const i=t.prepareTechnique(e);null!=i&&t.renderNode(e,i)}))}intersect(e,t,i,r,s){return this._geometries.forEach((n=>{if(r&&!r(n))return;this._intersectRenderGeometry(n,i,t,0,e,s);const a=this.rendererContext.longitudeCyclical;a&&(n.boundingSphere[0]-n.boundingSphere[3]<a.min&&this._intersectRenderGeometry(n,i,t,a.range,e,s),n.boundingSphere[0]+n.boundingSphere[3]>a.max&&this._intersectRenderGeometry(n,i,t,-a.range,e,s)),s++})),s}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear(),this._materialRenderers.forAll(((e,t)=>{e.drapedPriority=t,this._sortedMaterialRenderers.push(e)})),this._sortedMaterialRenderers.sort(((e,t)=>t.materialReference?.renderPriority===e.materialReference?.renderPriority?e.drapedPriority-t.drapedPriority:(t.materialReference?.renderPriority||0)-(e.materialReference?.renderPriority||0)))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,t,i,r,s,n){if(!e.visible)return;let a=0;r+=e.transformation[12],a=e.transformation[13],Vh[0]=i[0]-r,Vh[1]=i[1]-a,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,s,Vh,((i,r,a)=>{!function(e,t,i,r,s,n,a){const o=new Gc(n,a,t),l=t=>{t.set(ec.OVERLAY,o,e.dist,e.normal,e.transformation,i,r)};if((null==s.results.min.drapedLayerOrder||i>=s.results.min.drapedLayerOrder)&&(null==s.results.min.dist||s.results.ground.dist<=s.results.min.dist)&&l(s.results.min),s.options.store!==tc.MIN&&(null==s.results.max.drapedLayerOrder||i<s.results.max.drapedLayerOrder)&&(null==s.results.max.dist||s.results.ground.dist>s.results.max.dist)&&l(s.results.max),s.options.store===tc.ALL){const e=Jc(s.ray);l(e),s.results.all.push(e)}}(t,a,n,e.material.renderPriority,s,e.layerUid,e.graphicUid)}),t)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let t;for(const i of e){const e=i.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicGeometryChanged(e),t=e)}}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let t;for(const i of e){const e=i.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(e),t=e)}}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin((0,X.g)(e.boundingSphere))),e}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};(0,r._)([(0,h.MZ)()],Lh.prototype,"drapeSource",void 0),(0,r._)([(0,h.MZ)()],Lh.prototype,"updating",null),(0,r._)([(0,h.MZ)()],Lh.prototype,"rctx",null),(0,r._)([(0,h.MZ)({constructOnly:!0})],Lh.prototype,"rendererContext",void 0),(0,r._)([(0,h.MZ)()],Lh.prototype,"_materialRepository",null),(0,r._)([(0,h.MZ)()],Lh.prototype,"_localOriginFactory",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Lh.prototype,"isEmpty",null),(0,r._)([(0,h.MZ)()],Lh.prototype,"_materialRenderers",void 0),(0,r._)([(0,h.MZ)()],Lh.prototype,"_geometries",void 0),Lh=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Lh);class Nh{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const Vh=(0,dr.vt)();class Gh extends Jn.w{initializeProgram(e){return new Xn.B(e.rctx,Gh.shader.get().build(),Yn.D)}initializePipeline(){return this.configuration.hasAlpha?(0,ea.Ey)({blending:(0,ea.p3)(_t.dn.SRC_ALPHA,_t.dn.ONE,_t.dn.ONE_MINUS_SRC_ALPHA,_t.dn.ONE_MINUS_SRC_ALPHA),colorWrite:ea.wE}):(0,ea.Ey)({colorWrite:ea.wE})}}Gh.shader=new Qn.$(eo.a,(()=>i.e(5510).then(i.bind(i,5510))));class Uh extends ia.K{constructor(){super(...arguments),this.hasAlpha=!1}}(0,r._)([(0,ia.W)()],Uh.prototype,"hasAlpha",void 0);var zh=i(50162),Bh=i(58062);class Hh extends Jn.w{initializeProgram(e){return new Xn.B(e.rctx,Hh.shader.get().build(),Yn.D)}initializePipeline(){return(0,ea.Ey)({blending:(0,ea.ox)(_t.dn.ONE,_t.dn.ONE_MINUS_SRC_ALPHA),colorWrite:ea.wE})}}Hh.shader=new Qn.$(Bh.a,(()=>i.e(6174).then(i.bind(i,76174))));var jh=i(88416);let Wh=class extends oo.RW{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Bh.O,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new C.A,this._passParameters=new eo.T,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new co,this.worldToPCSRatio=1,this.events=new xs.A,this.longitudeCyclical=null,this.produces=new Map([[qn.N.DRAPED_MATERIAL,e=>e!==Wn.V.Highlight||this.hasHighlights],[qn.N.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const e=this.view._stage.renderer.fboCache,t=this.view._stage.renderView,{waterTextures:i,stippleTextures:r,markerTextures:s}=t;this._shaderTechniques=new io({rctx:this._rctx,viewingMode:oe.RT.Local,stippleTextureRepository:r,markerTextureRepository:s,waterTextureRepository:i}),this._renderContext=new vl(this._rctx,new El(e,this.view.state.viewingMode),null),this.addHandles([(0,l.wB)((()=>i.updating),(()=>this.events.emit("content-changed")),l.pc),(0,l.wB)((()=>this.spatialReference),(e=>this._localOriginFactory=new cl(e)),l.pc),(0,l.on)((()=>this.view.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0))]),this._materialRepository=new _o(t.textureRepository,this._shaderTechniques,(()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed"))),this._bindParameters.slot=qn.N.DRAPED_MATERIAL,this._bindParameters.mainDepth=null,this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=Mo.y.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new zh.$p((0,I.fA)(1,1,1))]),this.addHandles(this.view.resourceController.scheduler.registerTask(Ee.W6.STAGE,this))}destroy(){this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._debugTextureTechnique=(0,ce.Gz)(this._debugTextureTechnique),this._passParameters.texture=(0,ce.WD)(this._passParameters.texture),this._shaderTechniques=(0,ce.pR)(this._shaderTechniques),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}initializeRenderContext(e){this.pluginContext=e}uninitializeRenderContext(){}renderNode(){}get updating(){return this._sortedDrapeSourceRenderersDirty||(0,Bi.Bs)(this._renderers,(e=>e.updating))}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMemoryForMaterial(e){return Array.from(this._renderers.values()).reduce(((t,i)=>t+i.getMemoryForMaterial(e)),0)}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map((e=>e.drapeSource.layer)).filter((e=>!!e))}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,Lh)}createDrapeSourceRenderer(e,t,i){const r=this._renderers.get(e);null!=r&&r.destroy();const s=new t({...i,rendererContext:this,drapeSource:e});return this._renderers.set(e,s),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles((0,l.wB)((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e),s}removeDrapeSourceRenderer(e){if(null==e)return;const t=this._renderers.get(e);null!=t&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&(0,Na.bw)(e,(e=>e.drapeTargetType===Da.WithoutRasterImage))}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=(0,Na.bw)(e,(e=>e.drapeSourceType===Ma.Features)),this._hasDrapedRasterSource=(0,Na.bw)(e,(e=>e.drapeSourceType===Ma.RasterImage))):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,i=this._bindParameters.overlayStretch){null==this._overlays&&(this._renderTargets=new qa(this.view._stage.renderer.fboCache),this._overlays=[new Ha,new Ha]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=i}disposeOverlays(){this._overlays=null,this._renderTargets=(0,ce.WD)(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){if(null!=e)return e===Va.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(Va.Color):this._renderTargets?.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,(()=>!0))}_processDrapeSources(e,t){let i=!1;for(const[r,s]of this._renderers){if(e.done)break;(r.destroyed||t(r))&&s.commitChanges()&&(i=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,i=!0,this._updateSortedDrapeSourceRenderers()),i&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=(0,Bi.Bs)(this._renderers,(e=>e.hasHighlights)),this.notifyChange("rendersOccludedDraped"),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Ee.Bb,(e=>e.updatePolicy===xo.SYNC))}get isEmpty(){return!Is.b.OVERLAY_DRAW_DEBUG_TEXTURE&&!(0,Bi.Bs)(this._renderers,(e=>!e.isEmpty))}get hasWater(){return this._hasWater}get rendersOccludedDraped(){const e=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=qh;const t=this._sortedRenderers.some((({renderer:e})=>e.shouldRender(this._renderContext)));return this._renderContext.renderOccludedMask=e,t}renders(e){return Is.b.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==Va.Occluded||this._sortedRenderers.some((({renderer:e})=>e.shouldRender(this._renderContext)))}get mode(){return this.isEmpty?Xa.Disabled:this._renderTargets?.getTexture(Va.WaterNormal)?Xa.EnabledWithWater:this._renderTargets?.getTexture(Va.Color)?Xa.Enabled:Xa.Disabled}updateAnimation(e){let t=!1;return this._renderers.forEach((i=>t=i.updateAnimation(e)||t)),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const e of this._overlays)this.longitudeCyclical?e.setupGeometryViewsCyclical(this.longitudeCyclical):e.setupGeometryViewsDirect();for(const t of this._renderTargets.targets){if(t.content===Va.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const i=this._drawTarget(Ua.vr.INNER,t,e),r=this._drawTarget(Ua.vr.OUTER,t,e);(i||r)&&t.fbo.generateMipMap()}}}_drawTarget(e,t,i){const r=this._overlays[e],s=r.canvasGeometries;if(0===s.numViews)return!1;const{alignPixelEnabled:n,contentPixelRatio:a}=i;this._screenToWorldRatio=a*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;const o=t.output;if(this.isEmpty||o===Wn.V.Highlight&&!this.hasHighlights||o===Wn.V.Normal&&!this.hasWater||!r.hasSomeSizedView())return!1;const l=this._rctx;if(this._camera.pixelRatio=r.pixelRatio*a,this._renderContext.output=o,this._bindParameters.alignPixelEnabled=n,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=o===Wn.V.Normal?qn.N.DRAPED_WATER:qn.N.DRAPED_MATERIAL,t.content===Va.Occluded&&(this._renderContext.renderOccludedMask=qh),!this.renders(t.content))return this._renderContext.renderOccludedMask=bl,!1;const c=r.resolution;this._rctx.setViewport(e===Ua.vr.INNER?0:c,0,c,c);const h=2*r.resolution,d=r.resolution,u=t.fbo;if(u.bind(l,h,d),e===Ua.vr.INNER&&(l.setClearColor(0,0,0,0),l.clearSafe(_t.hn.COLOR_BUFFER_BIT)),Is.b.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==Va.Occluded)for(let t=0;t<s.numViews;t++)this._setViewParameters(s.extents[t],r),this._ensureDebugPatternResources(r.resolution,Zh[e]),this._rctx.bindTechnique(this._debugTextureTechnique,this._renderContext.bindParameters,this._passParameters),this._rctx.screen.draw();return this._sortedRenderers.forAll((({drapeSource:i,renderer:n})=>{if(t.content===Va.ColorNoRasterImage&&i.drapeSourceType===Ma.RasterImage)return;const{fullOpacity:a}=i,c=null!=a&&a<1&&o===Wn.V.Color?this.bindTemporaryFramebuffer(h,d):null;for(let e=0;e<s.numViews;e++)this._setViewParameters(s.extents[e],r),n.render(this._renderContext);if(c){u.bind(l,h,d),this._overlayParameters.texture=c.getTexture(),this._overlayParameters.opacity=a,this._overlayParameters.overlayIndex=e;const t=this.pluginContext.techniqueRepository.acquire(Hh);this._rctx.bindTechnique(t,this._renderContext.bindParameters,this._overlayParameters),this._rctx.screen.draw(),t.release(),c.release()}})),l.bindFramebuffer(null),this._renderContext.renderOccludedMask=bl,!0}bindTemporaryFramebuffer(e,t){const i=this.view._stage.renderer.fboCache,r=i.acquire(e,t,"overlay tmp");return i.rctx.unbindTexture(r.fbo.colorTexture),i.rctx.bindFramebuffer(r.fbo),i.rctx.clearSafe(_t.hn.COLOR_BUFFER_BIT),r}async reloadShaders(){await this._shaderTechniques.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,i,r){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let s=0;for(const{renderer:n}of this._sortedRenderers)s=n.intersect?.(e,t,i,r,s)??s}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this.view.map.allLayers,t=e.length;this._renderers.forEach(((i,r)=>{const s=e.indexOf(r.layer),n=s>=0,a=r.renderGroup??(n?Ia.MapLayer:Ia.ViewLayer),o=t*a+(n?s:0);this._sortedRenderers.push(new kh(r,i,o))})),this._sortedRenderers.sort(((e,t)=>e.index-t.index))}_setViewParameters(e,t){const i=this._camera;i.viewport=[0,0,t.resolution,t.resolution],(0,O.v3)(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),(0,O.kN)(i.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=(0,Bi.Bs)(this._renderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_ensureDebugPatternResources(e,t){if((0,M.s)(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const i=new Uint8Array(e*e*4);let r=0;for(let t=0;t<e;t++)for(let s=0;s<e;s++){const n=Math.floor(s/10),a=Math.floor(t/10);n<2||a<2||10*n>e-20||10*a>e-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&n&&1&a?1&s^1&t?0:255:1&n^1&a?0:128)}const s=new jh.R(e);s.samplingMode=_t.Cj.NEAREST,this._passParameters.texture=new wl.g(this._rctx,s,i);const n=new Uh;n.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniques.acquire(Gh,n)}get test(){return{drapedRenderers:Array.from(this._renderers.values()),sortedDrapeSources:Array.from(this._sortedRenderers).map((({drapeSource:e})=>e)),getDrapeSourceRenderer:e=>this._renderers.get(e)}}};(0,r._)([(0,h.MZ)()],Wh.prototype,"hasHighlights",void 0),(0,r._)([(0,h.MZ)()],Wh.prototype,"_sortedDrapeSourceRenderersDirty",void 0),(0,r._)([(0,h.MZ)()],Wh.prototype,"_shaderTechniques",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Wh.prototype,"view",void 0),(0,r._)([(0,h.MZ)()],Wh.prototype,"worldToPCSRatio",void 0),(0,r._)([(0,h.MZ)()],Wh.prototype,"spatialReference",void 0),(0,r._)([(0,h.MZ)({type:Boolean,readOnly:!0})],Wh.prototype,"updating",null),(0,r._)([(0,h.MZ)()],Wh.prototype,"isEmpty",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Wh.prototype,"rendersOccludedDraped",null),Wh=(0,r._)([(0,u.$)("esri.views.3d.terrain.OverlayRenderer")],Wh);class kh{constructor(e,t,i){this.drapeSource=e,this.renderer=t,this.index=i}}const Zh=[[1,.5,.5],[.5,.5,1]],qh=Zn.m$.OccludeAndTransparent;function $h(e,t,i,r){const s=(0,La.jp)(e.rings,!!e.hasZ&&"on-the-ground"!==r.mode,La.Wq.CCW_IS_HOLE,e.spatialReference),n=(0,Q.jh)(s.position.length),a=Dt(s.position,e.spatialReference,0,n,0,s.position,0,s.position.length/3,t,i,r),o=null!=a;return new id(s.position,n,Yh(s.polygons,s.position,n),Jh(s.outlines,s.position,n),o,a)}function Qh(e,t){const i=(0,La.jp)(e.rings,!1,La.Wq.CCW_IS_HOLE),r=(0,k.projectBuffer)(i.position,e.spatialReference,0,i.position,t,0,i.position.length/3);for(let e=2;e<i.position.length;e+=3)i.position[e]=-2;return{position:i.position,polygons:Yh(i.polygons,i.position),outlines:Jh(i.outlines,i.position),projectionSuccess:r}}function Jh(e,t,i=null){return e.filter((({count:e})=>e>1)).map((({index:e,count:r})=>{const s=3*e,n=3*r;return null!=i?new Kh(e,r,(0,Q.l5)(t,s,n),(0,Q.l5)(i,s,n)):new Xh(e,r,(0,Q.l5)(t,s,n))}))}function Yh(e,t,i=null){const r=new Array;for(const{index:s,count:n,holeIndices:a,pathLengths:o}of e){if(n<=1)continue;const e=3*s,l=3*n,c=a.map((e=>e-s)),h=null!=i?new ed(s,n,(0,Q.l5)(t,3*s,3*n),(0,Q.l5)(i,e,l),c,o):new td(s,n,(0,Q.l5)(t,3*s,3*n),c,o);r.push(h)}return r}class Xh{constructor(e,t,i){this.index=e,this.count=t,this.position=i}}class Kh extends Xh{constructor(e,t,i,r){super(e,t,i),this.mapPositions=r}}class ed extends Kh{constructor(e,t,i,r,s,n){super(e,t,i,r),this.holeIndices=s,this.pathLengths=n}}class td extends Xh{constructor(e,t,i,r,s){super(e,t,i),this.holeIndices=r,this.pathLengths=s}}class id{constructor(e,t,i,r,s,n){this.position=e,this.mapPositions=t,this.polygons=i,this.outlines=r,this.projectionSuccess=s,this.sampledElevation=n}}var rd=i(3525),sd=i(70789);const nd=["polygon","extent"];function ad(e,t,i,r,s,n){const a=(0,Y.EH)(t.length),o=[[It.r.POSITION,new gr.n(r.positions,t,3,!0)],[It.r.NORMALCOMPRESSED,new gr.n(r.normals,t,2,!0)],[It.r.COLOR,new gr.n(s,a,4,!0)]];return new _r.V(e,o,r.elevation,mr.X.Mesh,n,i)}function od(e,t,i,r,s,n,a,o,l,c,h,d,u){const p=i.length/3;let f=0,g=2*r.count;!function(e,t,i,r,s,n,a,o,l,c,h,d,u,p,f,g,m){(0,M.c)(vd,g);const _=f>0?1:-1;let y=3*i,v=0,b=3*v,x=r,S=3*x;for(let i=0;i<r;++i)m&&(vd[0]=e[y],vd[1]=e[y+1],vd[2]=e[y+2],(0,M.n)(vd,vd)),o[b]=e[y],o[b+1]=e[y+1],o[b+2]=e[y+2],l[b]=t[y],l[b+1]=t[y+1],l[b+2]=t[y+2],c[b]=-_*vd[0],c[b+1]=-_*vd[1],c[b+2]=-_*vd[2],h[v]=0,o[S]=e[y]+f*vd[0],o[S+1]=e[y+1]+f*vd[1],o[S+2]=e[y+2]+f*vd[2],l[S]=t[y],l[S+1]=t[y+1],l[S+2]=t[y+2],c[S]=_*vd[0],c[S+1]=_*vd[1],c[S+2]=_*vd[2],h[x]=f,b+=3,S+=3,y+=3,v+=1,x+=1;y=0,b=0,S=3*p;const w=f<0?Sd:xd,C=f<0?xd:Sd;for(let e=0;e<a;++e)u[b]=s[y+w[0]],u[b+1]=s[y+w[1]],u[b+2]=s[y+w[2]],d[S]=s[y+C[0]]+r,d[S+1]=s[y+C[1]]+r,d[S+2]=s[y+C[2]]+r,b+=3,S+=3,y+=3}(e,t,r.index,r.count,i,0,p,s,n,a,o,l,c,g,h,d,u);let m=2*r.count;g=0,hd(s,n,o,a,f,r.pathLengths[0],r.count,m,l,g,h),m+=4*r.pathLengths[0],g+=2*r.pathLengths[0],f+=r.pathLengths[0];for(let e=1;e<r.pathLengths.length;++e)hd(s,n,o,a,f,r.pathLengths[e],r.count,m,l,g,h),m+=4*r.pathLengths[e],g+=2*r.pathLengths[e],f+=r.pathLengths[e]}function ld(e,t,i,r,s,n,a){r[n]=r[a],a*=3,e[n*=3]=e[a],e[n+1]=e[a+1],e[n+2]=e[a+2],t[n]=t[a],t[n+1]=t[a+1],t[n+2]=t[a+2],i[n]=s[0],i[n+1]=s[1],i[n+2]=s[2]}const cd=(0,I.vt)();function hd(e,t,i,r,s,n,a,o,l,c,h){let d=s,u=s+1,p=s+a,f=s+a+1,g=o,m=o+1,_=o+2*n,y=o+2*n+1;h<0&&(d=s+a+1,f=s),c*=3;for(let o=0;o<n;++o)o===n-1&&(h>0?(u=s,f=s+a):(u=s,d=s+a)),md(e,d,u,p,cd),ld(e,t,r,i,cd,g,d),ld(e,t,r,i,cd,m,u),ld(e,t,r,i,cd,_,p),ld(e,t,r,i,cd,y,f),l[c++]=g,l[c++]=_,l[c++]=y,l[c++]=g,l[c++]=y,l[c++]=m,d++,u++,p++,f++,g+=2,m+=2,_+=2,y+=2}const dd=(0,I.vt)(),ud=(0,I.vt)(),pd=(0,I.vt)(),fd=(0,I.vt)(),gd=(0,I.vt)();function md(e,t,i,r,s){t*=3,i*=3,r*=3,(0,M.s)(dd,e[t++],e[t++],e[t++]),(0,M.s)(ud,e[i++],e[i++],e[i++]),(0,M.s)(pd,e[r++],e[r++],e[r++]),(0,M.f)(fd,ud,dd),(0,M.f)(gd,pd,dd),(0,M.b)(s,gd,fd),(0,M.n)(s,s)}const _d=(0,I.vt)(),yd=(0,I.vt)(),vd=(0,I.vt)(),bd=new Bt,xd=[0,2,1],Sd=[0,1,2];var wd;!function(e){e[e.Main=0]="Main",e[e.Bottom=1]="Bottom"}(wd||(wd={}));class Cd{constructor(e,t,i,r){this.positions=e,this.elevation=t,this.normals=i,this.heights=r}}var Rd=i(21332),Ed=i(52644),Ad=i(9427),Td=i(77234),Od=i(93611),Pd=i(36788),Md=i(98540),Id=i(54866),Dd=i(43996);const Fd=F.uY;class Ld{constructor(e,t,i,r){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=i,this._drapeSourceRenderer=r,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(e){this.stage=e.stage}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,Kc.ADD);if(e||this._addedToStage){for(const e of this.renderGeometries)e.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,eh.VISIBILITY)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,Kc.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=(0,I.vt)()){return(0,M.s)(e,0,0,0)}getBoundingBoxObjectSpace(e=(0,q.vt)()){return(0,q.Ie)(e)}addObjectState(e,t){e===ge.Mg.Highlight&&(this.renderGeometries.forEach((e=>{const i=e.geometry.addHighlight();t.addRenderGeometry(e,i,this)})),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,eh.HIGHLIGHT))}removeObjectState(e){this.renderGeometries.forEach((t=>{e.removeRenderGeometry(t)}))}removeRenderGeometryObjectState(e,t){e.geometry.removeHighlight(t),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,eh.HIGHLIGHT)}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.geometry.computeAttachmentOrigin(Gd)&&(e.draped.origin[0]+=Gd[0],e.draped.origin[1]+=Gd[1],e.draped.num++)}async getProjectedBoundingBox(e,t,i,r,s){(0,q.Ie)(s);for(let t=0;t<this.renderGeometries.length;t++){const r=this.renderGeometries[t];this._getRenderGeometryProjectedBoundingRect(r,e,Nd,i),(0,q.DC)(s,Nd)}if(t){let e;(0,q.gX)(s,Gd);const i=rn(s,t.service.spatialReference,t);try{e=await t.service.queryElevation(Gd[0],Gd[1],r,i,"ground")}catch(e){}null!=e&&(s[2]=Math.min(s[2],e),s[5]=Math.max(s[5],e))}return s}_getRenderGeometryProjectedBoundingRect(e,t,i,r){if(this.boundingBox)(0,q.hZ)(Vd,this.boundingBox);else{const t=e.boundingSphere,i=t[3];Vd[0]=t[0]-i,Vd[1]=t[1]-i,Vd[2]=t[2]-i,Vd[3]=t[0]+i,Vd[4]=t[1]+i,Vd[5]=t[2]+i}return t(Vd,0,2),this.calculateRelativeScreenBounds&&r.push({location:(0,q.gX)(Vd),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),(0,q.ES)(Vd,i)}}const Nd=(0,$.vt)(),Vd=(0,q.vt)(),Gd=(0,I.vt)();function Ud(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}function zd(e){const{size:t}=e.definition,i=e.fontString(t);let r=Bd.get(i);if(!r){const s=Ud(jd,0,0).getContext("2d");e.setFontProperties(s,t);const n=s.measureText(Wd);r=new Hd(n.actualBoundingBoxAscent,n.actualBoundingBoxDescent),Bd.set(i,r)}return r}const Bd=new Map;class Hd{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(e,t){this.maxAscent=e,this.maxDescent=t}}const jd={canvas:null},Wd=(()=>{let e="";for(let t=32;t<127;t++)e+=String.fromCharCode(t);return e})();class kd{constructor(e,t,i,r){this.text=e,this._alignment=t,this._parameters=i,this._maxSize=r,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${e}`,this._lines=e.replaceAll(" ","").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let e=this._metrics.firstLineAscent;for(let t=0;t<this._lines.length-1;t++)e+=this._lineSpacing;return e+=this._metrics.lastLineDescent,Math.ceil(e+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(null==this._metricsCached){const e=Ud($d,Jd,Jd).getContext("2d"),t=this._parameters.definition.pixelRatio,i=this._fontSize*t;this._parameters.setFontProperties(e,i);let r=2*this._haloSize;const s=this._parameters.definition.font;"italic"!==s.style&&"oblique"!==s.style&&"bold"!==s.weight&&"bolder"!==s.weight||(r+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let n=0,a=0,o=0,l=0,c=0;this._lines.forEach(((i,s)=>{const h=e.measureText(i),d=h.width/t,u=d+r;this._textWidths.push(d),this._lineWidths.push(u),n=Math.max(n,u),l=Math.max(l,h.actualBoundingBoxAscent/t),c=Math.max(c,h.actualBoundingBoxDescent/t),0===s&&(a=h.actualBoundingBoxAscent/t),s===this._lines.length-1&&(o=h.actualBoundingBoxDescent/t)}));const h=zd(this._parameters),d=Math.max(l,h.maxAscent),u=Math.max(c,h.maxDescent),p=a,f="underline"===this._parameters.definition.font.decoration?u:o,g=n;this._metricsCached=new Xd(p,f,d,u,g)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*Qd}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,1)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(null==this._renderPixelRatio){const e=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(e,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(e){switch(this._alignment){case qd.Left:return this._horizontalPadding;case qd.Center:return(this.displayWidth-this._lineWidths[e])/2;case qd.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[e]}}render(e,t,i){e.save();const r=t/=this.renderPixelRatio,s=i/=this.renderPixelRatio,n=this._haloSize,a=this._firstLineYOffset+this._metrics.firstLineAscent;t+=n,i+=a;const o=this._haloSize>0;o&&this._renderHalo(e,r,s,n,a),this._parameters.setFontProperties(e,this._renderedFontSize);for(let r=0;r<this._lines.length;++r){const s=this._lines[r],n=this._getLineXOffset(r);o&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,s,t+n,i),this._renderLineDecoration(e,t+n,i,this._textWidths[r])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,s,t+this._getLineXOffset(r),i),this._renderLineDecoration(e,t+n,i,this._textWidths[r]),i+=this._lineSpacing}if(Is.b.TEXT_SHOW_BASELINE){e.strokeStyle=Yd,e.setLineDash([2,2]),e.lineWidth=1;let t=s+a;for(let i=0;i<this._lines.length;++i)this._drawLine(e,[r,t],[r+this.displayWidth,t]),t+=this._lineSpacing}if(Is.b.TEXT_SHOW_BORDER&&(e.strokeStyle=Yd,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[r,s],[this.displayWidth,this.displayHeight])),this._hasBackground){const t=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,r,s,t),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,t,i,r,s=!1){if("none"===this._parameters.definition.font.decoration||0===r)return;const n=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":i+=2*n;break;case"line-through":i-=.33*this._midLineAscent}const a=s?this._haloSize:0;e.strokeStyle=s?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(n+2*a),e.beginPath(),e.moveTo(this._toRenderUnit(t-a),this._toRenderUnit(i)),e.lineTo(this._toRenderUnit(t+r+a),this._toRenderUnit(i)),e.stroke()}_roundedRect(e,t,i,r){t=this._toRenderUnit(t),i=this._toRenderUnit(i);const s=this.renderedWidth,n=this.renderedHeight;0!==r?(r=(0,U.qE)(r,0,Math.floor(n/2)),e.beginPath(),e.moveTo(t,i+r),e.arcTo(t,i,t+r,i,r),e.lineTo(t+s-r,i),e.arcTo(t+s,i,t+s,i+r,r),e.lineTo(t+s,i+n-r),e.arcTo(t+s,i+n,t+s-r,i+n,r),e.lineTo(t+r,i+n),e.arcTo(t,i+n,t,i+n-r,r),e.closePath()):e.rect(t,i,s,n)}_renderHalo(e,t,i,r,s){const n=this.renderedWidth,a=this.renderedHeight,o=Ud($d,Math.max(n,Jd),Math.max(a,Jd)),l=o.getContext("2d");l.clearRect(0,0,n,a),this._parameters.setFontProperties(l,this._renderedFontSize),l.fillStyle=this._parameters.haloStyle,l.strokeStyle=this._parameters.haloStyle;const c=this._renderedHaloSize<3;l.lineJoin=c?"miter":"round",c?this._renderHaloEmulated(l,r,s):this._renderHaloNative(l,r,s);let h=s;for(let e=0;e<this._lines.length;++e){const t=this._getLineXOffset(e);this._renderLineDecoration(l,r+t,h,this._textWidths[e],!0),h+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(o,0,0,n,a,this._toRenderUnit(t),this._toRenderUnit(i),n,a),e.globalAlpha=1}_renderHaloEmulated(e,t,i){for(let r=0;r<this._lines.length;++r){const s=this._lines[r],n=this._getLineXOffset(r);for(const[r,a]of Zd)this._fillText(e,s,t+n+this._haloSize*r,i+this._haloSize*a);i+=this._lineSpacing}}_renderHaloNative(e,t,i){const r=2*this._haloSize;for(let s=0;s<this._lines.length;++s){const n=this._lines[s],a=this._getLineXOffset(s),o=5,l=.1;for(let s=0;s<o;s++){const c=1-(o-1)*l+s*l;e.lineWidth=this._toRenderUnit(c*r),this._strokeText(e,n,t+a,i)}i+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,t,i,r){e.fillText(t,this._toRenderUnit(i),this._toRenderUnit(r))}_strokeText(e,t,i,r){e.strokeText(t,this._toRenderUnit(i),this._toRenderUnit(r))}_drawLine(e,t,i){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(t[0])+.5,this._toRoundedRenderUnit(t[1])+.5),e.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),e.stroke()}_drawBox(e,t,i){const r=this._toRenderUnit(t[0]),s=this._toRenderUnit(t[1]),n=this._toRenderUnit(i[0]),a=this._toRenderUnit(i[1]),o=Math.floor(r)+.5,l=Math.ceil(r+n)-.5,c=Math.floor(s)+.5,h=Math.ceil(s+a)-.5;e.beginPath(),e.moveTo(o,c),e.lineTo(l,c),e.lineTo(l,h),e.lineTo(o,h),e.lineTo(o,c),e.stroke()}}const Zd=[];{const e=16;for(let t=0;t<360;t+=360/e)Zd.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}var qd;!function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"}(qd||(qd={}));const $d={canvas:null},Qd=.2,Jd=512,Yd="rgb(255, 0, 255, 0.5)";class Xd{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(e,t,i,r,s){this.firstLineAscent=e,this.lastLineDescent=t,this.maxLineAscent=i,this.maxLineDescent=r,this.displayWidth=s}}const Kd=Object.freeze({left:0,center:.5,right:1}),eu=Object.freeze({"bottom-left":(0,dr.fA)(0,0),bottom:(0,dr.fA)(.5,0),"bottom-right":(0,dr.fA)(1,0),left:(0,dr.fA)(0,.5),center:(0,dr.fA)(.5,.5),right:(0,dr.fA)(1,.5),"top-left":(0,dr.fA)(0,1),top:(0,dr.fA)(.5,1),"top-right":(0,dr.fA)(1,1)});function tu(e){switch(e){case"left":return qd.Left;case"right":return qd.Right;default:return qd.Center}}function iu(e){switch(e){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}var ru=i(11519);class su{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=(0,P.vt)(),this._shaderTransformation=null,this._boundingSphere=null,this.id=(0,Gi.c)(),this.layerUid=t.layerUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,null!=t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){(0,O.C)(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){null==e?this._shaderTransformation=null:(this._shaderTransformation??=(0,P.vt)(),(0,O.lw)(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(null==this._boundingSphere&&(this._boundingSphere??=(0,X.d)(),(0,M.e)((0,X.g)(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*(0,Rn.hG)(this.shaderTransformation)),this._boundingSphere):X.N}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}var nu=i(40041),au=i(87331),ou=i(71678),lu=i(84231);class cu{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}}var hu=i(73395),du=i(32052);class uu extends Jn.w{initializeConfiguration(e,t){t.spherical=e.viewingMode===oe.RT.Global}initializeProgram(e){return new Xn.B(e.rctx,uu.shader.get().build(this.configuration),Yn.D)}initializePipeline(){const e=this.configuration.transparencyPassType,t=this.configuration,i=e===Mo.y.NONE,r=e===Mo.y.FrontFace,s=this.configuration.hasPolygonOffset?pu:null,n=t.draped?null:(i||r)&&t.output!==Wn.V.Highlight&&(t.depthEnabled||t.occlusionPass)?ea.kn:null;return(0,ea.Ey)({blending:t.output===Wn.V.Color||t.output===Wn.V.Alpha||t.output===Wn.V.Highlight?i?fu:(0,Oo.ez)(e):null,depthTest:t.draped?null:{func:_t.MT.LEQUAL},depthWrite:n,colorWrite:ea.wE,polygonOffset:s})}get primitiveType(){return this.configuration.occlusionPass?_t.WR.POINTS:_t.WR.TRIANGLES}}uu.shader=new Qn.$(du.H,(()=>i.e(6884).then(i.bind(i,56884))));const pu={factor:0,units:-4},fu=(0,ea.ox)(_t.dn.ONE,_t.dn.ONE_MINUS_SRC_ALPHA);class gu extends ra.E{constructor(){super(...arguments),this.output=Wn.V.Color,this.transparencyPassType=Mo.y.NONE,this.screenCenterOffsetUnitsEnabled=!1,this.spherical=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.debugDrawLabelBorder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}}(0,r._)([(0,ia.W)({count:Wn.V.COUNT})],gu.prototype,"output",void 0),(0,r._)([(0,ia.W)({count:Mo.y.COUNT})],gu.prototype,"transparencyPassType",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"spherical",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"occlusionTestEnabled",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"signedDistanceFieldEnabled",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"vvSize",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"vvColor",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"hasVerticalOffset",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"hasScreenSizePerspective",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"debugDrawLabelBorder",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"hasPolygonOffset",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"depthEnabled",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"pixelSnappingEnabled",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"draped",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"multipassEnabled",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"cullAboveGround",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"occlusionPass",void 0),(0,r._)([(0,ia.W)()],gu.prototype,"objectAndLayerIdColorInstanced",void 0),(0,r._)([(0,ia.W)({constValue:!0})],gu.prototype,"hasSliceInVertexProgram",void 0),(0,r._)([(0,ia.W)({constValue:!1})],gu.prototype,"hasVvInstancing",void 0);class mu extends Zn.im{constructor(e){super(e,new Nu),this._configuration=new gu,this.produces=new Map([[qn.N.HUD_MATERIAL,e=>(0,Wn.L0)(e)&&!this.parameters.drawInSecondSlot],[qn.N.LABEL_MATERIAL,e=>(0,Wn.L0)(e)&&this.parameters.drawInSecondSlot],[qn.N.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[qn.N.DRAPED_MATERIAL,e=>(0,Wn.L0)(e)]])}getConfiguration(e,t){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.draped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=t.slot===qn.N.OCCLUSION_PIXELS&&this.parameters.occlusionTest,e===Wn.V.Color&&(this._configuration.debugDrawLabelBorder=!!Is.b.LABELS_SHOW_BORDER),this._configuration.depthEnabled=this.parameters.depthEnabled,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(e,t,i,r,s,n){if(!(i.options.selectionMode&&i.options.hud&&e.visible&&i.point))return;const a=this.parameters,o=i.point,l=i.camera;let{scaleX:c,scaleY:h}=this._getScreenScale(e);c*=l.pixelRatio,h*=l.pixelRatio,(0,A.z0)(Ru,t),e.attributes.has(It.r.FEATUREATTRIBUTE)&&function(e){const t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],a=e[5],o=e[6],l=e[7],c=e[8],h=1/Math.sqrt(t*t+i*i+r*r),d=1/Math.sqrt(s*s+n*n+a*a),u=1/Math.sqrt(o*o+l*l+c*c);e[0]=t*h,e[1]=i*h,e[2]=r*h,e[3]=s*d,e[4]=n*d,e[5]=a*d,e[6]=o*u,e[7]=l*u,e[8]=c*u}(Ru);const d=e.attributes.get(It.r.POSITION),u=e.attributes.get(It.r.SIZE),p=e.attributes.get(It.r.NORMAL),f=e.attributes.get(It.r.CENTEROFFSETANDDISTANCE);(0,yr.vA)(d.size>=3);const g=(0,du.c)(a),m="screen"===this.parameters.centerOffsetUnits;for(let e=0;e<d.data.length/d.size;e++){const r=e*d.size;(0,M.s)(bu,d.data[r],d.data[r+1],d.data[r+2]),(0,M.e)(bu,bu,t);const s=e*u.size;Fu[0]=u.data[s]*c,Fu[1]=u.data[s+1]*h,(0,M.e)(bu,bu,l.viewMatrix);const _=e*f.size;if((0,M.s)(Tu,f.data[_],f.data[_+1],f.data[_+2]),!m&&(bu[0]+=Tu[0],bu[1]+=Tu[1],0!==Tu[2])){const e=Tu[2];(0,M.n)(Tu,bu),(0,M.f)(bu,bu,(0,M.h)(Tu,Tu,e))}const y=e*p.size;if((0,M.s)(xu,p.data[y],p.data[y+1],p.data[y+2]),this._normalAndViewAngle(xu,Ru,l,Mu),this._applyVerticalOffsetTransformationView(bu,Mu,l,vu),l.applyProjection(bu,Su),Su[0]>-1){m&&(Tu[0]||Tu[1])&&(Su[0]+=Tu[0]*l.pixelRatio,0!==Tu[1]&&(Su[1]+=(0,lu.m0)(Tu[1],vu.factorAlignment)*l.pixelRatio),l.unapplyProjection(Su,bu)),Su[0]+=this.parameters.screenOffset[0]*l.pixelRatio,Su[1]+=this.parameters.screenOffset[1]*l.pixelRatio,Su[0]=Math.floor(Su[0]),Su[1]=Math.floor(Su[1]),(0,lu.MD)(Fu,vu.factor,Fu);const e=Iu*l.pixelRatio;let t=0;if(a.textureIsSignedDistanceField&&(t=a.outlineSize*l.pixelRatio/2),yu(o,Su[0],Su[1],Fu,e,t,a,g)){const e=i.ray;if((0,M.e)(Cu,bu,(0,O.B8)(Au,l.viewMatrix)),Su[0]=o[0],Su[1]=o[1],l.unprojectFromRenderScreen(Su,bu)){const t=(0,I.vt)();(0,M.c)(t,e.direction);const i=1/(0,M.l)(t);(0,M.h)(t,t,i),n((0,M.p)(e.origin,bu)*i,t,-1,!0,1,Cu)}}}}}intersectDraped(e,t,i,r,s,n){const a=e.attributes.get(It.r.POSITION),o=e.attributes.get(It.r.SIZE),l=this.parameters,c=(0,du.c)(l);let{scaleX:h,scaleY:d}=this._getScreenScale(e);h*=e.screenToWorldRatio,d*=e.screenToWorldRatio;const u=Du*e.screenToWorldRatio;for(let t=0;t<a.data.length/a.size;t++){const i=t*a.size,p=a.data[i],f=a.data[i+1],g=t*o.size;Fu[0]=o.data[g]*h,Fu[1]=o.data[g+1]*d;let m=0;l.textureIsSignedDistanceField&&(m=l.outlineSize*e.screenToWorldRatio/2),yu(r,p,f,Fu,u,m,l,c)&&s(n.dist,n.normal,-1,!1)}}createBufferWriter(){return new Uu(this)}_normalAndViewAngle(e,t,i,r){return function(e){return function(e){return e instanceof Float32Array&&e.length>=16}(e)||function(e){return Array.isArray(e)&&e.length>=16}(e)}(t)&&(t=(0,A.z0)(Eu,t)),(0,M.t)(r.normal,e,t),(0,M.e)(r.normal,r.normal,i.viewInverseTransposeMatrix),r.cosAngle=(0,M.j)(wu,Lu),r}_updateScaleInfo(e,t,i){const r=this.parameters;null!=r.screenSizePerspective?(0,lu.cJ)(i,t,r.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minScaleFactor=0),null!=r.screenSizePerspectiveAlignment?(0,lu.cJ)(i,t,r.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minScaleFactor=e.factor.minScaleFactor)}applyShaderOffsetsView(e,t,i,r,s,n,a){const o=this._normalAndViewAngle(t,i,s,Mu);return this._applyVerticalGroundOffsetView(e,o,s,a),this._applyVerticalOffsetTransformationView(a,o,s,n),this._applyPolygonOffsetView(a,o,r[3],s,a),this._applyCenterOffsetView(a,r,a),a}applyShaderOffsetsNDC(e,t,i,r,s){return this._applyCenterOffsetNDC(e,t,i,r),null!=s&&(0,M.c)(s,r),this._applyPolygonOffsetNDC(r,t,i,r),r}_applyPolygonOffsetView(e,t,i,r,s){const n=r.aboveGround?1:-1;let a=Math.sign(i);0===a&&(a=n);const o=n*a;if(this.parameters.shaderPolygonOffset<=0)return(0,M.c)(s,e);const l=(0,U.qE)(Math.abs(t.cosAngle),.01,1),c=1-Math.sqrt(1-l*l)/l/r.viewport[2];return(0,M.h)(s,e,o>0?c:1/c),s}_applyVerticalGroundOffsetView(e,t,i,r){const s=(0,M.l)(e),n=i.aboveGround?1:-1,a=i.computeRenderPixelSizeAtDist(s)*au.R,o=(0,M.h)(bu,t.normal,n*a);return(0,M.g)(r,e,o),r}_applyVerticalOffsetTransformationView(e,t,i,r){const s=this.parameters;if(!s.verticalOffset?.screenLength){if(s.screenSizePerspective||s.screenSizePerspectiveAlignment){const i=(0,M.l)(e);this._updateScaleInfo(r,i,t.cosAngle)}else r.factor.scale=1,r.factorAlignment.scale=1;return e}const n=(0,M.l)(e),a=s.screenSizePerspectiveAlignment??s.screenSizePerspective,o=(0,hu.kE)(i,n,s.verticalOffset,t.cosAngle,a);return this._updateScaleInfo(r,n,t.cosAngle),(0,M.h)(t.normal,t.normal,o),(0,M.g)(e,e,t.normal)}_applyCenterOffsetView(e,t,i){const r="screen"!==this.parameters.centerOffsetUnits;return i!==e&&(0,M.c)(i,e),r&&(i[0]+=t[0],i[1]+=t[1],t[2]&&((0,M.n)(xu,i),(0,M.g)(i,i,(0,M.h)(xu,xu,t[2])))),i}_applyCenterOffsetNDC(e,t,i,r){const s="screen"!==this.parameters.centerOffsetUnits;return r!==e&&(0,M.c)(r,e),s||(r[0]+=t[0]/i.fullWidth*2,r[1]+=t[1]/i.fullHeight*2),r}_applyPolygonOffsetNDC(e,t,i,r){const s=this.parameters.shaderPolygonOffset;if(e!==r&&(0,M.c)(r,e),s){const e=i.aboveGround?1:-1,n=e*Math.sign(t[3]);r[2]-=(n||e)*s}return r}createGLMaterial(e){return new _u(e)}calculateRelativeScreenBounds(e,t,i=(0,$.vt)()){return function(e,t,i,r){r[0]=e.anchorPosition[0]*-t[0]+e.screenOffset[0]*i,r[1]=e.anchorPosition[1]*-t[1]+e.screenOffset[1]*i}(this.parameters,e,t,i),i[2]=i[0]+e[0],i[3]=i[1]+e[1],i}_getScreenScale(e){const t=e.attributes.get(It.r.FEATUREATTRIBUTE);if(null==t)return{scaleX:1,scaleY:1};const i=(0,F.ci)(t.data,Pu),[r,s]=(0,_n.VC)(Ou,this.parameters,i);return{scaleX:r,scaleY:s}}}class _u extends ou.m{constructor(e){super({...e,...e.material.parameters})}selectProgram(e){return this.ensureTechnique(uu,e)}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(e)}}function yu(e,t,i,r,s,n,a,o){let l=t-s-(o[0]>0?r[0]*o[0]:0),c=l+r[0]+2*s,h=i-s-(o[1]>0?r[1]*o[1]:0),d=h+r[1]+2*s;const u=a.distanceFieldBoundingBox;return a.textureIsSignedDistanceField&&null!=u&&(l+=r[0]*u[0],h+=r[1]*u[1],c-=r[0]*(1-u[2]),d-=r[1]*(1-u[3]),l-=n,c+=n,h-=n,d+=n),e[0]>l&&e[0]<c&&e[1]>h&&e[1]<d}const vu=new class{constructor(){this.factor=new cu,this.factorAlignment=new cu}},bu=(0,I.vt)(),xu=(0,I.vt)(),Su=(0,F.vt)(),wu=(0,I.vt)(),Cu=(0,I.vt)(),Ru=(0,T.vt)(),Eu=(0,T.vt)(),Au=(0,P.vt)(),Tu=(0,I.vt)(),Ou=(0,I.vt)(),Pu=(0,F.vt)(),Mu={normal:wu,cosAngle:0},Iu=1,Du=2,Fu=[0,0],Lu=(0,I.fA)(0,0,1);class Nu extends ou.N{constructor(){super(...arguments),this.renderOccluded=Zn.m$.Occlude,this.isDecoration=!1,this.color=(0,F.fA)(1,1,1,1),this.texCoordScale=[1,1],this.polygonOffset=!1,this.anchorPosition=(0,dr.fA)(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=(0,F.fA)(1,1,1,1),this.outlineSize=0,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.draped=!1}}const Vu=(0,jn.BP)().vec3f(It.r.POSITION).vec3f(It.r.NORMAL).vec2f(It.r.UV0).vec4u8(It.r.COLOR).vec2f(It.r.SIZE).vec4f(It.r.CENTEROFFSETANDDISTANCE).vec4f(It.r.FEATUREATTRIBUTE),Gu=Vu.clone().vec4u8(It.r.OBJECTANDLAYERIDCOLOR);class Uu{constructor(e){this._material=e,this.vertexBufferLayout=(0,d.A)("enable-feature:objectAndLayerId-rendering")?Gu:Vu}elementCount(e){return 6*e.attributes.get(It.r.POSITION).indices.length}write(e,t,i,r,s){(0,$n.Hk)(i.attributes.get(It.r.POSITION),e,r.position,s,6),(0,$n.p1)(i.attributes.get(It.r.NORMAL),t,r.normal,s,6);const n=i.attributes.get(It.r.UV0).data;let a,o,l,c;if(null==n||n.length<4){const e=this._material.parameters;a=0,o=0,l=e.texCoordScale[0],c=e.texCoordScale[1]}else a=n[0],o=n[1],l=n[2],c=n[3];l=Math.min(1.99999,l+1),c=Math.min(1.99999,c+1);let h=i.attributes.get(It.r.POSITION).indices.length,d=s;const u=r.uv0;for(let e=0;e<h;++e)u.set(d,0,a),u.set(d,1,o),d++,u.set(d,0,l),u.set(d,1,o),d++,u.set(d,0,l),u.set(d,1,c),d++,u.set(d,0,l),u.set(d,1,c),d++,u.set(d,0,a),u.set(d,1,c),d++,u.set(d,0,a),u.set(d,1,o),d++;(0,$n.tb)(i.attributes.get(It.r.COLOR),4,r.color,s,6);const{data:p,indices:f}=i.attributes.get(It.r.SIZE);h=f.length;const g=r.size;d=s;for(let e=0;e<h;++e){const t=p[2*f[e]],i=p[2*f[e]+1];for(let e=0;e<6;++e)g.set(d,0,t),g.set(d,1,i),d++}if(i.attributes.get(It.r.CENTEROFFSETANDDISTANCE)?(0,$n.Ut)(i.attributes.get(It.r.CENTEROFFSETANDDISTANCE),r.centerOffsetAndDistance,s,6):(0,$n.Pq)(r.centerOffsetAndDistance,s,6*h),i.attributes.get(It.r.FEATUREATTRIBUTE)?(0,$n.Ut)(i.attributes.get(It.r.FEATUREATTRIBUTE),r.featureAttribute,s,6):(0,$n.Pq)(r.featureAttribute,s,6*h),null!=i.objectAndLayerIdColor){const e=i.attributes.get(It.r.POSITION)?.indices;if(e){const t=e.length,n=r.getField(It.r.OBJECTANDLAYERIDCOLOR,nu.XP);(0,$n.tH)(i.objectAndLayerIdColor,n,t,s,6)}}}}const zu=(0,I.fA)(0,0,1),Bu=ru.CN,Hu=[Bu/2,Bu/2,1-Bu/2,1-Bu/2],ju=[ru.Q_*Bu,ru.Q_*Bu];class Wu extends vn{getCachedSize(){return{size:this._getIconSize()}}constructor(e,t,i,r){super(e,t,i,r),this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._patchTask=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}async doLoad(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),i=this._getPrimitive();if(null!=i)this._prepareResourcesPrimitive(t,i);else{const i=(0,Id.N7)(this.symbolLayer),r=(0,pt.r$)(i);r&&"application/json"===r.mediaType?await this._prepareResourcesCIM(t,JSON.parse(r.data),e):await this._prepareResourcesHref(t,i,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=en(this._getIconSize());if(e)throw new le.A("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,t=Math.round(null!=e.size?(0,Ms.Lz)(e.size):16);return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e){let t=this._cimData;if(t&&t.symbol||this.logger.error("Can't create texture, CIM data is undefined"),t.primitiveOverrides){t=(0,ut.o8)(t);const i=t.primitiveOverrides;Ad.$.evaluateOverrides(i,e,this._arcadeInfo.geometryType,null,null),Ad.$.applyOverrides(t.symbol,i)}const i=(0,Rd.Wm)(JSON.stringify(t));let r=this._cimSymbolTextures.get(i);if(r)return r;const s=this._context.sharedResources.cimSymbolRasterizer,n=this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null;n&&Ad.$.applyDictionaryTextOverrides(t.symbol,e,n,null);const a=null!=this._cimScaleFactorOrFunction?(0,Td.s4)(this._cimScaleFactorOrFunction,e):1;1!==a&&t.symbol&&(0,Od.Km)(t.symbol,a,!0);const o=Ed.wp.getEnvelope(t,null,s.resourceManager);if(o&&o.width&&o.height){const e=o.x+o.width/2,i=o.y+o.height/2,n=s.rasterize({type:"cim",data:t},o.width,o.height,e,i,1,"esriGeometryPoint"),a=new Md.Q({x:-o.x/o.width-.5,y:(o.height+o.y)/o.height-.5});this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",a),r=new mt.g(n,{width:n?.width??1,height:n?.height??1})}else r=new mt.g(new ImageData(1,1),{width:1,height:1});return this._cimSymbolTextures.set(i,r),this._context.stage.add(r),r}_prepareMaterialParameters(){const e={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(function(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}(t)){const{screenLength:i,minWorldLength:r,maxWorldLength:s}=t.verticalOffset;e.verticalOffset={screenLength:(0,Ms.Lz)(i),minWorldLength:r||0,maxWorldLength:null!=s?s:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.hasSlicePlane=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){const i=this._getOutlineSize();if(ku(t)&&0===i)throw new Error("Nothing to render");if(this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,null!=this._context.sharedResources.textures){const i=this._context.sharedResources.textures.fromData(`${t}-icon`,(()=>(0,ru.sZ)(t)));this._textureHandle=i,e.textureId=i.texture.id}e.textureIsSignedDistanceField=!0,e.sampleSignedDistanceFieldTexelCenter=(0,ru.ny)(t),e.distanceFieldBoundingBox=Hu;const r=this._getIconSize();this._size=[r,r],this._symbolTextureRatio=1/Bu,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesHref(e,t,i){this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const r=this._getIconSize(),s=r*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(null!=this._context.sharedResources.textures){const n=await(0,dt.Ke)(this._context.sharedResources.textures.fromUrl(t,s,{signal:i}));if(!1===n.ok)throw(0,o.QP)(n.error),new le.A("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${t})`);this._textureHandle=n.value;const a=n.value.texture;this._size=this._computeSizeFromTexture(a,r),e.textureId=a.id}this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesCIM(e,t,r){if(this._cimData=t,!this._context.sharedResources.cimSymbolRasterizer){const e=(await i.e(2549).then(i.bind(i,22549))).CIMSymbolRasterizer;(0,o.Te)(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new e(this._context.renderCoordsHelper.spatialReference))}const s=this._context.sharedResources.cimSymbolRasterizer,n=[],a=t,l=a?.symbol;Ed.wp.fetchResources(l,s.resourceManager,n,r),Ed.wp.fetchFonts(l,s.resourceManager,n);const c=this._context.layer.fields?this._context.layer.fields.map((e=>e.toJSON())):[],h=this._context.renderCoordsHelper.spatialReference;if(this._arcadeInfo={spatialReference:h,fields:c,geometryType:"esriGeometryPoint"},a?.primitiveOverrides&&n.push(Ad.$.createRenderExpressions(a.primitiveOverrides,this._arcadeInfo)),n.length>0&&(await Promise.all(n),(0,o.Te)(r)),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const e=this._context.renderer;if(e.scaleExpression){const t=e.scaleExpression,i=await(0,ti.Ad)(t,this._context.layer.spatialReference,c);this._cimScaleFactorOrFunction=(e,t,r)=>{const s=(0,Dd.A)(i,e,{$view:r},"esriGeometryPoint",t);return null!==s?s:1}}}(0,o.Te)(r),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||Pd.r}_getOutlineSize(){let e=0;const t=this.symbolLayer;return null!=t.outline?.size?Math.max((0,Ms.Lz)(t.outline.size),0):(e=ku(this._getPrimitive())?1.5:0,Math.max(e,0))}_getOutlineColor(){const e=this._getLayerOpacity(),t=this.symbolLayer,i=t?.outline?.color;if(null!=i){const t=y.A.toUnitRGB(i),r=i.a*e;return[t[0],t[1],t[2],r]}return[0,0,0,0]}_getFillColor(){if(ku(this._getPrimitive()))return Fd;const e=null==this._getPrimitive(),t=this.symbolLayer?.material?.color;return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}_getAnchorPos(e,t){return"relative"===e?(0,dr.fA)((t.x||0)+.5,.5-(t.y||0)):e in eu?eu[e]:eu.center}_createMaterialAndAddToStage(e,t){if(this._cimData){this._fastUpdates=null;let i=e.textureId?this._cimSymbolMaterials.get(e.textureId):null;return i||(i=new mu(e),this._cimSymbolMaterials.set(e.textureId??0,i),t.add(i)),i}return this._fastUpdates=(0,_n.s_)(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates&&(e={...e,...this._fastUpdates.materialParameters}),this._materials[0]=new mu(e),t.add(this._materials[0]),this._materials[0]}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial((e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,draped:this.draped})})),this.layerOpacityChanged())}destroy(){super.destroy(),this._patchTask=(0,ce.DC)(this._patchTask),this._forEachMaterial((e=>this._context.stage.remove(e))),this._materials.length=0,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((e=>this._context.stage.remove(e))),this._cimSymbolTextures.clear(),this._textureHandle=(0,ce.Gz)(this._textureHandle)}_getScaleFactor(e,t){if(this._drivenProperties.size&&e.size){for(let t=0;t<3;t++){const i=e.size[t];i&&"symbol-value"!==i&&"proportional"!==i&&(e.size[t]=(0,Ms.Lz)(i))}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let i,r=[0,0];if(this._cimData){if(!this._cimData.symbol)return null;const e=this._generateTextureCIM(t),s={textureId:e.id,...this._cimMaterialParametersInfo};i=this._createMaterialAndAddToStage(s,this._context.stage),r=[e.parameters.width,e.parameters.height]}else r=this._size,i=this._materials[0];const s=zn(t.geometry);if(null==s)return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const n=e.renderingInfo,a=this._getVertexOpacityAndColor(n);let o=1;if(!this._fastUpdates?.visualVariables.size){const e=r[0]>r[1]?r[0]:r[1];o=this._getScaleFactor(n,e)}o*=this._symbolTextureRatio;const l=(0,dr.fA)(r[0]*o,r[1]*o),c=this.setGraphicElevationContext(t);return this.ensureDrapedStatus("on-the-ground"===c.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(t,s,i,a,l,e.layer.uid):this._createAs3DShape(t,s,i,a,l,c,t.uid)}layerOpacityChanged(){const e=this._getFillColor(),t=this._getOutlineColor();this._forEachMaterial((i=>{i.setParameters({color:e}),i.setParameters({outlineColor:t})}))}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=Nt(Wu.elevationModeChangeTypes,i,r);if(s!==Mt.UPDATE)return s;const n=Vt(r)||"absolute-height"===r;return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial((e=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return null!=this._getPrimitive()}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return pn.RecreateSymbol;if(!(0,_n.J_)(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return pn.RecreateSymbol;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return pn.FastUpdate}prepareSymbolLayerPatch(e){if(this._patchTask?.abort(),"partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchResource(e,t)}_preparePatchResource(e,t){if(!t.resource||"partial"!==t.resource.type)return;const i=t.resource.diff;if("complete"!==i?.href?.type)return;const r=i.href.newValue,{textures:s}=this._context.sharedResources;if(null==r||null==s)return;const n=this._getIconSize(),a=n*this._context.graphicsCoreOwner.view.state.pixelRatio;e.symbolLayerStatePatches.push((()=>{this._patchTask=(0,ce.DC)(this._patchTask),this._patchTask=(0,dt.UT)((e=>this._context.schedule((async(e,t)=>{const i=await(0,dt.Ke)(s.fromUrl(r,a,{signal:t}));(0,o.Te)(t);const l=!i.ok;if(l&&(0,o.QP)(i.error),this._textureHandle=(0,ce.Gz)(this._textureHandle),this._patchTask=null,l){this._forEachMaterial((e=>{e.visible=!1,e.setParameters({textureId:null})}));const e=`Failed to load (Request for icon resource failed: ${r})`;return void this.logger.error(new le.A("graphics3diconsymbollayer:request-failed",e))}this._textureHandle=i.value;const c=i.value.texture;this._size=this._computeSizeFromTexture(c,n),this._forEachMaterial((e=>{e.setParameters({textureId:c.id}),e.visible=!0}))}),e)))})),delete i.href}_defaultElevationInfoNoZ(){return Zu}_createAs3DShape(e,t,i,r,s,n,a){const o=this.getFastUpdateAttrValues(e),l=this._context.layer.uid,c=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerUid:l}),h=jr(i,zu,null,r,s,qu,null,o,c),d=Gn(this._context,t,h,n,a);if(null==d)return null;const u=new an(this,d.object,[h],null,null,Ls,n);return u.alignedSampledElevation=d.sampledElevation,u.needsElevationUpdates=Vt(n.mode)||"absolute-height"===n.mode,u.getScreenSize=this._createScreenSizeGetter(s,o),u.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(u.getScreenSize(),1,e),Un(u,t,this._context.elevationProvider),u}_createAsOverlay(e,t,i,r,s,n){i.renderPriority=this._renderPriority;const a=(0,I.vt)();(0,Cn.g)(t,a,this._context.overlaySR),a[2]=-2;const o=this._context.clippingExtent;if(null!=o&&!(0,q.Uc)(o,a))return null;const l=this.getFastUpdateAttrValues(e),c=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:e.uid,layerUid:this._context.layer.uid}),h=jr(i,zu,a,r,s,null,null,l,c),d=new su(h,{layerUid:n,graphicUid:e.uid}),u=new Ld(this,[d],null,this._context.drapeSourceRenderer);return u.getScreenSize=this._createScreenSizeGetter(s,l),u.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(u.getScreenSize(),1,e),u}_createScreenSizeGetter(e,t){const i=this._outlineSize+2;if(this._fastUpdates&&t){const r=e[0]/this._symbolTextureRatio,s=e[1]/this._symbolTextureRatio;return(e=(0,dr.vt)())=>{const[n,a]=(0,_n.VC)($u,this._fastUpdates.materialParameters,t);return e[0]=n*r+i,e[1]=a*s+i,e}}const r=e[0]/this._symbolTextureRatio+i,s=e[1]/this._symbolTextureRatio+i;return(e=(0,dr.vt)())=>(e[0]=r,e[1]=s,e)}_fastVisualVariableConvertOptions(){const e=Math.max(this._size[0],this._size[1]),t=(0,I.fA)(e,e,e),i=(0,Ms.PN)(1),r=e*i,s=(0,I.fA)(r,r,r);return new _n.wI({size:!0,color:!0,rotation:!0,opacity:!1},t,s,i)}_forEachMaterial(e){this._materials.forEach(e),this._cimSymbolMaterials.forEach(e)}_computeSizeFromTexture({parameters:e},t){const i=(e.width??1)/(e.height??1);return i>1?[t,Math.round(t/i)]:[Math.round(t*i),t]}test(){return{...super.test(),material:this._materials[0]}}}function ku(e){return null!=e&&("cross"===e||"x"===e)}Wu.PRIMITIVE_SIZE=ju,Wu.elevationModeChangeTypes={definedChanged:Mt.UPDATE,staysOnTheGround:Mt.NONE,onTheGroundChanged:Mt.RECREATE};const Zu={mode:"relative-to-ground",offset:0},qu=(0,F.fA)(0,0,0,1),$u=(0,I.vt)();function Qu(e){switch(e){case"butt":return No.x.BUTT;case"square":return No.x.SQUARE;case"round":return No.x.ROUND;default:return null}}function Ju(e){return"diamond"===e?"kite":e}function Yu(e,t,i=null){const r=[],s=t.mapPositions;!function(e,t){const{attributeData:{position:i},removeDuplicateStartEnd:r}=e,s=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(i)&&r,n=i.length/3-(s?1:0),a=new Array(2*(n-1)),o=s?i.slice(0,-3):i;let l=0;for(let e=0;e<n-1;e++)a[l++]=e,a[l++]=e+1;t.push([It.r.POSITION,new gr.n(o,a,3,s)])}(t,r);const n=r[0][1].data,a=r[0][1].indices.length,o=(0,Y.EH)(a);return function(e,t,i){if(null!=e.attributeData.colorFeature)return;const r=e.attributeData.color;t.push([It.r.COLOR,new gr.n(r??F.Un,i,4)])}(t,r,o),function(e,t,i){null==e.attributeData.sizeFeature&&t.push([It.r.SIZE,new gr.n([e.attributeData.size??1],i,1,!0)])}(t,r,o),function(e,t,i){e.attributeData.normal&&t.push([It.r.NORMAL,new gr.n(e.attributeData.normal,i,3)])}(t,r,o),function(e,t,i){null!=e.attributeData.colorFeature&&t.push([It.r.COLORFEATUREATTRIBUTE,new gr.n([e.attributeData.colorFeature],i,1,!0)])}(t,r,o),function(e,t,i){null!=e.attributeData.sizeFeature&&t.push([It.r.SIZEFEATUREATTRIBUTE,new gr.n([e.attributeData.sizeFeature],i,1,!0)])}(t,r,o),function(e,t,i){null!=e.attributeData.opacityFeature&&t.push([It.r.OPACITYFEATUREATTRIBUTE,new gr.n([e.attributeData.opacityFeature],i,1,!0)])}(t,r,o),function(e,t,i){if(null==e.overlayInfo||e.overlayInfo.renderCoordsHelper.viewingMode!==oe.RT.Global||!e.overlayInfo.spatialReference.isGeographic)return;const r=(0,Q.jh)(i.length),s=(0,wt.tO)(e.overlayInfo.spatialReference);for(let e=0;e<r.length;e+=3)(0,N.RC)(i,e,r,e,s);const n=i.length/3,a=(0,J.oe)(n+1);let o=Xu,l=Ku,c=0,h=0;(0,xa.hZ)(o,r[h++],r[h++]),h++,a[0]=0;for(let e=1;e<n+1;++e)e===n&&(h=0),(0,xa.hZ)(l,r[h++],r[h++]),h++,c+=(0,xa.xg)(o,l),a[e]=c,[o,l]=[l,o];t.push([It.r.DISTANCETOSTART,new gr.n(a,t[0][1].indices,1,!0)])}(t,r,n),new _r.V(e,r,s,mr.X.Line,i)}const Xu=(0,dr.vt)(),Ku=(0,dr.vt)();function ep(e,t,i=null){const r=new Array;for(const{index:s,count:n}of e){if(n<=1)continue;const e=3*s,a=3*n;r.push({position:(0,Q.l5)(t,3*s,3*n),mapPositions:null!=i?(0,Q.l5)(i,e,a):void 0})}return r}var tp=i(94066);const ip=new Map([[It.r.POSITION,0],[It.r.PREVPOSITION,1],[It.r.UV0,2],[It.r.NORMAL,3],[It.r.COLOR,4],[It.r.COLORFEATUREATTRIBUTE,4],[It.r.SIZE,5],[It.r.SIZEFEATUREATTRIBUTE,5],[It.r.OPACITYFEATUREATTRIBUTE,6]]);class rp extends Jn.w{initializeProgram(e){return new Xn.B(e.rctx,rp.shader.get().build(this.configuration),ip)}_makePipelineState(e,t){const i=this.configuration,r=e===Mo.y.NONE;return(0,ea.Ey)({blending:i.output===Wn.V.Color||i.output===Wn.V.Alpha?r?Oo.V0:(0,Oo.ez)(e):null,depthTest:i.space===Ao.lM.Draped?null:{func:(0,Oo.K_)(e)},depthWrite:i.space===Ao.lM.Draped?null:r?i.writeDepth?ea.kn:null:(0,Oo.XO)(e),colorWrite:ea.wE,stencilWrite:i.hasOccludees?Po.v0:null,stencilTest:i.hasOccludees?t?Po.a9:Po.qh:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=(0,ea.Ey)({blending:Oo.V0,depthTest:Po.sf,depthWrite:null,colorWrite:ea.wE,stencilWrite:null,stencilTest:Po.mK}),this._occluderPipelineOpaque=(0,ea.Ey)({blending:Oo.V0,depthTest:Po.sf,depthWrite:null,colorWrite:ea.wE,stencilWrite:Po.r8,stencilTest:Po.I$}),this._occluderPipelineMaskWrite=(0,ea.Ey)({blending:null,depthTest:Po.m,depthWrite:null,colorWrite:null,stencilWrite:Po.v0,stencilTest:Po.a9})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipeline(e,t,i){return e?this._occludeePipelineState:this.configuration.occluder?i?this._occluderPipelineTransparent:t?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}}rp.shader=new Qn.$(tp.L,(()=>i.e(7810).then(i.bind(i,17810))));class sp extends Zn.im{constructor(e){super(e,new ap),this.produces=new Map([[qn.N.OPAQUE_MATERIAL,e=>e===Wn.V.Highlight||(0,Wn.j8)(e)&&this.parameters.renderOccluded===Zn.m$.OccludeAndTransparentStencil],[qn.N.OPAQUE_NO_SSAO_DEPTH,e=>e===Wn.V.LinearDepth],[qn.N.OCCLUDER_MATERIAL,e=>(0,Wn.MU)(e)&&this.parameters.renderOccluded===Zn.m$.OccludeAndTransparentStencil],[qn.N.TRANSPARENT_OCCLUDER_MATERIAL,e=>(0,Wn.MU)(e)&&this.parameters.renderOccluded===Zn.m$.OccludeAndTransparentStencil],[qn.N.TRANSPARENT_MATERIAL,e=>(0,Wn.j8)(e)&&this.parameters.writeDepth],[qn.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>(0,Wn.j8)(e)&&!this.parameters.writeDepth],[qn.N.DRAPED_MATERIAL,e=>e===Wn.V.Color||e===Wn.V.Highlight]]),this._vertexAttributeLocations=ip,this._configuration=new Ao.Dt,this._layout=this.createLayout()}getConfiguration(e,t){return this._configuration.output=e,this._configuration.space=t.slot===qn.N.DRAPED_MATERIAL?Ao.lM.Draped:this.parameters.worldSpace?Ao.lM.World:Ao.lM.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==No.x.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.occluder=this.parameters.renderOccluded===Zn.m$.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const e=(0,jn.BP)().vec3f(It.r.POSITION).vec3f(It.r.PREVPOSITION).vec2f(It.r.UV0);return this.parameters.worldSpace&&e.vec3f(It.r.NORMAL),this.parameters.vvSize?e.f32(It.r.SIZEFEATUREATTRIBUTE):e.f32(It.r.SIZE),this.parameters.vvColor?e.f32(It.r.COLORFEATUREATTRIBUTE):e.vec4f(It.r.COLOR),this.parameters.vvOpacity&&e.f32(It.r.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new op(this._layout,this.parameters)}createGLMaterial(e){return new np(e)}}class np extends ou.m{constructor(){super(...arguments),this._markerPrimitive=null}dispose(){super.dispose(),this._markerTextureRepository.release(this._markerPrimitive),this._markerPrimitive=null}_updateParameters(e){const t=this._material.parameters.markerPrimitive;return t!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextureRepository.swap(t,this._markerPrimitive)}),this._markerPrimitive=t),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(rp,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==Wn.V.Color&&this._output!==Wn.V.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class ap extends Eo.S{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive="arrow",this.placement="end",this.cap=No.x.BUTT,this.anchor=Ao.kJ.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1,this.markerTexture=null}}class op{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t}elementCount(){return"begin-end"===this._parameters.placement?12:6}write(e,t,i,r,s){const n=i.attributes.get(It.r.POSITION).data,a=n.length/3;let o=[1,0,0];const l=i.attributes.get(It.r.NORMAL);this._parameters.worldSpace&&null!=l&&(o=l.data);let c=1,h=0;this._parameters.vvSize?h=i.attributes.get(It.r.SIZEFEATUREATTRIBUTE).data[0]:i.attributes.has(It.r.SIZE)&&(c=i.attributes.get(It.r.SIZE).data[0]);let d=[1,1,1,1],u=0;this._parameters.vvColor?u=i.attributes.get(It.r.COLORFEATUREATTRIBUTE).data[0]:i.attributes.has(It.r.COLOR)&&(d=i.attributes.get(It.r.COLOR).data);let p=0;this._parameters.vvOpacity&&(p=i.attributes.get(It.r.OPACITYFEATUREATTRIBUTE).data[0]);const f=new Float32Array(r.buffer);let g=s*(this.vertexBufferLayout.stride/4);const m=(e,t,i,r)=>{if(f[g++]=e[0],f[g++]=e[1],f[g++]=e[2],f[g++]=t[0],f[g++]=t[1],f[g++]=t[2],f[g++]=i[0],f[g++]=i[1],this._parameters.worldSpace&&(f[g++]=o[0],f[g++]=o[1],f[g++]=o[2]),this._parameters.vvSize?f[g++]=h:f[g++]=c,this._parameters.vvColor)f[g++]=u;else{const e=Math.min(4*r,d.length-4);f[g++]=d[e],f[g++]=d[e+1],f[g++]=d[e+2],f[g++]=d[e+3]}this._parameters.vvOpacity&&(f[g++]=p)};let _;!function(e){e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=-1]="DESCENDING"}(_||(_={}));const y=(t,i)=>{const r=(0,M.s)(lp,n[3*t],n[3*t+1],n[3*t+2]),s=cp;let o=t+i;do{(0,M.s)(s,n[3*o],n[3*o+1],n[3*o+2]),o+=i}while((0,M.F)(r,s)&&o>=0&&o<a);e&&((0,M.e)(r,r,e),(0,M.e)(s,s,e)),m(r,s,[-1,-1],t),m(r,s,[1,-1],t),m(r,s,[1,1],t),m(r,s,[-1,-1],t),m(r,s,[1,1],t),m(r,s,[-1,1],t)},v=this._parameters.placement;"begin"!==v&&"begin-end"!==v||y(0,_.ASCENDING),"end"!==v&&"begin-end"!==v||y(a-1,_.DESCENDING)}}const lp=(0,I.vt)(),cp=(0,I.vt)(),hp={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},dp={dash:hp.dash,"dash-dot":[...hp.dash,...hp.dot],dot:hp.dot,"long-dash":hp["long-dash"],"long-dash-dot":[...hp["long-dash"],...hp.dot],"long-dash-dot-dot":[...hp["long-dash"],...hp.dot,...hp.dot],none:null,"short-dash":hp["short-dash"],"short-dash-dot":[...hp["short-dash"],...hp["short-dot"]],"short-dash-dot-dot":[...hp["short-dash"],...hp["short-dot"],...hp["short-dot"]],"short-dot":hp["short-dot"],solid:null};function up(e){return null!=e&&"style"===e.type?function(e){return null!=e?function(e,t){return null==e?e:{pattern:e.slice(),pixelRatio:8}}(dp[e]):null}(e.style):null}var pp=i(8e3);const fp=["polyline","polygon","extent"],gp=new _n.wI({size:!0,color:!0,rotation:!1,opacity:!0});class mp extends vn{constructor(e,t,i,r){super(e,t,i,r)}async doLoad(){if(this._fastUpdates=(0,_n.s_)(this._context.renderer,gp),!this._drivenProperties.size&&(null!=this.symbolLayer.size?this.symbolLayer.size:(0,Ms.PN)(1))<0)throw new le.A("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values")}_getMaterialParameters(e,t=!1){const i=this._getCombinedOpacityAndColor(t&&this._markerColor||this._materialColor);this._patternHidesLine&&!t&&(i[3]=0);const r={width:this._computeMaterialWidth(this.symbolLayer?.size),color:i,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:Qu(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:up(this.symbolLayer.pattern)};return this._fastUpdates?.visualVariables?{...r,...this._fastUpdates.materialParameters}:r}get _materialColor(){return this.symbolLayer.material?.color}get _markerColor(){return this.symbolLayer.marker?.color}get _lineMaterial(){return null==this._materials[yp.Line]&&(this._materials[yp.Line]=new Vo(this._getMaterialParameters(!1)),this._context.stage.add(this._materials[yp.Line])),this._materials[yp.Line]}get _ringMaterial(){return null==this._materials[yp.Ring]&&(this._materials[yp.Ring]=new Vo(this._getMaterialParameters(!0)),this._context.stage.add(this._materials[yp.Ring])),this._materials[yp.Ring]}get _wireframeLineMaterial(){return null==this._materials[yp.LineWireframe]&&(this._materials[yp.LineWireframe]=new Vo({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._materials[yp.LineWireframe])),this._materials[yp.LineWireframe]}get _wireframeRingMaterial(){return null==this._materials[yp.RingWireframe]&&(this._materials[yp.RingWireframe]=new Vo({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._materials[yp.RingWireframe])),this._materials[yp.RingWireframe]}get _markerMaterial(){return null==this._materials[yp.Marker]&&null!=this.symbolLayer.marker&&(this._materials[yp.Marker]=new sp({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,markerPrimitive:Ju(this.symbolLayer.marker.style)}),this._context.stage.add(this._materials[yp.Marker])),this._materials[yp.Marker]}destroy(){super.destroy(),this._forEachMaterial((e=>this._context.stage.remove(e))),this._materials.length=0}_getDrivenSize(e){return this._drivenProperties.size&&e.size?(0,Ms.Lz)(function(e){for(let t=0;t<3;t++){const i=e[t];if("number"==typeof i)return isFinite(i)?i:0}return 0}(e.size)):1}_getDrivenColor(e){const t=(0,F.fA)(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,fp,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,t.uid)}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return pn.RecreateSymbol;{const e=this._fastUpdates;if(!(0,_n.J_)(e,t,gp))return pn.RecreateSymbol;this._forEachMaterial((t=>t?.setParameters(e.materialParameters)))}}return pn.FastUpdate}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff,i={};"complete"===t.size?.type&&(i.width=this._computeMaterialWidth(t.size.newValue),delete t.size),"complete"===t.cap?.type&&(i.cap=Qu(t.cap.newValue??"butt"),delete t.cap);const r=this._prepareMarkerPatch(e,t);this._prepareMaterialPatch(e,t,r),e.symbolLayerStatePatches.push((()=>this._forEachMaterial((e=>e?.setParameters(i)))))}layerOpacityChanged(){this._forEachMaterial(((e,t)=>this._updateMaterialLayerOpacity(e,t===yp.Marker)))}_forEachMaterial(e){this._materials.forEach(e)}_updateMaterialLayerOpacity(e,t=!1){if(null==e)return;const i=e.parameters.color,r=this.symbolLayer?.material?.color,s=this._patternHidesLine&&!t?0:this._getCombinedOpacity(r),n=(0,F.fA)(i[0],i[1],i[2],s);e.setParameters({color:n})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=Nt(mp.elevationModeChangeTypes,i,r);if(s!==Mt.UPDATE)return s;const n=Vt(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){const e={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial((t=>t?.setParameters(e))),!0}physicalBasedRenderingChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof pp.A)return Sa.A.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,t,i){const r=e.graphic,s=this._getGeometryAsPolygonOrPolyline(r.geometry),n="polygon"===s.type?s.rings:s.paths,a=new Array,o=(0,q.vt)(),l=function(e,t,i,r){const s="polygon"===e.type?La.Wq.CCW_IS_HOLE:La.Wq.NONE,n="polygon"===e.type?e.rings:e.paths,{position:a,outlines:o}=(0,La.jp)(n,!!e.hasZ,s,e.spatialReference),l=(0,Q.jh)(a.length),c=Dt(a,e.spatialReference,0,l,0,a,0,a.length/3,t,i,r),h=null!=c;return{lines:h?ep(o,a,l):[],projectionSuccess:h,sampledElevation:c}}(s,this._context.elevationProvider,this._context.renderCoordsHelper,t),c="polygon"===s.type?"rings":"paths";this._logGeometryCreationWarnings(l,n,c,"LineSymbol3DLayer");for(let t=0;t<l.lines.length;t++){const r=l.lines[t],n=r.position,c=r.mapPositions;if(null!=this._context.clippingExtent&&((0,q.Ie)(o),(0,q.Hq)(o,c),!(0,q.KG)(o,this._context.clippingExtent)))continue;const h=this._createGeometry("polygon"===s.type?this._ringMaterial:this._lineMaterial,e,n,c,s.type,_p.ELEVATED,i);a.push(h),Is.b.LINE_WIREFRAMES&&a.push(h.instantiate({material:"polygon"===s.type?this._wireframeRingMaterial:this._wireframeLineMaterial})),null!=this._markerMaterial&&a.push(h.instantiate({material:this._markerMaterial}))}if(0===a.length)return null;const h=new On({geometries:a,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:i}),d=new an(this,h,a,null,null,Gs,t);return d.alignedSampledElevation=l.sampledElevation,d.needsElevationUpdates=Vt(t.mode),d}_createGeometry(e,t,i,r,s,n,a){const o=n===_p.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,l="polygon"===s,c=this._fastUpdates?.visualVariables.color,h=this._fastUpdates?.visualVariables.size,d=this._fastUpdates?.visualVariables.opacity,u=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerUid:this._context.layer.uid});return Yu(e,{overlayInfo:o,removeDuplicateStartEnd:l,mapPositions:r,attributeData:{position:i,size:h?null:this._getDrivenSize(t.renderingInfo),color:c?null:this._getDrivenColor(t.renderingInfo),sizeFeature:h?(0,_n.ul)(h.field,t.graphic):null,colorFeature:c?(0,_n.ul)(c.field,t.graphic):null,opacityFeature:d?(0,_n.ul)(d.field,t.graphic):null}},u)}_createAsOverlay(e,t){const i=e.graphic,r=this._getGeometryAsPolygonOrPolyline(i.geometry),s="polygon"===r.type?r.rings:r.paths,n="polygon"===r.type?this._ringMaterial:this._lineMaterial;n.renderPriority=this._renderPriority;const a=Is.b.LINE_WIREFRAMES?"polygon"===r.type?this._wireframeRingMaterial:this._wireframeLineMaterial:null,o=this._markerMaterial;null!=a&&(a.renderPriority=this._renderPriority-.001),null!=o&&(o.renderPriority=this._renderPriority-.002);const l=new Array,c=(0,q.vt)(),h=(0,q.Ie)(),d=function(e,t){const i="polygon"===e.type?La.Wq.CCW_IS_HOLE:La.Wq.NONE,r="polygon"===e.type?e.rings:e.paths,{position:s,outlines:n}=(0,La.jp)(r,!1,i),a=(0,k.projectBuffer)(s,e.spatialReference,0,s,t,0,s.length/3);for(let e=2;e<s.length;e+=3)s[e]=-2;return{lines:a?ep(n,s):[],projectionSuccess:a}}(r,this._context.overlaySR),u="polygon"===r.type?"rings":"paths";this._logGeometryCreationWarnings(d,s,u,"LineSymbol3DLayer");for(const s of d.lines){if((0,q.Ie)(c),(0,q.Hq)(c,s.position),!(0,q.KG)(c,this._context.clippingExtent))continue;(0,q.RF)(h,c);const d=n=>{const a=this._createGeometry(n,e,s.position,void 0,r.type,_p.DRAPED,i.uid),o=new su(a,{layerUid:t,graphicUid:i.uid});l.push(o)};if(null!=o){d(o);const e=this.symbolLayer.marker.placement;"begin"!==e&&"begin-end"!==e||(0,q.Hq)(c,s.position,0,1),"end"!==e&&"begin-end"!==e||(0,q.Hq)(c,s.position,s.position.length-3,1)}d(n),Is.b.LINE_WIREFRAMES&&d(a)}return new Ld(this,l,h,this._context.drapeSourceRenderer)}get _patternHidesLine(){const e=this.symbolLayer.pattern;return null!=e&&"style"===e.type&&"none"===e.style}_computeMaterialWidth(e){return e=e??(0,Ms.PN)(1),this._drivenProperties.size?this._fastUpdates?.visualVariables.size?(0,Ms.Lz)(1):1:(0,Ms.Lz)(e)}_prepareMaterialPatch(e,t,i){const r=t.material;if(null==r)return void(i.changed&&i.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._materials[yp.Marker],e));if("collection"===r.type)return;const s="complete"===r.type?r.newValue?.color:"complete"===r.diff.color?.type?r.diff.color.newValue:null,n=this._getCombinedOpacityAndColor(s);i.useMaterialColor&&this._patchMaterialColor((0,F.o8)(n),this._materials[yp.Marker],e),this._patternHidesLine&&(n[3]=0),this._patchMaterialColor(n,this._materials[yp.Line],e),delete t.material}_prepareMarkerPatch(e,t){const i=t.marker,r=this._markerMaterial;if(null==i||"partial"!==i.type||null==i.diff||null!=i.diff.placement||null!=i.diff.style&&"complete"!==i.diff.style.type||null!=i.diff.color&&"complete"!==i.diff.color.type||null==r)return{changed:!1,useMaterialColor:null==this._markerColor};const s=i.diff.color,n=null!=s,a=n?s.newValue:null,o=null==a&&null==this._markerColor;a&&this._patchMaterialColor(this._getCombinedOpacityAndColor(a),r,e);const l=i.diff.style?.newValue;return l&&e.symbolLayerStatePatches.push((()=>r.setParameters({markerPrimitive:Ju(l)}))),delete t.marker,{changed:n,useMaterialColor:o}}_patchMaterialColor(e,t,i){null!=t&&i.symbolLayerStatePatches.push((()=>t.setParameters({color:e})))}}var _p,yp;mp.elevationModeChangeTypes={definedChanged:Mt.RECREATE,staysOnTheGround:Mt.NONE,onTheGroundChanged:Mt.RECREATE},function(e){e[e.DRAPED=0]="DRAPED",e[e.ELEVATED=1]="ELEVATED"}(_p||(_p={})),function(e){e[e.Line=0]="Line",e[e.Ring=1]="Ring",e[e.LineWireframe=2]="LineWireframe",e[e.RingWireframe=3]="RingWireframe",e[e.Marker=4]="Marker"}(yp||(yp={}));const vp=(0,I.vt)();var bp,xp=i(2366),Sp=i(64855),wp=i(4388),Cp=i(56233),Rp=i(90514);!function(e){e[e.EnableFastUpdates=0]="EnableFastUpdates",e[e.DisableFastUpdates=1]="DisableFastUpdates",e[e.UpdateFastLocalOrigin=2]="UpdateFastLocalOrigin"}(bp||(bp={}));var Ep=i(61764);class Ap extends an{constructor(){super(...arguments),this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}enableFastTransformUpdates(e,t){if(this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!0;const{stageObject:i}=this,r=i.geometries.slice();i.removeAllGeometries();const s=(0,O.sC)(Tp,i.transformation),n=t.getOrigin(s);for(const t of r){const r=e(t.material),s=t.instantiate({material:r});s.localOrigin=n,i.addGeometry(s)}this._originalGeometries=r}disableFastTransformUpdates(e){if(!this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!1;const{stageObject:t}=this,i=t.geometries.map((t=>e(t.material)));t.removeAllGeometries();for(let e=0;e<this._originalGeometries.length;e++){const r=this._originalGeometries[e],s=i[e];s.setParameters({modelTransformation:null}),s===r.material?t.addGeometry(r):t.addGeometry(r.instantiate({material:s}))}this._originalGeometries.length=0}updateFastLocalOrigin(e,t,i){if(!this._fastTransformUpdatesEnabled)return;const{stageObject:r}=this;if(0===r.geometries.length)return;const s=r.geometries[0].localOrigin,n=(0,O.sC)(Tp,e),a=i.getOrigin(n);if(a===s)return;const o=t?.localMatrix??P.zK;r.shaderTransformation=null,r.transformation=e,r.geometries.forEach((e=>{e.transformation=o,e.localOrigin=a}))}updateTransform(e,t,i){const{stageObject:r}=this,s=t?.localMatrix??P.zK;if(!this._fastTransformUpdatesEnabled)return r.shaderTransformation=null,r.transformation=e,r.geometries.forEach((e=>{e.transformation=s})),void(this._fastUpdateEdgeTransform()||this.resetEdgeObject(i));const n=r.transformation,a=r.geometries[0].transformation,o=e,l=s,c=(0,O.lw)(Op,n,a),h=(0,O.lw)(Pp,o,l),d=(0,O.lw)(Ip,h,(0,O.B8)(Ip,a));r.shaderTransformation=d,this._setFastMaterialTransformation({matA:c,matB:h}),this._fastUpdateEdgeTransform()||this.resetEdgeObject(i)}alignWithElevation(e,t,i,r){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(e,t,i,r);null!=i&&si(this.elevationContext.featureExpressionInfoContext,i);const{stageObject:s}=this;if(!s.geometries[0].material.parameters.modelTransformation)return;const n=s.transformation,a=s.geometries[0].transformation,o=(0,O.lw)(Op,n,a),l=s.effectiveTransformation,c=(0,O.C)(Mp,l);this.alignedSampledElevation=Ls(this,this.elevationContext,e.spatialReference,((i,r)=>Ft(i,e,this.elevationContext,t,r)),t,c),s.shaderTransformation=c;const h=s.geometries[0].transformation,d=(0,O.lw)(Pp,c,h);this._setFastMaterialTransformation({matA:o,matB:d}),this._fastUpdateEdgeTransform()||this.resetEdgeObject(r)}_setFastMaterialTransformation({matA:e,matB:t}){const{stageObject:i}=this;if(0===i.geometries.length)return;const r=i.geometries[0].localOrigin,s=(0,O.kN)(Lp,(0,M.h)(Tp,r.vec3,-1)),n=(0,O.lw)(Dp,s,e),a=(0,O.lw)(Fp,s,t),o=(0,O.B8)(Dp,n),l=(0,O.lw)(Fp,a,o);for(const e of i.geometries)e.material.setParameters({modelTransformation:l})}_fastUpdateEdgeTransform(){return this._stageLayer.stage.renderer.ensureEdgeView().fastUpdateObject3DEdgesTransform(this.stageObject)}}const Tp=(0,I.vt)(),Op=(0,P.vt)(),Pp=(0,P.vt)(),Mp=(0,P.vt)(),Ip=(0,P.vt)(),Dp=(0,P.vt)(),Fp=(0,P.vt)(),Lp=(0,P.vt)();class Np{constructor(){this._fastTransformOriginalMaterials=new Map,this._fastTransformClonedMaterials=new Map,this._graphicReferenceCount=0}enable(e,t,i){e.enableFastTransformUpdates((e=>{if(this._graphicReferenceCount<=1){if(this._fastTransformOriginalMaterials.has(e))return e;const i=t.byMaterial(e);return this._fastTransformOriginalMaterials.set(e,i),t.delete(e),e}const r=new os.$U(e.parameters);return i.stage.add(r),this._fastTransformClonedMaterials.set(r,e),r}),i.localOriginFactory)}disable(e,t,i){const r=new Set,s=new Set;e.disableFastTransformUpdates((e=>{if(!this._fastTransformClonedMaterials.has(e)){const i=e,n=this._fastTransformOriginalMaterials.get(i);return t.has(n.uid)?(r.add(i),t.byUid(n.uid).material):(s.add(i),n.material)}const n=e,a=this._fastTransformClonedMaterials.get(n);return this._fastTransformClonedMaterials.delete(n),i.stage.remove(n),a}));for(const e of r)this._fastTransformOriginalMaterials.delete(e),i.stage.remove(e);for(const e of s){const i=this._fastTransformOriginalMaterials.get(e);this._fastTransformOriginalMaterials.delete(e),t.set(i.uid,i)}}onAddGraphic(){this._graphicReferenceCount++}onRemoveGraphic(e,t,i){this._graphicReferenceCount--,this.disable(e,t,i)}forEachMaterialInfo(e){this._fastTransformOriginalMaterials.forEach(e)}forEachClonedMaterial(e){this._fastTransformClonedMaterials.forEach(e)}destroy(e){e.removeMany(Array.from(this._fastTransformClonedMaterials.keys())),e.removeMany(Array.from(this._fastTransformOriginalMaterials.values(),(({material:e})=>e))),this._fastTransformClonedMaterials.clear(),this._fastTransformOriginalMaterials.clear()}}class Vp{constructor(){this._byUid=new Map,this._byMaterial=new Map}get materials(){return Array.from(this._byUid.values(),(e=>e.material))}byUid(e){return this._byUid.get(e)}byMaterial(e){return this._byMaterial.get(e)}set(e,t){this._byUid.set(e,t),this._byMaterial.set(t.material,t)}delete(e){const t=this._byMaterial.get(e)?.uid;t&&(this._byUid.delete(t),this._byMaterial.delete(e))}has(e){return this._byUid.has(e)}forEachMaterialInfo(e){this._byUid.forEach(e)}clear(){this._byUid.clear(),this._byMaterial.clear()}}var Gp=i(96153),Up=i(66356);const zp=(0,jn.BP)().vec3f(It.r.POSITION),Bp=(0,jn.BP)().vec3f(It.r.POSITION).vec2f(It.r.UV0),Hp=(0,jn.BP)().vec3f(It.r.POSITION).vec4u8(It.r.COLOR),jp=((0,jn.BP)().vec3f(It.r.POSITION).vec4u8(It.r.OBJECTANDLAYERIDCOLOR),(0,jn.BP)().vec3f(It.r.POSITION).vec2f(It.r.UV0).vec4u8(It.r.OBJECTANDLAYERIDCOLOR));(0,jn.BP)().vec3f(It.r.POSITION).vec4u8(It.r.COLOR).vec4u8(It.r.OBJECTANDLAYERIDCOLOR);var Wp=i(71005);class kp extends Jn.w{initializeProgram(e){return new Xn.B(e.rctx,kp.shader.get().build(this.configuration),Yn.D)}initializePipeline(){const e=this.configuration,t=(0,ea.p3)(_t.dn.SRC_ALPHA,_t.dn.ONE,_t.dn.ONE_MINUS_SRC_ALPHA,_t.dn.ONE_MINUS_SRC_ALPHA),i=(t,i=null,r=null)=>(0,ea.Ey)({blending:i,depthTest:Po.m,depthWrite:r,colorWrite:ea.wE,stencilWrite:e.hasOccludees?Po.v0:null,stencilTest:e.hasOccludees?t?Po.a9:Po.qh:null});return e.output===Wn.V.Color?(this._occludeePipelineState=i(!0,e.transparent?t:null,ea.kn),i(!1,e.transparent?t:null,ea.kn)):i(!1)}get primitiveType(){return _t.WR.LINES}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}kp.shader=new Qn.$(Wp.N,(()=>i.e(7130).then(i.bind(i,94749))));class Zp extends ra.E{constructor(){super(...arguments),this.output=Wn.V.Color,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.hasOccludees=!1}}(0,r._)([(0,ia.W)({count:Wn.V.COUNT})],Zp.prototype,"output",void 0),(0,r._)([(0,ia.W)()],Zp.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ia.W)()],Zp.prototype,"hasVertexColors",void 0),(0,r._)([(0,ia.W)()],Zp.prototype,"transparent",void 0),(0,r._)([(0,ia.W)()],Zp.prototype,"hasOccludees",void 0);class qp extends Zn.im{constructor(e){super(e,new Qp),this._configuration=new Zp,this.produces=new Map([[qn.N.OPAQUE_MATERIAL,e=>e===Wn.V.Color||e===Wn.V.Highlight||e===Wn.V.ObjectAndLayerIdColor]])}getConfiguration(e){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration}intersect(e,t,i,r,s,n){if(!i.options.selectionMode||!e.visible)return;if(!(0,yr.zH)(t))return void a.A.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const o=e.attributes.get(It.r.POSITION).data,l=i.camera,c=of;(0,xa.C)(c,i.point),(0,M.s)(lf[0],c[0]-2,c[1]+2,0),(0,M.s)(lf[1],c[0]+2,c[1]+2,0),(0,M.s)(lf[2],c[0]+2,c[1]-2,0),(0,M.s)(lf[3],c[0]-2,c[1]-2,0);for(let e=0;e<4;e++)if(!l.unprojectFromRenderScreen(lf[e],cf[e]))return;(0,pr.Cr)(l.eye,cf[0],cf[1],hf),(0,pr.Cr)(l.eye,cf[1],cf[2],df),(0,pr.Cr)(l.eye,cf[2],cf[3],uf),(0,pr.Cr)(l.eye,cf[3],cf[0],pf);let h=Number.MAX_VALUE,d=0;for(let e=0;e<o.length-5;e+=3){if(Jp[0]=o[e]+t[12],Jp[1]=o[e+1]+t[13],Jp[2]=o[e+2]+t[14],Yp[0]=o[e+3]+t[12],Yp[1]=o[e+4]+t[13],Yp[2]=o[e+5]+t[14],(0,pr.mN)(hf,Jp)<0&&(0,pr.mN)(hf,Yp)<0||(0,pr.mN)(df,Jp)<0&&(0,pr.mN)(df,Yp)<0||(0,pr.mN)(uf,Jp)<0&&(0,pr.mN)(uf,Yp)<0||(0,pr.mN)(pf,Jp)<0&&(0,pr.mN)(pf,Yp)<0)continue;if(l.projectToRenderScreen(Jp,ef),l.projectToRenderScreen(Yp,tf),ef[2]<0&&tf[2]>0){(0,M.f)(Xp,Jp,Yp);const e=l.frustum,t=-(0,pr.mN)(e[Rt.FB.NEAR],Jp)/(0,M.j)(Xp,(0,pr.Qj)(e[Rt.FB.NEAR]));(0,M.h)(Xp,Xp,t),(0,M.g)(Jp,Jp,Xp),l.projectToRenderScreen(Jp,ef)}else if(ef[2]>0&&tf[2]<0){(0,M.f)(Xp,Yp,Jp);const e=l.frustum,t=-(0,pr.mN)(e[Rt.FB.NEAR],Yp)/(0,M.j)(Xp,(0,pr.Qj)(e[Rt.FB.NEAR]));(0,M.h)(Xp,Xp,t),(0,M.g)(Yp,Yp,Xp),l.projectToRenderScreen(Yp,tf)}else if(ef[2]<0&&tf[2]<0)continue;ef[2]=0,tf[2]=0;const i=(0,Ro.kb)((0,Ro.Cr)(ef,tf,nf),c);i<h&&(h=i,(0,M.c)(rf,Jp),(0,M.c)(sf,Yp),d=e/3)}const u=i.rayBegin,p=i.rayEnd;if(h<4){let e=Number.MAX_VALUE;if((0,Ro.ld)((0,Ro.Cr)(rf,sf,nf),(0,Ro.Cr)(u,p,af),Kp)){(0,M.f)(Kp,Kp,u);const t=(0,M.l)(Kp);(0,M.h)(Kp,Kp,1/t),e=t/(0,M.p)(u,p)}n(e,Kp,d,!1)}}intersectDraped(e,t,i,r,s,n){if(!i.options.selectionMode)return;const a=e.attributes.get(It.r.POSITION).data,o=e.attributes.get(It.r.SIZE),l=o?o.data[0]:0,c=r[0],h=r[1],d=((l+1)/2+4)*e.screenToWorldRatio;let u=Number.MAX_VALUE,p=0;for(let e=0;e<a.length-5;e+=3){const t=a[e],i=a[e+1],r=c-t,s=h-i,n=a[e+3]-t,o=a[e+4]-i,l=(0,U.qE)((n*r+o*s)/(n*n+o*o),0,1),d=n*l-r,f=o*l-s,g=d*d+f*f;g<u&&(u=g,p=e/3)}u<d*d&&s(n.dist,n.normal,p,!1)}createGLMaterial(e){return new $p(e)}createBufferWriter(){const e=this.parameters.hasVertexColors?Hp:zp;return new Up.Z(e)}}class $p extends kn.A{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output===Wn.V.Color&&this._updateOccludeeState(e),this.ensureTechnique(kp,e)}}class Qp extends Zn.qA{constructor(){super(...arguments),this.color=F.Un,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1,this.hasOccludees=!1}}const Jp=(0,I.vt)(),Yp=(0,I.vt)(),Xp=(0,I.vt)(),Kp=(0,I.vt)(),ef=(0,Ms.r_)(),tf=(0,Ms.r_)(),rf=(0,I.vt)(),sf=(0,I.vt)(),nf=(0,Ro.vt)(),af=(0,Ro.vt)(),of=(0,I.vt)(),lf=[(0,Ms.r_)(),(0,Ms.r_)(),(0,Ms.r_)(),(0,Ms.r_)()],cf=[(0,I.vt)(),(0,I.vt)(),(0,I.vt)(),(0,I.vt)()],hf=(0,pr.vt)(),df=(0,pr.vt)(),uf=(0,pr.vt)(),pf=(0,pr.vt)(),ff=["mesh"];class gf{constructor(e,t,i){this.normals=e,this.indices=t,this.didFlipNormals=i}}const mf=(0,I.vt)(),_f=(0,I.vt)(),yf=(0,I.vt)(),vf=(0,I.vt)(),bf=(0,I.vt)(),xf=(0,P.vt)(),Sf=(0,T.vt)(),wf=(0,P.vt)(),Cf=(0,q.vt)(),Rf=[new xp.A],Ef=new wp.A;var Af;!function(e){e[e.NONE=0]="NONE",e[e.RENDER=1]="RENDER"}(Af||(Af={}));var Tf=i(41394);class Of{constructor(e,t,i,r){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=r,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const t=this._lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){null!=this.instanceIndex&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,t,i){if(this.elevationAligner){si(this.elevationContext.featureExpressionInfoContext,i);const r=(i,r)=>Ft(i,e,this.elevationContext,t,r),s=this.elevationAligner(this,this.elevationContext,e.spatialReference,r,t);null!=s&&(this.alignedSampledElevation=s)}}getCenterObjectSpace(e=(0,I.vt)()){return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,Ff),(0,M.e)(e,this._lodRenderer.baseBoundingSphere.center,Ff)}getBoundingBoxObjectSpace(e=(0,q.vt)()){this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,Ff);const t=this._lodRenderer.baseBoundingBox;(0,q.Ie)(e);for(let i=0;i<8;++i)(0,M.s)(Mf,0==(1&i)?t[0]:t[3],0==(2&i)?t[1]:t[4],0==(4&i)?t[2]:t[5]),(0,M.e)(Mf,Mf,Ff),(0,q.iT)(e,Mf);return e}computeAttachmentOrigin(e){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,Ff),e.render.origin[0]+=Ff[12],e.render.origin[1]+=Ff[13],e.render.origin[2]+=Ff[14],e.render.num++}async getProjectedBoundingBox(e,t,i,r,s){const n=this.getBoundingBoxObjectSpace(s),a=Df,o=(0,q.fT)(n)?1:a.length;this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,Ff);for(let e=0;e<o;e++){const t=a[e];Mf[0]=n[t[0]],Mf[1]=n[t[1]],Mf[2]=n[t[2]],(0,M.e)(Mf,Mf,Ff),Pf[3*e]=Mf[0],Pf[3*e+1]=Mf[1],Pf[3*e+2]=Mf[2]}if(!e(Pf,0,o))return null;(0,q.Ie)(n);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let e=0;e<3*o;e+=3){for(let t=0;t<3;t++)n[t]=Math.min(n[t],Pf[e+t]),n[t+3]=Math.max(n[t+3],Pf[e+t]);l&&i.push({location:Pf.slice(e,e+3),screenSpaceBoundingRect:l})}if(t&&((0,q.gX)(n,If),"absolute-height"!==this.elevationContext.mode)){let e;const i=rn(n,t.service.spatialReference,t);try{e=await t.service.queryElevation(If[0],If[1],r,i,"ground")}catch(e){}null!=e&&(0,q.cY)(n,0,0,-this.alignedSampledElevation+e)}return n}addObjectState(e,t){if(e===ge.Mg.Highlight){const i=new An.X(e);this._addHighlightId(i),t.addExternal((e=>{this._removeHighlightId(e)}),i)}}removeObjectState(e){this._highlights.forEach((t=>e.remove(t)))}_addHighlightId(e){this._highlights.add(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(e){this._highlights.delete(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const Pf=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Mf=(0,I.vt)(),If=(0,I.vt)(),Df=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],Ff=(0,P.vt)();const Lf=20;var Nf=i(6741),Vf=i(65949),Gf=i(43983);class Uf{constructor(e,t,i){this._elementSize=t,this._buffer=yh.g.createVertex(e,_t._U.STATIC_DRAW),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,t,i,r=0){const s=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(i.array,r*this.elementSize).set(s)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const i=e*this._elementSize,r=t*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),i,i,r)}resize(e){const t=e*this._elementSize,i=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setSize(t),this._capacity=e}}class zf{constructor(e){this.modelOriginHi=e.getField(It.r.INSTANCEMODELORIGINHI,nu.xs),this.modelOriginLo=e.getField(It.r.INSTANCEMODELORIGINLO,nu.xs),this.model=e.getField(It.r.INSTANCEMODEL,nu.jZ),this.modelNormal=e.getField(It.r.INSTANCEMODELNORMAL,nu.jZ),this.featureAttribute=e.getField(It.r.INSTANCEFEATUREATTRIBUTE,nu.Eq),this.color=e.getField(It.r.INSTANCECOLOR,nu.XP),this.objectAndLayerIdColor=e.getField(It.r.INSTANCEOBJECTANDLAYERIDCOLOR,nu.XP)}}class Bf{constructor(e,t){this._rctx=e,this._instanceBufferLayout=t,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){(0,yr.vA)(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){(0,yr.vA)(this._updating,"not updating"),this.size<b.$U*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){(0,yr.vA)(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),(0,yr.vA)(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){(0,yr.vA)(this._updating,"not updating"),(0,yr.vA)(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(Hf,Math.floor(this._capacity*b.Ji));this._resize(e)}_shrink(){const e=Math.max(Hf,Math.floor(this._capacity*b.He));this._resize(e)}_resize(e){if((0,yr.vA)(this._updating,"not updating"),e===this._capacity)return;const t=new Uf(this._rctx,this._instanceBufferLayout.stride,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const e=this.size,i=this._compactInstances(t);(0,yr.vA)(i===e,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=i,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new zf(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){const t=this._headIndex,i=this._tailIndex;return i<t?(this._buffer.copyRange(i,t,e),t-i):i>t?(this._buffer.copyRange(i,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-i),t+(this._capacity-i)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}}const Hf=64;var jf;!function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE"}(jf||(jf={}));class Wf{constructor(e){this.localTransform=e.getField(It.r.LOCALTRANSFORM,nu.E$),this.globalTransform=e.getField(It.r.GLOBALTRANSFORM,nu.E$),this.modelOrigin=e.getField(It.r.MODELORIGIN,nu.Xm),this.model=e.getField(It.r.INSTANCEMODEL,nu.jZ),this.modelNormal=e.getField(It.r.INSTANCEMODELNORMAL,nu.jZ),this.modelScaleFactors=e.getField(It.r.MODELSCALEFACTORS,nu.gH),this.boundingSphere=e.getField(It.r.BOUNDINGSPHERE,nu.Aj),this.featureAttribute=e.getField(It.r.FEATUREATTRIBUTE,nu.Eq),this.color=e.getField(It.r.COLOR,nu.XP),this.objectAndLayerIdColor=e.getField(It.r.OBJECTANDLAYERIDCOLOR,nu.XP),this.state=e.getField(It.r.STATE,nu.SL),this.lodLevel=e.getField(It.r.LODLEVEL,nu.SL)}}let kf=class extends n.A{constructor(e,t){super(e),this.events=new xs.A,this._capacity=0,this._size=0,this._next=0,this._layout=function(e){let t=(0,jn.BP)().mat4f64(It.r.LOCALTRANSFORM).mat4f64(It.r.GLOBALTRANSFORM).vec4f64(It.r.BOUNDINGSPHERE).vec3f64(It.r.MODELORIGIN).mat3f(It.r.INSTANCEMODEL).mat3f(It.r.INSTANCEMODELNORMAL).vec2f(It.r.MODELSCALEFACTORS);return e.includes(It.r.FEATUREATTRIBUTE)&&(t=t.vec4f(It.r.FEATUREATTRIBUTE)),e.includes(It.r.COLOR)&&(t=t.vec4u8(It.r.COLOR)),e.includes(It.r.OBJECTANDLAYERIDCOLOR)&&(t=t.vec4u8(It.r.OBJECTANDLAYERIDCOLOR)),t=t.u8(It.r.STATE).u8(It.r.LODLEVEL),t}(t),this._capacity=Hf,this._buffer=this._layout.createBuffer(this._capacity),this._view=new Wf(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,jf.ALLOCATED),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){const t=this._view.state;(0,yr.vA)(e>=0&&e<this._capacity&&0!=(t.get(e)&jf.ALLOCATED),"invalid instance handle"),this._getStateFlag(e,jf.ACTIVE)?this._setStateFlags(e,jf.REMOVE):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){const t=this._view.state;(0,yr.vA)(e>=0&&e<this._capacity&&0!=(t.get(e)&jf.ALLOCATED),"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t,i=!0){this._view.localTransform.setMat(e,t),i&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t,i=!0){this._view.globalTransform.setMat(e,t),i&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,i=Zf,r=qf;t.localTransform.getMat(e,$f),t.globalTransform.getMat(e,Qf);const s=(0,O.lw)(Qf,Qf,$f);(0,M.s)(i,s[12],s[13],s[14]),t.modelOrigin.setVec(e,i),(0,A.z0)(r,s),t.model.setMat(e,r);const n=(0,Rn.wp)(Zf,s);n.sort(),t.modelScaleFactors.set(e,0,n[1]),t.modelScaleFactors.set(e,1,n[2]),(0,A.B8)(r,r),(0,A.mg)(r,r),t.modelNormal.setMat(e,r),this._setStateFlags(e,jf.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const i=this._view;i.model.getMat(e,qf),i.modelOrigin.getVec(e,Zf),t[0]=qf[0],t[1]=qf[1],t[2]=qf[2],t[3]=0,t[4]=qf[3],t[5]=qf[4],t[6]=qf[5],t[7]=0,t[8]=qf[6],t[9]=qf[7],t[10]=qf[8],t[11]=0,t[12]=Zf[0],t[13]=Zf[1],t[14]=Zf[2],t[15]=1}applyShaderTransformation(e,t){null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){this._view.localTransform.getMat(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(Zf,this,e),t*=Math.max(Zf[0],Zf[1],Zf[2])),t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(Zf,this,e),t*=function(e,t,i){return Math.max(Math.min(e,t),Math.min(Math.max(e,t),i))}(Zf[0],Zf[1],Zf[2])),t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}setObjectAndLayerIdColor(e,t){this._view.objectAndLayerIdColor.setVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this._setStateFlag(e,jf.VISIBLE,t),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,jf.VISIBLE)}setHighlight(e,t){t!==this.getHighlight(e)&&(this._setStateFlag(e,jf.HIGHLIGHT,t),this.events.emit("instance-highlight-changed"))}getHighlight(e){return this._getStateFlag(e,jf.HIGHLIGHT)}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++t;return t}_setStateFlags(e,t){const i=this._view.state;t=i.get(e)|t,i.set(e,t)}_clearStateFlags(e,t){const i=this._view.state;t=i.get(e)&~t,i.set(e,t)}_setStateFlag(e,t,i){i?this._setStateFlags(e,t):this._clearStateFlags(e,t)}_getStateFlag(e,t){return!!(this._view.state.get(e)&t)}_grow(){this._capacity=Math.max(Hf,Math.floor(this._capacity*b.Ji)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new Wf(this._buffer)}_findSlot(){const e=this._view.state;let t=this._next;for(;e.get(t)&jf.ALLOCATED;)t=t+1===this._capacity?0:t+1;return this._next=t+1===this._capacity?0:t+1,t}};(0,r._)([(0,h.MZ)({constructOnly:!0})],kf.prototype,"shaderTransformation",void 0),(0,r._)([(0,h.MZ)()],kf.prototype,"_size",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],kf.prototype,"size",null),kf=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],kf);const Zf=(0,I.vt)(),qf=(0,T.vt)(),$f=(0,P.vt)(),Qf=(0,P.vt)();class Jf extends wo.A{constructor(e,t){super((e=>(0,X.w)(this._instanceData.view.boundingSphere.getVec(e,this._tmpSphere))),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=t,this._tmpSphere=(0,X.d)(),this._tmpMat4=(0,P.vt)()}addInstance(e){const t=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);(0,M.e)((0,X.g)(this._tmpSphere),this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*(0,Rn.hG)(i),t.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class Yf{constructor(e,t){this._worldSpaceRadius=e,this._minScreenSpaceRadii=t}selectLevel(e,t,i){const r=i.computeScreenPixelSizeAt(e),s=this._worldSpaceRadius*t/r;let n=0;for(let e=1;e<this._minScreenSpaceRadii.length;++e)s>=this._minScreenSpaceRadii[e]&&(n=e);return n}}class Xf extends oc{constructor(e,t,i,r,s,n){super(e,t),this.layerUid=e,this.graphicUid=t,this.geometryId=i,this.triangleNr=r,this.baseBoundingSphere=s,this.numLodLevels=n}}class Kf{constructor(e,t){const i=e.renderContext.rctx,r=t.geometry;this._materialRepository=e.materialRepository,r.material.setParameters({instancedDoublePrecision:!0});const s=r.material.createBufferWriter(),n=s.vertexBufferLayout,a=s.elementCount(r),o=n.createBuffer(a);s.write(null,null,r,o,0),this.geometry=r,this.material=r.material,this.glMaterials=new nh(r.material,this._materialRepository),this.vertexBufferLayout=n,this.vbo=yh.g.createVertex(i,_t._U.STATIC_DRAW,o.buffer),this.vao=new _h(i,Yn.D,{geometry:(0,sh.U)(n)},{geometry:this.vbo}),this.vertexCount=a}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,t,i,r,s,n,a,o){const l=this.geometry.id;this.material.intersect(this.geometry,e.transform.transform,e,i,r,((i,r,c,h,d)=>{if(i>=0){if(null!=t&&!t(e.rayBegin,e.rayEnd,i))return;const h=new Xf(n.layerUid,n.graphicUid(s),l,c,a,o);if((null==e.results.min.drapedLayerOrder||d>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||i<e.results.min.dist)&&e.results.min.set(ec.LOD,h,i,r,e.transform.transform,d),e.options.store!==tc.MIN&&(null==e.results.max.drapedLayerOrder||d>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||i>e.results.max.dist)&&e.results.max.set(ec.LOD,h,i,r,e.transform.transform,d),e.options.store===tc.ALL){const t=Jc(e.results.min.ray);t.set(ec.LOD,h,i,r,e.transform.transform,d),e.results.all.push(t)}}}))}}class eg{static async create(e,t,i){const r=await Promise.allSettled(t.components.map((t=>e.controller.schedule((()=>new Kf(e,t)),i)))),s=r.map((e=>"fulfilled"===e.status?e.value:null)).filter(b.Ru);if((0,o.G4)(i)||s.length!==r.length){s.forEach((e=>e.destroy())),(0,o.Te)(i);for(const e of r)if("rejected"===e.status)throw e.reason}return new eg(t.minScreenSpaceRadius,s)}constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}destroy(){this.components.forEach((e=>e.destroy()))}intersect(e,t,i,r,s,n,a){this.components.forEach((o=>o.intersect(e,t,i,r,s,n,this.boundingSphere,a)))}get boundingBox(){if(null==this._boundingBox){const e=(0,q.Ie)();this.components.forEach((t=>{null!=t.boundingInfo&&((0,q.iT)(e,t.boundingInfo.bbMin),(0,q.iT)(e,t.boundingInfo.bbMax))})),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(null==this._boundingSphere){const e=this.boundingBox,t=(0,I.vt)();(0,q.gX)(e,t),this._boundingSphere={center:t,radius:.5*(0,q._F)(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((e,t)=>e+t.triangleCount),0)}}var tg=i(83244),ig=i(73360);let rg=class extends oo.S{constructor(e,t){super(e),this.type=ec.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[new Array],this._highlightRenderInstanceData=[new Array],this._allRenderInstanceData=[this._defaultRenderInstanceData[0],this._highlightRenderInstanceData[0]],this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new co,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[qn.N.OPAQUE_MATERIAL,e=>this._produces(e)],[qn.N.TRANSPARENT_MATERIAL,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new kf({shaderTransformation:e.shaderTransformation},e.optionalFields),this.addHandles(t.registerTask(Ee.W6.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=function(e){let t=(0,jn.BP)().vec3f(It.r.INSTANCEMODELORIGINHI).vec3f(It.r.INSTANCEMODELORIGINLO).mat3f(It.r.INSTANCEMODEL).mat3f(It.r.INSTANCEMODELNORMAL);return null!=e&&e.includes("featureAttribute")&&(t=t.vec4f(It.r.INSTANCEFEATUREATTRIBUTE)),null!=e&&e.includes("color")&&(t=t.vec4u8(It.r.INSTANCECOLOR)),null!=e&&e.includes("objectAndLayerIdColor")&&(t=t.vec4u8(It.r.INSTANCEOBJECTANDLAYERIDCOLOR)),t}(this.optionalFields),this._glInstanceBufferLayout=(0,sh.U)(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",(()=>this._requestUpdateCycle())),this._instanceData.events.on("instance-transform-changed",(({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)})),this._instanceData.events.on("instance-visibility-changed",(({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)})),this._instanceData.events.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0)))])}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get usedMemory(){return this._allRenderInstanceData.reduce(((e,t)=>t.reduce(((e,t)=>e+t.usedMemory),e)),0)}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,i)=>{const r=this._allRenderInstanceData[0][i].size+this._allRenderInstanceData[1][i].size,s=e.triangleCount;t.push({renderedInstances:r,renderedTriangles:r*s,trianglesPerInstance:s})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}async initializeRenderContext(e,t){this._context=e;const i=e.renderContext.rctx,r=await Promise.allSettled(this.symbol.levels.map((r=>(this._defaultRenderInstanceData[0].push(new Bf(i,this._instanceBufferLayout)),this._highlightRenderInstanceData[0].push(new Bf(i,this._instanceBufferLayout)),eg.create(e,r,t))))),s=r.map((e=>"fulfilled"===e.status?e.value:null)).filter(b.Ru);if((0,o.G4)(t)||s.length!==r.length){s.forEach((e=>e.destroy())),(0,o.Te)(t);for(const e of r)if("rejected"===e.status)throw e.reason}this._levels=s,this._levelSelector=(e=>{const t=e.baseBoundingSphere.radius,i=e.levels.map((e=>e.minScreenSpaceRadius));return new Yf(t,i)})(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData[0].forEach((e=>e.destroy())),this._highlightRenderInstanceData[0].forEach((e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some((e=>e.components.some((e=>{const t=e.material.produces.get(qn.N.TRANSPARENT_MATERIAL);return t&&t(Wn.V.Color)}))))}hasHighlights(){return this._highlightRenderInstanceData[0].some((e=>e.size>0))}_produces(e){return e!==Wn.V.Highlight&&e!==Wn.V.ShadowHighlight||this.hasHighlights()}prepareRender(e){if(!Is.b.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bindParameters.contentCamera.equals(this._camera);this._camera.copyFrom(e.bindParameters.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Ee.Bb),this._needFullCycle=!1)}}prepareTechniques(e){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(e.output))return null;const t=this._getInstanceDatas(e.output);if(!t)return null;const i=new Array;return t.forEach((t=>this.levels.forEach(((r,s)=>{r.components.forEach((r=>i.push(this._beginComponent(e,t[s],r))))})))),i}renderNode(e,t){const i=this._getInstanceDatas(e.output);if(!i||null==t)return;let r=0;e.rctx.bindVAO(),i.forEach((i=>this.levels.forEach(((s,n)=>{s.components.forEach((s=>this._renderComponent(e,t[r++],i[n],s,n)))}))))}_getInstanceDatas(e){const t=e!==Wn.V.Highlight&&e!==Wn.V.ShadowHighlight,i=e!==Wn.V.ShadowExcludeHighlight;return t&&i?this._allRenderInstanceData:t?this._defaultRenderInstanceData:i?this._highlightRenderInstanceData:null}intersect(e,t,i,r){if(!this.baseMaterial.isVisible()||null==this._octree)return;const s=(0,I.vt)();(0,M.f)(s,r,i);const n=s=>{this._instanceData.getCombinedModelTransform(s,og),e.transform.set(og),(0,M.e)(lg,i,e.transform.inverse),(0,M.e)(cg,r,e.transform.inverse);const n=this._instanceData.getState(s),a=this._instanceData.getLodLevel(s),o=this._levels.length;(0,yr.vA)(0!=(n&jf.ACTIVE),"invalid instance state"),(0,yr.vA)(a>=0&&a<o,"invaid lod level"),this._levels[a].intersect(e,t,lg,cg,s,this.metadata,o)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(n):this._octree.forEachAlongRay(i,s,n)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){const e=this._instanceData,t=e.view?.state;if(!t)return null;this._octreeCached=new Jf(e,this.baseBoundingSphere);for(let i=0;i<e.capacity;++i)t.get(i)&jf.ACTIVE&&this._octreeCached.addInstance(i)}return this._octreeCached}_invalidateOctree(){this._octreeCached=(0,ce.pR)(this._octreeCached)}queryDepthRange(e){if(null==this._octree)return{near:1/0,far:-1/0};const t=e.viewForward,i=this._octree.findClosest(t,wo.A.DepthOrder.FRONT_TO_BACK,e.frustum),r=this._octree.findClosest(t,wo.A.DepthOrder.BACK_TO_FRONT,e.frustum);if(null==i||null==r)return{near:1/0,far:-1/0};const s=e.eye,n=this._instanceData.view;n.boundingSphere.getVec(i,ag),(0,M.f)(ag,ag,s);const a=(0,M.j)(ag,t)-ag[3];n.boundingSphere.getVec(r,ag),(0,M.f)(ag,ag,s);const o=(0,M.j)(ag,t)+ag[3];return{near:Math.max(e.near,a),far:Math.min(e.far,o)}}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.startUpdateCycle()))))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:i,_levelSelector:r}=this;this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.beginUpdate()))));const s=this._instanceData,n=s.view;let a=s.size;const o=s.capacity;let l=this._instanceIndex;const c=Math.ceil(o/500);for(let h=0;h<a&&!e.done;++h){l===this._cycleStartIndex&&this._startUpdateCycle();const h=n.state.get(l);let d=0;if(!(h&jf.ALLOCATED)){l=l+1===o?0:l+1,a++;continue}const u=n.lodLevel.get(l);if(h&jf.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[0][u].freeTail(),h&jf.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[0][u].freeTail(),h&jf.REMOVE)s.freeInstance(l);else if(h&jf.VISIBLE){let e=0;t&&(n.modelOrigin.getVec(l,ng),e=r.selectLevel(ng,s.getCombinedMedianScaleFactor(l),i)),d=h&~(jf.ACTIVE|jf.TRANSFORM_CHANGED),e>=0&&(h&jf.HIGHLIGHT?(sg(this._highlightRenderInstanceData[0][e],n,l),d|=jf.HIGHLIGHT_ACTIVE):(sg(this._defaultRenderInstanceData[0][e],n,l),d|=jf.DEFAULT_ACTIVE)),n.state.set(l,d),n.lodLevel.set(l,e)}else d=h&~(jf.ACTIVE|jf.TRANSFORM_CHANGED),n.state.set(l,d);if(null!=this._octreeCached){const e=!!(h&jf.ACTIVE),t=!!(d&jf.ACTIVE);!e&&t?this._octreeCached.addInstance(l):e&&!t?this._octreeCached.removeInstance(l):e&&t&&h&jf.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(l),this._octreeCached.addInstance(l))}l=l+1===o?0:l+1,l%c==0&&e.madeProgress()}this._instanceIndex=l,this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.endUpdate())))),this._context.requestRender()}_beginComponent(e,t,i){if(0===t.size)return null;const r=i.glMaterials.load(e.rctx,e.bindParameters.slot,e.output);return null!=r?r.beginSlot(e.bindParameters):null}_renderComponent(e,t,i,r,s){if(!t)return;const{bindParameters:n,rctx:a}=e;a.runAppleAmdDriverHelper();const o=a.bindTechnique(t,n,r.material.parameters,dg);a.bindVAO(r.vao),t.ensureAttributeLocations(r.vao),Is.b.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===Wn.V.Color&&(o.setUniform4fv("externalColor",hg[Math.min(s,hg.length-1)]),o.setUniform1i("colorMixMode",hu.Um.replace));const l=i.capacity,c=i.headIndex,h=i.tailIndex,d=i.firstIndex,u=this._glInstanceBufferLayout,p=(e,s)=>{(0,ig.yu)(a,Yn.D,i.buffer,u,e),a.drawArraysInstanced(t.primitiveType,0,r.vertexCount,s-e),(0,ig.Hi)(a,Yn.D,i.buffer,u)};r.material.parameters.transparent&&null!=d?c>h?((0,yr.vA)(d>=h&&d<=c,"invalid firstIndex"),p(d,c),p(h,d)):c<h&&(d<=c?((0,yr.vA)(d>=0&&d<=c,"invalid firstIndex"),p(d,c),p(h,l),p(0,d)):((0,yr.vA)(d>=h&&d<=l,"invalid firstIndex"),p(d,l),p(0,c),p(h,d))):c>h?p(h,c):c<h&&(p(0,c),p(h,l)),a.bindVAO(null)}};function sg(e,t,i){const r=e.allocateHead();!function(e,t,i,r){(0,Tn.Vk)(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,r),i.model.copyFrom(r,e.model,t),i.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(r,e.color,t),e.objectAndLayerIdColor&&i.objectAndLayerIdColor&&i.objectAndLayerIdColor.copyFrom(r,e.objectAndLayerIdColor,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(r,e.featureAttribute,t)}(t,i,e.view,r)}(0,r._)([(0,h.MZ)({constructOnly:!0})],rg.prototype,"symbol",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],rg.prototype,"optionalFields",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],rg.prototype,"metadata",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],rg.prototype,"shaderTransformation",void 0),(0,r._)([(0,h.MZ)()],rg.prototype,"_instanceData",void 0),(0,r._)([(0,h.MZ)()],rg.prototype,"_cycleStartIndex",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],rg.prototype,"_enableLevelSelection",null),(0,r._)([(0,h.MZ)()],rg.prototype,"_updateCyclesWithStaticCamera",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],rg.prototype,"running",null),rg=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],rg);const ng=(0,I.vt)(),ag=(0,F.vt)(),og=(0,P.vt)(),lg=(0,I.vt)(),cg=(0,I.vt)(),hg=[(0,F.fA)(1,0,1,1),(0,F.fA)(0,0,1,1),(0,F.fA)(0,1,0,1),(0,F.fA)(1,1,0,1),(0,F.fA)(1,0,0,1)],dg=new tg.V;class ug{constructor(e,t,i,r,s,n,a,o,l,c,h,d){this.lodResources=e,this.lodRenderer=t,this.stageResources=i,this.originalMaterialParameters=r,this.resourceSize=s,this.isEsriSymbolResource=n,this.isWosr=a,this.resourceBoundingBox=o,this.symbolSize=l,this.extentPadding=c,this.physicalBasedRenderingEnabled=h,this.pivotOffset=d}}const pg=(0,I.vt)(),fg=(0,P.vt)(),gg=(0,P.vt)(),mg=(0,F.vt)(),_g=new Bt;class yg{constructor(e,t,i,r){this.vertices=e,this.positionsES=t,this.offset=r;const s=e.length,n=Math.floor(s/2),a=this.offset+3*n,o=i[a],l=i[a+1],c=i[a+2];this.origin=(0,I.fA)(o,l,c),this.positions=(0,J.oe)(3*s);const h=this.offset+3*s;for(let e=this.offset;e<h;e+=3)this.positions[e]=i[e]-o,this.positions[e+1]=i[e+1]-l,this.positions[e+2]=i[e+2]-c;this.updatePathVertexInformation()}get usedMemory(){return(0,R.Ek)(this.positions)}updatePathVertexInformation(){const e=this.vertices.length,t=this.vertices[0];let i=this.offset;const r=this.positions;t.vRight[0]=r[i+3]-r[i],t.vRight[1]=r[i+4]-r[i+1],t.vRight[2]=r[i+5]-r[i+2],i+=3;let s=(0,M.l)(t.vRight);t.vMinSiblingLength=s,(0,M.n)(t.vRight,t.vRight);let n=t;for(let t=1;t<e;++t){const a=this.vertices[t];if(a.vLeft=n.vRight,t<e-1){a.vRight[0]=r[i+3]-r[i],a.vRight[1]=r[i+4]-r[i+1],a.vRight[2]=r[i+5]-r[i+2];const e=(0,M.l)(a.vRight);a.vMinSiblingLength=Math.min(s,e),s=e,(0,M.n)(a.vRight,a.vRight)}else(0,M.c)(a.vRight,a.vLeft),a.vMinSiblingLength=s;n=a,i+=3}}}class vg{constructor(e,t,i,r,s,n={}){this.path=e,this.profile=t,this.extruder=i,this.startCap=r,this.endCap=s,this.options=n,this._extrusionVertexCount=0;const a=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*a+2,this.numVerticesTotal=t.vertices.length*this.numExtrusionProfiles,this.startCap.vertexBufferStart=this.numVerticesTotal;const o=this.startCap.numVertices;this.numVerticesTotal+=o,this.endCap.vertexBufferStart=this.numVerticesTotal;const l=this.endCap.numVertices;this.numVerticesTotal+=l,this.pathVertexData=(0,Y.JH)(1*this.numVerticesTotal),this.profileRightAxes=(0,J.oe)(4*this.numVerticesTotal),this.profileUpAxes=(0,J.oe)(4*this.numVerticesTotal),this.profileVertexAndNormals=(0,J.oe)(4*this.numVerticesTotal),this.positions=(0,J.AK)(e.positions,e.offset,3*e.vertices.length),this._rebuildGeometry(),this.buildTopology()}get usedMemory(){return(0,R.Ek)(this.pathVertexData,this.profileRightAxes,this.profileUpAxes,this.profileVertexAndNormals)+this.path.usedMemory+this.profile.usedMemory}emitVertex(e,t,i,r,s){const n=4*this._extrusionVertexCount;if(this.profileRightAxes[n]=t.right[0],this.profileRightAxes[n+1]=t.right[1],this.profileRightAxes[n+2]=t.right[2],this.profileUpAxes[n]=t.up[0],this.profileUpAxes[n+1]=t.up[1],this.profileUpAxes[n+2]=t.up[2],this.profileVertexAndNormals[n]=i[0],this.profileVertexAndNormals[n+1]=i[1],this.profileVertexAndNormals[n+2]=r[0],this.profileVertexAndNormals[n+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,s){const t=this.path.vertices[e],i=t.maxStretchDistance;this.profileRightAxes[n+3]=t.rotationRight[0]*i,this.profileUpAxes[n+3]=t.rotationRight[1]*i}else this.profileRightAxes[n+3]=0,this.profileUpAxes[n+3]=0;++this._extrusionVertexCount}emitCapVertex(e,t,i,r,s,n){const a=4*this._extrusionVertexCount;this.profileRightAxes[a]=t.right[0],this.profileRightAxes[a+1]=t.right[1],this.profileRightAxes[a+2]=t.right[2],this.profileRightAxes[a+3]=s,this.profileUpAxes[a]=t.up[0],this.profileUpAxes[a+1]=t.up[1],this.profileUpAxes[a+2]=t.up[2],this.profileUpAxes[a+3]=n,this.profileVertexAndNormals[a]=i[0],this.profileVertexAndNormals[a+1]=i[1],this.profileVertexAndNormals[a+2]=r[0],this.profileVertexAndNormals[a+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,++this._extrusionVertexCount}_rebuildGeometry(){this._extrusionVertexCount=0;const{positions:e,offset:t,vertices:i}=this.path;this.positions=(0,J.AK)(e,t,3*i.length);let r=0;const s=(e,t,i,s,n)=>this.emitCapVertex(r,e,t,i,s,n),n=(e,t,i,s)=>this.emitVertex(r,e,t,i,s);for(this.startCap.rebuildConnectingProfileGeometry(i[r],this.profile,s),r=1;r<i.length-1;++r)this.extruder.extrude(i[r],this.profile,n);this.endCap.rebuildConnectingProfileGeometry(i[r],this.profile,s),r=0,this.startCap.rebuildCapGeometry(i[r],s),r=i.length-1,this.endCap.rebuildCapGeometry(i[r],s)}buildTopology(){const e=this.profile.vertices.length,t=this.profile.numSegments,i=this.numExtrusionProfiles-1;let r=t*i*2*3;this.startCap.indexBufferStart=r,this.startCap.firstProfileVertexIndex=0,r+=this.startCap.numIndices,this.endCap.indexBufferStart=r,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1);const s=new Array,n=new Array,a=new Array,o=(e,t,i)=>{s.push(e),s.push(t),s.push(i),n.push(e),n.push(t),n.push(i),a.push(this.pathVertexData[e]),a.push(this.pathVertexData[t]),a.push(this.pathVertexData[i])};for(let r=0;r<t;++r){const t=this.profile.indices[2*r],s=this.profile.indices[2*r+1];for(let r=0;r<i;++r){const i=r*e+t,n=(r+1)*e+s,a=r*e+s;o(i,(r+1)*e+t,n),o(i,n,a)}}this.startCap.buildTopology(this.path.vertices[0],o),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],o),this.vertexIndices=(0,Y.Dg)(s),this.normalIndices=(0,Y.Dg)(n),this.pathVertexIndices=(0,Y.Dg)(a)}onPathChanged(){this._rebuildGeometry()}}class bg{rebuildConnectingProfileGeometry(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.frame,t.vertices[r],t.normals[r],0,0)}}class xg extends bg{constructor(){super(),this.numVertices=0,this.numIndices=0}rebuildCapGeometry(){}buildTopology(){}}class Sg extends bg{constructor(e,t=0,i=!1){super(),this.profile=e,this.profilePlaneOffset=t,this.flip=i}get numVertices(){return this.profile.vertices.length}get numIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,t,i){const r=this.profilePlaneOffset;for(let s=0;s<t.vertices.length;++s)i(e.frame,t.vertices[s],t.normals[s],r,0)}rebuildCapGeometry(e,t){const i=this.profile,r=this.flip?1:-1,s=this.profilePlaneOffset,n=Rg;(0,xa.hZ)(n,0,0);for(let a=0;a<i.vertices.length;++a)t(e.frame,i.vertices[a],n,s,r)}buildTopology(e,t){const i=this.profile,r=this.vertexBufferStart+i.indices[0];for(let e=1;e<i.numSegments;++e){const s=i.indices[2*e],n=i.indices[2*e+1],a=this.vertexBufferStart+s,o=this.vertexBufferStart+n;this.flip?t(o,a,r):t(r,a,o)}}}class wg extends bg{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}get numVertices(){let e=this.profile.vertices.length*(this.numSegments-1)+this.profile.poles.length;return this.breakNormals&&(e+=this.profile.vertices.length),e}get numIndices(){let e=0;const t=this.profile;e+=2*t.numSegments*(this.numSegments-1);for(let i=0;i<t.numSegments;++i){const r=t.indices[2*i],s=t.indices[2*i+1];t.poleIndices[r]===t.poleIndices[s]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,t){const i=this.profile,r=e.frame,s=.5*this.sign,n=Cg,a=Rg;(0,xa.hZ)(a,0,0);for(const e of i.poles)e.normal?t(r,e.position,e.normal,s,0):t(r,e.position,a,s,this.sign);if(this.breakNormals)for(let e=0;e<i.vertices.length;++e)t(r,i.vertices[e],i.normals[e],0,0);for(let e=0;e<this.numSegments-1;++e){const o=(1-(e+1)/this.numSegments)*Math.PI*.5,l=Math.sin(o),c=Math.cos(o);for(let e=0;e<i.vertices.length;++e){const o=i.poles[i.poleIndices[e]];(0,xa.Re)(n,i.vertices[e],o.position),(0,xa.hs)(n,n,l),o.normal?((0,xa.WQ)(n,n,o.position),t(r,n,o.normal,s*c,0)):((0,xa.S8)(a,n),(0,xa.hs)(a,a,l),(0,xa.WQ)(n,n,o.position),t(r,n,a,s*c,this.sign*c))}}}buildTopology(e,t){const i=this.profile,r=this.breakNormals?this.vertexBufferStart+i.poles.length:this.firstProfileVertexIndex,s=this.breakNormals?this.vertexBufferStart+i.poles.length+i.vertices.length:this.vertexBufferStart+i.poles.length;for(let e=0;e<i.numSegments;++e){const n=i.indices[2*e],a=i.indices[2*e+1],o=this.vertexBufferStart+i.poleIndices[n],l=this.vertexBufferStart+i.poleIndices[a];let c=r+n,h=r+a;for(let e=0;e<this.numSegments-1;++e){const r=s+e*i.vertices.length+n,o=s+e*i.vertices.length+a;this.flip?(t(r,h,c),t(h,r,o)):(t(c,h,r),t(o,r,h)),c=r,h=o}this.flip?(t(o,h,c),o!==l&&t(o,l,h)):(t(c,h,o),o!==l&&t(h,l,o))}}}const Cg=(0,dr.vt)(),Rg=(0,dr.vt)();class Eg{numProfilesPerJoin(){return 1}extrude(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.frame,t.vertices[r],t.normals[r],!1)}}class Ag{constructor(e,t){this.cutoffAngle=e,this.numBendSubdivisions=t}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,t,i){const r=Ig,{rotationAngle:s,rotationRight:n,frame:a}=e;if(Math.abs(s)>=this.cutoffAngle){const o=e.rotationFrameUp;for(let l=0;l<this.numBendSubdivisions+1;++l){(0,O.$0)(Mg,.5*-s+l*s/this.numBendSubdivisions,o),Og(r,a,Mg);for(let o=0;o<t.vertices.length;++o)(0,xa.Om)(t.vertices[o],n)*s>=0?i(r,t.vertices[o],t.normals[o],!1):i(a,e.applyMiterStretch(Pg,t.vertices[o]),t.normals[o],!0)}}else for(let r=0;r<this.numBendSubdivisions+1;++r)for(let r=0;r<t.vertices.length;++r){const o=(0,xa.Om)(t.vertices[r],n)*s>=0;i(a,e.applyMiterStretch(Pg,t.vertices[r]),t.normals[r],!o)}}}class Tg{constructor(){this.up=(0,I.vt)(),this.right=(0,I.vt)()}}function Og(e,t,i){(0,M.e)(e.up,t.up,i),(0,M.e)(e.right,t.right,i)}const Pg=(0,dr.vt)(),Mg=(0,P.vt)(),Ig=new Tg;class Dg extends _r.V{constructor(e,t,i,r,s,n){super(e,t,null,mr.X.Mesh,n),this.path=i,this.geometrySR=r,this.stencilWidth=s}}var Fg;function Lg(e){return"path"in e}!function(e){e[e.World=0]="World",e[e.Path=1]="Path"}(Fg||(Fg={}));class Ng{constructor(e){this.builder=e}onPathChanged(e){this.builder.onPathChanged()}}class Vg extends Ng{constructor(e){super(e),this.vertexAttributeColor=(0,F.fA)(255,255,255,255),this.size=new Array,this.vertexAttributePosition=(0,J.oe)(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Int16Array(2*this.builder.numVerticesTotal)}bakeVertexColors(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}bake(e){this.size=e;const{numVerticesTotal:t,pathVertexData:i,path:r,positions:s,profileRightAxes:n,profileUpAxes:a,profileVertexAndNormals:o}=this.builder;for(let l=0;l<t;++l){let t=i[l];const c=0===t||t===r.vertices.length-1;t*=3;const h=jg;let d=0,u=0;const p=4*l,f=(0,M.s)(Wg,n[p],n[p+1],n[p+2]),g=(0,M.s)(kg,a[p],a[p+1],a[p+2]),m=(0,xa.hZ)(Ug,o[p]*e[0],o[p+1]*e[1]);if(c)(0,M.b)(h,g,f),d=n[p+3]*e[0],u=a[p+3];else{const e=zg,t=Bg;(0,xa.hZ)(e,n[p+3],a[p+3]);const i=(0,xa.Bw)(e);(0,xa.S8)(e,e);const r=(0,xa.Om)(m,e);if(Math.abs(r)>i){(0,xa.hZ)(t,-e[1],e[0]);const s=(0,xa.Om)(m,t);(0,xa.hs)(e,e,i*Math.sign(r)),(0,xa.hs)(t,t,s),(0,xa.WQ)(m,e,t)}(0,M.s)(h,0,0,0)}const _=(0,M.s)(Hg,f[0]*m[0]+g[0]*m[1],f[1]*m[0]+g[1]*m[1],f[2]*m[0]+g[2]*m[1]),y=3*l;this.vertexAttributePosition[y]=s[t]+_[0]+h[0]*d,this.vertexAttributePosition[y+1]=s[t+1]+_[1]+h[1]*d,this.vertexAttributePosition[y+2]=s[t+2]+_[2]+h[2]*d;const v=(0,xa.hZ)(Ug,o[p+2],o[p+3]);(0,sd.aT)(this.vertexAttributeNormal,l,f[0]*v[0]+g[0]*v[1]+h[0]*u,f[1]*v[0]+g[1]*v[1]+h[1]*u,f[2]*v[0]+g[2]*v[1]+h[2]*u)}}createGeometryData(){const e=this.builder.vertexIndices.length,{normalIndices:t,vertexIndices:i}=this.builder;return[[It.r.POSITION,new gr.n(this.vertexAttributePosition,i,3,!0)],[It.r.NORMALCOMPRESSED,new gr.n(this.vertexAttributeNormal,t,2,!0)],[It.r.COLOR,new gr.n(this.vertexAttributeColor,(0,Y.EH)(e),4)]]}onPathChanged(e){super.onPathChanged(e),this.bake(this.size)}intersect(e,t,i){const r=this.builder.vertexIndices,s=new gr.K(this.vertexAttributePosition,3),n=r.length/3;(0,hu.Z$)(e,t,0,n,r,s,void 0,void 0,i)}}class Gg extends Ng{constructor(e,t,i,r){super(e),this.sizeAttributeValue=t,this.colorAttributeValue=i,this.opacityAttributeValue=r,this.vvData=null,this.baked=new Vg(e),this.vvData=(0,J.oe)(4*this.builder.path.vertices.length);for(let e=0;e<this.builder.path.vertices.length;++e){this.vvData[4*e]=t,this.vvData[4*e+1]=i,this.vvData[4*e+2]=r;const s=0===e||e===this.builder.path.vertices.length-1;this.vvData[4*e+3]=s?1:0}}createGeometryData(){const{positions:e,profileRightAxes:t,profileUpAxes:i,profileVertexAndNormals:r,pathVertexIndices:s,vertexIndices:n}=this.builder;return[[It.r.POSITION,new gr.n(e,s,3,!0)],[It.r.PROFILERIGHT,new gr.n(t,n,4,!0)],[It.r.PROFILEUP,new gr.n(i,n,4,!0)],[It.r.PROFILEVERTEXANDNORMAL,new gr.n(r,n,4,!0)],[It.r.FEATUREVALUE,new gr.n(this.vvData,s,4,!0)]]}onPathChanged(e){super.onPathChanged(e);const t=e.getMutableAttribute(It.r.POSITION);t&&(t.data=this.builder.positions)}}const Ug=(0,dr.vt)(),zg=(0,dr.vt)(),Bg=(0,dr.vt)(),Hg=(0,I.vt)(),jg=(0,I.vt)(),Wg=(0,I.vt)(),kg=(0,I.vt)(),Zg=(0,I.vt)();class qg{constructor(){this.vertices=new Array,this.normals=new Array,this.indices=new Array,this.poles=new Array,this.poleIndices=new Array}addVertex(e,t){return this.vertices.push((0,dr.o8)(e)),this.normals.push((0,dr.o8)(t)),this.vertices.length-1}addPole(e,t=null){return this.poles.push({position:(0,dr.o8)(e),normal:t?(0,dr.o8)(t):null}),this.poles.length-1}addSegment(e,t=null){this.indices.push(e.v0),this.indices.push(e.v1),t&&(this.poleIndices.push(t.v0),this.poleIndices.push(t.v1))}get numSegments(){return this.indices.length/2}translate(e,t){for(const i of this.vertices)i[0]+=e,i[1]+=t;for(const i of this.poles)i.position[0]+=e,i.position[1]+=t}get usedMemory(){return this.vertices.length*(0,R.Ek)(this.vertices[0])*2+(0,R.Ek)(this.indices)}}const $g={top:[0,-.5],bottom:[0,.5]};function Qg(e){const t=new qg,i={v0:0,v1:0};t.addPole((0,dr.fA)(0,0));for(let e=0;e<10;++e){const i=2*e*Math.PI/10,r=Math.cos(i),s=Math.sin(i),n=(0,dr.fA)(.5*r,.5*s),a=(0,dr.fA)(r,s);t.addVertex(n,a)}for(let e=0;e<9;++e){const r={v0:e,v1:e+1};t.addSegment(r,i)}const r={v0:9,v1:0};if(t.addSegment(r,i),"center"!==e){const i=$g[e];t.translate(i[0],i[1])}return t}const Jg={center:Qg("center"),top:Qg("top"),bottom:Qg("bottom")},Yg={center:Xg("center"),top:Xg("top"),bottom:Xg("bottom")};function Xg(e){const t=new qg,i=(0,dr.fA)(-.5,-.5),r=(0,dr.fA)(.5,-.5),s=(0,dr.fA)(.5,.5),n=(0,dr.fA)(-.5,.5),a=(0,dr.fA)(0,-1),o=(0,dr.fA)(1,0),l=(0,dr.fA)(0,1),c=(0,dr.fA)(-1,0);if(t.addPole((0,dr.fA)(0,.5),l),t.addPole((0,dr.fA)(0,.5)),t.addPole((0,dr.fA)(0,-.5)),t.addPole((0,dr.fA)(0,-.5),a),t.addVertex(i,a),t.addVertex(r,a),t.addSegment({v0:0,v1:1},{v0:3,v1:3}),t.addVertex(r,o),t.addVertex(s,o),t.addSegment({v0:2,v1:3},{v0:2,v1:1}),t.addVertex(s,l),t.addVertex(n,l),t.addSegment({v0:4,v1:5},{v0:0,v1:0}),t.addVertex(n,c),t.addVertex(i,c),t.addSegment({v0:6,v1:7},{v0:1,v1:2}),"center"!==e){const i=$g[e];t.translate(i[0],i[1])}return t}var Kg=i(78115);function em(e,t,i,r,s){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e}function tm(e,t,i){const r=t[0],s=t[1],n=t[2],a=t[3],o=i[0],l=i[1],c=i[2],h=i[3];return e[0]=r*o+n*l,e[1]=s*o+a*l,e[2]=r*c+n*h,e[3]=s*c+a*h,e}function im(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}const rm=tm,sm=im;Object.freeze(Object.defineProperty({__proto__:null,LDU:function(e,t,i,r){return e[2]=r[2]/r[0],i[0]=r[0],i[1]=r[1],i[3]=r[3]-e[2]*i[1],[e,t,i]},add:function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e},adjoint:function(e,t){const i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},determinant:function(e){return e[0]*e[3]-e[2]*e[1]},equals:function(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],a=t[0],o=t[1],l=t[2],c=t[3],h=(0,Kg.FD)();return Math.abs(i-a)<=h*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-o)<=h*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-l)<=h*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=h*Math.max(1,Math.abs(n),Math.abs(c))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},frob:function(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2)},fromRotation:function(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},invert:function(e,t){const i=t[0],r=t[1],s=t[2],n=t[3];let a=i*n-s*r;return a?(a=1/a,e[0]=n*a,e[1]=-r*a,e[2]=-s*a,e[3]=i*a,e):null},mul:rm,multiply:tm,multiplyScalar:function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e},multiplyScalarAndAdd:function(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e},rotate:function(e,t,i){const r=t[0],s=t[1],n=t[2],a=t[3],o=Math.sin(i),l=Math.cos(i);return e[0]=r*l+n*o,e[1]=s*l+a*o,e[2]=r*-o+n*l,e[3]=s*-o+a*l,e},scale:function(e,t,i){const r=t[0],s=t[1],n=t[2],a=t[3],o=i[0],l=i[1];return e[0]=r*o,e[1]=s*o,e[2]=n*l,e[3]=a*l,e},set:em,str:function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},sub:sm,subtract:im,transpose:function(e,t){if(e===t){const i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e}},Symbol.toStringTag,{value:"Module"})),Object.freeze(Object.defineProperty({__proto__:null,clone:function(e){return[e[0],e[1],e[2],e[3]]},create:function(){return[1,0,0,1]},createView:function(e,t){return new Float64Array(e,t,4)},fromValues:function(e,t,i,r){return[e,t,i,r]}},Symbol.toStringTag,{value:"Module"}));class nm{constructor(){this.vLeft=(0,I.vt)(),this.vRight=(0,I.vt)(),this.vMinSiblingLength=0,this.frame=new Tg}setFrameFromUpVector(e){(0,M.c)(this.frame.up,e),(0,M.g)(_m,this.vLeft,this.vRight),(0,M.n)(_m,_m),(0,M.h)(mm,this.frame.up,(0,M.j)(_m,this.frame.up)),(0,M.f)(ym,_m,mm),(0,M.n)(ym,ym),(0,M.b)(this.frame.right,ym,this.frame.up)}get foldingAngle(){return Math.PI-this.rotationAngle}}class am extends nm{get rotationFrameUp(){return this.frame.up}get rotationRight(){return dr.Cw}get rotationAngle(){return(0,M.h)(fm,this.frame.up,(0,M.j)(this.frame.up,this.vLeft)),(0,M.f)(fm,this.vLeft,fm),(0,M.E)(fm,fm),(0,M.n)(fm,fm),(0,M.h)(gm,this.frame.up,(0,M.j)(this.frame.up,this.vRight)),(0,M.f)(gm,this.vRight,gm),(0,M.n)(gm,gm),(0,M.b)(pm,this.rotationFrameUp,this.vLeft),Math.sign((0,M.j)(pm,this.vRight))*(Math.PI-(0,U.XM)((0,M.j)(fm,gm)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength/Math.cos(.5*this.foldingAngle))}applyMiterStretch(e,t){const i=this.rotationAngle;if(Math.abs(i)<=0)return t;const r=(0,U.J_)(Math.cos(.5*i));return(0,xa.hZ)(e,(r-1+1)*t[0],t[1])}}class om extends nm{get rotationFrameUp(){const e=Math.sign((0,M.j)(this.frame.right,this.vRight));return(0,M.b)(cm,this.vRight,this.vLeft),(0,M.h)(cm,cm,e),(0,M.n)(cm,cm)}get rotationRight(){const e=this.rotationFrameUp,t=(0,M.j)(e,this.frame.up),i=(0,M.j)(e,this.frame.right);return(0,M.h)(dm,this.frame.up,-i),(0,M.h)(um,this.frame.right,t),(0,M.g)(dm,dm,um),(0,M.n)(dm,dm),function(e,t,i){(0,xa.hZ)(e,(0,M.j)(i,t.right),(0,M.j)(i,t.up))}(hm,this.frame,dm),hm}get rotationAngle(){const e=Math.sign((0,M.j)(this.frame.right,this.vRight));return(0,M.E)(pm,this.vLeft),-e*(Math.PI-(0,U.XM)((0,M.j)(pm,this.vRight)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength*(0,U.J_)(Math.cos(.5*this.foldingAngle)))}applyMiterStretch(e,t){const i=this.rotationAngle;if(0===Math.abs(i))return t;const r=(0,U.J_)(Math.cos(.5*i)),s=this.rotationRight,n=em(vm,1+(r-1)*s[0]*s[0],(r-1)*s[0]*s[1],(r-1)*s[0]*s[1],1+(r-1)*s[1]*s[1]);return(0,xa.ZF)(e,t,n)}}function lm(e){switch(e){case Fg.World:return new am;case Fg.Path:return new om}}const cm=(0,I.vt)(),hm=(0,dr.vt)(),dm=(0,I.vt)(),um=(0,I.vt)(),pm=(0,I.vt)(),fm=(0,I.vt)(),gm=(0,I.vt)(),mm=(0,I.vt)(),_m=(0,I.vt)(),ym=(0,I.vt)(),vm=[1,0,0,1];var bm=i(23605),xm=i(40198),Sm=i(43575);const wm=new Map([[It.r.POSITION,0],[It.r.PROFILERIGHT,1],[It.r.PROFILEUP,2],[It.r.PROFILEVERTEXANDNORMAL,3],[It.r.FEATUREVALUE,4]]);class Cm extends xm.W{constructor(){super(...arguments),this.ambient=(0,I.fA)(.2,.2,.2),this.diffuse=(0,I.fA)(.8,.8,.8),this.specular=(0,I.fA)(0,0,0),this.opacity=1,this.origin=(0,I.vt)(),this.modelTransformation=null}}class Rm extends Jn.w{initializeConfiguration(e,t){t.spherical=e.viewingMode===oe.RT.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Xn.B(e.rctx,Rm.shader.get().build(this.configuration),wm)}initializePipeline(){const e=this.configuration.transparencyPassType,t=this.configuration,i=e===Mo.y.NONE,r=e===Mo.y.FrontFace;return(0,ea.Ey)({blending:t.output!==Wn.V.Color&&t.output!==Wn.V.Alpha||!t.transparent?null:i?Oo.V0:(0,Oo.ez)(e),culling:t.hasSlicePlane&&!t.transparent&&t.doubleSidedMode!==bm.W.None?ea.hG:null,depthTest:{func:(0,Oo.K_)(e)},depthWrite:i||r?ea.kn:null,colorWrite:ea.wE,stencilWrite:t.hasOccludees?Po.v0:null,stencilTest:t.hasOccludees?Po.qh:null,polygonOffset:i||r?null:Oo.SE})}}Rm.shader=new Qn.$(Sm.P,(()=>i.e(7975).then(i.bind(i,97975))));class Em extends ra.E{constructor(){super(...arguments),this.output=Wn.V.Color,this.doubleSidedMode=bm.W.None,this.transparencyPassType=Mo.y.NONE,this.spherical=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.doublePrecisionRequiresObfuscation=!1}}(0,r._)([(0,ia.W)({count:Wn.V.COUNT})],Em.prototype,"output",void 0),(0,r._)([(0,ia.W)({count:bm.W.COUNT})],Em.prototype,"doubleSidedMode",void 0),(0,r._)([(0,ia.W)({count:Mo.y.COUNT})],Em.prototype,"transparencyPassType",void 0),(0,r._)([(0,ia.W)()],Em.prototype,"spherical",void 0),(0,r._)([(0,ia.W)()],Em.prototype,"receiveShadows",void 0),(0,r._)([(0,ia.W)()],Em.prototype,"receiveAmbientOcclusion",void 0),(0,r._)([(0,ia.W)()],Em.prototype,"vvSize",void 0),(0,r._)([(0,ia.W)()],Em.prototype,"vvColor",void 0),(0,r._)([(0,ia.W)()],Em.prototype,"vvOpacity",void 0),(0,r._)([(0,ia.W)()],Em.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ia.W)()],Em.prototype,"transparent",void 0),(0,r._)([(0,ia.W)()],Em.prototype,"hasOccludees",void 0),(0,r._)([(0,ia.W)()],Em.prototype,"multipassEnabled",void 0),(0,r._)([(0,ia.W)()],Em.prototype,"cullAboveGround",void 0),(0,r._)([(0,ia.W)()],Em.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,r._)([(0,ia.W)({constValue:!1})],Em.prototype,"occlusionPass",void 0),(0,r._)([(0,ia.W)({constValue:Ja.A9.Disabled})],Em.prototype,"pbrMode",void 0),(0,r._)([(0,ia.W)({constValue:!0})],Em.prototype,"hasVvInstancing",void 0),(0,r._)([(0,ia.W)({constValue:!1})],Em.prototype,"useCustomDTRExponentForWater",void 0),(0,r._)([(0,ia.W)({constValue:!1})],Em.prototype,"useFillLights",void 0),(0,r._)([(0,ia.W)({constValue:!1})],Em.prototype,"hasColorTexture",void 0);class Am extends Zn.im{constructor(e){super(e,new Om),this.supportsEdges=!0,this.produces=new Map([[qn.N.OPAQUE_MATERIAL,e=>(this.parameters.castShadows&&(0,Wn.PJ)(e)||(0,Wn.XY)(e))&&!this.parameters.transparent],[qn.N.TRANSPARENT_MATERIAL,e=>(this.parameters.castShadows&&(0,Wn.PJ)(e)||(0,Wn.XY)(e))&&this.parameters.transparent]]),this._vertexAttributeLocations=wm,this._configuration=new Em,this._vertexBufferLayout=Am.getVertexBufferLayout()}getConfiguration(e,t){return this._configuration.output=e,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasOccludees=this.parameters.hasOccludees,e!==Wn.V.Color&&e!==Wn.V.Alpha||(this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?bm.W.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?bm.W.WindingOrder:bm.W.None,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.receiveAmbientOcclusion=null!=t.ssao),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}isVisibleForOutput(e){return e!==Wn.V.Shadow&&e!==Wn.V.ShadowExcludeHighlight&&e!==Wn.V.ShadowHighlight||this.parameters.castShadows}isVisible(){return super.isVisible()&&this.parameters.opacity>0}intersect(e,t,i,r,s,n){const a=e;if(!Lg(a))return;const o=a.path,l=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSize){const{offset:e,factor:t,minSize:i,maxSize:r}=this.parameters.vvSize,s=o.sizeAttributeValue;l[0]*=(0,U.qE)(e[0]+s*t[0],i[0],r[0]),l[1]*=(0,U.qE)(e[2]+s*t[2],i[2],r[2])}const c=Math.max(l[0],l[1]),h=e.boundingInfo;if(null==h)return void this._intersectTriangles(o,l,r,s,n);const d=(0,q.fA)(h.bbMin[0]-c,h.bbMin[1]-c,h.bbMin[2]-c,h.bbMax[0]+c,h.bbMax[1]+c,h.bbMax[2]+c),u=[s[0]-r[0],s[1]-r[1],s[2]-r[2]],p=Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]),f=[p/u[0],p/u[1],p/u[2]];(0,hu.Wb)(d,r,f,i.tolerance)&&this._intersectTriangles(o,l,r,s,n)}_intersectTriangles(e,t,i,r,s){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(i,r,s)}createBufferWriter(){return new Up.Z(this._vertexBufferLayout)}createGLMaterial(e){return new Tm(e)}static getVertexBufferLayout(){return(0,jn.BP)().vec3f(It.r.POSITION).vec4f(It.r.PROFILERIGHT).vec4f(It.r.PROFILEUP).vec4f(It.r.PROFILEVERTEXANDNORMAL).vec4f(It.r.FEATUREVALUE)}}class Tm extends kn.A{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}_updateShadowState(e){null!=this.technique&&e.shadowMap.enabled===this.technique.configuration.receiveShadows||this._material.setParameters({receiveShadows:e.shadowMap.enabled})}beginSlot(e){return this._output!==Wn.V.Color&&this._output!==Wn.V.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this.ensureTechnique(Rm,e)}}class Om extends Cm{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.receiveShadows=!1,this.castShadows=!0,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1}}const Pm=["polyline"];function Mm(e,t,i){const{origin:r,positions:s}=e;let n=e.offset;switch(t){default:case Fg.World:for(const t of e.vertices)Fm[0]=s[n++]+r[0],Fm[1]=s[n++]+r[1],Fm[2]=s[n++]+r[2],i.worldUpAtPosition(Fm,Fm),t.setFrameFromUpVector(Fm);break;case Fg.Path:Fm[0]=s[n]+r[0],Fm[1]=s[n+1]+r[1],Fm[2]=s[n+2]+r[2],i.worldUpAtPosition(Fm,Fm),function(e,t){let i=null;const r=e.vertices.length,s=.99619469809,n=(0,I.vt)(),a=(0,I.vt)(),o=(0,I.vt)(),l=(0,I.vt)(),c=(0,I.vt)(),h=(0,I.vt)(),d=(0,pr.vt)();let u=e.vertices[0];(0,M.c)(a,t),(0,M.s)(n,0,1,0),Zr(u.vRight,a,n,n,o,a,s),(0,M.c)(u.frame.up,a),(0,M.c)(u.frame.right,o);const p=e.positions;let f=e.offset;i=u;for(let t=1;t<r;++t){u=e.vertices[t],(0,M.g)(c,u.vLeft,u.vRight);let r=(0,M.l)(c);r>0?(r=1/Math.sqrt(r),c[0]=c[0]*r,c[1]=c[1]*r,c[2]=c[2]*r):(c[0]=u.vRight[0],c[1]=u.vRight[1],c[2]=u.vRight[2]),h[0]=p[f]+i.frame.up[0],h[1]=p[f+1]+i.frame.up[1],h[2]=p[f+2]+i.frame.up[2],f+=3;const g=(0,M.s)(Zg,p[f],p[f+1],p[f+2]);(0,pr.O_)(g,c,d),(0,pr.Ui)(d,(0,fr.LV)(h,u.vLeft),l)?(l[0]-=p[f],l[1]-=p[f+1],l[2]-=p[f+2],(0,M.n)(a,l),(0,M.b)(o,c,a),(0,M.n)(o,o)):Zr(c,i.frame.up,i.frame.right,n,o,a,s),(0,M.c)(u.frame.up,a),(0,M.c)(u.frame.right,o),i=u}}(e,Fm)}}function Im(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function Dm(e,t,i,r){let s=0;const{origin:n,vertices:a,positions:o,positionsES:l}=e,c=e.offset+3*a.length;for(let t=e.offset;t<c;t+=3)(0,M.s)(Fm,l[t],l[t+1],l[t+2]),i(Fm,Lm),s+=Lm.sampledElevation,Fm[0]=o[t]+n[0],Fm[1]=o[t+1]+n[1],Fm[2]=o[t+2]+n[2],r.setAltitude(Fm,Lm.z),o[t]=Fm[0]-n[0],o[t+1]=Fm[1]-n[1],o[t+2]=Fm[2]-n[2];return e.updatePathVertexInformation(),s/a.length}const Fm=(0,I.vt)(),Lm=new Bt;function Nm(e,t,i,r,s=1){(0,M.s)(zm,1,0,0),(0,M.s)(Bm,0,1,0),(0,M.s)(Hm,0,0,1),function(e,t){(0,M.s)(Xm,0,0,0);for(let e=0;e<t.length-3;e+=3)Xm[0]+=t[e],Xm[1]+=t[e+1],Xm[2]+=t[e+2];(0,M.h)(e,Xm,1/(t.length/3-1))}(Vm,i),(0,pr.ci)(Um,i)&&function(e,t,i,r,s,n){null!=s?(s.basisMatrixAtPosition(n,$m),(0,M.s)(Qm,$m[0],$m[1],$m[2]),(0,M.s)(Jm,$m[4],$m[5],$m[6]),(0,M.s)(Ym,$m[8],$m[9],$m[10])):((0,M.s)(Qm,1,0,0),(0,M.s)(Jm,0,1,0),(0,M.s)(Ym,0,0,1));const a=(0,pr.Qj)(e);(0,M.j)(a,Ym)<0&&(0,M.h)(a,a,-1),(0,M.c)(r,a);const o=(0,M.j)(a,Jm),l=(0,M.j)(a,Qm);Math.abs(o)>Math.abs(l)?((0,M.q)(t,Qm,a,-l),(0,M.n)(t,t),(0,M.b)(i,t,a),(0,M.n)(i,i),(0,M.h)(i,i,-1)):((0,M.q)(i,Jm,a,-o),(0,M.n)(i,i),(0,M.b)(t,i,a),(0,M.n)(t,t))}(Um,zm,Bm,Hm,r,Vm),(0,xa.hZ)(jm,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),(0,xa.hZ)(Wm,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let e=0;e<i.length;e+=3){(0,M.s)(Gm,i[e],i[e+1],i[e+2]);const t=(0,M.j)(zm,Gm),r=(0,M.j)(Bm,Gm);jm[0]=Math.min(jm[0],t),jm[1]=Math.min(jm[1],r),Wm[0]=Math.max(Wm[0],t),Wm[1]=Math.max(Wm[1],r)}const n=(0,M.j)(Hm,Vm);Km(km,jm[0],jm[1],n,zm,Bm,Hm),Km(Zm,Wm[0],jm[1],n,zm,Bm,Hm),Km(qm,jm[0],Wm[1],n,zm,Bm,Hm),(0,M.f)(Zm,Zm,km),(0,M.h)(Zm,Zm,.5),(0,M.f)(qm,qm,km),(0,M.h)(qm,qm,.5),(0,M.g)(km,km,Zm),(0,M.g)(km,km,qm);const a=jm[0]%s,o=jm[1]%s,l=jm[0]-a,c=jm[1]-o;for(let r=0;r<i.length;r+=3){(0,M.s)(Gm,i[r],i[r+1],i[r+2]);const n=r/3,a=4*n;e[a]=((0,M.j)(zm,Gm)-l)/s,e[a+1]=((0,M.j)(Bm,Gm)-c)/s,e[a+2]=l/s,e[a+3]=c/s;const o=9*n;for(let e=0;e<3;e++)t[o+e]=km[e],t[o+e+3]=Zm[e],t[o+e+6]=qm[e]}}const Vm=(0,I.vt)(),Gm=(0,I.vt)(),Um=(0,pr.vt)(),zm=(0,I.vt)(),Bm=(0,I.vt)(),Hm=(0,I.vt)(),jm=(0,dr.vt)(),Wm=(0,dr.vt)(),km=(0,I.vt)(),Zm=(0,I.vt)(),qm=(0,I.vt)(),$m=(0,P.vt)(),Qm=(0,I.vt)(),Jm=(0,I.vt)(),Ym=(0,I.vt)(),Xm=(0,I.vt)();function Km(e,t,i,r,s,n,a){(0,M.s)(e,t*s[0]+i*n[0]+r*a[0],t*s[1]+i*n[1]+r*a[1],t*s[2]+i*n[2]+r*a[2])}class e_ extends Zn.im{intersect(e,t,i,r,s,n){return(0,hu.Uy)(e,i,r,s,void 0,n)}}var t_=i(38382);Eo.S;class i_ extends Jn.w{initializeProgram(e){return new Xn.B(e.rctx,i_.shader.get().build(this.configuration),Yn.D)}_createPipeline(e,t){const i=this.configuration,r=e===Mo.y.NONE,s=e===Mo.y.FrontFace;return(0,ea.Ey)({blending:i.output!==Wn.V.Color&&i.output!==Wn.V.Alpha||!i.transparent?null:r?Oo.V0:(0,Oo.ez)(e),culling:(0,ea.Xt)(i.cullFace),depthTest:i.draped?null:{func:(0,Oo.K_)(e)},depthWrite:i.draped?null:(r||s)&&i.writeDepth?ea.kn:null,colorWrite:ea.wE,stencilWrite:i.hasOccludees?Po.v0:null,stencilTest:i.hasOccludees?t?Po.a9:Po.qh:null,polygonOffset:r||s?i.polygonOffset?r_:null:(0,Oo.aB)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}i_.shader=new Qn.$(t_.C,(()=>i.e(5918).then(i.bind(i,55918))));const r_={factor:1,units:1};class s_ extends ra.E{constructor(){super(...arguments),this.output=Wn.V.Color,this.cullFace=ge.s2.None,this.transparencyPassType=Mo.y.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1,this.draped=!1}}(0,r._)([(0,ia.W)({count:Wn.V.COUNT})],s_.prototype,"output",void 0),(0,r._)([(0,ia.W)({count:ge.s2.COUNT})],s_.prototype,"cullFace",void 0),(0,r._)([(0,ia.W)({count:Mo.y.COUNT})],s_.prototype,"transparencyPassType",void 0),(0,r._)([(0,ia.W)()],s_.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ia.W)()],s_.prototype,"hasVertexColors",void 0),(0,r._)([(0,ia.W)()],s_.prototype,"transparent",void 0),(0,r._)([(0,ia.W)()],s_.prototype,"polygonOffset",void 0),(0,r._)([(0,ia.W)()],s_.prototype,"enableOffset",void 0),(0,r._)([(0,ia.W)()],s_.prototype,"writeDepth",void 0),(0,r._)([(0,ia.W)()],s_.prototype,"hasOccludees",void 0),(0,r._)([(0,ia.W)()],s_.prototype,"multipassEnabled",void 0),(0,r._)([(0,ia.W)()],s_.prototype,"cullAboveGround",void 0),(0,r._)([(0,ia.W)()],s_.prototype,"objectAndLayerIdColorInstanced",void 0),(0,r._)([(0,ia.W)()],s_.prototype,"vvColor",void 0),(0,r._)([(0,ia.W)()],s_.prototype,"draped",void 0),(0,r._)([(0,ia.W)({constValue:!1})],s_.prototype,"occlusionPass",void 0),(0,r._)([(0,ia.W)({constValue:!0})],s_.prototype,"hasVvInstancing",void 0),(0,r._)([(0,ia.W)({constValue:!1})],s_.prototype,"vvSize",void 0),(0,r._)([(0,ia.W)({constValue:!1})],s_.prototype,"vvOpacity",void 0);class n_ extends e_{constructor(e){super(e,new o_),this.supportsEdges=!0,this.produces=new Map([[qn.N.OPAQUE_MATERIAL,e=>e===Wn.V.Highlight||(0,Wn.BF)(e)&&!this._isTransparent],[qn.N.OPAQUE_NO_SSAO_DEPTH,e=>e===Wn.V.LinearDepth&&this.parameters.writeLinearDepth&&!this._isTransparent],[qn.N.TRANSPARENT_MATERIAL,e=>(0,Wn.BF)(e)&&this._isTransparent&&this.parameters.writeDepth],[qn.N.TRANSPARENT_NO_SSAO_DEPTH,e=>e===Wn.V.LinearDepth&&this.parameters.writeLinearDepth&&this._isTransparent&&this.parameters.writeDepth],[qn.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>((0,Wn.BF)(e)||e===Wn.V.LinearDepth&&this.parameters.writeLinearDepth)&&this._isTransparent&&!this.parameters.writeDepth],[qn.N.DRAPED_MATERIAL,e=>(0,Wn.i3)(e)]]),this._configuration=new s_}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._isTransparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Oo.xt,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}createGLMaterial(e){return new a_(e)}createBufferWriter(){const e=(0,jn.BP)().vec3f(It.r.POSITION);return(0,d.A)("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(It.r.OBJECTANDLAYERIDCOLOR),this.parameters.vvColor?e.f32(It.r.COLORFEATUREATTRIBUTE):e.vec4u8(It.r.COLOR),new Up.Z(e)}get _isTransparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}}class a_ extends kn.A{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==Wn.V.Color&&this._output!==Wn.V.Alpha||this._updateOccludeeState(e),this.ensureTechnique(i_,e)}}class o_ extends Eo.S{constructor(){super(...arguments),this.color=F.uY,this.forceTransparentMode=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=ge.s2.None,this.hasOccludees=!1,this.draped=!1}}var l_=i(72253),c_=i(49526);class h_ extends Jn.w{initializeProgram(e){return new Xn.B(e.rctx,h_.shader.get().build(this.configuration),(0,d.A)("enable-feature:objectAndLayerId-rendering")?f_:p_)}_setPipelineState(e,t){const i=this.configuration,r=e===Mo.y.NONE,s=e===Mo.y.FrontFace;return(0,ea.Ey)({blending:i.output===Wn.V.Color||i.output===Wn.V.Alpha?r?Oo.V0:(0,Oo.ez)(e):null,culling:(0,ea.Xt)(i.cullFace),depthTest:i.draped?null:{func:(0,Oo.K_)(e)},depthWrite:i.draped?null:r?ea.kn:(0,Oo.XO)(e),colorWrite:ea.wE,stencilWrite:i.hasOccludees?Po.v0:null,stencilTest:i.hasOccludees?t?Po.a9:Po.qh:null,polygonOffset:r||s?i.polygonOffset?d_:null:(0,Oo.aB)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}h_.shader=new Qn.$(c_.P,(()=>i.e(6470).then(i.bind(i,56470))));const d_={factor:1,units:1};class u_ extends ra.E{constructor(){super(...arguments),this.output=Wn.V.Color,this.cullFace=ge.s2.None,this.transparencyPassType=Mo.y.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasOccludees=!1,this.enableOffset=!0,this.multipassEnabled=!1,this.cullAboveGround=!1,this.vvColor=!1,this.objectAndLayerIdColorInstanced=!1}}(0,r._)([(0,ia.W)({count:Wn.V.COUNT})],u_.prototype,"output",void 0),(0,r._)([(0,ia.W)({count:ge.s2.COUNT})],u_.prototype,"cullFace",void 0),(0,r._)([(0,ia.W)({count:l_.O.COUNT})],u_.prototype,"style",void 0),(0,r._)([(0,ia.W)({count:Mo.y.COUNT})],u_.prototype,"transparencyPassType",void 0),(0,r._)([(0,ia.W)()],u_.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ia.W)()],u_.prototype,"hasVertexColors",void 0),(0,r._)([(0,ia.W)()],u_.prototype,"polygonOffset",void 0),(0,r._)([(0,ia.W)()],u_.prototype,"hasOccludees",void 0),(0,r._)([(0,ia.W)()],u_.prototype,"patternSpacing",void 0),(0,r._)([(0,ia.W)()],u_.prototype,"lineWidth",void 0),(0,r._)([(0,ia.W)()],u_.prototype,"enableOffset",void 0),(0,r._)([(0,ia.W)()],u_.prototype,"draped",void 0),(0,r._)([(0,ia.W)()],u_.prototype,"multipassEnabled",void 0),(0,r._)([(0,ia.W)()],u_.prototype,"cullAboveGround",void 0),(0,r._)([(0,ia.W)()],u_.prototype,"vvColor",void 0),(0,r._)([(0,ia.W)({constValue:!0})],u_.prototype,"writeDepth",void 0),(0,r._)([(0,ia.W)({constValue:!1})],u_.prototype,"occlusionPass",void 0),(0,r._)([(0,ia.W)({constValue:!1})],u_.prototype,"hasVvInstancing",void 0),(0,r._)([(0,ia.W)({constValue:!1})],u_.prototype,"vvSize",void 0),(0,r._)([(0,ia.W)({constValue:!1})],u_.prototype,"vvOpacity",void 0);const p_=new Map([[It.r.POSITION,0],[It.r.COLOR,3],[It.r.UVMAPSPACE,4],[It.r.COLORFEATUREATTRIBUTE,5],[It.r.BOUNDINGRECT,6]]),f_=new Map([[It.r.POSITION,0],[It.r.COLOR,3],[It.r.UVMAPSPACE,4],[It.r.COLORFEATUREATTRIBUTE,5],[It.r.BOUNDINGRECT,6],[It.r.OBJECTANDLAYERIDCOLOR,9]]);class g_ extends e_{constructor(e){super(e,new y_),this.supportsEdges=!0,this.produces=new Map([[qn.N.OPAQUE_MATERIAL,e=>(0,Wn.u5)(e)],[qn.N.TRANSPARENT_MATERIAL,e=>(0,Wn.j8)(e)],[qn.N.TRANSPARENT_NO_SSAO_DEPTH,e=>e===Wn.V.LinearDepth&&this.parameters.writeLinearDepth],[qn.N.DRAPED_MATERIAL,e=>this.parameters.draped&&e===Wn.V.Color||(0,Wn.u5)(e)]]),this._vertexAttributeLocations=(0,d.A)("enable-feature:objectAndLayerId-rendering")?f_:p_,this._configuration=new u_}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Oo.xt,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration}createGLMaterial(e){return new m_(e)}createBufferWriter(){const e=(0,jn.BP)().vec3f(It.r.POSITION).vec4f(It.r.UVMAPSPACE);return this.parameters.draped||e.mat3f(It.r.BOUNDINGRECT),this.parameters.vvColor?e.f32(It.r.COLORFEATUREATTRIBUTE):e.vec4u8(It.r.COLOR),(0,d.A)("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(It.r.OBJECTANDLAYERIDCOLOR),new __(e)}}class m_ extends kn.A{_updateParameters(e){return this.ensureTechnique(h_,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==Wn.V.Color&&this._output!==Wn.V.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class __ extends Up.Z{write(e,t,i,r,s){(0,$n.SA)(i,this.vertexBufferLayout,e,t,r,s);for(const t of this.vertexBufferLayout.fields.keys()){const n=i.attributes.get(t),a=n?.indices;if(n&&a)switch(t){case It.r.UVMAPSPACE:{(0,yr.vA)(4===n.size);const e=r.getField(t,nu.Eq);e&&(0,$n.Ut)(n,e,s);break}case It.r.BOUNDINGRECT:{(0,yr.vA)(9===n.size);const i=r.getField(t,nu.jZ);i&&this.writeBoundingRect(n,e,i,s);break}}}}writeBoundingRect(e,t,i,r){const{data:s,indices:n}=e,a=t,o=i.typedBuffer,l=i.typedBufferStride,c=n.length;r*=l;for(let e=0;e<c;++e){const t=9*n[e],i=s[t],c=s[t+1],h=s[t+2];o[r]=a[0]*i+a[4]*c+a[8]*h+a[12],o[r+1]=a[1]*i+a[5]*c+a[9]*h+a[13],o[r+2]=a[2]*i+a[6]*c+a[10]*h+a[14];for(let e=3;e<9;++e)o[r+e]=s[t+e];r+=l}}}class y_ extends Eo.S{constructor(){super(...arguments),this.color=(0,F.fA)(1,1,1,1),this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=ge.s2.None,this.hasOccludees=!1,this.style=l_.O.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}}function v_(e,t){if(function(e){return e.material instanceof g_&&!e.material.parameters.draped}(e)){const i=e.attributes.get(It.r.POSITION).data;Nm(e.getMutableAttribute(It.r.UVMAPSPACE).data,e.getMutableAttribute(It.r.BOUNDINGRECT).data,i,t)}}function b_(e,t,i,r,s){const n=Fs(e,t,i,r,s),a=e.stageObject.geometries;for(const e of a)v_(e,s);return n}const x_=["polyline","polygon","extent"],S_=new _n.wI({size:!1,color:!0,rotation:!1,opacity:!1});class w_ extends vn{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1}async doLoad(){this._fastUpdates=(0,_n.s_)(this._context.renderer,S_)}_createMaterials(){if(this._materials.length>0)return;const e=this.symbolLayer?.material?.color,t=this._getCombinedOpacityAndColor(e);this._materials[A_.Fill]=function(e,t){const i=e?.pattern??null;return null==i?new n_(t):"none"===i.style||"solid"===i.style?("none"===i.style&&(t.color=(0,F.fA)(0,0,0,0),t.forceTransparentMode=!0),new n_(t)):(t.style=function(e){switch(e){case"horizontal":return l_.O.Horizontal;case"vertical":return l_.O.Vertical;case"cross":return l_.O.Cross;case"forward-diagonal":return l_.O.ForwardDiagonal;case"backward-diagonal":return l_.O.BackwardDiagonal;case"diagonal-cross":return l_.O.DiagonalCross;default:return}}(i.style),new g_(t))}(this.symbolLayer,{color:t,forceTransparentMode:this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,draped:this.draped,hasSlicePlane:this._context.slicePlaneEnabled,...this._fastUpdates?.materialParameters}),this._needsUV=this._materials[A_.Fill]instanceof g_;const i=this.symbolLayer.outline;if(this._isValidOutline(i)){const e=up(i.pattern);this._materials[A_.Outline]=new Vo({width:(0,Ms.Lz)(i.size),color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:e,cap:Qu(i.patternCap||"butt")})}this._context.stage.addMany(this._materials)}_isValidOutline(e){return null!=e?.size&&e.size>0&&null!=e.color&&(null==e.pattern||"style"!==e.pattern.type||"none"!==e.pattern.style)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,x_,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t);return this.ensureDrapedStatus("on-the-ground"===r.mode),this._createMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,r)}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return pn.RecreateSymbol;if(!(0,_n.J_)(this._fastUpdates,t,S_))return pn.RecreateSymbol;this._materials[A_.Fill]?.setParameters(this._fastUpdates.materialParameters)}return pn.FastUpdate}layerOpacityChanged(){if(null!=this._materials[A_.Fill]){const e=this._materials[A_.Fill].parameters.color,t=this.symbolLayer?.material?.color,i=this._getCombinedOpacity(t);this._materials[A_.Fill].setParameters({color:[e[0],e[1],e[2],i],forceTransparentMode:this.needsDrivenTransparentPass})}if(null!=this._materials[A_.Outline]){const e=this._materials[A_.Outline].parameters.color;this._materials[A_.Outline].setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=Nt(w_.elevationModeChangeTypes,i,r);if(s!==Mt.UPDATE)return s;const n=Vt(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){if(this._materials[A_.Fill]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[A_.Outline]){const e={hasSlicePlane:this._context.slicePlaneEnabled};this._materials[A_.Outline].setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,i){const r=(0,Fa.dE)(e.geometry);if(!r)return null;const s=$h(r,this._context.elevationProvider,this._context.renderCoordsHelper,i),n=new R_(s,t,this._context.layer.uid,e.uid),a=n.renderData.position.length/3;if(this._needsUV&&(n.uvMapSpace=(0,J.oe)(4*a,!0),n.boundingRect=(0,Q.jh)(9*a,!0),Nm(n.uvMapSpace,n.boundingRect,n.renderData.position,this._context.renderCoordsHelper)),n.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(n),this._createAs3DShapeFill(e,n),this._materials[A_.Outline]&&this._createAs3DShapeOutline(n),this._logGeometryCreationWarnings(n.renderData,r.rings,"rings","FillSymbol3DLayer"),0===n.outGeometries.length)return null;const o=new On({geometries:n.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:e.uid}),l=new an(this,o,n.outGeometries,null,null,b_,i);return l.alignedSampledElevation=n.renderData.sampledElevation,l.needsElevationUpdates=Vt(i.mode),l}_createAs3DShapeFill(e,t){const i=t.renderData.polygons;for(const{position:r,mapPositions:s,holeIndices:n,index:a,count:o}of i){if(null!=this._context.clippingExtent&&((0,q.Ie)(C_),(0,q.Hq)(C_,s),!(0,q.KG)(C_,this._context.clippingExtent)))continue;const i=(0,Fa.v7)(s,n,this._context.elevationProvider.spatialReference);if(0===i.length)continue;const l=this._fastUpdates?.visualVariables.color,c=(0,Fa.a4)({material:this._materials[A_.Fill],indices:i,mapPositions:s,attributeData:{position:r,color:l?null:t.color,colorFeature:l?(0,_n.ul)(l.field,e):null,uvMapSpace:this._needsUV?(0,J.AK)(t.uvMapSpace,4*a,4*o):null,boundingRect:this._needsUV?(0,Q.l5)(t.boundingRect,9*a,9*o):null,objectAndLayerIdColor:t.objectAndLayerIdColor}});t.outGeometries.push(c)}}_createAs3DShapeOutline(e){if(null==this._materials[A_.Outline])return;const t=e.renderData.outlines;for(const{mapPositions:i,position:r}of t){if(null!=this._context.clippingExtent&&((0,q.Ie)(C_),(0,q.Hq)(C_,i),!(0,q.KG)(C_,this._context.clippingExtent)))continue;const t=Yu(this._materials[A_.Outline],{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:i,attributeData:{position:r}},e.objectAndLayerIdColor);e.outGeometries.push(t)}}_createAsOverlay(e,t){const i=(0,Fa.dE)(e.geometry);if(null==i)return null;this._materials[A_.Fill].renderPriority=this._renderPriority+this._renderPriorityStep/2,null!=this._materials[A_.Outline]&&(this._materials[A_.Outline].renderPriority=this._renderPriority);const r=Qh(i,this._context.overlaySR),s=new E_(r,t,this._context.layer.uid,e.uid),n=s.renderData.position.length/3;return this._needsUV&&(s.uvMapSpace=(0,J.oe)(4*n,!0),function(e,t,i,r,s=1){if(i.isGeographic&&r===oe.RT.Global){const e=(0,Q.jh)(t.length),r=t.length,s=(0,wt.tO)(i);for(let i=0;i<r;i+=3)(0,N.RC)(t,i,e,i,s);t=e}(0,xa.hZ)(jm,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let e=0;e<t.length;e+=3)jm[0]=Math.min(jm[0],t[e]),jm[1]=Math.min(jm[1],t[e+1]);const n=jm[0]%s,a=jm[1]%s,o=jm[0]-n,l=jm[1]-a;for(let i=0;i<t.length;i+=3){const r=i/3*4;e[r]=(t[i]-o)/s,e[r+1]=(t[i+1]-l)/s,e[r+2]=o/s,e[r+3]=l/s}}(s.uvMapSpace,s.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),s.outBoundingBox=(0,q.Ie)(),s.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(s),this._createAsOverlayFill(e,s),this._materials[A_.Outline]&&this._createAsOverlayOutline(s),this._logGeometryCreationWarnings(s.renderData,i.rings,"rings","FillSymbol3DLayer"),0===s.outGeometries.length?null:new Ld(this,s.outGeometries,s.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(e,t){const i=t.renderData.polygons;for(const{position:r,holeIndices:s,index:n,count:a}of i){const i=(0,q.Ie)(C_);if((0,q.Hq)(i,r),!(0,q.KG)(i,this._context.clippingExtent))continue;const o=(0,Aa.e)(r,s,3);if(0===o.length)continue;(0,q.RF)(t.outBoundingBox,i);const l=this._fastUpdates?.visualVariables.color,c=(0,Fa.a4)({material:this._materials[A_.Fill],indices:o,attributeData:{position:r,color:l?null:t.color,colorFeature:l?(0,_n.ul)(l.field,e):null,uvMapSpace:this._needsUV?(0,J.AK)(t.uvMapSpace,4*n,4*a):null,objectAndLayerIdColor:t.objectAndLayerIdColor}});t.outGeometries.push(new su(c,t))}}_createAsOverlayOutline(e){if(null==this._materials[A_.Outline])return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:r}=t[i];if((0,q.Ie)(C_),(0,q.Hq)(C_,r),!(0,q.KG)(C_,this._context.clippingExtent))continue;(0,q.RF)(e.outBoundingBox,C_);const s=Yu(this._materials[A_.Outline],{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:r}},e.objectAndLayerIdColor);e.outGeometries.push(new su(s,e))}}_getOutlineOpacity(){const e=this.symbolLayer?.outline?.color;return(this.draped?1:this._getLayerOpacity())*(null!=e?e.a:0)}_getOutlineColor(){const e=this.symbolLayer?.outline?.color,t=this._getOutlineOpacity();return Xs(null!=e?y.A.toUnitRGB(e):null,t)}test(){return{...super.test(),createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}}}w_.elevationModeChangeTypes={definedChanged:Mt.RECREATE,staysOnTheGround:Mt.NONE,onTheGroundChanged:Mt.RECREATE};const C_=(0,q.vt)();class R_ extends Fa.JQ{constructor(e,t,i,r){super(e,i,r),this.color=t}}class E_ extends Fa.JQ{constructor(e,t,i,r){super(e,i,r),this.color=t}}var A_;!function(e){e[e.Fill=0]="Fill",e[e.Outline=1]="Outline"}(A_||(A_={}));class T_{constructor(e,t="center",i=!1,r=(0,dr.vt)(),s=(0,F.fA)(0,0,0,-1),n="world",a=(0,I.vt)(),o=0){this.verticalOffset=e,this.anchor=t,this.hasLabelVerticalOffset=i,this.screenOffset=r,this.centerOffset=s,this.centerOffsetUnits=n,this.translation=a,this.elevationOffset=o}}class O_{constructor(e,t="center",i="center",r=null,s=(0,dr.vt)()){this.placement=e,this.horizontalPlacement=t,this.verticalPlacement=i,this.text=r,this.displaySize=s}}var P_=i(47111);class M_{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=this._colorToRGBA(e.color),this.haloStyle=this._colorToRGB(e.halo.color),this.backgroundStyle=0!==e.background.color[3]?this._colorToRGBA(e.background.color):null}fontString(e){const t=this.definition.font;return`${t.style} ${t.weight} ${e}px ${t.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(e,t){e.font=this.fontString(t),e.textAlign="left",e.textBaseline="alphabetic"}_colorToRGB(e){return`rgb(${e.slice(0,3).map((e=>Math.floor(255*e))).toString()})`}_colorToRGBA(e){return`rgba(${e.slice(0,3).map((e=>Math.floor(255*e))).toString()},${e[3]})`}static async fromSymbol(e,t){const i=e?.material?.color,r=y.A.toUnitRGBA(i)??F.uY,s=null!=e.size?(0,Ms.Lz)(e.size):12,n=e.lineHeight,o=null!=e.background?y.A.toUnitRGBA(e.background.color):F.uY,l={family:e.font?.family??"sans-serif",decoration:e.font?.decoration??"none",weight:e.font?.weight??"normal",style:e.font?.style??"normal"},c=e.halo,h=null!=c?.color&&c.size>0?{size:(0,Ms.Lz)(c.size),color:y.A.toUnitRGBA(c.color)}:{size:0,color:F.uY},d=new M_({color:r,size:s,background:{color:o,padding:null!=e.background?[.65*s,.5*s]:[0,0],borderRadius:null!=e.background?s*(6/16):0},lineSpacingFactor:n,font:l,halo:h,pixelRatio:t});if(e.font){let t=!1;const i=d.fontString(s);try{t=(await document.fonts.load(i)).some((e=>!(0,P_.NZ)(e)))}catch(e){a.A.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${i}'. Some text symbology may be rendered using the default browser font.`)}if(!t&&!I_.has(e.font.family))try{await(0,P_.Al)(e.font)}catch(e){}}return d}}const I_=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]);var D_=i(50521);const F_=4096;let L_=class extends n.A{constructor(e){super(e),this.type=mr.X.Texture,this.id=(0,Gi.c)(),this.events=new xs.A,this._glTexture=null,this._atlas=new z_(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._stageObjects=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view._stage,this._stage.add(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=(0,ce.WD)(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get glTexture(){return this._glTexture}static get maxSize(){return H_=0,[F_-V_-H_,F_-V_-H_-G_]}load(e){if(this._glTexture)return this._glTexture;const t=new jh.R;return t.wrapMode=_t.pF.CLAMP_TO_EDGE,t.samplingMode=_t.Cj.LINEAR_MIPMAP_LINEAR,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=e.parameters.maxMaxAnisotropy,this._glTexture=new wl.g(e,t,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(Ee.W6.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=(0,ce.xt)(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=(0,ce.WD)(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(e){this._canvas.setAttribute("width",e.width.toString()),this._canvas.setAttribute("height",e.height.toString())}_resizeAtlas(e,t){const{width:i,height:r}=this._atlas;i===e&&r===t||(this._atlas.width=e,this._atlas.height=t,this._glTexture?.resize(e,t),this._glTexture?.updateData(0,0,0,i,r,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach((e=>{const t=this._stageObjects.get(e.textRenderer.key);t?.forEach((t=>N_(t,e)))})),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(e,t,i,r){const s=this._atlas;if(s.width<i||s.height<r)return!1;let n=s.cursors.get(r);if(!n){if(s.height<s.nextY+r)return!1;n=[new B_(s.nextY)],s.cursors.set(r,n),s.nextY+=r}let a=n.find((e=>s.width>=e.x+i));if(null==a){if(s.height<s.nextY+r)return!1;a=new B_(s.nextY),s.nextY+=r,n.push(a)}return e.setNewPosition(a),this._elements.set(t,e),this._elementsToRender.set(t,e),a.x+=i,!0}_ensureStageObjects(e){const t=this._stageObjects.get(e);if(t)return t;const i=new Set;return this._stageObjects.set(e,i),i}_addStageObject(e,t){this._ensureStageObjects(e).add(t)}_removeStageObject(e,t){const i=this._stageObjects.get(e);i?.delete(t)&&(t.geometries[0].setAttributeData(It.r.SIZE,[0,0]),t.geometryVertexAttributeUpdated(t.geometries[0],It.r.SIZE),this._elementsToRender.delete(e))}_processAddition(e){const t=e.textRenderer.key;if(this._needsRepack)return void this._elements.set(t,e);const i=this._atlas,r=e.textRenderer.renderedWidth,s=e.textRenderer.renderedHeight,n=r+V_,a=s+V_+G_;if(!this._addAtlasElement(e,t,n,a)){if(this._canRepack)this._reset();else if(i.width<n){const e=Math.min((0,me.Mv)(Math.max(n,1.5*i.width)),F_);this._resizeAtlas(e,i.height)}else{const e=i.nextY+a,t=Math.min((0,me.Mv)(Math.max(e,1.5*i.height)),F_);if(t>i.height)this._resizeAtlas(i.width,t);else if(i.width<F_){const e=Math.min((0,me.Mv)(1.5*i.width),F_);this._resizeAtlas(e,i.height)}}this._elements.set(t,e)}}_renderElement(e){const t=e.commitNewPosition(),i=e.textRenderer;this._ctx.clearRect(t[0]-V_,t[1]-V_,i.renderedWidth+2*V_,i.renderedHeight+2*V_),i.render(this._ctx,t[0],t[1]);const r=this._stageObjects.get(i.key);r?.forEach((t=>N_(t,e)))}get running(){return this.updating}runTask(e){if(null==this._glTexture)return D_.G;for(;this._needsRepack&&(this._canRepack||this._atlas.height<F_&&this._atlas.height<F_);){this._canRepack=this._needsRepack=!1;const t=this._elements;this._elements=new Map,t.forEach((e=>this._processAddition(e))),e.madeProgress()}if(this._elementsToRender.size>0){for(const[t,i]of this._elementsToRender){if(e.done)break;this._renderElement(i),this._elementsToRender.delete(t),e.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addTextTexture(e,t){const i=e.key;this._addStageObject(i,t);let r=this._elements.get(i);null==r&&(r=new U_(this._atlas,e),this._processAddition(r),this.setDirty()),function(e,t){e.geometries[0].setAttributeData(It.r.SIZE,[t.textRenderer.displayWidth,t.textRenderer.displayHeight]),e.geometryVertexAttributeUpdated(e.geometries[0],It.r.SIZE)}(t,r),N_(t,r)}removeTextTexture(e,t){const i=e.key;if(!this._elements.get(i))return;this._removeStageObject(i,t);const r=this._stageObjects.get(i);r&&0!==r.size||this._elements.delete(i),0===r?.size&&this._stageObjects.delete(i),this._canRepack=!0}setDirty(){this._glTexture&&(this.updating=!0)}get test(){const{_elements:e,_stageObjects:t,_atlas:i}=this,r=this;return{elements:e,stageObjects:t,atlas:i,resizeAtlas:(e,t)=>r._resizeAtlas(e,t),run:e=>r.runTask(e)}}};function N_(e,t){e.geometries[0].setAttributeData(It.r.UV0,t.uv),e.geometryVertexAttributeUpdated(e.geometries[0],It.r.UV0,!0)}(0,r._)([(0,h.MZ)({constructOnly:!0})],L_.prototype,"view",void 0),(0,r._)([(0,h.MZ)({type:Boolean})],L_.prototype,"updating",void 0),L_=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],L_);const V_=2,G_=2;class U_{constructor(e,t){this._atlas=e,this.textRenderer=t,this._uv=(0,F.vt)(),this._newPosition=[0,0]}get uv(){if(null==this._xOffset||null==this._yOffset)return F.uY;const{renderedWidth:e,renderedHeight:t}=this.textRenderer;return(0,D.s)(this._uv,this._xOffset/this._atlas.width,(this._yOffset+t)/this._atlas.height,(this._xOffset+e)/this._atlas.width,this._yOffset/this._atlas.height)}setNewPosition(e){this._newPosition[0]=e.x,this._newPosition[1]=e.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class z_{constructor(e,t){this.width=e,this.height=t,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=H_}}class B_{constructor(e){this.y=e,this.x=H_}}let H_=0;class j_{constructor(e,t,i){this._renderer=new kd(e,t,i,L_.maxSize)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const e=Ud(W_,this._renderer.renderedWidth,this._renderer.renderedHeight),t=e.getContext("2d");return t.save(),this._renderer.render(t,0,0),t.restore(),new mt.g(e,{wrap:{s:_t.pF.CLAMP_TO_EDGE,t:_t.pF.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0})}}const W_={canvas:null},k_=(0,I.fA)(0,0,1);function Z_(e,t,i){e&&e.forEach((e=>{const r=t(e);null!=r&&i(r,e.graphic)}))}const q_={mode:"relative-to-ground",offset:0};var $_=i(10558),Q_=(i(63149),i(9684));class J_ extends Jn.w{initializeConfiguration(e,t){t.spherical=e.viewingMode===oe.RT.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Xn.B(e.rctx,J_.shader.get().build(this.configuration),Yn.D)}_setPipelineState(e){const t=this.configuration,i=e===Mo.y.NONE,r=e===Mo.y.FrontFace;return(0,ea.Ey)({blending:t.output!==Wn.V.Normal&&t.output!==Wn.V.Highlight&&t.output!==Wn.V.ObjectAndLayerIdColor&&t.transparent?i?Oo.V0:(0,Oo.ez)(e):null,depthTest:t.draped?null:{func:(0,Oo.K_)(e)},depthWrite:t.draped?null:i?t.writeDepth?ea.kn:null:(0,Oo.XO)(e),colorWrite:ea.wE,polygonOffset:i||r?null:(0,Oo.aB)(t.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}J_.shader=new Qn.$(Q_.W,(()=>i.e(4212).then(i.bind(i,64212))));class Y_ extends ra.E{constructor(){super(...arguments),this.output=Wn.V.Color,this.transparencyPassType=Mo.y.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.objectAndLayerIdColorInstanced=!1,this.draped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}}(0,r._)([(0,ia.W)({count:Wn.V.COUNT})],Y_.prototype,"output",void 0),(0,r._)([(0,ia.W)({count:Mo.y.COUNT})],Y_.prototype,"transparencyPassType",void 0),(0,r._)([(0,ia.W)()],Y_.prototype,"spherical",void 0),(0,r._)([(0,ia.W)()],Y_.prototype,"receiveShadows",void 0),(0,r._)([(0,ia.W)()],Y_.prototype,"hasSlicePlane",void 0),(0,r._)([(0,ia.W)()],Y_.prototype,"transparent",void 0),(0,r._)([(0,ia.W)()],Y_.prototype,"enableOffset",void 0),(0,r._)([(0,ia.W)()],Y_.prototype,"writeDepth",void 0),(0,r._)([(0,ia.W)()],Y_.prototype,"hasScreenSpaceReflections",void 0),(0,r._)([(0,ia.W)()],Y_.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,r._)([(0,ia.W)()],Y_.prototype,"hasCloudsReflections",void 0),(0,r._)([(0,ia.W)()],Y_.prototype,"objectAndLayerIdColorInstanced",void 0),(0,r._)([(0,ia.W)()],Y_.prototype,"draped",void 0),(0,r._)([(0,ia.W)()],Y_.prototype,"multipassEnabled",void 0),(0,r._)([(0,ia.W)()],Y_.prototype,"cullAboveGround",void 0),(0,r._)([(0,ia.W)({constValue:!1})],Y_.prototype,"occlusionPass",void 0),(0,r._)([(0,ia.W)({constValue:Ja.A9.Water})],Y_.prototype,"pbrMode",void 0),(0,r._)([(0,ia.W)({constValue:!0})],Y_.prototype,"useCustomDTRExponentForWater",void 0),(0,r._)([(0,ia.W)({constValue:!0})],Y_.prototype,"highStepCount",void 0),(0,r._)([(0,ia.W)({constValue:!1})],Y_.prototype,"useFillLights",void 0);class X_ extends kn.A{_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}_updateSSRState(e){const t=null!=e.ssr.lastFrameColor;t!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:t})}_updateCloudsReflectionState(e){const t=null!=e.cloudsFade.data;t!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:t})}ensureResources(e){return this._techniqueRepository.constructionContext.waterTextureRepository.ensureResources(e)}beginSlot(e){return this._output===Wn.V.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this._material.setParameters(this._techniqueRepository.constructionContext.waterTextureRepository.passParameters),this.ensureTechnique(J_,e)}}class K_ extends e_{constructor(e){super(e,new ey),this._configuration=new Y_,this._animation=new $_.a,this.produces=new Map([[qn.N.OPAQUE_MATERIAL,e=>(0,Wn.j8)(e)&&!this.parameters.transparent||(0,Wn.u5)(e)],[qn.N.TRANSPARENT_MATERIAL,e=>(0,Wn.j8)(e)&&this.parameters.transparent||(0,Wn.u5)(e)],[qn.N.DRAPED_MATERIAL,e=>this.parameters.draped&&e===Wn.V.Color||(0,Wn.u5)(e)],[qn.N.DRAPED_WATER,e=>e===Wn.V.Normal]])}getConfiguration(e,t){return this._configuration.output=e,this._configuration.writeDepth=!0,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Oo.xt,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);this._animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<ty;const i=this._animation.advance(e);return this.setParameters({timeElapsed:(0,dl.y)(this._animation.time)*this.parameters.animationSpeed},!1),this._animation.enabled&&i}createGLMaterial(e){return new X_(e)}createBufferWriter(){return new Up.Z((0,d.A)("enable-feature:objectAndLayerId-rendering")?jp:Bp)}get test(){return{animationEnabled:this._animation.enabled}}}class ey extends Zn.qA{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=(0,dr.fA)(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=(0,F.fA)(0,0,0,0),this.transparent=!0,this.hasSlicePlane=!1,this.draped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.origin=(0,I.vt)(),this.modelTransformation=null}}const ty=35e3,iy={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},ry=["polyline","polygon","extent"];class sy extends vn{constructor(e,t,i,r){super(e,t,i,r)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,ry,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,i,t.uid)}ensureMaterial(){if(this._materials[0])return;const e=new ey,t=this.symbolLayer.color;null!=t&&(e.color=y.A.toUnitRGBA(t));const i=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],i],e.transparent=i<1||this.needsDrivenTransparentPass,e.waveDirection=null!=this.symbolLayer.waveDirection?sy.headingVectorFromAngle(this.symbolLayer.waveDirection):(0,dr.fA)(0,0);const r=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,s=iy[r];e.waveStrength=s.waveStrength,e.waveTextureRepeat=s.textureRepeat,e.waveVelocity=s.waveVelocity,e.flowStrength=s.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.draped=this.draped,this._materials[0]=new K_(e),this._context.stage.add(this._materials[0])}layerOpacityChanged(){if(null==this._materials[0])return;const e=this._materials[0].parameters.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),i=t<1||this.needsDrivenTransparentPass;this._materials[0].setParameters({color:[e[0],e[1],e[2],t],transparent:i})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=Nt(sy.elevationModeChangeTypes,i,r);if(s!==Mt.UPDATE)return s;const n=Vt(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,i){const r=(0,Fa.dE)(e.geometry);if(null==r)return null;const s=$h(r,this._context.elevationProvider,this._context.renderCoordsHelper,t),n=s.position.length/3,a=(0,Q.jh)(2*n);this._createUVCoordsFromVertices(a,s.mapPositions,n,this._context.elevationProvider.spatialReference);const o=new cy(s,a,this._context.layer.uid,e.uid);if(o.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(o),this._create3DShapeGeometries(o),this._logGeometryCreationWarnings(o.renderData,r.rings,"rings","WaterSymbol3DLayer"),0===o.outGeometries.length)return null;const l=new On({geometries:o.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:i}),c=new an(this,l,o.outGeometries,null,null,Fs,t);return c.alignedSampledElevation=o.renderData.sampledElevation,c.needsElevationUpdates=Vt(t.mode),c}_createUVCoordsFromVertices(e,t,i,r){const s=(0,E.GA)(r);(0,$.Ie)(ay);for(let e=0;e<i;e++)(0,xa.hZ)(oy,t[3*e],t[3*e+1]),(0,$.tK)(ay,oy);(0,D.d)(ay,ay,s);const n=ay[0]%sy.unitSizeOfTexture,a=ay[1]%sy.unitSizeOfTexture;ny[0]=ay[0]-n,ny[1]=ay[1]-a;for(let r=0;r<i;r++)e[2*r]=(t[3*r]*s-ny[0])/sy.unitSizeOfTexture,e[2*r+1]=(t[3*r+1]*s-ny[1])/sy.unitSizeOfTexture}_create3DShapeGeometries(e){const t=e.renderData.polygons,i=e.uvCoords;for(const{count:r,index:s,position:n,mapPositions:a,holeIndices:o}of t){if(null!=this._context.clippingExtent&&((0,q.Ie)(ly),(0,q.Hq)(ly,a),!(0,q.KG)(ly,this._context.clippingExtent)))continue;const t=(0,Aa.e)(a,o,3);if(0===t.length)continue;const l=(0,Q.l5)(i,2*s,2*r),c=(0,Fa.SY)({material:this._materials[0],indices:t,mapPositions:a,attributeData:{position:n,uv0:l}},e.objectAndLayerIdColor);e.outGeometries.push(c)}}_createAsOverlay(e){const t=(0,Fa.dE)(e.geometry);if(null==t)return null;this._materials[0].renderPriority=this._renderPriority;const i=Qh(t,this._context.overlaySR),r=i.position.length/3,s=(0,Q.jh)(2*r);this._createUVCoordsFromVertices(s,i.position,r,this._context.overlaySR);const n=new hy(i,s,this._context.layer.uid,e.uid);return n.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(n),n.outBoundingBox=(0,q.Ie)(),this._createAsOverlayWater(n),this._logGeometryCreationWarnings(n.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===n.outGeometries.length?null:new Ld(this,n.outGeometries,n.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(e){const t=e.uvCoords,i=e.renderData.polygons;for(const{position:r,holeIndices:s,index:n,count:a}of i){if((0,q.Ie)(ly),(0,q.Hq)(ly,r),!(0,q.KG)(ly,this._context.clippingExtent))continue;(0,q.RF)(e.outBoundingBox,ly);const i=(0,Aa.e)(r,s,3);if(0===i.length)continue;const o=(0,Q.l5)(t,2*n,2*a),l=(0,Fa.SY)({material:this._materials[0],indices:i,attributeData:{position:r,uv0:o}},e.objectAndLayerIdColor);e.outGeometries.push(new su(l,e))}}static headingVectorFromAngle(e){const t=(0,dr.vt)(),i=(0,Kg.DF)(e);return t[0]=Math.sin(i),t[1]=Math.cos(i),t}test(){return{...super.test(),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}sy.unitSizeOfTexture=100,sy.elevationModeChangeTypes={definedChanged:Mt.RECREATE,staysOnTheGround:Mt.NONE,onTheGroundChanged:Mt.RECREATE};const ny=(0,dr.vt)(),ay=(0,$.vt)(),oy=(0,dr.vt)(),ly=(0,q.vt)();class cy extends Fa.JQ{constructor(e,t,i,r){super(e,i,r),this.uvCoords=t}}class hy extends Fa.JQ{constructor(e,t,i,r){super(e,i,r),this.uvCoords=t}}function dy(e,t,i,r){const s=py[e.type]?.[t.type]||uy[t.type];return s?new s(e,t,i,r):(a.A.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory").error("GraphicsLayerFactory#make",`unknown symbol type ${t.type}`),null)}const uy={icon:Wu,object:class extends vn{getCachedSize(){const[e,t,i]=null!=this._resources?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:i}}constructor(e,t,i,r){super(e,t,i,r),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.skipHighSymbolLodsChanged=!1,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=i.physicalBasedRenderingEnabled}async doLoad(e){if(!this._drivenProperties.size&&en(this.symbolLayer))throw new Error;if(this._isPrimitive){const t=this.symbolLayer.resource,i=t&&function(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}(t.primitive)?t.primitive:lr.r;this._resources=await this._createResourcesForPrimitive(i,e)}else{const t=await async function(e){if(null===e||null==e.styleName&&null==e.styleUrl)return null;const t=e.name;if(null==t)throw new le.A("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference");const i={portal:e.portal},r=await(0,Vf.cF)(e,i).catch((()=>null));if(null===r)return null;const s=(0,Gf.p)(t,r.data);if(s&&!s.formatInfos?.some((e=>"gltf_basisu"===e.type)))return null;const n=await(0,Gf.I)(r,t,i,"webRef",((e,t)=>(0,Vf.o5)(e,t,["gltf_basisu","gltf"]))).catch((()=>null));if(null===n||"point-3d"!==n.type)return null;const a=n.symbolLayers.items[0];return"object"===a.type?a.resource:null}(this.symbol.styleOrigin),i=t?.href??this.symbolLayer.resource.href;this._resources=await this._createResourcesForUrl(i,e)}this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return null!=this._resources?this._resources.extentPadding:0}get _isPrimitive(){return!this.symbolLayer.resource?.href}get lodRenderer(){return this._resources?.lodRenderer}get materials(){return this._resources?.stageResources.materials??[]}_setMaterialTransparencyParameters(e,t=this.symbolLayer?.material?.color){const i=this._getCombinedOpacity(t),r=i<1||this.needsDrivenTransparentPass;return e.transparent=r,e.opacity=i,e.cullFace=r?ge.s2.None:ge.s2.Back,e}async _createResourcesForPrimitive(e,t){const i=this.symbolLayer,r=(0,q.vt)((0,Tf.Fq)(e)),s=(0,I.ci)((0,q.Ej)(r)),n=(0,I.ci)((0,Tf.Bb)(s,i)),a=(0,M.l)(n),o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:[..._e.mX],ambient:I.Un,diffuse:I.Un,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},l=!!o.usePBR;this._setMaterialTransparencyParameters(o);const c=this.symbol;if("point-3d"===c.type&&c.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=c.verticalOffset;o.verticalOffset={screenLength:(0,Ms.Lz)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},o.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(o.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)o.externalColor=F.Un;else{const e=null!=i.material?i.material.color:null,t=null!=e?y.A.toUnitRGBA(e):F.Un;o.externalColor=t}this._fastUpdates=(0,_n.s_)(this._context.renderer,this._fastVisualVariableConvertOptions(r,n,s,null)),o.isInstanced=!0,this._fastUpdates?(Object.assign(o,this._fastUpdates.materialParameters),this._optionalFields.push(It.r.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(o.hasInstancedColor=!0,this._optionalFields.push(It.r.COLOR)),(0,d.A)("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(It.r.OBJECTANDLAYERIDCOLOR);const h=Kr(e,new os.$U(o));if(!h)throw new Error(`Unknown object symbol primitive: ${e}`);const u=Jr(h).map((e=>({opacity:1,transparent:e.parameters.transparent}))),p=await this._createStageResources(h,l,t),f=await this._createLodRenderer(h,t);return new ug(h,f,p,u,s,!1,!1,r,n,a,l,null)}async _createResourcesForUrl(e,t){const i={materialParameters:{isInstanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=(0,_n.s_)(this._context.renderer,this._fastVisualVariableConvertOptions(null,null,null,null)),this._fastUpdates?(Object.assign(i.materialParameters,this._fastUpdates.materialParameters),this._optionalFields.push(It.r.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(i.materialParameters.hasInstancedColor=!0,this._optionalFields.push(It.r.COLOR)),(0,d.A)("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(It.r.OBJECTANDLAYERIDCOLOR);const r=this.symbol;if("point-3d"===r.type&&r.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=r.verticalOffset;i.materialParameters.verticalOffset={screenLength:(0,Ms.Lz)(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},i.materialParameters.castShadows=!1}const s=this._context.physicalBasedRenderingEnabled;i.signal=t,i.usePBR=s,i.skipHighLods=this._context.skipHighSymbolLods;const n=await(0,Nf.fetch)(e,i),a=n.isEsriSymbolResource,o=n.isWosr,l=function(e){return new Qr(e.map(((e,t)=>function(e,t){const i=e.stageResources.geometries.map((t=>new qr(t,e.stageResources.textures))),r=null==e.lodThreshold||0===e.lodThreshold&&t>0?function(e){const t=e.reduce(((e,{geometry:t})=>e+t.indexCount/3),0);return Math.sqrt(t*Lf/Math.PI)}(i):e.lodThreshold;return new $r(i,r,e.pivotOffset)}(e,t))))}(n.lods),c=this._context,h=this.symbolLayer.material,u=this._getExternalColorParameters(h),p=this.symbolLayer?.material?.color,f=this._getCombinedOpacity(p,{hasIntrinsicColor:!0}),g=this.needsDrivenTransparentPass,m=Jr(l),_=Jr(l).map((e=>({opacity:e.parameters.opacity||1,transparent:e.parameters.transparent})));m.forEach((e=>{const t=e.parameters;e.setParameters(u);const i=t.opacity*f,r=i<1||g||t.transparent;e.setParameters({opacity:i,transparent:r}),c.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:c.sharedResources.screenSizePerspectiveSettings})}));const y=n.referenceBoundingBox,v=(0,I.ci)((0,q.Ej)(y)),b=(0,I.ci)(l.levels[0].pivotOffset),x=(0,I.ci)((0,Tf.Bb)(v,this.symbolLayer)),S=(0,M.l)(x),w=this._fastUpdates;(0,_n.J_)(w,this._context.renderer,this._fastVisualVariableConvertOptions(y,x,v,b))&&m.forEach((e=>e.setParameters(w.materialParameters)));const C=await this._createStageResources(l,s,t),R=await this._createLodRenderer(l,t);return new ug(l,R,C,_,v,a,o,y,x,S,s,b)}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createStageResources(e,t,i){const r=this._context.stage,s=Jr(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),r.addMany(s),this._addDisposeResource((()=>r.removeMany(s)));const n=Yr(e);r.addMany(n),this._addDisposeResource((()=>{n.forEach((e=>e.unload())),r.removeMany(n)})),await Promise.all(n.map((e=>this._context.stage.schedule((()=>e.load(r.renderView.renderingContext)),i)))),(0,o.Te)(i);const a=Xr(e);return r.addMany(a),this._addDisposeResource((()=>r.removeMany(a))),{materials:s,textures:n,geometries:a}}async _createLodRenderer(e,t){const i=this._context.stage,r={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},s=this._fastUpdates,n=s?{applyTransform:(e,t,i)=>{e.getFeatureAttribute(t,mg),(0,O.C)(i,(0,_n.b3)(s.materialParameters,mg,i))},scaleFactor:(e,t,i)=>{t.getFeatureAttribute(i,mg),(0,_n.VC)(e,s.materialParameters,mg)}}:null,a=new rg({symbol:e,optionalFields:this._optionalFields,metadata:r,shaderTransformation:n},this._context.scheduler);return a.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource((()=>{i.removeRenderPlugin(a),a.destroy()})),await i.addRenderPlugin(a,t),a}_getExternalColorParameters(e){const t={};return this._drivenProperties.color?t.externalColor=F.Un:null!=e?.color?t.externalColor=y.A.toUnitRGBA(e.color):(t.externalColor=F.Un,t.colorMixMode="ignore"),t}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach((e=>e())),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const i=zn(t.geometry);if(null==i)return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const r=this.setGraphicElevationContext(t),s=e.renderingInfo;return this._createAs3DShape(t,i,s,r,t.uid,e.layer.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(null==this._resources)return;const e=this._drivenProperties.opacity,t=!this._isPrimitive,i=this._resources.stageResources.materials,r=this._resources.originalMaterialParameters;for(let s=0;s<i.length;s++){const n=i[s],a=this.symbolLayer?.material?.color,o=r[s],l=this._getCombinedOpacity(a,{hasIntrinsicColor:t})*o.opacity,c=l<1||e||o.transparent;n.setParameters({opacity:l,transparent:c}),this._isPrimitive&&n.setParameters({cullFace:c?ge.s2.None:ge.s2.Back})}}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Gt)}slicePlaneEnabledChanged(){if(null==this._resources)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(null==this._resources)return!0;const{stageResources:e,isWosr:t}=this._resources;for(const i of e.materials)this._isPrimitive?i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this._hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this._hasLoadedPBRTextures=!0,!1)}applyRendererDiff(e,t){if(null==this._resources)return pn.RecreateSymbol;const{stageResources:{materials:i},lodRenderer:r,resourceBoundingBox:s,symbolSize:n,resourceSize:a,pivotOffset:o}=this._resources;for(const l in e.diff){if("visualVariables"!==l)return pn.RecreateSymbol;if(!(0,_n.J_)(this._fastUpdates,t,this._fastVisualVariableConvertOptions(s,n,a,o)))return pn.RecreateSymbol;for(const e of i)e.setParameters(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged()}return pn.FastUpdate}computeComplexity(){if(null==this._resources)return super.computeComplexity();const e=this._resources.lodResources,t=fs(e.levels),i=Xr(e).reduce(((e,t)=>e+(e=>Array.from(e.attributes.values()).reduce(((e,t)=>e+(0,R.Ek)(t.data,t.indices)),0))(t)),0),r=Yr(e).reduce(((e,t)=>e+t.memoryEstimate),0)+i,s={...us(this.symbol,this.symbolLayer),resourceBytes:r};return new ts({verticesPerFeature:t,memory:s})}_hasLodRenderer(){return null!=this._resources}_createAs3DShape(e,t,i,r,s,n){if(!this._hasLodRenderer()||null==this._resources)return null;const a=this.getFastUpdateAttrValues(e),o=this._context.clippingExtent;if((0,Cn.g)(t,pg,this._context.elevationProvider.spatialReference),null!=o&&!(0,q.Uc)(o,pg))return null;const l=this._requiresTerrainElevation(r),c=this._computeGlobalTransform(t,r,gg,_g),h=this._computeLocalTransform(this._resources,this.symbolLayer,i,fg),d=this._resources.lodRenderer.instanceData,u=d.addInstance();this._instanceIndexToGraphicUid.set(u,s),d.setLocalTransform(u,h,!1),d.setGlobalTransform(u,c),a&&d.setFeatureAttribute(u,a),null==this._fastUpdates&&this._hasPerInstanceColor()&&d.setColor(u,Xs(i.color,i.opacity,255)),null!=this._context.stage.renderView.objectAndLayerIdRenderHelper&&d.setObjectAndLayerIdColor(u,this._context.stage.renderView.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:s,layerUid:n}));const p=new Of(this,u,Vs,r);return l&&(p.alignedSampledElevation=_g.sampledElevation),p.needsElevationUpdates=Gt(r.mode),Un(p,t,this._context.elevationProvider),p}_computeGlobalTransform(e,t,i,r){return Ft(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r),pg[0]=e.x,pg[1]=e.y,pg[2]=r.z,(0,Et.l)(e.spatialReference,pg,i,this._context.renderCoordsHelper.spatialReference),i}_computeLocalTransform(e,t,i,r){return(0,O.D_)(r),this._applyObjectRotation(i,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,i,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,i){if(this._fastUpdates?.requiresShaderTransformation)return;const r=Ks(this._drivenProperties.size&&t.size?t.size:e.symbolSize,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===r[0]&&1===r[1]&&1===r[2]||(0,O.hs)(i,i,r)}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(null==this._resources)return!0;const i=t&&zn(t);if(null==i)return!1;const r=this.getGeometryElevationMode(t);return e.elevationContext.mode===r&&(this._computeGlobalTransform(i,e.elevationContext,gg,_g),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=_g.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,gg,!0),Un(e,i,this._context.elevationProvider),!0)}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(null==this._resources)return;const i=(e,t,i)=>(null!=e&&"complete"===e.type?e.newValue:t)??i,r=i(t.heading,this.symbolLayer.heading,0),s=i(t.tilt,this.symbolLayer.tilt,0),n=i(t.roll,this.symbolLayer.roll,0),a=i(t.width,this.symbolLayer.width,void 0),o=i(t.height,this.symbolLayer.height,void 0),l=i(t.depth,this.symbolLayer.depth,void 0),c=i(t.anchor,this.symbolLayer.anchor,void 0),h=i(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const d={heading:r,tilt:s,roll:n,anchor:c,anchorPosition:h},u=this._resources;this.loadStatus===fn.LOADED&&e.symbolLayerStatePatches.push((()=>{u.symbolSize=(0,I.ci)((0,Tf.Bb)(u.resourceSize,{width:a,height:o,depth:l,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const i=this._computeLocalTransform(u,d,t,fg),r=e.instanceIndex;u.lodRenderer.instanceData.setLocalTransform(r,i,!0)}))}_preparePatchColor(e,t){if(!t.material||"partial"!==t.material.type)return;const i=t.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const r=i.color.newValue,s=null!=r?y.A.toUnitRGBA(r):F.Un;delete i.color;const n=this._resources;null!=n&&e.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(n.lodRenderer.instanceData.setColor(e.instanceIndex,s),t=this._setMaterialTransparencyParameters({},r)):t=this._setMaterialTransparencyParameters({externalColor:s},r);for(const e of n.stageResources.materials)e.setParameters(t)}))}_requiresTerrainElevation(e){return"absolute-height"!==e.mode}_applyObjectRotation(e,t,i){if(!this._fastUpdates?.requiresShaderTransformation||!t)return function(e,t,i,r=(0,P.vt)()){return e&&(0,O.Qr)(r,r,-e/180*Math.PI),t&&(0,O.eL)(r,r,t/180*Math.PI),i&&(0,O.Z8)(r,r,i/180*Math.PI),r}(e.heading,e.tilt,e.roll,i)}_computeAnchor(e,t,i){const r=(0,I.vt)();switch(i.anchor){case"center":(0,M.c)(r,(0,q.gX)(e)),(0,M.E)(r,r);break;case"top":{const t=(0,q.gX)(e);(0,M.s)(r,-t[0],-t[1],-e[5]);break}case"bottom":{const t=(0,q.gX)(e);(0,M.s)(r,-t[0],-t[1],-e[2]);break}case"relative":{const t=(0,q.gX)(e),s=(0,q.Ej)(e),n=i.anchorPosition,a=n?(0,I.fA)(n.x,n.y,n.z):I.uY;(0,M.A)(r,s,a),(0,M.g)(r,r,t),(0,M.E)(r,r);break}default:null!=t?(0,M.E)(r,t):(0,M.c)(r,I.uY)}return r}_applyAnchor(e,t,i){if(this._fastUpdates?.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&(0,O.Tl)(i,i,r)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,t,i,r){const s=null!=e?(0,I.ci)((0,q.Ej)(e)):I.Un,n=null!=e?this._computeAnchor(e,r,this.symbolLayer):I.uY,a=this._context.renderCoordsHelper.unitInMeters,o=Ks(null!=t?t:void 0,t,i,a),l=(0,I.fA)(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new _n.wI({size:!0,color:!0,rotation:!0,opacity:!1},s,t??I.Un,a,n,o,l)}},line:mp,path:class extends vn{constructor(e,t,i,r){super(e,t,i,r),this._intrinsicSize=(0,dr.fA)(1,1),this._upVectorAlignment=Fg.Path,this._stencilWidth=.1,this.usedMemory=0,this.ensureDrapedStatus(!1)}async doLoad(){const e=null!=this.symbolLayer.width?this.symbolLayer.width:this.symbolLayer.height,t=null!=this.symbolLayer.height?this.symbolLayer.height:e;this._vvConvertOptions=new _n.wI({size:!0,color:!0,rotation:!1,opacity:!0},[1,1,1],[e,1,t],this._context.renderCoordsHelper.unitInMeters),this._fastUpdates=this._context.renderer?.visualVariables?.length>0?(0,_n.s_)(this._context.renderer,this._vvConvertOptions):null;const i=this.symbolLayer.anchor||"center";this._upVectorAlignment="heading"===this.symbolLayer.profileRotation?Fg.World:Fg.Path;const r=this.symbolLayer.profile||"circle";switch(r){default:case"circle":this._profile=Jg[i];break;case"quad":this._profile=Yg[i]}switch(this.symbolLayer.join){case"round":this._extruder=new Ag(0,3);break;case"bevel":this._extruder=new Ag(0,1);break;case"miter":this._extruder=new Ag(.8*Math.PI,1);break;default:this._extruder=new Eg}const s=this.symbolLayer.cap||"butt";switch(s){case"none":this._startCap=new xg,this._endCap=new xg;break;case"butt":default:this._startCap=new Sg(this._profile,0),this._endCap=new Sg(this._profile,0,!0);break;case"square":this._startCap=new Sg(this._profile,-.5),this._endCap=new Sg(this._profile,.5,!0);break;case"round":{const e="quad"===r;this._startCap=new wg({profile:this._profile,flip:!1,breakNormals:e,subdivisions:3}),this._endCap=new wg({profile:this._profile,flip:!0,breakNormals:e,subdivisions:3});break}}const n=this.symbolLayer?.material?.color,a=this._getCombinedOpacityAndColor(n),o=(0,I.ci)(a),l=a[3],c=l<1||this.needsDrivenTransparentPass,h={diffuse:o,ambient:o,opacity:l,transparent:c,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:c||"none"===s?ge.s2.None:ge.s2.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&((0,xa.hZ)(this._intrinsicSize,e,t),!tn(this._intrinsicSize[0])||!tn(this._intrinsicSize[1])))throw new le.A("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");if(this._fastUpdates?.visualVariables.size||(0,xa.hs)(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates){const e={...h,...this._fastUpdates.materialParameters,size:(0,dr.ci)(this._intrinsicSize)};this._materials[0]=new Am(e)}else h.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,h.normalType=rd.W.Compressed,this._materials[0]=new os.$U(h);this._materials[0].setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._materials[0])}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials[0]=null,this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Pm,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}layerOpacityChanged(){const e=this.symbolLayer?.material?.color,t=this._getCombinedOpacity(e),i=t<1||this.needsDrivenTransparentPass;this._materials[0]?.setParameters({opacity:t,transparent:i})}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Gt)}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._materials[0]?.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return pn.RecreateSymbol;if(!(0,_n.J_)(this._fastUpdates,t,this._vvConvertOptions))return pn.RecreateSymbol;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return pn.FastUpdate}_getVertexData(e){let t=0;const i=e.paths,r=[],s=e.spatialReference,n=this._context.elevationProvider.spatialReference,a=this._context.renderCoordsHelper.spatialReference;for(const e of i)t+=e.length;const o=(0,Q.jh)(3*t);let l,c=0;for(const t of i){r.push({offset:c,numVertices:t.length});for(const i of t)o[c++]=i[0],o[c++]=i[1],o[c++]=e.hasZ?i[2]:0}return null==n||s.equals(n)||(0,k.projectBuffer)(o,s,0,o,n,0,t)?(null==n||n.equals(a)?l=(0,Q.xm)(o):(l=(0,Q.jh)(3*t),(0,k.projectBuffer)(o,n,0,l,a,0,t)),{pathVertexDataInfos:r,vertexDataES:o,vertexDataRS:l}):null}_createAs3DShape(e,t,i,r){this.usedMemory=0;const s=e.geometry,n=this._getVertexData(s);if(null==n)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(0===n.pathVertexDataInfos.length)return 0!==s.paths.length&&s.paths.some((e=>e.length>0))||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;const a=new Array,o=s.spatialReference,l=(0,q.vt)(),c=this._context.renderCoordsHelper,h=new Tt(n.vertexDataES);for(const s of n.pathVertexDataInfos){const d=s.numVertices;if(d<2)continue;const u=s.offset;if(null!=this._context.clippingExtent&&((0,q.Ie)(l),(0,q.Hq)(l,n.vertexDataES,u,d),!(0,q.KG)(l,this._context.clippingExtent)))continue;const p=new Array,f=u+3*d;for(let e=u;e<f;e+=3){h.offset=e;const t=Lt(h,this._context.elevationProvider,i,c);(0,M.s)(Fm,n.vertexDataRS[e],n.vertexDataRS[e+1],n.vertexDataRS[e+2]),c.setAltitude(Fm,t),n.vertexDataRS[e]=Fm[0],n.vertexDataRS[e+1]=Fm[1],n.vertexDataRS[e+2]=Fm[2],p.push(lm(this._upVectorAlignment))}const g=new yg(p,n.vertexDataES,n.vertexDataRS,u);Mm(g,this._upVectorAlignment,this._context.renderCoordsHelper);const m=new vg(g,this._profile,this._extruder,this._startCap,this._endCap);let _=null;if(this._fastUpdates){const t=this._fastUpdates.visualVariables,i=(0,_n.ul)(t.size?.field,e)??0,r=(0,_n.ul)(t.color?.field,e)??0,s=(0,_n.ul)(t.opacity?.field,e)??0;_=new Gg(m,i,r,s)}else{const e=[this._intrinsicSize[0],this._intrinsicSize[1]];if(this._drivenProperties.size){const i=t.size;e[0]*=Im(i[0],"symbol-value"===i[2]?this.symbolLayer.height||0:i[2],this.symbolLayer.width||0),e[1]*=Im(i[2],"symbol-value"===i[0]?this.symbolLayer.width||0:i[0],this.symbolLayer.height||0)}let i;this._drivenProperties.color&&(i=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(i=i?[i[0],i[1],i[2],t.opacity]:[1,1,1,t.opacity]);const r=new Vg(m);r.bake(e),i&&r.bakeVertexColors(i),_=r}const y=_.createGeometryData(),v=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerUid:this._context.layer.uid}),b=new Dg(this._materials[0],y,_,o,this._stencilWidth,v);b.transformation=(0,O.Tl)((0,P.vt)(),P.zK,m.path.origin),a.push(b),this.usedMemory+=m.usedMemory}if(0===a.length)return null;const d=new On({geometries:a,layerUid:this._context.layer.uid,graphicUid:r}),u=new an(this,d,a,null,null,((e,t,i,r,s)=>function(e,t,i,r,s){const n=e.stageObject,a=n.geometries;let o=0;for(const e of a){if(!Lg(e))continue;const t=e.path,a=t.builder.path;o+=Dm(a,0,i,r),s!==Fg.World&&Mm(a,s,r),t.onPathChanged(e),e.invalidateBoundingInfo(),n.geometryVertexAttributeUpdated(e,It.r.POSITION)}return o/a.length}(e,0,r,s,this._upVectorAlignment)),i);return u.alignedSampledElevation=0,u.needsElevationUpdates=Gt(i.mode),u}},fill:w_,extrude:class extends vn{constructor(e,t,i,r){super(e,t,i,r),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=en(this._getSymbolSize());if(e)throw new le.A("graphics3dextrudesymbollayer:invalid-size",e)}const e=this.symbolLayer?.material?.color,t=this._getCombinedOpacityAndColor(e),i=(0,I.ci)(t),r=t[3],s=r<1||this.needsDrivenTransparentPass,n={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:r,transparent:s,cullFace:s?ge.s2.None:ge.s2.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0,normalType:rd.W.Compressed};this._materials[wd.Main]=new os.$U(n),this._materials[wd.Bottom]=new os.$U({...n,cullFace:ge.s2.Back}),this._context.stage.addMany(this._materials)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,nd,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t);return this._createAs3DShape(t,e.renderingInfo,i,r,t.uid)}layerOpacityChanged(e,t){const i=this.symbolLayer?.material?.color,r=this._getCombinedOpacity(i),s=r<1||this.needsDrivenTransparentPass;this._materials[wd.Main]?.setParameters({opacity:r,transparent:s}),this._materials[wd.Bottom]?.setParameters({opacity:r,transparent:s});const n=this._getLayerOpacity();e.forEach((e=>{const i=t(e);null!=i&&i.layerOpacityChanged(n,this._context.isAsync)}))}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Gt)}slicePlaneEnabledChanged(e,t){return this._materials[wd.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[wd.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach((e=>{const i=t(e);null!=i&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){const e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[wd.Main]?.setParameters(e),this._materials[wd.Bottom]?.setParameters(e),!0}_getExtrusionSize(e){let t;return t=e.size&&this._drivenProperties.size?function(e,t=0){const i=e[t];return"number"==typeof i&&isFinite(i)?i:null}(e.size,2)??0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}applyRendererDiff(e,t){return this._drivenPropertiesChanged(t)?pn.RecreateSymbol:pn.RecreateGraphics}async queryForSnapping(e,t,i,r){const s=this._getExtrusionSize(i)*this._context.renderCoordsHelper.unitInMeters/(0,E.G9)(t),{objectId:n,target:a}=e,o=(0,ut.o8)(a);switch(o.z=(o.z??0)+s,e.type){case"edge":{const{start:t,end:i}=e,r=(0,ut.o8)(t),a=(0,ut.o8)(i);return r.z=(r.z??0)+s,a.z=(a.z??0)+s,[(0,Oa.P)(n,o,1/0,r,a)]}case"vertex":return[(0,Oa.k)(n,o,1/0),(0,Oa.P)(n,a,1/0,a,o)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,t,i,r,s){const n=(0,Fa.dE)(e.geometry);if(null==n)return null;if(0===n.rings.length||!n.rings.some((e=>e.length>0)))return this._logGeometryValidationWarnings(n.rings,"rings","ExtrudeSymbol3DLayer"),null;const a=$h(n,this._context.elevationProvider,this._context.renderCoordsHelper,r);this._logGeometryCreationWarnings(a,n.rings,"rings","ExtrudeSymbol3DLayer");const o=Qs(n);if(null==o)return null;const l=new Array,c=new Array,h=(0,q.vt)(),d=(0,P.vt)(),u=(0,I.vt)(),p=this._context.renderCoordsHelper.viewingMode===oe.RT.Global;p||this._context.renderCoordsHelper.worldUpAtPosition(null,u),(0,Et.l)(n.spatialReference,[o.x,o.y,0],d,this._context.renderCoordsHelper.spatialReference);const f=(0,P.vt)();(0,O.B8)(f,d);const g=(0,T.vt)();(0,A.Ge)(g,f);const{polygons:m,mapPositions:_,position:y}=a;for(const e of m){const r=e.count;if(this._context.clippingExtent&&((0,q.Ie)(h),(0,q.Hq)(h,e.mapPositions),!(0,q.KG)(h,this._context.clippingExtent)))continue;const n=(0,Aa.e)(e.mapPositions,e.holeIndices,3);if(0===n.length)continue;const a=n.length,o=6*r,d=(0,Y.my)(o+a),g=(0,Y.my)(a),m=(0,Q.jh)(3*o),v=(0,Q.jh)(3*o),b=(0,Q.jh)(3*o),x=(0,Q.jh)(o);od(y,_,n,e,m,b,v,x,d,g,this._getExtrusionSize(t),u,p),(0,Ta.a)(m,m,f);const S=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerUid:this._context.layer.uid}),w=new Cd(m,b,(0,sd.fA)(v),x);l.push(ad(this._materials[wd.Main],d,d.length-g.length,w,i,S),ad(this._materials[wd.Bottom],g,0,w,i,S)),c.push(w.heights)}if(0===l.length)return null;const v=new On({geometries:l,layerUid:this._context.layer.uid,graphicUid:s,isElevationSource:!0});v.transformation=d;const b=(0,as.Cc)(this.symbolLayer,{opacity:this._getLayerOpacity()}),x=null!=b?{baseMaterial:this._materials[wd.Main],edgeMaterials:[b],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,S=new an(this,v,l,null,null,((e,t,i,r,s)=>function(e,t,i,r,s,n){const a=e.stageObject,o=a.geometries,l=o.length,c="absolute-height"!==t.mode;let h=0;const d=a.transformation,u=(0,O.Qw)((0,P.vt)(),d);for(let e=0;e<l;e+=2){const t=o[e];if(!Ds(t))continue;const l=t.getMutableAttribute(It.r.POSITION).data,p=n[e/2],f=new Tt(t.mapPositions),g=l.length/3;let m=0,_=!1,y=0;for(let e=0;e<g;e++){_d[0]=l[m],_d[1]=l[m+1],_d[2]=l[m+2],r(f,bd),c&&(y+=bd.sampledElevation),Is.b.TESTS_DISABLE_OPTIMIZATIONS?((0,M.s)(yd,f.array[f.offset],f.array[f.offset+1],bd.z+p[m/3]),null!=i&&s.toRenderCoords(yd,i,yd),(0,M.e)(yd,yd,u)):((0,M.s)(yd,l[m],l[m+1],l[m+2]),(0,M.e)(yd,yd,d),s.setAltitude(yd,bd.z+p[m/3]),(0,M.e)(yd,yd,u)),l[m]=yd[0],l[m+1]=yd[1],l[m+2]=yd[2];const e=.01/s.unitInMeters;(Math.abs(_d[0]-l[m])>=e||Math.abs(_d[1]-l[m+1])>=e||Math.abs(_d[2]-l[m+2])>=e)&&(_=!0),f.offset+=3,m+=3}_&&(t.invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(o[e],It.r.POSITION),o[e+1].invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(o[e+1],It.r.POSITION)),h+=y/g}return h/l}(e,t,i,r,s,c)),r,x);return S.alignedSampledElevation=a.sampledElevation,S.needsElevationUpdates=Gt(r.mode),S}},text:class extends vn{constructor(e,t,i,r){super(e,t,i,r),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=en(this.symbolLayer.size);if(e)throw new le.A("graphics3dtextsymbollayer:invalid-size",e)}await this._createTextRenderParameters()}async _createTextRenderParameters(){const e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=await M_.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){const t=e.graphic,i=zn(t.geometry);if(null==i)return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;const r=this.symbolLayer.text;if(null==r||""===r)return null;const s=(0,Ps.YX)(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(null!=s&&!(0,Ps.Ie)(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const{verticalAlignment:n}=this.symbolLayer,a=new T_(s);!function(e,t){switch(e){case"top":return(0,xa.hZ)(t,0,1);case"bottom":return(0,xa.hZ)(t,0,-1);default:(0,xa.C)(t,dr.uY)}}(n,a.screenOffset);const o=new O_(a,this.symbolLayer.horizontalAlignment,function(e){return"middle"===e?"center":e}(n));return this._createAs3DShape(t,i,r,o)}createLabel(e,t,i,r,s){const n=e.graphic,a=zn(n.geometry);if(null==a)return this.logger.warn(`unsupported geometry type for label: ${n.geometry.type}`),null;const o=t.text;return!o||/^\s+$/.test(o)?null:this._createAs3DShape(n,a,o,t,i,r,s)}setGraphicElevationContext(e,t,i=0){return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(i),t}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,t){return Z_(e,t,((e,t)=>{this.updateGraphicElevationContext(t,e)})),Mt.UPDATE}slicePlaneEnabledChanged(e,t){return Z_(e,t,(e=>{for(const t of e.stageObject.geometries)t.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return!1}updateGraphicElevationContext(e,t){const i=t.elevationContext;this.setGraphicElevationContext(e,i,null!=t.metadata?t.metadata.elevationOffset:0),t.needsElevationUpdates=Vt(i.mode)||"absolute-height"===i.mode}_defaultElevationInfoNoZ(){return q_}_createAs3DShape(e,t,i,r,s=null,n=null,a=(()=>r.placement.elevationOffset)){const l=this.setGraphicElevationContext(e,new ci,r.placement.elevationOffset),c="polyline"===e.geometry?.type,h=e.uid;let d=null,u=null;if(null==n){const e=tu(r.horizontalPlacement);d=new j_(i,e,this._textRenderParameters);let t=null;if(null!=this._context.sharedResources.textures){u=this._context.sharedResources.textures.fromData(d.key,(()=>d.create())),u.texture.events.on("unloaded",(()=>t?.release()));const e=this._context.stage.renderView.textureRepository.acquire(u.texture.id);if(null==e||(0,o.$X)(e))return u.release(),null;t=e}}const p=function(e,t){if("baseline"===t.verticalPlacement){const i=Kd[t.horizontalPlacement],r=null!=e?e.baselineAnchorY:0;return(0,dr.fA)(i,r)}const i=function(e,t){switch(t){case"bottom":return"left"===e?"bottom-left":"right"===e?"bottom-right":"bottom";case"center":return e;case"top":return"left"===e?"top-left":"right"===e?"top-right":"top"}}(t.horizontalPlacement,t.verticalPlacement);return eu[i]}(d,r),f={occlusionTest:!0,screenOffset:r.placement.screenOffset,anchorPosition:p,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:r.placement.centerOffsetUnits,drawInSecondSlot:!0};if(n?f.textureId=n.id:u&&(f.textureId=u.texture.id),null!=r.placement.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=r.placement.verticalOffset;f.verticalOffset={screenLength:(0,Ms.Lz)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources,i=zd(this._textRenderParameters);f.screenSizePerspective=t.overrideFontHeight(i.maxHeight),f.screenSizePerspectiveAlignment=e}c&&(f.shaderPolygonOffset=1e-4),f.hasSlicePlane=this._context.slicePlaneEnabled;const g=s?((e,t)=>{const i=JSON.stringify(t);let r=e.get(i);return null==r&&(r=new mu(t),e.add(i,r)),r})(s,f):new mu(f),m=r.placement.translation,_=d?(0,dr.fA)(d.displayWidth,d.displayHeight):dr.uY,y=r.placement.centerOffset,v=jr(g,k_,m,null,_,y,(0,dr.vt)(),null),b=Gn(this._context,t,v,l,h);if(null==b)return null;const x=new an(this,b.object,[v],null==s?[g]:null,u,((t,i,s,n,o,l)=>{const c=a()||r.placement.elevationOffset;return Ls(t,this.setGraphicElevationContext(e,i,c),0,n,o,l)}),l);x.alignedSampledElevation=b.sampledElevation,x.needsElevationUpdates=Vt(l.mode)||"absolute-height"===l.mode,x.getScreenSize=(e=(0,dr.vt)())=>(e[0]=d?d.displayWidth:r.displaySize[0],e[1]=d?d.displayHeight:r.displaySize[1],e);const S=new un(r.placement.elevationOffset,i);return x.metadata=S,Un(x,t,this._context.elevationProvider),x}},water:sy},py={"mesh-3d":{fill:class extends vn{constructor(e,t,i,r){super(e,t,i,r),this._materialInfoCache=new Vp,this._fastUpdateProcessor=new Np,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){Is.b.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new qp({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new qp({color:[0,1,1,1]}))}destroy(){super.destroy(),this._textures.forEach((e=>e.unload())),this._context.stage.removeMany(this._materialInfoCache.materials),this._context.stage.removeMany(Array.from(this._textures.values())),this._materialInfoCache.clear(),this._textures.clear(),this._fastUpdateProcessor.destroy(this._context.stage)}get materials(){return this._materialInfoCache.materials}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,ff,"fill on mesh-3d"))return null;const i=this.setGraphicElevationContext(t),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}onRemoveGraphic(e){this._fastUpdateProcessor.onRemoveGraphic(e,this._materialInfoCache,this._context)}layerOpacityChanged(e,t){const i=this._getLayerOpacity();this._updateMaterialParameters((e=>{e.material.setParameters({layerOpacity:i});const t=e.material.parameters;this._setMaterialTransparentParameter(t,e),e.material.setParameters({transparent:t.transparent})})),e.forEach((e=>t(e)?.layerOpacityChanged(i,this._context.isAsync)))}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Gt)}slicePlaneEnabledChanged(e,t){return this._updateMaterialParameters((({material:e})=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),e.forEach((e=>t(e)?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync))),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._updateMaterialParameters((({material:t})=>t.setParameters({usePBR:e}))),!0}updateTransform(e,t,i,r){const s=e.fastTransformUpdatesEnabled;switch(r){case bp.EnableFastUpdates:if(s)return!0;break;case bp.DisableFastUpdates:if(!s)return!0;break;default:if(!s)return!1}const n=this._context.renderCoordsHelper.spatialReference,a=wf,{origin:o,transform:l}=i;if(!(0,Et.l)(t,(0,M.s)(_f,o.x,o.y,o.z??0),a,n))return!1;switch(r){case bp.EnableFastUpdates:this._fastUpdateProcessor.enable(e,this._materialInfoCache,this._context);break;case bp.DisableFastUpdates:this._fastUpdateProcessor.disable(e,this._materialInfoCache,this._context);break;case bp.UpdateFastLocalOrigin:e.updateFastLocalOrigin(a,l,this._context.localOriginFactory)}const{elevationContext:c}=e;c.centerPointInElevationSR=this._getCenterPointInElevationSR(a);const{elevationProvider:h,renderCoordsHelper:d}=this._context;return e.alignedSampledElevation=Ls(e,c,h.spatialReference,((e,t)=>Ft(e,h,c,d,t)),d,a),e.updateTransform(a,l,this._context.isAsync),!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return null==e?"-":e instanceof y.A?e.toHex():e.contentHash}_materialPropertiesDefault(e,t){const i=this._requiresSymbolVertexColors(),r=!!e.vertexAttributes.color,s=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:i,hasVertexColors:r,hasVertexTangents:s,uid:`vc:${r},vt:${s},vct${t},svc:${i}`}}_textureTransformUid(e){const{offset:t,scale:i,rotation:r}=e??Ef;return`${t[0]},${t[1]},${r},${i[0]},${i[1]}`}_materialProperties(e,t,i){const r=this._materialPropertiesDefault(e,i);if(!t.material)return r;const{color:s,colorTexture:n,colorTextureTransform:a,normalTexture:o,normalTextureTransform:l,doubleSided:c,alphaCutoff:h,alphaMode:d}=t.material,u=this._colorOrTextureUid(s),p=this._colorOrTextureUid(n),f=this._textureTransformUid(a),g=this._colorOrTextureUid(o),m=this._textureTransformUid(l);if(r.color=s,r.colorTexture=n,r.normalTexture=o,r.uid=`${r.uid},cmuid:${u},ctmuid:${p},cttuid:${f},ntmuid:${g},nttuid:${m},ds:${c},ac:${h},am:${d}`,t.material instanceof Sp.A){const{metallic:e,roughness:i,metallicRoughnessTexture:s,metallicRoughnessTextureTransform:n,emissiveColor:o,emissiveTexture:c,emissiveTextureTransform:h,occlusionTexture:d,occlusionTextureTransform:u}=t.material,p=this._colorOrTextureUid(s),f=this._textureTransformUid(n),g=this._colorOrTextureUid(o),m=this._colorOrTextureUid(c),_=this._textureTransformUid(h),y=this._colorOrTextureUid(d),v=this._textureTransformUid(u);r.metallic=e,r.roughness=i,r.metallicRoughnessTexture=s,r.emissiveColor=o,r.emissiveTexture=c,r.occlusionTexture=d,r.colorTextureTransform=this._convertTextureTransform(a),r.normalTextureTransform=this._convertTextureTransform(l),r.emissiveTextureTransform=this._convertTextureTransform(h),r.occlusionTextureTransform=this._convertTextureTransform(u),r.metallicRoughnessTextureTransform=this._convertTextureTransform(n),r.uid=`${r.uid},mrm:${e},mrr:${i},mrt:${p},mrtt:${f},emuid:${g},etmuid:${m},ett:${_},otmuid:${y},ott:${v}`}return r}_convertTextureTransform(e){if(!e)return null;const{scale:t,offset:i,rotation:r}=e;return{scale:t,offset:i,rotation:(0,U.kU)(r)}}_setInternalColorValueParameters(e,t){t.diffuse=y.A.toUnitRGB(e),t.opacity=e.a}_getLoadableTextureResource(e){return e.data??e.url}_getInternalTextureId(e){const t=this._getInternalTexture(e,ge.sf.Opaque);return t?.id}_getInternalTexture(e,t){const i=this._getLoadableTextureResource(e);if(!i)return null;const r=`${e.contentHash}/${t}`;let s=this._textures.get(r);if(!s){let n=null;const a=this._context.stage.renderView.renderingContext.parameters.maxMaxAnisotropy,o={wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,maxAnisotropy:a,mipmap:a>1};(0,fe.x3)(i)?(n=i.data,o.preMultiplyAlpha=!1,o.encoding=i.encoding):(n=i,o.preMultiplyAlpha=t!==ge.sf.Opaque,o.downsampleUncompressed=this._context.graphicsCoreOwner.view.qualitySettings.graphics3D.uncompressedTextureDownsamplingEnabled),s=new mt.g(n,o),this._textures.set(r,s),s.load(this._context.stage.renderView.renderingContext),this._context.stage.add(s)}return s}_castTextureWrap(e="repeat"){if("string"==typeof e){const t=this._castTextureWrapIndividual(e);return{s:t,t}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return _t.pF.CLAMP_TO_EDGE;case"mirror":return _t.pF.MIRRORED_REPEAT;default:return _t.pF.REPEAT}}_setInternalMaterialParameters(e,t){if(null!=e.color&&this._setInternalColorValueParameters(e.color,t),null!=e.colorTexture){const i=this._getInternalTexture(e.colorTexture,t.textureAlphaMode);i?(t.textureId=i.id,t.textureAlphaPremultiplied=!!i.parameters.preMultiplyAlpha):t.textureId=void 0}e.normalTexture&&(t.normalTextureId=this._getInternalTextureId(e.normalTexture)),e.emissiveColor&&(t.emissiveFactor=y.A.toUnitRGB(e.emissiveColor)),e.emissiveTexture&&(t.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),e.occlusionTexture&&(t.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),e.metallicRoughnessTexture&&(t.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture)),t.colorTextureTransformMatrix=(0,Ep.G)(e.colorTextureTransform),t.normalTextureTransformMatrix=(0,Ep.G)(e.normalTextureTransform);const i=null!=e.normalTextureTransform?.scale?e.normalTextureTransform?.scale:dr.Un;t.scale=[i[0],i[1]],t.occlusionTextureTransformMatrix=(0,Ep.G)(e.occlusionTextureTransform),t.emissiveTextureTransformMatrix=(0,Ep.G)(e.emissiveTextureTransform),t.metallicRoughnessTextureTransformMatrix=(0,Ep.G)(e.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(e){const t=this._drivenProperties.color;let i=this.symbolLayer.material?.colorMixMode??null;if(t)e.externalColor=F.Un;else{const t=this.symbolLayer.material?.color??null;t?e.externalColor=y.A.toUnitRGBA(t):(i=null,e.externalColor=F.Un)}i&&(e.colorMixMode=i),e.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const t=e.vertexAttributes.color;if(null==t)return!1;for(let e=3;e<t.length;e+=4)if(255!==t[e])return!0;return!1}_getOrCreateMaterial(e,t){const i=t.material?.color,r=t.material?.colorTexture,s=t.material?.alphaMode,n="blend"===s,a=!("opaque"===s)&&(this._hasTransparentVertexColors(e)||null!=i&&i.a<1||r?.transparent||n),o=this._materialProperties(e,t,a),l=this._materialInfoCache.byUid(o.uid);if(l)return l.material;const c={uid:o.uid,material:null,isComponentTransparent:a,alphaMode:t.material?t.material.alphaMode:"opaque"},h=(0,_e.Jr)({normalTexture:o.normalTexture,metallicRoughnessTexture:o.metallicRoughnessTexture,metallicFactor:o.metallic,roughnessFactor:o.roughness,emissiveTexture:o.emissiveTexture,emissiveFactor:y.A.toUnitRGB(o.emissiveColor),occlusionTexture:o.occlusionTexture}),d={usePBR:this._usePBR(),isSchematic:h,hasVertexColors:o.hasVertexColors,hasSymbolColors:o.hasSymbolVertexColors,hasVertexTangents:o.hasVertexTangents,ambient:I.uY,diffuse:I.Un,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:ge.s2.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};d.mrrFactors=h?[..._e.mX]:[o.metallic,o.roughness,_e.Rk[2]],t.material&&(d.doubleSided=t.material.doubleSided,d.cullFace=t.material.doubleSided?ge.s2.None:ge.s2.Back,d.textureAlphaCutoff=t.material.alphaCutoff),this._setExternalMaterialParameters(d),this._setMaterialTransparentParameter(d,c),this._setInternalMaterialParameters(o,d);const u=new os.$U(d);return c.material=u,this._materialInfoCache.set(o.uid,c),this._context.stage.add(u),u}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?ge.sf.MaskBlend:ge.sf.Opaque:e.textureAlphaMode="opaque"===t.alphaMode?ge.sf.Opaque:"mask"===t.alphaMode?ge.sf.Mask:ge.sf.Blend}_addDebugNormals(e,t){const i=t.length,r=e.spatialReference.isGeographic?20015077/180:1,s=.1*Math.max(e.extent.width*r,e.extent.height*r,e.extent.zmax-e.extent.zmin),n=[],a=[],o=[],l=[];for(let e=0;e<i;e++){const i=t[e],r=i.attributes.get(It.r.POSITION),c=i.attributes.get(It.r.NORMAL),h=r.data,d=r.indices,u=c.data,p=c.indices;for(let e=0;e<d.length;e++){const t=3*d[e],i=3*p[e];for(let e=0;e<3;e++)n.push(h[t+e]);for(let e=0;e<3;e++)n.push(h[t+e]+u[i+e]*s);if(a.push(a.length),a.push(a.length),e%3==0){this._calculateFaceNormal(h,d,e,bf),this._getFaceVertices(h,d,e,_f,yf,vf),(0,M.g)(_f,_f,yf),(0,M.g)(_f,_f,vf),(0,M.h)(_f,_f,1/3);for(let e=0;e<3;e++)o.push(_f[e]);for(let e=0;e<3;e++)o.push(_f[e]+bf[e]*s);l.push(l.length),l.push(l.length)}}}const c=t[0].transformation,h=new _r.V(this._debugVertexNormalMaterial,[[It.r.POSITION,new gr.n(n,a,3,!0)]],null,mr.X.Line);t.push(h),h.transformation=c;const d=new _r.V(this._debugFaceNormalMaterial,[[It.r.POSITION,new gr.n(o,l,3,!0)]],null,mr.X.Line);d.transformation=c,t.push(d)}_createAs3DShape(e,t,i,r){const s=e.geometry;if("mesh"!==s.type)return null;const n=this._createGeometryInfo(s,t,r);if(null==n)return null;const{geometries:a,objectTransformation:o}=n;Is.b.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(s,a);const l=new On({geometries:a,layerUid:this._context.layer.uid,graphicUid:r,isElevationSource:!0});l.transformation=o;const c=(0,as.Cc)(this.symbolLayer,{opacity:this._getLayerOpacity()}),h=c?new nn(a[0].material,[c],{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}):null,d=new Ap(this,l,a,null,null,Ls,i,h);this._fastUpdateProcessor.onAddGraphic(),d.needsElevationUpdates=Gt(i.mode),d.useObjectOriginAsAttachmentOrigin=!0,i.centerPointInElevationSR=this._getCenterPointInElevationSR(l.transformation);const{elevationProvider:u,renderCoordsHelper:p}=this._context;return d.alignedSampledElevation=Ls(d,i,u.spatialReference,((e,t)=>Ft(e,u,i,p,t)),p),d}_getCenterPointInElevationSR(e){const t=(0,ne.T)(0,0,0,null!=this._context.elevationProvider.spatialReference?this._context.elevationProvider.spatialReference:null);return function(e,t,i){!!(0,Z.F)(e,t,vp,i.spatialReference)&&(i.x=vp[0],i.y=vp[1],i.z=vp[2])}([e[12],e[13],e[14]],this._context.renderCoordsHelper.spatialReference,t),t}_createComponentNormals(e,t,i,r){switch(i.shading||"flat"){default:case"source":return this._createComponentNormalsSource(e,t,i,r);case"flat":return this._createComponentNormalsFlat(e,r);case"smooth":return this._createComponentNormalsSmooth(e,r)}}_createComponentNormalsSource(e,t,i,r){if(null==t)return this._createComponentNormalsFlat(e,r);let s=!1;if(!i.trustSourceNormals)for(let i=0;i<r.length;i+=3){this._calculateFaceNormal(e,r,i,bf);for(let e=0;e<3;e++){const n=3*r[i+e];_f[0]=t[n],_f[1]=t[n+1],_f[2]=t[n+2],(0,M.j)(bf,_f)<0&&(t[n]=-t[n],t[n+1]=-t[n+1],t[n+2]=-t[n+2],s=!0)}}return new gf(t,r,s)}_createComponentNormalsFlat(e,t){const i=(0,J.oe)(t.length),r=new Array(3*t.length);for(let s=0;s<t.length;s+=3){const n=this._calculateFaceNormal(e,t,s,bf);for(let e=0;e<3;e++)i[s+e]=n[e],r[s+e]=s/3}return new gf(i,r,!1)}_createComponentNormalsSmooth(e,t){const i={};for(let r=0;r<t.length;r+=3){const s=this._calculateFaceNormal(e,t,r,bf);for(let e=0;e<3;e++){const n=t[r+e];let a=i[n];a||(a={normal:(0,I.vt)(),count:0},i[n]=a),(0,M.g)(a.normal,a.normal,s),a.count++}}const r=(0,J.oe)(3*t.length),s=new Array(3*t.length);for(let e=0;e<t.length;e++){const n=i[t[e]];1!==n.count&&((0,M.n)(n.normal,n.normal),n.count=1);for(let t=0;t<3;t++)r[3*e+t]=n.normal[t];s[e]=e}return new gf(r,s,!1)}_getFaceVertices(e,t,i,r,s,n){const a=3*t[i],o=3*t[i+1],l=3*t[i+2];r[0]=e[a],r[1]=e[a+1],r[2]=e[a+2],s[0]=e[o],s[1]=e[o+1],s[2]=e[o+2],n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2]}_calculateFaceNormal(e,t,i,r){return this._getFaceVertices(e,t,i,_f,yf,vf),(0,M.f)(yf,yf,_f),(0,M.f)(vf,vf,_f),(0,M.b)(_f,yf,vf),(0,M.n)(r,_f),r}_getOrCreateComponents(e){return e.components??Rf}_createPositionBuffer(e,t){let i=e.vertexAttributes.position;const r=t.reprojection===Af.RENDER?t.transformBeforeProject:null;if(r&&(i=(0,Ta.a)(new Float64Array(i.length),i,r)),t.reprojection===Af.NONE)return t.needsBufferCopy?new Float64Array(i):i;const s=r?i:new Float64Array(i.length);return(0,k.projectBuffer)(i,e.spatialReference,0,s,this._context.renderCoordsHelper.spatialReference,0,i.length/3),s}_createNormalBuffer(e,t,i){let r=e.vertexAttributes.normal;if(null==r)return null;const s=i.reprojection===Af.RENDER?i.transformBeforeProject:null;if(s&&(r=(0,Rp.qs)(r,new Float32Array(r.length),s)),"local"===this._context.graphicsCoreOwner.view.viewingMode||i.reprojection===Af.NONE)return i.needsBufferCopy&&e.vertexAttributes.normal===r?new Float32Array(r):r;const n=e.vertexAttributes.position,a=s?r:new Float32Array(r.length);return(0,Rp.X4)(r,n,t,e.spatialReference,a)}_createTangentBuffer(e,t,i){let r=e.vertexAttributes.tangent;if(null==r)return null;const s=i.reprojection===Af.RENDER?i.transformBeforeProject:null;if(s&&(r=(0,Rp.KM)(r,new Float32Array(r.length),s)),"local"===this._context.graphicsCoreOwner.view.viewingMode||i.reprojection===Af.NONE)return i.needsBufferCopy&&e.vertexAttributes.normal===r?new Float32Array(r):r;const n=e.vertexAttributes.position,a=s?r:new Float32Array(r.length);return(0,Rp.xA)(r,n,t,e.spatialReference,a)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const t=this._getVertexOpacityAndColor(e),i=(0,Gp.Eb)(this.symbolLayer?.material?.colorMixMode),r=new Uint8Array(4);return(0,Gp._j)(t,i,r),r}return null}_createBuffers(e,t){const i=e.vertexAttributes&&e.vertexAttributes.position;if(!i)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const r=e.vertexAttributes.normal,s=e.vertexAttributes.uv,n=e.vertexAttributes.tangent;if(r&&r.length!==i.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(n&&n.length/4!=i.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(s&&s.length/2!=i.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const a=this._computeReprojectionInfo(e),o=this._createPositionBuffer(e,a),l=this._createColorBuffer(e),c=this._createSymbolColorBuffer(t),h=this._createNormalBuffer(e,o,a),d=this._createTangentBuffer(e,o,a);return{positionBuffer:o,normalBuffer:h,tangentBuffer:d,uvBuffer:s,colorBuffer:l,symbolColorBuffer:c,objectTransformation:a.reprojection===Af.NONE&&a.objectTransformation?a.objectTransformation:this._transformOriginLocal(e,o,h,d),geometryTransformation:a.reprojection===Af.NONE&&a.geometryTransformation?a.geometryTransformation:(0,P.vt)()}}_computeReprojectionInfo(e){const{vertexSpace:t}=e,i="georeferenced"===t.type?(0,G.aI)(this._context.renderCoordsHelper.spatialReference,e.spatialReference)?Af.NONE:Af.RENDER:Af.NONE;if((0,ue.Hq)(t)){const r=t.origin,s=(0,P.vt)(),n=e.transform?.localMatrix??P.zK;if(i===Af.NONE)return(0,Et.l)(e.spatialReference,r,s,this._context.renderCoordsHelper.spatialReference),{reprojection:i,objectTransformation:s,geometryTransformation:(0,P.o8)(n),needsBufferCopy:!1};const a=(0,O.kN)((0,P.vt)(),r);return(0,O.lw)(a,a,n),{reprojection:i,transformBeforeProject:a,needsBufferCopy:!0}}return{reprojection:i,needsBufferCopy:!0}}_transformOriginLocal(e,t,i,r){const s=this._context.renderCoordsHelper.spatialReference,n=e.anchor;mf[0]=n.x,mf[1]=n.y,mf[2]=n.z??0;const a=(0,P.vt)();return(0,Et.l)(e.spatialReference,mf,a,s),(0,O.B8)(xf,a),(0,Ta.a)(t,t,xf),(i||r)&&((0,A.z0)(Sf,a),(0,A.mg)(Sf,Sf),i&&(0,Ta.b)(i,i,Sf),r&&(0,Ta.b)(r,r,Sf,4)),a}_validateFaces(e,t){const i=e.vertexAttributes.position.length/3,r=t.faces;if(r){let e=-1;for(let t=0;t<r.length;t++){const i=r[t];i>e&&(e=i)}if(i<=e)return this.logger.warn(`Vertex index ${e} is out of bounds of the mesh position buffer`),!1}else if(i%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(e,t){return t.faces??(0,Y.tM)(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return!1;const t=e.vertexAttributes?.position;if(!t)return!1;const i=this._context.elevationProvider.spatialReference,r=(0,Cp.project)({positions:t,transform:e.transform,vertexSpace:e.vertexSpace,inSpatialReference:e.spatialReference,outSpatialReference:i??e.spatialReference,localMode:this._context.stage.viewingMode===oe.RT.Local}),s=r.length/3;return(0,q.Ie)(Cf),(0,q.Hq)(Cf,r,0,s),!(0,q.KG)(Cf,this._context.clippingExtent)}_createGeometryInfo(e,t,i){if(!(0,Hi.canProjectWithoutEngine)(e.spatialReference,this._context.renderCoordsHelper.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(!this._validateVertexSpace(e))return null;if(this._isOutsideClippingArea(e))return null;const r=this._createBuffers(e,t);if(null==r)return null;const{positionBuffer:s,uvBuffer:n,colorBuffer:a,symbolColorBuffer:o,normalBuffer:l,tangentBuffer:c,objectTransformation:h,geometryTransformation:d}=r,u=this._getOrCreateComponents(e),p=new Array;let f=!1;const g=(0,O.sC)(_f,h),m=this._context.localOriginFactory.getOrigin(g);for(const t of u){if(!this._validateFaces(e,t))return null;const r=this._getOrCreateFaces(e,t);if(0===r.length)continue;const h=this._createComponentNormals(s,l,t,r);h.didFlipNormals&&(f=!0);const u=[[It.r.POSITION,new gr.n(s,r,3,!0)],[It.r.NORMAL,new gr.n(h.normals,h.indices,3,!0)]];a&&u.push([It.r.COLOR,new gr.n(a,r,4,!0)]),o&&u.push([It.r.SYMBOLCOLOR,new gr.n(o,(0,Y.EH)(r.length),4,!0)]),n&&u.push([It.r.UV0,new gr.n(n,r,2,!0)]),c&&u.push([It.r.TANGENT,new gr.n(c,r,4,!0)]);const g=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerUid:this._context.layer.uid}),_=this._getOrCreateMaterial(e,t),y=new _r.V(_,u,null,mr.X.Mesh,g);y.transformation=d,y.localOrigin=m,p.push(y)}return f&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:p,objectTransformation:h}}_updateMaterialParameters(e){this._materialInfoCache.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachClonedMaterial(((e,t)=>{t.setParameters(e.parameters)}))}_validateVertexSpace(e){const{_context:{graphicsCoreOwner:{view:{state:{viewingMode:t}}}}}=this,{vertexSpace:i}=e;return t!==oe.RT.Local||"local"!==i.type||(this.logger.warn("Displaying a mesh with a local vertex space in a view in local viewing mode is not supported."),!1)}test(){return{...super.test(),materials:this._materialInfoCache.materials}}}}};class fy extends mn{set symbol(e){this._symbol=e,e.symbolLayers.forEach(((t,i)=>{const r=this.symbolLayers[i];null!=r&&(r.symbol=e,r.symbolLayer=t)}))}get symbol(){return this._symbol}constructor(e,t,i){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const i=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const r=[];for(let s=0;s<i;s++){const n=t.at(s);if(!1===n.enabled)continue;gy.renderPriority=1-(1+s)/i,gy.renderPriorityStep=1/i,gy.ignoreDrivers=n.ignoreDrivers;const a=dy(this.symbol,n,this._context,gy),l=(0,o.NY)(e,(()=>{this.symbolLayers[s]=null,a.destroy()}));l&&r.push(l),this.symbolLayers[s]=a}if(await(0,dt.jJ)(this.symbolLayers,(async(e,t)=>{if(null!=e)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}})),r.forEach((e=>e.remove())),(0,o.Te)(e),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return null!=t?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some((e=>e?.queryForSnapping))}createGraphics3DGraphic(e,t){const i=e.graphic,r=this.symbolLayers.map((t=>t?.createGraphics3DGraphic(e)??null)),s=this._context.arcade||this._context.featureExpressionInfoContext?.arcade?.modules||null;return new Ea(i,t||this,r,e.layer,s)}get complexity(){return cs(this.symbolLayers.map((e=>null!=e?e.complexity:null)))}globalPropertyChanged(e,t){const i=this.symbolLayers.length;for(let r=0;r<i;r++){const i=this.symbolLayers[r],s=e=>{const t=e.layers[r];return t instanceof an?t:null};if(null!=i&&!i.globalPropertyChanged(e,t,s))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus!==fn.LOADED?pn.RecreateSymbol:this.symbolLayers.reduce(((i,r)=>i!==pn.RecreateSymbol&&null!=r?Math.min(i,r.applyRendererDiff(e,t)):i),pn.FastUpdate)}prepareSymbolPatch(e){if(this.loadStatus===fn.FAILED)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const i=t.symbolLayers.diff;this.symbolLayers.forEach(((t,r)=>{if(null==t)return;const s=i[r];if(s){const i={diff:s,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(i),e.symbolStatePatches.push(...i.symbolLayerStatePatches),i.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const s=e.layers[r];null!=s&&i.graphics3DGraphicPatches.forEach((e=>e(s,t)))}))}}))}updateGeometry(e,t){return this._updateGeometryOrTransform(e,((e,i)=>e.updateGeometry(i,t)))}updateTransform(e,t,i,r){return this._updateGeometryOrTransform(e,((e,s)=>e.updateTransform(s,t,i,r)))}_updateGeometryOrTransform(e,t){for(let i=0;i<this.symbolLayers.length;i++){const r=this.symbolLayers[i];if(null==r)continue;const s=e.layers[i];if(!s||!t(r,s))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const i=this.symbolLayers[t];if(null==i)continue;const r=e.layers[t];null!=r&&i.onRemoveGraphic(r)}}getFastUpdateStatus(){let e=0,t=0,i=0;return this.symbolLayers.forEach((r=>{null!=r&&(r.loadStatus===fn.LOADING?e++:r.isFastUpdatesEnabled()?i++:t++)})),{loading:e,slow:t,fast:i}}async queryForSnapping(e,t,i,r){const s=this.symbolLayers.filter(b.Ru).filter((e=>null!=e.queryForSnapping)).map((s=>s.queryForSnapping(e,t,i,r))),n=await Promise.all(s);return(0,o.Te)(r),n.flat()}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const e of this.symbolLayers)null!=e&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const gy=new class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}};class my extends fy{constructor(e,t,i){super(e,t,i),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=_a(this.symbol,t))}async doLoad(e){const t=this._calloutSymbolLayer?(0,dt.Ke)(this._calloutSymbolLayer.load()):null;try{await super.doLoad(e),(0,o.Te)(e)}catch(e){throw this._calloutSymbolLayer?.abortLoad(),e}t&&await t}destroy(){super.destroy(),this._calloutSymbolLayer=(0,ce.pR)(this._calloutSymbolLayer)}createGraphics3DGraphic(e,t){const i=super.createGraphics3DGraphic(e,t);if(null!=this._calloutSymbolLayer&&null!=i){const t=this._createCalloutGraphic(e);t&&i.setCalloutGraphic(t)}return i}globalPropertyChanged(e,t){return!!super.globalPropertyChanged(e,t)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(e,t,(e=>e.calloutLayer)))}updateGeometry(e,t){const i=super.updateGeometry(e,t);if(i&&this._calloutSymbolLayer){const i=e.calloutLayer;if(i)return this._calloutSymbolLayer.updateGeometry(i,t)}return i}_createCalloutGraphic(e){const t=e.renderingInfo;return e.renderingInfo=new ga(t.renderer,t.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(e)}}class _y extends mn{constructor(e,t,i){super(t),this.symbol=e,this._convert=i,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),null!=this.graphics3DSymbol&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.complexity:ls}globalPropertyChanged(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return null!=this.graphics3DSymbol?this.graphics3DSymbol.applyRendererDiff(e,t):pn.RecreateSymbol}prepareSymbolPatch(e){null!=this.graphics3DSymbol&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.updateGeometry(e,t)}updateTransform(e,t,i,r){return this.graphics3DSymbol?.updateTransform(e,t,i,r)??!1}onRemoveGraphic(){}getFastUpdateStatus(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){null!=this.graphics3DSymbol&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}}class yy{constructor(e,t,i){this.visible=e,this.missing=t,this.pending=i}}class vy{constructor(e){this._graphicsCore=e,this._idToState=new Map,this._states=new Set;const t=e.owner.layer?.objectIdField;t?(this._getGraphicId=e=>(0,ki.RW)(e,t),this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicByObjectId(e)):(this._getGraphicId=e=>e.uid,this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicById(e))}destroy(){this._idToState.clear(),this._states.forEach(((e,t)=>this.remove(t)))}add(e){const t=(0,w.hA)((()=>this.remove(e)));if(this._states.has(e))return t;const i=this._getGraphicId(e.graphic),r=this._getGraphics3DGraphicById(i);return this._states.has(e)||this._states.add(e),this._ensureStateList(i).push(e),e.displaying=null!=r&&r.isVisible(),e.isDraped=null!=r&&r.isDraped,e.tracking=!0,null!=r&&e.emit("changed"),t}remove(e){if(this._states.has(e)){if(this._idToState.size){const t=this._getGraphicId(e.graphic),i=this._idToState.get(t);i&&((0,b.TF)(i,e),0===i.length&&this._idToState.delete(t))}this._states.delete(e),e.tracking=!1,e.displaying=!1}}addGraphic(e){this._forEachState(e,(t=>{t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed")}))}removeGraphic(e){this._forEachState(e,(e=>{e.displaying=!1,e.isDraped=!1}))}updateGraphicGeometry(e){this._forEachState(e,(e=>e.emit("changed")))}updateGraphicVisibility(e){this._forEachState(e,(t=>t.displaying=e.isVisible()))}allGraphicsDeleted(){this._states.forEach((e=>e.displaying=!1))}_ensureStateList(e){const t=this._idToState.get(e);if(t)return t;const i=new Array;return this._idToState.set(e,i),i}_forEachState(e,t){if(0===this._states.size||0===this._idToState.size)return;const i=this._getGraphicId(e.graphic),r=this._idToState.get(i);null!=r&&r.forEach(t)}}var by=i(21120);let xy=class extends n.A{constructor(e){super(e),this._index=new by.w(9,(0,d.A)("esri-csp-restrictions")?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(e){this._addMany(e)}destroy(){this._missing.clear(),this._index=(0,ce.pR)(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(e,t,i){null!=t&&t.equals(this.spatialReference)&&(Sy.minX=e[0],Sy.minY=e[1],Sy.maxX=e[2],Sy.maxY=e[3],this.update(),this._index.search(Sy,(e=>i(e.graphic.uid))))}add(e){this._missing.add(e),this.updating=!0}remove(e){if(this._missing.delete(e))return void(this.updating=this._missing.size>0);this._index.remove(e);const t=(0,ki.RW)(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)}_addMany(e){if(0===e.length)return;const t=this._get("objectIdField");for(const i of e){i.computeExtent(this.spatialReference);const e=(0,ki.RW)(i.graphic,t);null!=e&&this._boundsByFeature.set(e,i.extent)}this._index.load(e)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(e,t){Sy.minX=e[0],Sy.minY=e[1],Sy.maxX=e[2],Sy.maxY=e[3],this.update(),this._index.search(Sy,(e=>{t(e)}))}getBounds(e,t){this.update();const i=this._boundsByFeature.get(e);return i?(0,q.Jt)(t,i):null}};(0,r._)([(0,h.MZ)({constructOnly:!0})],xy.prototype,"spatialReference",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],xy.prototype,"hasZ",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],xy.prototype,"hasM",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],xy.prototype,"objectIdField",void 0),(0,r._)([(0,h.MZ)()],xy.prototype,"updating",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],xy.prototype,"updatingRemaining",null),xy=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.SpatialIndex2D")],xy);const Sy={minX:0,minY:0,maxX:0,maxY:0};class wy{constructor(e="scene"){this.context=e,this.extent=(0,$.Ie)()}}const Cy=Symbol("layerHandles");let Ry=class extends(xs.A.EventedMixin(n.A)){get spatialReference(){return this.view?.spatialReference}constructor(e){super(e),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=Zc(this.view.state.viewingMode),this._intersector.options.store=tc.MIN;const e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];const t=this.stageLayer.events;this.addHandles([t.on(["layerObjectAdded","layerObjectRemoved","geometryAdded","geometryRemoved"],(({object:e})=>this._objectChanged(e))),t.on("attributesChanged",(({attribute:e,object:t})=>(0,It.b)(e)&&this._objectChanged(t))),t.on(["transformationChanged","shaderTransformationChanged"],(e=>this._objectChanged(e)))],Cy)}dispose(){this.removeHandles(Cy)}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=(0,E.G9)(this.layer.spatialReference),i=(0,_.Ao)(e.unit??"meters");this._elevationOffset=(e.offset??0)*i/t}else this._elevationOffset=0}getElevation(e,t,i,r){if(Ty[0]=e,Ty[1]=t,Ty[2]=i,!this._renderCoordsHelper.toRenderCoords(Ty,r,Ty))return a.A.getLogger(this).error("could not project point for elevation alignment"),null;const s=this._elevationOffset,n=this._zmin+s,o=this._zmax+s;return this._renderCoordsHelper.setAltitude(Oy,o,Ty),this._renderCoordsHelper.setAltitude(Py,n,Ty),this._intersector.reset(Oy,Py,null),this._intersector.intersect(this._intersectLayers,null,1,null,(e=>!!e.lastValidElevationBB)),this._intersector.results.min.getIntersectionPoint(Ty)?this._renderCoordsHelper.getAltitude(Ty):null}_objectChanged(e){const t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;(0,q.Ie)(Ey);const i=e.lastValidElevationBB;i.isEmpty()||this._expandExtent(t,i.min,i.max,Ey);const{min:r,max:s}=e.boundingVolumeWorldSpace;this._expandExtent(t,r,s,Ey),(0,q.ES)(Ey,Ay.extent),this._zmin=Math.min(this._zmin,Ey[2]),this._zmax=Math.max(this._zmax,Ey[5]),Ay.spatialReference=t,this.emit("elevation-change",Ay),(0,M.c)(i.min,r),(0,M.c)(i.max,s)}_computeLayerExtent(e,t){return(0,q.Ie)(Ey),null!=e&&t.objects.forAll((t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,Ey))),Ey}_expandExtent(e,t,i,r){for(let s=0;s<8;++s)Ty[0]=1&s?t[0]:i[0],Ty[1]=2&s?t[1]:i[1],Ty[2]=4&s?t[2]:i[2],this._renderCoordsHelper.fromRenderCoords(Ty,Ty,e),(0,q.iT)(r,Ty);return r}};(0,r._)([(0,h.MZ)({constructOnly:!0})],Ry.prototype,"layer",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Ry.prototype,"stageLayer",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Ry.prototype,"view",void 0),(0,r._)([(0,h.MZ)()],Ry.prototype,"spatialReference",null),Ry=(0,r._)([(0,u.$)("esri.views.3d.layers.support.StageLayerElevationProvider")],Ry);const Ey=(0,q.Ie)(),Ay=new wy,Ty=(0,I.vt)(),Oy=(0,I.vt)(),Py=(0,I.vt)();var My,Iy=i(6443),Dy=i(96444),Fy=i(8977),Ly=i(94598),Ny=i(31864),Vy=i(43532);const Gy=(0,I.vt)(),Uy=(0,q.vt)();let zy=My=class extends n.A{get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){return this._spatialIndex||(this._spatialIndex=new xy({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){return null!=this.currentRenderer&&"dictionary"===this.currentRenderer.type?xo.ASYNC:this._forcedUpdatePolicy??this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){return!!(this.dataUpdating||this._elevationAlignment?.updating||this._scaleVisibility?.updating||this._filterVisibility?.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this.running)}get dataUpdating(){return!!(this._graphicsWaitingForSymbol.size>0||this._pendingUpdates.size>0||this._spatialIndex?.updating||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.running||this._loadingSymbols>0)}get running(){return this._pendingUpdates.size>0||!!this._spatialIndex?.updating||this._dataUpdateQueue.running||this._updateQueue.running}get suspendedOrOutsideOfView(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}get updatingRemaining(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}get displayFeatureLimit(){const e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?.graphics3D.minTotalNumberOfFeatures??0,i=e?.graphics3D.maxTotalNumberOfFeatures??0,r=e?.graphics3D.maxNumberOfDrawCalls??0,s=e?.graphics3D.maxTotalNumberOfVertices??0,n=this.averageSymbolComplexity,a=Math.max(1,n?.verticesPerFeature??1),o=n&&n.drawCallsPerFeature>0&&r>0?r/n.drawCallsPerFeature:i,l=Math.ceil(s/a),c=Math.max(t,Math.min(i,l,o)),h=this._get("displayFeatureLimit");return h&&h.maximumTotalNumberOfVertices===s&&h.averageSymbolComplexity===n&&h.maximumNumberOfFeatures===c?h:new ms(s,c,n)}get averageSymbolComplexity(){const e=function(e){const t=cs(e);return t.numComplexities>0&&(t.verticesPerFeature/=t.numComplexities,t.verticesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.resourceBytes/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities),t}(this._symbolComplexities),t=this._get("averageSymbolComplexity");return 0===e.numComplexities||null!=t&&(e.estimated&&(t.verticesPerFeature>=e.verticesPerFeature||t.verticesPerCoordinate>=e.verticesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.verticesPerFeature===e.verticesPerFeature&&t.verticesPerCoordinate===e.verticesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}get usedMemory(){const e=null!=this.averageSymbolComplexity&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,t=this._getSymbolComplexitiesUsed().reduce(((e,t)=>e+t.memory.resourceBytes),0),i=this.owner.view._stage.renderer,r=this.owner.view.basemapTerrain.overlayManager.renderer,s=Array.from(this._symbols.values()).reduce(((e,t)=>e+(t?.symbolLayers.reduce(((e,t)=>e+(t?.materials.reduce(((e,t)=>t?e+(i.plugins.getMaterialRenderer(t)?.usedMemory??0)+r.getMemoryForMaterial(t):e),0)??0)),0)??0)),0);return this._usedMemory+e+t+s}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics){const e=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*e}if(null!=this.averageSymbolComplexity){const e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(e){if("web-style"===e.type)return e.clone();const t=this._symbolConversionCache.get(e.id);if(null!=t)return t;const i=(0,ar.t)(e,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(e)}),r=i.symbol||null;return null==r&&i.error&&a.A.getLogger(this).error(i.error.message),this._symbolConversionCache.set(e.id,r),r}_getSymbolComplexitiesUsedOrRenderer(e){if(null==e)return[];const t=e.getSymbols(),i="backgroundFillSymbol"in e?e.backgroundFillSymbol:null;if(!i&&!t?.length)return[];const r=[],s=this._getSymbolComplexityUsedOrRenderer(i);null!=s&&r.push(s);for(const e of t){const t=this._getSymbolComplexityUsedOrRenderer(e);null!=t&&r.push(t)}return r}_getSymbolComplexityUsedOrRenderer(e){if(null==e)return null;const t=this._symbols.get(e.id);if(null!=t)return t.complexity;const i=this._getConvertedSymbol(e);return null!=i?function(e){return"web-style"===e.type?ls:cs(e.symbolLayers.toArray().map((t=>ds(e,t))))}(i):null}_getSymbolComplexitiesUsed(){const e=[];return this._symbols.forEach((t=>{null!=t&&e.push(t.complexity)})),e}get _objectIdField(){return this.layer.objectIdField}constructor(e){super(e),this._propertiesPool=new Iy.M({computedExtent:pp.A},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._frameTaskHandle=Ee.nu,this._dataUpdateQueue=new ae.T,this._updateQueue=new ae.T,this._suspendSymbolCleanup=!1,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._sharedSymbolResourcesOwnerHandle=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this._loadingSymbols=0,this._pendingUpdatesPool=new C.A({allocator:e=>e||new Hy,deallocator:e=>(e.clear(),e)}),this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new C.A,this.preferredUpdatePolicy=xo.SYNC,this._forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=!1,this._startCreateGraphics=!1,this._unusedSymbolsCache=e.owner.view.resourceController.memoryController.newCache("graphics-3d-unused-symbols",(e=>e.destroy())),this.symbolCreationContext=new Os(e.owner.view.resourceController.scheduler,((e,t)=>this._updateQueue.push(e,t)))}initialize(){this._featureStore=new Es({objectIdField:this.owner.layer?.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:e=>this.graphics3DGraphics.forEach(e)});const e=(e,t,i)=>this.spatialIndex.queryGraphicUIDsInExtent(e,t,i),{componentFactories:t}=this;if(null!=t.elevationAlignment){const i=t.elevationAlignment(this,e);this._elevationAlignment=i}if(null!=t.scaleVisibility){const i=t.scaleVisibility(this,e);this._scaleVisibility=i}if(null!=t.filterVisibility){const e=t.filterVisibility({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:e=>this.modifyGraphics3DGraphicVisibilities((t=>t.setVisibilityFlag(ys.GRAPHIC,_s.FILTER,e((0,ki.RW)(t.graphic,this._objectIdField))))),setAllFeaturesVisibility:e=>this.modifyGraphics3DGraphicVisibilities((t=>t.setVisibilityFlag(ys.GRAPHIC,_s.FILTER,e))),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(ys.GRAPHIC,_s.FILTER,!0)))});this._filterVisibility=e}if(null!=t.deconflictor){const e=t.deconflictor(this);this._deconflictor=e}if(null!=t.labeler&&null!=this._scaleVisibility){const e=t.labeler(this,this._scaleVisibility);this._labeler=e}if(null!=t.objectStates){const e=t.objectStates(this);this._objectStates=e}this._initializeAbortController=new AbortController,this._initializePromise=this._initializeAsync()}async _initializeAsync(){const e=this._initializeAbortController?.signal,t=this.owner.view;this._viewElevationProvider=new bs(this._viewSpatialReference,t),this._initializeStage(t,this.layer.uid);const i=t.sharedSymbolResources;this.symbolCreationContext.sharedResources=i,this._sharedSymbolResourcesOwnerHandle=i.addGraphicsOwner(this.owner),null!=this.currentRenderer&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=i.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=t.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new cl(t.renderSpatialReference),this.symbolCreationContext.elevationProvider=t.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);const r=ni(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=await ii(r,this._viewSpatialReference,e,a.A.getLogger(this)),(0,o.Te)(e),this.symbolCreationContext.screenSizePerspectiveEnabled=t.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,this.symbolCreationContext.skipHighSymbolLods=!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,"drapeSourceType"in this.owner){const{owner:e}=this;this.symbolCreationContext.drapeSourceRenderer=t.basemapTerrain.overlayManager.registerGeometryDrapeSource(e),this.addHandles((0,w.hA)((()=>t.basemapTerrain.overlayManager.unregisterDrapeSource(e))))}this.addHandles([(0,l.wB)((()=>this.suspendedOrOutsideOfView),(()=>this._updateQueue.unshift((()=>this._updateLayerVisibility()),null))),(0,l.wB)((()=>[this.layer?.screenSizePerspectiveEnabled,this.owner.view?.screenSizePerspectiveEnabled]),(()=>{const e=t.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;e!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=e,this._labeler?.reset(),this.recreateAllGraphicsAndSymbols())})),(0,l.wB)((()=>this.owner.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(!!e))),(0,l.wB)((()=>this.owner.view.state?.rasterPixelRatio),(()=>this._pixelRatioChange())),(0,l.wB)((()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled),(e=>this._physicalBasedRenderingChange(e))),(0,l.wB)((()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods),(e=>this._skipHighSymbolLoDsChange(e))),(0,l.z7)((()=>t.basemapTerrain?.tilingScheme),(e=>{if(e.spatialReference.equals(this.symbolCreationContext.overlaySR)||null==t.basemapTerrain.spatialReference||(this.symbolCreationContext.overlaySR=t.basemapTerrain.spatialReference),this.hasHandles("loaded-graphics"))this.recreateAllGraphics();else{const e=()=>this.owner?.loadedGraphics;this.addHandles([(0,l.on)(e,"change",(e=>{this._graphicsCollectionChanged(e),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}),{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")}}),{initial:!0}),(0,l.wB)((()=>this.effectiveUpdatePolicy),(e=>{null!=this.stageLayer&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===xo.ASYNC,e===xo.SYNC&&this.runTask(Ee.Bb)}),l.pc)]),this._frameTaskHandle=t.resourceController.scheduler.registerTask(Ee.W6.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this.addHandles((0,l.wB)((()=>this.layer.featureReduction),(()=>this._deconflictor.featureReductionChange()))),this.notifyChange("averageSymbolComplexity"),this.rendererChange(this.owner.renderer).catch((()=>{})),this._initializeAbortController=null}_abortInitialize(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=null)}destroy(){this._unusedSymbolsCache.destroy(),this._abortInitialize(),this._abortRendererChange(),this._abortElevationInfoChange(),this._frameTaskHandle.remove(),this._frameTaskHandle=Ee.nu,this._dataUpdateQueue.cancelAll(),this._updateQueue.cancelAll(),this.owner.view?.deconflictor?.removeGraphicsOwner(this),this.owner.view?.labeler?.removeGraphicsOwner(this),this._elevationAlignment=(0,ce.pR)(this._elevationAlignment),this._scaleVisibility=(0,ce.pR)(this._scaleVisibility),this._filterVisibility=(0,ce.pR)(this._filterVisibility),this._deconflictor=null,this._labeler=null,this._objectStates=(0,ce.pR)(this._objectStates),this.clear(),this._featureStore=(0,ce.pR)(this._featureStore),this._updatingPendingLoadedGraphicsChange=(0,ce.xt)(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=(0,ce.pR)(this._graphicStateTracking),this.stage&&(this.stageLayer=(0,ce.pR)(this.stageLayer),this.stage=null),this._set("owner",null);for(const e in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[e].reject(new le.A("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=(0,ce.xt)(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=(0,ce.pR)(this._propertiesPool),this._pendingUpdatesPool=null,this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=(0,ce.pR)(this._spatialIndex)}clear(){this._objectStates?.allGraphicsDeleted(),null!=this._graphicStateTracking&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((e=>e.destroy())),this._spatialIndex?.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(ce.pR),this._symbols.clear(),this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingUpdatesPool.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange("dataUpdating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed")}_initializeStage(e,t){this.stage=e._stage,this.stageLayer=new Co(this.stage,{pickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t);const i=this.stageLayer.events;i.on("transformationChanged",(e=>this.notifyGraphicGeometryChanged(e.graphicUid))),i.on("shaderTransformationChanged",(e=>this.notifyGraphicGeometryChanged(e.graphicUid))),i.on("visibilityChanged",(e=>this.notifyGraphicVisibilityChanged(e.graphicUid))),i.on("geometryAdded",(e=>this.notifyGraphicGeometryChanged(e.object.graphicUid))),i.on("geometryRemoved",(e=>this.notifyGraphicGeometryChanged(e.object.graphicUid))),i.on("attributesChanged",(e=>(0,It.b)(e.attribute)&&this.notifyGraphicGeometryChanged(e.object.graphicUid)))}notifyGraphicGeometryChanged(e){if(null==this._graphicStateTracking||null==e)return;const t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicGeometry(t)}notifyGraphicVisibilityChanged(e){if(null==this._graphicStateTracking||null==e)return;const t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicVisibility(t)}_updateLayerVisibility(){const e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this._numberOfGraphics>e*jy,i=!this.suspendedOrOutsideOfView&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.pickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.pickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())}_updateStageLayerVisibility(){this.stageLayer.visible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)}getGraphics3DGraphicById(e){return null!=e?this.graphics3DGraphics.get(e):void 0}getGraphics3DGraphicByObjectId(e){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}_getGraphicObjectID(e,t=this.owner.layer?.objectIdField){return(0,ki.RW)(e,t)}get graphics3DGraphicsByObjectID(){const e=this.owner.layer?.objectIdField;if(!e)return;const t=new Map;return this.graphics3DGraphics.forEach((i=>{if(!i)return;const r=i.graphic,s=this._getGraphicObjectID(r,e);null!=s&&t.set(s,i)})),t}get labelsEnabled(){return!(!this._labeler||!this._labeler.layerLabelsEnabled())}async updateLabelingInfo(e){const t=this._deconflictor&&this._deconflictor.labelingInfoChange(e),i=this._labeler&&this._labeler.labelingInfoChange(e);await Promise.allSettled([t,i])}updateVisibilityInfo(){this._deconflictor&&this._deconflictor.labelingInfoChange(),this._labeler&&this._labeler.visibilityInfoChange()}get symbolUpdateType(){if(this._pendingUpdates.size>0)return"unknown";let e=0,t=0;return(0,Bi.Bs)(this._symbols,((i,r)=>{if(null!=i){const s=i.getFastUpdateStatus();if(s.loading>0)return!0;this._graphicsBySymbol.has(r)&&(t+=s.fast,e+=s.slow)}return!1}))?"unknown":t>=0&&0===e?"fast":e>=0&&0===t?"slow":"mixed"}runTask(e){if(this._dataUpdateQueue.runTask(e),this._updateQueue.runTask(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("dataUpdating"),this.notifyChange("updatingRemaining"),!e.hasProgressed)return D_.G}setObjectIdVisibility(e,t){t?this._objectIdInvisibleSet.delete(e):this._objectIdInvisibleSet.add(e);const i=this._findGraphics3DGraphicByObjectId(e);null!=i&&this._updateUserVisibility(i)}_findGraphics3DGraphicByObjectId(e){return(0,Bi.$n)(this.graphics3DGraphics,(t=>this._getGraphicObjectID(t.graphic)===e))}_updateUserVisibility(e){if(null==e)return!1;const t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&(null==i||!this._objectIdInvisibleSet.has(i));return e.setVisibilityFlag(ys.GRAPHIC,_s.USER,r)}_whenGraphics3DGraphic(e){const t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);const i=this._whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;const r=(0,o.Tw)();return this._whenGraphics3DGraphicRequests[e.uid]=r,r.promise}async _boundsForGraphics3DGraphic(e,t){const i=this._viewSpatialReference,r=this.owner.view.renderSpatialReference,s=this.owner.view.basemapTerrain.spatialReference,n=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:null!=t&&!!t.useViewElevation,minDemResolution:null!=t?t.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:null,a=await e.getProjectedBoundingBox(((e,t,s)=>(0,k.projectBuffer)(e,r,t,e,i,t,s)),((e,t,r)=>(0,k.projectBuffer)(e,s,t,e,i,t,r)),n,t?.signal);if(!a)return null;const o=a.boundingBox;if(a.requiresDrapedElevation){const e=this.symbolCreationContext.elevationProvider;if(e){(0,q.gX)(o,Gy);const t=e.getElevation(Gy[0],Gy[1],0,i,"ground")??0;o[2]=Math.min(o[2],t),o[5]=Math.max(o[5],t)}}return{boundingBox:o,screenSpaceObjects:a.screenSpaceObjects}}async whenGraphicBounds(e,t){await(0,l.C_)((()=>this.owner?.loadedGraphics));const i=this.owner.layer?.objectIdField,r=this.owner.loadedGraphics.find((t=>t===e||null!=i&&null!=t.attributes&&e.attributes&&t.attributes[i]===e.attributes[i]));if(!r)throw new le.A("internal:graphic-not-part-of-view","Graphic is not part of this view");const s=await this._whenGraphics3DGraphic(r);return this._boundsForGraphics3DGraphic(s,t)}computeAttachmentOrigin(e,t){const i=this.graphics3DGraphics.get(e.uid);if(!i)return null;const r=i.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;(0,M.s)(Wy,0,0,0);let s=0;if(r.render.num>0){if(!(0,Z.F)(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,ky,t))return null;(0,M.g)(Wy,Wy,ky),s++}if(r.draped.num>0){const[e,i]=r.draped.origin,n=this._viewElevationProvider.getElevation(e,i,"ground")??0;if((0,M.s)(ky,e,i,n),!(0,Z.F)(ky,this._viewElevationProvider.spatialReference,ky,t))return null;(0,M.g)(Wy,Wy,ky),s++}return s>1&&(0,M.h)(Wy,Wy,1/s),new Fy.A({x:Wy[0],y:Wy[1],z:Wy[2],spatialReference:t})}getSymbolLayerSize(e,t){const i=this._symbols.get(e.id);if(null==i)throw new le.A("internal:symbol-not-part-of-view","Symbol is not part of this view");const r=e.symbolLayers.indexOf(t);if(-1===r)throw new le.A("internal:missing-symbol-layer","Symbol layer is not in symbol");const s=i.getSymbolLayerSize(r);if(null==s)throw new le.A("internal:missing-size","Symbol layer has no valid size");return s}_graphicsCollectionChanged(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}graphicUpdateHandler(e){const t=e.graphic.uid,i=this.graphics3DGraphics.get(t);if(null!=i||null!=this._graphicsWithoutSymbol.get(t))switch(e.property){case"visible":this._graphicUpdateVisibleHandler(i);break;case"geometry":this._graphicUpdateGeometryHandler(i,e);break;case"symbol":this._graphicUpdateSymbolHandler(i,e);break;case"attributes":break;case"origin-transform":this._graphicUpdateTransformHandler(i,e)}}_graphicUpdateGeometryHandler(e,t){this._graphicUpdateGeometryOrTransformHandler(e,t,(()=>null!=t.newValue&&null!=e&&e.graphics3DSymbol.updateGeometry(e,t.newValue)));const i=t.graphic.geometry;null!=i&&this._expandComputedExtent(i)}_graphicUpdateTransformHandler(e,t){const i=t.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(e,t,(()=>null!=t.newValue&&null!=e&&null!=i&&e.graphics3DSymbol.updateTransform(e,i.spatialReference,t.newValue,t.action)))}_graphicUpdateGeometryOrTransformHandler(e,t,i){if(null!=t.graphic.geometry)if(null!=e)i()||this._recreateGraphic(e.graphic);else{const e=t.graphic.symbol?.id;if(e){const t=this._symbols.get(e);if(null!=t&&t.loadStatus===fn.LOADING)return}this._recreateGraphic(t.graphic)}else this._recreateGraphic(t.graphic)}_graphicUpdateSymbolHandler(e,t){const i=t.graphic,r=null!=e?e.graphics3DSymbol:null!=t.oldValue?this._symbols.get(t.oldValue.id):null;if(null==r||null==t.newValue)return void this._recreateGraphic(i);const s=r.symbol,n=this._getConvertedSymbol(t.newValue);if(null!=n&&(n.type!==s.type||"web-style"===n.type)||"web-style"===s.type)return void this._recreateGraphic(i);const a=this._graphicsBySymbol.get(s.id);if(a&&1!==a.size)return void this._recreateGraphic(i);const o=(0,Ui.Ui)(s,n);if(null==o)return void this._updateSymbolMapping(s.id,n);const l={diff:o,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),!(0,Ui.Im)(l.diff))return void this._recreateGraphic(i);const c=this._getRenderingInfo(i);if(null==c)return void this._recreateGraphic(i);const h=r.extentPadding;for(const e of l.symbolStatePatches)e();if(h!==r.extentPadding&&this._recomputeExtentPadding(),null!=e)for(const t of l.graphics3DGraphicPatches)t(e,c);this._updateSymbolMapping(s.id,n)}_graphicUpdateVisibleHandler(e){this._updateUserVisibility(e)&&(this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}recreateGraphics(e){this._suspendSymbolCleanup=!0,this.remove(e),this.add(e),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===xo.SYNC&&this._cleanupSymbols()}_recreateGraphic(e){this.recreateGraphics([e])}_beginGraphicUpdate(e){const t=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(e.uid,t),1===this._graphicsWaitingForSymbol.size&&this.notifyChange("dataUpdating"),t}_endGraphicUpdate(e){e&&(this._graphicsWaitingForSymbol.delete(e.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating")))}_recomputeExtentPadding(){let e=0;this._symbols.forEach((t=>{null!=t&&(e=Math.max(e,t.extentPadding))})),this._set("extentPadding",e)}_expandComputedExtent(e){const t=Uy,i=e.spatialReference;(0,ki.w9)(e,t);const r=this._viewSpatialReference,s=My.tmpVec;if((0,G.aI)(i,r)||(0,ji.L)(t[0],t[1],0,i,s,r)&&(t[0]=s[0],t[1]=s[1],(0,ji.L)(t[3],t[4],0,i,s,r),t[3]=s[0],t[4]=s[1]),!(isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])))return;const n=this.computedExtent;let a=null;const o=isFinite(t[2])&&isFinite(t[5]),l=o&&(null==n?.zmin||t[2]<n.zmin),c=o&&(null==n?.zmax||t[5]>n.zmax);n?(t[0]<n.xmin||t[1]<n.ymin||t[3]>n.xmax||t[4]>n.ymax||l||c)&&(a=this._propertiesPool.get("computedExtent"),a.xmin=Math.min(t[0],n.xmin),a.ymin=Math.min(t[1],n.ymin),a.xmax=Math.max(t[3],n.xmax),a.ymax=Math.max(t[4],n.ymax),a.spatialReference=r):(a=this._propertiesPool.get("computedExtent"),a.xmin=t[0],a.ymin=t[1],a.xmax=t[3],a.ymax=t[4],a.spatialReference=r),a&&(l&&(a.zmin=t[2]),c&&(a.zmax=t[5]),this._set("computedExtent",a))}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}async elevationInfoChange(){this._abortElevationInfoChange();const e=new AbortController;this._elevationInfoChangeAbortController=e;const t=ni(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await ii(t,this._viewSpatialReference,e.signal,a.A.getLogger(this)),(0,o.Te)(e.signal),this._elevationInfoChangeAbortController=null,this._labeler?.elevationInfoChange(),this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("elevationInfo",t)?t.forEach((e=>{const t=e.graphic,i=e.labelLayers;for(const e of i)e.graphics3DSymbolLayer.updateGraphicElevationContext(t,e)})):this._recreateSymbol(i)})),this.updateStageLayerElevationProvider(),this._elevationAlignment?.elevationInfoChange()}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,ce.WD)(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new Ry({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){this.clear(),null!=this._filterVisibility&&this._filterVisibility.clear(),this._labeler?.reset(),this._deconflictor?.clear(),this._elevationAlignment?.clear(),this.stageLayer?.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,ce.WD)(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(e=!1){if(!this._startCreateGraphics)return;const{loadedGraphics:t,view:i}=this.owner,r=i.basemapTerrain.tilingScheme&&t?.length?t.toArray():null;!e&&r||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),r&&(e?this.add(r):this.recreateGraphics(r))}_recreateSymbol(e){const t=this._graphicsBySymbol.get(e),i=[];t&&(t.forEach(((e,t)=>{const r=e.usedMemory;this._conditionalRemove(e,t),this._spatialIndex?.remove(e),i.push(e.graphic),e.destroy(),this._removeGraphics3DGraphic(t,r),this._updateLayerVisibility(),this._featureStore.events.emit("changed")})),this._graphicsBySymbol.set(e,new Map));const r=this._symbols.get(e);(0,ce.pR)(r),this._symbols.delete(e),this.add(i)}_recreateGraphicsForSymbol(e){const t=this._graphicsBySymbol.get(e);if(t){const e=[];t.forEach((t=>e.push(t.graphic))),this.recreateGraphics(e)}}_conditionalRemove(e,t){this._graphicsDrapedUids.delete(t),this._objectStates?.removeGraphic(e),this._labeler?.removeGraphic(e),this._deconflictor?.removeGraphic(e),null!=this._graphicStateTracking&&this._graphicStateTracking.removeGraphic(e)}add(e){e&&0!==e.length&&(this.owner.view.basemapTerrain?.tilingScheme?(this._updatePolicyForGraphics(e)===xo.ASYNC?this._addDelayed(e):this._addImmediate(e),this.notifyChange("dataUpdating")):a.A.getLogger(this).error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(e){if(this.effectiveUpdatePolicy===xo.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const t of e)if(null!=t.geometry&&"mesh"===t.geometry.type&&!t.geometry.loaded)return xo.ASYNC;return this.effectiveUpdatePolicy}_addImmediate(e){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(const t of e)this._addGraphic(t,this._getRenderingInfo(t,a.A.getLogger(this)),xo.SYNC);this._cleanupSymbols(),this._labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()}_addDelayed(e){for(const t of e){const e=t.uid;let i=this._pendingUpdates.get(e);i?i.add?i.state!==By.NEW&&i.abortController?.abort():this._pendingAdds++:(i=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(e,i)),i.add=t}this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}remove(e){this.effectiveUpdatePolicy===xo.ASYNC?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("dataUpdating")}_removeImmediate(e){for(const t of e)this._removeGraphic(t);this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}_removeDelayed(e){for(const t of e){const e=t.uid,i=this._pendingUpdates.get(e);if(i)i.add&&(i.remove?i.add=null:this._pendingUpdates.delete(e),i.state===By.LOADING&&i.abortController?.abort(),this._pendingAdds--);else{const i=this._pendingUpdatesPool.pushNew();i.remove=t,this._pendingUpdates.set(e,i),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}0===this._pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}_finishPendingUpdates(){this._pendingUpdatesPool.clear(),this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&a.A.getLogger(this).warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}_applyPendingUpdates(e){if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,0===this._pendingUpdates.size&&this._spatialIndex?.updating)return this._spatialIndex.update(),void e.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(const[t,i]of this._pendingUpdates){if(e.done){this._applyPendingRemovesFirst=!0;break}if(i.remove&&!i.add&&(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(i.remove),i.remove=null,this._pendingUpdates.delete(t),0===this._pendingRemoves))break}}for(const[t,i]of this._pendingUpdates){if(e.done)break;i.add&&i.state===By.NEW&&this._processPendingUpdateNew(i);let r=this.effectiveUpdatePolicy;if(!i.remove||i.add&&i.state!==By.READY||(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(i.remove),i.remove=null,r=xo.SYNC),i.add)switch(i.state){case By.READY:this._addGraphic(i.add,i.renderingInfo,r),i.add=null,this._pendingAdds--,e.madeProgress();break;case By.REJECTED:i.add=null,this._pendingAdds--;case By.LOADING:}null==i.remove&&null==i.add&&this._pendingUpdates.delete(t)}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("dataUpdating"))}_processPendingUpdateNew(e){if(!e.add)return void(e.state=By.READY);const t=e.add.geometry;null==t||"mesh"!==t.type||t.loaded?this._processPendingUpdateNewRenderingInfo(e):this._processPendingUpdateNewMesh(e,t)}async _processPendingUpdateNewMesh(e,t){e.state=By.LOADING,e.abortController=new AbortController;const i=e.abortController.signal;try{await t.load({signal:i})}catch(t){return this._processPendingUpdateNewError(e,t)}e.abortController=null,this._processPendingUpdateNewRenderingInfo(e)}_processPendingUpdateNewError(e,t){e.abortController=null,(0,o.zf)(t)?e.state=By.NEW:e.state=By.REJECTED}async _processPendingUpdateNewRenderingInfo(e){if(null==this.layer.renderer||"dictionary"!==this.layer.renderer.type)return e.renderingInfo=this._getRenderingInfo(e.add,a.A.getLogger(this)),void(e.state=By.READY);e.state=By.LOADING,e.abortController=new AbortController;let t=null;try{t=await this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal})}catch(t){return e.abortController=null,void((0,o.zf)(t)?e.state=By.NEW:e.state=By.REJECTED)}null==t?.symbol?(this._symbolWarningLogged||(this._symbolWarningLogged=!0,a.A.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),e.renderingInfo=null):e.renderingInfo=t,e.state=By.READY}_addGraphic(e,t,i){if(this._graphicsWithoutSymbol.set(e.uid,e),null==t?.symbol||!(0,ki.N3)(e))return;if(null!=this.stage.renderView.objectAndLayerIdRenderHelper&&this.setUidToIdOnAdd){const t=(0,Vi.ns)(this.owner.view.map,this.layer.uid);this.stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(e.objectId,e.uid,this.layer.id,this.layer.uid,!!this.layer.popupEnabled&&!t&&(0,Dy.d0)(this.layer,this.owner.view.popup?.defaultPopupTemplateEnabled))}const r=t.symbol,s=this.getOrCreateGraphics3DSymbol(r,t.renderer);if(null==s)return;this._expandComputedExtent(e.geometry);const n=this._beginGraphicUpdate(e),a=new Ts(e,t,this.layer);let l=!1;const c=e=>{e===s.symbol.id&&(l=!0)};this._whenSymbolRemoved.push(c);const h=()=>{if(--this._loadingSymbols,!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(c),this._graphicsWaitingForSymbol.get(e.uid)!==n||l||s.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==s.symbol.id)--s.referenced,this._cleanupSymbols();else{const t=this._createGraphics3DGraphic(s,a);this._spatialIndex&&null!=t&&this._spatialIndex.add(t),--s.referenced,this._endGraphicUpdate(e)}this._featureStore.events.emit("changed"),this._labeler&&this.owner.view.labeler.setDirty()}},d=t=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(c),l||((0,o.zf)(t)?this.add([e]):s.destroyed||this._endGraphicUpdate(e)))};++this._loadingSymbols,i===xo.ASYNC?s.load((()=>this._dataUpdateQueue.push(h,null)),(e=>this._dataUpdateQueue.push((()=>d(e)),null))):s.load(h,d)}_removeGraphic(e){const t=e.uid,i=this.graphics3DGraphics.get(t);if(i){i.graphics3DSymbol.onRemoveGraphic(i);const e=i.usedMemory,r=i.isElevationSource;this._conditionalRemove(i,t),this._spatialIndex?.remove(i);const s=i.graphics3DSymbol.symbol.id;this._graphicsBySymbol.get(s)?.delete(t),this._graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,e,r),i.destroy(),this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(t),this._graphicsWaitingForSymbol.delete(t),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating"))}_hasLabelingContext(e){if(e instanceof Ly.A||e instanceof Ny.A){const t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some((t=>t.symbol===e))}return!1}_hasValidSymbolCreationContext(e){return!(e instanceof Ly.A&&!this._hasLabelingContext(e)&&(a.A.getLogger(this).error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),1))}_getRenderingInfo(e,t){const i=e.geometry;if(null==i)return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!(0,Hi.canProjectWithoutEngine)(i.spatialReference,this._viewSpatialReference))return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&null!=e.symbol)return t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?Jt(e,this.layer):e;let s;return s=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||null!=this.currentRenderer)?this.owner.getRenderingInfo(r,this.currentRenderer,this._arcadeOnDemand):{symbol:r.symbol||nr(r.geometry)},null==s?.symbol?(t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):s}_getRenderingInfoAsync(e,t){if(null==e.geometry)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,a.A.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&null!=e.symbol)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,a.A.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const i=this.rendererHasGeometryOperations?Jt(e,this.layer):e;return this.owner.getRenderingInfoAsync(i,this.currentRenderer,this._arcadeOnDemand,t)}_createGraphics3DSymbol(e,t){if(!this._hasValidSymbolCreationContext(e))return null;const i=this._getConvertedSymbol(e);if(!i)return null;let r;if(null!=t&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){const e=(0,ar.t)(t.backgroundFillSymbol,{ignoreDrivers:!0});null!=e.symbol&&"web-style"!==e.symbol.type&&"cim"!==e.symbol.type&&(r=e.symbol.symbolLayers)}const s=function(e,t,i){return"point-3d"===e.type?new my(e,t,i):new fy(e,t,i)}(i,this.symbolCreationContext,r);return s.load((()=>{const e=s.extentPadding;e>this.extentPadding&&this._set("extentPadding",e),this.notifyChange("averageSymbolComplexity")}),(()=>{})),s}getOrCreateGraphics3DSymbol(e,t){let i=this._symbols.get(e.id);if(void 0===i){const r=this._unusedSymbolsCache.pop(e.id);i=null!=r?r:e instanceof Vy.A?new _y(e,(e=>this._dataUpdateQueue.push(e,null)),(e=>this._createGraphics3DSymbol(e,t))):this._createGraphics3DSymbol(e,t),this._symbols.set(e.id,i)}return null!=i&&++i.referenced,i}trackGraphicState(e){return null==this._graphicStateTracking&&(this._graphicStateTracking=new vy(this)),this._graphicStateTracking.add(e)}_addGraphics3DGraphic(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this._numberOfGraphics++,e.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(e,t,i=!1){this._usedMemory-=t,this.graphics3DGraphics.delete(e),this._numberOfGraphics--,i&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(e,t){const i=t.graphic;if(this._graphicsWithoutSymbol.delete(i.uid),!this._symbols.has(e.symbol.id))return this.add([i]),null;if(this.graphics3DGraphics.has(i.uid))return null;const r=e.createGraphics3DGraphic(t);if(null==r)return null;this._addGraphics3DGraphic(r);const s=e.symbol.id;if(this._graphicsBySymbol.has(s)||this._graphicsBySymbol.set(s,new Map),this._graphicsBySymbol.get(s).set(i.uid,r),r.isDraped&&this._graphicsDrapedUids.add(i.uid),r.centroid=null,null!=i.geometry&&"point"!==i.geometry.type&&(r.centroid=Qs(i.geometry,this._viewSpatialReference)),this._updateUserVisibility(r),null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(r),null!=this._filterVisibility){const{defaultVisibility:e}=this._filterVisibility;r.setVisibilityFlag(ys.GRAPHIC,_s.FILTER,e),e||this._filterVisibility.reapply()}this._deconflictor?.addGraphic(r),this._labeler?.addGraphic(r),this._objectStates?.addGraphic(r),this._deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,r),r.initialize(this.stageLayer,this.owner),null!=this._graphicStateTracking&&this._graphicStateTracking.addGraphic(r);const n=this._whenGraphics3DGraphicRequests[i.uid];return n&&(delete this._whenGraphics3DGraphicRequests[i.uid],n.resolve(r)),r}_abortRendererChange(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)}async rendererChange(e){if(this._abortRendererChange(),e!==this.currentRenderer)if(this._validateRenderer(e),null==e&&this._currentRendererChange(null,!1),(0,Zi.l)(e))if(null!=e&&e.arcadeRequired){const t=new AbortController;this._rendererChangeAbortController=t;const{arcadeUtils:i}=await this._ensureArcade();(0,o.Te)(t);const r=i.hasGeometryOperations(e);r&&(await i.enableGeometryOperations(),(0,o.Te)(t)),this.effectiveUpdatePolicy===xo.ASYNC?await this._updateQueue.push((()=>this._currentRendererChange(e,r)),t.signal):this._currentRendererChange(e,r),this._rendererChangeAbortController=null}else if(this.effectiveUpdatePolicy===xo.ASYNC){const t=new AbortController;this._rendererChangeAbortController=t,await this._updateQueue.push((()=>this._currentRendererChange(e,!1)),t.signal),this._rendererChangeAbortController=null}else this._currentRendererChange(e,!1);else this._currentRendererChange(e,!1)}async _ensureArcade(){return null==this._arcadeOnDemand?(this._arcadeOnDemand=await(0,ti.lw)(),this._arcadeOnDemand):this._arcadeOnDemand}_currentRendererChange(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=this._arcadeOnDemand;const i=this.symbolCreationContext.renderer;if(e===i)return;if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),null==e)return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const r=(0,Ui.Ui)(i,e);this._updateUnchangedSymbolMappings(r,e,i),this.symbolCreationContext.renderer=e,null!=r&&("complete"===r.type?this.recreateAllGraphicsAndSymbols():"partial"===r.type&&(this._applyRendererDiff(r,e,i)?this._labeler?.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}_diffHasSymbolChange(e){for(const t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1}_applySymbolSetDiff(e,t,i){e=e||[],t=t||[];const r=[];for(const s of t){const t=this._graphicsBySymbol.get(s.id);t&&t.forEach(((n,a)=>{const o=n.graphic,l=this.layer instanceof Wi.A?this.layer:null,c=this._arcadeOnDemand;if(s===i.defaultSymbol&&i.getSymbol(Jt(o,l),{arcade:c})===i.defaultSymbol)return;const h=n.usedMemory;e.length||i.defaultSymbol?r.push(o):this._graphicsWithoutSymbol.set(a,o);const d=this.graphics3DGraphics.get(a);this._conditionalRemove(d,a),n.destroy(),t.delete(a),this._removeGraphics3DGraphic(a,h),this._updateLayerVisibility()})),this._whenSymbolRemoved.forAll((e=>e(s.id)))}(e.length||r.length)&&(this._graphicsWithoutSymbol.forEach((e=>r.push(e))),this._graphicsWithoutSymbol.clear(),this.add(r)),this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}_applyUniqueValueRendererDiff(e,t,i){const r=e.diff.defaultSymbol,s=e.diff.uniqueValueInfos;if(r||s){const n=s?s.added.map((e=>e.symbol)).filter(b.Ru):[],a=s?s.removed.map((e=>e.symbol)).filter(b.Ru):[];if(s)for(let e=0;e<s.changed.length;e++)n.push(s.changed[e].newValue.symbol),a.push(s.changed[e].oldValue.symbol);return r?(i.defaultSymbol&&a.push(i.defaultSymbol),t.defaultSymbol&&n.push(t.defaultSymbol)):i.defaultSymbol&&n.length&&a.push(t.defaultSymbol),this._applySymbolSetDiff(n,a,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(e,t,i){if("unique-value"!==t?.type||"unique-value"!==i?.type||null!=e&&"partial"!==e.type)return[];const r=e=>null!=e?e.id:null,s=e&&e.diff,n=s?.defaultSymbol,a=s&&s.uniqueValueInfos;let o;if(a)o=a.unchanged.map((e=>({oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)})));else{o=[];for(const e of i.uniqueValueInfos??[]){const i=r(e.symbol),s=t.uniqueValueInfos?.find((t=>t.value===e.value));s&&i!==r(s.symbol)&&o.push({oldId:i,newId:r(s.symbol)})}}return!n&&i.defaultSymbol&&o.push({oldId:r(i.defaultSymbol),newId:r(t.defaultSymbol)}),o}_updateSymbolMapping(e,t){const i=null!=t&&t?"string"==typeof t?t:t.id:null;if(null==e||e===i)return;const r=this._graphicsBySymbol.get(e);this._graphicsBySymbol.delete(e),void 0!==r&&this._graphicsBySymbol.set(i,r);const s=this._symbols.get(e);if(void 0!==s&&(this._symbols.delete(e),this._symbols.set(i,s),null!=s)){const e="string"==typeof t?null:t;null!=e?s.symbol=e:s.symbol.id=i}}_updateUnchangedSymbolMappings(e,t,i){const r=this._calculateUnchangedSymbolMapping(e,t,i);for(const{oldId:e,newId:t}of r)this._updateSymbolMapping(e,t)}_applyRendererDiff(e,t,i){if(this._diffHasSymbolChange(e))return!1;if(t instanceof zi.A&&i instanceof zi.A&&this._applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)return!0;for(const[i]of this._graphicsBySymbol){const r=this._symbols.get(i);if(null!=r)switch(r.applyRendererDiff(e,t)){case pn.RecreateSymbol:this._recreateSymbol(i);break;case pn.RecreateGraphics:this._recreateGraphicsForSymbol(i);case pn.FastUpdate:}}return!0}opacityChange(){this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("opacity",t))),this._updateStageLayerVisibility()}_slicePlaneEnabledChange(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.sliceable=e,this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("slicePlaneEnabled",t))),this._deconflictor&&this._deconflictor.slicePlaneEnabledChange(),this._labeler&&this._labeler.slicePlaneEnabledChange())}_physicalBasedRenderingChange(e){this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("physicalBasedRenderingEnabled",t)||this._recreateSymbol(i)}))}_skipHighSymbolLoDsChange(e){this.symbolCreationContext.skipHighSymbolLods=e,this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("skipHighSymbolLods",t)||this._recreateSymbol(i)}))}_pixelRatioChange(){this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("pixelRatio",t)||this._recreateSymbol(i)}))}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=(0,c._)((()=>{this._updatingPendingLoadedGraphicsChange=null}))}setClippingExtent(e,t){const i=this.symbolCreationContext.clippingExtent,r=(0,$.vt)();return bi(e,r,t)?this.symbolCreationContext.clippingExtent=(0,q.Jt)((0,q.vt)(),r):this.symbolCreationContext.clippingExtent=null,!(0,q.aI)(this.symbolCreationContext.clippingExtent,i)}modifyGraphics3DGraphicVisibilities(e){if(this.destroyed)return;let t=!1;this.graphics3DGraphics.forEach((i=>{e(i)&&(t=!0)})),t&&(this.owner.view.labeler?.setDirty(),this.owner.view.deconflictor?.setDirty())}forEachGraphics3DSymbol(e){for(const[t,i]of this._symbols){if(null==i)return;e(i,this._graphicsBySymbol.get(t)||Zy,t)}}updateAllGraphicsVisibility(){null!=this._filterVisibility&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities((e=>{const t=this._updateUserVisibility(e),i=null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(e);return t||i}))}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(ys.GRAPHIC,_s.USER,!1)))}_validateRenderer(e){const t=(0,Zi.b)(e,{geometryType:this.layer?.geometryType});if(t){const e=`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`;a.A.getLogger(this).warn(e,t.message)}}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let e=!1;this._symbols.forEach(((t,i)=>{if(null==t||t.referenced>0)return;const r=this._graphicsBySymbol.get(i);r&&0!==r.size||(this._graphicsBySymbol.delete(i),this._symbols.delete(i),this._unusedSymbolsCache.put(i,t,function(e){return 2216+4096*e.symbolLayers.length+e.complexity.memory.resourceBytes}(t),he.Ti),e=!0)})),e&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}get test(){return{snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this._symbols.keys()].sort(),graphicsBySymbol:[...this._graphicsBySymbol.keys()].sort().map((e=>({symbolId:e,graphics:[...this._graphicsBySymbol.get(e).keys()].sort()}))),graphicsWithoutSymbol:[...this._graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this._graphicsDrapedUids].sort(),pendingUpdates:this._pendingUpdates}),symbols:this._symbols,filterVisibility:this._filterVisibility,numPending:this._pendingUpdates.size,forceUpdatePolicy:e=>{this._forcedUpdatePolicy=e}}}get performanceInfo(){return new yy(this.graphics3DGraphics.size,this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}};var By;zy.tmpVec=(0,I.vt)(),(0,r._)([(0,h.MZ)({readOnly:!0})],zy.prototype,"computedExtent",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"currentRenderer",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"rendererHasGeometryOperations",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_frameTaskHandle",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_dataUpdateQueue",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_updateQueue",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],zy.prototype,"_viewSpatialReference",null),(0,r._)([(0,h.MZ)()],zy.prototype,"_rendererChangeAbortController",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_elevationInfoChangeAbortController",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_initializeAbortController",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_elevationAlignment",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_scaleVisibility",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_filterVisibility",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_initializePromise",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_spatialIndex",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],zy.prototype,"extentPadding",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_updatingPendingLoadedGraphicsChange",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_featureStore",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_deconflictor",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_labeler",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_objectStates",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_loadingSymbols",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"preferredUpdatePolicy",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_forcedUpdatePolicy",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],zy.prototype,"effectiveUpdatePolicy",null),(0,r._)([(0,h.MZ)({constructOnly:!0})],zy.prototype,"elevationFeatureExpressionEnabled",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],zy.prototype,"owner",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],zy.prototype,"layer",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],zy.prototype,"graphicSymbolSupported",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],zy.prototype,"getRenderingInfoWithoutRenderer",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],zy.prototype,"componentFactories",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],zy.prototype,"setUidToIdOnAdd",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"featureStore",null),(0,r._)([(0,h.MZ)()],zy.prototype,"initializePromise",null),(0,r._)([(0,h.MZ)()],zy.prototype,"scaleVisibility",null),(0,r._)([(0,h.MZ)()],zy.prototype,"elevationAlignment",null),(0,r._)([(0,h.MZ)()],zy.prototype,"objectStates",null),(0,r._)([(0,h.MZ)()],zy.prototype,"filterVisibility",null),(0,r._)([(0,h.MZ)({readOnly:!0})],zy.prototype,"updating",null),(0,r._)([(0,h.MZ)({readOnly:!0})],zy.prototype,"dataUpdating",null),(0,r._)([(0,h.MZ)({readOnly:!0})],zy.prototype,"running",null),(0,r._)([(0,h.MZ)({readOnly:!0})],zy.prototype,"suspendedOrOutsideOfView",null),(0,r._)([(0,h.MZ)({readOnly:!0,dependsOn:[]})],zy.prototype,"updatingRemaining",null),(0,r._)([(0,h.MZ)({readOnly:!0})],zy.prototype,"displayFeatureLimit",null),(0,r._)([(0,h.MZ)({readOnly:!0,dependsOn:[]})],zy.prototype,"averageSymbolComplexity",null),(0,r._)([(0,h.MZ)({constructOnly:!0})],zy.prototype,"hasZ",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],zy.prototype,"hasM",void 0),(0,r._)([(0,h.MZ)()],zy.prototype,"_objectIdField",null),zy=My=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Graphics3DCore")],zy),function(e){e[e.NEW=0]="NEW",e[e.LOADING=1]="LOADING",e[e.READY=2]="READY",e[e.REJECTED=3]="REJECTED"}(By||(By={}));class Hy{constructor(){this.add=null,this.renderingInfo=null,this.state=By.NEW,this.abortController=null,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=By.NEW,this.abortController=null,this.remove=null}}const jy=10,Wy=(0,I.vt)(),ky=(0,I.vt)(),Zy=new Map;let qy=class extends n.A{constructor(e){super(e),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this._updatingHandles=new L.U,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0}initialize(){this.updateScaleRangeActive();const e=this.graphicsCoreOwner.view.resourceController.scheduler;this.addHandles(e.registerTask(Ee.W6.SCALE_VISIBILITY,this)),this._updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this.layerMinMaxScaleChangeHandler()))}destroy(){this._updatingHandles.destroy(),this.removeHandles(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}get updating(){return this._dirty||this._updatingHandles.updating}_setDirty(){this._dirty=!0}setExtent(e){const t=this.graphicsCoreOwner.view.spatialReference,i=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(t===i)this._extent=e??null;else{const r=(0,$.vt)();ee(e,t,r,i)?this._extent=r:this._extent=null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const e=this.layer,t=e.effectiveScaleRange;let i=this.layerScaleEnabled&&null!=t&&$y(t.minScale,t.maxScale);e.labelingInfo&&!i&&(i=e.labelingInfo.some((e=>e&&$y(e.minScale??0,e.maxScale??0))));const r=this._scaleRangeActive!==i;return this._scaleRangeActive=i,i&&!this.hasHandles(Qy)&&this.basemapTerrain?(this.addHandles(this.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),Qy),this.layerScaleEnabled&&this.addHandles(this.basemapTerrain.on("tiles-visibility-changed",(()=>this._setDirty())),Qy)):!i&&this.hasHandles(Qy)&&this.removeHandles(Qy),r}get running(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(e){const t=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&t&&t.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return D_.G;{this._layerScaleRangeVisibilityQuery=!0;const{minScale:e,maxScale:i}=this.layer.effectiveScaleRange;t.queryVisibleScaleRange(this._extent,e,i,(e=>this._finishUpdate(e)))}}else this._finishUpdate(!0);e.madeProgress()}_finishUpdate(e){this._layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._dirty=!1}_visibleAtLayerScale(e){const t=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||(0,Ri.JU)(e,t.minScale||0,t.maxScale||0)}_visibleAtLabelScale(e,t){return(0,Ri.JU)(e,t.minScale||0,t.maxScale||0)}_graphicScale(e){let t;return null!=e.centroid?t=e.centroid:null!=e.graphic.geometry&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(t):1:null}_graphicVisible(e){if(!this.layerScaleEnabled)return!0;const t=this._graphicScale(e);return this._visibleAtLayerScale(t)}updateVisibility(e){if(this._scaleRangeActive){const t=this._graphicVisible(e);return e.setVisibilityFlag(ys.GRAPHIC,_s.SCALE_RANGE,t)}return!1}updateGraphicLabelScaleVisibility(e){if(!this._scaleRangeActive)return!1;if(!e.labelLayers||0===e.labelLayers.length)return!1;const t=this._graphicScale(e),i=this._updateLabelScaleVisibility(e,t);return i&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty()),i}_updateLabelScaleVisibility(e,t){if(!e.labelLayers||0===e.labelLayers.length)return!1;const i=e.labelLayers[0]._labelClass;if(null!=i?.minScale&&null!=i.maxScale){const r=this._visibleAtLabelScale(t,i);if(e.setVisibilityFlag(ys.LABEL,_s.SCALE_RANGE,r))return!0}return!1}_scaleUpdateHandler(e){if(this._setDirty(),!this.graphicsCore.visible)return;const t=e.extent,i=e.scale,r=this._visibleAtLayerScale(i);let s=!1;const n=this.graphicsCoreOwner.view.spatialReference,o=e.spatialReference;if(null==o)return void a.A.getLogger(this).error("scaleUpdate: Internal error, no SpatialReference given for tiles");const l=!o.equals(n);if(l&&!ee(t,o,Jy,n))return void a.A.getLogger(this).error("scaleUpdate: Internal error, cannot project AABR from "+o+" to wkid "+n);const c=l?Jy:t;this.queryGraphicUIDsInExtent(c,n,(e=>{const n=this.graphicsCore.getGraphics3DGraphicById(e);if(null==n)return;const a=n.centroid;null!=a&&(t[0]>a.x||t[1]>a.y||t[2]<a.x||t[3]<a.y)||(n.setVisibilityFlag(ys.GRAPHIC,_s.SCALE_RANGE,r)&&(s=!0),this._updateLabelScaleVisibility(n,i)&&(s=!0))})),s&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(ys.GRAPHIC,_s.SCALE_RANGE,!0))):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}};function $y(e,t){return e>0||t>0}(0,r._)([(0,h.MZ)()],qy.prototype,"graphicsCoreOwner",void 0),(0,r._)([(0,h.MZ)()],qy.prototype,"layer",void 0),(0,r._)([(0,h.MZ)()],qy.prototype,"queryGraphicUIDsInExtent",void 0),(0,r._)([(0,h.MZ)()],qy.prototype,"graphicsCore",void 0),(0,r._)([(0,h.MZ)()],qy.prototype,"basemapTerrain",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],qy.prototype,"layerScaleEnabled",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],qy.prototype,"suspended",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],qy.prototype,"updating",null),(0,r._)([(0,h.MZ)()],qy.prototype,"_dirty",void 0),qy=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],qy);const Qy="terrain-events",Jy=(0,$.vt)();function Yy(e,t,i,r,s){const n=t.getComponentAabb(i,e,Xy),a=t.getObjectTransform(i);for(let e=0;e<8;++e)Ky[0]=1&e?n[0]:n[3],Ky[1]=2&e?n[1]:n[4],Ky[2]=4&e?n[2]:n[5],(0,M.t)(Ky,Ky,a.rotationScale),(0,M.g)(Ky,Ky,a.position),r[s++]=Ky[0],r[s++]=Ky[1],r[s++]=Ky[2];return r}const Xy=(0,q.vt)(),Ky=(0,I.vt)();class ev extends xs.A{constructor(){super(...arguments),this._map=new Map}clear(){if(this._map.size>0){const e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}}get length(){return this._map.size}get(e){return this._map.get(e)}addMany(e){if(0===e.length)return;const t=new Set;for(let i=0;i<e.length;i++){const r=e[i],s=r.objectId,n=this._map.get(s);n?(t.add(s),r!==n&&(e[i]=n),n.refCount||(n.refCount=0),++n.refCount):(r.refCount=1,this._map.set(s,r))}const i=t.size>0?e.filter((e=>!t.has(e.objectId))):e;i.length>0&&this.emit("change",{added:i,removed:[]})}removeMany(e){const t=[];for(const i of e){const e=i.objectId,r=this._map.get(e);null!=r&&(!r.refCount||--r.refCount<=0)&&(this._map.delete(e),t.push(i))}t.length>0&&this.emit("change",{added:[],removed:t})}removeManyByObjectId(e){const t=[];for(const i of e){const e=this._map.get(i);null!=e&&(!e.refCount||--e.refCount<=0)&&(this._map.delete(i),t.push(e))}t.length>0&&this.emit("change",{added:[],removed:t})}toArray(){return[...this._map.values()]}find(e){let t;return(0,Bi.Bs)(this._map,(i=>!!e(i)&&(t=i,!0))),t}forEach(e){this._map.forEach((t=>e(t)))}}class tv extends xs.A{constructor(e){super(),this._limit=e,this._all=new ev,this._active=new rv(this),this._pending=new Map,this._handle=this._all.on("change",(e=>this._handleChanges(e)))}destroy(){this._handle.remove()}get length(){return this._active.length}toArray(){return this._active.toArray()}find(e){return this._active.find(e)}forEach(e){this._active.forEach(e)}addMany(e){this._all.addMany(e)}removeManyByObjectId(e){this._all.removeManyByObjectId(e)}_handleChanges(e){let t=e.removed;if(this._pending.size>0){t=new Array;for(const i of e.removed)this._pending.delete(i.objectId)||t.push(i)}let i=this._limit-this._active.length+t.length;i<e.added.length&&(this._active.removeMany(t),t=[],iv.reset(1-this._limit/(this._active.length+e.added.length)),this._active.forEach((e=>{iv.sample()&&(t.push(e),this._pending.set(e.objectId,e))})),i=this._limit-this._active.length+t.length);let r=e.added;if(i<e.added.length){r=new Array,iv.reset(i/e.added.length);for(const t of e.added)iv.sample()?r.push(t):this._pending.set(t.objectId,t)}const s=i-r.length;s>0&&this._pending.size>0&&(iv.reset(s/this._pending.size),this._pending.forEach((e=>{iv.sample()&&(r.push(e),this._pending.delete(e.objectId))}))),this._active.addAndRemove(r,t)}}const iv=new class{constructor(){this._percentage=1,this._last=-1,this._index=0}reset(e){this._percentage=e,this._last=-1}sample(){const e=Math.floor(this._index*this._percentage);return++this._index,e!==this._last&&(this._last=e,!0)}};class rv{constructor(e){this._parent=e,this._map=new Map}get length(){return this._map.size}forEach(e){this._map.forEach((t=>e(t)))}find(e){let t;return(0,Bi.Bs)(this._map,(i=>!!e(i)&&(t=i,!0))),t}toArray(){return[...this._map.values()]}addAndRemove(e,t){for(const t of e)this._map.set(t.objectId,t);for(const e of t)this._map.delete(e.objectId);(e.length>0||t.length>0)&&this._parent.emit("change",{added:e,removed:t})}removeMany(e){for(const t of e)this._map.delete(t.objectId);e.length>0&&this._parent.emit("change",{added:[],removed:e})}}class sv{constructor(e,t){this.meta=e,this.index=t}}class nv{constructor(e,t){this.graphic=e,this.geometry=t,this.components=[],this.overridesDirty=!1}}let av=class extends n.A{get updating(){return this._graphicsCore?.updating??!1}constructor(e){super(e),this.loadedGraphics=new tv(5e4),this.slicePlaneEnabled=!1,this._renderingInfo={symbol:new Ji.A},this._featuresMap=new Map}initialize(){const e=this.view.basemapTerrain;this._graphicsCore=new zy({owner:this,layer:this.layer,preferredUpdatePolicy:xo.ASYNC,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1,componentFactories:{deconflictor:e=>this.view.deconflictor.addGraphicsOwner(e),labeler:(e,t)=>this.view.labeler.addGraphicsOwner(e,t,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),scaleVisibility:(t,i)=>new qy({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:i,graphicsCore:t,basemapTerrain:e,layerScaleEnabled:!1})}}),this._graphicsCore.initializePromise.then((()=>this._graphicsCore.startCreateGraphics())).catch((()=>{})),this.addHandles((0,l.wB)((()=>this.layer.labelingInfo),((e,t)=>{(0,Ui.Ui)(e,t)&&this._graphicsCore.updateLabelingInfo()})))}destroy(){this._graphicsCore=(0,ce.pR)(this._graphicsCore),this.loadedGraphics=(0,ce.pR)(this.loadedGraphics),this.view=null}addNodeMeta(e,t){let i=0;const r=e.filteredIds,s=this.view.spatialReference,n=[];for(let a=0;a<e.featureIds.length;a++){const o=e.featureIds[a];let l=null==r;if(r&&i<r.length&&o===r[i]&&(l=!0,i++),!this._enabledForFeatureInNode(e,a))continue;const c=this._featuresMap.get(o);if(c){c.components.push(new sv(e,a)),this._updateLabelPosition(o);continue}const h=t(a,e),d=(0,ne.T)(0,0,0,s),u={objectId:o,uid:(0,Gi.c)(),attributes:h,visible:l,geometry:d},p=new nv(u,d);p.components.push(new sv(e,a)),this._featuresMap.set(o,p),this._updateLabelGeometry(o),n.push(u)}this.loadedGraphics.addMany(n)}updateLabelPositions(e){const t=this.view.renderCoordsHelper;this._forEachGraphic(e,((i,r,s)=>{const n=this._graphicsCore.getGraphics3DGraphicById(r.uid);null!=n&&this._updateLabelGeometry(e.featureIds[i])&&n.alignWithAbsoluteElevation(s.z??0,t,!1)}))}setNodeMetaAttributes(e,t){const i=new Array;this._forEachGraphic(e,((r,s)=>{const n=t(r,e);(0,ut.gh)(s.attributes,n)||(s.attributes=n,i.push(s.uid))})),this._graphicsCore.updateLabelingInfo(i)}applyFilterChange(e){this._forEachFeature(e,((t,i,r)=>{if(!this._enabledForFeatureInNode(e,t)){const r=e.featureIds[t];switch(this._removeFeature(i,e,t)){case lv.REMOVED:this.loadedGraphics.removeManyByObjectId([r]);break;case lv.MODIFIED:this._updateLabelPosition(r)}return}const s=i.graphic,n=s.visible;n!==r&&(s.visible=r,ov.graphic=s,ov.property="visible",ov.oldValue=n,ov.newValue=r,this._graphicsCore.graphicUpdateHandler(ov))}))}removeNodeMeta(e){const t=[];this._forEachGraphic(e,(i=>{const r=e.featureIds[i],s=this._featuresMap.get(r);if(s)switch(this._removeFeature(s,e,i)){case lv.MODIFIED:this._updateLabelPosition(r);break;case lv.REMOVED:t.push(r)}})),this.loadedGraphics.removeManyByObjectId(t)}_removeFeature(e,t,i){const r=e.components.length;return(0,b.$i)(e.components,(e=>!(e.meta===t&&e.index===i))),0===e.components.length?(this._featuresMap.delete(t.featureIds[i]),lv.REMOVED):r!==e.components.length?lv.MODIFIED:lv.UNMODIFIED}getRenderingInfo(){return this._renderingInfo}notifyGraphicGeometryChanged(){}notifyGraphicVisibilityChanged(){}_updateLabelPosition(e){const t=this._featuresMap.get(e);t&&this._updateLabelGeometry(e)&&(this.loadedGraphics.removeManyByObjectId([e]),this.loadedGraphics.addMany([t.graphic]))}_updateLabelGeometry(e){const t=this._featuresMap.get(e);if(!t)return!1;const i=t.geometry,r=this.view.spatialReference,s=this.view.renderCoordsHelper,n=i.x,a=i.y,o=i.z??0,l=t.components.length,c=(0,Q.jh)(24*l);let h=0;for(const{meta:e,index:i}of t.components)Yy(i,this.collection,e.objectHandle,c,h),h+=24;return(0,k.projectBuffer)(c,s.spatialReference,0,c,r,0,c.length/3),(0,q.hZ)(cv,q.qv),(0,q.Hq)(cv,c),i.x=(cv[0]+cv[3])/2,i.y=(cv[1]+cv[4])/2,i.z=cv[5],!(0,U.Io)(i.x,n)||!(0,U.Io)(i.y,a)||!(0,U.Io)(i.z,o)}_forEachGraphic(e,t){this._forEachFeature(e,((i,{graphic:r,geometry:s},n)=>{this._enabledForFeatureInNode(e,i)&&t(i,r,s,n)}))}_forEachFeature(e,t){let i=0;for(let r=0;r<e.featureIds.length;r++){const s=this._featuresMap.get(e.featureIds[r]);let n=null==e.filteredIds;e.filteredIds&&e.filteredIds[i]===e.featureIds[r]&&(n=!0,i++),s&&t(r,s,n)}}_enabledForFeatureInNode(e,t){return e.node.index<0||!this.overrides?.featureHasGeometryChanges(e.featureIds[t])}get updatePolicy(){return this._graphicsCore.effectiveUpdatePolicy}get usedMemory(){return this._graphicsCore.usedMemory}get unloadedMemoryEstimate(){return this._graphicsCore.unprocessedMemoryEstimate}get test(){return{graphicsCore:this._graphicsCore}}};(0,r._)([(0,h.MZ)()],av.prototype,"view",void 0),(0,r._)([(0,h.MZ)()],av.prototype,"layer",void 0),(0,r._)([(0,h.MZ)()],av.prototype,"collection",void 0),(0,r._)([(0,h.MZ)()],av.prototype,"loadedGraphics",void 0),(0,r._)([(0,h.MZ)()],av.prototype,"overrides",void 0),(0,r._)([(0,h.MZ)()],av.prototype,"updating",null),(0,r._)([(0,h.MZ)()],av.prototype,"slicePlaneEnabled",void 0),(0,r._)([(0,h.MZ)()],av.prototype,"_graphicsCore",void 0),av=(0,r._)([(0,u.$)("esri.views.3d.layers.I3SMeshViewLabeler")],av);const ov={graphic:null,property:null,oldValue:null,newValue:null};var lv;!function(e){e[e.UNMODIFIED=0]="UNMODIFIED",e[e.MODIFIED=1]="MODIFIED",e[e.REMOVED=2]="REMOVED"}(lv||(lv={}));const cv=(0,q.vt)();class hv{constructor(e,t=0,i=0,r=0,s=0,n=null){this.usedMemory=e,this.displayedFeatures=t,this.totalFeatures=i,this.maximumFeatures=r,this.nodes=s,this.core=n}}var dv,uv,pv;i(5878),f.B,new C.A({deallocator:null}),(0,I.vt)(),function(e){e[e.VISIBLE_ONLY=0]="VISIBLE_ONLY",e[e.ALL=1]="ALL",e[e.QUERYABLE=2]="QUERYABLE"}(dv||(dv={})),function(e){e[e.EXIT=0]="EXIT",e[e.CONTINUE=1]="CONTINUE",e[e.SKIP=2]="SKIP"}(uv||(uv={})),function(e){e[e.Absolute=0]="Absolute",e[e.RelativeToGround=1]="RelativeToGround",e[e.OnTheGround=2]="OnTheGround"}(pv||(pv={})),i(70844);var fv=i(6104);function gv(e){return e instanceof _y?e.graphics3DSymbol:e instanceof fy?e:null}const mv=()=>a.A.getLogger("esri.views.3d.layers.graphics.labelPlacement");class _v{constructor(e,t,i,r=null){this.graphics3DGraphic=e,this.labelSymbol=t,this.labelClass=i,this.disablePlacement=r}}function yv(e){const t=function(e){const t=e.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:r}=e,s=gv(r.graphics3DSymbol),n="point-3d"===s?.symbol.type?s.symbol:null,a=Cv[t]||xv(e);return null!=n&&n.supportsCallout()&&n.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:wv(n.verticalOffset),anchor:null,normalizedOffset:null}:!i||!i.hasVisibleVerticalOffset()||null!=n&&n.supportsCallout()&&n.verticalOffset&&!r.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:a&&function(e){return"above-center"===e}(a.placement)?{placement:"above-center",verticalOffset:wv(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,a.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(mv().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null)}(e);if(null==t)return null;const i=function(e,t){if(t.anchor)return t;const i=e.labelClass.labelPlacement,r=Cv[i],s=r||xv(e);return i&&!r&&mv().warnOncePerTick(`the requested label placement '${i}' is currently unsupported in SceneView.`),function(e,t){const i=t.graphics3DGraphic.graphic.geometry;if(null==i)return null;if(null!=t.disablePlacement)return t.labelClass.labelPlacement?(mv().warnOncePerTick(bv(e?.placement,t.disablePlacement.logEntityDescription)),xv(t)):e;const r=i.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return mv().warnOncePerTick(bv(e?.placement,`'${r}' geometries`)),xv(t);break;case"point":case"mesh":return e}return e}(s,e)}(e,t);if(null==i)return null;const r=i.anchor,s=!!t.hasLabelVerticalOffset,n=t.verticalOffset;return function(e,t,i){const r=i.graphics3DGraphic.graphic.geometry;if(null==r)return null;switch(r.type){case"point":!function(e,t,i){const r=vv(i);if(null==r)return;const s=i.graphics3DGraphic.layers[0];switch(null!=s?s.getCenterObjectSpace(e.translation):(0,M.s)(e.translation,0,0,0),r.type){case"icon":case"text":!function(e,t,i,r){const{graphics3DGraphic:s}=i,n=null!=r?r.getScreenSize():null;if(s.isDraped||null==n)e.hasLabelVerticalOffset||"center"===e.anchor||(Cv[i.labelClass.labelPlacement]&&mv().warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");else{const r=function(e,t=Ev){const{graphics3DGraphic:i}=e,r=i.layers[0],s=r?.stageObject.geometries[0].material??null;if(s&&s instanceof mu){const e=s.parameters.anchorPosition;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5)}else t[0]=0,t[1]=0;return t}(i);e.screenOffset[0]=n[0]/2*(t.normalizedOffset[0]-r[0]);const s=n[1]/2*(t.normalizedOffset[1]-r[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=s,e.centerOffsetUnits="screen"):e.screenOffset[1]=s}}(e,t,i,s);break;case"object":Sv(e,t,s)}}(e,t,i);break;case"polygon":!function(e,t,i){const r=vv(i);if(null!=r)switch(r.type){case"extrude":{const r=i.graphics3DGraphic.layers[0];null!=r?(r.getBoundingBoxObjectSpace(Av),(0,q.gX)(Av,e.translation),e.translation[2]=(0,q.uJ)(Av)/2):(0,M.s)(e.translation,0,0,0),Sv(e,t,r);break}}}(e,t,i);break;case"mesh":Sv(e,t,i.graphics3DGraphic.layers[0])}return e.screenOffset[0]+=3*t.normalizedOffset[0],e.screenOffset[1]+=3*t.normalizedOffset[1],e}(new T_(n,r,s),i,e)}function vv(e){const t=gv(e.graphics3DGraphic.graphics3DSymbol);return null!=t?t.symbol.symbolLayers.at(0):null}function bv(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView.`}function xv(e){const t=e.graphics3DGraphic.graphic.geometry;if(null==t)return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:I.uY,anchor:"center"};case"polygon":{const t=vv(e);return null!=t&&"extrude"===t.type?Cv["above-center"]:{placement:"center-center",normalizedOffset:I.uY,anchor:"center"}}case"point":case"mesh":return Cv["above-center"];default:return}}function Sv(e,t,i){const r=null!=i?i.getBoundingBoxObjectSpace(Av):Av,s=(0,I.fA)(r[3]-r[0],r[4]-r[1],r[5]-r[2]),n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);e.centerOffset[0]=n/2*t.normalizedOffset[0];const a=e.translation[2],o=s[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=a+o;const l=(0,M.l)(s);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function wv(e){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:i,maxWorldLength:r}}const Cv={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Rv={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in Rv){const t=Rv[e],i=Cv[e];t.forEach((e=>{Cv[e]=i}))}Object.freeze&&(Object.freeze(Cv),Object.keys(Cv).forEach((e=>{Object.freeze(Cv[e]),Object.freeze(Cv[e]?.normalizedOffset)})));const Ev=[0,0],Av=(0,q.vt)();class Tv{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}class Ov{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.addedToTextureAtlas=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class Pv{constructor(e,t,i,r,s){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=r,this.labelFunction=s,this.calloutSymbolLayerIndex=0}}class Mv{constructor(e,t,i,r,s,n,a,o){this.layer=t,this.graphics3DCore=i,this.scaleVisibility=r,this.emptySymbolLabelSupported=s,this.elevationInfoOverride=n,this.disablePlacement=a,this.active=o,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new Co(e,{pickable:!0,disableOctree:!0},t.uid)}destroy(){this.stageLayer.destroy()}}let Iv=class extends n.A{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([(0,l.wB)((()=>this.view.state?.camera),(()=>this.setDirty())),(0,l.wB)((()=>this.view.state?.rasterPixelRatio),(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(Ee.W6.LABELER,this)]),this._textTextureAtlas=new L_({view:this.view}),this._hudMaterialCollection=new Tv(this.view._stage),this._calloutMaterialCollection=new Tv(this.view._stage)}dispose(){this.removeAllHandles(),this._textTextureAtlas=(0,ce.WD)(this._textTextureAtlas),this._hudMaterialCollection=(0,ce.WD)(this._hudMaterialCollection),this._calloutMaterialCollection=(0,ce.WD)(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),Nv.graphic=null,Nv.renderingInfo=null,Nv.layer=null}_activateLabelingContext(e){e.graphics.forEach(((t,i)=>{const r=new Ov(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r),t.setVisibilityFlag(ys.LABEL,_s.USER,!0)})),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach(((e,t)=>{e.setVisibilityFlag(ys.LABEL,_s.USER,!1),this.setLabelGraphicVisibility(e,!1),e.clearLabelGraphics(),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&(this._textTextureAtlas.addTextTexture(i,t.stageObject),e.addedToTextureAtlas=!0)}}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];null!=i&&(this._textTextureAtlas.removeTextTexture(i,t.stageObject),e.addedToTextureAtlas=!1)}}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),D_.G}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(Dv(t))this._dirty=!0;else if(Fv(t.labelClassContexts)){if(null===t.labelClassContexts){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else(0,Bi.Bs)(t.labelsToInitialize,((i,r)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(r,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textInitialized||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done)))&&(this._dirty=!0);this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController?.signal;e.layer.when&&await e.layer.when(),(0,o.Te)(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,s=r.labelingInfo?.filter((e=>!!e.symbol));if(!s||0===s.length)return;let n=!1;await(0,dt.jJ)(s,(async(r,s)=>{const l=r.symbol,c=gv(i.getOrCreateGraphics3DSymbol(l));if(null==c)return void a.A.getLogger(this).error("Failed to create Graphics3DSymbol for label");await c.load(),(0,o.Te)(t);let h=null;(0,Ps.YX)(l)&&l.hasVisibleCallout()&&(h=_a(l,i.symbolCreationContext),await h.load(),(0,o.Te)(t));const d=await(0,dt.Ke)((0,fv.l)(r,e.layer.fieldsIndex,this.view.spatialReference));if((0,o.Te)(t),!0===d.ok){const i=await this._createTextRenderParameters(c.symbol);(0,o.Te)(t),e.labelClassContexts[s]=new Pv(r,c,h,i,d.value)}else a.A.getLogger(this).error(`Label expression failed to evaluate: ${d.error}`),n=!0})),(0,o.Te)(t)}async _createLabelClassContext(e){return null==e.labelClassPromise&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if((0,o.zf)(t))throw t;e.labelClassContexts.length=0})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return"text"!==t?.type?null:M_.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const t of e.labelClassContexts)--t.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,(0,ce.DC)(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,s,n){const a=new O_(i,iu(i.anchor),function(e){switch(e){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}(i.anchor),e.text,(0,dr.fA)(e.displayWidth,e.displayHeight));return Nv.graphic=t,Nv.renderingInfo=null,Nv.layer=r,s.createLabel(Nv,a,this._hudMaterialCollection,this._textTextureAtlas,(()=>{const e=yv(n);return e?e.elevationOffset:null}))}_createLineCalloutGraphic(e,t,i,r,s){Nv.graphic=e,Nv.layer=s;const n=r.screenOffset[0];return Nv.renderingInfo=new ga(null,t,r.translation,r.centerOffset,n,r.centerOffsetUnits,r.elevationOffset,this._calloutMaterialCollection),i.createGraphics3DGraphic(Nv)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,r=i.labelClassContexts;if(Fv(r)||!i.emptySymbolLabelSupported&&0===t.layers.length)return!1;let s=!1;const n=t.graphic,a=i.layer,o=Lv(i.layer);for(let l=0;l<r.length;l++){const c=e.textRenderers[l],h=e.textLabelPlacements[l];if(null==c||null==h)continue;const d=r[l],u=d.graphics3DSymbol,p=u.symbol&&"label-3d"===u.symbol.type?u.symbol:null,f=u.symbolLayers[0];if(!f)continue;f.setElevationInfoOverride(i.elevationInfoOverride);const g=new _v(t,p,d.labelClass),m=this._createTextSymbolGraphic(c,n,h,a,f,g);if(null==m)return!1;m._labelClass=d.labelClass,m._labelIndex=l,t.addLabelGraphic(m,i.stageLayer),t.deconflictionPriority=d.textRenderParameters?.definition.size??0,t.setVisibilityFlag(ys.LABEL,_s.USER,o),t.setVisibilityFlag(ys.LABEL,_s.SCALE_RANGE,!0),t.setVisibilityFlag(ys.LABEL,_s.DECONFLICTION,!1),s=!0;const _=d.graphics3DCalloutSymbolLayer;if(_&&h.hasLabelVerticalOffset){_.setElevationInfoOverride(i.elevationInfoOverride);const e=this._createLineCalloutGraphic(n,p,_,h,a);null!=e&&(d.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,i.stageLayer))}break}return i.scaleVisibility&&s&&i.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(null==i._labelClass)continue;const e=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];e?.onRemoveGraphic(i)}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if(Fv(i))return;const r=e.graphics3DGraphic.graphic;for(let s=0;s<i.length;s++){const n=i[s];if(e.textRenderers[s]=null,e.textLabelPlacements[s]=null,null==n?.textRenderParameters)continue;const a=n.labelFunction;let o;if("arcade"===a.type)try{const e=a.needsHydrationToEvaluate()?Jt(r,t.layer):r;o=a.evaluate(e)}catch(e){o=null}else o=a.evaluate(r);if(null==o||""===o||/^\s+$/.test(o))continue;const l=n.graphics3DSymbol,c="label-3d"===l.symbol?.type?l.symbol:null;if(!l.symbolLayers[0])continue;const h=yv({graphics3DGraphic:e.graphics3DGraphic,labelSymbol:c,labelClass:n.labelClass,disablePlacement:t.disablePlacement});if(null==h)continue;const d=tu(iu(h.anchor));e.textRenderers[s]=new kd(o,d,n.textRenderParameters,L_.maxSize),e.textLabelPlacements[s]=h}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const r=new Ov(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r)}this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const i=t.graphic.uid,r=this._labels.get(i);e.graphics.delete(i),r&&(this._destroyGraphic(r,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.graphics.get(i);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.graphics.forEach((e=>r.set(e.graphic.uid,e)));const s=e=>e.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,s),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,t)}}}_visibilityInfoChange(e){const t=Lv(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach(((t,i)=>{const r=this._labels.get(i);r&&(this._destroyGraphic(r,i),r.visible=!1,e.labelsToInitialize.set(i,r))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i&&i.emptySymbolLabelSupported||!1,s=i?.elevationInfoOverride||null,n=i?.disablePlacement||null;if(this._findLabelingContext(e))return;const a=e.layer,o=new Mv(this.view._stage,a,e,t,r,s,n,Lv(a));return this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>Lv(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach((e=>this._removeGraphic(t,e))),t.destroy(),this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.addedToTextureAtlas?(this._addLabelTextureToAtlas(r),r.textInitialized||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(r),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some((e=>Dv(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(Dv(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function Dv(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function Fv(e){return!e||0===e.length}function Lv(e){return!0===e.labelsVisible&&!!e.labelingInfo?.some((e=>!!e.symbol))}(0,r._)([(0,h.MZ)({constructOnly:!0})],Iv.prototype,"view",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Iv.prototype,"deconflictor",void 0),(0,r._)([(0,h.MZ)()],Iv.prototype,"_textTextureAtlas",void 0),(0,r._)([(0,h.MZ)({type:Boolean,readOnly:!0})],Iv.prototype,"updating",null),Iv=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Labeler")],Iv);const Nv=new class extends Ts{}(null,null,null);class Vv{constructor(){this._extents=new C.A({allocator:e=>e||(0,$.vt)()}),this._tmpExtent=(0,$.vt)(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this._contains(e)||(this._removeContained(e),(0,$.C)(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(e){return this._mergeTight(e),e.hasProgressed}_mergeTight(e=Ee.Bb){const t=this._extents,i=new Set;let r=0;for(;r!==t.length;){t.sort(((e,t)=>e[0]-t[0])),r=t.length,i.clear();for(let r=0;r<t.length;++r){if(e.done)return;const s=t.at(r);if(s){for(let e=r+1;e<t.length;++e){const r=t.at(e);if(null==r||r[0]>=s[2])break;i.add(r)}i.forEach((r=>{if(s===r)return;if(r[2]<=s[0])return void i.delete(r);const n=(0,$.Wc)(s),a=(0,$.Wc)(r),o=this._tmpExtent;(0,$.fT)(s,r,o);const l=n+a;((0,$.Wc)(o)-l)/l<.05&&((0,$.C)(s,o),i.delete(r),t.remove(r),e.madeProgress())})),i.add(s)}}}this._dirty=!1}_contains(e){return this._extents.some((t=>(0,$.gR)(t,e)))}_removeContained(e){this._extents.filterInPlace((t=>!(0,$.gR)(e,t)))}get test(){const e=this;return{containsPoint:t=>e._extents.some((e=>(0,$.Uc)(e,t)))}}}let Gv=class extends n.A{constructor(e,t,i,r){super({}),this._updateExtent=t,this._updateNode=i,this._getElevationMode=r,this.running=!1,this._extentSet=new Vv,this._nodeSet=new Set;const s=this._taskPriority,n=e.registerTask(this._taskPriority,this);this.addHandles(n),this._task=n,this._lastTaskPriority=s}get _taskPriority(){const e=this._getElevationMode();return e&&e===pv.RelativeToGround?Ee.W6.ELEVATION_ALIGNMENT_SCENE:Ee.W6.ELEVATION_ALIGNMENT}_updateTaskPriority(){const e=this._taskPriority;e!==this._lastTaskPriority&&(this._task.priority=e,this._lastTaskPriority=e)}normalizeCtorArgs(){return{}}addExtent(e){this._extentSet.add(e),this._updateTaskPriority(),this.running=!0}schedule(e){this._nodeSet.add(e),this._updateTaskPriority(),this.running=!0}remove(e){this._nodeSet.delete(e),this._updateRunning()}runTask(e){const t=this._extentSet;for(e.run((()=>t.merge(e)));!t.empty&&!e.done;){const i=this._updateExtent(t.pop());null!=i&&i.forAll((e=>this.schedule(e))),e.madeProgress()}if(e.done)return;const i=this._nodeSet;for(const t of i)if(i.delete(t),this._updateNode(t),e.madeProgress(),e.done)break;this._updateRunning()}_updateRunning(){this.running=this._nodeSet.size>0||this._extentSet.size>0}};(0,r._)([(0,h.MZ)()],Gv.prototype,"running",void 0),Gv=(0,r._)([(0,u.$)("esri.views.3d.layers.i3s.I3SAsyncElevationUpdater.ts")],Gv);var Uv=i(12056),zv=i(18632),Bv=i(5213),Hv=i(78621),jv=i(65452),Wv=i(63457),kv=i(57942),Zv=i(23271),qv=i(51074),$v=i(36767),Qv=i(10591),Jv=(i(61064),i(38648),i(54483)),Yv=i(45352),Xv=i(92801);class Kv{get isReferenced(){return 0!==this.versions.length}get isSingle(){return 1===this.versions.length&&1===this.versions[0].refCount}constructor(e,t){this._highestResolutionVersion=null,this.versions=[],this.ref(e,t)}ref(e,t){const i=this.feature;tb.oldVersion=i,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0});for(const r of this.versions)if(r.resolution===t){r.refCount++;const t=this._highestResolutionVersion===r&&!(0,Xv.aI)(e,r.feature);return(t||this._highestResolutionVersion!==r)&&(r.feature=e),tb.newVersion=t?e:i,tb}const r={feature:e,resolution:t,refCount:1};return this.versions.push(r),!this._highestResolutionVersion||t<this._highestResolutionVersion.resolution?(tb.newVersion=e,this._highestResolutionVersion=r):tb.newVersion=i,tb}unref(e){for(let t=0;t<this.versions.length;t++){const i=this.versions[t];if(i.resolution===e)return i.refCount--,tb.oldVersion=this.feature,0===i.refCount&&(this.versions[t]=this.versions[this.versions.length-1],this.versions.length--,this._highestResolutionVersion===i&&(this._recalculateHighestResolutionVersion(),tb.oldVersion=i.feature)),tb.newVersion=this.feature,tb}return null}get feature(){return this._highestResolutionVersion?this._highestResolutionVersion.feature:null}_recalculateHighestResolutionVersion(){if(0===this.versions.length)return void(this._highestResolutionVersion=null);let e=this.versions[0];for(let t=1;t<this.versions.length;t++){const i=this.versions[t];i.resolution<e.resolution&&(e=i)}this._highestResolutionVersion=e}}class eb{get isReferenced(){return 0!==this._refCount}get isSingle(){return 1===this._refCount}constructor(e){this._feature=e,this._refCount=1}ref(e){return++this._refCount,tb.oldVersion=this._feature,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0}),(0,Xv.aI)(this._feature,e)||(this._feature=e),tb.newVersion=this._feature,tb}unref(){return tb.oldVersion=this._feature,this._refCount>0&&(this._refCount--,!this.isReferenced)?(tb.newVersion=null,tb):(tb.newVersion=this._feature,tb)}get feature(){return this._feature}}const tb={oldVersion:null,newVersion:null};var ib=i(39369);const rb=new Set;class sb{get featuresMissing(){return this._featuresMissing.value}set featuresMissing(e){this._featuresMissing.value=e}get missingAttributes(){return this._missingAttributes}get fetchFailed(){return this._fetchFailed.value}set fetchFailed(e){this._fetchFailed.value=e}get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(e){this._displayingFeatures=e,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){const e=(this.fetchStatus===ab.DONE||this.fetchStatus===ab.FULL)&&this.featuresMissing;return!this.filtered&&(e||this.hasFeatureLimit)}get features(){return this._features}get featureLimit(){return this._featureLimit.value}set featureLimit(e){this._featureLimit.value!==e&&(this._featureLimit.value=e,this._estimatedUnusedSizeDirty=!0)}get hasFeatureLimit(){return this.featureLimit!==this._featuresLength.value}get hasAllFeatures(){return!(this.featuresMissing||this.fetchFailed||this.hasFeatureLimit)}get availableFields(){return this._availableFields}setFeatures(e,t,i,r){this._availableFields=i??rb,this._features=e,this._featuresLength.value=e?.length??0,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,this._missingAttributes=r,e&&e.length>0?(this._emptyFeatureRatio.value=t/(e.length+t),this._numVertices=e.reduce(((e,t)=>e+(0,ki.Kq)(t.geometry)),0)):(this._emptyFeatureRatio.value=0,this._numVertices=0)}get emptyFeatureRatio(){return this._emptyFeatureRatio.value}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0}set numFeatures(e){this._numFeatures=e}get hasPreciseFeatureCount(){return this._numFeatures>nb}get needsFeatureCount(){return this._numFeatures===nb}get numVertices(){return this._numVertices}constructor(e){this.descriptor=e,this.fetchStatus=ab.FETCH_NEEDED,this._features=null,this._featuresLength=(0,ib.v)(0),this._numVertices=0,this._featureLimit=(0,ib.v)(0),this._featuresMissing=(0,ib.v)(!0),this._fetchFailed=(0,ib.v)(!1),this._shuffled=!1,this._numFeatures=nb,this._emptyFeatureRatio=(0,ib.v)(0),this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=rb,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let e=0;e<this._features.length;++e){const t=(0,ki.Ek)(this._features[e]);this._estimatedSize+=t,e>=this.featureLimit&&(this._estimatedUnusedSize+=t)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let e=this.featureLimit;e<this._features.length;++e)this._estimatedUnusedSize+=(0,ki.Ek)(this._features[e]);return!0}return!1}get isFetching(){return this.fetchStatus===ab.FETCHING||this.fetchStatus===ab.REFETCHING}get isRefetching(){return this.fetchStatus===ab.REFETCHING}get needsFetching(){return this.fetchStatus===ab.FETCH_NEEDED||this.fetchStatus===ab.REFETCH_NEEDED}get needsRefetching(){return this.fetchStatus===ab.REFETCH_NEEDED}get isFetched(){return this.fetchStatus===ab.DONE||this.fetchStatus===ab.FULL}resetFetching(){this.fetchStatus=this.fetchStatus===ab.REFETCHING?ab.REFETCH_NEEDED:ab.FETCH_NEEDED}get needsDisplayUpdate(){return!!this._features&&!function(e,t,i){if(null==t||null==e||i!==t.length||i>e.length)return!1;for(let r=0;r<i;++r)if(e[r]!==t[r])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}intersects(e){return null==e||!this.descriptor.extent||((0,$.VY)(e,ob),(0,$.HY)(this.descriptor.extent,ob))}intersectionIncludingBorrowed(e,t){const i=null!=this.extentIncludingBorrowedFeatures?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return e||i?(null!=e?((0,$.VY)(e,t),(0,$.E$)(t,i,t)):(0,$.C)(t,i),t):((0,$.C)(t,$.sI),t)}_shuffle(e){this._features&&(this._features.sort(((t,i)=>(0,ki.RW)(t,e)-(0,ki.RW)(i,e))),(0,b.k4)(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0)}reduceFeatures(e,t,i){if(e<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let r=!1;this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===ab.DONE&&this._features.length>0&&(this.fetchStatus=ab.REFETCH_NEEDED,r=!0)),!this._shuffled&&e<1&&this._shuffle(i);const s=Math.max(this.featureLimit,Math.ceil(t*this.numFeatures));return this._features.length>s&&(this._features.length=s,this._featuresLength.value=s,this.featuresMissing=!0,this.fetchStatus===ab.FULL&&(this.fetchStatus=ab.DONE)),r}get cache(){return{availableFields:this._availableFields,features:this._features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio.value,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}}set cache(e){this.requestController=null,this._availableFields=e.availableFields,this._features=e.features,this._featuresLength.value=e.features?.length??0,this._numFeatures=e.numFeatures,this._emptyFeatureRatio.value=e.emptyFeatureRatio,this.fetchStatus=e.fetchStatus,this.featuresMissing=e.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}const nb=-1;var ab;!function(e){e[e.FETCH_NEEDED=0]="FETCH_NEEDED",e[e.REFETCH_NEEDED=1]="REFETCH_NEEDED",e[e.FETCHING=2]="FETCHING",e[e.REFETCHING=3]="REFETCHING",e[e.DONE=4]="DONE",e[e.FULL=5]="FULL"}(ab||(ab={}));const ob=(0,$.vt)();var lb,cb;(cb=lb||(lb={}))[cb.BACK_TO_FRONT=-1]="BACK_TO_FRONT",cb[cb.NONE=0]="NONE",cb[cb.FRONT_TO_BACK=1]="FRONT_TO_BACK";let hb=class extends n.A{set maximumNumberOfFeatures(e){e=e||1/0;const t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this._maximumFeaturesUpdated(t,e))}set memoryFactor(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this._setDirty())}set lodFactor(e){this.lodFactor!==e&&(this._set("lodFactor",e),this._supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&null!=this.context.query.queryFeatureCount}set useTileCount(e){this._useTileCount=e,this.notifyChange("useTileCount")}get updating(){return this._dirty||!!this._pendingEdits||this._isFetching||(this.tileDescriptors?.updating??!1)}get memoryForUnusedFeatures(){let e=0;return this._featureTiles.forEach((t=>e+=t.estimatedUnusedSize)),e}get totalVertices(){let e=0;return this._featureTiles.forEach((t=>e+=t.numVertices)),e}get totalFeatures(){let e=0;return this._featureTiles.forEach((t=>e+=t.numFeatures)),e}get hasAllFeatures(){if(this._paused||this.dataUpdating)return!1;for(const[,e]of this._featureTiles)if(!this.hasFullGeometries&&0!==e.emptyFeatureRatio||!e.hasAllFeatures)return!1;return!0}get hasFullGeometries(){return!this._supportsResolution||!this.tileDescriptors.find((e=>null!=e.resolution))||!this.context.capabilities.supportsQuantization&&"polyline"!==this.context.geometryType}set filterExtent(e){if(null!=e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))return void a.A.getLogger(this).error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const i=null!=e?e.clone():null;this._set("filterExtent",i),this._reclip(i,t)}constructor(e){super(e),this._useTileCount=!1,this.dataUpdating=!1,this.running=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this._fullRatio=1,this._farRatio=1,this._changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this._frameTask=Ee.nu,this._dirty=!1,this._featureTiles=new qv.A,this._displayingFeatureReferences=new Map,this._numDisplayingFeatureReferences=0,this._suspended=!0,this._pendingEdits=null,this._applyEditsTilesUpdated=!1,this._isFetching=!1}initialize(){this.addHandles((0,l.on)((()=>this.tileDescriptors),"change",(()=>this._setDirty()),{sync:!0,onListenerAdd:()=>this._setDirty()})),this._objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?Kv:eb;const e=this.context.scheduler;null!=e&&(this._frameTask=e.registerTask(Ee.W6.FEATURE_TILE_FETCHER,this)),this._setDirty()}destroy(){this._frameTask.remove(),this._featureTiles.forEach((e=>{this._cancelFetchTile(e),this._removeTile(e)})),this._featureTiles.clear(),this._displayingFeatureReferences.clear(),this._pendingEdits?.controller.abort(),this._pendingEdits=null}get _paused(){return this._suspended||!!this._pendingEdits}restart(){this._featureTiles.forEach((e=>{this._cancelFetchTile(e),this._clearTile(e),this._resetFetchTile(e)})),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._setDirty()}refetch(){this._featureTiles.forEach((e=>{this._cancelFetchTile(e),this._resetFetchTile(e)})),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._setDirty()}suspend(){this._suspended||(this._suspended=!0,this._pause(),this._setDirty())}resume(){this._suspended&&(this._suspended=!1,this._unpause())}getMissingAttributesForFeature(e){for(const[,t]of this._featureTiles){const i=t.missingAttributes?.get(e);if(null!=i)return i}}_pause(){this._paused&&(this._featureTiles.forEach((e=>this._cancelFetchTile(e))),this._updated())}_unpause(){this._paused||(this._setDirty(),this._updated())}get availableFields(){let e=null;return this._featureTiles.forEach((t=>{null!=t.displayingFeatures&&0!==t.displayingFeatures.length&&(null==e?e=new Set(t.availableFields):e.forEach((i=>{t.availableFields.has(i)||e.delete(i)})))})),null!=e?e:new Set}applyEdits(e){this._pendingEdits||(this._pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const t=this._pendingEdits;t.count++;const i=t.edits.then((()=>e.result.catch((e=>{if((0,o.zf)(e))throw e;return null})).then((e=>e?(this._applyEditsDeleteFeatures(e.deletedFeatures),this._applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures,t.controller.signal).then((()=>e))):e)).then((e=>(0==--t.count&&(this._pendingEdits===t&&(this._pendingEdits=null),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._applyEditsTilesUpdated=!1,this._unpause()),e)))));return t.edits=i,this._updated(),i}_applyEditsDeleteFeatures(e){if(0===e.length)return;const t=this.context.globalIdField,i=t&&this.availableFields.has(t),r=new Set,s=this._objectIdField;e.forEach((({objectId:e,globalId:n})=>{(!e||e<0)&&t&&n&&(i||a.A.getLogger(this).errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected in the view`),e=this._objectIdFromGlobalId(n,s,t)),null!=e&&e>=0&&r.add(e)})),this._featureTiles.forEach((e=>{if(!e.features)return;const t=e.features.filter((e=>!r.has((0,ki.RW)(e,this._objectIdField))));t.length!==e.features.length&&(this._applyEditsTileUpdated(),e.setFeatures(t,0,e.availableFields,e.missingAttributes),this._invalidateCounts())}))}_objectIdFromGlobalId(e,t,i){if(null==e)return null;const r=this.features.find((t=>t.attributes?.[i]===e));return r?(0,ki.RW)(r,t):null}async _applyEditsAddUpdateFeatures(e,t,i){const{objectIdField:r,globalIdField:s}=this.context,n=s&&this.availableFields.has(s),o=new Set,l=new Set;for(const t of e){const e=t.objectId;null!=e&&o.add(e)}for(const{objectId:e,globalId:i}of t){let t=e;(null==t||t<0)&&s&&(n||a.A.getLogger(this).errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${s} to be included the layer's outFields for updates to be reflected in the view`),t=this._objectIdFromGlobalId(i,r,s)),null!=t&&t>=0&&(o.add(t),l.add(t))}if(0===o.size)return;const c=[];this._featureTiles.forEach((e=>{const t=this._applyEditsAddUpdateTile(e,o,l,i);t&&c.push(t)})),this._updated(),await Promise.allSettled(c)}async _applyEditsAddUpdateTile(e,t,i,r){if(!e.features)return;const s=this._createQuery(e);s.resultType=void 0,s.cacheHint=!1,s.objectIds=Array.from(t);const n=await this._queryFeatures(s,r);let a=null;if(i.size>0){const t=e.features.filter((e=>!i.has((0,ki.RW)(e,this._objectIdField))));t.length!==e.features.length&&(a=t)}if(n.features.length>0){a||(a=e.features.slice());for(const e of n.features)a.push(e)}a&&(e.hasPreciseFeatureCount&&(e.numFeatures=Math.max(e.numFeatures,a.length)),this._applyEditsTileUpdated(),e.setFeatures(a,0,fb(e.availableFields,n.fields),gb(e.missingAttributes,n.missingAttributes)),this._invalidateCounts())}_applyEditsTileUpdated(){this._applyEditsTilesUpdated||(this._applyEditsTilesUpdated=!0,this._updated())}_queryFeatures(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:vb})}_setDirty(){this._dirty=!0,this._updated()}runTask(e){const t=this._frameTask.processQueue(e);if(!this._dirty||!this.initialized)return t;this._dirty=!1;const i=this._getListOfTiles();if(this._markTilesNotAlive(i),!e.run((()=>this._addTiles(i,e)))||!e.run((()=>this._filterExtentTiles(i,e)))||!e.run((()=>this._removeTiles(i,e)))||e.done)return void this._setDirty();const r=this._sortTiles(i);e.run((()=>this._showTiles(r,e)))&&e.run((()=>this._fetchTiles(r,e)))&&e.run((()=>this._updateMemoryEstimates(r,e)))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}_markTilesNotAlive(e){for(const t of e)t.alive=!1}_addTiles(e,t){return!(this._suspended||!this.tileDescriptors)&&(this.tileDescriptors.forEach((i=>{const r=this._featureTiles.get(i.id);r?r.alive=!0:t.done||(e.push(this._addTile(i)),t.madeProgress())})),t.hasProgressed)}_filterExtentTiles(e,t){for(const i of e){if(t.done)break;i.alive&&(i.filtered=!i.intersects(this.filterExtent),i.filtered&&(this._clearTile(i),t.madeProgress()))}return t.hasProgressed}_removeTiles(e,t){for(let i=e.length-1;i>=0&&!t.done;i--){const r=e[i];r.alive||(this._removeTile(r),i!==e.length-1&&(e[i]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}_sortTiles(e){return e.sort(((e,t)=>(e.descriptor.loadPriority??0)-(t.descriptor.loadPriority??0))),e}_showTiles(e,t){const i=this._updateRatio(e),r=e=>{const t=this._fullRatio<1?i(e)*this._farRatio:1;return e.reduceFeatures(t,this.memoryFactor,this._objectIdField)&&this._setDirty(),this._showTile(e)};for(const i of e)if(!t.run((()=>r(i)))){this._setDirty();break}return t.hasProgressed}_fetchTiles(e,t){if(this._paused)return!1;let i=!1;for(const r of e){if(!r.needsFetching)continue;const e=null!=this.context.memoryCache?this.context.memoryCache.pop(r.id):null;if(null==e){if(this._needsNumFeatures(r)){const e=new AbortController,s=this._fetchTileCount(r,e.signal);this._handleRequest(r,s,e,(()=>r.numFeatures=-2)),i=!0,t.madeProgress()}if(t.done)return!0}else r.cache=e,this._setDirty(),this._scheduleUpdated(),t.madeProgress()}if(i)return t.hasProgressed;for(const i of e)if(i.needsFetching){const e=new AbortController,r=this._fetchTile(i,e.signal);if(this._handleRequest(i,r,e,(e=>{i.setFeatures([],0,null,void 0),this._invalidateCounts(),i.featuresMissing=!1,i.fetchFailed=!0,this.context.logFetchError(a.A.getLogger(this),e)})),t.madeProgress())return!0}return t.hasProgressed}_updateMemoryEstimates(e,t){return e.some((e=>!t.run((()=>e.updateMemoryEstimates()))&&(this._setDirty(),!0))),t.hasProgressed}_reclip(e,t){if(!this.initialized)return;const i=new Array;this._featureTiles.forEach((r=>{null!=r.displayingFeatures&&0!==r.displayingFeatures.length&&(r.intersectionIncludingBorrowed(t,_b),r.intersectionIncludingBorrowed(e,yb),(0,$.aI)(_b,yb)||i.push(r))})),this._refreshDisplayingFeatures(i),this._updated()}_refreshDisplayingFeatures(e){const t=new Set,i=this._changes.updates;for(const r of e)if(null!=r.displayingFeatures)for(const e of r.displayingFeatures){const r=(0,ki.RW)(e,this._objectIdField);if(t.has(r))continue;t.add(r);const s=this._displayingFeatureReferences.get(r).feature;i.removes.push(s),i.adds.push(s)}this._applyChanges()}_updated(){let e=0;if(this._paused||this._featureTiles.forEach((t=>t.isFetching?++e:0)),this._isFetching=e>0,this._set("running",this._dirty),e>0||this._applyEditsTilesUpdated?this._set("dataUpdating",!0):this._dirty||this._set("dataUpdating",!1),this.updating){let t=0,i=0,r=0,s=0,n=0;const a=this._displayingFeatureReferences.size/this._numDisplayingFeatureReferences;this._featureTiles.forEach((e=>{if(++i,e.isFetching&&e.hasPreciseFeatureCount){const t=this._maximumFeaturesForTile(e)*(1-e.emptyFeatureRatio),i=null!=e.displayingFeatures?e.displayingFeatures.length*a:0;n+=t-i}e.needsFetching?++s:e.numFeatures>0&&(++r,t+=e.numFeatures)})),s+=e;let o=0,l=0;t?(l=t,o=Math.min(s*t/r,t)):(l=i,o=s),n=Math.min(this.maximumNumberOfFeatures-this.features.length,n),this._set("updatingTotal",l),this._set("updatingRemaining",o),this._set("expectedFeatureDiff",n)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}_updateMaximumNumberOfFeaturesExceeded(){const e=(0,Bi.Bs)(this._featureTiles,(e=>e.perTileMaximumNumberOfFeaturesExceeded));this._set("maximumNumberOfFeaturesExceeded",e)}_updateRatio(e){const t=function(e){let t=0;for(const i of e)i.features&&i.features.length>0&&i.alive&&(t=Math.max(t,i.descriptor.lij[0]));return t}(e),i=e=>1/(1<<Math.max(0,t-e.descriptor.lij[0]));let r=0,s=0;for(const t of e){const e=t.numFeatures;r+=e,s+=e*i(t)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/r),this._farRatio=this.maximumNumberOfFeatures/s,this._scheduleUpdated(),i}_maximumFeaturesUpdated(e,t){e!==t&&(t>e&&this._featureTiles.forEach((e=>{if(!e.featuresMissing)return;const t=this._maximumFeaturesForTile(e);e.features&&(e.features.length>=t||e.fetchStatus===ab.FULL)||(this._cancelFetchTile(e),this._resetFetchTile(e))})),this._setDirty())}_addTile(e){const t=new sb(e);return this._featureTiles.set(t.id,t),this._resetFetchTile(t),this._referenceDisplayingFeaturesFromRelatedTiles(t),t}_referenceDisplayingFeaturesFromRelatedTiles(e){const t=e.descriptor.resolution;this._featureTiles.forEach((i=>{if(!(null==i.displayingFeatures||e===i||e.descriptor.lij&&i.descriptor.lij&&!function(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],r=i?e:t,s=i?t:e,n=1<<s[0]-r[0];return Math.floor(s[1]/n)===r[1]&&Math.floor(s[2]/n)===r[2]}(e.descriptor.lij,i.descriptor.lij))){null==e.displayingFeatures&&(e.displayingFeatures=[]),e.descriptor.extent&&i.descriptor.extent&&(null==e.extentIncludingBorrowedFeatures&&(e.extentIncludingBorrowedFeatures=(0,$.o8)(e.descriptor.extent)),(0,$.fT)(e.extentIncludingBorrowedFeatures,i.descriptor.extent,e.extentIncludingBorrowedFeatures));for(const r of i.displayingFeatures){e.displayingFeatures.push(r);const i=this._displayingFeatureReferences.get((0,ki.RW)(r,this._objectIdField));i.ref(i.feature,t),this._numDisplayingFeatureReferences++}}})),e.featureLimit=null!=e.displayingFeatures?e.displayingFeatures.length:0}_removeTile(e){this._clearTile(e),this._featureTiles.delete(e.id)}_resetFetchTile(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=ab.DONE):e.fetchStatus=ab.FETCH_NEEDED}_cancelFetchTile(e){const t=e.requestController;null!=t&&(e.requestController=null,e.resetFetching(),t.abort())}async _fetchTileCount(e,t){return e.numFeatures=await this._fetchCount(e,t),this._updateRatio(this._getListOfTiles()),e.fetchStatus===ab.REFETCHING?ab.REFETCH_NEEDED:ab.FETCH_NEEDED}async _fetchTile(e,t){e.fetchFailed=!1;const i=this._maximumFeaturesForTile(e);if(i<=0)return e.hasPreciseFeatureCount&&0===e.numFeatures||(e.fetchFailed=!0),function(e){return e.setFeatures([],0,null,void 0),e.featuresMissing=!1,ab.DONE}(e);const r=this._getMaxRecordCount(e),s=Math.ceil(i/r);if(db(e)||!this.context.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=i&&s>Qv.A.MAX_MAX_RECORD_COUNT_FACTOR)return this._fetchPagedTile(e,t);const n=this._createQuery(e);if(n.maxRecordCountFactor=Math.ceil(i/r),e.isRefetching&&e.features&&e.features.length>0){const t=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/r);n.maxRecordCountFactor=Math.max(t+1,n.maxRecordCountFactor)}const{features:a,exceededTransferLimit:l,fields:c,missingAttributes:h}=await this._queryFeatures(n,t),d=l?n.maxRecordCountFactor>=Qv.A.MAX_MAX_RECORD_COUNT_FACTOR?ab.FULL:ab.DONE:ab.FULL;return await this._frameTask.schedule((()=>{e.featuresMissing=e.hasPreciseFeatureCount&&a.length<e.numFeatures||!!l;const t=this._removeEmptyFeatures(a);e.setFeatures(a,t,pb(c),gb(void 0,h))}),t),(0,o.Te)(t),this._invalidateCounts(),d}async _fetchCount(e,t){return this.context.query.queryFeatureCount(this._createFeatureCountQuery(e),{signal:t})}async _fetchPagedTile(e,t){let i,r=0,s=0,n=0,a=this._maximumFeaturesForTile(e)-n;const l=this._getMaxRecordCount(e);let c,h=null;for(;;){const d=this._createQuery(e),u=this._setPagingParameters(d,r,a,l),{features:p,exceededTransferLimit:f,fields:g,missingAttributes:m}=await this._queryFeatures(d,t);if(await this._frameTask.schedule((()=>{u&&(r+=d.num),n+=p.length,s+=this._removeEmptyFeatures(p),e.featuresMissing=u&&e.hasPreciseFeatureCount&&r<e.numFeatures||!!f,i=i?i.concat(p):p,h=fb(h,g),c=gb(c,m),e.setFeatures(i,s,h,c)}),t),(0,o.Te)(t),this._invalidateCounts(),this._setDirty(),a=this._maximumFeaturesForTile(e)-n,!u||!f||a<=0)return f?ab.DONE:ab.FULL}}_createFeatureCountQuery(e){const t=this._createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}_createQuery(e){const t=this.context.createQuery(),i=e.descriptor.extent;if(i){const e=this.context.tilingScheme.spatialReference;t.geometry=(0,$.w1)(i,e)}return this._setResolutionParams(t,e),this._useTileQuery(e)?t.resultType="tile":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}_setPagingParameters(e,t,i,r){return!!this.context.capabilities.supportsPagination&&(e.start=t,i>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(i/r),e.num=Math.min(e.maxRecordCountFactor*r,i)):e.num=Math.min(r),!0)}_getEffectiveTileResolution(e){if(null==e.descriptor.resolution)return null;const t=this.context.viewingMode===oe.RT.Global?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}get _supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}_setResolutionParams(e,t){if(!this._supportsResolution)return;const i=this._getEffectiveTileResolution(t);null!=i&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new $v.A({mode:"view",originPosition:"upper-left",tolerance:i,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(e.maxAllowableOffset=i))}_removeEmptyFeatures(e){const t=e.length;for(let t=0;t<e.length;){const i=e[t];(0,ki.ao)(i.geometry)?++t:(e[t]=e[e.length-1],--e.length)}return t-e.length}_needsNumFeatures(e){return this.useTileCount&&e.needsFeatureCount&&!db(e)}_getMaxRecordCount(e){const{tileMaxRecordCount:t,maxRecordCount:i}=this.context;return this._useTileQuery(e)&&null!=t&&t>0&&this.context.capabilities.supportsResultType?t:null!=i&&i>0?i:mb}_useTileQuery(e){return(!db(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}_handleRequest(e,t,i,r){e.fetchStatus=e.needsRefetching?ab.REFETCHING:ab.FETCHING,e.requestController=i;let s=!1;t.then((t=>{e.requestController=null,e.fetchStatus=t})).catch((t=>{e.requestController===i&&(e.requestController=null,e.fetchStatus=ab.DONE),(0,o.zf)(t)?s=!0:r(t)})).then((()=>{s||this._setDirty(),this._scheduleUpdated()}))}_scheduleUpdated(){this.hasHandles("scheduleUpdated")||this.addHandles((0,c._)((()=>{this.removeHandles("scheduleUpdated"),this._updated()})),"scheduleUpdated")}_showTile(e){if(null!=e.displayingFeatures&&!e.needsDisplayUpdate)return!1;const t=e.features;if(0===e.featureLimit||!t){const t=null!=e.displayingFeatures&&e.displayingFeatures.length>0;return this._hideTileFeatures(e),e.displayingFeatures=[],t}const i=e.descriptor.resolution,r=this._changes.updates,s=this._changes.adds,n=Math.min(e.featureLimit,t.length);e.featureLimit=n;for(let e=0;e<n;++e){const n=t[e],a=(0,ki.RW)(n,this._objectIdField),o=this._displayingFeatureReferences.get(a);if(o){const e=o.ref(n,i);e.oldVersion!==e.newVersion&&(e.oldVersion&&r.removes.push(e.oldVersion),e.newVersion&&r.adds.push(e.newVersion))}else this._displayingFeatureReferences.set(a,new this.FeatureReferenceClass(n,i)),s.push(n);this._numDisplayingFeatureReferences++}return this._hideTileFeatures(e),this._applyChanges(),e.displayingFeatures=t.slice(0,n),!0}_hideTile(e){this._cancelFetchTile(e),this._hideTileFeatures(e)}_hideTileFeatures(e){if(null==e.displayingFeatures)return;const t=this._changes.updates,i=this._changes.removes;for(const r of e.displayingFeatures){const s=(0,ki.RW)(r,this._objectIdField),n=this._displayingFeatureReferences.get(s);if(!n)continue;const a=n.unref(e.descriptor.resolution);this._numDisplayingFeatureReferences--,a?a.oldVersion!==a.newVersion&&(null==a.newVersion?(this._displayingFeatureReferences.delete(s),a.oldVersion&&i.push(a.oldVersion)):(t.adds.push(a.newVersion),a.oldVersion&&t.removes.push(a.oldVersion))):console.error("Hiding unreferenced feature")}this._applyChanges(),e.displayingFeatures=null}_applyChanges(){const e=this._changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);const t=this._changes.adds,i=this._changes.removes,r=Math.min(t.length,i.length);let s=0;for(;s<r;){const e=Math.min(s+bb,r);this.features.addMany(t.slice(s,e)),this.features.removeMany(i.slice(s,e)),s=e}t.length>r&&this.features.addMany(0===s?t:t.slice(s)),i.length>r&&this.features.removeMany(0===s?i:i.slice(s)),t.length=0,i.length=0}_clearTile(e){if(this._hideTile(e),e.features&&null!=this.context.memoryCache){const t=16+e.estimatedSize;this.context.memoryCache.put(e.id,e.cache,t)}e.setFeatures(null,0,null,void 0),this._invalidateCounts()}_invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}_getListOfTiles(){return Array.from(this._featureTiles.values())}get storedFeatures(){return this._getListOfTiles().reduce(((e,t)=>e+(t.features?t.features.length:0)),0)}get missingTiles(){return Array.from(this._featureTiles.values()).reduce(((e,t)=>e+(t.needsFetching||t.isFetching?1:0)),0)}_maximumFeaturesForTile(e){const t=e.hasPreciseFeatureCount?e.numFeatures:1/0,i=e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures,r=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(i*r/(1-e.emptyFeatureRatio)),t)}get test(){return{process:e=>this.runTask(e),getFeatureTileById:e=>this._featureTiles.get(e),forEachFeatureTile:e=>this._featureTiles.forEach(e)}}};function db(e){return"dummy-tile-full-extent"===e.id}function ub(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function pb(e){return null==e?new Set:new Set(e.map((e=>e.name)))}function fb(e,t){if(null==e||null==t)return pb(t);const i=new Set;for(const{name:r}of t)e.has(r)&&i.add(r);return i}function gb(e,t){if(!t?.length)return e;e??=new Map;const i=()=>new Set;for(const{objectId:r,attribute:s}of t)(0,Bi.tE)(e,r,i).add(s);return e}(0,r._)([(0,h.MZ)({constructOnly:!0})],hb.prototype,"features",void 0),(0,r._)([(0,h.MZ)()],hb.prototype,"tileDescriptors",void 0),(0,r._)([(0,h.MZ)({value:1/0})],hb.prototype,"maximumNumberOfFeatures",null),(0,r._)([(0,h.MZ)({value:1})],hb.prototype,"memoryFactor",null),(0,r._)([(0,h.MZ)({value:1})],hb.prototype,"lodFactor",null),(0,r._)([(0,h.MZ)()],hb.prototype,"useTileCount",null),(0,r._)([(0,h.MZ)({readOnly:!0})],hb.prototype,"updating",null),(0,r._)([(0,h.MZ)({readOnly:!0})],hb.prototype,"dataUpdating",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],hb.prototype,"running",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],hb.prototype,"updatingTotal",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],hb.prototype,"updatingRemaining",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],hb.prototype,"expectedFeatureDiff",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],hb.prototype,"memoryForUnusedFeatures",null),(0,r._)([(0,h.MZ)({readOnly:!0})],hb.prototype,"maximumNumberOfFeaturesExceeded",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],hb.prototype,"totalVertices",null),(0,r._)([(0,h.MZ)({readOnly:!0})],hb.prototype,"totalFeatures",null),(0,r._)([(0,h.MZ)({readOnly:!0})],hb.prototype,"hasAllFeatures",null),(0,r._)([(0,h.MZ)({readOnly:!0})],hb.prototype,"hasFullGeometries",null),(0,r._)([(0,h.MZ)()],hb.prototype,"filterExtent",null),(0,r._)([(0,h.MZ)({constructOnly:!0})],hb.prototype,"context",void 0),(0,r._)([(0,h.MZ)()],hb.prototype,"_dirty",void 0),(0,r._)([(0,h.MZ)()],hb.prototype,"_suspended",void 0),(0,r._)([(0,h.MZ)()],hb.prototype,"_pendingEdits",void 0),(0,r._)([(0,h.MZ)()],hb.prototype,"_applyEditsTilesUpdated",void 0),(0,r._)([(0,h.MZ)()],hb.prototype,"_paused",null),(0,r._)([(0,h.MZ)()],hb.prototype,"_isFetching",void 0),hb=(0,r._)([(0,u.$)("esri.views.3d.layers.support.FeatureTileFetcher3D")],hb);const mb=2e3,_b=(0,$.vt)(),yb=(0,$.vt)(),vb=6e5,bb=200;var xb=i(31873),Sb=i(20593),wb=i(74810),Cb=i(97160);const Rb=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];class Eb{constructor(e,t,i){this._loadingGraphics=new Map,this._loadedGraphics=new Map,this._pendingGraphics=new Map,this._dataExtentGraphic=null,this._enabled=!0,this._tileFetcher=e,this._view=i,this._tilingScheme=new wb.n(t),this._loadedSymbols=Rb.map((e=>new Yi.A({symbolLayers:new S.A([new qi.A({material:{color:[e[0],e[1],e[2],.6]},outline:{color:"black",size:1}})])}))),this._loadingSymbols=[new Yi.A({symbolLayers:new S.A([new qi.A({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}})])})],this._pendingSymbols=[new Yi.A({symbolLayers:new S.A([new qi.A({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}})])})],this._dataExtentSymbol=new Yi.A({symbolLayers:new S.A([new qi.A({material:{color:[0,0,0,0]},outline:{color:"green",size:4}})])})}destroy(){this.enabled=!1}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.update()}update(){this._enabled?(this._synchronizeMaps(this._loadingGraphics,{filter:e=>e.isFetching,symbols:this._loadingSymbols}),this._synchronizeMaps(this._loadedGraphics,{filter:e=>!e.isFetching,symbols:this._loadedSymbols}),this._synchronizeMaps(this._pendingGraphics,{filter:e=>!e.isFetching,symbols:this._pendingSymbols}),this.showDataExtent(this._tileFetcher.filterExtent)):(this._loadingGraphics.forEach((e=>{this._view.graphics.removeMany(e)})),this._loadingGraphics.clear(),this._loadedGraphics.forEach((e=>{this._view.graphics.removeMany(e)})),this._loadedGraphics.clear(),this._pendingGraphics.forEach((e=>{this._view.graphics.removeMany(e)})),this._pendingGraphics.clear(),this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null))}showDataExtent(e){if(this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null),null==e)return;const t=Sa.A.fromExtent(e);this._dataExtentGraphic=new v.A({geometry:t,symbol:this._dataExtentSymbol}),this._view.graphics.add(this._dataExtentGraphic)}_synchronizeMaps(e,t){const i=[];e.forEach(((e,r)=>{const s=this._tileFetcher.test.getFeatureTileById(r);s&&t.filter(s)||(this._view.graphics.removeMany(e),i.push(r))})),i.forEach((t=>e.delete(t))),this._tileFetcher.test.forEachFeatureTile((i=>{if(t.filter(i)&&!e.has(i.id)){const[r,s,n]=i.descriptor.lij;this._tilingScheme.ensureMaxLod(r);const a=this._tilingScheme.getExtentGeometry(r,s,n),o=[new v.A({geometry:a,symbol:t.symbols[r%t.symbols.length]}),new v.A({geometry:a.center,symbol:new Ji.A({verticalOffset:new Sb.A({screenLength:40/.75}),callout:new Cb.A({color:"white",border:{color:"black"}}),symbolLayers:new S.A([new xb.A({text:`${r}/${s}/${n}`,halo:{color:"white",size:1/.75},material:{color:"black"},size:16})])})})];e.set(i.id,o),this._view.graphics.addMany(o)}}))}}let Ab=class extends((0,K.g)(n.A)){get dataUpdating(){return this._tileFetcher?.dataUpdating??!1}set extent(e){if(null!=e&&!e.spatialReference.equals(this.layerView.view.spatialReference))return void a.A.getLogger(this).error("#extent=","extent needs to be in the same spatial reference as the view");const t=this._get("extent");if(t===e)return;if(null!=t&&e&&t.equals(e))return;const i=null!=e?e.clone():null;this._set("extent",i)}get updating(){return!!(null!=this._tileFetcher&&this._tileFetcher.updating||null!=this._fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this._updatingHandles&&this._updatingHandles.updating)}get updatingTotal(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.updatingTotal:0}get updatingRemaining(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.updatingRemaining:0}get expectedFeatureDiff(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.expectedFeatureDiff:0}get memoryForUnusedFeatures(){return null!=this._tileFetcher?this._tileFetcher.memoryForUnusedFeatures:0}get maximumNumberOfFeaturesExceeded(){return!(null==this._tileFetcher||!this._tileFetcher.maximumNumberOfFeaturesExceeded)}get maximumNumberOfFeatures(){return this.displayFeatureLimit?.maximumNumberOfFeatures??0}set maximumNumberOfFeatures(e){e!==this.maximumNumberOfFeatures&&this._overrideIfSome("maximumNumberOfFeatures",e)}get hasMaximumNumberOfFeaturesOverride(){return this._isOverridden("maximumNumberOfFeatures")}get hasAllFeatures(){return this.serviceDataCount===Mb.noServiceDataCount&&"snapshot"===this.mode&&this.hasAllFeaturesInView||this.serviceDataCount===this.graphics.length}get hasAllFeaturesInView(){return this._tileFetcher?.hasAllFeatures??!1}get hasFullGeometries(){return this._tileFetcher?.hasFullGeometries??!1}get mode(){const e=this.layerView.layer;if("feature"===e.type&&null!=e.infoFor3D)return"snapshot";if(this._forceTilesMode)return"tiles";const t=this.layerView.view;if(!1===t.qualitySettings?.graphics3D?.snapshotAvailable||this.serviceDataCount===Mb.noServiceDataCount||this._snapshotLimitExceeded||this.maximumNumberOfFeaturesExceeded||t.quality<1)return"tiles";const i=t&&t.featureTiles,r=i&&i.tilingScheme;if(e&&e.minScale&&this.serviceDataExtent&&r){const t=this._approximateExtentSizeAtScale(e.minScale,r);if((this.serviceDataExtent.width/t+this.serviceDataExtent.height/t)/2>Mb.maxSnapshotMinScaleFactor)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}get maxTotalSnapshotVertices(){const e=this._get("maxTotalSnapshotVertices")||0,t="snapshot"===this.mode&&this._tileFetcher?.totalVertices||0;return Math.max(e,t)}_approximateExtentSizeAtScale(e,t){const i=this.layerView.view,r=Math.ceil((i.width/t.pixelSize+i.height/t.pixelSize)/2),s=t.levels[0];return r*((s.tileSize[0]/(s.scale/e)+s.tileSize[1]/(s.scale/e))/2)}get tileDescriptors(){const e=this.layerView.view.featureTiles;return"snapshot"===this.mode?new S.A([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):e?e.tiles:new S.A}get test(){return{fetchDataInfoPromise:this._fetchDataInfoPromise,tileFetcher:this._tileFetcher}}constructor(e){super(e),this.type="feature-tile-3d",this._updatingHandles=new L.U,this.serviceDataExtent=null,this.serviceDataCount=Mb.noServiceDataCount,this._snapshotLimitExceeded=!1,this.displayFeatureLimit=null,this._forceTilesMode=!1,this._suspended=!1,this._tileFetcher=null,this._fetchDataInfoPromise=null,this._fetchDataInfoAbortController=null,this._lifeCycleAbortController=new AbortController}initialize(){this._updatingHandles.add((()=>this.displayFeatureLimit),(e=>this._updatingHandles.addPromise(this._updateSnapshotLimit(e,null,this._lifeCycleAbortController.signal)))),this._updatingHandles.add((()=>this.mode),(()=>this._modeChanged()),l.Vh),this._updatingHandles.add((()=>this.mode),((e,t)=>{"tiles"===e&&"snapshot"===t&&(this._forceTilesMode=!0)}),l.Vh),this.addResolvingPromise(Promise.resolve().then((()=>this._verifyCapabilities())).then((()=>this._updatingHandles.addPromise(this._fetchServiceDataInfo()))).then((()=>this._initializeTileFetcher())))}_verifyCapabilities(){const e=this.layerView.layer;if("ogc-feature"!==e.type&&!(0,jv.BR)(e)?.operations.supportsQuery)throw new le.A("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})}destroy(){this._cancelFetchServiceDataInfo(),this._tileFetcher=(0,ce.pR)(this._tileFetcher),this._tilesHandle=(0,ce.xt)(this._tilesHandle),this._lifeCycleAbortController=(0,ce.DC)(this._lifeCycleAbortController),this._updatingHandles.destroy(),this._set("_updatingHandles",null)}suspend(){this._suspended||(this._suspended=!0,null!=this._tileFetcher&&this._tileFetcher.suspend())}resume(){this._suspended&&(this._suspended=!1,null!=this._tileFetcher&&this._tileFetcher.resume())}restart(){const e=()=>{null!=this._tileFetcher&&this._tileFetcher.restart()};this._updatingHandles.addPromise(this._fetchServiceDataInfo().then(e,e))}refetch(){this._refetch({resetForceTilesMode:!1})}getMissingAttributesForFeature(e){return this._tileFetcher?.getMissingAttributesForFeature(e)}_refetch(e){const t=()=>{null!=this._tileFetcher&&(e.resetForceTilesMode&&(this._forceTilesMode=!1),this._tileFetcher.refetch())};this._updatingHandles.addPromise(this._fetchServiceDataInfo().then(t,t))}_initializeTileFetcher(){const e=this.layerView.view;if(!e)return;const t=(0,l.C_)((()=>e.featureTiles?.tilingScheme),this._lifeCycleAbortController.signal);this._updatingHandles.addPromise(t),t.then((()=>{const{layerView:e,tileDescriptors:t}=this,i=e.layer,r=new hb({context:this.context,filterExtent:this.extent,tileDescriptors:t,features:this.graphics});this._tileFetcher=r,this._suspended?r.suspend():r.resume();const s=this.layerView.view;s&&this.addHandles((0,l.wB)((()=>s.quality),(e=>r.memoryFactor=e),l.pc));const n="polygon"===this.context.geometryType?"polygonLodFactor":"polyline"===this.context.geometryType?"polylineLodFactor":null;n&&this.addHandles((0,l.wB)((()=>this.layerView.view?.qualitySettings?.graphics3D?.[n]),(e=>r.lodFactor=e||1),l.Vh)),"ogc-feature"!==i.type&&this._updatingHandles.add((()=>i.createQueryVersion),(()=>this._dataFilterChanged())),this._updatingHandles.add((()=>e.availableFields),((e,t)=>this._availableFieldsChanged(t,e))),this._updatingHandles.add((()=>e.requiredFields),((e,t)=>this._requiredFieldsChanged(t,e))),"customParameters"in i&&this._updatingHandles.add((()=>i.customParameters),(()=>this.restart())),this.addHandles([i.on("apply-edits",(e=>this._applyEdits(e))),(0,l.wB)((()=>this.extent),(e=>r.filterExtent=e),l.OH),(0,l.wB)((()=>this.tileDescriptors),(e=>r.tileDescriptors=e),l.OH),(0,l.wB)((()=>this.maximumNumberOfFeatures),(e=>{r.maximumNumberOfFeatures=e,r.useTileCount=this.serviceDataCount>e}),l.pc),(0,l.wB)((()=>this.serviceDataCount),(e=>{r.useTileCount=e>this.maximumNumberOfFeatures}),l.pc),(0,l.wB)((()=>Is.b.FEATURE_TILE_FETCH_SHOW_TILES),(e=>{e&&r&&!r.debugger?(r.debugger=new Eb(r,s.featureTiles.tilingScheme.toTileInfo(),s),r.debugger.update()):!e&&this._tileFetcher&&r.debugger&&(r.debugger.destroy(),r.debugger=null)}),l.pc)]),this._supportsExceedsLimitQuery||this._updatingHandles.add((()=>this.maxTotalSnapshotVertices),(()=>this._updatingHandles.addPromise(this._updateSnapshotLimit(this.displayFeatureLimit,null,this._lifeCycleAbortController.signal))))})).catch((()=>{}))}_modeChanged(){switch(this.mode){case"tiles":this._tilesHandle||(this._tilesHandle=this.layerView.view.featureTiles.addClient());break;default:a.A.getLogger(this).warn("Unhandled feature layer mode "+this.mode);case"snapshot":null!=this._tilesHandle&&(this._tilesHandle.remove(),this._tilesHandle=null)}}_dataFilterChanged(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this._refetch({resetForceTilesMode:!0})}_applyEdits(e){null!=this._tileFetcher&&this._tileFetcher.applyEdits(e).then((e=>{if(e){if(!this._lifeCycleAbortController)throw(0,o.NK)();e.exceededTransferLimit?this.layerView.layer.refresh():(e.deletedFeatures.length||e.updatedFeatures.length||e.addedFeatures.length)&&this._updatingHandles.addPromise(this._updateServiceDataExtent(this._lifeCycleAbortController.signal))}})).catch((e=>{if(!(0,o.zf)(e))throw e}))}_availableFieldsChanged(e,t){null!=this._tileFetcher&&Pb(this._tileFetcher.availableFields,t)&&this._refetch({resetForceTilesMode:!1})}_requiredFieldsChanged(e,t){null!=this._tileFetcher&&Pb(this._tileFetcher.availableFields,t)&&this.restart()}_createVertexLimitExceededQuery(e){const t=this.layerView.layer,i=t.createQuery();return i.returnGeometry=!1,i.outStatistics=[new Zv.A({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],t.capabilities?.query.supportsCacheHint&&(i.cacheHint=!0),i}_createDataInfoQuery(){const e=this.layerView.layer,t=e.createQuery();return t.returnGeometry=!1,t.outSpatialReference=this.layerView.view.spatialReference,e.capabilities?.query.supportsCacheHint&&(t.cacheHint=!0),t}_fullExtentIsAccurate(){const e=this.layerView.layer;if("definitionExpression"in e&&e.definitionExpression)return!1;switch(e.type){case"feature":case"oriented-imagery":return(0,Wv.Wo)(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}async _updateServiceDataExtent(e){try{await this._tryUpdateServiceDataExtent(e)}catch(e){(0,o.zf)(e)||this._set("serviceDataExtent",(0,ut.o8)(this.layerView.fullExtentInLocalViewSpatialReference))}}async _tryUpdateServiceDataExtent(e){const t=this.layerView,i=t.layer,r=i.capabilities?.query.supportsExtent??!1,s=(0,ut.o8)(t.fullExtentInLocalViewSpatialReference),n=i.fullExtent,a=this._fullExtentIsAccurate(),o=this.serviceDataCount;if(r&&o<=Mb.maxFeatureCountForExtent&&(!s||!a)&&"queryExtent"in i){const t=this._createDataInfoQuery(),r=await i.queryExtent(t,{timeout:Mb.queryExtentTimeout,signal:e});this._set("serviceDataExtent",r.extent)}else if(s)this._set("serviceDataExtent",s);else if(null!=n){const r="portalItem"in i?i.portalItem:null,s=await(0,kv.projectGeometry)(n,t.view.spatialReference,r,e);this._set("serviceDataExtent",s)}else this._set("serviceDataExtent",null)}async _updateServiceDataCount(e){const t=this.layerView.layer;if(!("queryFeatureCount"in t)||!(0,d.A)("featurelayer-snapshot-enabled"))return void this._set("serviceDataCount",Mb.noServiceDataCount);const i=await(0,dt.Ke)(t.queryFeatureCount(this._createDataInfoQuery(),{timeout:Mb.queryStatisticsTimeout,signal:e}));if(!0===i.ok)this._set("serviceDataCount",i.value);else{if((0,o.zf)(i.error))throw i.error;this._set("serviceDataCount",Mb.noServiceDataCount)}}get _supportsExceedsLimitQuery(){const e=this.layerView.layer;return null!=e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}get _minimumNumberOfVerticesForGeometry(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}async _updateSnapshotLimit(e,t,i){if(null==e?.averageSymbolComplexity)return void(this._snapshotLimitExceeded=!1);const{maximumTotalNumberOfVertices:r,averageSymbolComplexity:s}=e,{verticesPerFeature:n,verticesPerCoordinate:a}=s,l=n<=0,c=this._minimumNumberOfVerticesForGeometry>1;if(!l&&!c)return void(this._snapshotLimitExceeded=!1);0!==n&&null!=t&&await t;const h=Math.min(r,Tb),u=this.serviceDataCount,p=u!==Mb.noServiceDataCount;let f=p?Math.ceil((h-u*n)/(a||1)):Math.ceil(h/(a||1));if(c&&(f=Math.min(f,Ob)),p&&this._minimumNumberOfVerticesForGeometry*u>f)return void(this._snapshotLimitExceeded=!0);if(!this._supportsExceedsLimitQuery||!(0,d.A)("featurelayer-snapshot-enabled"))return void(this._snapshotLimitExceeded=this.maxTotalSnapshotVertices>f);const g=await(0,dt.Ke)(this.layerView.layer.queryFeatures(this._createVertexLimitExceededQuery(f),{timeout:Mb.queryStatisticsTimeout,signal:i}));if(!1===g.ok){if((0,o.zf)(g.error))throw g.error;return void(this._snapshotLimitExceeded=!1)}const m=g.value.features[0];this._snapshotLimitExceeded=!!m?.attributes&&!!m.attributes.exceedslimit}async _fetchServiceDataInfo(){this._cancelFetchServiceDataInfo();let e=new AbortController;const t=e.signal,i=this._updateServiceDataCount(t),r=Promise.allSettled([i,this._updateSnapshotLimit(this.displayFeatureLimit,i,t)]),s=r.then((()=>this._updateServiceDataExtent(t))).catch((e=>{(0,o.zf)(e)||a.A.getLogger(this).error("#fetchServiceDataInfo()",e)})).then((()=>{s===this._fetchDataInfoPromise&&(this._fetchDataInfoPromise=null,this._fetchDataInfoAbortController=null),e=null}));return e&&(this._fetchDataInfoPromise=s),this._fetchDataInfoAbortController=e,r.then((()=>{}),(()=>{}))}_cancelFetchServiceDataInfo(){const e=this._fetchDataInfoAbortController;e&&(this._fetchDataInfoAbortController=null,this._fetchDataInfoPromise=null,e.abort())}get performanceInfo(){return{storedFeatures:this._tileFetcher?.storedFeatures??0,totalFeatures:this._tileFetcher?.totalFeatures??0,totalVertices:this._tileFetcher?.totalVertices??0,missingTiles:this._tileFetcher?.missingTiles??0}}};(0,r._)([(0,h.MZ)({readOnly:!0})],Ab.prototype,"type",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Ab.prototype,"graphics",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Ab.prototype,"layerView",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Ab.prototype,"context",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],Ab.prototype,"dataUpdating",null),(0,r._)([(0,h.MZ)()],Ab.prototype,"extent",null),(0,r._)([(0,h.MZ)()],Ab.prototype,"updating",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ab.prototype,"_updatingHandles",void 0),(0,r._)([(0,h.MZ)()],Ab.prototype,"updatingTotal",null),(0,r._)([(0,h.MZ)()],Ab.prototype,"updatingRemaining",null),(0,r._)([(0,h.MZ)()],Ab.prototype,"expectedFeatureDiff",null),(0,r._)([(0,h.MZ)()],Ab.prototype,"memoryForUnusedFeatures",null),(0,r._)([(0,h.MZ)()],Ab.prototype,"maximumNumberOfFeaturesExceeded",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ab.prototype,"serviceDataExtent",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],Ab.prototype,"serviceDataCount",void 0),(0,r._)([(0,h.MZ)()],Ab.prototype,"_snapshotLimitExceeded",void 0),(0,r._)([(0,h.MZ)()],Ab.prototype,"displayFeatureLimit",void 0),(0,r._)([(0,h.MZ)({type:Number})],Ab.prototype,"maximumNumberOfFeatures",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ab.prototype,"hasAllFeatures",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ab.prototype,"hasAllFeaturesInView",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ab.prototype,"hasFullGeometries",null),(0,r._)([(0,h.MZ)()],Ab.prototype,"_forceTilesMode",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],Ab.prototype,"mode",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ab.prototype,"maxTotalSnapshotVertices",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Ab.prototype,"tileDescriptors",null),(0,r._)([(0,h.MZ)()],Ab.prototype,"_tileFetcher",void 0),(0,r._)([(0,h.MZ)()],Ab.prototype,"_fetchDataInfoPromise",void 0),Ab=(0,r._)([(0,u.$)("esri.layers.graphics.controllers.FeatureTileController3D")],Ab);const Tb=1e6,Ob=5e6;function Pb(e,t){if(!t)return!1;for(const i of t)if(!e.has(i))return!0;return!1}var Mb;!function(e){e.noServiceDataCount=1/0,e.maxSnapshotMinScaleFactor=5,e.reset=function(){e.maxFeatureCountForExtent=1e4,e.queryStatisticsTimeout=12e3,e.queryExtentTimeout=1e4}}(Mb||(Mb={})),Mb.reset();class Ib extends hv{constructor(e,t,i,r,s,n){super(e.usedMemory,e.displayedFeatures,e.totalFeatures,e.maximumFeatures,e.nodes,e.core),this.storedFeatures=t,this.totalVertices=i,this.partial=r,this.mode=s,this.symbolComplexity=n}}var Db=i(19541),Fb=i(26318),Lb=i(64672),Nb=i(54895);let Vb=class extends n.A{constructor(e){super(e),this._dirtyExtents=new Vv,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new xs.A}initialize(){const e=this.elevationProvider,t=this.graphicsCoreOwner.view.resourceController.scheduler;this._task=t.registerTask(Gb(this.graphicsCore.layer.elevationInfo?.mode),this),this.addHandles([e.on("elevation-change",(e=>this._elevationChanged(e))),(0,l.wB)((()=>this.graphicsCoreOwner.suspended),(()=>this._suspendedChange())),this._task,(0,l.wB)((()=>Gb(this.graphicsCore.layer.elevationInfo?.mode)),(e=>this._task.priority=e))])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(e){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,e.madeProgress()),e.run((()=>this._dirtyExtents.merge(e)));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.notifyChange("updating")}_updateDirtyGraphics(e){const t=this.graphicsCoreOwner.view.renderCoordsHelper,i=this.graphicsCore.effectiveUpdatePolicy===xo.ASYNC;for(const r of this._dirtyGraphicsSet.keys()){const s=this.graphicsCore.getGraphics3DGraphicById(r);if(this._dirtyGraphicsSet.delete(r),null!=s&&(s.alignWithElevation(this.elevationProvider,t,i),this.graphicsCoreOwner.view.deconflictor.setDirty(),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this._dirtyExtents.empty&&!e.done;){const t=this._dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});const r=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,i,(e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);null!=t&&t.needsElevationUpdates()&&this._dirtyGraphicsSet.add(e)})),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-r)+.9*this._averageExtentUpdateSize,e.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((e,t)=>this._dirtyGraphicsSet.add(t)))}_elevationChanged(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const t=e.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",e)}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange("updating")}};function Gb(e){return null==e?Ee.W6.ELEVATION_ALIGNMENT:"relative-to-scene"===e?Ee.W6.ELEVATION_ALIGNMENT_SCENE:Ee.W6.ELEVATION_ALIGNMENT}function Ub(e,t,i,r){return function(e,t,i,r){r.clip[0]=0,r.clip[1]=i?r.len:Number.MAX_VALUE;for(let i=0;i<e.length;i++)if(!Bb(e[i],t,r))return!1;return!0}(e,t,i,function(e,t,i,r){const s=zb;return e?(i&&r&&(s.len=(0,M.p)(t,i)),(0,M.c)(s.dir,e)):r?(s.len=(0,M.p)(t,i),(0,M.f)(s.dir,i,t),(0,M.h)(s.dir,s.dir,1/s.len)):((0,M.f)(s.dir,i,t),(0,M.n)(s.dir,s.dir)),s}(r,t,i,!0))}(0,r._)([(0,h.MZ)()],Vb.prototype,"graphicsCoreOwner",void 0),(0,r._)([(0,h.MZ)()],Vb.prototype,"graphicsCore",void 0),(0,r._)([(0,h.MZ)()],Vb.prototype,"queryGraphicUIDsInExtent",void 0),(0,r._)([(0,h.MZ)()],Vb.prototype,"elevationProvider",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],Vb.prototype,"updating",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Vb.prototype,"updatingRemaining",null),Vb=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],Vb);const zb={dir:(0,I.vt)(),len:0,clip:(0,dr.vt)()};function Bb(e,t,i){const r=(0,M.j)((0,pr.Qj)(e),i.dir),s=-(0,pr.mN)(e,t);if(s<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return s>0;if((s<0||r<0)&&!(s<0&&r<0))return!0;const n=s/r;return r>0?n<i.clip[1]&&(i.clip[1]=n):n>i.clip[0]&&(i.clip[0]=n),i.clip[0]<=i.clip[1]}const Hb=.5*Math.PI,jb=Hb/Math.PI*180;class Wb{constructor(e){this._renderCoordsHelper=e.renderCoordsHelper,this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:(0,I.vt)(),direction:(0,I.vt)()};for(let e=0;e<4;e++)this._extent[e]={origin:(0,I.vt)(),direction:(0,I.vt)(),cap:{next:null,direction:(0,I.vt)()}},this._planes[e]=(0,pr.vt)();this._planes[Rt.FB.NEAR]=(0,pr.vt)(),this._planes[Rt.FB.FAR]=(0,pr.vt)(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,t,i,r=!0){const s=this._extent;this._toRenderBoundingExtent(e,t,i),(0,M.g)(this._center.origin,s[0].origin,s[2].origin),(0,M.h)(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),r||(0,M.h)(this._center.direction,this._center.direction,-1);for(let e=0;e<4;e++){const t=s[e];this._renderCoordsHelper.worldUpAtPosition(t.origin,t.direction);const i=s[3===e?0:e+1];t.cap.next=i.origin,(0,M.D)(t.cap.direction,t.origin,i.origin),(0,pr.mR)(t.direction,t.cap.direction,t.origin,this._planes[e]),r||(0,M.h)(t.direction,t.direction,-1)}(0,pr.mR)(s[0].cap.direction,s[1].cap.direction,s[0].origin,this._planes[Rt.FB.NEAR]),r?(0,pr.ze)(this._planes[Rt.FB.NEAR],this._planes[Rt.FB.FAR]):((0,pr.C)(this._planes[Rt.FB.FAR],this._planes[Rt.FB.NEAR]),(0,pr.ze)(this._planes[Rt.FB.NEAR],this._planes[Rt.FB.NEAR])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*(0,wt.tO)(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,i=!1){if(null==e)return!1;if(this._renderCoordsHelper.viewingMode===oe.RT.Global){const i=this._maxSpanSpatialReference.isGeographic?jb:Hb*t;if(this._maxSpan>i)return!0;if(null!=e.altitude&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(0===this._maxSpan){const t=this._extent[0];return!(i||!e.intersectsRay((0,fr.LV)(t.origin,t.direction)))}for(let t=0;t<this._extent.length;t++){const r=this._extent[t];if(!i&&e.intersectsRay((0,fr.LV)(r.origin,r.direction)))return!0;if(e.intersectsLineSegment((0,Ro.Cr)(r.origin,r.cap.next,Yb),r.cap.direction))return!0}const r=i?this._planes:this._planesWithoutFar;for(let t=0;t<e.lines.length;t++){const i=e.lines[t];if(Ub(r,i.origin,i.endpoint,i.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,t,i){(0,$.gX)(e,Zb),Zb[2]=i,(0,Et.l)(t,Zb,qb,this._renderCoordsHelper.spatialReference),(0,O.B8)($b,qb),(0,q.Ie)(Qb);for(const{x0:r,x1:s,y0:n,y1:a}of kb)for(let o=0;o<5;o++){const l=o/4;Zb[0]=(0,U.Cc)(e[r],e[s],l),Zb[1]=(0,U.Cc)(e[n],e[a],l),Zb[2]=i,(0,Z.F)(Zb,t,Zb,this._renderCoordsHelper.spatialReference),(0,M.e)(Zb,Zb,$b),(0,q.iT)(Qb,Zb)}(0,M.s)(this._extent[0].origin,Qb[0],Qb[1],Qb[2]),(0,M.s)(this._extent[1].origin,Qb[3],Qb[1],Qb[2]),(0,M.s)(this._extent[2].origin,Qb[3],Qb[4],Qb[2]),(0,M.s)(this._extent[3].origin,Qb[0],Qb[4],Qb[2]);for(let e=0;e<4;++e)(0,M.e)(this._extent[e].origin,this._extent[e].origin,qb)}_toRenderBoundingExtentLocal(e,t,i){ee(e,t,Jb,this._renderCoordsHelper.spatialReference),(0,M.s)(this._extent[0].origin,Jb[0],Jb[1],i),(0,M.s)(this._extent[1].origin,Jb[2],Jb[1],i),(0,M.s)(this._extent[2].origin,Jb[2],Jb[3],i),(0,M.s)(this._extent[3].origin,Jb[0],Jb[3],i)}_toRenderBoundingExtent(e,t,i){switch(this._renderCoordsHelper.viewingMode){case oe.RT.Global:this._toRenderBoundingExtentGlobal(e,t,i);break;case oe.RT.Local:this._toRenderBoundingExtentLocal(e,t,i);break;default:(0,or.Xb)(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(e){if((0,pr.mN)(e.planes[Rt.FB.NEAR],this._center.origin)<0&&(0,M.j)(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const i=this._extent[t];if((0,pr.mN)(e.planes[Rt.FB.NEAR],i.origin)<0&&(0,M.j)(i.direction,e.direction)<0)return!0}return!1}}const kb=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],Zb=(0,I.vt)(),qb=(0,P.vt)(),$b=(0,P.vt)(),Qb=(0,q.vt)(),Jb=(0,$.vt)(),Yb=(0,Ro.vt)();let Xb=class extends n.A{constructor(e){super(e),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){const{graphicsCoreOwner:e}=this;this._extentIntersection=new Wb({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,i=t.basemapTerrain,r=t.resourceController.scheduler;this.addHandles([t.on("resize",(()=>this._viewChange())),(0,l.wB)((()=>t.state.camera),(()=>this._viewChange()),l.OH),r.registerTask(Ee.W6.FRUSTUM_VISIBILITY,this),(0,l.wB)((()=>i.visibleElevationBounds),(()=>this._elevationBoundsChange()))]),"local"===t.viewingMode?this._isVisibleBelowSurface=!0:this.addHandles([(0,l.wB)((()=>[i.baseOpacity,i.wireframe,t.map?.ground?.navigationConstraint?.type]),(()=>this._updateIsVisibleBelowSurface()),l.Vh)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){const e=this.graphicsCoreOwner.view,t=e.basemapTerrain,i="local"===e.viewingMode,r="none"===e.map.ground?.navigationConstraint?.type;this._isVisibleBelowSurface=i||!t.opaque||r}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const e=this.graphicsCoreOwner.view;let t;if(this._isVisibleBelowSurfaceInternal)t=-.3*(0,wt.tO)(e.spatialReference).radius;else{const{min:i,max:r}=e.basemapTerrain.visibleElevationBounds;t=i-Math.max(1,(r-i)*(1.2-1))}this._extentIntersection.update(this._extent,e.spatialReference,t)}get running(){return this.updating}runTask(e){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),D_.G;this._updateExtentIntersection();const t=this.graphicsCoreOwner.view.frustum,i=(0,wt.tO)(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(t,i)),e.madeProgress()}};var Kb;(0,r._)([(0,h.MZ)({readOnly:!0})],Xb.prototype,"suspended",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Xb.prototype,"graphicsCoreOwner",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],Xb.prototype,"updating",void 0),Xb=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],Xb),function(e){e[e.Object=0]="Object",e[e.RenderGeometry=1]="RenderGeometry",e[e.External=2]="External",e[e.COUNT=3]="COUNT"}(Kb||(Kb={}));class ex{constructor(){this._items=[]}addObject(e,t){this._items.push({type:Kb.Object,objectStateId:t,object:e})}addRenderGeometry(e,t,i){this._items.push({type:Kb.RenderGeometry,objectStateId:t,renderGeometry:e,owner:i})}addExternal(e,t){this._items.push({type:Kb.External,objectStateId:t,remove:e})}remove(e){for(let t=this._items.length-1;t>=0;--t){const i=this._items[t];i.objectStateId===e&&(this._removeObjectStateItem(i),this._items.splice(t,1))}}removeObject(e){for(let t=this._items.length-1;t>=0;--t){const i=this._items[t];i.type===Kb.Object&&i.object===e&&(this._removeObjectStateItem(i),this._items.splice(t,1))}}removeRenderGeometry(e){for(let t=this._items.length-1;t>=0;--t){const i=this._items[t];i.type===Kb.RenderGeometry&&i.renderGeometry===e&&(this._removeObjectStateItem(i),this._items.splice(t,1))}}removeAll(){this._items.forEach((e=>{this._removeObjectStateItem(e)})),this._items=[]}_removeObjectStateItem(e){switch(e.type){case Kb.Object:e.objectStateId.channel===ge.Mg.Highlight?e.object.removeHighlight(e.objectStateId):e.objectStateId.channel===ge.Mg.MaskOccludee&&e.object.removeOcclude(e.objectStateId);break;case Kb.RenderGeometry:e.owner.removeRenderGeometryObjectState(e.renderGeometry,e.objectStateId);break;case Kb.External:e.remove(e.objectStateId)}}}class tx{constructor(e,t){this.stateType=e,this.objectIdField=t,this.objectStateSet=new ex,this.ids=new Set,this.paused=!1}hasGraphic(e){if(this.objectIdField){const t=e.graphic.attributes[this.objectIdField];return this.ids.has(t)}return this.ids.has(e.graphic.uid)}}class ix{constructor(e){this._graphicsCore=e,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach((e=>e.objectStateSet.removeAll())),this._stateSets.length=0)}acquireSet(e,t){const i=new tx(e,t);this._stateSets.push(i);const r=(0,w.hA)((()=>this.releaseSet(i)));return{set:i,handle:r}}releaseSet(e){e.objectStateSet.removeAll();const t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)}_addObjectStateSet(e,t){e.addObjectStateSet(t.stateType,t.objectStateSet)}_removeObjectStateSet(e,t){e.removeObjectState(t.objectStateSet)}setUid(e,t){e.ids.add(t);const i=this._graphicsCore.graphics3DGraphics.get(t);i&&this._addObjectStateSet(i,e)}setUids(e,t){t.forEach((t=>this.setUid(e,t)))}setObjectIds(e,t){t.forEach((t=>e.ids.add(t))),this._initializeSet(e)}addGraphic(e){this._stateSets.forEach((t=>{!t.paused&&t.hasGraphic(e)&&this._addObjectStateSet(e,t)}))}removeGraphic(e){this._stateSets.forEach((t=>{t.hasGraphic(e)&&this._removeObjectStateSet(e,t)}))}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach((e=>e.objectStateSet.removeAll()))}_initializeSet(e){const t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach((t=>{t&&e.hasGraphic(t)&&this._addObjectStateSet(t,e)})):e.ids.forEach((i=>{const r=t.get(i);r&&this._addObjectStateSet(r,e)}))}get test(){return{states:this._stateSets}}}function rx(e,t,i){if(!i||null==t)return null;if(!e)return function(e,t){const i=t.toLowerCase();for(const t in e)if(t.toLowerCase()===i)return e[t];return null}(t,i);const r=e.get(i);return r?t[r.name]:null}var sx=i(51216),nx=i(57179),ax=i(52790),ox=i(51387),lx=i(74704);const cx=ax.d;let hx=class extends n.A{get layer(){return this.context.layer}get spatialReference(){return this.context.spatialReference}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new Qv.A({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}constructor(e){super(e),this._dataQueryEngineInstance=null}destroy(){this.clear()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t,i){return this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,t),i)}async executeQueryForCount(e,t){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:i,extent:r}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:i,extent:pp.A.fromJSON(r)}}async executeQueryForIds(e,t){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){const i=await this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),r=lx.A.fromJSON(i);return r.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),r}async executeQuery(e,t){const i=await this._dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),r=lx.A.fromJSON(i);return r.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),r}_ensureQueryJSON(e,t){let i=this.defaultQueryJSON;if(null!=e&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),i=e.toJSON()),null!=t){const e=t.geometries.map((e=>e.toJSON())).reduce(((e,t)=>(e.rings=e.rings.concat(t.rings),e)));i={...i,sceneFilter:{...t,geometry:e}}}return i}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e="timeInfo"in this.layer&&this.layer.timeInfo?.toJSON()||null,t=this.layer.objectIdField,i=Jv.g.toJSON(this._queryGeometryType),r=this.layer.fieldsIndex?.toJSON()||new ox.A([]),s=this.priority,n=this.spatialReference.toJSON(),{hasZ:a,hasM:o,featureStore:l,scheduler:c}=this.context;return this._dataQueryEngineInstance=new cx({hasZ:a,hasM:o,geometryType:i,fieldsIndex:r,timeInfo:e,spatialReference:n,objectIdField:t,featureStore:l,scheduler:c,priority:s}),this._dataQueryEngineInstance}};(0,r._)([(0,h.MZ)({constructOnly:!0})],hx.prototype,"context",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],hx.prototype,"priority",void 0),(0,r._)([(0,h.MZ)()],hx.prototype,"layer",null),(0,r._)([(0,h.MZ)()],hx.prototype,"spatialReference",null),(0,r._)([(0,h.MZ)()],hx.prototype,"_queryGeometryType",null),(0,r._)([(0,h.MZ)()],hx.prototype,"defaultQueryJSON",null),hx=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.QueryEngine")],hx);let dx=class extends n.A{constructor(e){super(e),this._updateTask=null,this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new L.U,this._updateVisibility=async e=>{if(null==this._compositedFeatureFilter&&null==this._sceneFilter||0===this.context.getFeatureCount())return this._frameTask.schedule((()=>this.clear()),e);try{const t=await this._queryEngine.executeQueryForIdSet(this._compositedFeatureFilter,this._sceneFilter,e);return this._frameTask.schedule((()=>{this.context.updateFeatureVisibilities((e=>t.has(e)))}),e)}catch(t){return(0,o.QP)(t),a.A.getLogger(this).warn(`FeatureFilter query failed: ${t}`,{error:t}),this._frameTask.schedule((()=>{this.context.setAllFeaturesVisibility(!0)}),e)}}}initialize(){const e=Ee.W6.FILTER_VISIBILITY,{layer:t,view:i}=this._layerView,{featureStore:r}=this.context,s="hasZ"in this._layerView&&this._layerView.hasZ,n="hasM"in this._layerView&&this._layerView.hasM;this._queryEngine=new hx({context:{spatialReference:i.spatialReference,layer:t,scheduler:i.resourceController.scheduler,featureStore:r,hasM:n,hasZ:s},priority:e}),this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(e,this),this._updatingHandles.add((()=>[this._compositedFeatureFilter,this._sceneFilter]),(()=>this.reapply()),l.Vh)}destroy(){this._updateRequested=!1,this._updatingHandles.destroy(),this.clear(),this._updateTask=(0,ce.DC)(this._updateTask),this._frameTask=(0,ce.xt)(this._frameTask),this._queryEngine=(0,ce.pR)(this._queryEngine),this._set("context",null)}get updating(){return this.running||this._updatingHandles.updating||null!=this._updateTask&&!this._updateTask.finished}get running(){return this._updateRequested||this._frameTask.updating}get defaultVisibility(){return null==this._compositedFeatureFilter&&null==this._sceneFilter}get _featureFilter(){return"filter"in this._layerView?this._layerView.filter:null}get _sceneFilter(){return"layerFilter"in this._layerView?this._layerView.layerFilter:null}get _floorFilter(){return(0,nx.E)(this._layerView)}get _timeExtent(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:e,_timeExtent:t,_floorFilter:i}=this;if(null==t&&null==i)return e;const r=null!=e?e.clone():new sx.A;if(null!=t&&(r.timeExtent=null!=r.timeExtent?r.timeExtent.intersection(t):t),null!=i){const e=null==r.where||""===r.where;r.where=e?i:`(${r.where}) AND (${i})`}return r}get _layerView(){return this.context.layerView}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}runTask(e){if(this._updateRequested&&(this._updateTask=(0,ce.DC)(this._updateTask),this._updateTask=(0,dt.UT)(this._updateVisibility),this._updateRequested=!1,e.madeProgress()),this._frameTask.processQueue(e),!e.hasProgressed)return D_.G}};(0,r._)([(0,h.MZ)({constructOnly:!0})],dx.prototype,"context",void 0),(0,r._)([(0,h.MZ)()],dx.prototype,"updating",null),(0,r._)([(0,h.MZ)()],dx.prototype,"running",null),(0,r._)([(0,h.MZ)()],dx.prototype,"defaultVisibility",null),(0,r._)([(0,h.MZ)()],dx.prototype,"_featureFilter",null),(0,r._)([(0,h.MZ)()],dx.prototype,"_sceneFilter",null),(0,r._)([(0,h.MZ)()],dx.prototype,"_floorFilter",null),(0,r._)([(0,h.MZ)()],dx.prototype,"_timeExtent",null),(0,r._)([(0,h.MZ)()],dx.prototype,"_compositedFeatureFilter",null),(0,r._)([(0,h.MZ)()],dx.prototype,"_layerView",null),(0,r._)([(0,h.MZ)()],dx.prototype,"_updateTask",void 0),(0,r._)([(0,h.MZ)()],dx.prototype,"_updateRequested",void 0),dx=(0,r._)([(0,u.$)("esri.views.3d.layers.support.FeatureVisibilityFilter")],dx);let ux=class extends n.A{constructor(e){super(e),this.type="graphics-3d",this._randomRotationRenderers=null,this._updatingHandles=new L.U,this.elevationFeatureExpressionEnabled=!1,this.scaleVisibilityEnabled=!1,this.filterVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this.elevationAlignmentEnabled=!1,this.timeExtentEnabled=!1,this.setUidToIdOnAdd=!0,this.dataExtent=null,this.drapeSourceType=Ma.Features,this.preferredUpdatePolicy=xo.ASYNC,this._suspendResumeExtent=null}initialize(){const e=this.owner,t=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&"multipatch"!==e.layer.geometryType,i=new zy({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.hasZ,hasM:e.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:t=>e.view.deconflictor.addGraphicsOwner(t),labeler:(t,i)=>e.view.labeler.addGraphicsOwner(t,i),elevationAlignment:this.elevationAlignmentEnabled?(t,i)=>new Vb({graphicsCoreOwner:this,graphicsCore:t,queryGraphicUIDsInExtent:i,elevationProvider:e.view.elevationProvider}):null,scaleVisibility:this.scaleVisibilityEnabled?(t,i)=>new qy({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:i,graphicsCore:t,basemapTerrain:e.view.basemapTerrain}):null,filterVisibility:t?t=>new dx({context:{layerView:e,...t}}):null,objectStates:e=>new ix(e)}});this._set("graphicsCore",i),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new Xb({graphicsCoreOwner:this})),this.elevationAlignment&&this._updatingHandles.add((()=>this.layer.elevationInfo),((e,t)=>{(0,Ui.Ui)(e,t)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})),this._updatingHandles.add((()=>this.layer.labelsVisible),(()=>this.graphicsCore.updateVisibilityInfo())),this._updatingHandles.add((()=>this.layer.labelingInfo),((e,t)=>{(0,Ui.Ui)(e,t)&&this.graphicsCore.updateLabelingInfo()})),this._updatingHandles.add((()=>this.preferredUpdatePolicy),(e=>this.graphicsCore.preferredUpdatePolicy=e)),this._set("initializePromise",this._initializeAsync()),this._updatingHandles.addPromise(this.initializePromise)}async _initializeAsync(){await(0,o.Qg)(this.graphicsCore.initializePromise);const e=this.owner;this._updatingHandles.add((()=>this.renderer),(e=>this._updatingHandles.addPromise(this.graphicsCore.rendererChange(e)))),this._updatingHandles.add((()=>e.fullOpacity),(()=>this.graphicsCore.opacityChange())),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this._updatingHandles.add((()=>e.view.clippingArea),(()=>this._updateClippingExtent())),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await(0,o.Qg)(this.graphicsCore.updateLabelingInfo())}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",(0,ce.pR)(this.frustumVisibility)),this._set("graphicsCore",(0,ce.pR)(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get dataUpdating(){return this.graphicsCore?.dataUpdating??!1}get renderer(){const{renderer:e,objectIdField:t}=this.layer;if(!e||!t||"heatmap"===e.type||!e.visualVariables)return e;const i=e.visualVariables.findIndex((e=>"rotation"===e.type&&null!=e.valueExpression&&(0,Nb.D)(e.valueExpression)===t&&(null==e.axis||"heading"===e.axis)&&"geographic"===e.rotationType));if(i<0)return e;const r=e.clone();return r.visualVariables.splice(i,1),this._randomRotationRenderers||(this._randomRotationRenderers=new WeakMap),this._randomRotationRenderers.set(r,t),r}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get filterVisibility(){return this.graphicsCore?.filterVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get objectStates(){return this.graphicsCore?.objectStates}get suspendResumeExtentMode(){return"suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}get scaleVisibilitySuspended(){return null!=this.scaleVisibility&&this.scaleVisibility.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return null==this.frustumVisibility||!this.frustumVisibility.suspended}get suspendInfo(){const e={};return this.scaleVisibilitySuspended&&(e.outsideScaleRange=!0),null!=this.frustumVisibility&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){return!!(this.graphicsCore?.updating||this.frustumVisibility?.updating||this._updatingHandles.updating)}get updatingRemaining(){return this.graphicsCore?.updatingRemaining??0}get featureStore(){return this.graphicsCore?.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner?.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get symbolUpdateType(){return this.graphicsCore?.symbolUpdateType}get displayFeatureLimit(){const e=this.view.quality,t=this.graphicsCore?.displayFeatureLimit;if(1===e)return t;const i=Math.ceil(t.maximumNumberOfFeatures*e);return new ms(t.maximumTotalNumberOfVertices,i,t.averageSymbolComplexity)}get usedMemory(){return this.graphicsCore?.usedMemory??0}get loadedFeatures(){return this.graphicsCore?.numberOfGraphics??0}get usedMemoryPerFeature(){return this.graphicsCore?.usedMemoryPerGraphic??0}get unprocessedMemoryEstimate(){return this.graphicsCore?.unprocessedMemoryEstimate??0}get performanceInfo(){return this.graphicsCore.performanceInfo}maskOccludee(e){const{set:t,handle:i}=this.objectStates.acquireSet(ge.Mg.MaskOccludee,null);return this.objectStates.setUid(t,e.uid),i}highlight(e,t){if(e instanceof Qv.A){const{set:i,handle:r}=this.objectStates.acquireSet(ge.Mg.Highlight,t);return this.owner.queryObjectIds(e).then((e=>this.objectStates.setObjectIds(i,e))),r}if("number"==typeof e||"string"==typeof e)return this.highlight([e],t);if(e instanceof v.A)return this.highlight([e],t);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof v.A){const i=e;if(null==rx(this.layer.fieldsIndex,i[0].attributes,t)){const e=i.map((e=>e.uid)),{set:t,handle:r}=this.objectStates.acquireSet(ge.Mg.Highlight,null);return this.objectStates.setUids(t,e),r}e=i.map((e=>rx(this.layer.fieldsIndex,e.attributes,t)))}if(Array.isArray(e)&&("number"==typeof e[0]||"string"==typeof e[0])){const i=e,{set:r,handle:s}=this.objectStates.acquireSet(ge.Mg.Highlight,t);return this.objectStates.setObjectIds(r,i),s}}return(0,w.hA)()}resetObjectStates(){this.objectStates.reset()}whenGraphicBounds(e,t){return this.graphicsCore?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.graphicsCore?.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}getRenderingInfo(e,t,i){const r=function(e,t){const i=Pa(e,t),r=function(e,t){if(null!=e.symbol)return e.symbol;const i=Pa(e,t);return null!=i&&"dot-density"!==i.type?i.getSymbol(e,t):null}(e,t);if(null==r)return null;const s={renderer:i,symbol:r};if(null==i||!("visualVariables"in i)||!i.visualVariables)return s;const n=(0,Ni.getVisualVariableValues)(i,e,t)??[],a=["proportional","proportional","proportional"];for(const{variable:e,value:t}of n)switch(e.type){case"color":s.color=t.toRgba();break;case"size":if("outline"===e.target)s.outlineSize=t;else{const i=e.axis,r=e.useSymbolValue?"symbol-value":t;switch(i){case"width":a[0]=r;break;case"depth":a[1]=r;break;case"height":a[2]=r;break;case"width-and-depth":a[0]=a[1]=r;break;default:a[0]=a[1]=a[2]=r}}break;case"opacity":s.opacity=t;break;case"rotation":switch(e.axis){case"tilt":s.tilt=t;break;case"roll":s.roll=t;break;default:s.heading=t}}return"proportional"===a[0]&&"proportional"===a[1]&&"proportional"===a[2]||(s.size=a),s}(e,{renderer:t,arcade:i});if(r?.color){const e=r.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255}if(null!=r&&null!=t&&this._randomRotationRenderers?.has(t)){const i=this._randomRotationRenderers.get(t),s=e.attributes[i],n=new Fb.b(0);n.updateFloatArray([s]),n.updateUint8Array([173]),r.heading=8.381e-8*n.digest()}return r}getRenderingInfoAsync(e,t,i,r){return async function(e,t){const i=Pa(e,t),r=await async function(e,t){if(null!=e.symbol)return e.symbol;const i=Pa(e,t);return null!=i?i.getSymbolAsync(e,t):null}(e,t);if(!r)return null;const s={renderer:i,symbol:r};if(!i||!("visualVariables"in i)||!i.visualVariables)return s;const n=(0,Ni.getVisualVariableValues)(i,e,t)??[],a=["proportional","proportional","proportional"];for(const{variable:e,value:t}of n)if("color"===e.type)s.color=y.A.toUnitRGBA(t);else if("size"===e.type)if("outline"===e.target)s.outlineSize=t;else{const i=e.axis,r=e.useSymbolValue?"symbol-value":t;"width"===i?a[0]=r:"depth"===i?a[1]=r:"height"===i?a[2]=r:a[0]=a[1]="width-and-depth"===i?r:a[2]=r}else"opacity"===e.type?s.opacity=t:"rotation"===e.type&&"tilt"===e.axis?s.tilt=t:"rotation"===e.type&&"roll"===e.axis?s.roll=t:"rotation"===e.type&&(s.heading=t);return(isFinite(a[0])||isFinite(a[1])||isFinite(a[2]))&&(s.size=a),s}(e,{renderer:t,arcade:i,...r})}getSymbolLayerSize(e,t){return this.graphicsCore?.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){this.graphicsCore?.setObjectIdVisibility(e,t)}refreshFilter(){null!=this.filterVisibility&&this.filterVisibility.reapply()}getGraphics3DGraphicByObjectId(e){return this.graphicsCore?.getGraphics3DGraphicByObjectId(e)}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.addHandles((0,l.wB)((()=>this.suspendResumeExtentMode),(()=>{switch(this.removeHandles(px),this.suspendResumeExtentMode){case"computed":this.addHandles([(0,l.wB)((()=>this.graphicsCore.computedExtent),(e=>this._updateSuspendResumeExtent(e)),l.Vh),(0,l.wB)((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent)))],px);break;case"data":this.addHandles([(0,l.z7)((()=>this.dataExtent),(e=>this._updateSuspendResumeExtent(e)),l.Vh),(0,l.wB)((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.dataExtent)))],px);break;default:(0,or.Xb)(this.suspendResumeExtentMode)}}),l.Vh))}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(e,t){const i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!(0,Lb.y7)(e,i))return;e=(0,Lb.Cv)(e,i)}return function(e,t,i,r=0){if(e){t||(t=(0,$.vt)());const s=e;let n=.5*s.width*(i-1),a=.5*s.height*(i-1);return s.width<1e-7*s.height?n+=a/20:s.height<1e-7*s.width&&(a+=n/20),(0,D.s)(t,s.xmin-n-r,s.ymin-a-r,s.xmax+n+r,s.ymax+a+r),t}return null}(e,t,1.2,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){null!=this.frustumVisibility&&this.frustumVisibility.setExtent(e),null!=this.scaleVisibility&&this.scaleVisibility.setExtent(e)}};(0,r._)([(0,h.MZ)()],ux.prototype,"type",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],ux.prototype,"owner",void 0),(0,r._)([(0,h.MZ)()],ux.prototype,"layer",null),(0,r._)([(0,h.MZ)({readOnly:!0})],ux.prototype,"dataUpdating",null),(0,r._)([(0,h.MZ)()],ux.prototype,"renderer",null),(0,r._)([(0,h.MZ)({constructOnly:!0})],ux.prototype,"updateClippingExtent",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],ux.prototype,"elevationFeatureExpressionEnabled",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],ux.prototype,"graphicsCore",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],ux.prototype,"scaleVisibilityEnabled",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],ux.prototype,"filterVisibilityEnabled",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],ux.prototype,"frustumVisibilityEnabled",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],ux.prototype,"elevationAlignmentEnabled",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],ux.prototype,"timeExtentEnabled",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],ux.prototype,"setUidToIdOnAdd",void 0),(0,r._)([(0,h.MZ)()],ux.prototype,"scaleVisibility",null),(0,r._)([(0,h.MZ)()],ux.prototype,"filterVisibility",null),(0,r._)([(0,h.MZ)()],ux.prototype,"elevationAlignment",null),(0,r._)([(0,h.MZ)({constructOnly:!0})],ux.prototype,"frustumVisibility",void 0),(0,r._)([(0,h.MZ)()],ux.prototype,"objectStates",null),(0,r._)([(0,h.MZ)()],ux.prototype,"initializePromise",void 0),(0,r._)([(0,h.MZ)()],ux.prototype,"suspendResumeExtentMode",null),(0,r._)([(0,h.MZ)()],ux.prototype,"dataExtent",void 0),(0,r._)([(0,h.MZ)()],ux.prototype,"scaleVisibilitySuspended",null),(0,r._)([(0,h.MZ)()],ux.prototype,"suspended",null),(0,r._)([(0,h.MZ)()],ux.prototype,"legendEnabled",null),(0,r._)([(0,h.MZ)()],ux.prototype,"suspendInfo",null),(0,r._)([(0,h.MZ)()],ux.prototype,"updating",null),(0,r._)([(0,h.MZ)()],ux.prototype,"updatingRemaining",null),(0,r._)([(0,h.MZ)()],ux.prototype,"featureStore",null),(0,r._)([(0,h.MZ)()],ux.prototype,"view",null),(0,r._)([(0,h.MZ)()],ux.prototype,"loadedGraphics",null),(0,r._)([(0,h.MZ)()],ux.prototype,"fullOpacity",null),(0,r._)([(0,h.MZ)()],ux.prototype,"filter",null),(0,r._)([(0,h.MZ)()],ux.prototype,"slicePlaneEnabled",null),(0,r._)([(0,h.MZ)()],ux.prototype,"drapeSourceType",void 0),(0,r._)([(0,h.MZ)()],ux.prototype,"updatePolicy",null),(0,r._)([(0,h.MZ)()],ux.prototype,"preferredUpdatePolicy",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],ux.prototype,"displayFeatureLimit",null),ux=(0,r._)([(0,u.$)("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],ux);const px="suspendResumeExtentMode",fx={candidates:[],sourceCandidateIndices:[]};var gx=i(84459),mx=i(91582),_x=i(10961),yx=i(67277);new yx._(It.r.POSITION,3,_t.pe.FLOAT,0,12),new yx._(It.r.POSITION,3,_t.pe.FLOAT,0,20),new yx._(It.r.UV0,2,_t.pe.FLOAT,12,20),new yx._(It.r.POSITION,3,_t.pe.FLOAT,0,32),new yx._(It.r.NORMAL,3,_t.pe.FLOAT,12,32),new yx._(It.r.UV0,2,_t.pe.FLOAT,24,32),new yx._(It.r.POSITION,3,_t.pe.FLOAT,0,16),new yx._(It.r.COLOR,4,_t.pe.UNSIGNED_BYTE,12,16);const vx=[new yx._(It.r.POSITION,2,_t.pe.FLOAT,0,8)],bx=[new yx._(It.r.POSITION,2,_t.pe.FLOAT,0,16),new yx._(It.r.UV0,2,_t.pe.FLOAT,8,16)];var xx=i(77148);class Sx extends Ka.Y{constructor(){super(...arguments),this.colorRamp=null,this.densityMap=null,this.searchRadius=1,this.fieldTotal=0,this.minDensity=0,this.maxDensity=100}}class wx extends Jn.w{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){return new Xn.B(e.rctx,wx.shader.get().build(this.configuration),Yn.D)}initializePipeline(){return(0,ea.Ey)({blending:Oo.V0,colorWrite:ea.wE,depthTest:null,depthWrite:null})}get primitiveType(){return _t.WR.TRIANGLE_STRIP}}wx.shader=new Qn.$(xx.H,(()=>i.e(4092).then(i.bind(i,84092))));class Cx extends ra.E{constructor(){super(...arguments),this.usesHalfFloat=!1}}(0,r._)([(0,ia.W)()],Cx.prototype,"usesHalfFloat",void 0);var Rx=i(49214);let Ex=class extends Lh{constructor(e){super(e),this.pixelRatio=1,this._colorRampData=new Uint8ClampedArray(4),this.type="draped-heatmap",this._heatmapParameters=new Sx;const t=new jh.R;t.pixelFormat=e.pixelFormat,t.internalFormat=e.internalFormat,t.dataType=e.dataType,t.samplingMode=e.samplingMode,t.wrapMode=_t.pF.CLAMP_TO_EDGE;const i=e.rendererContext.rctx;this._densityMap=new Rx.H(i,t),this._quad=function(e,t=vx,i=Yn.D,r=-1,s=1){let n=null;return n=t===bx?new Float32Array([r,r,0,0,s,r,1,0,r,s,0,1,s,s,1,1]):new Float32Array([r,r,s,r,r,s,s,s]),new _h(e,i,{geometry:t},{geometry:yh.g.createVertex(e,_t._U.STATIC_DRAW,n)})}(i);const r=new Cx;r.usesHalfFloat=e.dataType!==_t.ld.FLOAT,this._technique=new wx({rctx:i,viewingMode:oe.RT.Local},r)}initialize(){const e=this._colorRampData,t=new jh.R(e.length/4,1);t.wrapMode=_t.pF.CLAMP_TO_EDGE,this._colorRamp=new wl.g(this.rctx,t,e),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.addHandles((0,l.wB)((()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius]),(()=>this.rendererContext.notifyContentChanged())))}destroy(){this._technique=(0,ce.Gz)(this._technique),this._densityMap=(0,ce.WD)(this._densityMap),this._quad=(0,ce.WD)(this._quad),this._colorRamp=(0,ce.WD)(this._colorRamp)}get searchRadius(){return this._heatmapParameters.searchRadius}set searchRadius(e){e!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=e,this.notifyChange("searchRadius"))}get minDensity(){return this._heatmapParameters.minDensity}set minDensity(e){e!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=e,this.notifyChange("minDensity"))}get maxDensity(){return this._heatmapParameters.maxDensity}set maxDensity(e){e!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=e,this.notifyChange("maxDensity"))}get fieldTotal(){return this._heatmapParameters.fieldTotal}set fieldTotal(e){this._heatmapParameters.fieldTotal=e,this.notifyChange("fieldTotal")}get colorRampData(){return this._colorRampData}set colorRampData(e){const{colorRamp:t}=this._heatmapParameters;if(null!=t&&e!==this._colorRampData){const i=t.descriptor.width,r=e.length/4;r!==i&&t.resize(r,1),t.setData(e)}this._colorRampData=e}get _colorRamp(){return this._heatmapParameters.colorRamp}set _colorRamp(e){this._heatmapParameters.colorRamp=e}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccludedDraped(){return!1}render(e){const t=this._sortedMaterialRenderers;if(0===t.length)return;const i=this.rctx.getBoundFramebufferObject(),r=this.rctx.getViewport(),{pixelRatio:s}=this,n=Math.ceil(r.width*s),a=Math.ceil(r.height*s);this._densityMap.resize(n,a),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,n,a),this.rctx.clear(_t.hn.COLOR_BUFFER_BIT);let o=!1;t.forAll((t=>{const i=t.prepareTechnique(e);null!=i&&(t.renderNode(e,i),o=!0)})),this.rctx.bindFramebuffer(i),this.rctx.setViewport(r.x,r.y,r.width,r.height),o&&(this.rctx.bindVAO(this._quad),this.rctx.bindTechnique(this._technique,e.bindParameters,this._heatmapParameters),this.rctx.drawArrays(this._technique.primitiveType,0,(0,ig.mT)(this._quad,"geometry")))}};(0,r._)([(0,h.MZ)()],Ex.prototype,"searchRadius",null),(0,r._)([(0,h.MZ)()],Ex.prototype,"minDensity",null),(0,r._)([(0,h.MZ)()],Ex.prototype,"maxDensity",null),(0,r._)([(0,h.MZ)()],Ex.prototype,"fieldTotal",null),(0,r._)([(0,h.MZ)()],Ex.prototype,"pixelRatio",void 0),(0,r._)([(0,h.MZ)()],Ex.prototype,"colorRampData",null),(0,r._)([(0,h.MZ)({constructOnly:!0})],Ex.prototype,"dataType",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Ex.prototype,"samplingMode",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Ex.prototype,"pixelFormat",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Ex.prototype,"internalFormat",void 0),(0,r._)([(0,h.MZ)()],Ex.prototype,"_colorRampData",void 0),Ex=(0,r._)([(0,u.$)("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],Ex);var Ax=i(80506);class Tx extends Zn.qA{constructor(){super(...arguments),this.searchRadius=128,this.resolutionForScale=0}}class Ox extends Jn.w{initializeProgram(e){return new Xn.B(e.rctx,Ox.shader.get().build(this.configuration),Yn.D)}initializePipeline(){return(0,ea.Ey)({blending:(0,ea.ox)(_t.dn.ONE,_t.dn.ONE,_t.Tb.ADD),colorWrite:ea.wE,depthTest:null,depthWrite:null})}destroy(){super.destroy()}}Ox.shader=new Qn.$(Ax.H,(()=>i.e(1466).then(i.bind(i,81466))));class Px extends ra.E{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloat=!1}}(0,r._)([(0,ia.W)()],Px.prototype,"isAttributeDriven",void 0),(0,r._)([(0,ia.W)()],Px.prototype,"usesHalfFloat",void 0);class Mx extends Tx{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloats=!1}}class Ix extends Zn.im{constructor(e){super(e,new Mx),this.produces=new Map([[qn.N.DRAPED_MATERIAL,e=>e===Wn.V.Color]]),this._configuration=new Px}getConfiguration(){return this._configuration.isAttributeDriven=this.parameters.isAttributeDriven,this._configuration.usesHalfFloat=this.parameters.usesHalfFloats,this._configuration}createGLMaterial(e){return new Dx(e)}intersect(){}intersectDraped(e,t,i,r,s,n){const a=e.attributes.get(It.r.POSITION),{parameters:o}=this,{searchRadius:l}=o,{screenToWorldRatio:c}=e,h=l*c+2*c,d=h*h,u=a.data.length/a.size;for(let e=0;e<u;e++){const t=e*a.size,i=(0,xa.hZ)(Gx,a.data[t],a.data[t+1]);(0,xa.hG)(i,r)<d&&s(n.dist,n.normal,-1,!1)}}createBufferWriter(){return new Fx(this.parameters.isAttributeDriven?Nx:Lx)}}class Dx extends kn.A{beginSlot(e){return this.ensureTechnique(Ox,e)}}class Fx{constructor(e){this.vertexBufferLayout=e}elementCount(e){return e.attributes.get(It.r.POSITION).indices.length*Vx}write(e,t,i,r,s){(0,$n.Hk)(i.attributes.get(It.r.POSITION),e,r.position,s,Vx);const n=i.attributes.get(It.r.POSITION).indices.length,a=r.uv0;let o=s;for(let e=0;e<n;++e)a.setValues(o++,-1,-1),a.setValues(o++,1,-1),a.setValues(o++,1,1),a.setValues(o++,1,1),a.setValues(o++,-1,1),a.setValues(o++,-1,-1);const l=It.r.FEATUREATTRIBUTE in r?r.featureAttribute:null;l&&(0,$n.uO)(i.attributes.get(It.r.FEATUREATTRIBUTE),l,s,Vx)}}const Lx=(0,jn.BP)().vec3f(It.r.POSITION).vec2f(It.r.UV0),Nx=Lx.clone().f32(It.r.FEATUREATTRIBUTE),Vx=6,Gx=(0,dr.vt)();var Ux=i(70838);let zx=class extends n.A{constructor(e){super(e),this.type="heatmap",this.preferredUpdatePolicy=xo.ASYNC,this.dataExtent=null,this.drapeSourceType=Ma.Features,this._renderGeometries=new Map,this._fieldTotal=0,this._drapeSourceRenderer=null,this._dataType=_t.ld.HALF_FLOAT,this._pixelFormat=_t.Ab.RGBA,this._updatingHandles=new L.U,this.initializePromise=Promise.resolve()}initialize(){this._featureStore=new mx.A({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});const{dataType:e,samplingMode:t,pixelFormat:i,internalFormat:r}=(0,Ux.S)(this._renderView.renderingContext,a.A.getLogger(this));this._dataType=e,this._pixelFormat=i;const s=e!==_t.ld.FLOAT;this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerDrapeSource(this,Ex,{...this._rendererParameters,dataType:e,samplingMode:t,pixelFormat:i,internalFormat:r}),this._material=new Ix({usesHalfFloats:s}),this._materialWithField=new Ix({usesHalfFloats:s,isAttributeDriven:!0}),this._filterVisibility=new dx({context:{layerView:this.owner,featureStore:this.featureStore,getFeatureCount:()=>this._loadedPointGraphics.length,setAllFeaturesVisibility:e=>this._setAllFeaturesVisibility(e),clearFeaturesVisibility:()=>this._setAllFeaturesVisibility(!0),updateFeatureVisibilities:e=>this._updateFeatureVisibilities(e)}}),this._updatingHandles.addOnCollectionChange((()=>this._loadedPointGraphics),(e=>this._onLoadedFeaturesChange(e)),l.Vh),this._updatingHandles.addWhen((()=>this._materialParameters),(e=>this._forEachMaterial((t=>t.setParameters(e)))),l.Vh),this._updatingHandles.add((()=>this._rendererParameters),(e=>this._drapeSourceRenderer.set(e))),this._updatingHandles.add((()=>this._heatmapRendererField),(()=>{this._recreate()}),l.OH),this._updatingHandles.add((()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric})),(({fieldName:e,numeric:t})=>{if(null!=e&&t){let t=0;this._featureStore.forEach((i=>t+=i.attributes[e]??0)),this._fieldTotal=t}else this._fieldTotal=this._featureStore.numFeatures}),l.Vh),this.addHandles([(0,l.wB)((()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField})),(({fieldName:e,field:t})=>{e&&!t&&a.A.getLogger(this).warn(`Heatmap renderer field '${e}' for layer '${this.layer.title??this.layer.id}' not found`)})),(0,l.wB)((()=>({field:this._heatmapRendererField,numeric:this._heatmapRendererFieldIsNumeric})),(({field:e,numeric:t})=>{null==e||t||a.A.getLogger(this).warn(`Heatmap renderer field '${e.name}' for layer '${this.layer.title??this.layer.id}' does not contain numeric values and cannot be used to drive the heatmap density`)})),(0,w.hA)((()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this)))])}destroy(){this._renderGeometries.clear(),this._material=null,this._materialWithField=null,this._featureStore.clear(),this._featureStore=null,this._updatingHandles.destroy()}get layer(){return this.owner.layer}get featureStore(){return this._featureStore}get updating(){return this._updatingHandles.updating||this.filterVisibility.updating}get updatingRemaining(){return 0}get suspendInfo(){return{}}get legendEnabled(){return!0}get filterVisibility(){return this._filterVisibility}get displayFeatureLimit(){const e=this.owner?.view?.quality??1,t=this.owner?.view?.qualitySettings,i=t?Math.ceil(t.heatmap.maxTotalNumberOfFeatures*e):0;return new ms(6*i,i)}get hasZ(){return"hasZ"in this.layer&&this.layer.hasZ}get hasM(){return"hasM"in this.layer&&this.layer.hasM}get view(){return this.owner.view}get fullOpacity(){return this.owner.fullOpacity}get updatePolicy(){return this.owner.updatePolicy}get scaleVisibilitySuspended(){if(!this._isScaleRangeActive)return!1;const{minScale:e,maxScale:t}=this.layer.effectiveScaleRange,{scale:i}=this.view;return!(0,Ri.JU)(i,e??0,t??0)}get usedMemory(){const e=this.usedMemoryPerFeature*this._featureStore.numFeatures,t=this._pixelFormat===_t.Ab.RED?1:4,i=this._dataType===_t.ld.FLOAT?4:2,r=Math.ceil((this._overlayRenderer?.overlays[0]?.resolution??0)*this._densityMapPixelRatio)??0;return r*r*t*i+e}get usedMemoryPerFeature(){const e=this._loadedPointGraphics.find((()=>!0));if(null==e)return 0;const t=(0,va.eY)(e),i=(0,va.f3)();return 6*(0,va.zd)([0,0,0],i)+6*(0,va.zd)([0,0],i)+(this._heatmapRendererFieldIsNumeric?6*i:0)+t}get loadedFeatures(){return this._featureStore.numFeatures}get unprocessedMemoryEstimate(){return 0}get performanceInfo(){return new yy(this._visibleFeatures,0,0)}get renderer(){return this._heatmapRenderer}get _overlayRenderer(){return this.view.basemapTerrain.overlayManager.renderer}get _overlaySpatialReference(){return this._overlayRenderer.spatialReference}get _rendererParameters(){return{...this._radiusParameter,...this._densityParameters,...this._colorRampParameter,...this._pixelRatioParameter}}get _materialParameters(){return{...this._radiusParameter,...this._resolutionForScaleParameter}}get _densityParameters(){const e=this._heatmapRenderer;if(null==e)return null;const{minDensity:t,maxDensity:i}=e;return{minDensity:t,maxDensity:i,fieldTotal:this._fieldTotal}}get _radiusParameter(){const e=this._heatmapRenderer;return e?{searchRadius:(0,Ms.Lz)(this._clampSearchRadius(e.radius))}:null}get _resolutionForScaleParameter(){const e=this._heatmapRenderer;if(!e)return null;const{referenceScale:t}=e;return{resolutionForScale:0===t?0:(0,gx.i1)(t,this.view.spatialReference)}}get _colorRampParameter(){const e=this._heatmapRenderer;return e?{colorRampData:(0,_x.O3)(e.colorStops)}:null}get _pixelRatioParameter(){return{pixelRatio:this._densityMapPixelRatio}}get _densityMapPixelRatio(){return this.owner?.view?.qualitySettings.heatmap.pixelRatio??1}get _renderView(){return this.view._stage.renderView}get _featuresArePoints(){return"point"===this.layer.geometryType}get _loadedPointGraphics(){return this.owner.loadedGraphics}get _heatmapRenderer(){const e=this.layer.renderer;return"heatmap"===e?.type?e:null}get _heatmapRendererFieldName(){return this._heatmapRenderer?.field}get _heatmapRendererField(){const e=this._heatmapRendererFieldName;return null!=e?this.layer.fieldsIndex.get(e):null}get _heatmapRendererFieldIsNumeric(){const e=this._heatmapRendererField;return null!=e&&(0,Li.WA)(e)}get _isScaleRangeActive(){const{layer:e}=this;if(!("effectiveScaleRange"in e))return!1;const{minScale:t,maxScale:i}=e.effectiveScaleRange;return(0,Ri.WK)(t,i)}get _visibleFeatures(){let e=0;return this._renderGeometries.forEach((t=>{t.visible&&++e})),e}async whenGraphicBounds(){return null}computeAttachmentOrigin(){return null}highlight(){return(0,w.hA)()}maskOccludee(){return(0,w.hA)()}setObjectIdVisibility(){}refreshFilter(){this.filterVisibility.reapply()}_onLoadedFeaturesChange(e){if(!this._featuresArePoints)return;const{objectIdField:t}=this.layer;this._featureStore.removeManyById(e.removed.map((e=>(0,ki.RW)(e,t)))),this._featureStore.addMany(e.added.map((e=>{const{attributes:i,centroid:r,geometry:s}=e,n=new Ss.Om((0,wa.qN)(new ws.A,s),i,r?(0,wa.qN)(new ws.A,r):null,(0,ki.RW)(e,t));return n.displayId=e.uid,n})));const i=e.added,r=e.removed;this._fieldTotal+=this._computeFieldTotalChange(i,r);const s=r.map((({uid:e})=>{const t=this._renderGeometries.get(e);return this._renderGeometries.delete(e),t})).filter(b.Ru),n=i.map((e=>{const t=this._pointGraphicToRenderGeometry(e);return this._renderGeometries.set(e.uid,t),t}));s.length>0&&this._drapeSourceRenderer.removeGeometries(s,Kc.REMOVE),n.length>0&&this._drapeSourceRenderer.addGeometries(n,Kc.ADD),(n.length>0||s.length>0)&&(this.filterVisibility.reapply(),this._renderView.requestRender())}_recreate(){if(!this._loadedPointGraphics)return;const e=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:e,removed:e})}_pointGraphicToRenderGeometry(e){const t=this._heatmapRendererFieldName,i=null!=t?this._materialWithField:this._material,r=(0,I.vt)();(0,Cn.g)(e.geometry,r,this._overlaySpatialReference),r[2]=-2;const s=(0,Y.tM)(1),n=[[It.r.POSITION,new gr.n(r,s,r.length)]],a=this._heatmapRendererFieldIsNumeric;null!=t&&n.push([It.r.FEATUREATTRIBUTE,new gr.n([a?e.attributes[t]??0:0],s,1)]);const o=new su(new _r.V(i,n,null,mr.X.Point),{layerUid:this.layer.uid,graphicUid:e.uid});return o.visible=this.filterVisibility.defaultVisibility,o}_forEachMaterial(e){e(this._material),e(this._materialWithField)}_computeFieldTotalChange(e,t){if(null==this._heatmapRendererFieldName||!this._heatmapRendererFieldIsNumeric)return e.length-t.length;const i=this._heatmapRendererFieldName,r=(e,t)=>e+(t.attributes[i]??0);return e.reduce(r,0)-t.reduce(r,0)}_clampSearchRadius(e){return e>112&&a.A.getLogger(this).warnOnce("SceneView supports a maximum radius of 112 pt for HeatmapRenderer."),Math.min(e,112)}_updateFeatureVisibilities(e){const t=[];this._featureStore.forEach((({objectId:i,displayId:r})=>{const s=e(i),n=this._renderGeometries.get(r);n&&n.visible!==s&&(t.push(n),n.visible=s)})),this._drapeSourceRenderer.modifyGeometries(t,eh.VISIBILITY)}_setAllFeaturesVisibility(e){const t=[];for(const i of this._renderGeometries.values())i.visible!==e&&(t.push(i),i.visible=e);this._drapeSourceRenderer.modifyGeometries(t,eh.VISIBILITY)}get test(){return{visibleFeatureCount:this._visibleFeatures}}};(0,r._)([(0,h.MZ)()],zx.prototype,"type",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],zx.prototype,"owner",void 0),(0,r._)([(0,h.MZ)()],zx.prototype,"layer",null),(0,r._)([(0,h.MZ)()],zx.prototype,"featureStore",null),(0,r._)([(0,h.MZ)()],zx.prototype,"updating",null),(0,r._)([(0,h.MZ)()],zx.prototype,"updatingRemaining",null),(0,r._)([(0,h.MZ)()],zx.prototype,"suspendInfo",null),(0,r._)([(0,h.MZ)()],zx.prototype,"legendEnabled",null),(0,r._)([(0,h.MZ)()],zx.prototype,"filterVisibility",null),(0,r._)([(0,h.MZ)()],zx.prototype,"displayFeatureLimit",null),(0,r._)([(0,h.MZ)()],zx.prototype,"preferredUpdatePolicy",void 0),(0,r._)([(0,h.MZ)()],zx.prototype,"hasZ",null),(0,r._)([(0,h.MZ)()],zx.prototype,"hasM",null),(0,r._)([(0,h.MZ)()],zx.prototype,"dataExtent",void 0),(0,r._)([(0,h.MZ)()],zx.prototype,"view",null),(0,r._)([(0,h.MZ)()],zx.prototype,"fullOpacity",null),(0,r._)([(0,h.MZ)()],zx.prototype,"updatePolicy",null),(0,r._)([(0,h.MZ)()],zx.prototype,"drapeSourceType",void 0),(0,r._)([(0,h.MZ)()],zx.prototype,"scaleVisibilitySuspended",null),(0,r._)([(0,h.MZ)()],zx.prototype,"renderer",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_featureStore",void 0),(0,r._)([(0,h.MZ)()],zx.prototype,"_filterVisibility",void 0),(0,r._)([(0,h.MZ)()],zx.prototype,"_overlayRenderer",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_overlaySpatialReference",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_rendererParameters",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_materialParameters",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_densityParameters",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_radiusParameter",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_resolutionForScaleParameter",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_colorRampParameter",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_pixelRatioParameter",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_densityMapPixelRatio",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_renderGeometries",void 0),(0,r._)([(0,h.MZ)()],zx.prototype,"_material",void 0),(0,r._)([(0,h.MZ)()],zx.prototype,"_materialWithField",void 0),(0,r._)([(0,h.MZ)()],zx.prototype,"_renderView",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_featuresArePoints",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_loadedPointGraphics",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_heatmapRenderer",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_heatmapRendererFieldName",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_heatmapRendererField",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_heatmapRendererFieldIsNumeric",null),(0,r._)([(0,h.MZ)()],zx.prototype,"_fieldTotal",void 0),(0,r._)([(0,h.MZ)()],zx.prototype,"_drapeSourceRenderer",void 0),(0,r._)([(0,h.MZ)()],zx.prototype,"_isScaleRangeActive",null),zx=(0,r._)([(0,u.$)("esri.views.3d.layers.support.HeatmapFeatureProcessor")],zx);const Bx=e=>{let t=class extends e{constructor(){super(...arguments),this._dataUpdatingState=Hx.NONE,this.controller=null,this.updatePolicy=xo.SYNC,this.suspendResumeExtentMode="computed",this.slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.suspendResumeExtent=null,this._controllerCreated=!1,this.supportsHeightUnitConversion=!0,this._pendingController=null,this.queryEngine=null}initialize(){const e=this.layer;if("isTable"in e&&e.isTable)return void this.addResolvingPromise(Promise.reject(new le.A("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e})));this.addResolvingPromise(this._validateGeometryType()),this._updatingHandles.add((()=>this.layer.renderer),(e=>this._recreateProcessor(e)),l.Vh),this.addResolvingPromise((async()=>{const e=await function(e){const t=e.view.spatialReference,i=e.layer.fullExtent,r=null!=i&&i.spatialReference;if(null==i||!r)return Promise.resolve(null);if(r.equals(t))return Promise.resolve(i.clone());const s=(0,Lb.Cv)(i,t);return null!=s?Promise.resolve(s):e.view.state.isLocal?(0,kv.projectGeometry)(i,t,e.layer.portalItem).then((t=>!e.destroyed&&t?t:null)).catch((()=>null)):Promise.resolve(null)}(this);this.fullExtentInLocalViewSpatialReference=e,await this._initializeController()})()),this._updatingHandles.add((()=>this.updatePolicy),(e=>this.processor.preferredUpdatePolicy=e));const t=()=>this.processor.featureStore;this.queryEngine=new hx({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return t()},hasZ:this.hasZ,hasM:this.hasM},priority:Ee.W6.FEATURE_QUERY_ENGINE}),this.notifyChange("updating")}destroy(){this._destroyPendingController(),this.controller=(0,ce.pR)(this.controller),this._set("processor",(0,ce.pR)(this.processor)),this.queryEngine=(0,ce.pR)(this.queryEngine),this.loadedGraphics=null}_destroyPendingController(){this._pendingController=(0,ce.pR)(this._pendingController)}get dataUpdating(){return this._dataUpdatingState!==Hx.NONE}get legendEnabled(){return this.canResume()&&this.processor?.legendEnabled}get graphics3DProcessor(){return"graphics-3d"===this.processor?.type?this.processor:null}get heatmapProcessor(){return"heatmap"===this.processor?.type?this.processor:null}get symbologySnappingSupported(){const e=this.layer?.renderer?.getSymbols();return e?.some(Id.f3)??!1}get hasAllFeatures(){return!(!this.controller||!("hasAllFeatures"in this.controller))&&this.controller.hasAllFeatures}get hasAllFeaturesInView(){return!(!this.controller||!("hasAllFeaturesInView"in this.controller))&&this.controller.hasAllFeaturesInView}get hasFullGeometries(){return!(!this.controller||!("hasFullGeometries"in this.controller))&&this.controller.hasFullGeometries}getHit(e){let t;return this.loadedGraphics?.forEach((i=>{i.uid===e&&(t=Jt(i,this.layer))})),t?{type:"graphic",graphic:t,layer:t.layer}:null}whenGraphicBounds(e,t){return this.processor?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.processor?.computeAttachmentOrigin(e,t)}async elevationAlignPointsInFeatures(e,t){const i=this.graphics3DProcessor;if(null==i)throw new le.A("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");return async function(e,t,i,r,s){const{elevationProvider:n,renderCoordsHelper:a}=e,{elevationInfo:l}=t,{pointsInFeatures:c,spatialReference:h}=r,d=qt.A.fromJSON(h),u=ni(l,!0),p=await ii(u,d,s);(0,o.Te)(s);const f=[],g=new Set,m=new Set,_=new ci,y=(0,ne.T)(0,0,0,qt.A.WGS84),v=new Bt,b=(0,I.vt)();y.spatialReference=d;const x=e.elevationProvider.spatialReference??e.spatialReference;for(const{objectId:e,points:r}of c){const o=i(e);if(null==o){for(const e of r)f.push(e.z??0);g.add(e);continue}o.isDraped&&m.add(e);const c=o.graphic.geometry;_.setFromElevationInfo((0,Db.ze)(c,l)),_.updateFeatureExpressionInfoContext(p,o.graphic,t);for(const{x:e,y:t,z:i}of r)y.x=e,y.y=t,y.z=i??0,await(0,Cn.W)(y,b,x,0,{signal:s}),Ft(b,n,_,a,v),f.push(v.z)}return{elevations:f,drapedObjectIds:m,failedObjectIds:g}}(this.view,this.layer,(e=>i.getGraphics3DGraphicByObjectId(e)),e,t)}async queryForSymbologySnapping(e,t){return this.symbologySnappingSupported?async function(e,t,i){if(null==e||0===t.candidates.length)return fx;const r=e.graphics3DGraphicsByObjectID??e.graphics3DGraphics,s=[],n=[],{renderer:a}=e,l=null!=a&&"arcadeRequired"in a&&a.arcadeRequired?(0,ti.lw)():null,c=async(t,{graphic:r,graphics3DSymbol:s})=>{const n=await l,o=await e.getRenderingInfoAsync(r,a,n,{signal:i});return null==o?[]:s.queryForSnapping(t,d,o,i)},{candidates:h,spatialReference:d}=t;for(let e=0;e<h.length;++e){const t=h[e],{objectId:i}=t,a="number"==typeof i?r?.get(i):void 0;if(null==a)continue;const{graphics3DSymbol:o}=a;o.symbologySnappingSupported&&(s.push(c(t,a)),n.push(e))}if(0===s.length)return fx;const u=await Promise.all(s);(0,o.Te)(i);const p=[],f=[];for(let e=0;e<u.length;++e){const t=u[e],i=n[e];for(const e of t)p.push(e),f.push(i)}return{candidates:p,sourceCandidateIndices:f}}(this.graphics3DProcessor,e,t):{candidates:[],sourceCandidateIndices:[]}}queryFeatures(e,t){return this.queryEngine.executeQuery(this._ensureQuery(e),t?.signal)}queryObjectIds(e,t){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),t?.signal)}queryFeatureCount(e,t){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),t?.signal)}queryExtent(e,t){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),t?.signal)}_ensureQuery(e){return null==e?this.createQuery():Qv.A.from(e)}highlight(e){return this.processor.highlight(e,this.layer.objectIdField)}maskOccludee(e){return this.processor.maskOccludee(e)}canResume(){return super.canResume()&&!this.processor?.scaleVisibilitySuspended}getSuspendInfo(){const e=super.getSuspendInfo();return this.processor?{...e,...this.processor.suspendInfo}:e}isUpdating(){return!(!this.processor||this.processor.destroyed||this._controllerCreated&&!this.controller?.updating&&this.view?.basemapTerrain?.ready&&!this.processor.updating)}async _initializeController(){const e=this.createController();this._pendingController=e,this._setupDataUpdating(e),await e.when(),this._setControllerWhenInitialized(e)}_setupDataUpdating(e){"dataUpdating"in e&&this.addHandles([(0,l.wB)((()=>e.dataUpdating),(e=>{e&&this._dataUpdatingState===Hx.NONE?this._dataUpdatingState=Hx.CONTROLLER:e||this._dataUpdatingState!==Hx.CONTROLLER||(this._dataUpdatingState=Hx.NONE)}),l.OH),(0,l.wB)((()=>!!this.graphics3DProcessor?.dataUpdating),(t=>{t&&this._dataUpdatingState===Hx.CONTROLLER?this._dataUpdatingState=Hx.CORE:t||this._dataUpdatingState!==Hx.CORE||(this._dataUpdatingState=e.dataUpdating?Hx.CONTROLLER:Hx.NONE)}),l.OH)])}async _setControllerWhenInitialized(e){try{await this.when()}catch(e){}this._controllerCreated=!0,this.notifyChange("updating"),this.isResolved()&&!this.destroyed?(await(0,l.C_)((()=>this.view?.basemapTerrain?.ready)),this.beforeSetController(e),this._pendingController=null,this.controller=e,this.loadedGraphics=e.graphics,this.notifyChange("updating")):this._destroyPendingController()}_updateClippingExtent(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}}async _validateGeometryType(){switch(this.layer.geometryType){case"multipatch":case"multipoint":throw new le.A("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType})}}_recreateProcessor(e){const t="heatmap"===e?.type,i="heatmap"===this.processor?.type,r=this.processor;if(r&&t===i)return;const s=t?new zx({owner:this}):new ux({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:e=>this._updateClippingExtent(e)});this._set("processor",s),r?.destroy(),this.queryEngine?.clear(),this.addResolvingPromise(s.initializePromise)}get performanceInfo(){const e=this.controller instanceof Ab?this.controller:null;return new hv(this.processor.usedMemory,this.loadedGraphics?.length,e?.serviceDataCount??-1,e?.maximumNumberOfFeatures??-1,0,this.processor.performanceInfo)}};return(0,r._)([(0,h.MZ)()],t.prototype,"loadedGraphics",void 0),(0,r._)([(0,h.MZ)()],t.prototype,"_dataUpdatingState",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],t.prototype,"dataUpdating",null),(0,r._)([(0,h.MZ)()],t.prototype,"suspended",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],t.prototype,"legendEnabled",null),(0,r._)([(0,h.MZ)()],t.prototype,"updating",void 0),(0,r._)([(0,h.MZ)()],t.prototype,"controller",void 0),(0,r._)([(0,h.MZ)()],t.prototype,"processor",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],t.prototype,"updatePolicy",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],t.prototype,"suspendResumeExtentMode",void 0),(0,r._)([(0,h.MZ)({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],t.prototype,"suspendInfo",void 0),(0,r._)([(0,h.MZ)()],t.prototype,"graphics3DProcessor",null),(0,r._)([(0,h.MZ)()],t.prototype,"heatmapProcessor",null),(0,r._)([(0,h.MZ)()],t.prototype,"symbologySnappingSupported",null),(0,r._)([(0,h.MZ)({readOnly:!0})],t.prototype,"hasAllFeatures",null),(0,r._)([(0,h.MZ)({readOnly:!0})],t.prototype,"hasAllFeaturesInView",null),(0,r._)([(0,h.MZ)({readOnly:!0})],t.prototype,"hasFullGeometries",null),t=(0,r._)([(0,u.$)("esri.views.3d.layers.FeatureLikeLayerView3D")],t),t};var Hx;!function(e){e[e.NONE=0]="NONE",e[e.CONTROLLER=1]="CONTROLLER",e[e.CORE=2]="CORE"}(Hx||(Hx={}));var jx=i(4197);const Wx=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(e){super.postscript(e),(0,jx.jI)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=new AbortController,t=e.signal;this.addHandles((0,w.hA)((()=>e.abort()))),await(0,l.C_)((()=>this.view.defaultsFromMap?.heightModelInfoReady),t),(0,o.Te)(t);const i=(0,jx.Hu)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(i)throw i}canResume(){const e=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!e?.minScale||!e.maxScale||e.minScale>=e.maxScale)}getSuspendInfo(){const e=super.getSuspendInfo(),t=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return t&&t.minScale&&t.maxScale&&t.minScale<t.maxScale&&(e.outsideScaleRange=!0),e}};return(0,r._)([(0,h.MZ)()],t.prototype,"view",void 0),(0,r._)([(0,h.MZ)()],t.prototype,"slicePlaneEnabled",void 0),t=(0,r._)([(0,u.$)("esri.views.3d.layers.LayerView3D")],t),t};var kx=i(95254);class Zx{constructor(e){this._controller=e,this._handle=new $x((t=>e.schedule(t)))}destroy(){this._handle.destroy()}invoke(e,t){return e.buffer&&0!==e.buffer.byteLength?(e.options.sourceSpatialReference&&e.options.sourceSpatialReference instanceof qt.A&&(e.options={...e.options,sourceSpatialReference:e.options.sourceSpatialReference.toJSON()}),this._handle.invoke(e,t).then((e=>{let t=0,i=0;const r=qt.A.fromJSON(e.spatialReference);e.spatialReference=r;const s=async n=>{const a=e.fields;if(a)for(;t<a.length;)if(a[t]=Yv.A.fromJSON(a[t]),t++,n.madeProgress())return this._controller.reschedule((e=>s(e)));const o=e.features;for(;i<o.length;){const e=o[i];++i,e.uid=v.A.generateUID();const t=e.geometry;if(null!=t&&(t.spatialReference=r,qx(t),n.madeProgress()))return this._controller.reschedule((e=>s(e)))}return e};return this._controller.schedule((e=>s(e)))}))):Promise.resolve(null)}}function qx(e){switch(e.type){case"polyline":e.paths.reduce(((e,t)=>e+t.length),0)<R.y9&&(e.paths=e.hasZ||e.hasM?e.paths.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.paths.map((e=>e.map((e=>[e[0],e[1]])))));break;case"polygon":e.rings.reduce(((e,t)=>e+t.length),0)<R.y9&&(e.rings=e.hasZ||e.hasM?e.rings.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.rings.map((e=>e.map((e=>[e[0],e[1]])))))}}class $x extends f.B{constructor(e){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:e=>[e.buffer]},e)}}let Qx=class extends n.A{constructor(e){super(e)}get implicitFields(){const e=this.layer.outFields?.includes("*");if(!e)return new Set;const t=new Set(this.layerView.requiredFields),i=new Set(this.layerView.availableFields);return(0,Na.iv)(i,t)}get queryFeaturesDehydrated(){const{layer:e}=this,t=e.capabilities,i=t&&t.query,r=i&&i.supportsFormatPBF,s=e.parsedUrl;if(r){null==this._decoder&&(this._decoder=new Zx(this.controller));const t={sourceSpatialReference:e.spatialReference?.toJSON()??null,applyTransform:!0,maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:Kx};return(e,i)=>(0,kx.GB)(s,e,"pbf",this._createRequestOptions(i)).then((e=>((0,o.Te)(i),null!=this._decoder?this._decoder.invoke({buffer:e.data,options:t},i.signal):Promise.reject((0,o.NK)()))))}return(t,i)=>(0,kx.eW)(s,t,e.spatialReference,this._createRequestOptions(i)).then((e=>(0,ki.JS)(e.data,{maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:Kx})))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}destroy(){this._decoder=(0,ce.pR)(this._decoder)}_createRequestOptions(e){return{...e,query:{...this.layer.customParameters,token:this.layer.apiKey,...e?.query}}}};(0,r._)([(0,h.MZ)({constructOnly:!0})],Qx.prototype,"layer",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Qx.prototype,"layerView",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Qx.prototype,"controller",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],Qx.prototype,"implicitFields",null),(0,r._)([(0,h.MZ)({readOnly:!0})],Qx.prototype,"queryFeaturesDehydrated",null),Qx=(0,r._)([(0,u.$)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],Qx);let Jx=class extends n.A{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};(0,r._)([(0,h.MZ)({constructOnly:!0})],Jx.prototype,"layer",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],Jx.prototype,"queryFeaturesDehydrated",null),Jx=(0,r._)([(0,u.$)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],Jx);let Yx=class extends n.A{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}};(0,r._)([(0,h.MZ)({constructOnly:!0})],Yx.prototype,"layer",void 0),Yx=(0,r._)([(0,u.$)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],Yx);let Xx=class extends n.A{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.source.queryFeaturesJSON(e,t).then(ki.JS,(i=>{if(i&&"query-features-json:unsupported"===i.name)return this.layer.queryFeatures(e,t);throw i}))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};(0,r._)([(0,h.MZ)({constructOnly:!0})],Xx.prototype,"layer",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Xx.prototype,"source",void 0),Xx=(0,r._)([(0,u.$)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],Xx);const Kx=1024;class eS{constructor(e){this._memoryCache=null,this._capabilities=null;const t=e.layerView.layer;this._layerView=e.layerView,this.objectIdField=t.objectIdField,this.globalIdField="globalIdField"in t?t.globalIdField:null,this._returnZ=e.returnZ,this._returnM=e.returnM;const i=this._layerView.view.resourceController;this.query=function(e,t){const{layer:i}=e;return"feature"===i.type&&"feature-layer"===i.source.type?null!=i.infoFor3D?new Jx({layer:i}):new Qx({layer:i,layerView:e,controller:t}):"feature"===i.type&&"memory"===i.source.type||"csv"===i.type||"geojson"===i.type||"oriented-imagery"===i.type||"wfs"===i.type?new Xx({layer:i,source:i.source}):"ogc-feature"===i.type?new Yx({layer:i}):null}(this._layerView,i.normal),i&&this._memoryCacheEnabled&&(this._memoryCache=i.memoryController.newCache(`fl-${t.uid}`))}get _memoryCacheEnabled(){switch(this._layerView.layer.source.type){case"feature-layer":case"ogc-feature":case"oriented-imagery":return!0;case"csv":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=(0,ce.pR)(this._memoryCache),this.query.destroy()}createQuery(){const e=this._layerView.layer.createQuery();return e.outFields=this._layerView.availableFields,e.returnZ=this._returnZ,e.returnM=this._returnM,e.outSpatialReference=this.tilingScheme.spatialReference,e}get memoryCache(){return this._memoryCache}get viewingMode(){return this._layerView.view.state.viewingMode}get tilingScheme(){return this._layerView.view.featureTiles.tilingScheme}get scheduler(){const e=this._layerView.view.resourceController;return e?e.scheduler:null}get geometryType(){return this._layerView.layer.geometryType}get fullExtent(){return this._layerView.layer.fullExtent}get tileMaxRecordCount(){return this._layerView.layer.capabilities.query.tileMaxRecordCount}get maxRecordCount(){return this._layerView.layer.capabilities.query.maxRecordCount}get capabilities(){return null!=this._capabilities||(this._capabilities=function(e){const t=e.capabilities.query;return{supportsMultipleResolutions:ub(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}(this._layerView.layer)),this._capabilities}logFetchError(e,t){e.error("#fetchTile()",this._layerView.layer,t?.message??t)}}var tS=i(40951);class iS extends xs.A{constructor(){super(...arguments),this._set=new Set,this._length=(0,ib.v)(0)}clear(){if(this._set.size>0){const e=this.toArray();this._set.clear(),this.emit("after-changes",{type:tS.R.REMOVE}),this.emit("change",{added:[],removed:e})}}get length(){return this._length.value}addMany(e){if(0!==e.length){for(const t of e)this._set.add(t);this._length.value=this._set.size,this.emit("after-changes",{type:tS.R.ADD}),this.emit("change",{added:e,removed:[]})}}remove(e){this._set.delete(e)&&(this._length.value=this._set.size,this.emit("after-changes",{type:tS.R.REMOVE}),this.emit("change",{added:[],removed:[e]}))}removeMany(e){const t=[];for(const i of e)this._set.delete(i)&&t.push(i);t.length>0&&(this._length.value=this._set.size,this.emit("after-changes",{type:tS.R.REMOVE}),this.emit("change",{added:[],removed:t}))}toArray(){return[...this._set]}find(e){let t;return(0,Na.bw)(this._set,(i=>!!e(i)&&(t=i,!0))),t}forEach(e){this._set.forEach((t=>e(t)))}}const rS={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};var sS=i(50241),nS=i(24775),aS=i(30386);let oS=class extends((0,aS.A)(Bx((0,sS.A)(Wx(nS.A))))){constructor(e){super(e),this._controllerTotal=0,this._processorTotal=0,this._needsRefresh=!1,this.suspendResumeExtentMode="data"}initialize(){this.addHandles([(0,l.wB)((()=>this._updatingRequiredFieldsPromise),(e=>this._updatingHandles.addPromise(e)),l.pc),(0,l.wB)((()=>({controller:this.controller,suspended:this.suspended})),(({controller:e,suspended:t})=>{e&&!t&&this._needsRefresh&&(e.refetch(),this._needsRefresh=!1)}))])}destroy(){this._updatingHandles.removeAll(),this._fetcherContext=(0,ce.pR)(this._fetcherContext)}get maximumNumberOfFeatures(){return this.controller?.maximumNumberOfFeatures??this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(e){this._set("maximumNumberOfFeatures",e),this.controller&&(this.controller.maximumNumberOfFeatures=e)}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){let e=0;if(this.controller?.updating){const t=this.controller.updatingRemaining,i=Math.max(this.controller.updatingTotal,this._controllerTotal);i>0&&(e=(i-t)/i,this._controllerTotal=i)}let t=0;if(this.processor?.updating){const e=this.processor.updatingRemaining,i=Math.max(e,this._processorTotal);i>0&&(t=(i-e)/i,this._processorTotal=i)}return.5*(e+t)}get updatePolicy(){if(!this.controller)return xo.ASYNC;switch(this.controller.mode){case"snapshot":{const e=lS.get(this.layer.geometryType);return null==e||this.controller.serviceDataCount>e?xo.ASYNC:xo.SYNC}case"tiles":return xo.ASYNC}}get hasZ(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsZ)&&("returnZ"in e&&null!=e.returnZ?e.returnZ:t.supportsZ)}get hasM(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsM)&&"returnM"in e&&null!=e.returnM&&e.returnM}setVisibility(e,t){this.processor?.setObjectIdVisibility(e,t)}createQuery(){return super.createQuery()}queryFeatures(e,t){const i=()=>super.queryFeatures(e,t);return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(e),i):i()}beforeSetController(e){e.maximumNumberOfFeatures=this.maximumNumberOfFeatures}createController(){this._fetcherContext=new eS({layerView:this,returnZ:this.hasZ,returnM:this.hasM});const e=new Ab({layerView:this,context:this._fetcherContext,graphics:new iS,extent:this.clippingExtent});return this._updatingHandles.add((()=>e.serviceDataExtent),(e=>{this.processor&&(this.processor.dataExtent=e)}),l.Vh),this.addHandles((0,l.wB)((()=>this.suspended),(t=>{t?e.suspend():e.resume()}),l.pc)),this._updatingHandles.add((()=>this.processor?.displayFeatureLimit),(t=>e.displayFeatureLimit=t),l.Vh),this.addHandles((0,l.z7)((()=>!this.updating),(()=>{this._controllerTotal=0,this._processorTotal=0}))),e}async doRefresh(e){const{controller:t,processor:i,suspended:r}=this;e&&t&&(r?this._needsRefresh=!0:(t.refetch(),this._needsRefresh=!1)),i.refreshFilter()}_popupFeatureHasRequiredFields(e,t){if(!super._popupFeatureHasRequiredFields(e,t))return!1;const i=(0,ki.RW)(e,this.layer.objectIdField);if(null==i)return!0;const r=this.controller.getMissingAttributesForFeature(i);if(null==r)return!0;for(const e of t)if(r.has(e))return!1;return!0}get usedMemory(){return(this.processor?.usedMemory??0)+(this.controller?.memoryForUnusedFeatures??0)}get unloadedMemory(){const e=this.processor?.unprocessedMemoryEstimate??0,t=this.controller?.expectedFeatureDiff??0,i=this.processor?.loadedFeatures??0,r=i+t>0?i/(i+t):1;return e+t*(this.processor?.usedMemoryPerFeature??0)*r}get ignoresMemoryFactor(){return this.controller?.hasMaximumNumberOfFeaturesOverride}async _queryFeaturesMesh(e,t){await this._validateQueryFeaturesMesh(e);const i=await t();if(e?.outStatistics||null==this.graphics3DProcessor)return i;const r=this.layer.objectIdField,s=this.graphics3DProcessor.graphics3DGraphicsByObjectID,n=[];for(const e of i.features)if(e.geometry){const t=s.get(e.attributes[r]);t&&(e.geometry=Yt(t.graphic.geometry),n.push(e))}else n.push(e);return i.features=n,i}async _validateQueryFeaturesMesh(e){if(!e)return;const t=e=>{throw new le.A("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${e}'`)},i=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const r of i)null!=e[r]&&t(r);"returnM"in e&&e.returnM&&t("returnM"),"returnCentroid"in e&&e.returnCentroid&&t("returnCentroid"),null==e.outSpatialReference||e.outSpatialReference.equals(this.view.spatialReference)||t("outSpatialReference")}get performanceInfo(){const e=this.controller?.displayFeatureLimit,t=null!=e?e.averageSymbolComplexity:void 0,i=null!=t?`f:${t.verticesPerFeature},v:${t.verticesPerCoordinate}`:"n/a";return new Ib(super.performanceInfo,this.controller?.performanceInfo?.storedFeatures??0,this.controller?.performanceInfo?.totalVertices??0,this.maximumNumberOfFeaturesExceeded,this.controller?.mode??"n/a",i)}get test(){return{updatePolicy:this.updatePolicy,controller:this.controller,loadedGraphics:this.controller?.graphics,...this.getTest()}}};(0,r._)([(0,h.MZ)()],oS.prototype,"layer",void 0),(0,r._)([(0,h.MZ)()],oS.prototype,"controller",void 0),(0,r._)([(0,h.MZ)()],oS.prototype,"_controllerTotal",void 0),(0,r._)([(0,h.MZ)()],oS.prototype,"_processorTotal",void 0),(0,r._)([(0,h.MZ)()],oS.prototype,"_needsRefresh",void 0),(0,r._)([(0,h.MZ)()],oS.prototype,"maximumNumberOfFeatures",null),(0,r._)([(0,h.MZ)()],oS.prototype,"maximumNumberOfFeaturesExceeded",null),(0,r._)([(0,h.MZ)(rS)],oS.prototype,"updatingProgress",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],oS.prototype,"updatingProgressValue",null),(0,r._)([(0,h.MZ)({readOnly:!0})],oS.prototype,"updatePolicy",null),(0,r._)([(0,h.MZ)({readOnly:!0})],oS.prototype,"hasZ",null),(0,r._)([(0,h.MZ)({readOnly:!0})],oS.prototype,"hasM",null),(0,r._)([(0,h.MZ)()],oS.prototype,"suspendResumeExtentMode",void 0),oS=(0,r._)([(0,u.$)("esri.views.3d.layers.FeatureLayerViewBase3D")],oS);const lS=new Map([["point",5e3],["polygon",500],["polyline",1e3]]),cS=oS;let hS=class extends cS{constructor(){super(...arguments),this.type="feature-3d",this.direct3DObjectFeatureLayerDisplayEnabled=(0,Me.Qf)()}initialize(){const{layer:e,view:t}=this;(0,jv.BR)(e)?.operations.supportsQuery||this.addResolvingPromise(Promise.reject(new le.A("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e}))),null!=e.infoFor3D&&(this.direct3DObjectFeatureLayerDisplayEnabled?this._set("suspendResumeExtentMode","computed"):this.addResolvingPromise(Promise.reject(new le.A("featurelayerview3d:unsupported-geometry-type",`Unsupported geometry type ${e.geometryType}`)))),"mesh"!==e.geometryType||(0,Hi.canProjectWithoutEngine)(e.spatialReference,t.spatialReference)||this.addResolvingPromise(Promise.reject(new le.A("layerview:spatial-reference-incompatible","The spatial references of the feature layer is incompatible with the spatial reference of the view")))}get featureSpatialReference(){return this.view.featureTiles?.tilingScheme?.spatialReference}};(0,r._)([(0,h.MZ)({constructOnly:!0})],hS.prototype,"direct3DObjectFeatureLayerDisplayEnabled",void 0),(0,r._)([(0,h.MZ)()],hS.prototype,"layer",void 0),hS=(0,r._)([(0,u.$)("esri.views.3d.layers.FeatureLayerView3D")],hS);const dS=hS,uS="esri.views.3d.layers.i3s.I3SOverrides";let pS=class extends n.A{constructor(e){super(e),this._warnMaximumChangedObjectsExceeded=!1,this._maximumNumberOfEditOVerrides=mS,this._original3DOFLDefinitionExpression=null,this._interactiveEditingSessions=new S.A,this.geometryOverrides=new S.A,this._clientGeometryCache=new Map,this._associatedLayerView=null,this._attributeChangedObjectIds=new Uv.A,this._geometryChangedObjectIds=new Uv.A,this._pendingFetchChangedObjectIds=null,this._pendingFetchAbortController=new AbortController,this._featureIdLocks=new Map}initialize(){this._memCache=this.memoryController.newCache(`i3s-attribute-overrides-${this.layer.uid}`),this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(this._pendingFetchAbortController?.signal),this._pendingFetchChangedObjectIds.finally((()=>{this._pendingFetchAbortController=null,this._pendingFetchChangedObjectIds=null})),this.is3DOFL&&null!=this._associatedLayer&&((0,Me.Qf)()?this._associatedLayer.load().then((e=>{this.destroyed||(this._original3DOFLDefinitionExpression=e.definitionExpression,this.addHandles((0,l.wB)((()=>this._definitionExpression),(t=>e.definitionExpression=t),l.Vh)),this._associatedLayerView=new dS({layer:this._associatedLayer,view:this.view}))})):(0,Me.lC)())}destroy(){this.is3DOFL&&null!=this._associatedLayer&&((0,Me.Qf)()?null!=this._associatedLayerView&&(this._associatedLayer.definitionExpression=this._original3DOFLDefinitionExpression):(0,Me.lC)()),this._set("layer",null),this._memCache=(0,ce.pR)(this._memCache),this._pendingFetchAbortController=(0,ce.DC)(this._pendingFetchAbortController),this._pendingFetchChangedObjectIds=null,this._featureIdLocks.clear()}get is3DOFL(){return(0,Me.Vo)()&&null!=this._associatedLayer?.infoFor3D}get sortedGeometryChangedObjectIds(){return this.is3DOFL?[...this._geometryChangedObjectIds].sort(((e,t)=>e-t)):[]}get _associatedLayer(){return null==this.layer?null:this.layer.associatedLayer}get hasGeometryChanges(){return this._geometryChangedObjectIds.size>0}get _definitionExpression(){const e=this.sortedGeometryChangedObjectIds;return 0===e.length?"1 = 0":`OBJECTID IN (${e.join(",")})`}get updating(){return!!this.is3DOFL&&(!!this._pendingFetchChangedObjectIds||!!(0,Me.Qf)()&&(!(null!=this._associatedLayerView)||null!=this._associatedLayerView&&this._associatedLayerView.updating))}get isEmpty(){return null==this._pendingFetchChangedObjectIds&&0===this._attributeChangedObjectIds.size&&0===this._geometryChangedObjectIds.size}featureHasGeometryChanges(e){return this._geometryChangedObjectIds.has(e)}featureHasAttributeChanges(e){return this._attributeChangedObjectIds.has(e)}createInteractiveEditSession(e){this._attributeChangedObjectIds.add(e);const t=this._interactiveEditingSessions,i=new fS(e,(()=>{t.remove(i)}));return t.unshift(i),i}async applyAttributeOverrides(e,t,i,r=[]){if(this._pendingFetchChangedObjectIds&&await(0,o.qr)(this._pendingFetchChangedObjectIds,i),null==t)return;const{attributeData:s,loadedAttributes:n}=t;if(null==n||null==s||0===this._attributeChangedObjectIds.size)return;const a=new Set;for(const e of n)a.add(e.index);for(const t of r)a.has(t.index)||(n.push(t),s[t.name]=new Array(e.length));const l=await this._lockFeatureIds(e);try{const t={attributeData:s,loadedAttributes:n},r=this._getOverridesFromCache(e,t,this._attributeChangedObjectIds),{objectIds:a,fieldNames:o}=r;if(0===a.length||0===o.length)return;const l=await this._queryAttributeOverridesFromAssociatedLayer(a,o,i);if(null==l)return;this._processOverridesFromAssociatedLayer(e,l,o,t)}finally{l.remove()}}updateGeometry(e,t){this._geometryChangedObjectIds.add(e);const i=this._clientGeometryCache.get(e);if(null!=i&&(this.geometryOverrides.remove(i),this._clientGeometryCache.delete(e)),null!=t){const i={oid:e,mesh:t};this.geometryOverrides.add(i),this._clientGeometryCache.set(e,i)}}updateAttributeValue(e,t,i){this._attributeChangedObjectIds.add(e),this._cacheAttributeValue(e,t,i)}featureAdded(e){this.is3DOFL&&(0,Me.lC)()&&this._geometryChangedObjectIds.add(e),this._attributeChangedObjectIds.add(e)}_cacheAttributeValue(e,t,i){this._memCache.put(this._getAttributeCacheKey(e,t),i,this._memCacheAttributeValueSize(i))}_getOverridesFromCache(e,{loadedAttributes:t,attributeData:i},r){const s=new Set,n=new Array;for(const e of t)n[e.index]=i[e.name];const a=new Set;for(let i=0;i<e.length;i++){const o=e[i];if(r.has(o))for(const e of t){const t=this._attributeFromCache(o,e.index);void 0===t?(s.add(o),a.add(e.name)):n[e.index][i]=t}}return{objectIds:Array.from(s),fieldNames:Array.from(a)}}_attributeFromCache(e,t){const i=this._fromInteractiveEditingSession(e,t);if(void 0!==i)return i;const r=this._getAttributeCacheKey(e,t);return this._memCache.get(r)}_fromInteractiveEditingSession(e,t){if(null!=this._interactiveEditingSessions)for(const i of this._interactiveEditingSessions){if(i.objectId!==e)continue;const r=i.getAttribute(t);if(void 0!==r)return r}}_getAttributeCacheKey(e,t){return`${e}-${t}`}async _queryAttributeOverridesFromAssociatedLayer(e,t,i){if(0===e.length)return null;this._logWarningIfMaximumObjectsExceeded();const{associatedLayer:r}=this.layer;if(null==r)return null;const s=r.createQuery(),{objectIdField:n}=r,a=[n,...t];s.where="1=1",s.returnGeometry=!1,s.outFields=a,s.cacheHint=!0;const o=await this._executeBatchQuery(r,e,s,i),l=[];for(const e of o)if(e.ok)for(const t of e.value.features)l.push(t);return l}async _queryGeometryOverridesFromAssociatedLayer(e,t){if(0===e.length||!this.is3DOFL||!(0,Me.lC)())return null;const i=this.layer.associatedLayer,r=i.infoFor3D,{spatialReference:s}=i,{state:{viewingMode:n},spatialReference:o}=this.view,l=n===oe.RT.Global,c=s.isGeographic;if(l&&!c)return a.A.getLogger(uS).warn("unsupported-pcs-edits-in-global-view",this.layer.title,yS(s,o,this.view.viewingMode,_S.Mode)),null;if(!l&&c)return a.A.getLogger(uS).warn("unsupported-gcs-edits-in-local-view",this.layer.title,yS(s,o,this.view.viewingMode,_S.Mode)),null;if(!((0,G.aI)(s,o)||l&&o.isWebMercator&&s.isWGS84))return a.A.getLogger(uS).warn("unsupported-mismatched-spatial-reference-edits",this.layer.title,yS(s,o,this.view.viewingMode,_S.SpatialReference)),null;this._logWarningIfMaximumObjectsExceeded();const{objectIdField:h,globalIdField:d}=i,u=[h,...null!=d?[d]:[]],p=i.createQuery();p.where="1=1",p.returnGeometry=!0,p.outFields=u,p.cacheHint=!0,p.returnZ=i.hasZ,p.returnM=i.hasM;const f=await this._executeBatchQuery(i,e,p,t),g=[];for(const e of f){if(!e.ok)continue;const t=e.value,{assetMaps:i,features:n,globalIdFieldName:a}=t;if(null==i)continue;const o=(0,Hv.assetMapFromAssetMapsJSON)(r,i);for(const e of n){const t=(0,Hv.extractMesh)(e,a,s,r,o),i=e;null!=t?(i.geometry=t,g.push(i)):i.geometry=null}}return g}_logWarningIfMaximumObjectsExceeded(){if(!this._warnMaximumChangedObjectsExceeded)return;this._warnMaximumChangedObjectsExceeded=!1;let e=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${(0,zv.ZV)(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const t=this.layer.portalItem;t&&t.loaded?e+=` (${t.portal.url}/home/item.html?id=${t.id}#settings)`:e+=` (${this.layer.parsedUrl.path})`,a.A.getLogger(uS).warn("#queryOverrides()",this.layer.title,`${e}.`)}async _executeBatchQuery(e,t,i,r){if(0===t.length)return[];const s=(0,Bv.qM)(e);t=[...t].sort(((e,t)=>e-t));const n=(0,b.Ho)(t,s).map((t=>{const s=i.clone();return s.objectIds=t,(0,dt.DZ)((0,Bv.SE)(e,s,{signal:r}))}));return Promise.all(n)}_processOverridesFromAssociatedLayer(e,t,i,{loadedAttributes:r,attributeData:s}){const n=this._associatedLayer;if(null==n)return;const a=n.objectIdField,o=i.map((t=>(t in s||(s[t]=new Array(e.length)),s[t]))),l=new Map(r.map((e=>[e.name,e.index]))),c=i.map((e=>l.get(e))),h=new Map(Array.from(e,((e,t)=>[e,t])));for(const e of t){const t=e.attributes[a];for(let r=0;r<i.length;r++){const s=c[r],n=h.get(t),a=e.attributes[i[r]];o[r][n]=a,this._cacheAttributeValue(t,s,a)}}}_memCacheAttributeValueSize(e){return"string"==typeof e?(0,va.xU)(e):(0,va.f3)()}async _fetchChangedObjectIds(e){const t=this.layer;await t.load({signal:e}),this._geometryChangedObjectIds.clear(),this._attributeChangedObjectIds.clear();const{associatedLayer:i}=t;if(null==i||!i.capabilities?.operations?.supportsChangeTracking)return;const r=this._getFetchChangedObjectIdsServerGen();if(null==r)return;const n=i.layerId,o=this.is3DOFL,l={f:"json",returnIdsOnly:!0,layers:`[${n}]`,returnUpdates:!0,returnDeletes:o,returnInserts:o,layerServerGens:JSON.stringify([{id:n,serverGen:r}])};if(o){const e=i.infoFor3D;l.fieldsToCompare=JSON.stringify({fields:[...Object.values(e.transformFieldRoles),e.sourceHashField]})}const c=await(0,dt.Ke)((0,s.A)(`${i.url}/extractChanges`,{method:"post",query:l,timeout:gS,signal:e}));if(!c.ok&&(0,pe.c8)(c.error)){const e=this.layer.title;a.A.getLogger(uS).warn("extractChanges:timeout",e,`${e} could not obtain edited features that are not cached in the scene service. Display of features may not be up to date with the latest edits. Consider re-caching the scene service.`)}if(c.ok&&1===c.value.data?.edits?.length){const t=c.value.data.edits[0],r=t?.objectIds,s=t?.fieldUpdates,n=r?.adds??[],a=r?.updates??[],l=r?.deletes??[],h=[...n,...a,...l],d=o?[...n,...s??a,...l]:[],u=Math.min(this._maximumNumberOfEditOVerrides,h.length);u<h.length&&(this._warnMaximumChangedObjectsExceeded=!0);const p=h.sort(((e,t)=>e-t));for(let e=0;e<u;++e){const t=p[e];this._attributeChangedObjectIds.add(t)}for(const e of d)this._geometryChangedObjectIds.add(e);if(this.is3DOFL&&(0,Me.lC)()&&this._geometryChangedObjectIds.size>0){const t=await this._queryGeometryOverridesFromAssociatedLayer(Array.from(this._geometryChangedObjectIds),e);if(null!=t)for(const e of t)null!=e.geometry&&this.updateGeometry(e.attributes[i.objectIdField],e.geometry)}}}_getFetchChangedObjectIdsServerGen(){const e=this.layer;if(null!=e.serviceUpdateTimeStamp?.lastUpdate)return e.serviceUpdateTimeStamp.lastUpdate;const t=e.associatedLayer;return null!=t?.serverGens?.minServerGen?t.serverGens.minServerGen:null}async _lockFeatureIds(e){const t=this._featureIdLocks;let i=!0;for(;i;){const r=new Array;for(const i of e){const e=t.get(i);e&&r.push(e)}0===r.length?i=!1:await Promise.all(r)}const r=(0,o.Tw)(),s=r.promise;for(const i of e)t.set(i,s);return(0,w.hA)((()=>{for(const i of e)t.delete(i);r.resolve()}))}get test(){const e=Array.from(this._attributeChangedObjectIds),t=this._pendingFetchChangedObjectIds,i=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return i._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){i._maximumNumberOfEditOVerrides=e}}}};(0,r._)([(0,h.MZ)({constructOnly:!0})],pS.prototype,"view",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],pS.prototype,"layer",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],pS.prototype,"is3DOFL",null),(0,r._)([(0,h.MZ)()],pS.prototype,"_interactiveEditingSessions",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],pS.prototype,"sortedGeometryChangedObjectIds",null),(0,r._)([(0,h.MZ)({readOnly:!0})],pS.prototype,"geometryOverrides",void 0),(0,r._)([(0,h.MZ)()],pS.prototype,"_clientGeometryCache",void 0),(0,r._)([(0,h.MZ)()],pS.prototype,"_associatedLayer",null),(0,r._)([(0,h.MZ)()],pS.prototype,"_associatedLayerView",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],pS.prototype,"memoryController",void 0),(0,r._)([(0,h.MZ)()],pS.prototype,"_attributeChangedObjectIds",void 0),(0,r._)([(0,h.MZ)()],pS.prototype,"_geometryChangedObjectIds",void 0),(0,r._)([(0,h.MZ)()],pS.prototype,"hasGeometryChanges",null),(0,r._)([(0,h.MZ)()],pS.prototype,"_pendingFetchChangedObjectIds",void 0),(0,r._)([(0,h.MZ)()],pS.prototype,"_pendingFetchAbortController",void 0),(0,r._)([(0,h.MZ)()],pS.prototype,"_definitionExpression",null),(0,r._)([(0,h.MZ)()],pS.prototype,"updating",null),(0,r._)([(0,h.MZ)()],pS.prototype,"isEmpty",null),pS=(0,r._)([(0,u.$)(uS)],pS);class fS{constructor(e,t){this.objectId=e,this._remove=t,this._updates=new Map,this._isActive=!0}getAttribute(e){return this._updates.get(e)}setAttribute(e,t){this.isActive&&this._updates.set(e,t)}remove(){this.isActive&&(this._isActive=!1,this._remove())}get isActive(){return this._isActive}}const gS=1e4,mS=5e4;var _S;function yS(e,t,i,r){return`Displaying the edits of a SceneLayer with a${r===_S.Mode?e.isGeographic?" geographic ":" projected ":" "}spatial reference (wkid:${e.wkid}) in ${i} viewing mode${r===_S.SpatialReference?` with spatial reference (wkid:${t.wkid}) `:" "}is not supported. No geometry edits will be displayed for this layer.\nPlease consider re-caching the scene service or changing the ${r===_S.Mode?"viewing mode":"view spatial reference"} to display edits.`}!function(e){e[e.Mode=0]="Mode",e[e.SpatialReference=1]="SpatialReference"}(_S||(_S={})),i(68695),new WeakMap;let vS=class extends(xs.A.EventedMixin(n.A)){constructor(e){super(e),this._tmpEvent=new wy,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=Zc(this.view.state.viewingMode),this._intersector.options.store=tc.MIN,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(e,t,i,r){const s=this._renderCoordsHelper,n=(0,M.s)(SS,e,t,i);if(!s.toRenderCoords(n,r,n))return a.A.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:o,_intersector:l,intersectionHandler:c}=this,h=o.fullExtent,d=null!=h&&Number.isFinite(h.xmin)&&Number.isFinite(h.xmax)&&Number.isFinite(h.ymin)&&Number.isFinite(h.ymax)&&Number.isFinite(h.zmin)&&Number.isFinite(h.zmax)?new Le.H(h.zmin,h.zmax):o.elevationRange;if(null==d)return null;const u=o.elevationOffset,p=d.elevationRangeMin+u,f=d.elevationRangeMax+u,g=s.setAltitude(wS,f,n),m=s.setAltitude(CS,p,n);return l.reset(g,m,null),c.intersect(l,null,g,m,null,!0),l.results.min.getIntersectionPoint(n)?s.getAltitude(n):null}getSphereElevationBounds(e,t){return z(e,t,xS,this._renderSR),this._layerElevationSource.getElevationRange(xS)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return e?.hasZ?new Le.H(e.zmin,e.zmax):null}objectsChanged(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,t){(0,$.Ie)(t),this._expandExtent(e,t)}_computeLayerExtent(e,t){(0,$.Ie)(t);for(const i of e)this._expandExtent(i,t)}_expandExtent(e,t){const i=this.spatialReference;if(null==i)return;if(null==e)return;(0,O.I0)(bS,e.quaternion),bS[12]=e.center[0],bS[13]=e.center[1],bS[14]=e.center[2];const r=e.halfSize;for(let e=0;e<8;++e)SS[0]=1&e?r[0]:-r[0],SS[1]=2&e?r[1]:-r[1],SS[2]=4&e?r[2]:-r[2],(0,M.e)(SS,SS,bS),this._renderCoordsHelper.fromRenderCoords(SS,SS,i),(0,$.fT)(t,SS,t)}};(0,r._)([(0,h.MZ)({constructOnly:!0})],vS.prototype,"layerElevationSource",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],vS.prototype,"intersectionHandler",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],vS.prototype,"view",void 0),(0,r._)([(0,h.MZ)()],vS.prototype,"spatialReference",null),vS=(0,r._)([(0,u.$)("esri.views.3d.layers.i3s.LayerElevationProvider")],vS);const bS=(0,P.vt)(),xS=(0,X.f)(0,0,0,0),SS=(0,I.vt)(),wS=(0,I.vt)(),CS=(0,I.vt)();var RS,ES,AS,TS;i(51229),i(82864),function(e){e[e.CastShadows=4]="CastShadows",e[e.Pickable=5]="Pickable"}(RS||(RS={})),x.u.MEGABYTES,function(e){e[e.ADD=0]="ADD",e[e.REMOVE=1]="REMOVE",e[e.UPDATE=2]="UPDATE"}(ES||(ES={})),(0,q.vt)(),(0,$.vt)(),(0,$.vt)(),new Ne.ab,new y.A([0,0,0,0]),(0,X.f)(0,0,0,0),(0,I.vt)(),(0,q.vt)(),new Le.H,function(e){e[e.Lifetime=0]="Lifetime",e[e.Jobs=1]="Jobs",e[e.Renderables=2]="Renderables"}(AS||(AS={})),function(e){e[e.Critical=0]="Critical",e[e.Error=1]="Error",e[e.Warning=2]="Warning",e[e.Info=3]="Info"}(TS||(TS={}));let OS=class extends n.A{constructor(e){super(e),this._lyr3DMainPromise=null,this._lyr3DMain=null,this._layers=new Map,this._debugFlags=new Set,this._debugLevel=TS.Critical,this._pulseTaskHandle=null,this._session=null,this._debugFlags.add(AS.Lifetime),this._debugFlags.add(AS.Jobs),this._debugFlags.add(AS.Renderables)}_debugLog(e,t,i,r=!0){if(this._debugFlags.has(e)&&this._debugLevel>=t){const e=r?`[js] ${i}`:`${i}`;t===TS.Critical||t===TS.Error?a.A.getLogger(this).error(e):t===TS.Warning&&a.A.getLogger(this).warn(e),a.A.getLogger(this).info(e)}}initialize(){this._debugLevel>TS.Warning&&(a.A.getLogger(this).level="info"),this._debugLog(AS.Lifetime,TS.Info,"Lyr3DWasmPerSceneView.initialize()"),this.addHandles([(0,l.wB)((()=>this.view.state?.contentCamera),(()=>this._updateWasmCamera()))]),this._pulseTaskHandle=(0,c.mg)({preRender:()=>this._pulseTask()})}destroy(){this._debugLog(AS.Lifetime,TS.Info,"Lyr3DWasmPerSceneView.destroy()"),this._lyr3DMain&&(this._layers.forEach((e=>{e.abortController.abort()})),this._lyr3DMain.uninitialize_lyr3d_wasm(),this._lyr3DMain=null);const e=this._worker;e&&e.destroyWasm().then((()=>{this._worker?.destroy(),this._worker=null})),this._pulseTaskHandle?.remove(),this._pulseTaskHandle=null}add3DTilesLayerView(e){return this._lyr3DMain?this._add3DTilesLayerView(e):(this._debugLog(AS.Lifetime,TS.Error,"Lyr3DWasmPerSceneView.add3DTilesLayerView() called when WASM wasn't initialized"),p.vE)}remove3DTilesLayerView(e){if(!this._lyr3DMain)return this._debugLog(AS.Lifetime,TS.Error,"Lyr3DWasmPerSceneView.remove3DTilesLayerView() called when WASM wasn't loaded!"),0;this._doRemoveLayerView(e);const t=this._layers.size;return 0===t&&(this._debugLog(AS.Lifetime,TS.Info,"Lyr3DWasmPerSceneView.remove3DTilesLayerView() no Lyr3D layers left after removing a layer, destroying"),this.destroy()),t}setEnabled(e,t){if(!this._lyr3DMain)return void this._debugLog(AS.Lifetime,TS.Error,"Lyr3DWasmPerSceneView.setEnabled() called when WASM wasn't loaded!");const i=this._layers.get(e.wasmLayerId);i&&(this._lyr3DMain.set_enabled(e.wasmLayerId,t),i.needMemoryUsageUpdate=!0)}setLayerOffset(e,t){this._lyr3DMain?this._layers.get(e.wasmLayerId)&&this._lyr3DMain.set_carto_offset_z(e.wasmLayerId,t):this._debugLog(AS.Lifetime,TS.Error,"Lyr3DWasmPerSceneView.setLayerOffset() called when WASM wasn't loaded!")}getAttributionText(){return this._lyr3DMain?this._lyr3DMain.get_current_attribution_text().split("|"):(this._debugLog(AS.Lifetime,TS.Error,"Lyr3DWasmPerSceneView.getAttributionText() called when WASM wasn't loaded!"),[])}onRenderableEvicted(e,t,i){this._lyr3DMain?this._layers.get(e.wasmLayerId)&&this._lyr3DMain.on_renderable_evicted(e.wasmLayerId,t,i):this._debugLog(AS.Lifetime,TS.Error,"Lyr3DWasmPerSceneView.onRenderableEvicted() called when WASM wasn't loaded!")}isUpdating(e){if(!this._lyr3DMain&&this._lyr3DMainPromise)return!0;const t=this._layers.get(e);return!!t&&(t.outstandingJobCount>0||t.outstandingRenderableCount>0)}initializeWasm(){return this._lyr3DMain?Promise.resolve():(this._debugLog(AS.Lifetime,TS.Info,"Lyr3DWasmPerSceneView.initializeWasm()"),this._lyr3DMainPromise||(this._lyr3DMainPromise=(0,m.a)().then((e=>{this._lyr3DMain=e,this._lyr3DMainPromise=null;const t=this._lyr3DMain.addFunction(this._onNewJob.bind(this),"v"),i=this._lyr3DMain.addFunction(this._onNewRenderable.bind(this),"v"),r=this._lyr3DMain.addFunction(this._freeRenderables.bind(this),"viii"),s=this._lyr3DMain.addFunction(this._setRenderableVisibility.bind(this),"viiii"),n=this._lyr3DMain.addFunction(this._onWasmError.bind(this),"viiii"),a="global"===this.view.viewingMode,o=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1,l=this.view.heightModelInfo?.heightModel,c=!l||"gravity-related-height"===l;return this._lyr3DMain.initialize_lyr3d_wasm(n,t,i,r,s,a,c,o,this._debugLevel)?(this._worker=new g(function(e){return t=>{if(e.immediate)return e.immediate.schedule(t);throw console.error("Error no immediate schudler"),new Error("cant find immediate scheduler")}}(this.view.resourceController)),this._worker.promise?this._worker.promise:void 0):(this._lyr3DMain=null,void this._debugLog(AS.Lifetime,TS.Critical,"Lyr3d Main WASM failed to initialize",!1))})).catch((e=>{this._debugLog(AS.Lifetime,TS.Critical,`Lyr3d WASM failed to download error = ${e}`,!1)}))),this._lyr3DMainPromise)}_pulseTask(){if(this._lyr3DMain){let e=0;this._layers.forEach((t=>{e+=t.layerView.usedMemory})),e/=1048576;const t=this.view.resourceController.memoryController,i=t.usedMemory*t.maxMemory-e,r=t.maxMemory-i+t.additionalCacheMemory;this._lyr3DMain.frame_pulse(r,e,i,t.maxMemory)}}_incrementJobCount(e){e.outstandingJobCount+=1,1===e.outstandingJobCount&&e.outstandingRenderableCount<1&&e.layerView.updatingFlagChanged()}_decrementJobCount(e){e.outstandingJobCount-=1,0===e.outstandingJobCount&&e.outstandingRenderableCount<1&&e.layerView.updatingFlagChanged()}_incrementRenderableCount(e){e.outstandingRenderableCount+=1,e.outstandingJobCount<1&&1===e.outstandingRenderableCount&&e.layerView.updatingFlagChanged()}_decrementRenderableCount(e){e.outstandingRenderableCount-=1,e.outstandingJobCount<1&&0===e.outstandingRenderableCount&&e.layerView.updatingFlagChanged()}_onJobFailed(e,t,i){t.error.length&&this._debugLog(AS.Jobs,TS.Error,t.error,!1),this._lyr3DMain&&this._lyr3DMain.on_job_failed(i.jobId,i.desc),this._decrementJobCount(e)}_onJobSucceeded(e,t,i){if(this._lyr3DMain){const e=t.data.byteLength,r=this._lyr3DMain._malloc(e);new Uint8Array(this._lyr3DMain.HEAPU8.buffer,r,e).set(t.data),this._lyr3DMain.on_job_completed(i.jobId,t.jobDescJson,r,e),this._lyr3DMain._free(r)}this._decrementJobCount(e)}_getRequestPromises(e,t){const i=[];for(const r of e){const e=new URL(r),n=e.searchParams.get("session");n?this._session=n:this._session&&e.searchParams.append("session",this._session),i.push((0,s.A)(e.toString(),t).then((e=>e.data)))}return i}_onNewJob(){const e=this._lyr3DMain.get_next_job(),t=this._layers.get(e.layerId);if(!t)return;this._incrementJobCount(t);const i=t.abortController.signal,r={responseType:"array-buffer",signal:i,query:{...t.customParameters,token:t.apiKey}},s={inputs:[],jobDescJson:e.desc,isMissingResourceCase:!1},n=this._getRequestPromises(e.urls,r);Promise.all(n).then((e=>(s.inputs=e,this._worker.invoke(s,i)))).then((e=>e)).catch((t=>((0,o.zf)(t)?this._debugLog(AS.Jobs,TS.Warning,`job ${e.jobId} was cancelled.`):this._debugLog(AS.Jobs,TS.Error,`job ${e.jobId} failed with error ${t}.`),{status:p.Qg.Failed,error:"",jobDescJson:"",data:new Uint8Array(0),missingInputUrls:[],inputs:[]}))).then((n=>{if(n.status===p.Qg.Failed)this._onJobFailed(t,n,e);else if(n.status===p.Qg.Succeeded)this._onJobSucceeded(t,n,e);else if(n.status===p.Qg.MissingInputs){const a=this._getRequestPromises(n.missingInputUrls,r);Promise.all(a).then((e=>{s.jobDescJson=n.jobDescJson,n.originalInputs?s.inputs=n.originalInputs:s.inputs=[],s.isMissingResourceCase=!0;for(const t of e)s.inputs.push(t);return this._worker.invoke(s,i)})).then((i=>{i.status===p.Qg.Failed?this._onJobFailed(t,i,e):i.status===p.Qg.Succeeded&&this._onJobSucceeded(t,i,e)})).catch((i=>{this._decrementJobCount(t),(0,o.zf)(i)?this._debugLog(AS.Jobs,TS.Warning,`job ${e.jobId} was cancelled.`):this._debugLog(AS.Jobs,TS.Error,`job ${e.jobId} failed with error2 ${i}.`),this._lyr3DMain&&this._lyr3DMain.on_job_failed(e.jobId,e.desc)}))}}))}_onNewRenderable(){const e=this._lyr3DMain.get_next_renderable(),t=e.meshData;if(t.data&&t.data.byteLength>0){const e=t.data.slice();t.data=e}const i=this._layers.get(e.layerId);i&&(this._incrementRenderableCount(i),i.layerView.createRenderable(e).then((t=>{this._lyr3DMain&&this._lyr3DMain.on_renderable_created(!0,e.layerId,e.handle,t.memUsageBytes),this._decrementRenderableCount(i)})).catch((t=>{(0,o.zf)(t)||this._debugLog(AS.Renderables,TS.Error,`createRenderable failed with error ${t}.`),this._lyr3DMain&&this._lyr3DMain.on_renderable_created(!1,e.layerId,e.handle,0),this._decrementRenderableCount(i)})))}_freeRenderables(e,t,i){if(i<1)return;const r=this._layers.get(e);if(!r)return;const s=r.layerView,n=[],a=new Uint32Array(this._lyr3DMain.HEAPU32.buffer,t,i);for(let e=0;e<i;++e)n.push(a[e]);for(let e=0;e<i;++e)s.freeRenderable(n[e])}_setRenderableVisibility(e,t,i,r){if(r<1)return;const s=this._layers.get(e);if(!s)return;const n=s.layerView,a=[],o=[],l=new Uint32Array(this._lyr3DMain.HEAPU32.buffer,t,r),c=new Uint8Array(this._lyr3DMain.HEAPU8.buffer,i,r);for(let e=0;e<r;++e)a.push(l[e]),o.push(1===c[e]);n.setRenderableVisibility(a,o,r)}_onWasmError(e,t,i,r){this._lyr3DMain&&this._debugLog(i,r,this._lyr3DMain.UTF8ToString(e,t),!1)}_doRemoveLayerView(e){const t=this._layers.get(e.wasmLayerId);return!!t&&(t.abortController.abort(),this._lyr3DMain.remove_layer(e.wasmLayerId),this._layers.delete(e.wasmLayerId),!0)}_add3DTilesLayerView(e){const t=e.layer;if(!t.url)return p.Pl;const i=this._lyr3DMain.get_next_layer_id(),r=new AbortController;this._layers.set(i,{layerView:e,abortController:r,needMemoryUsageUpdate:!1,outstandingJobCount:0,outstandingRenderableCount:0,customParameters:t.customParameters,apiKey:t.apiKey});const s=t.elevationInfo?.offset??0,n=t.elevationInfo?.unit?(0,_.Ao)(t.elevationInfo?.unit):1;return this._lyr3DMain.add_layer(t.url,i,s*n)?(this._updateWasmCamera(),i):(this._layers.delete(i),p.Pl)}_updateWasmCamera(){const e=this.view.state?.contentCamera;if(!e||!this._lyr3DMain)return;const{eye:t,center:i,up:r,near:s,far:n,fovY:a}=e,o=[e.viewport[2],e.viewport[3]],l=e.width/e.height;this._lyr3DMain.set_camera_parameters({eye:t,center:i,up:r,near:s,far:n,fov:a,aspectRatio:l,viewport:o})}};(0,r._)([(0,h.MZ)({constructOnly:!0})],OS.prototype,"view",void 0),OS=(0,r._)([(0,u.$)("esri.layers.Lyr3DWasmPerSceneView")],OS);const PS=OS},65088:(e,t,i)=>{i.d(t,{A:()=>g});var r,s=i(82392),n=(i(3313),i(84977)),a=i(15565),o=i(97629),l=i(81482),c=(i(6273),i(80861),i(26325)),h=i(48524),d=i(18031),u=i(34561),p=i(65648);let f=r=class extends n.oY{constructor(e){super(e),this.geometry=null,this.type="clip"}writeGeometry(e,t,i,r){if(r.layer?.spatialReference&&!r.layer.spatialReference.equals(this.geometry.spatialReference)){if(!(0,u.canProjectWithoutEngine)(e.spatialReference,r.layer.spatialReference))return void(r?.messages&&r.messages.push(new o.A("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:r.layer.spatialReference,context:r})));const s=new p.A;(0,u.projectPolygon)(e,s,r.layer.spatialReference),t[i]=s.toJSON(r)}else t[i]=e.toJSON(r);delete t[i].spatialReference}clone(){return new r({geometry:(0,a.o8)(this.geometry),type:this.type})}};(0,s._)([(0,l.MZ)({type:p.A}),(0,d.P)()],f.prototype,"geometry",void 0),(0,s._)([(0,h.K)(["web-scene","portal-item"],"geometry")],f.prototype,"writeGeometry",null),(0,s._)([(0,l.MZ)({type:["clip","mask","replace"],nonNullable:!0}),(0,d.P)()],f.prototype,"type",void 0),f=r=(0,s._)([(0,c.$)("esri.layers.support.SceneModification")],f);const g=f},52360:(e,t,i)=>{i.d(t,{E1:()=>o,Fm:()=>l,JZ:()=>f,R_:()=>a,fu:()=>s,oF:()=>n,rq:()=>c});const r=[["binary","application/octet-stream","bin",""]];function s(e,t){return null!=d(t.name,e?.supportedFormats??[])}function n(e,t){if(!e)return!1;const i=c(t,e.supportedFormats??[]);return null!=i&&e.editFormats.includes(i)}function a(e,t){return u(function(e,t){const i=e.toLowerCase();return h(t).find((e=>p(e)===i))}(e,t))}function o(e,t){return u(d(e,t))}function l(e,t){return p(function(e,t){return h(t).find((t=>u(t)===e))}(e,t))}function c(e,t){return o(e.name,t)??a(e.type,t)}function h(e){return[...r,...e]}function d(e,t){const i=e.toLowerCase();return h(t).find((e=>function(e){return e?.[2].split(",").map((e=>e.toLowerCase()))??[]}(e).some((e=>i.endsWith(e)))))}function u(e){return e?.[0]}function p(e){return e?.[1].toLowerCase()}function f(e){return e.tables?.find((e=>"assetMaps"===e.role))}},6104:(e,t,i)=>{i.d(t,{W:()=>m,l:()=>g});var r=i(62991),s=i(80861),n=i(80189),a=i(50189),o=i(18632),l=i(14849),c=i(46227),h=i(61845),d=i(83911);const u=()=>s.A.getLogger("esri.layers.support.labelFormatUtils"),p={type:"simple",evaluate:()=>null},f={getAttribute:(e,t)=>e.field(t)};async function g(e,t,i){if(!e||!e.symbol||!t)return p;const s=e.where,a=(0,h.XJ)(e);let o;if("arcade"===a.type){const e=await(0,d.$I)(a.expression,i,t);if(null==e)return p;o={type:"arcade",evaluate(t,i){try{const r="attributes"in t?e.repurposeFeature(t):t;r.contextTimeZone=i??null;const s=e.evaluate({$view:{timeZone:i},$feature:r},e.services);if(null!=s)return s.toString()}catch(e){u().error(new r.A("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:e,feature:t,expression:a}))}return null},needsHydrationToEvaluate:()=>null==(0,h.tH)(a.expression)}}else o={type:"simple",evaluate:e=>a.expression.replaceAll(/{[^}]*}/g,(i=>{const r=i.slice(1,-1),s=t.get(r);if(!s)return i;let n=null;return"attributes"in e?e&&e.attributes&&(n=e.attributes[s.name]):n=e.field(s.name),null==n?"":m(n,s)}))};if(s){let e;try{e=await(0,n.G)(s,t)}catch(e){return u().error(new r.A("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:s,error:e})),p}const i=o.evaluate;o.evaluate=(t,n)=>{const a="attributes"in t?void 0:f;try{if(e.testFeature(t,a))return i(t,n)}catch(e){u().error(new r.A("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:s,feature:t,error:e}))}return null}}return o}function m(e,t){if(null==e)return"";const i=t.domain;if(i)if("codedValue"===i.type||"coded-value"===i.type){const t=e;for(const e of i.codedValues)if(e.code===t)return e.name}else if("range"===i.type){const{max:r,min:s}=(0,l.A5)(t),n=+e;if(null!=s&&null!=r&&s<=n&&n<=r)return i.name}let r=e;return(0,c.vE)(t)?r=(0,a.Yq)(r,(0,a.J2)("short-date")):(0,c.WA)(t)&&(r=(0,o.ZV)(+r)),r||""}},5878:(e,t,i)=>{var r,s;i.d(t,{D:()=>s,f:()=>r}),function(e){e[e.None=0]="None",e[e.Int16=1]="Int16",e[e.Int32=2]="Int32"}(r||(r={})),function(e){e[e.Replace=0]="Replace",e[e.Outside=1]="Outside",e[e.Inside=2]="Inside",e[e.Finished=3]="Finished"}(s||(s={}))},38425:(e,t,i)=>{i.d(t,{a:()=>s,h:()=>n});var r=i(44764);function s(){return new Promise((e=>i.e(8505).then(i.bind(i,78505)).then((e=>e.l)).then((({default:t})=>{const i=t({locateFile:a,onRuntimeInitialized:()=>e(i)})})))).catch((e=>{throw e}))}function n(){return new Promise((e=>i.e(3654).then(i.bind(i,63654)).then((e=>e.l)).then((({default:t})=>{const i=t({locateFile:a,onRuntimeInitialized:()=>e(i)})})))).catch((e=>{throw e}))}function a(e){return(0,r.s)(`esri/libs/lyr3d/${e}`)}},57942:(e,t,i)=>{i.r(t),i.d(t,{getGeometryServiceURL:()=>l,projectGeometry:()=>c});var r=i(32083),s=i(62991),n=i(83382),a=i(35497),o=i(15697);async function l(e=null,t){if(r.A.geometryServiceUrl)return r.A.geometryServiceUrl;if(!e)throw new s.A("internal:geometry-service-url-not-configured");let i;i="portal"in e?e.portal||n.A.getDefault():e,await i.load({signal:t});const a=i.helperServices?.geometry?.url;if(!a)throw new s.A("internal:geometry-service-url-not-configured");return a}async function c(e,t,i=null,r){const n=await l(i,r),c=new o.A;c.geometries=[e],c.outSpatialReference=t;const h=await(0,a.C)(n,c,{signal:r});if(h&&Array.isArray(h)&&1===h.length)return h[0];throw new s.A("internal:geometry-service-projection-failed")}},80925:(e,t,i)=>{i.d(t,{n:()=>s});var r=i(19759);function s(e){return n[function(e){return"json"===e.type?"application/json":"blob"===e.type?e.blob.type:function(e){const t=(0,r.Zo)(e);return l[t]||a}(e.url)}(e)]||o}const n={},a="text/plain",o=n[a],l={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip","bin.gz":"application/octet-stream"};for(const e in l)n[l[e]]=e},35497:(e,t,i)=>{i.d(t,{C:()=>h});var r=i(38116),s=i(8636),n=i(56053),a=i(36321),o=i(96905),l=i(15697);const c=(0,s.dp)(l.A);async function h(e,t,i){t=c(t);const s=(0,a.Dl)(e),l={...s.query,f:"json",...t.toJSON()},h=t.outSpatialReference,d=(0,n.$B)(t.geometries[0]),u=(0,a.jV)(l,i);return(0,r.A)(s.path+"/project",u).then((({data:{geometries:e}})=>(0,o.V)(e,d,h)))}},49173:(e,t,i)=>{function r(e){const t={};for(const i in e){if("declaredClass"===i)continue;const s=e[i];if(null!=s&&"function"!=typeof s)if(Array.isArray(s)){t[i]=[];for(let e=0;e<s.length;e++)t[i][e]=r(s[e])}else"object"==typeof s?s.toJSON&&(t[i]=JSON.stringify(s)):t[i]=s}return t}i.d(t,{z:()=>r})},95254:(e,t,i)=>{i.d(t,{GB:()=>v,IJ:()=>f,Jf:()=>y,Pk:()=>m,eW:()=>p,gW:()=>_,kS:()=>g});var r=i(38116),s=i(19759),n=i(56053),a=i(87249),o=i(67488),l=i(49173),c=i(91039),h=i(11378);const d="Layer does not support extent calculation.";function u(e,t){const i=e.geometry,r=e.toJSON();delete r.compactGeometryEnabled,delete r.defaultSpatialReferenceEnabled;const s=r;let a,l,c;if(null!=i&&(l=i.spatialReference,c=(0,o.YX)(l),s.geometryType=(0,n.$B)(i),s.geometry=function(e,t){if(t&&"extent"===e.type)return`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`;if(t&&"point"===e.type)return`${e.x},${e.y}`;const i=e.toJSON();return delete i.spatialReference,JSON.stringify(i)}(i,e.compactGeometryEnabled),s.inSR=c),r.groupByFieldsForStatistics&&(s.groupByFieldsForStatistics=r.groupByFieldsForStatistics.join(",")),r.objectIds&&(s.objectIds=r.objectIds.join(",")),r.orderByFields&&(s.orderByFields=r.orderByFields.join(",")),!r.outFields||!r.returnDistinctValues&&(t?.returnCountOnly||t?.returnExtentOnly||t?.returnIdsOnly)?delete s.outFields:r.outFields.includes("*")?s.outFields="*":s.outFields=r.outFields.join(","),r.outSR?(s.outSR=(0,o.YX)(r.outSR),a=e.outSpatialReference):i&&(r.returnGeometry||r.returnCentroid)&&(s.outSR=s.inSR,a=l),r.returnGeometry&&delete r.returnGeometry,r.outStatistics&&(s.outStatistics=JSON.stringify(r.outStatistics)),r.fullText&&(s.fullText=JSON.stringify(r.fullText)),r.pixelSize&&(s.pixelSize=JSON.stringify(r.pixelSize)),r.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&null!=l&&null!=e.quantizationParameters?.extent&&l.equals(e.quantizationParameters.extent.spatialReference)&&delete r.quantizationParameters.extent.spatialReference,s.quantizationParameters=JSON.stringify(r.quantizationParameters)),r.parameterValues&&(s.parameterValues=JSON.stringify(r.parameterValues)),r.rangeValues&&(s.rangeValues=JSON.stringify(r.rangeValues)),r.dynamicDataSource&&(s.layer=JSON.stringify({source:r.dynamicDataSource}),delete r.dynamicDataSource),r.timeExtent){const e=r.timeExtent,{start:t,end:i}=e;null==t&&null==i||(s.time=t===i?t:`${t??"null"},${i??"null"}`),delete r.timeExtent}return e.defaultSpatialReferenceEnabled&&null!=l&&null!=a&&l.equals(a)&&(s.defaultSR=s.inSR,delete s.inSR,delete s.outSR),s}async function p(e,t,i,r){const s=null!=t.timeExtent&&t.timeExtent.isEmpty?{data:{features:[]}}:await v(e,t,"json",r);return(0,h.q)(t,i,s.data),s}async function f(e,t,i,r){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:i.createFeatureResult()};const s=await g(e,t,r),n=s;return n.data=(0,c.m)(s.data,i),n}function g(e,t,i){return v(e,t,"pbf",i)}function m(e,t,i){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):v(e,t,"json",i,{returnIdsOnly:!0})}function _(e,t,i){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):v(e,t,"json",i,{returnIdsOnly:!0,returnCountOnly:!0})}async function y(e,t,i){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:{count:0,extent:null}};const r=await v(e,t,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}),s=r.data;if(s.hasOwnProperty("extent"))return r;if(s.features)throw new Error(d);if(s.hasOwnProperty("count"))throw new Error(d);return r}async function v(e,t,i,n={},o={}){const c="string"==typeof e?(0,s.An)(e):e,h=t.geometry?[t.geometry]:[],d=await(0,a.el)(h,null,{signal:n.signal}),p=d?.[0];null!=p&&((t=t.clone()).geometry=p);const f=(0,l.z)({...c.query,f:i,...o,...u(t,o)});return(0,r.A)((0,s.fj)(c.path,(g=o,null==t.formatOf3DObjects||g.returnCountOnly||g.returnExtentOnly||g.returnIdsOnly?"query":"query3d")),{...n,responseType:"pbf"===i?"array-buffer":"json",query:{...f,...n.query}});var g}},15697:(e,t,i)=>{i.d(t,{A:()=>h});var r=i(82392),s=i(84977),n=i(81482),a=(i(6273),i(80861),i(67498),i(26325)),o=i(56053),l=i(67488);let c=class extends s.oY{constructor(e){super(e),this.geometries=[],this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const e=this.geometries.map((e=>e.toJSON())),t=this.geometries[0],i={};return i.outSR=(0,l.YX)(this.outSpatialReference),i.inSR=(0,l.YX)(t.spatialReference),i.geometries=JSON.stringify({geometryType:(0,o.$B)(t),geometries:e}),this.transformation&&(i.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),null!=this.transformForward&&(i.transformForward=this.transformForward),i}};(0,r._)([(0,n.MZ)()],c.prototype,"geometries",void 0),(0,r._)([(0,n.MZ)({json:{read:{source:"outSR"}}})],c.prototype,"outSpatialReference",void 0),(0,r._)([(0,n.MZ)()],c.prototype,"transformation",void 0),(0,r._)([(0,n.MZ)()],c.prototype,"transformForward",void 0),c=(0,r._)([(0,a.$)("esri.rest.support.ProjectParameters")],c);const h=c},78621:(e,t,i)=>{i.r(t),i.d(t,{assetMapFromAssetMapsJSON:()=>v,extractMesh:()=>m,meshFeatureSetFromJSON:()=>g});var r=i(20857),s=i(80861),n=i(80294),a=i(8e3),o=i(53170),l=i(8977),c=i(44153),h=i(77873),d=i(28936),u=i(52360),p=i(74704);const f=()=>s.A.getLogger("esri.rest.support.meshFeatureSet");function g(e,t,i){const s=i.features;i.features=[],delete i.geometryType;const n=p.A.fromJSON(i);if(n.geometryType="mesh",!i.assetMaps)return n;const a=v(t,i.assetMaps),o=e.sourceSpatialReference??c.A.WGS84,l=i.globalIdFieldName,{outFields:h}=e,d=null!=h&&h.length>0?(u=h.includes("*")?null:new Set(h),({attributes:e})=>{if(!e)return{};if(!u)return e;for(const t in e)u.has(t)||delete e[t];return e}):()=>({});var u;for(const e of s){const i=m(e,l,o,t,a);null!=i&&n.features.push(new r.A({geometry:i,attributes:d(e)}))}return n}function m(e,t,i,r,s){const n=e.attributes[t],c=s.get(n);if(null==c)return f().error("mesh-feature-set:asset-not-found","Service returned a feature which was not found in the asset map",e),null;if(!e.geometry)return f().error("mesh-feature-set:no-geometry","Service returned a feature without geometry",e),null;const u=function({attributes:e},t,{transformFieldRoles:i}){const r=e[i.originX],s=e[i.originY],n=e[i.originZ];return new l.A({x:r,y:s,z:n,spatialReference:t})}(e,i,r),p=a.A.fromJSON(e.geometry);p.spatialReference=i;const g=function(e,{transformFieldRoles:t}){return new h.A({translation:[e[t.translationX],-e[t.translationZ],e[t.translationY]],rotationAxis:[e[t.rotationX],-e[t.rotationZ],e[t.rotationY]],rotationAngle:e[t.rotationDeg],scale:[e[t.scaleX],e[t.scaleZ],e[t.scaleY]]})}(e.attributes,r),m=i.isGeographic?"local":"georeferenced",y=function(e){const t=Array.from(e.files.values()),i=new Array;for(const e of t){if(e.status!==_.COMPLETED)return null;const t=new Array;for(const i of e.parts){if(!i)return null;t.push(new d.Bq(i.url,i.hash))}i.push(new d.Qp(e.name,e.mimeType,t))}return i}(c);return y?o.A.createWithExternalSource(u,y,{extent:p,transform:g,vertexSpace:m}):o.A.createIncomplete(u,{extent:p,transform:g,vertexSpace:m})}var _,y;function v(e,t){const i=new Map;for(const r of t){const t=r.parentGlobalId;if(null==t)continue;const s=r.assetName,a=r.assetType,o=r.assetHash,l=r.assetURL,c=r.conversionStatus,h=r.seqNo,d=(0,u.Fm)(a,e.supportedFormats);if(!d){f().error("mesh-feature-set:unknown-format",`Service returned an asset of type ${a}, but it does not list it as a supported type`);continue}const p=(0,n.tE)(i,t,(()=>({files:new Map})));(0,n.tE)(p.files,s,(()=>({name:s,type:a,mimeType:d,status:b(c),parts:[]}))).parts[h]={hash:o,url:l}}return i}function b(e){switch(e){case"COMPLETED":case"SUBMITTED":return _.COMPLETED;case"INPROGRESS":return _.PENDING;default:return _.FAILED}}(y=_||(_={}))[y.FAILED=0]="FAILED",y[y.PENDING=1]="PENDING",y[y.COMPLETED=2]="COMPLETED"},19541:(e,t,i)=>{function r(e){return e?h:d}function s(e,t){return function(e,t){return t?.mode?t.mode:r(e).mode}(null!=e&&e.hasZ,t)}function n(e,t){return function(e,t){return null!=t?t:r(e)}(null!=e&&!!e.hasZ,t)}function a(e,t,i){return i&&i.mode!==t?`${e} only support ${t} elevation mode`:null}function o(e,t,i){return i?.mode===t?`${e} do not support ${t} elevation mode`:null}function l(e,t){return null!=t?.featureExpressionInfo&&"0"!==t.featureExpressionInfo.expression?`${e} do not support featureExpressionInfo`:null}function c(e,t){t&&e.warn(".elevationInfo=",t)}i.d(t,{$7:()=>o,B:()=>a,XF:()=>c,tW:()=>l,w7:()=>s,ze:()=>n}),i(5262),i(69172);const h={mode:"absolute-height",offset:0},d={mode:"on-the-ground",offset:null}},85953:(e,t,i)=>{var r,s,n,a,o,l,c,h,d,u,p,f,g,m,_,y,v,b,x,S,w,C,R,E,A,T,O,P,M,I,D,F,L,N,V,G,U,z,B,H,j,W,k,Z,q,$,Q,J,Y,X,K,ee,te,ie,re,se,ne,ae,oe,le,ce;i.d(t,{$2:()=>o,C1:()=>n,JO:()=>s,M1:()=>C,O$:()=>ne,Q1:()=>$,TZ:()=>y,WE:()=>P,Y:()=>c,YI:()=>J,bj:()=>h,e_:()=>q,f0:()=>se,fu:()=>p,g7:()=>d,ip:()=>Q,mU:()=>M,oF:()=>S,uQ:()=>w,uT:()=>G,vG:()=>oe,wd:()=>H,xR:()=>r,xn:()=>v,xw:()=>A,yS:()=>U}),function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE",e[e.UNKNOWN=4]="UNKNOWN"}(r||(r={})),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER",e[e.UNKNOWN=4]="UNKNOWN"}(s||(s={})),function(e){e[e.SCREEN=0]="SCREEN",e[e.MAP=1]="MAP"}(n||(n={})),function(e){e[e.Tint=0]="Tint",e[e.Ignore=1]="Ignore",e[e.Multiply=99]="Multiply"}(a||(a={})),function(e){e.Both="Both",e.JustBegin="JustBegin",e.JustEnd="JustEnd",e.None="None"}(o||(o={})),function(e){e[e.Mosaic=0]="Mosaic",e[e.Centered=1]="Centered"}(l||(l={})),function(e){e[e.Normal=0]="Normal",e[e.Superscript=1]="Superscript",e[e.Subscript=2]="Subscript"}(c||(c={})),function(e){e[e.MSSymbol=0]="MSSymbol",e[e.Unicode=1]="Unicode"}(h||(h={})),function(e){e[e.Unspecified=0]="Unspecified",e[e.TrueType=1]="TrueType",e[e.PSOpenType=2]="PSOpenType",e[e.TTOpenType=3]="TTOpenType",e[e.Type1=4]="Type1"}(d||(d={})),function(e){e[e.Display=0]="Display",e[e.Map=1]="Map"}(u||(u={})),function(e){e.None="None",e.Loop="Loop",e.Oscillate="Oscillate"}(p||(p={})),function(e){e[e.Z=0]="Z",e[e.X=1]="X",e[e.Y=2]="Y"}(f||(f={})),function(e){e[e.XYZ=0]="XYZ",e[e.ZXY=1]="ZXY",e[e.YXZ=2]="YXZ"}(g||(g={})),function(e){e[e.Rectangle=0]="Rectangle",e[e.RoundedRectangle=1]="RoundedRectangle",e[e.Oval=2]="Oval"}(m||(m={})),function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.Screen=2]="Screen",e[e.Multiply=3]="Multiply",e[e.Add=4]="Add"}(_||(_={})),function(e){e[e.TTB=0]="TTB",e[e.RTL=1]="RTL",e[e.BTT=2]="BTT"}(y||(y={})),function(e){e[e.None=0]="None",e[e.SignPost=1]="SignPost",e[e.FaceNearPlane=2]="FaceNearPlane"}(v||(v={})),function(e){e[e.Float=0]="Float",e[e.String=1]="String",e[e.Boolean=2]="Boolean"}(b||(b={})),function(e){e[e.Intersect=0]="Intersect",e[e.Subtract=1]="Subtract"}(x||(x={})),function(e){e.OpenEnded="OpenEnded",e.Block="Block",e.Crossed="Crossed"}(S||(S={})),function(e){e.FullGeometry="FullGeometry",e.PerpendicularFromFirstSegment="PerpendicularFromFirstSegment",e.ReversedFirstSegment="ReversedFirstSegment",e.PerpendicularToSecondSegment="PerpendicularToSecondSegment",e.SecondSegmentWithTicks="SecondSegmentWithTicks",e.DoublePerpendicular="DoublePerpendicular",e.OppositeToFirstSegment="OppositeToFirstSegment",e.TriplePerpendicular="TriplePerpendicular",e.HalfCircleFirstSegment="HalfCircleFirstSegment",e.HalfCircleSecondSegment="HalfCircleSecondSegment",e.HalfCircleExtended="HalfCircleExtended",e.OpenCircle="OpenCircle",e.CoverageEdgesWithTicks="CoverageEdgesWithTicks",e.GapExtentWithDoubleTicks="GapExtentWithDoubleTicks",e.GapExtentMidline="GapExtentMidline",e.Chevron="Chevron",e.PerpendicularWithArc="PerpendicularWithArc",e.ClosedHalfCircle="ClosedHalfCircle",e.TripleParallelExtended="TripleParallelExtended",e.ParallelWithTicks="ParallelWithTicks",e.Parallel="Parallel",e.PerpendicularToFirstSegment="PerpendicularToFirstSegment",e.ParallelOffset="ParallelOffset",e.OffsetOpposite="OffsetOpposite",e.OffsetSame="OffsetSame",e.CircleWithArc="CircleWithArc",e.DoubleJog="DoubleJog",e.PerpendicularOffset="PerpendicularOffset",e.LineExcludingLastSegment="LineExcludingLastSegment",e.MultivertexArrow="MultivertexArrow",e.CrossedArrow="CrossedArrow",e.ChevronArrow="ChevronArrow",e.ChevronArrowOffset="ChevronArrowOffset",e.PartialFirstSegment="PartialFirstSegment",e.Arch="Arch",e.CurvedParallelTicks="CurvedParallelTicks",e.Arc90Degrees="Arc90Degrees"}(w||(w={})),function(e){e.Mitered="Mitered",e.Bevelled="Bevelled",e.Rounded="Rounded",e.Square="Square",e.TrueBuffer="TrueBuffer"}(C||(C={})),function(e){e.ClosePath="ClosePath",e.ConvexHull="ConvexHull",e.RectangularBox="RectangularBox"}(R||(R={})),function(e){e.BeginningOfLine="BeginningOfLine",e.EndOfLine="EndOfLine"}(E||(E={})),function(e){e.Mitered="Mitered",e.Bevelled="Bevelled",e.Rounded="Rounded",e.Square="Square"}(A||(A={})),function(e){e.Fast="Fast",e.Accurate="Accurate"}(T||(T={})),function(e){e.BeginningOfLine="BeginningOfLine",e.EndOfLine="EndOfLine"}(O||(O={})),function(e){e.Sinus="Sinus",e.Square="Square",e.Triangle="Triangle",e.Random="Random"}(P||(P={})),function(e){e[e.None=0]="None",e[e.Default=1]="Default",e[e.Force=2]="Force"}(M||(M={})),function(e){e[e.Buffered=0]="Buffered",e[e.Left=1]="Left",e[e.Right=2]="Right",e[e.AlongLine=3]="AlongLine"}(I||(I={})),function(e){e[e.Linear=0]="Linear",e[e.Rectangular=1]="Rectangular",e[e.Circular=2]="Circular",e[e.Buffered=3]="Buffered"}(D||(D={})),function(e){e[e.Discrete=0]="Discrete",e[e.Continuous=1]="Continuous"}(F||(F={})),function(e){e[e.AcrossLine=0]="AcrossLine",e[e.AloneLine=1]="AloneLine"}(L||(L={})),function(e){e[e.Left=0]="Left",e[e.Right=1]="Right",e[e.Center=2]="Center",e[e.Justify=3]="Justify"}(N||(N={})),function(e){e[e.Base=0]="Base",e[e.MidPoint=1]="MidPoint",e[e.ThreePoint=2]="ThreePoint",e[e.FourPoint=3]="FourPoint",e[e.Underline=4]="Underline",e[e.CircularCW=5]="CircularCW",e[e.CircularCCW=6]="CircularCCW"}(V||(V={})),function(e){e.Butt="Butt",e.Round="Round",e.Square="Square"}(G||(G={})),function(e){e.NoConstraint="NoConstraint",e.HalfPattern="HalfPattern",e.HalfGap="HalfGap",e.FullPattern="FullPattern",e.FullGap="FullGap",e.Custom="Custom"}(U||(U={})),function(e){e[e.None=-1]="None",e[e.Custom=0]="Custom",e[e.Circle=1]="Circle",e[e.OpenArrow=2]="OpenArrow",e[e.ClosedArrow=3]="ClosedArrow",e[e.Diamond=4]="Diamond"}(z||(z={})),function(e){e[e.ExtraLeading=0]="ExtraLeading",e[e.Multiple=1]="Multiple",e[e.Exact=2]="Exact"}(B||(B={})),function(e){e.Bevel="Bevel",e.Round="Round",e.Miter="Miter"}(H||(H={})),function(e){e[e.Default=0]="Default",e[e.String=1]="String",e[e.Numeric=2]="Numeric"}(j||(j={})),function(e){e[e.InsidePolygon=0]="InsidePolygon",e[e.PolygonCenter=1]="PolygonCenter",e[e.RandomlyInsidePolygon=2]="RandomlyInsidePolygon"}(W||(W={})),function(e){e[e.Tint=0]="Tint",e[e.Replace=1]="Replace",e[e.Multiply=2]="Multiply"}(k||(k={})),function(e){e[e.ClipAtBoundary=0]="ClipAtBoundary",e[e.RemoveIfCenterOutsideBoundary=1]="RemoveIfCenterOutsideBoundary",e[e.DoNotTouchBoundary=2]="DoNotTouchBoundary",e[e.DoNotClip=3]="DoNotClip"}(Z||(Z={})),function(e){e.NoConstraint="NoConstraint",e.WithMarkers="WithMarkers",e.WithFullGap="WithFullGap",e.WithHalfGap="WithHalfGap",e.Custom="Custom"}(q||(q={})),function(e){e.Fixed="Fixed",e.Random="Random",e.RandomFixedQuantity="RandomFixedQuantity"}($||($={})),function(e){e.LineMiddle="LineMiddle",e.LineBeginning="LineBeginning",e.LineEnd="LineEnd",e.SegmentMidpoint="SegmentMidpoint"}(Q||(Q={})),function(e){e.OnPolygon="OnPolygon",e.CenterOfMass="CenterOfMass",e.BoundingBoxCenter="BoundingBoxCenter"}(J||(J={})),function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(Y||(Y={})),function(e){e[e.MarkerCenter=0]="MarkerCenter",e[e.MarkerBounds=1]="MarkerBounds"}(X||(X={})),function(e){e[e.None=0]="None",e[e.PropUniform=1]="PropUniform",e[e.PropNonuniform=2]="PropNonuniform",e[e.DifUniform=3]="DifUniform",e[e.DifNonuniform=4]="DifNonuniform"}(K||(K={})),function(e){e.Tube="Tube",e.Strip="Strip",e.Wall="Wall"}(ee||(ee={})),function(e){e[e.Random=0]="Random",e[e.Increasing=1]="Increasing",e[e.Decreasing=2]="Decreasing",e[e.IncreasingThenDecreasing=3]="IncreasingThenDecreasing"}(te||(te={})),function(e){e[e.Relative=0]="Relative",e[e.Absolute=1]="Absolute"}(ie||(ie={})),function(e){e[e.Normal=0]="Normal",e[e.LowerCase=1]="LowerCase",e[e.Allcaps=2]="Allcaps"}(re||(re={})),function(e){e[e.LTR=0]="LTR",e[e.RTL=1]="RTL"}(se||(se={})),function(e){e.Draft="Draft",e.Picture="Picture",e.Text="Text"}(ne||(ne={})),function(e){e[e.Top=0]="Top",e[e.Center=1]="Center",e[e.Baseline=2]="Baseline",e[e.Bottom=3]="Bottom"}(ae||(ae={})),function(e){e[e.Right=0]="Right",e[e.Upright=1]="Upright"}(oe||(oe={})),function(e){e[e.Small=0]="Small",e[e.Medium=1]="Medium",e[e.Large=2]="Large"}(le||(le={})),function(e){e[e.Calm=0]="Calm",e[e.Rippled=1]="Rippled",e[e.Slight=2]="Slight",e[e.Moderate=3]="Moderate"}(ce||(ce={}))},71345:(e,t,i)=>{i.d(t,{A:()=>s});var r=i(14571);class s{constructor(e,t,i,s){this.computedX=0,this.computedY=0,this.center=(0,r.fA)(e,t),this.centerT=(0,r.vt)(),this.halfWidth=i/2,this.halfHeight=s/2,this.width=i,this.height=s}get x(){return this.center[0]}get y(){return this.center[1]}get blX(){return this.center[0]+this.halfWidth}get blY(){return this.center[1]+this.halfHeight}get trX(){return this.center[0]-this.halfWidth}get trY(){return this.center[1]-this.halfHeight}get xmin(){return this.x-this.halfWidth}get xmax(){return this.x+this.halfWidth}get ymin(){return this.y-this.halfHeight}get ymax(){return this.y+this.halfHeight}set x(e){this.center[0]=e}set y(e){this.center[1]=e}clone(){return new s(this.x,this.y,this.width,this.height)}serialize(e){return e.writeF32(this.center[0]),e.writeF32(this.center[1]),e.push(this.width),e.push(this.height),e}findCollisionDelta(e,t=4){const i=Math.abs(e.centerT[0]-this.centerT[0]),r=Math.abs(e.centerT[1]-this.centerT[1]),s=(e.halfWidth+this.halfWidth+t)/i,n=(e.halfHeight+this.halfHeight+t)/r,a=Math.min(s,n);return Math.log2(a)}extend(e){const t=Math.min(this.xmin,e.xmin),i=Math.min(this.ymin,e.ymin),r=Math.max(this.xmax,e.xmax)-t,s=Math.max(this.ymax,e.ymax)-i,n=t+r/2,a=i+s/2;this.width=r,this.height=s,this.halfWidth=r/2,this.halfHeight=s/2,this.x=n,this.y=a}static deserialize(e){const t=e.readF32(),i=e.readF32(),r=e.readInt32(),n=e.readInt32();return new s(t,i,r,n)}}},6538:(e,t,i)=>{i.d(t,{$U:()=>I,C2:()=>d,CQ:()=>s,CR:()=>w,C_:()=>F,Cp:()=>C,DY:()=>c,Gh:()=>P,LY:()=>T,O5:()=>H,Pq:()=>u,Qb:()=>z,Sr:()=>x,TB:()=>q,Tv:()=>a,Vl:()=>Z,Xh:()=>k,YS:()=>f,YV:()=>o,_j:()=>N,_x:()=>j,bg:()=>n,c5:()=>M,dV:()=>E,eG:()=>h,eI:()=>W,fq:()=>G,g0:()=>O,hM:()=>L,ju:()=>l,lL:()=>y,mg:()=>D,n9:()=>b,nM:()=>_,nW:()=>V,qM:()=>r,r1:()=>B,sn:()=>v,uM:()=>g,ue:()=>p,vN:()=>R,vd:()=>S,yv:()=>U,z2:()=>m});const r=1e-30,s=512,n=128,a=511,o=16777216,l=8,c=29,h=24,d=4,u=0,p=0,f=0,g=1,m=2,_=3,y=4,v=5,b=6,x=12,S=5,w=6,C=5,R=6;var E,A;(A=E||(E={}))[A.FilterFlags=0]="FilterFlags",A[A.Animation=1]="Animation",A[A.GPGPU=2]="GPGPU",A[A.VV=3]="VV",A[A.DD0=4]="DD0",A[A.DD1=5]="DD1",A[A.DD2=6]="DD2";const T=8,O=T<<1,P=1.05,M=1,I=5,D=6,F=1.15,L=2,N=128-2*L,V=2,G=10,U=1024,z=128,B=4,H=1,j=1<<20,W=.75,k=10,Z=.75,q=256},29740:(e,t,i)=>{var r,s;function n(e){return null!=e&&!e.running}i.d(t,{c:()=>s,c2:()=>r,pi:()=>n}),function(e){e[e.RENDERING=0]="RENDERING",e[e.FADING=1]="FADING",e[e.FINISHED=2]="FINISHED"}(r||(r={})),function(e){e[e.RG=0]="RG",e[e.BA=1]="BA"}(s||(s={}))},99164:(e,t,i)=>{i.d(t,{OQ:()=>r,ny:()=>g});var r,s,n=i(4506),a=i(25336),o=i(26110),l=i(80347),c=i(19913),h=i(43785),d=i(99263),u=i(29740),p=i(16120),f=i(47273);class g{constructor(){this.readChannels=u.c.RG,this.renderingStage=u.c2.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=(0,c.vt)(),this.parallax=new m,this.parallaxNew=new m,this.pointOnGround=(0,c.vt)(),this.fadeMode=r.HIDE,this.fadeFactor=0,this.opacity=0}updateParallax(e){const t=this.parallax,i=(0,l.l)(e.eye);if(t.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(i*i-d.$O.radius*d.$O.radius,0))/i,(0,h.Cr)(_,t.anchorPointClouds,y),(0,a.e$)(t.transform,o.zK,y[3],(0,h.yo)(y)),this.fadeMode===r.CROSS_FADE){const e=this.parallaxNew;(0,h.Cr)(_,e.anchorPointClouds,y),(0,a.e$)(e.transform,o.zK,y[3],(0,h.yo)(y))}}updateFading(e,t,i,r){this.isFading&&this._advanceFading(i,r),this._evaluateFading(e,t,i)}_evaluateFading(e,t,i){const s=e.relativeElevation,n=this._calculateDistanceToAnchorPoint(e);if((s>1.7*p.ni||s<-p.ni||n>w)&&this.opacity>0)this._setFade(r.HIDE,i);else if(!this.isFading)if((s>p.ni||s<-.35*p.ni||n>S)&&this.opacity>0)this._setFade(r.FADE_OUT,i);else if(s<=p.ni&&s>=-.35*p.ni&&t===f.M.IDLE&&(0,u.pi)(this.data)){if(0===this.opacity)return void this._setFade(r.FADE_IN,i);(n>x||this.renderingStage===u.c2.FADING)&&this._setFade(r.CROSS_FADE,i)}}_advanceFading(e,t){this._switchReadChannels(),this._updateAnchorPoint(),this._advanceFadingFactorAndOpacity(e,t)}_advanceFadingFactorAndOpacity(e,t){if(this.fadeFactor<1)return this.fadeFactor=t?(0,n.qE)((e-this.startTime)/(b*t),0,1):1,this.fadeMode===r.FADE_OUT&&(this.opacity=1-this.fadeFactor),this.fadeMode===r.FADE_IN&&(this.opacity=this.fadeFactor),void(this.fadeMode===r.CROSS_FADE&&(this.opacity=1));this.fadeFactor=0,this.fadeMode===r.FADE_OUT&&(this.opacity=0),this.fadeMode===r.FADE_IN&&(this.opacity=1),this.fadeMode===r.CROSS_FADE&&(this.opacity=1),this.fadeMode=r.NONE}_switchReadChannels(){const e=this.fadeMode===r.CROSS_FADE&&1===this.fadeFactor,t=this.fadeMode===r.FADE_IN&&0===this.fadeFactor;this.renderingStage===u.c2.FADING&&(e||t)&&(this.readChannels=1-this.readChannels,this.renderingStage=u.c2.FINISHED)}_calculateDistanceToAnchorPoint(e){return(0,l.n)(this.pointOnGround,e.eye),(0,l.h)(this.pointOnGround,this.pointOnGround,d.$O.radius),(0,l.l)((0,l.f)(v,this.parallax.anchorPointClouds,this.pointOnGround))}_updateAnchorPoint(){this.fadeMode===r.CROSS_FADE&&(0===this.fadeFactor&&(0,l.c)(this.parallaxNew.anchorPointClouds,this.pointOnGround),1===this.fadeFactor&&(0,l.c)(this.parallax.anchorPointClouds,this.parallaxNew.anchorPointClouds)),this.fadeMode===r.FADE_IN&&0===this.fadeFactor&&(0,l.c)(this.parallax.anchorPointClouds,this.pointOnGround)}_setFade(e,t){switch(e){case r.HIDE:this.opacity=0;break;case r.FADE_OUT:this.opacity=1;break;case r.FADE_IN:this.opacity=0;break;case r.CROSS_FADE:this.opacity=1}this.fadeMode=e,this.fadeFactor=0,this.startTime=t}get isFading(){return this.fadeMode===r.FADE_OUT||this.fadeMode===r.FADE_IN||this.fadeMode===r.CROSS_FADE}}(s=r||(r={}))[s.NONE=0]="NONE",s[s.HIDE=1]="HIDE",s[s.FADE_OUT=2]="FADE_OUT",s[s.FADE_IN=3]="FADE_IN",s[s.CROSS_FADE=4]="CROSS_FADE";class m{constructor(){this.anchorPointClouds=(0,c.vt)(),this.radiusCurvatureCorrectionFactor=0,this.transform=(0,o.vt)()}}const _=(0,c.fA)(0,0,1),y=(0,h.vt)(),v=(0,c.vt)(),b=1.25,x=34e3,S=64e3,w=2e5},16120:(e,t,i)=>{i.d(t,{k9:()=>C,ni:()=>w});var r,s=i(82392),n=i(84977),a=i(81482),o=(i(6273),i(80861),i(67498),i(85716)),l=i(26325);let c=r=class extends n.oY{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new r({cloudCover:this.cloudCover})}};(0,s._)([(0,o.e)({cloudy:"cloudy"})],c.prototype,"type",void 0),(0,s._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"cloudCover",void 0),c=r=(0,s._)([(0,l.$)("esri.views.3d.environment.CloudyWeather")],c);const h=c;var d;let u=d=class extends n.oY{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new d({fogStrength:this.fogStrength})}};(0,s._)([(0,o.e)({foggy:"foggy"})],u.prototype,"type",void 0),(0,s._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],u.prototype,"fogStrength",void 0),u=d=(0,s._)([(0,l.$)("esri.views.3d.environment.FoggyWeather")],u);const p=u;var f;let g=f=class extends n.oY{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new f({cloudCover:this.cloudCover,precipitation:this.precipitation})}};(0,s._)([(0,o.e)({rainy:"rainy"})],g.prototype,"type",void 0),(0,s._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],g.prototype,"cloudCover",void 0),(0,s._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],g.prototype,"precipitation",void 0),g=f=(0,s._)([(0,l.$)("esri.views.3d.environment.RainyWeather")],g);const m=g;var _;let y=_=class extends n.oY{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new _({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};(0,s._)([(0,o.e)({snowy:"snowy"})],y.prototype,"type",void 0),(0,s._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],y.prototype,"cloudCover",void 0),(0,s._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],y.prototype,"precipitation",void 0),(0,s._)([(0,a.MZ)({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],y.prototype,"snowCover",void 0),y=_=(0,s._)([(0,l.$)("esri.views.3d.environment.SnowyWeather")],y);const v=y;var b;let x=b=class extends n.oY{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new b({cloudCover:this.cloudCover})}};(0,s._)([(0,o.e)({sunny:"sunny"})],x.prototype,"type",void 0),(0,s._)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],x.prototype,"cloudCover",void 0),x=b=(0,s._)([(0,l.$)("esri.views.3d.environment.SunnyWeather")],x);const S={key:"type",base:x,typeMap:{sunny:x,cloudy:h,rainy:m,snowy:v,foggy:p}};Object.keys(S.typeMap);const w=1e4,C=1e5},70844:(e,t,i)=>{i.r(t),i.d(t,{destroyContext:()=>b,dracoDecompressPointCloudData:()=>f,filterObbsForModifications:()=>g,filterObbsForModificationsSync:()=>E,initialize:()=>O,interpretObbModificationResults:()=>R,process:()=>p,project:()=>y,setLegacySchema:()=>_,setModifications:()=>m,setModificationsSync:()=>w,test:()=>M,transformNormals:()=>v});var r=i(44153),s=i(75644),n=i(58823),a=i(93320),o=i(72449),l=i(5878),c=i(44764);function h(e){return(0,c.s)(`esri/libs/i3s/${e}`)}let d;var u=i(36466);async function p(e){S=await P();const t=[e.geometryBuffer];return{result:C(S,e,t),transferList:t}}async function f(e){S=await P();const t=[e.geometryBuffer],{geometryBuffer:i}=e,r=i.byteLength,s=S._malloc(r),n=new Uint8Array(S.HEAPU8.buffer,s,r);n.set(new Uint8Array(i));const a=S.dracoDecompressPointCloudData(s,n.byteLength);if(S._free(s),a.error.length>0)throw new Error(`i3s.wasm: ${a.error}`);const o=a.featureIds?.length>0?a.featureIds.slice():null,l=a.positions.slice();return o&&t.push(o.buffer),t.push(l.buffer),{result:{positions:l,featureIds:o},transferList:t}}async function g(e){await P(),E(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}}async function m(e){await P(),w(e)}async function _(e){S=await P(),S.setLegacySchema(e.context,e.jsonSchema)}async function y(e){const{localMatrix:t,origin:o,positions:l,vertexSpace:c,localMode:h}=e,d=r.A.fromJSON(e.inSpatialReference),u=r.A.fromJSON(e.outSpatialReference);let p;if("georeferenced"===c.type&&null==c.origin){const[{projectBuffer:e},{initializeProjection:t}]=await Promise.all([Promise.resolve().then(i.bind(i,88133)),Promise.resolve().then(i.bind(i,34561))]);await t(d,u),p=new Float64Array(l.length),e(l,d,0,p,u,0,p.length/3)}else{const e="georeferenced"===c.type?n.A.fromJSON(c):a.A.fromJSON(c),{project:r}=await i.e(6233).then(i.bind(i,56233));p=(0,s.Ns)(r({positions:l,transform:t?{localMatrix:t}:void 0,vertexSpace:e,inSpatialReference:d,outSpatialReference:u,localMode:h}))}const f=p.length,[g,m,_]=o;for(let e=0;e<f;e+=3)p[e]-=g,p[e+1]-=m,p[e+2]-=_;return{result:{projected:p,original:l},transferList:[p.buffer,l.buffer]}}async function v({normalMatrix:e,normals:t}){const i=new Float32Array(t.length);return(0,o.b)(i,t,e),(0,o.n)(i,i),{result:{transformed:i,original:t},transferList:[i.buffer,t.buffer]}}function b(e){A(e)}let x,S;function w(e){if(!S)return;const t=e.modifications,i=S._malloc(8*t.length),r=new Float64Array(S.HEAPU8.buffer,i,t.length);for(let e=0;e<t.length;++e)r[e]=t[e];S.setModifications(e.context,i,t.length,e.isGeodetic),S._free(i)}function C(e,t,i){const{context:r,localOrigin:s,globalTrafo:n,mbs:a,obbData:o,elevationOffset:c,geometryBuffer:h,geometryDescriptor:d,indexToVertexProjector:u,vertexToRenderProjector:p}=t,f=e._malloc(h.byteLength),g=e._malloc(33*Float64Array.BYTES_PER_ELEMENT),m=new Uint8Array(e.HEAPU8.buffer,f,h.byteLength);m.set(new Uint8Array(h));const _=new Float64Array(e.HEAPU8.buffer,g,33);T(_,s);let y=_.byteOffset+3*_.BYTES_PER_ELEMENT,v=new Float64Array(_.buffer,y);T(v,n),y+=16*_.BYTES_PER_ELEMENT,v=new Float64Array(_.buffer,y),T(v,a),y+=4*_.BYTES_PER_ELEMENT,o&&(v=new Float64Array(_.buffer,y),T(v,o));const b=d,x={isDraco:!1,isLegacy:!1,color:t.layouts.some((e=>e.some((e=>"color"===e.name)))),normal:t.needNormals&&t.layouts.some((e=>e.some((e=>"normalCompressed"===e.name)))),uv0:t.layouts.some((e=>e.some((e=>"uv0"===e.name)))),uvRegion:t.layouts.some((e=>e.some((e=>"uvRegion"===e.name)))),featureIndex:b.featureIndex},S=e.process(r,!!t.obbData,f,m.byteLength,b,x,g,c,u,p,t.normalReferenceFrame);if(e._free(g),e._free(f),S.error.length>0)throw new Error(`i3s.wasm: ${S.error}`);if(S.discarded)return null;const w=S.componentOffsets.length>0?S.componentOffsets.slice():null,C=S.featureIds.length>0?S.featureIds.slice():null,R=S.anchorIds.length>0?Array.from(S.anchorIds):null,E=S.anchors.length>0?Array.from(S.anchors):null,A=S.interleavedVertedData.slice().buffer,O=S.indicesType===l.f.Int16?new Uint16Array(S.indices.buffer,S.indices.byteOffset,S.indices.byteLength/2).slice():new Uint32Array(S.indices.buffer,S.indices.byteOffset,S.indices.byteLength/4).slice(),P=S.positions.slice(),M=S.positionIndicesType===l.f.Int16?new Uint16Array(S.positionIndices.buffer,S.positionIndices.byteOffset,S.positionIndices.byteLength/2).slice():new Uint32Array(S.positionIndices.buffer,S.positionIndices.byteOffset,S.positionIndices.byteLength/4).slice(),I={layout:t.layouts[0],interleavedVertexData:A,indices:O,hasColors:S.hasColors,hasModifications:S.hasModifications,positionData:{data:P,indices:M}};return C&&i.push(C.buffer),w&&i.push(w.buffer),i.push(A),i.push(O.buffer),i.push(P.buffer),i.push(M.buffer),{componentOffsets:w,featureIds:C,anchorIds:R,anchors:E,transformedGeometry:I,obb:S.obb}}function R(e){return 0===e?u.Js.Unmodified:1===e?u.Js.PotentiallyModified:2===e?u.Js.Culled:u.Js.Unknown}function E(e){if(!S)return;const{context:t,buffer:i}=e,r=S._malloc(i.byteLength),s=i.byteLength/Float64Array.BYTES_PER_ELEMENT,n=new Float64Array(S.HEAPU8.buffer,r,s),a=new Float64Array(i);n.set(a),S.filterOBBs(t,r,s),a.set(n),S._free(r)}function A(e){S&&0===S.destroy(e)&&(S=null)}function T(e,t){for(let i=0;i<t.length;++i)e[i]=t[i]}async function O(){S||await P()}function P(){return S?Promise.resolve(S):(x||(x=(d||(d=new Promise((e=>i.e(7966).then(i.bind(i,85585)).then((e=>e.i)).then((({default:t})=>{const i=t({locateFile:h,onRuntimeInitialized:()=>e(i)});delete i.then})))).catch((e=>{throw e}))),d).then((e=>(S=e,x=null,S)))),x)}const M={transform:(e,t)=>S&&C(S,e,t),destroy:A}},36466:(e,t,i)=>{i.d(t,{EG:()=>g,Js:()=>s,TJ:()=>r,UY:()=>o,ay:()=>p,bP:()=>f,cJ:()=>a,iF:()=>n});var r,s,n,a,o,l,c=i(76982),h=i(69891),d=i(37734),u=i(21016);class p extends u.H{constructor(e,t){super(NaN,NaN),this.id=e,this.serviceMbsInIndexSR=t,this.serviceMbsInRenderSR=(0,h.f)(0,0,0,-1)}invalidateServiceBVsInRenderSR(){(0,d.Q7)(this.serviceMbsInRenderSR),this.serviceObbInRenderSR?.invalidate()}shareServiceBVsInRenderSRWith(e){this.serviceObbInRenderSR=e.serviceObbInRenderSR,this.serviceMbsInRenderSR=e.serviceMbsInRenderSR}}(l=r||(r={}))[l.Unmodified=0]="Unmodified",l[l.Culled=1]="Culled",l[l.NotChecked=2]="NotChecked",function(e){e[e.Unmodified=0]="Unmodified",e[e.PotentiallyModified=1]="PotentiallyModified",e[e.Culled=2]="Culled",e[e.Unknown=3]="Unknown",e[e.NotChecked=4]="NotChecked"}(s||(s={}));class f extends p{constructor(e,t,i,r,a,o,l,h,d,u){super(e,i),this.index=t,this.childCount=r,this.level=a,this.resources=o,this.version=l,this.lodMetric=h,this.maxError=d,this.numFeatures=u,this.failed=!1,this.cacheState=n.Unknown,this.vertexCount=0,this.memory=0,this.childrenLoaded=0,this.hasModifications=!1,this.imModificationImpact=s.NotChecked,this.elevationAgnosticBoundingVolume=(0,c.fA)(0,0,0,-1)}invalidateServiceBVsInRenderSR(){super.invalidateServiceBVsInRenderSR(),this.elevationAgnosticBoundingVolume[3]=-1}}!function(e){e[e.Unknown=0]="Unknown",e[e.Uncached=1]="Uncached",e[e.Cached=2]="Cached"}(n||(n={})),function(e){e[e.None=0]="None",e[e.MaxScreenThreshold=1]="MaxScreenThreshold",e[e.ScreenSpaceRelative=2]="ScreenSpaceRelative",e[e.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",e[e.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera"}(a||(a={})),function(e){e[e.Hole=0]="Hole",e[e.Leaf=1]="Leaf"}(o||(o={}));class g{constructor(e,t,i,r){this.nodeHasLOD=e,this.isChosen=t,this.lodLevel=i,this.version=r}}},21016:(e,t,i)=>{i.d(t,{H:()=>r});class r{constructor(e=1/0,t=-1/0){this.elevationRangeMin=e,this.elevationRangeMax=t}get elevationRangeValid(){return!Number.isNaN(this.elevationRangeMin)}invalidateElevationRange(){this.elevationRangeMin=NaN}expandElevationRangeValues(e,t){this.elevationRangeMin=Math.min(this.elevationRangeMin,e),this.elevationRangeMax=Math.max(this.elevationRangeMax,t)}expandElevationRange(e){this.elevationRangeMin=Math.min(this.elevationRangeMin,e.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,e.elevationRangeMax)}setElevationRange(e){this.elevationRangeMin=e.elevationRangeMin,this.elevationRangeMax=e.elevationRangeMax}}},29386:(e,t,i)=>{i.d(t,{U:()=>n});var r=i(68716),s=i(67277);function n(e,t=0){const i=e.stride;return Array.from(e.fields.keys()).map((r=>{const n=e.fields.get(r),o=n.constructor.ElementCount,l=a(n.constructor.ElementType),c=n.offset,h=!(!n.optional||!n.optional.glNormalized);return new s._(r,o,l,c,i,h,t)}))}function a(e){const t=o[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}const o={u8:r.pe.UNSIGNED_BYTE,u16:r.pe.UNSIGNED_SHORT,u32:r.pe.UNSIGNED_INT,i8:r.pe.BYTE,i16:r.pe.SHORT,i32:r.pe.INT,f32:r.pe.FLOAT}},4498:(e,t,i)=>{i.d(t,{Cz:()=>s,DZ:()=>a,PV:()=>n,vO:()=>r}),i(11519),i(68716),i(89958),i(88416);const r=64,s=r/2,n=r/(s/5),a=.25},11519:(e,t,i)=>{i.d(t,{CN:()=>o,Q_:()=>a,ny:()=>l,sZ:()=>c}),i(6273);var r=i(39637),s=i(32573),n=i(68716);const a=128,o=.5;function l(e){return"cross"===e||"x"===e}function c(e,t=a,i=t*o,r=0){const l=function(e,t=a,i=t*o,r=0){switch(e){case"circle":default:return function(e,t){const i=e/2-.5;return f(e,u(i,i,t/2))}(t,i);case"square":return function(e,t){return h(e,t,!1)}(t,i);case"cross":return function(e,t,i=0){return d(e,t,!1,i)}(t,i,r);case"x":return function(e,t,i=0){return d(e,t,!0,i)}(t,i,r);case"kite":return function(e,t){return h(e,t,!0)}(t,i);case"triangle":return function(e,t){return f(e,p(e/2,t,t/2))}(t,i);case"arrow":return function(e,t){const i=t,r=t/2,s=e/2,n=.8*i,a=u(s,(e-t)/2-n,Math.sqrt(n*n+r*r)),o=p(s,i,r);return f(e,((e,t)=>Math.max(o(e,t),-a(e,t))))}(t,i)}}(e,t,i,r);return new s.g(l,{mipmap:!1,wrap:{s:n.pF.CLAMP_TO_EDGE,t:n.pF.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0,reloadable:!0})}function h(e,t,i){return i&&(t/=Math.SQRT2),f(e,((r,s)=>{let n=r-.5*e+.25,a=.5*e-s-.75;if(i){const e=(n+a)/Math.SQRT2;a=(a-n)/Math.SQRT2,n=e}return Math.max(Math.abs(n),Math.abs(a))-.5*t}))}function d(e,t,i,r=0){t-=r,i&&(t*=Math.SQRT2);const s=.5*t;return f(e,((t,n)=>{let a,o=t-.5*e,l=.5*e-n-1;if(i){const e=(o+l)/Math.SQRT2;l=(l-o)/Math.SQRT2,o=e}return o=Math.abs(o),l=Math.abs(l),a=o>l?o>s?Math.sqrt((o-s)*(o-s)+l*l):l:l>s?Math.sqrt(o*o+(l-s)*(l-s)):o,a-=r/2,a}))}function u(e,t,i){return(r,s)=>{const n=r-e,a=s-t;return Math.sqrt(n*n+a*a)-i}}function p(e,t,i){const r=Math.sqrt(t*t+i*i);return(s,n)=>{const a=Math.abs(s-e)-i,o=n-e+t/2+.75,l=(t*a+i*o)/r,c=-o;return Math.max(l,c)}}function f(e,t){const i=new Uint8Array(4*e*e);for(let s=0;s<e;s++)for(let n=0;n<e;n++){const a=n+e*s;let o=t(n,s);o=o/e+.5,(0,r.U)(o,i,4*a)}return i}},68986:(e,t,i)=>{var r,s,n,a;i.d(t,{vr:()=>r}),function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"}(r||(r={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(s||(s={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(n||(n={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(a||(a={}))},40198:(e,t,i)=>{i.d(t,{H:()=>p,W:()=>f});var r=i(56560),s=i(18185),n=i(66579),a=i(64802),o=i(5800),l=i(4930),c=i(41014),h=i(33763),d=i(34383);const u=8;function p(e,t){const i=h.r.FEATUREVALUE;e.attributes.add(i,"vec4");const r=e.vertex;r.code.add(c.H`
  bool isCapVertex() {
    return ${i}.w == 1.0;
  }
  `),r.uniforms.add(new n.G("size",(e=>e.size))),t.vvSize?(r.uniforms.add(new a.t("vvSizeMinSize",(e=>e.vvSize.minSize)),new a.t("vvSizeMaxSize",(e=>e.vvSize.maxSize)),new a.t("vvSizeOffset",(e=>e.vvSize.offset)),new a.t("vvSizeFactor",(e=>e.vvSize.factor))),r.code.add(c.H`
    vec2 getSize() {
      return size * clamp(vvSizeOffset + ${i}.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
    }
    `)):r.code.add(c.H`vec2 getSize(){
return size;
}`),t.vvOpacity?(r.constants.add("vvOpacityNumber","int",u),r.uniforms.add(new l.x("vvOpacityValues",(e=>e.vvOpacity.values),u),new l.x("vvOpacityOpacities",(e=>e.vvOpacity.opacityValues),u)),r.code.add(c.H`
    vec4 applyOpacity(vec4 color) {
      float value = ${i}.z;
      if (value <= vvOpacityValues[0]) {
        return vec4( color.xyz, vvOpacityOpacities[0]);
      }

      for (int i = 1; i < vvOpacityNumber; ++i) {
        if (vvOpacityValues[i] >= value) {
          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
          return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
        }
      }

      return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
    }
    `)):r.code.add(c.H`vec4 applyOpacity(vec4 color){
return color;
}`),t.vvColor?(r.constants.add("vvColorNumber","int",d.p),r.uniforms.add(new l.x("vvColorValues",(e=>e.vvColor.values),d.p),new o.F("vvColorColors",(e=>e.vvColor.colors),d.p)),r.code.add(c.H`
    vec4 getColor() {
      float value = ${i}.y;
      if (value <= vvColorValues[0]) {
        return applyOpacity(vvColorColors[0]);
      }

      for (int i = 1; i < vvColorNumber; ++i) {
        if (vvColorValues[i] >= value) {
          float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
          return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
        }
      }

      return applyOpacity(vvColorColors[vvColorNumber - 1]);
    }
    `)):r.code.add(c.H`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),e.include(s.I),e.attributes.add(h.r.PROFILERIGHT,"vec4"),e.attributes.add(h.r.PROFILEUP,"vec4"),e.attributes.add(h.r.PROFILEVERTEXANDNORMAL,"vec4"),r.code.add(c.H`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),r.code.add(c.H`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),r.code.add(c.H`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),r.code.add(c.H`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}class f extends d.S{constructor(){super(...arguments),this.size=(0,r.fA)(1,1)}}},37303:(e,t,i)=>{i.d(t,{s:()=>h});var r=i(24578),s=i(64802),n=i(19635),a=i(4930),o=i(41014),l=i(33763);const c=8;function h(e,t){const i=e.vertex;i.uniforms.add(new n.m("intrinsicWidth",(e=>e.width))),t.vvSize?(e.attributes.add(l.r.SIZEFEATUREATTRIBUTE,"float"),i.uniforms.add(new s.t("vvSizeMinSize",(e=>e.vvSize.minSize)),new s.t("vvSizeMaxSize",(e=>e.vvSize.maxSize)),new s.t("vvSizeOffset",(e=>e.vvSize.offset)),new s.t("vvSizeFactor",(e=>e.vvSize.factor))),i.code.add(o.H`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(e.attributes.add(l.r.SIZE,"float"),i.code.add(o.H`float getSize(){
return intrinsicWidth * size;
}`)),t.vvOpacity?(e.attributes.add(l.r.OPACITYFEATUREATTRIBUTE,"float"),i.constants.add("vvOpacityNumber","int",8),i.uniforms.add(new a.x("vvOpacityValues",(e=>e.vvOpacity.values),c),new a.x("vvOpacityOpacities",(e=>e.vvOpacity.opacityValues),c)),i.code.add(o.H`float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):i.code.add(o.H`vec4 applyOpacity( vec4 color ){
return color;
}`),t.vvColor?(e.include(r.A,t),e.attributes.add(l.r.COLORFEATUREATTRIBUTE,"float"),i.code.add(o.H`vec4 getColor(){
return applyOpacity(interpolateVVColor(colorFeatureAttribute));
}`)):(e.attributes.add(l.r.COLOR,"vec4"),i.code.add(o.H`vec4 getColor(){
return applyOpacity(color);
}`))}},65895:(e,t,i)=>{i.d(t,{K:()=>n});var r=i(27981),s=i(41014);function n(e){e.uniforms.add(new r.e("alignPixelEnabled",((e,t)=>t.alignPixelEnabled))),e.code.add(s.H`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`),e.code.add(s.H`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`)}},87331:(e,t,i)=>{i.d(t,{Q:()=>d,R:()=>h});var r=i(11255),s=i(15510),n=i(69952),a=i(92121),o=i(19635),l=i(41014),c=i(33763);const h=.5;function d(e,t){e.include(s.Y6),e.attributes.add(c.r.POSITION,"vec3"),e.attributes.add(c.r.NORMAL,"vec3"),e.attributes.add(c.r.CENTEROFFSETANDDISTANCE,"vec4");const i=e.vertex;(0,n.NB)(i,t),(0,n.yu)(i,t),i.uniforms.add(new a.E("viewport",((e,t)=>t.camera.fullViewport)),new o.m("polygonOffset",(e=>e.shaderPolygonOffset)),new o.m("cameraGroundRelative",((e,t)=>t.camera.aboveGround?1:-1))),t.hasVerticalOffset&&(0,r.V)(i),i.constants.add("smallOffsetAngle","float",.984807753012208),i.code.add(l.H`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),i.code.add(l.H`
    float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
      float pointGroundSign = ${t.multipassEnabled?l.H.float(0):l.H`sign(pointGroundDistance)`};
      if (pointGroundSign == 0.0) {
        pointGroundSign = cameraGroundRelative;
      }

      // cameraGroundRelative is -1 if camera is below ground, 1 if above ground
      // groundRelative is 1 if both camera and symbol are on the same side of the ground, -1 otherwise
      float groundRelative = cameraGroundRelative * pointGroundSign;

      // view angle dependent part of polygon offset emulation: we take the absolute value because the sign that is
      // dropped is instead introduced using the ground-relative position of the symbol and the camera
      if (polygonOffset > .0) {
        float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
        float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
        float factor = (1.0 - tanAlpha / viewport[2]);

        // same side of the terrain
        if (groundRelative > 0.0) {
          posView *= factor;
        }
        // opposite sides of the terrain
        else {
          posView /= factor;
        }
      }

      return groundRelative;
    }
  `),t.draped&&!t.hasVerticalOffset||(0,n.S7)(i),t.draped||(i.uniforms.add(new o.m("perDistancePixelRatio",((e,t)=>Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)))),i.code.add(l.H`
    void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
      float distanceToCamera = length(posView);

      // Compute offset in world units for a half pixel shift
      float pixelOffset = distanceToCamera * perDistancePixelRatio * ${l.H.float(h)};

      // Apply offset along normal in the direction away from the ground surface
      vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;

      // Apply the same offset also on the view space position
      vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;

      posModel += modelOffset;
      posView += viewOffset;
    }
  `)),t.screenCenterOffsetUnitsEnabled&&(0,n.Nz)(i),t.hasScreenSizePerspective&&(0,s.OH)(i),i.code.add(l.H`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      vec3 centerOffset = centerOffsetAndDistance.xyz;
      float pointGroundDistance = centerOffsetAndDistance.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${t.draped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${t.hasScreenSizePerspective&&(t.hasVerticalOffset||t.screenCenterOffsetUnitsEnabled)?"vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${t.hasVerticalOffset?t.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${t.hasVerticalOffset?l.H`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${t.screenCenterOffsetUnitsEnabled?"":l.H`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${t.screenCenterOffsetUnitsEnabled?t.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${t.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `)}},73227:(e,t,i)=>{i.d(t,{I:()=>o});var r=i(65895),s=i(43793),n=i(65630),a=i(41014);function o(e,t){const{vertex:i,fragment:o}=e;i.include(r.K),t.multipassEnabled&&(i.include(s.H),e.varyings.add("depth","float")),i.code.add(a.H`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${t.multipassEnabled?a.H`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${t.multipassEnabled?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),e.include(n.Q,t),o.code.add(a.H`
  void main() {
    fragColor = vec4(1);
    ${t.multipassEnabled?a.H`
        if(terrainDepthTest(depth)) {
          fragColor.g = 0.5;
        }`:""}
  }
  `)}},86316:(e,t,i)=>{var r;i.d(t,{D:()=>r}),function(e){e[e.Occluded=0]="Occluded",e[e.NotOccluded=1]="NotOccluded",e[e.Both=2]="Both",e[e.COUNT=3]="COUNT"}(r||(r={}))},16075:(e,t,i)=>{i.d(t,{y:()=>c});var r=i(65895),s=i(86316),n=i(92121),a=i(19635),o=i(41014),l=i(19778);function c(e){e.vertex.uniforms.add(new a.m("renderTransparentlyOccludedHUD",((e,t)=>t.hudRenderStyle===s.D.Occluded?1:t.hudRenderStyle===s.D.NotOccluded?0:.75)),new n.E("viewport",((e,t)=>t.camera.fullViewport)),new l.N("hudVisibilityTexture",((e,t)=>t.hudVisibility?.getTexture()))),e.vertex.include(r.K),e.vertex.code.add(o.H`bool testHUDVisibility(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}},38596:(e,t,i)=>{i.d(t,{v:()=>n,z:()=>s});var r=i(41014);function s(e){e.fragment.code.add(r.H`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function n(e){e.fragment.code.add(r.H`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}},77802:(e,t,i)=>{i.d(t,{q:()=>f,h:()=>g});var r=i(80002),s=i(69952),n=i(92121),a=i(19635),o=i(41014),l=i(19778);function c(e){return e.pattern.map((t=>Math.round(t*e.pixelRatio)))}function h(e){return c(e).reduce(((e,t)=>Math.max(e,t)))}i(39637),i(68716),i(89958),i(88416);var d=i(74772),u=i(76982);const p=(0,u.vt)();function f(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?function(e,t){const i=!(t.draped&&t.stipplePreferContinuous),{vertex:c,fragment:f}=e;f.include(r.W),t.draped||((0,s.yu)(c,t),c.uniforms.add(new a.m("worldToScreenPerDistanceRatio",((e,t)=>1/t.camera.perScreenPixelRatio))),c.code.add(o.H`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),e.varyings.add("vStippleDistance","float"),e.varyings.add("vStippleDistanceLimits","vec2"),e.varyings.add("vStipplePatternStretch","float"),c.code.add(o.H`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${m};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),c.code.add(o.H`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),c.code.add(o.H`
    if (segmentLengthPseudoScreen >= ${i?"patternLength":"1e4"}) {
  `),(0,s.Nz)(c),c.code.add(o.H`float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
float segmentLengthScreenRounded = flooredRepetitions * patternLength;
float stretch = repetitions / flooredRepetitions;
vStipplePatternStretch = max(0.75, stretch);
return vec2(0.0, segmentLengthScreenRounded);
}
return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
}`),f.uniforms.add(new l.N("stipplePatternTexture",(e=>e.stippleTexture)),new a.m("stipplePatternSDFNormalizer",(e=>function(e){return e?(Math.floor(.5*(h(e)-1))+.5)/e.pixelRatio:1}(e.stipplePattern))),new a.m("stipplePatternPixelSizeInv",(e=>1/g(e)))),f.code.add(o.H`float getStippleSDF(out bool isClamped) {
float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;
float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv * vLineSizeInv;
u = fract(u);
float encodedSDF = rgba2float(texture(stipplePatternTexture, vec2(u, 0.5)));
float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;
return (sdf - 0.5) * vStipplePatternStretch + 0.5;
}
float getStippleSDF() {
bool ignored;
return getStippleSDF(ignored);
}
float getStippleAlpha() {
bool isClamped;
float stippleSDF = getStippleSDF(isClamped);
float antiAliasedResult = clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);
return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
}`),t.stippleOffColorEnabled?(f.uniforms.add(new n.E("stippleOffColor",(e=>function(e){return null==e?u.uY:4===e.length?e:(0,d.s)(p,e[0],e[1],e[2],1)}(e.stippleOffColor)))),f.code.add(o.H`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`)):f.code.add(o.H`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}(e,t):function(e){e.fragment.code.add(o.H`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}(e)}function g(e){const t=e.stipplePattern;return t?function(e){if(null==e)return 1;const t=c(e);return Math.floor(t.reduce(((e,t)=>e+t)))}(e.stipplePattern)/t.pixelRatio:1}const m=o.H.float(.4)},47913:(e,t,i)=>{i.d(t,{r:()=>l});var r=i(4498),s=i(69952),n=i(19635),a=i(41014),o=i(18994);function l(e,t){const{vertex:i,constants:l}=e;l.add("markerSizePerLineWidth","float",r.PV),(0,s.Nz)(i),null==i.uniforms.get("markerScale")&&i.constants.add("markerScale","float",1),i.code.add(a.H`float getLineWidth() {
return max(getSize(), 1.0) * pixelRatio;
}
float getScreenMarkerSize() {
return markerSizePerLineWidth * markerScale * getLineWidth();
}`),t.space===o.lM.World&&(i.constants.add("maxSegmentLengthFraction","float",.45),i.uniforms.add(new n.m("perRenderPixelRatio",((e,t)=>t.camera.perRenderPixelRatio))),i.code.add(a.H`bool areWorldMarkersHidden(vec4 pos, vec4 other) {
vec3 midPoint = mix(pos.xyz, other.xyz, 0.5);
float distanceToCamera = length(midPoint);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
float worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;
float segmentLen = length(pos.xyz - other.xyz);
return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
}
float getWorldMarkerSize(vec4 pos) {
float distanceToCamera = length(pos.xyz);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
return getScreenMarkerSize() * screenToWorldRatio;
}`))}},43793:(e,t,i)=>{i.d(t,{H:()=>o,U:()=>l});var r=i(16937),s=i(66579),n=i(41014),a=i(19778);function o(e){e.include(r.D),e.uniforms.add(new a.N("geometryDepthTexture",((e,t)=>t.multipassGeometry.linearDepth?.getTexture())),new s.G("nearFar",((e,t)=>t.camera.nearFar))),e.code.add(n.H`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}class l{}},60769:(e,t,i)=>{i.d(t,{n:()=>s});var r=i(41014);function s(e,t){t.spherical?e.vertex.code.add(r.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(r.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),t.spherical?e.vertex.code.add(r.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(r.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}},25853:(e,t,i)=>{i.d(t,{E:()=>E});var r=i(38596),s=i(41014);function n(e){e.fragment.code.add(s.H`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}var a=i(75762),o=i(60060),l=i(16937),c=i(66579),h=i(19635),d=i(99040),u=i(19778);function p(e,t){const i=e.fragment;i.include(l.D),i.uniforms.add(new c.G("nearFar",((e,t)=>t.camera.nearFar))),i.uniforms.add(new u.N("depthMap",((e,t)=>t.linearDepth?.getTexture()))),i.uniforms.add(new d.X("proj",((e,t)=>t.camera.projectionMatrix))),i.uniforms.add(new h.m("invResolutionHeight",((e,t)=>1/t.camera.height))),i.uniforms.add(new d.X("reprojectionMatrix",((e,t)=>t.ssr.reprojectionMatrix))),i.code.add(s.H`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${t.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        return vec3(P, depth);
      }

      // continue with ray marching
      P = clamp(P + dP, vec2(0.0), vec2(0.999));
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}var f=i(4506),g=i(99263),m=i(29740),_=i(99164),y=i(16120),v=i(40574),b=i(27981),x=i(64802),S=i(7804),w=i(34088);class C extends S.n{constructor(e,t){super(e,"samplerCube",w.c.Pass,((i,r,s)=>i.bindTexture(e,t(r,s))))}}function R(e){const t=e.fragment;t.uniforms.add(new d.X("rotationMatrixClouds",((e,t)=>t.cloudsFade.parallax.transform)),new d.X("rotationMatrixCloudsCrossFade",((e,t)=>t.cloudsFade.parallaxNew.transform)),new x.t("anchorPosition",((e,t)=>t.cloudsFade.parallax.anchorPointClouds)),new x.t("anchorPositionCrossFade",((e,t)=>t.cloudsFade.parallaxNew.anchorPointClouds)),new h.m("cloudsHeight",(()=>y.k9)),new h.m("radiusCurvatureCorrectionFactor",((e,t)=>t.cloudsFade.parallax.radiusCurvatureCorrectionFactor)),new h.m("totalFadeInOut",((e,t)=>1-t.cloudsFade.opacity)),new h.m("crossFadeAnchorFactor",((e,t)=>(0,f.qE)(t.cloudsFade.fadeFactor,0,1))),new C("cubeMap",((e,t)=>t.cloudsFade.data?.cubeMap?.colorTexture??null)),new b.e("crossFade",((e,t)=>t.cloudsFade.fadeMode===_.OQ.CROSS_FADE)),new b.e("readChannelsRG",((e,t)=>t.cloudsFade.readChannels===m.c.RG)),new b.e("fadeTextureChannels",((e,t)=>t.cloudsFade.renderingStage===m.c2.FADING))),t.constants.add("planetRadius","float",g.$O.radius),t.code.add(s.H`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)
{
float radiusClouds = planetRadius + cloudsHeight;
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),t.code.add(s.H`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),t.code.add(s.H`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),(0,v.Gc)(t),(0,v.O4)(t),t.code.add(s.H`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(mainLightDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(mainLightDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, RIM_SCATTERING_FACTOR)) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),t.code.add(s.H`vec4 getCloudData(vec3 rayDir, bool readOtherChannel)
{
vec4 cloudData = texture(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
bool readChannels = readChannelsRG ^^ readOtherChannel;
if (readChannels) {
cloudData = vec4(vec3(cloudData.r), cloudData.g);
} else {
cloudData = vec4(vec3(cloudData.b), cloudData.a);
}
if (length(cloudData) == 0.0) {
return vec4(cloudData.rgb, 1.0);
}
return cloudData;
}`),t.code.add(s.H`vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);
}`),t.code.add(s.H`vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
vec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected, fadeTextureChannels);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`),t.code.add(s.H`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)
{
return crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);
}`)}function E(e,t){e.include(a.f,t),e.include(n),e.include(r.v),t.hasCloudsReflections&&e.include(R,t),t.hasScreenSpaceReflections&&e.include(p,t);const i=e.fragment;i.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",o.O).add("ssrHeightFadeEnd","float",o.b).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),i.code.add(s.H`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),i.uniforms.add(new h.m("lightingSpecularStrength",((e,t)=>t.lighting.mainLight.specularStrength)),new h.m("lightingEnvironmentStrength",((e,t)=>t.lighting.mainLight.environmentStrength))),i.code.add(s.H`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),t.hasCloudsReflections&&i.code.add(s.H`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);`),t.hasScreenSpaceReflections?(i.uniforms.add(new d.X("view",((e,t)=>t.camera.viewMatrix)),new u.N("lastFrameColorTexture",((e,t)=>t.ssr.lastFrameColor?.getTexture())),new h.m("fadeFactorSSR",((e,t)=>t.ssr.fadeFactor))),i.code.add(s.H`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`)):i.code.add(s.H`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),t.hasCloudsReflections?t.hasScreenSpaceReflections?i.code.add(s.H`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):i.code.add(s.H`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):i.code.add(s.H`return waterRenderedColor;
}`)}},63149:(e,t,i)=>{i.d(t,{V:()=>u});var r=i(53334),s=i(56560),n=i(74772),a=i(76982),o=i(38596),l=(i(88251),i(66579)),c=i(92121),h=i(41014),d=i(19778);function u(e){e.fragment.uniforms.add(new d.N("texWaveNormal",(e=>e.waveNormal)),new d.N("texWavePerturbation",(e=>e.wavePerturbation)),new c.E("waveParams",(e=>(0,n.s)(p,e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset))),new l.G("waveDirection",(e=>(0,r.hZ)(f,e.waveDirection[0]*e.waveVelocity,e.waveDirection[1]*e.waveVelocity)))),e.include(o.z),e.fragment.code.add(h.H`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}const p=(0,a.vt)(),f=(0,s.vt)()},70789:(e,t,i)=>{i.d(t,{aT:()=>s,fA:()=>n});var r=i(4506);function s(e,t,i,r,s,n=2){const o=1/(Math.abs(i)+Math.abs(r)+Math.abs(s)),l=i*o,c=r*o,h=s<=0?(l>=0?1:-1)*(1-Math.abs(c)):l,d=s<=0?(c>=0?1:-1)*(1-Math.abs(l)):c,u=t*n;e[u]=a(h),e[u+1]=a(d)}function n(e){const t=e.length/3,i=new Int16Array(2*t);let r=0;for(let n=0;n<t;++n)s(i,n,e[r++],e[r++],e[r++]);return i}function a(e){return(0,r.qE)(Math.round(32767*e),-32767,32767)}i(80347),i(19913),i(68435)},935:(e,t,i)=>{i.d(t,{A:()=>G});var r,s,n=i(39744),a=i(41785),o=i(80347),l=i(19913),c=i(74860),h=i(63918),d=i(69891),u=i(26421);class p{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,t){this.objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new f,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth))}destroy(){this._degenerateObjects.clear(),f.clearPool(),R[0]=null,P.prune(),N.prune()}add(e,t=e.length){this._objectCount+=t,this._grow(e,t);const i=f.acquire();for(let r=0;r<t;r++){const t=e[r];this._isDegenerate(t)?this._degenerateObjects.add(t):(i.init(this._root),this._add(t,i))}f.release(i)}remove(e,t=null){this._objectCount-=e.length;const i=f.acquire();for(const r of e){const e=t??(0,d.c)(this.objectToBoundingSphere(r),M);x(e[3])?(i.init(this._root),this._remove(r,e,i)):this._degenerateObjects.delete(r)}f.release(i),this._shrink()}update(e,t){if(!x(t[3])&&this._isDegenerate(e))return;const i=function(e){return R[0]=e,R}(e);this.remove(i,t),this.add(i)}forEachAlongRay(e,t,i){const r=(0,h.LV)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNode(r,e))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObject(r,e)&&i(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObject(r,e)&&i(e)})),!0}))}forEachAlongRayWithVerticalOffset(e,t,i,r){const s=(0,h.LV)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNodeWithOffset(s,e,r))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObjectWithOffset(s,e,r)&&i(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObjectWithOffset(s,e,r)&&i(e)})),!0}))}forEach(e){this._forEachNode(this._root,(t=>{const i=t.node;return i.terminals.forAll(e),null!==i.residents&&i.residents.forAll(e),!0})),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,i,r=(()=>!0),s=1/0){let n=1/0,a=1/0,l=null;const h=v(e,t),u=o=>{if(--s,!r(o))return;const h=this.objectToBoundingSphere(o);if(!(0,c.m7)(i,h))return;const u=b(e,t,(0,d.g)(h)),p=u-h[3],f=u+h[3];p<n&&(n=p,a=f,l=o)};return this._forEachNodeDepthOrdered(this._root,(r=>{if(s<=0||!(0,c.m7)(i,r.bounds))return!1;if((0,o.h)(A,h,r.halfSize),(0,o.g)(A,A,(0,d.g)(r.bounds)),b(e,t,A)>a)return!1;const n=r.node;return n.terminals.forAll((e=>u(e))),null!==n.residents&&n.residents.forAll((e=>u(e))),!0}),e,t),l}forEachInDepthRange(e,t,i,r,s,n,a){let l=-1/0,h=1/0;const u={setRange:e=>{i===p.DepthOrder.FRONT_TO_BACK?(l=Math.max(l,e.near),h=Math.min(h,e.far)):(l=Math.max(l,-e.far),h=Math.min(h,-e.near))}};u.setRange(r);const f=b(t,i,e),g=v(t,i),m=v(t,-i),_=e=>{if(!a(e))return;const r=this.objectToBoundingSphere(e),o=(0,d.g)(r),p=b(t,i,o)-f,g=p-r[3],m=p+r[3];g>h||m<l||!(0,c.m7)(n,r)||s(e,u)};this._forEachNodeDepthOrdered(this._root,(e=>{if(!(0,c.m7)(n,e.bounds))return!1;if((0,o.h)(A,g,e.halfSize),(0,o.g)(A,A,(0,d.g)(e.bounds)),b(t,i,A)-f>h)return!1;if((0,o.h)(A,m,e.halfSize),(0,o.g)(A,A,(0,d.g)(e.bounds)),b(t,i,A)-f<l)return!1;const r=e.node;return r.terminals.forAll((e=>_(e))),null!==r.residents&&r.residents.forAll((e=>_(e))),!0}),t,i)}forEachNode(e){this._forEachNode(this._root,(t=>e(t.node,t.bounds,t.halfSize,t.depth)))}forEachNeighbor(e,t){const i=(0,d.a)(t),r=(0,d.g)(t),s=t=>{const s=this.objectToBoundingSphere(t),n=(0,d.a)(s),a=i+n;return!((0,o.a)((0,d.g)(s),r)-a*a<=0)||e(t)};let n=!0;const a=e=>{n&&(n=s(e))};this._forEachNode(this._root,(e=>{const t=(0,d.a)(e.bounds),s=i+t;if((0,o.a)((0,d.g)(e.bounds),r)-s*s>0)return!1;const l=e.node;return l.terminals.forAll(a),n&&null!==l.residents&&l.residents.forAll(a),n})),n&&this.forEachDegenerateObject(a)}_intersectsNode(e,t){return _((0,d.g)(t.bounds),2*-t.halfSize,T),_((0,d.g)(t.bounds),2*t.halfSize,O),(0,u.O_)(e.origin,e.direction,T,O)}_intersectsNodeWithOffset(e,t,i){return _((0,d.g)(t.bounds),2*-t.halfSize,T),_((0,d.g)(t.bounds),2*t.halfSize,O),i.applyToMinMax(T,O),(0,u.O_)(e.origin,e.direction,T,O)}_intersectsObject(e,t){const i=this.objectToBoundingSphere(t);return!(i[3]>0)||(0,d.i)(i,e)}_intersectsObjectWithOffset(e,t,i){const r=this.objectToBoundingSphere(t);return!(r[3]>0)||(0,d.i)(i.applyToBoundingSphere(r),e)}_forEachNode(e,t){let i=f.acquire().init(e);const r=[i];for(;0!==r.length;){if(i=r.pop(),t(i)&&!i.isLeaf())for(let e=0;e<i.node.children.length;e++)i.node.children[e]&&r.push(f.acquire().init(i).advance(e));f.release(i)}}_forEachNodeDepthOrdered(e,t,i,r=p.DepthOrder.FRONT_TO_BACK){let s=f.acquire().init(e);const n=[s];for(function(e,t,i){if(!N.length)for(let e=0;e<8;++e)N.push({index:0,distance:0});for(let i=0;i<8;++i){const r=S[i];N.data[i].index=i,N.data[i].distance=b(e,t,r)}N.sort(((e,t)=>e.distance-t.distance));for(let e=0;e<8;++e)i[e]=N.data[e].index}(i,r,V);0!==n.length;){if(s=n.pop(),t(s)&&!s.isLeaf())for(let e=7;e>=0;--e){const t=V[e];s.node.children[t]&&n.push(f.acquire().init(s).advance(t))}f.release(s)}}_remove(e,t,i){P.clear();const r=i.advanceTo(t,((e,t)=>{P.push(e.node),P.push(t)}))?i.node.terminals:i.node.residents;if(r.removeUnordered(e),0===r.length)for(let e=P.length-2;e>=0;e-=2){const t=P.data[e],i=P.data[e+1];if(!this._purge(t,i))break}}_nodeIsEmpty(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(let t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0}_purge(e,t){return t>=0&&(e.children[t]=null),!!this._nodeIsEmpty(e)&&(null===e.residents&&(e.residents=new a.A({shrink:!0})),!0)}_add(e,t){t.advanceTo(this.objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let i=0;i<t.length;i++){const r=f.acquire().init(e);this._add(t.at(i),r),f.release(r)}}_grow(e,t){if(0!==t&&(y(e,t,(e=>this.objectToBoundingSphere(e)),I),x(I[3])&&!this._fitsInsideTree(I)))if(this._nodeIsEmpty(this._root.node))(0,d.c)(I,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const e=this._rootBoundsForRootAsSubNode(I);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(I,e):this._growRootAsSubNode(e),f.release(e)}}_rebuildTree(e,t){(0,o.c)((0,d.g)(D),(0,d.g)(t.bounds)),D[3]=t.halfSize,y([e,D],2,(e=>e),F);const i=f.acquire().init(this._root);this._root.initFrom(null,F,F[3]),this._root.increaseHalfSize(1.25),this._forEachNode(i,(e=>(this.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&this.add(e.node.residents.data,e.node.residents.length),!0))),f.release(i)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let i=0;return this._forEachNode(this._root,(e=>(i=Math.max(i,e.depth),i+t<=this._maximumDepth))),i+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],i=e;let r=-1/0;const s=this._root.bounds,n=this._root.halfSize;for(let e=0;e<3;e++){const a=s[e]-n-(i[e]-t),o=i[e]+t-(s[e]+n),l=Math.max(0,Math.ceil(a/(2*n))),c=Math.max(0,Math.ceil(o/(2*n)))+1,h=2**Math.ceil(Math.log(l+c)*Math.LOG2E);r=Math.max(r,h),L[e].min=l,L[e].max=c}for(let e=0;e<3;e++){let t=L[e].min,i=L[e].max;const a=(r-(t+i))/2;t+=Math.ceil(a),i+=Math.floor(a);const o=s[e]-n-t*n*2;E[e]=o+(i+t)*n}const a=r*n;return E[3]=a*C,f.acquire().initFrom(null,E,a,0)}_growRootAsSubNode(e){const t=this._root.node;(0,o.c)((0,d.g)(I),(0,d.g)(this._root.bounds)),I[3]=this._root.halfSize,this._root.init(e),e.advanceTo(I,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let i=0,r=0;for(;r<t.length&&null==e;)i=r++,e=t[i];for(;r<t.length;)if(t[r++])return-1;return i}_isDegenerate(e){return!x(this.objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,i=this._root.halfSize;return e[3]<=i&&e[0]>=t[0]-i&&e[0]<=t[0]+i&&e[1]>=t[1]-i&&e[1]<=t[1]+i&&e[2]>=t[2]-i&&e[2]<=t[2]+i}toJSON(){const{maximumDepth:e,maximumObjectsPerNode:t,_objectCount:i}=this,r=this._nodeToJSON(this._root.node);return{maximumDepth:e,maximumObjectsPerNode:t,objectCount:i,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:r}}}_nodeToJSON(e){const t=e.children.map((e=>e?this._nodeToJSON(e):null)),i=e.residents?.map((e=>this.objectToBoundingSphere(e))),r=e.terminals?.map((e=>this.objectToBoundingSphere(e)));return{children:t,residents:i,terminals:r}}static fromJSON(e){const t=new p((e=>e),{maximumDepth:e.maximumDepth,maximumObjectsPerNode:e.maximumObjectsPerNode});return t._objectCount=e.objectCount,t._root.initFrom(e.root.node,e.root.bounds,e.root.halfSize,e.root.depth),t}}class f{constructor(){this.bounds=(0,d.d)(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,i,r=this.depth){return this.node=null!=e?e:f.createEmptyNode(),t&&(0,d.c)(t,this.bounds),this.halfSize=i,this.depth=r,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*C}advance(e){let t=this.node.children[e];t||(t=f.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const i=S[e];return this.bounds[0]+=i[0]*this.halfSize,this.bounds[1]+=i[1]*this.halfSize,this.bounds[2]+=i[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,t,i=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!i)return t&&t(this,-1),!1;this.node.residents=null}const r=this._childIndex(e);t&&t(this,r),this.advance(r)}}isLeaf(){return null!=this.node.residents}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new a.A({shrink:!0}),residents:new a.A({shrink:!0})}}static acquire(){return f._pool.acquire()}static release(e){f._pool.release(e)}static clearPool(){f._pool.prune()}}function g(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function m(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function _(e,t,i){i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t}function y(e,t,i,r){if(1===t){const t=i(e[0]);(0,d.c)(t,r)}else{T[0]=1/0,T[1]=1/0,T[2]=1/0,O[0]=-1/0,O[1]=-1/0,O[2]=-1/0;for(let r=0;r<t;r++){const t=i(e[r]);x(t[3])&&(g(T,t),m(O,t))}(0,o.k)((0,d.g)(r),T,O,.5),r[3]=Math.max(O[0]-T[0],O[1]-T[1],O[2]-T[2])/2}}function v(e,t){let i,r=1/0;for(let s=0;s<8;++s){const n=b(e,t,w[s]);n<r&&(r=n,i=w[s])}return i}function b(e,t,i){return t*(e[0]*i[0]+e[1]*i[1]+e[2]*i[2])}function x(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}f._pool=new n.A(f),r=p||(p={}),(s=r.DepthOrder||(r.DepthOrder={}))[s.FRONT_TO_BACK=1]="FRONT_TO_BACK",s[s.BACK_TO_FRONT=-1]="BACK_TO_FRONT";const S=[(0,l.fA)(-1,-1,-1),(0,l.fA)(1,-1,-1),(0,l.fA)(-1,1,-1),(0,l.fA)(1,1,-1),(0,l.fA)(-1,-1,1),(0,l.fA)(1,-1,1),(0,l.fA)(-1,1,1),(0,l.fA)(1,1,1)],w=[(0,l.fA)(-1,-1,-1),(0,l.fA)(-1,-1,1),(0,l.fA)(-1,1,-1),(0,l.fA)(-1,1,1),(0,l.fA)(1,-1,-1),(0,l.fA)(1,-1,1),(0,l.fA)(1,1,-1),(0,l.fA)(1,1,1)],C=Math.sqrt(3),R=[null],E=(0,d.d)(),A=(0,l.vt)(),T=(0,l.vt)(),O=(0,l.vt)(),P=new a.A,M=(0,d.d)(),I=(0,d.d)(),D=(0,d.d)(),F=(0,d.d)(),L=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],N=new a.A,V=[0,0,0,0,0,0,0,0],G=p},72253:(e,t,i)=>{var r;i.d(t,{O:()=>r}),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Cross=2]="Cross",e[e.ForwardDiagonal=3]="ForwardDiagonal",e[e.BackwardDiagonal=4]="BackwardDiagonal",e[e.DiagonalCross=5]="DiagonalCross",e[e.COUNT=6]="COUNT"}(r||(r={}))},18994:(e,t,i)=>{i.d(t,{Dt:()=>d,kJ:()=>s,lM:()=>r});var r,s,n,a=i(82392),o=i(77788),l=i(51662),c=i(7782),h=i(18693);(n=r||(r={}))[n.Draped=0]="Draped",n[n.Screen=1]="Screen",n[n.World=2]="World",n[n.COUNT=3]="COUNT",function(e){e[e.Center=0]="Center",e[e.Tip=1]="Tip",e[e.COUNT=2]="COUNT"}(s||(s={}));class d extends h.E{constructor(){super(...arguments),this.output=o.V.Color,this.transparencyPassType=c.y.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.space=r.Screen,this.hideOnShortSegments=!1,this.hasCap=!1,this.anchor=s.Center,this.hasTip=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}get draped(){return this.space===r.Draped}}(0,a._)([(0,l.W)({count:o.V.COUNT})],d.prototype,"output",void 0),(0,a._)([(0,l.W)({count:c.y.COUNT})],d.prototype,"transparencyPassType",void 0),(0,a._)([(0,l.W)()],d.prototype,"occluder",void 0),(0,a._)([(0,l.W)()],d.prototype,"hasSlicePlane",void 0),(0,a._)([(0,l.W)()],d.prototype,"writeDepth",void 0),(0,a._)([(0,l.W)({count:r.COUNT})],d.prototype,"space",void 0),(0,a._)([(0,l.W)()],d.prototype,"hideOnShortSegments",void 0),(0,a._)([(0,l.W)()],d.prototype,"hasCap",void 0),(0,a._)([(0,l.W)({count:s.COUNT})],d.prototype,"anchor",void 0),(0,a._)([(0,l.W)()],d.prototype,"hasTip",void 0),(0,a._)([(0,l.W)()],d.prototype,"vvSize",void 0),(0,a._)([(0,l.W)()],d.prototype,"vvColor",void 0),(0,a._)([(0,l.W)()],d.prototype,"vvOpacity",void 0),(0,a._)([(0,l.W)()],d.prototype,"hasOccludees",void 0),(0,a._)([(0,l.W)()],d.prototype,"multipassEnabled",void 0),(0,a._)([(0,l.W)()],d.prototype,"cullAboveGround",void 0),(0,a._)([(0,l.W)({constValue:!1})],d.prototype,"occlusionPass",void 0),(0,a._)([(0,l.W)({constValue:!0})],d.prototype,"hasVvInstancing",void 0),(0,a._)([(0,l.W)({constValue:!0})],d.prototype,"hasSliceTranslatedView",void 0)},47268:(e,t,i)=>{i.d(t,{Q:()=>h,x:()=>r});var r,s,n=i(82392),a=i(77788),o=i(51662),l=i(7782),c=i(18693);(s=r||(r={}))[s.BUTT=0]="BUTT",s[s.SQUARE=1]="SQUARE",s[s.ROUND=2]="ROUND",s[s.COUNT=3]="COUNT";class h extends c.E{constructor(){super(...arguments),this.output=a.V.Color,this.capType=r.BUTT,this.transparencyPassType=l.y.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.wireframe=!1,this.objectAndLayerIdColorInstanced=!1}}(0,n._)([(0,o.W)({count:a.V.COUNT})],h.prototype,"output",void 0),(0,n._)([(0,o.W)({count:r.COUNT})],h.prototype,"capType",void 0),(0,n._)([(0,o.W)({count:l.y.COUNT})],h.prototype,"transparencyPassType",void 0),(0,n._)([(0,o.W)()],h.prototype,"occluder",void 0),(0,n._)([(0,o.W)()],h.prototype,"hasSlicePlane",void 0),(0,n._)([(0,o.W)()],h.prototype,"hasPolygonOffset",void 0),(0,n._)([(0,o.W)()],h.prototype,"writeDepth",void 0),(0,n._)([(0,o.W)()],h.prototype,"draped",void 0),(0,n._)([(0,o.W)()],h.prototype,"stippleEnabled",void 0),(0,n._)([(0,o.W)()],h.prototype,"stippleOffColorEnabled",void 0),(0,n._)([(0,o.W)()],h.prototype,"stipplePreferContinuous",void 0),(0,n._)([(0,o.W)()],h.prototype,"roundJoins",void 0),(0,n._)([(0,o.W)()],h.prototype,"applyMarkerOffset",void 0),(0,n._)([(0,o.W)()],h.prototype,"vvSize",void 0),(0,n._)([(0,o.W)()],h.prototype,"vvColor",void 0),(0,n._)([(0,o.W)()],h.prototype,"vvOpacity",void 0),(0,n._)([(0,o.W)()],h.prototype,"falloffEnabled",void 0),(0,n._)([(0,o.W)()],h.prototype,"innerColorEnabled",void 0),(0,n._)([(0,o.W)()],h.prototype,"hasOccludees",void 0),(0,n._)([(0,o.W)()],h.prototype,"multipassEnabled",void 0),(0,n._)([(0,o.W)()],h.prototype,"cullAboveGround",void 0),(0,n._)([(0,o.W)()],h.prototype,"wireframe",void 0),(0,n._)([(0,o.W)()],h.prototype,"objectAndLayerIdColorInstanced",void 0),(0,n._)([(0,o.W)({constValue:!1})],h.prototype,"occlusionPass",void 0),(0,n._)([(0,o.W)({constValue:!0})],h.prototype,"hasVvInstancing",void 0),(0,n._)([(0,o.W)({constValue:!0})],h.prototype,"hasSliceTranslatedView",void 0)},50241:(e,t,i)=>{i.d(t,{A:()=>y});var r=i(82392),s=i(62991),n=i(80861),a=i(37623),o=i(61985),l=i(81482),c=(i(6273),i(67498),i(26325)),h=i(41332),d=i(11479),u=i(51216),p=i(46227),f=i(57179),g=i(10591),m=i(83911),_=i(96444);const y=e=>{let t=class extends e{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([(0,o.wB)((()=>{const e=this.layer;return[e&&"elevationInfo"in e?e.elevationInfo?.featureExpressionInfo:null,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,this.filter,this.featureEffect,this.timeExtent]}),(()=>this._handleRequiredFieldsChange()),o.pc),(0,o.on)((()=>this.view?.floors),"change",(()=>this._handleRequiredFieldsChange())),(0,o.on)((()=>{const e=this.layer;return e&&"sublayers"in e?e.sublayers:null}),"change",(()=>this._handleRequiredFieldsChange()))])}get availableFields(){if(!this.layer)return[];const{layer:e,layer:{fieldsIndex:t},requiredFields:i}=this;return"outFields"in e&&e.outFields?(0,p.DB)(t,[...(0,p.hL)(t,e.outFields),...i]):(0,p.DB)(t,i)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){n.A.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=null!=this.filter?this.filter.createQuery(e):new g.A(e);if("feature"===this.layer.type){const e=(0,f.E)(this);null!=e&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return null!=this.timeExtent&&(t.timeExtent=null!=t.timeExtent?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new g.A(e)}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(e,t){return this._validateFetchPopupFeatures(e,t),this._fetchPopupFeatures(e,t)}_loadArcadeModules(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type))?(0,m.lw)():Promise.resolve()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:i,objectIdField:r}}=this,s="renderer"in t&&t.renderer,a="orderBy"in t&&t.orderBy,o="featureReduction"in t?t.featureReduction:null,l=new Set,c=await Promise.allSettled([s?s.collectRequiredFields(l,i):null,(0,p.Im)(l,t),e&&"elevationInfo"in t?(0,p.NO)(l,t):null,null!=this.filter?(0,p.o)(l,t,this.filter):null,e||null==this.featureEffect?null:(0,p.o)(l,t,this.featureEffect.filter),!e&&o?(0,p.RP)(l,t,o):null,!e&&a?(0,p.f)(l,t,a):null]);if("timeInfo"in t&&t.timeInfo&&this.timeExtent&&(0,p._w)(l,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"feature"===t.type&&(t.floorInfo&&(0,p._w)(l,t.fieldsIndex,[t.floorInfo.floorField]),e&&null!=t.infoFor3D&&(null==t.globalIdField&&n.A.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),(0,p._w)(l,t.fieldsIndex,[t.globalIdField]))),"subtype-group"===t.type){(0,p.rq)(l,i,t.subtypeField);const e=t.sublayers.map((e=>Promise.all([e.renderer?.collectRequiredFields(l,i),(0,p.Im)(l,e)])));await Promise.allSettled(e)}"catalog-footprint"===t.type&&(0,p._w)(l,i,[t.parent.itemSourceField,t.parent.itemTypeField]);for(const e of c)"rejected"===e.status&&n.A.getLogger(this).error(e.reason);(0,p.rq)(l,i,r),e&&"displayField"in t&&t.displayField&&(0,p.rq)(l,i,t.displayField);const h=Array.from(l).sort();this._set("requiredFields",h)}_validateFetchPopupFeatures(e,t){if(null!=t)for(const i of e){const e=i.origin&&"layer"in i.origin?i.origin.layer:i.layer;if("popupEnabled"in e&&!e.popupEnabled)throw new s.A("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:e});if(i.isAggregate){const t="featureReduction"in e?e.featureReduction:null;if(!(t&&"popupTemplate"in t&&t.popupEnabled&&t.popupTemplate))throw new s.A("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:e})}else if("popupTemplate"in e&&!(0,_.D8)(e,t))throw new s.A("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:e})}}_popupFeatureHasRequiredFields(e,t){return(0,p.Kl)(t,e)}async _fetchPopupFeatures(e,t){const i=new Array(e.length),r=new Map,s=await this._createPopupQuery(e.map((e=>e.origin?.layer??e.layer)),t);for(let n=0;n<e.length;n++){const o=e[n];if(o.isAggregate){i[n]=o;continue}const l=o.origin?.layer??o.layer;if(!l||!("popupEnabled"in l))continue;const c=(0,p.hL)(this.layer.fieldsIndex,s.outFields),h=(0,_.D8)(l,t);if(null==h)continue;const d=await this._loadArcadeModules(h);(0,a.Te)(t),d&&d.arcadeUtils.hasGeometryOperations(h)||!this._popupFeatureHasRequiredFields(o,c)?r.set(o.getObjectId(),{graphic:o,index:n}):i[n]=o}if("stream"===this.layer.type||0===r.size)return i.filter(Boolean);s.objectIds=Array.from(r.keys());try{const e=await this.layer.queryFeatures(s,t);for(const t of e.features){const{graphic:{geometry:e,origin:s},index:n}=r.get(t.getObjectId());t.geometry||=e,t.origin=s,i[n]=t}}catch{}return i.filter(Boolean)}async _createPopupQuery(e,t){const i=this.layer.createQuery(),r=new Set;let s=!1;const n=e??[this.layer];for(const e of n){if(!("popupEnabled"in e))continue;const i=(0,_.D8)(e,t);if(null==i)continue;const n=await this._loadArcadeModules(i);(0,a.Te)(t);const o=n&&n.arcadeUtils.hasGeometryOperations(i);s=!("point"!==this.layer.geometryType&&!o);const l=await(0,_.TO)(this.layer,i);(0,a.Te)(t);for(const e of l)r.add(e)}if(i.returnGeometry=s,i.returnZ=s,i.returnM=s,i.outFields=Array.from(r),i.outSpatialReference=this.view.spatialReference,"feature"===this.layer.type){const e=(0,f.E)(this);null!=e&&(i.where=i.where?`(${i.where}) AND (${e})`:e)}return i}canResume(){return!(!super.canResume()||null!=this.timeExtent&&this.timeExtent.isEmpty)}getTest(){return{createPopupQuery:e=>this._createPopupQuery(void 0,e)}}get test(){return this.getTest()}};return(0,r._)([(0,l.MZ)()],t.prototype,"_updatingRequiredFieldsPromise",void 0),(0,r._)([(0,l.MZ)({readOnly:!0})],t.prototype,"availableFields",null),(0,r._)([(0,l.MZ)({readOnly:!0})],t.prototype,"dataUpdating",void 0),(0,r._)([(0,l.MZ)({type:d.A})],t.prototype,"featureEffect",null),(0,r._)([(0,l.MZ)({type:u.A})],t.prototype,"filter",void 0),(0,r._)([(0,l.MZ)(h.ui)],t.prototype,"timeExtent",void 0),(0,r._)([(0,l.MZ)()],t.prototype,"layer",void 0),(0,r._)([(0,l.MZ)({type:Number})],t.prototype,"maximumNumberOfFeatures",null),(0,r._)([(0,l.MZ)({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),(0,r._)([(0,l.MZ)({readOnly:!0})],t.prototype,"requiredFields",void 0),(0,r._)([(0,l.MZ)()],t.prototype,"suspended",void 0),(0,r._)([(0,l.MZ)()],t.prototype,"view",void 0),t=(0,r._)([(0,c.$)("esri.views.layers.FeatureLayerView")],t),t}},24775:(e,t,i)=>{i.d(t,{A:()=>f});var r=i(82392),s=i(73783),n=i(57888),a=i(23377),o=i(80861),l=i(57725),c=i(71004),h=i(81482),d=(i(6273),i(67498),i(26325)),u=i(68660);let p=class extends((0,a.sA)((0,c.g)(n.A.EventedMixin(s.A)))){constructor(e){super(e),this._updatingHandles=new u.U,this.layer=null,this.parent=null}initialize(){this.when().catch((e=>{if("layerview:create-error"!==e.name){const t=this.layer&&this.layer.id||"no id",i=this.layer?.title||"no title";o.A.getLogger(this).error("#resolve()",`Failed to resolve layer view (layer title: '${i}', id: '${t}')`,e)}}))}destroy(){this._updatingHandles=(0,l.pR)(this._updatingHandles)}get fullOpacity(){return(this.layer?.opacity??1)*(this.parent?.fullOpacity??1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this._updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){return!0===this.layer?.visible}set visible(e){this._overrideIfSome("visible",e)}canResume(){return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready||!1}getSuspendInfo(){const e=this.parent?.suspended?this.parent.suspendInfo:{};return this.view?.ready||(e.viewNotReady=!0),this.layer&&this.layer.loaded||(e.layerNotLoaded=!0),this.visible||(e.layerInvisible=!0),e}isUpdating(){return!1}};(0,r._)([(0,h.MZ)()],p.prototype,"fullOpacity",null),(0,r._)([(0,h.MZ)()],p.prototype,"layer",void 0),(0,r._)([(0,h.MZ)()],p.prototype,"parent",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],p.prototype,"suspended",null),(0,r._)([(0,h.MZ)({readOnly:!0})],p.prototype,"suspendInfo",null),(0,r._)([(0,h.MZ)({readOnly:!0})],p.prototype,"legendEnabled",null),(0,r._)([(0,h.MZ)({type:Boolean,readOnly:!0})],p.prototype,"updating",null),(0,r._)([(0,h.MZ)({readOnly:!0})],p.prototype,"updatingProgress",null),(0,r._)([(0,h.MZ)()],p.prototype,"visible",null),(0,r._)([(0,h.MZ)()],p.prototype,"view",void 0),p=(0,r._)([(0,d.$)("esri.views.layers.LayerView")],p);const f=p},30386:(e,t,i)=>{i.d(t,{A:()=>l});var r=i(82392),s=i(80861),n=i(37623),a=i(61985),o=(i(6273),i(67498),i(62991),i(26325));const l=e=>{let t=class extends e{initialize(){this.addHandles((0,a.on)((()=>this.layer),"refresh",(e=>{this.doRefresh(e.dataChanged).catch((e=>{(0,n.zf)(e)||s.A.getLogger(this).error(e)}))})),"RefreshableLayerView")}};return t=(0,r._)([(0,o.$)("esri.layers.mixins.RefreshableLayerView")],t),t}},96444:(e,t,i)=>{i.d(t,{D8:()=>n,TO:()=>s,d0:()=>a});var r=i(46227);async function s(e,t=e.popupTemplate){if(null==t)return[];const i=await t.getRequiredFields(e.fieldsIndex),{lastEditInfoEnabled:s}=t,{objectIdField:n,typeIdField:a,globalIdField:o,relationships:l}=e;if(i.includes("*"))return["*"];const c=s?(0,r.eX)(e):[],h=(0,r.DB)(e.fieldsIndex,[...i,...c]);return a&&h.push(a),h&&n&&e.fieldsIndex?.has(n)&&!h.includes(n)&&h.push(n),h&&o&&e.fieldsIndex?.has(o)&&!h.includes(o)&&h.push(o),l&&l.forEach((t=>{const{keyField:i}=t;h&&i&&e.fieldsIndex?.has(i)&&!h.includes(i)&&h.push(i)})),h}function n(e,t){return e.popupTemplate?e.popupTemplate:null!=t&&t.defaultPopupTemplateEnabled&&null!=e.defaultPopupTemplate?e.defaultPopupTemplate:null}function a(e,t){return null!=n(e,{defaultPopupTemplateEnabled:t})}},96383:(e,t,i)=>{function r(e){return e&&"function"==typeof e.highlight}function s(e,t,i){return null==e||e>i&&(0===t||e<t)}function n(e,t){return null!=e&&e>0||null!=t&&t>0}function a(e){const t=e.effectiveScaleRange;return{minScale:t?.minScale??0,maxScale:t?.maxScale??0}}i.d(t,{Cf:()=>a,JU:()=>s,Of:()=>r,WK:()=>n})},89325:(e,t,i)=>{i.d(t,{g:()=>c});var r=i(3223),s=i(80861),n=i(62088),a=i(63103),o=i(68716);const l=()=>s.A.getLogger("esri.views.webgl.BufferObject");class c{static createIndex(e,t,i){return new c(e,o.NZ.ELEMENT_ARRAY_BUFFER,t,i)}static createVertex(e,t,i){return new c(e,o.NZ.ARRAY_BUFFER,t,i)}static createUniform(e,t,i){return new c(e,o.NZ.UNIFORM_BUFFER,t,i)}static createPixelPack(e,t=o._U.STREAM_READ,i){const r=new c(e,o.NZ.PIXEL_PACK_BUFFER,t);return i&&r.setSize(i),r}static createPixelUnpack(e,t=o._U.STREAM_DRAW,i){return new c(e,o.NZ.PIXEL_UNPACK_BUFFER,t,i)}static createTransformFeedback(e,t=o._U.STATIC_DRAW,i){const r=new c(e,o.NZ.TRANSFORM_FEEDBACK_BUFFER,t);return r.setSize(i),r}constructor(e,t,i,r){this._context=e,this.bufferType=t,this.usage=i,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(o.vt.BufferObject,this),this._glName=this._context.gl.createBuffer(),(0,a.Y2)(this._context.gl),r&&this.setData(r)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get usedMemory(){return this.bufferType===o.NZ.ELEMENT_ARRAY_BUFFER?this._indexType===o.pe.UNSIGNED_INT?4*this._size:2*this._size:this._size}get _isVAOAware(){return this.bufferType===o.NZ.ELEMENT_ARRAY_BUFFER||this.bufferType===o.NZ.ARRAY_BUFFER}dispose(){this._context?.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(o.vt.BufferObject,this),this._context=null):this._glName&&l().warn("Leaked WebGL buffer object")}setSize(e,t=null){if(e<=0&&l().error("Buffer size needs to be positive!"),this.bufferType===o.NZ.ELEMENT_ARRAY_BUFFER&&null!=t)switch(this._indexType=t,t){case o.pe.UNSIGNED_SHORT:e*=2;break;case o.pe.UNSIGNED_INT:e*=4}this._setBufferData(e)}setData(e){if(!e)return;let t=e.byteLength;this.bufferType===o.NZ.ELEMENT_ARRAY_BUFFER&&((0,n.jq)(e)&&(t/=2,this._indexType=o.pe.UNSIGNED_SHORT),(0,n.XJ)(e)&&(t/=4,this._indexType=o.pe.UNSIGNED_INT)),this._setBufferData(t,e)}_setBufferData(e,t=null){this._size=e;const i=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const r=this._context.gl;null!=t?r.bufferData(this.bufferType,t,this.usage):r.bufferData(this.bufferType,e,this.usage),(0,a.Y2)(r),this._isVAOAware&&this._context.bindVAO(i)}setSubData(e,t,i,r){if(!e)return;(t<0||t*e.BYTES_PER_ELEMENT>=this.usedMemory)&&l().error("offset is out of range!"),i>=r&&l().error("end must be bigger than start!"),(t+(r-i))*e.BYTES_PER_ELEMENT>this.usedMemory&&l().error("An attempt to write beyond the end of the buffer!");const s=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const{gl:n}=this._context;n.bufferSubData(this.bufferType,t*e.BYTES_PER_ELEMENT,e,i,r-i),(0,a.Y2)(n),this._isVAOAware&&this._context.bindVAO(s)}getSubData(e,t=0,i,s){if(i<0||s<0)return void l().error("Problem getting subdata: offset and length were less than zero!");const n=function(e){return(0,r.Xj)(e)}(e)?e.BYTES_PER_ELEMENT:1;if(n*((i??0)+(s??0))>e.byteLength)return void l().error("Problem getting subdata: offset and length exceeded destination size!");t+n*(s??0)>this.usedMemory&&l().warn("Potential problem getting subdata: requested data exceeds buffer size!");const a=this._context.gl;this.bufferType===o.NZ.TRANSFORM_FEEDBACK_BUFFER?(this._context.bindBuffer(this,o.NZ.TRANSFORM_FEEDBACK_BUFFER),a.getBufferSubData(o.NZ.TRANSFORM_FEEDBACK_BUFFER,t,e,i,s),this._context.unbindBuffer(o.NZ.TRANSFORM_FEEDBACK_BUFFER)):(this._context.bindBuffer(this,o.NZ.COPY_READ_BUFFER),a.getBufferSubData(o.NZ.COPY_READ_BUFFER,t,e,i,s),this._context.unbindBuffer(o.NZ.COPY_READ_BUFFER))}async getSubDataAsync(e,t=0,i,r){await this._context.clientWaitAsync(),this.getSubData(e,t,i,r)}}},49214:(e,t,i)=>{i.d(t,{H:()=>d}),i(6273);var r=i(80861),s=i(57725),n=i(89325),a=i(63103),o=i(68716),l=i(86424),c=i(53386),h=i(89958);class d{constructor(e,t,i=null){this._context=e,this._glName=null,this._colorAttachments=new Map,this._depthStencilBuffer=null,this._depthStencilTexture=null,this._initialized=!1,e.instanceCounter.increment(o.vt.FramebufferObject,this);const r=u(t)?t:new h.g(this._context,t);if(this._colorAttachments.set(o.Nm.COLOR_ATTACHMENT0,r),this._validateTextureDescriptor(r.descriptor),this._validateColorAttachmentPoint(o.Nm.COLOR_ATTACHMENT0),null!=i)if(function(e){return u(e)||null!=e&&"pixelFormat"in e}(i))this._context.capabilities.depthTexture||console.error("Setting the depth/stencil texture as an attachment requires WEBGL_depth_texture or WebGL2"),this._depthStencilTexture=u(i)?i:new h.g(this._context,i),this._validateTextureDescriptor(this._depthStencilTexture.descriptor);else{const e=function(e){return null!=e&&"type"in e&&e.type===l.p.RenderBuffer}(i)?i:new c.l(this._context,i);this._depthStencilBuffer=e,this._validateRenderBufferDescriptor(e.descriptor)}}dispose(){if(0===this._colorAttachments.size&&!this._glName)return;const e=this._context.getBoundFramebufferObject();this._colorAttachments.forEach(((e,t)=>this.detachColorTexture(t)?.dispose())),this.detachDepthStencilBuffer()?.dispose(),this.detachDepthStencilTexture()?.dispose(),this._glName&&(this._context.gl.deleteFramebuffer(this._glName),this._glName=null),this._context.bindFramebuffer(e),this._context.instanceCounter.decrement(o.vt.FramebufferObject,this)}get glName(){return this._glName}get colorTexture(){return this._colorAttachments.get(o.Nm.COLOR_ATTACHMENT0)}get depthStencil(){return this._depthStencilTexture||this._depthStencilBuffer}get depthStencilTexture(){return this._depthStencilTexture}get width(){const e=this._colorAttachments.get(o.Nm.COLOR_ATTACHMENT0);return e?.descriptor?.width??0}get height(){const e=this._colorAttachments.get(o.Nm.COLOR_ATTACHMENT0);return e?.descriptor?.height??0}get usedMemory(){return[...this._colorAttachments].reduce(((e,[t,i])=>e+i.usedMemory),this.depthStencil?.usedMemory??0)}getColorTexture(e){const t=this._colorAttachments.get(e);return t&&u(t)?t:null}get colorAttachments(){return[...this._colorAttachments.keys()]}attachColorTexture(e,t=o.Nm.COLOR_ATTACHMENT0){if(!e)return;this._validateColorAttachmentPoint(t);const i=e.descriptor;this._validateTextureDescriptor(i),this.detachColorTexture(t)?.dispose(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,t)),this._colorAttachments.set(t,e)}detachColorTexture(e=o.Nm.COLOR_ATTACHMENT0){const t=this._colorAttachments.get(e);if(t){if(this._initialized){const t=this._context.getBoundFramebufferObject();this._context.bindFramebuffer(this),this._framebufferTexture2D(null,e),this._context.bindFramebuffer(t)}return this._colorAttachments.delete(e),t}}setColorTextureTarget(e,t=o.Nm.COLOR_ATTACHMENT0){const i=this._colorAttachments.get(t);i&&this._framebufferTexture2D(i.glName,t,e)}attachDepthStencil(e){if(e)switch(e.type){case l.p.Texture:return this._attachDepthStencilTexture(e);case l.p.RenderBuffer:return this._attachDepthStencilBuffer(e)}}_attachDepthStencilTexture(e){if(null==e)return;const t=e.descriptor;t.pixelFormat!==o.Ab.DEPTH_STENCIL&&t.pixelFormat!==o.Ab.DEPTH24_STENCIL8&&console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!"),t.dataType!==o.ld.UNSIGNED_INT_24_8&&console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"),this._context.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture!"),this._validateTextureDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,o.nI)),this._depthStencilTexture?.dispose(),this._depthStencilTexture=e}detachDepthStencilTexture(){const e=this._depthStencilTexture;return e&&this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,o.nI)),this._depthStencilTexture=null,e}_attachDepthStencilBuffer(e){if(null==e)return;const t=e.descriptor;if(this._validateRenderBufferDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized){this._context.bindFramebuffer(this);const i=this._context.gl,r=this._getGLAttachmentPoint(t);i.framebufferRenderbuffer(o.R.FRAMEBUFFER,r,i.RENDERBUFFER,e.glName)}this._depthStencilBuffer=e}detachDepthStencilBuffer(){const e=this._depthStencilBuffer;if(e&&this._initialized){this._context.bindFramebuffer(this);const t=this._context.gl,i=this._getGLAttachmentPoint(e.descriptor);t.framebufferRenderbuffer(o.R.FRAMEBUFFER,i,t.RENDERBUFFER,null)}return this._depthStencilBuffer=null,e}copyToTexture(e,t,i,r,s,n,a){(e<0||t<0||s<0||n<0)&&console.error("Offsets cannot be negative!"),(i<=0||r<=0)&&console.error("Copy width and height must be greater than zero!");const l=a.descriptor;a.descriptor.target!==o.Ap.TEXTURE_2D&&console.error("Texture target must be TEXTURE_2D!"),(null==l?.width||null==l?.height||e+i>this.width||t+r>this.height||s+i>l.width||n+r>l.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const c=this._context,d=c.bindTexture(a,h.g.TEXTURE_UNIT_FOR_UPDATES);c.setActiveTexture(h.g.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(this),c.gl.copyTexSubImage2D(o.Ap.TEXTURE_2D,0,s,n,e,t,i,r),c.bindTexture(d,h.g.TEXTURE_UNIT_FOR_UPDATES)}readPixels(e,t,i,r,s,n,a){(i<=0||r<=0)&&console.error("Copy width and height must be greater than zero!"),a||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(e,t,i,r,s,n,a)}async readPixelsAsync(e,t,i,r,s,a,l){const{gl:c}=this._context,h=n.g.createPixelPack(this._context,o._U.STREAM_READ,l.byteLength);this._context.bindBuffer(h),this._context.bindFramebuffer(this),c.readPixels(e,t,i,r,s,a,0),this._context.unbindBuffer(o.NZ.PIXEL_PACK_BUFFER),await h.getSubDataAsync(l),h.dispose()}resize(e,t){if(this.width===e&&this.height===t)return;const i={width:e,height:t};p(i,this._context.parameters.maxTextureSize),this._colorAttachments.forEach((e=>e.resize(i.width,i.height))),this._depthStencilTexture?.resize(i.width,i.height),this._initialized&&(p(i,this._context.parameters.maxRenderbufferSize),this._depthStencilBuffer?.resize(i.width,i.height),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1)}initializeAndBind(e=o.R.FRAMEBUFFER){const t=this._context.gl;if(this._initialized)return void t.bindFramebuffer(e,this.glName);this._glName&&t.deleteFramebuffer(this._glName);const i=t.createFramebuffer();if(t.bindFramebuffer(e,i),this._colorAttachments.forEach(((t,i)=>this._framebufferTexture2D(t.glName,i,f(t),e))),this._depthStencilBuffer){const i=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);t.framebufferRenderbuffer(e,i,t.RENDERBUFFER,this._depthStencilBuffer.glName)}else this._depthStencilTexture&&this._framebufferTexture2D(this._depthStencilTexture.glName,t.DEPTH_STENCIL_ATTACHMENT,f(this._depthStencilTexture),e);(0,a.en)()&&t.checkFramebufferStatus(e)!==t.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=i,this._initialized=!0}_framebufferTexture2D(e,t=o.Nm.COLOR_ATTACHMENT0,i=o.Ap.TEXTURE_2D,r=o.R.FRAMEBUFFER,s=0){this._context.gl.framebufferTexture2D(r,t,i,e,s)}_disposeDepthStencilAttachments(){const e=this._context.gl;if(this._depthStencilBuffer){if(this._initialized){this._context.bindFramebuffer(this);const t=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);e.framebufferRenderbuffer(o.R.FRAMEBUFFER,t,e.RENDERBUFFER,null)}this._depthStencilBuffer=(0,s.WD)(this._depthStencilBuffer)}this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,e.DEPTH_STENCIL_ATTACHMENT)),this._depthStencilTexture=(0,s.WD)(this._depthStencilTexture))}_validateTextureDescriptor(e){e.target!==o.Ap.TEXTURE_2D&&e.target!==o.Ap.TEXTURE_CUBE_MAP&&console.error("Texture type must be TEXTURE_2D or TEXTURE_CUBE_MAP!"),p(e,this._context.parameters.maxTextureSize),this._validateBufferDimensions(e)}_validateRenderBufferDescriptor(e){p(e,this._context.parameters.maxRenderbufferSize),this._validateBufferDimensions(e)}_validateBufferDimensions(e){e.width<=0&&(e.width=this.width),e.height<=0&&(e.height=this.height),this.width>0&&this.height>0&&(this.width===e.width&&this.height===e.height||console.error("Attachment size must match framebuffer size!"))}_getGLAttachmentPoint(e){switch(e.internalFormat){case o.yQ.DEPTH_COMPONENT16:case o.yQ.DEPTH_COMPONENT24:case o.yQ.DEPTH_COMPONENT32F:return this._context.gl.DEPTH_ATTACHMENT;case o.yQ.DEPTH24_STENCIL8:case o.yQ.DEPTH32F_STENCIL8:case o.yQ.DEPTH_STENCIL:return this._context.gl.DEPTH_STENCIL_ATTACHMENT;case o.yQ.STENCIL_INDEX8:return this._context.gl.STENCIL_ATTACHMENT}}_validateColorAttachmentPoint(e){if(-1===d._MAX_COLOR_ATTACHMENTS){const{gl:e}=this._context;d._MAX_COLOR_ATTACHMENTS=e.getParameter(e.MAX_COLOR_ATTACHMENTS)}const t=e-o.Nm.COLOR_ATTACHMENT0;t+1>d._MAX_COLOR_ATTACHMENTS&&r.A.getLogger("esri.views.webgl.FrameBufferObject").error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${t+1}. Implementation supports up to ${d._MAX_COLOR_ATTACHMENTS} color attachments`)}}function u(e){return null!=e&&"type"in e&&e.type===l.p.Texture}function p(e,t){const i=Math.max(e.width,e.height);if(i>t){r.A.getLogger("esri.views.webgl.FramebufferObject").warn(`Resizing FBO attachment size ${e.width}x${e.height} to device limit ${t}`);const s=t/i;return e.width=Math.round(e.width*s),e.height=Math.round(e.height*s),!1}return!0}function f(e){return e.descriptor.target===o.Ap.TEXTURE_CUBE_MAP?o.Ap.TEXTURE_CUBE_MAP_POSITIVE_X:o.Ap.TEXTURE_2D}d._MAX_COLOR_ATTACHMENTS=-1},53386:(e,t,i)=>{i.d(t,{l:()=>a});var r=i(68716),s=i(86424),n=i(85939);class a{constructor(e,t){this._context=e,this._descriptor=t,this.type=s.p.RenderBuffer,this._context.instanceCounter.increment(r.vt.Renderbuffer,this);const i=this._context.gl;this.glName=i.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:n,height:a,internalFormat:o,multisampled:l}=t;l?i.renderbufferStorageMultisample(i.RENDERBUFFER,this.samples,o,n,a):i.renderbufferStorage(i.RENDERBUFFER,o,n,a)}get descriptor(){return this._descriptor}get samples(){const e=this._descriptor.samples,t=this._context.parameters.maxSamples;return e?Math.min(e,t):t}get usedMemory(){return(0,n.e)(this._descriptor)}resize(e,t){const i=this._descriptor;if(i.width===e&&i.height===t)return;i.width=e,i.height=t;const r=this._context.gl;this._context.bindRenderbuffer(this),i.multisampled?r.renderbufferStorageMultisample(r.RENDERBUFFER,this.samples,i.internalFormat,i.width,i.height):r.renderbufferStorage(r.RENDERBUFFER,i.internalFormat,i.width,i.height)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(r.vt.Renderbuffer,this),this._context=null)}}},85939:(e,t,i)=>{i.d(t,{e:()=>n,q:()=>s});var r=i(73360);class s{constructor(e,t,i=t){this.internalFormat=e,this.width=t,this.height=i,this.multisampled=!1,this.samples=1}}function n(e){return e.width<=0||e.height<=0||null==e.internalFormat?0:e.width*e.height*(0,r.IB)(e.internalFormat)}},40866:(e,t,i)=>{i.d(t,{Z:()=>c});var r=i(80861),s=i(57725),n=i(62088),a=i(68716),o=i(73360);const l=()=>r.A.getLogger("esri.views.webgl.VertexArrayObject");let c=class{constructor(e,t,i,r,s=null){this._context=e,this._locations=t,this._layout=i,this._buffers=r,this._indexBuffer=s,this._glName=null,this._initialized=!1}get glName(){return this._glName}get context(){return this._context}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get byteSize(){return Object.keys(this._buffers).reduce(((e,t)=>e+this._buffers[t].usedMemory),null!=this._indexBuffer?this._indexBuffer.usedMemory:0)}get layout(){return this._layout}get locations(){return this._locations}get usedMemory(){return this.byteSize+(Object.keys(this._buffers).length+(this._indexBuffer?1:0))*n.zQ}dispose(){if(this._context){this._context.getBoundVAO()===this&&this._context.bindVAO(null);for(const e in this._buffers)this._buffers[e]?.dispose(),delete this._buffers[e];this._indexBuffer=(0,s.WD)(this._indexBuffer),this.disposeVAOOnly()}else(this._glName||Object.getOwnPropertyNames(this._buffers).length>0)&&l().warn("Leaked WebGL VAO")}disposeVAOOnly(){this._glName&&(this._context.gl.deleteVertexArray(this._glName),this._glName=null,this._context.instanceCounter.decrement(a.vt.VertexArrayObject,this)),this._context=null}initialize(){if(this._initialized)return;const{gl:e}=this._context,t=e.createVertexArray();e.bindVertexArray(t),this._bindLayout(),e.bindVertexArray(null),this._glName=t,this._context.instanceCounter.increment(a.vt.VertexArrayObject,this),this._initialized=!0}bind(){this.initialize(),this._context.gl.bindVertexArray(this.glName)}_bindLayout(){const{_buffers:e,_layout:t,_indexBuffer:i}=this;e||l().error("Vertex buffer dictionary is empty!");const r=this._context.gl;for(const i in e){const r=e[i];r||l().error("Vertex buffer is uninitialized!");const s=t[i];s||l().error("Vertex element descriptor is empty!"),(0,o.yu)(this._context,this._locations,r,s)}null!=i&&r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,i.glName)}unbind(){this.initialize(),this._context.gl.bindVertexArray(null)}}},67277:(e,t,i)=>{i.d(t,{_:()=>r});class r{constructor(e,t,i,r,s,n=!1,a=0){this.name=e,this.count=t,this.type=i,this.offset=r,this.stride=s,this.normalized=n,this.divisor=a}}},70838:(e,t,i)=>{i.d(t,{S:()=>a});var r=i(62991),s=i(68716);class n{constructor(e,t,i,r){this.dataType=e,this.samplingMode=t,this.pixelFormat=i,this.internalFormat=r}}function a(e,t){const{textureFloat:i,colorBufferFloat:a}=e.capabilities,o=i?.textureFloatLinear,l=a?.textureFloat,c=a?.textureHalfFloat,h=a?.floatBlend,d=e.driverTest.floatBufferBlend.result;if(!l&&!c)throw new r.A("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(h&&d||c))throw new r.A("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(d?"":" This device claims support for EXT_float_blend, but does not actually support it."));const u=l&&h&&d,p=c,f=o,g=!!a?.R32F,m=!!a?.R16F;if(u&&f)return f||t.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new n(s.ld.FLOAT,f?s.Cj.LINEAR:s.Cj.NEAREST,g?s.Ab.RED:s.Ab.RGBA,g?s.H0.R32F:s.Ab.RGBA);if(p)return new n(s.ld.HALF_FLOAT,s.Cj.LINEAR,m?s.Ab.RED:s.Ab.RGBA,m?s.H0.R16F:s.Ab.RGBA);throw new r.A("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}}}]);